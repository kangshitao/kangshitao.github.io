<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>建立Hexo个人博客</title>
    <url>/2020/10/25/BlogCreatProcess/</url>
    <content><![CDATA[<blockquote>
<p>使用hexo和github.pages搭建博客，主题为<a href="https://github.com/izhaoo/hexo-theme-zhaoo">zhaoo</a></p>
<p>文章部分功能是主题没更新之前写的，作为记录，已有的内容不再修改，具体配置情况根据主题而定。更多内容可以参考zhaoo主题作者博客主页：<a href="https://www.izhaoo.com/">zhaoo</a></p>
</blockquote>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>github创建名为username.github.io的repository</p>
<p>安装git</p>
<p>安装Node.js</p>
<h1 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h1><p>新建文件夹blog，存放博客的所有内容</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 安装hexo</span><br><span class="hljs-attr">npm</span> <span class="hljs-string">install hexo-cli -g</span><br><span class="hljs-comment"># 确认是否安装成功</span><br><span class="hljs-attr">hexo</span> <span class="hljs-string">-v</span><br><span class="hljs-comment"># init</span><br><span class="hljs-attr">hexo</span> <span class="hljs-string">init</span><br><span class="hljs-attr">npm</span> <span class="hljs-string">install</span><br></code></pre></td></tr></tbody></table></figure>
<p>生成的几个文件：</p>
<ul>
<li>node_modules：依赖包</li>
<li>public：存放生成的页面</li>
<li>scaffolds：生成文章的一些模版</li>
<li>source：用来存放文章</li>
<li>themes：主题</li>
<li>_config.yml: 配置文件</li>
</ul>
<figure class="highlight axapta"><table><tbody><tr><td class="code"><pre><code class="hljs axapta">hexo <span class="hljs-keyword">server</span><br></code></pre></td></tr></tbody></table></figure>
<p>然后在浏览器输入localhost:4000即可看到生成的博客。</p>
<h1 id="更换主题"><a href="#更换主题" class="headerlink" title="更换主题"></a>更换主题</h1><p>hexo默认主题是landscape，可以自由更换主题：</p>
<figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><code class="hljs crmsh"><span class="hljs-comment">#下载主题到themes/zhaoo路径</span><br>git <span class="hljs-keyword">clone</span> <span class="hljs-title">git</span>@github.com:izhaoo/hexo-theme-zhaoo.git themes/zhaoo<br></code></pre></td></tr></tbody></table></figure>
<p>根据需求创建tags、about、categories页面：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><code class="hljs routeros">hexo new<span class="hljs-built_in"> page </span>tags<br>hexo new<span class="hljs-built_in"> page </span>about<br>hexo new<span class="hljs-built_in"> page </span>categories<br></code></pre></td></tr></tbody></table></figure>
<p>以上代码会在<code>source</code>的对应文件夹下生成index.md文件，可根据需求配置页面:</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><code class="hljs vim"># 以<span class="hljs-keyword">tags</span>的<span class="hljs-built_in">index</span>为例，将layout设置为<span class="hljs-keyword">tags</span>布局，不同与一般的布局。<br>layou<span class="hljs-variable">t:</span> <span class="hljs-keyword">tags</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>layout(布局)有三种：post(文章)、draft(草稿)、page(页面)，默认是post</p>
</blockquote>
<p>然后根据主题配置说明，配置主题的配置文件<code>themes/zhaoo/_config.yml</code></p>
<h1 id="关联git库"><a href="#关联git库" class="headerlink" title="关联git库"></a>关联git库</h1><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment"># 安装要用的插件</span><br>npm <span class="hljs-keyword">install</span> hexo-deployer-git <span class="hljs-comment">--save</span><br></code></pre></td></tr></tbody></table></figure>
<p>修改<code>blog/_config.yml</code>配置文件：</p>
<figure class="highlight stylus"><table><tbody><tr><td class="code"><pre><code class="hljs stylus">deploy：<br>  type: git<br>  repo: git@github<span class="hljs-selector-class">.com</span>:username/username<span class="hljs-selector-class">.github</span><span class="hljs-selector-class">.io</span>.git<br>  branch: master<br></code></pre></td></tr></tbody></table></figure>
<p>上述代码表示部署到指定的库中，并且默认部署到分支master。</p>
<p>部署的机制是将本地生成的<code>.deploy_git</code>文件夹里的文件，上传到远程库，并不包括配置文件和主题文件。</p>
<blockquote>
<p>为了方便多终端工作，建议每次写完文章，除了deploy操作以外，将源代码也push到远程仓库保存。新建一个分支，将源文件push到这个分支里面，这样在另一台机器上只需要clone远程库，安装必要的文件就可以了。</p>
</blockquote>
<h1 id="新建文章"><a href="#新建文章" class="headerlink" title="新建文章"></a>新建文章</h1><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 创建新的文件，默认保存在source/_post路径下</span><br>hexo new <span class="hljs-string">'new blog'</span><br><span class="hljs-comment"># run server</span><br>hexo server<br><span class="hljs-comment"># 清除缓存</span><br>hexo clean<br><span class="hljs-comment"># 生成静态网页</span><br>hexo generate/hexo g<br><span class="hljs-comment"># 将网页部署到远程站点</span><br>hexo deploy/hexo d<br></code></pre></td></tr></tbody></table></figure>
<p>在<code>scaffolds</code>文件夹中，有三种默认布局新建时的模版，可以自定义新建文件时的格式。</p>
<p>tags和categories属性的值可以用列表，表示多个标签/类别。</p>
<h1 id="数学公式渲染"><a href="#数学公式渲染" class="headerlink" title="数学公式渲染"></a>数学公式渲染</h1><blockquote>
<p>主题更新添加了公式渲染配置的说明，方法简单快捷，可以<a href="https://www.izhaoo.com/2020/05/05/hexo-theme-zhaoo-doc/#%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F">参考</a>。本节内容作为踩坑记录。</p>
<p>hexo默认的Markdown渲染器是hexo-renderer-marked，会先按照Markdown语法解析，然后才是LaTex，所以会有冲突。试了网上各种解决方法，终于遇到一个有效的方法：<a href="https://www.dazhuanlan.com/2020/03/07/5e633a3b46a81/">hexo无法显示公式的问题-DGZ’s Blog</a></p>
</blockquote>
<h2 id="重装插件"><a href="#重装插件" class="headerlink" title="重装插件"></a>重装插件</h2><p>首先，只保留一个公式渲染器，这里保留kramed渲染器。</p>
<figure class="highlight sql"><table><tbody><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment"># 卸载默认的渲染器，其他的公式渲染器也卸载，只保留kramed</span><br>npm <span class="hljs-keyword">uninstall</span> hexo-renderer-marked <span class="hljs-comment">--save</span><br>npm <span class="hljs-keyword">install</span> hexo-renderer-kramed <span class="hljs-comment">--save</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="修改js文件"><a href="#修改js文件" class="headerlink" title="修改js文件"></a>修改js文件</h2><p>打开<code>bolg/node_modules/hexo-renderer-kramed/lib/renderer.js</code>，将：</p>
<figure class="highlight arcade"><table><tbody><tr><td class="code"><pre><code class="hljs arcade"><span class="hljs-comment">//change inline math rule</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">formatText</span>(<span class="hljs-params">text</span>) </span>{<br>    <span class="hljs-comment">// Fit kramed's rule: <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.973ex" height="2.509ex" style="vertical-align: -0.505ex;" viewBox="0 -863.1 3002.4 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">$ + 1 + </title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-24" d="M162 187Q162 164 146 149T109 133H103V130Q108 115 115 105Q122 92 131 82T150 64T170 52T190 44T206 40T220 37L227 36V313Q190 320 162 335Q116 358 86 404T55 508Q55 567 85 614T165 685Q186 696 225 704H227V750H273V704L286 703Q369 690 413 631Q441 588 444 531Q444 514 443 509Q439 490 425 479T391 468Q368 468 353 483T337 522Q337 546 353 560T390 575L394 576V578Q386 599 372 614T342 637T314 649T288 656L273 658V408L288 405Q329 394 355 376Q396 348 420 300T444 199Q444 130 408 76T313 1Q286 -9 276 -9H273V-56H227V-10H221Q202 -6 193 -4T155 11T108 41T74 94T55 176V182Q55 227 95 238Q103 240 108 240Q129 240 145 226T162 187ZM225 657Q219 657 204 651T169 632T135 594T121 538Q121 512 131 491T156 457T187 435T213 423T227 420V539Q227 657 225 657ZM378 169Q378 230 339 265T274 301Q273 301 273 169V37Q324 50 351 87T378 169Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-24" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="722" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1723" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="2223" y="0"></use>
</g>
</svg>$</span><br>    <span class="hljs-keyword">return</span> text.replace(<span class="hljs-regexp">/`<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.103ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2197.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">(.*?)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3F" d="M226 668Q190 668 162 656T124 632L114 621Q116 621 119 620T130 616T145 607T157 591T162 567Q162 544 147 529T109 514T71 528T55 566Q55 625 100 661T199 704Q201 704 210 704T224 705H228Q281 705 320 692T378 656T407 612T416 567Q416 503 361 462Q267 395 247 303Q242 279 242 241V224Q242 205 239 202T222 198T205 201T202 218V249Q204 320 220 371T255 445T292 491T315 537Q317 546 317 574V587Q317 604 315 615T304 640T277 661T226 668ZM162 61Q162 89 180 105T224 121Q247 119 264 104T281 61Q281 31 264 16T222 1Q197 1 180 16T162 61Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-28" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="389" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2217" x="834" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3F" x="1335" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1807" y="0"></use>
</g>
</svg>`/g</span>, <span class="hljs-string">'<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.162ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 500.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">$</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-24" d="M162 187Q162 164 146 149T109 133H103V130Q108 115 115 105Q122 92 131 82T150 64T170 52T190 44T206 40T220 37L227 36V313Q190 320 162 335Q116 358 86 404T55 508Q55 567 85 614T165 685Q186 696 225 704H227V750H273V704L286 703Q369 690 413 631Q441 588 444 531Q444 514 443 509Q439 490 425 479T391 468Q368 468 353 483T337 522Q337 546 353 560T390 575L394 576V578Q386 599 372 614T342 637T314 649T288 656L273 658V408L288 405Q329 394 355 376Q396 348 420 300T444 199Q444 130 408 76T313 1Q286 -9 276 -9H273V-56H227V-10H221Q202 -6 193 -4T155 11T108 41T74 94T55 176V182Q55 227 95 238Q103 240 108 240Q129 240 145 226T162 187ZM225 657Q219 657 204 651T169 632T135 594T121 538Q121 512 131 491T156 457T187 435T213 423T227 420V539Q227 657 225 657ZM378 169Q378 230 339 265T274 301Q273 301 273 169V37Q324 50 351 87T378 169Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-24" x="0" y="0"></use>
</g>
</svg><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.325ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 1001 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">$1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-24" d="M162 187Q162 164 146 149T109 133H103V130Q108 115 115 105Q122 92 131 82T150 64T170 52T190 44T206 40T220 37L227 36V313Q190 320 162 335Q116 358 86 404T55 508Q55 567 85 614T165 685Q186 696 225 704H227V750H273V704L286 703Q369 690 413 631Q441 588 444 531Q444 514 443 509Q439 490 425 479T391 468Q368 468 353 483T337 522Q337 546 353 560T390 575L394 576V578Q386 599 372 614T342 637T314 649T288 656L273 658V408L288 405Q329 394 355 376Q396 348 420 300T444 199Q444 130 408 76T313 1Q286 -9 276 -9H273V-56H227V-10H221Q202 -6 193 -4T155 11T108 41T74 94T55 176V182Q55 227 95 238Q103 240 108 240Q129 240 145 226T162 187ZM225 657Q219 657 204 651T169 632T135 594T121 538Q121 512 131 491T156 457T187 435T213 423T227 420V539Q227 657 225 657ZM378 169Q378 230 339 265T274 301Q273 301 273 169V37Q324 50 351 87T378 169Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-24" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="500" y="0"></use>
</g>
</svg><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.162ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 500.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">$</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-24" d="M162 187Q162 164 146 149T109 133H103V130Q108 115 115 105Q122 92 131 82T150 64T170 52T190 44T206 40T220 37L227 36V313Q190 320 162 335Q116 358 86 404T55 508Q55 567 85 614T165 685Q186 696 225 704H227V750H273V704L286 703Q369 690 413 631Q441 588 444 531Q444 514 443 509Q439 490 425 479T391 468Q368 468 353 483T337 522Q337 546 353 560T390 575L394 576V578Q386 599 372 614T342 637T314 649T288 656L273 658V408L288 405Q329 394 355 376Q396 348 420 300T444 199Q444 130 408 76T313 1Q286 -9 276 -9H273V-56H227V-10H221Q202 -6 193 -4T155 11T108 41T74 94T55 176V182Q55 227 95 238Q103 240 108 240Q129 240 145 226T162 187ZM225 657Q219 657 204 651T169 632T135 594T121 538Q121 512 131 491T156 457T187 435T213 423T227 420V539Q227 657 225 657ZM378 169Q378 230 339 265T274 301Q273 301 273 169V37Q324 50 351 87T378 169Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-24" x="0" y="0"></use>
</g>
</svg>'</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>修改为：</p>
<figure class="highlight pgsql"><table><tbody><tr><td class="code"><pre><code class="hljs pgsql">// Change <span class="hljs-keyword">inline</span> math <span class="hljs-keyword">rule</span><br><span class="hljs-keyword">function</span> formatText(<span class="hljs-type">text</span>) {<br>    <span class="hljs-keyword">return</span> <span class="hljs-type">text</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="安装mathjax插件"><a href="#安装mathjax插件" class="headerlink" title="安装mathjax插件"></a>安装mathjax插件</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment"># 如果有hexo-math，则卸载掉</span><br>npm <span class="hljs-keyword">uninstall</span> hexo-math <span class="hljs-comment">--save</span><br>npm <span class="hljs-keyword">install</span> hexo-renderer-mathjax <span class="hljs-comment">--save</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="修改html文件"><a href="#修改html文件" class="headerlink" title="修改html文件"></a>修改html文件</h2><p>打开<code>blog/node_modules/hexo-renderer-mathjax/mathjax.html，将：</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>修改为：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="激活插件"><a href="#激活插件" class="headerlink" title="激活插件"></a>激活插件</h2><p>在使用公式的md文件添加属性：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">mathjax:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>如果是第一次修改，修改完以后需要重新启动服务：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">hexo</span> <span class="hljs-string">clean</span><br><span class="hljs-attr">hexo</span> <span class="hljs-string">g</span><br><span class="hljs-attr">hexo</span> <span class="hljs-string">s</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="图床"><a href="#图床" class="headerlink" title="图床"></a>图床</h1><p>众所周知，github是万能的，使用<a href="https://picgo.github.io/PicGo-Doc/">PigGo</a>和Github搭建个人图床，参考<a href="https://picgo.github.io/PicGo-Doc/zh/guide/#%E5%90%AC%E8%AF%B4%E4%BD%A0%E4%B9%9F%E6%83%B3%E7%94%A8picgo">PigGo官方文档</a></p>
<h2 id="新建github项目"><a href="#新建github项目" class="headerlink" title="新建github项目"></a>新建github项目</h2><p>新建github项目用来存放图片，并生成token：</p>
<figure class="highlight xl"><table><tbody><tr><td class="code"><pre><code class="hljs xl"><span class="hljs-function"><span class="hljs-title">github</span>头像-&gt;</span>S<span class="hljs-function"><span class="hljs-title">ettings</span>-&gt;</span>D<span class="hljs-function"><span class="hljs-title">eveloper</span> settings-&gt;</span>Generate new token<br>将repo选项打勾<br></code></pre></td></tr></tbody></table></figure>
<h2 id="配置PicGo"><a href="#配置PicGo" class="headerlink" title="配置PicGo"></a>配置PicGo</h2><p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/blogcreatprocess_1.png"><span class="image-caption">1</span></p>
<p>然后点击确定，并设置为默认图床。</p>
<p>自定义域名可以按照图中的设置，也可以使用别的自定义域名。第二种域名方式就是使用<a href="https://en.wikipedia.org/wiki/Content_delivery_network">CDN</a>加速的方法，CDN(Content Delivery Network)是指内容分发网络，也称为内容传送网络。</p>
<p><a href="https://www.jsdelivr.com/?docs=gh">jsDelivr</a>是一种免费的CDN加速产品，可以加速Github和NPM的资源，其中使用jsDelivr的方法访问Github资源只需要将链接改为以下格式：</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>cdn.jsdelivr.net<span class="hljs-regexp">/gh/u</span>sername<span class="hljs-regexp">/repository@version/</span>file   <br><span class="hljs-comment"># 其中的version指的是仓库版本，如果没有release版本，也可以使用分支名称</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>jsDelivr的更多用法可以参考官方文档</p>
</blockquote>
<p>使用jsDelivr加速的自定义域名填写内容如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/blogcreatprocess_2.png"><span class="image-caption">2</span></p>
<h2 id="上传图片"><a href="#上传图片" class="headerlink" title="上传图片"></a>上传图片</h2><p>将图片拖入上传区，上传成功后会自动在剪切板生成图片链接。</p>
<h2 id="其他设置"><a href="#其他设置" class="headerlink" title="其他设置"></a>其他设置</h2><p>其他参数设置可根据个人喜好进行设置：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/blogcreatprocess_3.png"><span class="image-caption">3</span></p>
<h2 id="图片上传失败问题"><a href="#图片上传失败问题" class="headerlink" title="图片上传失败问题"></a>图片上传失败问题</h2><p>由于某些原因，github当作图库不是很稳定，时好时坏也是正常现象。</p>
<p>参考<a href="https://blog.csdn.net/TalesOV/article/details/104450037?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-5.channel_param&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-5.channel_param">PicGo踩坑记</a></p>
<ul>
<li>首先检查设置的仓库名是否正确，仓库名不可包含空格，且不要出现奇怪的符号</li>
<li>上传的图片名字不要有奇怪符号</li>
<li>间歇性上传失败的话，可以将server的开关状态切换一下</li>
</ul>
<p>另外，有条件的可以使用全局代理<span class="github-emoji"><span>✈</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2708.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span></p>
<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><p>主题的其他设置可以参考<a href="https://www.izhaoo.com/2020/05/05/hexo-theme-zhaoo-doc/">zhaoo主题文档</a>，这里只记录一部分</p>
<h2 id="访问量统计"><a href="#访问量统计" class="headerlink" title="访问量统计"></a>访问量统计</h2><p>主题默认使用的是<a href="https://leancloud.cn/">leancloud</a>，这里的统计是每篇文章的访问量，zhaoo主题支持leancloud，只需要按要求填写即可：</p>
<figure class="highlight monkey"><table><tbody><tr><td class="code"><pre><code class="hljs monkey">进入leancloud，创建应用(开发版)<br>创建<span class="hljs-class"><span class="hljs-keyword">Class</span>，<span class="hljs-title">ACL</span>权限选择无限制</span><br>打开设置-应用keys<br>将AppID、AppKey、Rest API服务器地址复制到themes/_config.yml<br></code></pre></td></tr></tbody></table></figure>
<p>如果想要设置本地访问不统计次数，则可以在<code>\themes\zhaoo\layout\_partial\common\visitors.ejs</code>中，修改以下内容：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript">$(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<br>	  <span class="hljs-keyword">const</span> Counter = AV.Object.extend(<span class="hljs-string">"Counter"</span>);<br>	  showCount(Counter);<br>      <span class="hljs-keyword">const</span> localhost = <span class="hljs-regexp">/http\:\/\/localhost|http\:\/\/127.0.0.1|http\:\/\/0.0.0.0/</span>;<br>      <span class="hljs-keyword">if</span> (localhost.test(<span class="hljs-built_in">document</span>.URL)) {<br>	    <span class="hljs-keyword">return</span>;<br>	  }<br>	  addCount(Counter);<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p>如果想对网站访问量统计，可以使用<a href="http://busuanzi.ibruce.info/">卜蒜子</a>，在<code>themes\zhaoo\layout\_partial\footer.ejs</code>中合适的位置加入以下代码，其中的字体显示内容和风格可以自由设置：</p>
<figure class="highlight django"><table><tbody><tr><td class="code"><pre><code class="hljs django"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"</span>&lt;/<span class="hljs-attr">script</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"busuanzi_container_site_pv"</span>&gt;</span></span><br><span class="xml">  总浏览量：<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"busuanzi_value_site_pv"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size:12px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> 次</span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"busuanzi_container_site_uv"</span> &gt;</span></span><br><span class="xml">  总访客数：<span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"busuanzi_value_site_uv"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"font-size:12px;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>人</span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="评论功能"><a href="#评论功能" class="headerlink" title="评论功能"></a>评论功能</h2><h3 id="开启Valine"><a href="#开启Valine" class="headerlink" title="开启Valine"></a>开启Valine</h3><p>使用<a href="https://valine.js.org/">Valine</a>，前提是主题支持：</p>
<figure class="highlight monkey"><table><tbody><tr><td class="code"><pre><code class="hljs monkey">leancloud,创建应用(开发版),可以和访问量统计使用一个应用<br>创建<span class="hljs-class"><span class="hljs-keyword">Class</span>，配置默认</span><br>打开设置-应用keys<br>将AppID、AppKey复制到themes/_config.yml<br></code></pre></td></tr></tbody></table></figure>
<h3 id="设置邮箱提醒"><a href="#设置邮箱提醒" class="headerlink" title="设置邮箱提醒"></a>设置邮箱提醒</h3><p>如果想要在别人评论后，能够收到提醒，就需要设置邮箱提醒了。这里使用<a href="https://github.com/zhaojun1998/Valine-Admin">Valine-Admin</a>插件，参考官方教程设置：</p>
<ol>
<li><p>进入<a href="https://console.leancloud.cn/apps">Leancloud</a>对应的valine应用中，</p>
</li>
<li><p>点击云引擎—设置，添加环境变量，添加自定义环境变量，保存。</p>
<blockquote>
<p>如果使用QQ邮箱，密码需要使用QQ邮箱的授权码。</p>
</blockquote>
</li>
<li><p>设置好环境变量以后，选择Web—部署—Git部署，填写代码库<code>https://github.com/zhaojun1998/Valine-Admin</code>，分支使用master，部署。</p>
</li>
</ol>
<p>此外，由于LeanCloud免费版有休眠策略，需要使用自定义计时器让容器一直保持运行状态。</p>
<p>具体使用方法：</p>
<ul>
<li>创建两个定时任务，第一个定时器选<code>self_wake</code>函数,<code>Cron</code>表达式填<code>0 */20 7-23 * * ?</code>，表示每天的7-23点每20分钟访问一次。</li>
<li>第二个定时器选<code>resend_mails</code>函数，<code>Cron</code>表达式填<code>0 0 8 * * ?</code>，表示每天早8点检查过去24小时内漏发的通知邮件并补发。</li>
</ul>
<p>更新设置以后，重新部署一下即可，至此，可以收到邮件的评论提醒，此外还可以设置邮件的回执格式等。</p>
<h3 id="设置微信提醒"><a href="#设置微信提醒" class="headerlink" title="设置微信提醒"></a>设置微信提醒</h3><p>如果想使用微信提醒，前提是配置好邮箱提醒。</p>
<p>使用<a href="https://sct.ftqq.com/">Server酱</a>设置微信提醒，首先需要根据<a href="http://sc.ftqq.com/9.version">Server酱的使用教程</a>获取到<code>SCKEY</code>，在LeanCloud中添加自定义环境变量，<code>name</code>是<code>SCKEY</code>，<code>value</code>是<code>SCKEY</code>的值，保存，重新部署。这样配置完后，在Server酱官网进行测试，应该能够收到微信提醒。</p>
<p>设置别人评论收到微信提醒，需要在主题的JS文件中添加代码（参考<a href="https://www.zyskys.com/posts/bd75">链接</a>），往 <code>https://sctapi.ftqq.com/SENDKEY.send</code> 发 HTTP 请求，就可以收到消息啦。具体设置，根据不同主题而定，对于<code>zhaoo</code>主题，在<code>zhaoo\layout\_partial\comments</code>下的<code>valine.ejs</code>文件中，添加以下代码：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// 添加代码以后的文件</span><br>&lt;% <span class="hljs-keyword">if</span> (theme.valine.appId &amp;&amp; theme.valine.appKey) { %&gt;<br>&lt;div id=<span class="hljs-string">"valine"</span>&gt;&lt;/div&gt;<br>&lt;script defer src=<span class="hljs-string">"//unpkg.com/valine/dist/Valine.min.js"</span>&gt;&lt;/script&gt;<br>&lt;script&gt;<br>  <span class="hljs-built_in">window</span>.onload = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<br>    <span class="hljs-keyword">var</span> loadValine = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<br>      <span class="hljs-keyword">new</span> Valine({<br>        el: <span class="hljs-string">'#valine'</span>,<br>        app_id: <span class="hljs-string">"&lt;%= theme.valine.appId %&gt;"</span>,<br>        app_key: <span class="hljs-string">"&lt;%= theme.valine.appKey %&gt;"</span>,<br>        placeholder: <span class="hljs-string">"&lt;%= theme.valine.placeholder %&gt;"</span>,<br>        avatar: <span class="hljs-string">"&lt;%= theme.valine.avatar %&gt;"</span>,<br>        pageSize: <span class="hljs-string">"&lt;%= theme.valine.pageSize %&gt;"</span>,<br>        lang: <span class="hljs-string">"&lt;%= theme.valine.lang %&gt;"</span>,<br>      });<br>    }<br>    <span class="hljs-keyword">if</span> ( &lt;%- theme.comments.button %&gt; ) {<br>      $(<span class="hljs-string">"#comments-btn"</span>).on(<span class="hljs-string">"click"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{<br>        $(<span class="hljs-built_in">this</span>).hide();<br>        loadValine();<br>        <span class="hljs-comment">//从这里开始添加代码</span><br>		<span class="hljs-keyword">var</span> title1=<span class="hljs-string">"text=Live and Learn有新评论啦~ --by Valine"</span>  <span class="hljs-comment">//自定义标题</span><br>		<span class="hljs-keyword">var</span> SCKEY_Server=<span class="hljs-string">""</span>  <span class="hljs-comment">//填写SCKEY的值</span><br>		<span class="hljs-keyword">var</span> ValineButton=<span class="hljs-built_in">document</span>.getElementsByClassName(<span class="hljs-string">"vsubmit vbtn"</span>)[<span class="hljs-number">0</span>];<br>		<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">send_valine_Server</span>(<span class="hljs-params"></span>)</span>{<br>			<span class="hljs-keyword">var</span> text=<span class="hljs-string">"desp="</span>;<br>			<span class="hljs-keyword">var</span> pageurl=<span class="hljs-built_in">document</span>.URL;<br>			<span class="hljs-keyword">var</span> ptime=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>();<br>			<span class="hljs-keyword">var</span> vnick=<span class="hljs-built_in">document</span>.getElementsByClassName(<span class="hljs-string">"vnick vinput"</span>)[<span class="hljs-number">0</span>].value;<br>			<span class="hljs-keyword">var</span> veditor=<span class="hljs-built_in">document</span>.getElementsByClassName(<span class="hljs-string">"veditor vinput"</span>)[<span class="hljs-number">0</span>].value;<br>			<span class="hljs-keyword">var</span> data=text+<span class="hljs-string">"|昵称"</span>+<span class="hljs-string">"|评论内容"</span>+<span class="hljs-string">"|跳转链接"</span>+<span class="hljs-string">"|评论时间"</span>+<span class="hljs-string">"\n"</span>+<span class="hljs-string">"|----|----|----|----|"</span>+<span class="hljs-string">"\n"</span>+<span class="hljs-string">"|"</span>+vnick+<span class="hljs-string">"|"</span>+veditor+<span class="hljs-string">"|"</span>+pageurl+<span class="hljs-string">"|"</span> +ptime.toLocaleString()+<span class="hljs-string">"|"</span>;<br>			<span class="hljs-keyword">var</span> httpRequest = <span class="hljs-keyword">new</span> XMLHttpRequest();<span class="hljs-comment">//第一步：创建需要的对象</span><br>			httpRequest.open(<span class="hljs-string">'POST'</span>, <span class="hljs-string">'https://sctapi.ftqq.com/'</span>+SCKEY_Server+<span class="hljs-string">'.send'</span>, <span class="hljs-literal">true</span>); <span class="hljs-comment">//第二步：打开连接</span><br>			httpRequest.setRequestHeader(<span class="hljs-string">"Content-type"</span>,<span class="hljs-string">"application/x-www-form-urlencoded"</span>);<span class="hljs-comment">//设置请求头 注：post方式必须设置请求头（在建立连接后设置请求头）</span><br>			httpRequest.send(title1+<span class="hljs-string">"&amp;"</span>+data);<span class="hljs-comment">//发送请求 将请头体体写在send中</span><br>		};<br>		ValineButton.onclick=send_valine_Server;<br>        <span class="hljs-comment">// 添加代码结束</span><br>      });<br>    } <span class="hljs-keyword">else</span> {<br>      loadValine();<br>    }<br>  };<br> <br>&lt;/script&gt;<br>&lt;% } %&gt;<br><br></code></pre></td></tr></tbody></table></figure>
<p>至此，收到评论以后就能够收到微信提醒。</p>
<h2 id="侧边目录"><a href="#侧边目录" class="headerlink" title="侧边目录"></a>侧边目录</h2><p>zhaoo没有支持侧边目录，需要自己添加代码，使用hexo官方的toc函数。(2020.11.16主题更新，已经支持)</p>
<p>在<code>themes\zhaoo\layout\_partial\post\article.ejs</code>中，最前面加以下代码：</p>
<figure class="highlight erb"><table><tbody><tr><td class="code"><pre><code class="hljs erb"><span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">aside</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"post-widget"</span>&gt;</span></span><br><span class="xml">  <span class="hljs-tag">&lt;<span class="hljs-name">nav</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"toc"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"toc-article fixed"</span>&gt;</span></span><br><span class="xml">	<span class="hljs-tag">&lt;<span class="hljs-name">strong</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"toc-title"</span>&gt;</span>文章目录<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span></span><br><span class="xml">	  <span class="hljs-tag">&lt;<span class="hljs-name">%-</span></span></span><span class="ruby"> toc(page.content, {</span><br><span class="ruby">	    <span class="hljs-class"><span class="hljs-keyword">class</span>: '<span class="hljs-title">post</span>-<span class="hljs-title">toc</span>',</span></span><br><span class="ruby">		<span class="hljs-symbol">list_number:</span> <span class="hljs-literal">false</span>,</span><br><span class="ruby">        <span class="hljs-symbol">max_depth:</span> <span class="hljs-string">'6'</span>,</span><br><span class="ruby">	    <span class="hljs-symbol">min_depth:</span> <span class="hljs-string">'1'</span>}) </span><span class="xml">%&gt;</span><br><span class="xml">	<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span></span><br><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">aside</span>&gt;</span></span><br></code></pre></td></tr></tbody></table></figure>
<p>然后在<code>themes\zhaoo\source\css\_partial\post.styl</code>中，最前面添加以下代码：</p>
<figure class="highlight scss"><table><tbody><tr><td class="code"><pre><code class="hljs scss"><span class="hljs-selector-class">.post-widget</span><br>  <span class="hljs-attribute">float</span> <span class="hljs-attribute">right</span><br>  <span class="hljs-attribute">width</span> 15%<br>  <span class="hljs-attribute">padding-left</span> 10px<br>  min-hidden 1px<br><span class="hljs-selector-class">.toc-article</span><span class="hljs-selector-class">.fixed</span><br>  <span class="hljs-attribute">top</span> 76px<br>  <span class="hljs-attribute">bottom</span> 140px<br>  <span class="hljs-attribute">overflow-y</span> <span class="hljs-attribute">auto</span><br><span class="hljs-selector-class">.toc-article</span><br>  <span class="hljs-attribute">position</span> fixed<br>  <span class="hljs-attribute">overflow-x</span> hidden<br><span class="hljs-selector-class">.toc-title</span><br>  <span class="hljs-attribute">padding-left</span> 20px<br></code></pre></td></tr></tbody></table></figure>
<h2 id="SEO优化"><a href="#SEO优化" class="headerlink" title="SEO优化"></a>SEO优化</h2><blockquote>
<p>搜索引擎优化（Search Engine Optimization,SEO），是一种通过了解搜索引擎的运作规则来调整网站，以及提高目的网站在有关搜索引擎内排名的方式。</p>
</blockquote>
<p>Github.pages屏蔽了百度的爬虫请求，配置较麻烦，这里仅以Google为例，使用<a href="https://search.google.com/search-console/about">Google Search Console</a>，以下过程参考：<a href="https://zhuanlan.zhihu.com/p/35400128">hexo博客搭建(五) SEO优化</a></p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-number">1</span><span class="hljs-string">、首先去google</span> <span class="hljs-string">search</span> <span class="hljs-string">console验证，有多种方式可选。</span><br><span class="hljs-number">2</span><span class="hljs-string">、添加站点地图</span> <span class="hljs-string">sitemap</span><br><span class="hljs-string">npm</span> <span class="hljs-string">install</span> <span class="hljs-string">hexo-generator-sitemap</span> <span class="hljs-string">--save</span>  <span class="hljs-comment"># 安装站点地图自动生成的插件</span><br><span class="hljs-string">在_config.yml文件中添加以下代码：</span><br><span class="hljs-attr">sitemap:</span><br>  <span class="hljs-attr">path:</span> <span class="hljs-string">sitemap.xml</span><br><span class="hljs-number">3</span><span class="hljs-string">、部署之后可以去google</span> <span class="hljs-string">search</span> <span class="hljs-string">console测试。</span><br></code></pre></td></tr></tbody></table></figure>
<p> continue……</p>
<hr>
<h1 id="参考教程"><a href="#参考教程" class="headerlink" title="参考教程"></a>参考教程</h1><blockquote>
<p><a href="https://hexo.io/zh-cn/docs/">hexo官方文档</a></p>
<p><a href="https://blog.csdn.net/sinat_37781304/article/details/82729029">hexo史上最全搭建教程</a></p>
</blockquote>
]]></content>
      <categories>
        <category>博客</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>blog</tag>
      </tags>
  </entry>
  <entry>
    <title>Python正则表达式</title>
    <url>/2020/11/01/RegularExpression/</url>
    <content><![CDATA[<h1 id="Re简介"><a href="#Re简介" class="headerlink" title="Re简介"></a>Re简介</h1><p>正则表达式(Regular Expression，RE，以下简称Re)通常用来检索、替换那些符合某个模式(规则)的文本，也就是说，RE是用来记录文本规则的代码。</p>
<p>总的来说，正则表达式是：</p>
<ul>
<li>通用的字符串表达框架</li>
<li>简洁表达一组字符串的表达式</li>
<li>针对字符串表达“简洁”和“特征”思想的工具</li>
<li>判断字符串的特征归属</li>
</ul>
<h1 id="Re的使用"><a href="#Re的使用" class="headerlink" title="Re的使用"></a>Re的使用</h1><p>编程语言使用正则表达式时需要编译，将符合正则表达式语法的字符串转换成正则表达式特征，也就是说，编译是将一个符合正则表达式语法的<strong>字符串</strong>编译为<strong>正则表达式</strong>。</p>
<blockquote>
<p>我们用字符串的形式表示正则表达式，如字符串<code>[a-z]</code>是表示匹配a到z中的任意一个字母的Re的表示方法</p>
</blockquote>
<h1 id="Re的语法"><a href="#Re的语法" class="headerlink" title="Re的语法"></a>Re的语法</h1><p>Re的语法是核心部分，RE语法是由字符和操作符组成。</p>
<p>常用操作符：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">操作符</th>
<th style="text-align:center">描述</th>
<th style="text-align:center">具体用例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>.</code></td>
<td style="text-align:center">表示除换行符\n以外的任何单个字符，如果要匹配’.’，则使用<code>\.</code>，其余字符同理</td>
<td style="text-align:center">无</td>
</tr>
<tr>
<td style="text-align:center"><code>[]</code></td>
<td style="text-align:center">字符集，对单个字符给出取值范围</td>
<td style="text-align:center">例：<code>[abc]</code>表示a或b或c，<code>[a-z]</code>表示从a到z的任意单个字符</td>
</tr>
<tr>
<td style="text-align:center"><code>[^]</code></td>
<td style="text-align:center">非字符集，对单个字符给出排除范围</td>
<td style="text-align:center">例：<code>[^abc]</code>表示非a或b或c的单个字符</td>
</tr>
<tr>
<td style="text-align:center"><code>*</code></td>
<td style="text-align:center">前一个字符0次或无限次扩展</td>
<td style="text-align:center">例：<code>abc*</code>表示ab、abc、abcc、abccc等</td>
</tr>
<tr>
<td style="text-align:center"><code>+</code></td>
<td style="text-align:center">前一个字符1次或无限次扩展</td>
<td style="text-align:center">例：<code>abc+</code>表示abc、abcc、abccc等</td>
</tr>
<tr>
<td style="text-align:center"><code>?</code></td>
<td style="text-align:center">前一个字符0次或1次扩展</td>
<td style="text-align:center">例：<code>abc?</code>表示ab、abc</td>
</tr>
<tr>
<td style="text-align:center">|</td>
<td style="text-align:center">左右表达式任意一个</td>
<td style="text-align:center">例：abc|def表示abc或def</td>
</tr>
<tr>
<td style="text-align:center"><code>\</code></td>
<td style="text-align:center">将下一个字符标记为或特殊字符、或原义字符、或向后引用、或八进制转义符。</td>
<td style="text-align:center">例： <code>n</code> 匹配字符 n。<code>\n</code> 匹配换行符,而 <code>\\</code> 匹配 <code>\</code>， <code>\(</code>匹配 “(“。</td>
</tr>
<tr>
<td style="text-align:center"><code>{m}</code></td>
<td style="text-align:center">扩展前一个字符m次</td>
<td style="text-align:center">例：<code>ab{2}c</code>表示abbc</td>
</tr>
<tr>
<td style="text-align:center"><code>{m,n}</code></td>
<td style="text-align:center">扩展前一个字符m到n(包括n)次</td>
<td style="text-align:center">例：<code>ab{1,2}c</code>表示abc、abbc</td>
</tr>
<tr>
<td style="text-align:center"><code>^</code></td>
<td style="text-align:center">匹配字符串开头</td>
<td style="text-align:center">例：<code>^abc</code>表示abc且在一个字符串的开头</td>
</tr>
<tr>
<td style="text-align:center">$</td>
<td style="text-align:center">匹配字符串结尾</td>
<td style="text-align:center">例：abc$表示abc且在一个字符串的结尾</td>
</tr>
<tr>
<td style="text-align:center"><code>()</code></td>
<td style="text-align:center">分组标记，内部只能用|操作符</td>
<td style="text-align:center">例：<code>(abc)</code>表示abc，(abc|def)表示abc或def</td>
</tr>
<tr>
<td style="text-align:center"><code>\d</code></td>
<td style="text-align:center">表示数字，等价于<code>[0-9]</code></td>
<td style="text-align:center">无</td>
</tr>
<tr>
<td style="text-align:center"><code>\w</code></td>
<td style="text-align:center">表示单词字符，等价于<code>[A-Za-z0-9_]</code>(包括下划线)</td>
<td style="text-align:center">无</td>
</tr>
</tbody>
</table>
</div>
<h1 id="Re语法实例"><a href="#Re语法实例" class="headerlink" title="Re语法实例"></a>Re语法实例</h1><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">正则表达式</th>
<th style="text-align:center">匹配的字符串</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">P(Y|YT|YTH)?N</td>
<td style="text-align:center">‘PN’、’PYN’、’PYTN’、’PYTHN’</td>
</tr>
<tr>
<td style="text-align:center"><code>PYTHON+</code></td>
<td style="text-align:center">‘PYTHON’、’PYTHONN’、’PYTHONNN’…</td>
</tr>
<tr>
<td style="text-align:center"><code>PY[TH]ON</code></td>
<td style="text-align:center">‘PYTON’,’PYHON’</td>
</tr>
<tr>
<td style="text-align:center"><code>PY[^TH]?ON</code></td>
<td style="text-align:center">‘PYON’、’PYaON’、’PYbON’…（不含T和H即可）</td>
</tr>
<tr>
<td style="text-align:center"><code>PY{0,3}N</code></td>
<td style="text-align:center">‘PN’、’PYN’、’PYYN’、’PYYYN’</td>
</tr>
<tr>
<td style="text-align:center"><code>^[A-Za-z]+$</code></td>
<td style="text-align:center">由26个字母组成的字符串</td>
</tr>
<tr>
<td style="text-align:center"><code>^[A-Za-z0-9]+$</code></td>
<td style="text-align:center">由26个字母和数字组成的字符串</td>
</tr>
<tr>
<td style="text-align:center"><code>^-?\d+$</code></td>
<td style="text-align:center">整数形式的字符串</td>
</tr>
<tr>
<td style="text-align:center"><code>^[0-9]*[1-9][0-9]*$</code></td>
<td style="text-align:center">正整数形式的字符串</td>
</tr>
<tr>
<td style="text-align:center"><code>[1-9]\d{5}</code></td>
<td style="text-align:center">中国境内邮政编码，6位</td>
</tr>
<tr>
<td style="text-align:center"><code>[\u4e00-\u9fa5]</code></td>
<td style="text-align:center">匹配中文字符(UTF-8编码)</td>
</tr>
<tr>
<td style="text-align:center">\d{3}-\d{8}|\d{4}-\d{7}</td>
<td style="text-align:center">国内电话号码，如000-12345678</td>
</tr>
</tbody>
</table>
</div>
<p>如果想要匹配ip地址，需要考虑如何表示取值范围在0-255，将其分为四部分，即0-99,100-199,200-249,250-255：</p>
<p>(([1-9]?\d|1\d{2}|2[0-4]\d|25[0-5]).){3}([1-9]?\d|1\d{2}|2[0-4]\d|25[0-5])</p>
<p>上述正则表达式，每两个<code>|</code>之间的正则表达式表示一个范围内的数，比如<code>[1-9]?\d</code>表示0-99</p>
<h1 id="Python的re库"><a href="#Python的re库" class="headerlink" title="Python的re库"></a>Python的re库</h1><p>python中的<a href="https://docs.python.org/3.9/library/re.html">re</a>库使用raw string(原生字符串类型)表示正则表达式，如原生字符串<code>text</code>写作<code>r'text'</code></p>
<p>例如，<code>r'[1-9]\d{5}'</code>是用来匹配邮政编码的Re字符串形式</p>
<blockquote>
<p>raw string 是指不包含转义符的字符串，即<code>\</code>不被认为是转义符<br>也可以使用string类型，但是更繁琐，不建议使用</p>
</blockquote>
<h2 id="主要功能函数"><a href="#主要功能函数" class="headerlink" title="主要功能函数"></a>主要功能函数</h2><ul>
<li><code>re.search()</code>        # 在一个字符串中搜索匹配Re的第一个位置，返回match对象</li>
<li><code>re.match()</code>       # 从一个字符串的开始位置起匹配Re，返回match对象</li>
<li><code>re.findall()</code>        # 搜索字符串，以列表类型返回全部能匹配的字符串</li>
<li><code>re.split()</code>           # 将一个字符串按照Re匹配结果进行分割，返回列表类型</li>
<li><code>re.finditer()</code>       # 搜索字符串，返回一个匹配结果的迭代类型，每个迭代元素是match对象</li>
<li><code>re.sub()</code>             # 在一个字符串中替换所有匹配Re的子串，返回替换后的子串</li>
</ul>
<p>函数的具体参数使用，详见<a href="https://docs.python.org/3.9/library/re.html#module-contents">官方文档</a>，以<code>re.search()</code>函数举例：</p>
<figure class="highlight vala"><table><tbody><tr><td class="code"><pre><code class="hljs vala">re.search(pattern, <span class="hljs-keyword">string</span>, flags=<span class="hljs-number">0</span>)<br><span class="hljs-meta"># 其中pattern是Re的字符串，string是待匹配的字符串</span><br><span class="hljs-meta"># flags是Re使用时的控制标记，用于控制Re的匹配方式，如是否区分大小写等</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><ul>
<li><p>函数式用法，一次性操作：</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><code class="hljs awk">rst = re.search(<span class="hljs-string">r'[1-9]\d{5}'</span>, <span class="hljs-string">'BIT 100081'</span>)<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>面向对象用法，编译后的多次操作</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python">pat = re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">r'[1-9]\d{5}'</span>)<br>rst = pat.search(<span class="hljs-string">'BIT 100081'</span>)<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p><code>pat = re.compile(pattern, flags=0)</code>是编译函数，将Re的字符串形式编译为Re对象</p>
<p>生成的结果pat才是正则表达式，参数pattern只是正则表达式的字符串表示方法</p>
</blockquote>
</li>
</ul>
<h2 id="Match对象"><a href="#Match对象" class="headerlink" title="Match对象"></a>Match对象</h2><p>match对象是re函数的一种返回值对象，其有很多属性。</p>
<p><strong>属性</strong>：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">代码</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>match.string</code></td>
<td style="text-align:center">待匹配的文本</td>
</tr>
<tr>
<td style="text-align:center"><code>match.re</code></td>
<td style="text-align:center">匹配时使用的正则表达式</td>
</tr>
<tr>
<td style="text-align:center"><code>match.pos</code></td>
<td style="text-align:center">正则表达式搜索文本的开始位置</td>
</tr>
<tr>
<td style="text-align:center"><code>match.endpos</code></td>
<td style="text-align:center">正则表达式搜索文本的结束位置</td>
</tr>
</tbody>
</table>
</div>
<p><strong>方法</strong>：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">代码</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>match.group(0)</code></td>
<td style="text-align:center">返回匹配后的字符串</td>
</tr>
<tr>
<td style="text-align:center"><code>match.start()</code></td>
<td style="text-align:center">返回匹配字符串在原始字符串的开始位置</td>
</tr>
<tr>
<td style="text-align:center"><code>match.end()</code></td>
<td style="text-align:center">返回匹配字符串在原始字符串的结束位置</td>
</tr>
<tr>
<td style="text-align:center"><code>match.span()</code></td>
<td style="text-align:center">返回(start(),end())，即开始和结束位置</td>
</tr>
</tbody>
</table>
</div>
<h2 id="贪婪匹配和最小匹配"><a href="#贪婪匹配和最小匹配" class="headerlink" title="贪婪匹配和最小匹配"></a>贪婪匹配和最小匹配</h2><p>re库默认采用贪婪匹配，即输出匹配最长的子串</p>
<p>若想得到最小匹配，则需要对以下操作符扩展，即在引起贪婪匹配的操作符后加<code>?</code>:</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">扩展</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>*?</code></td>
<td style="text-align:center">前一个字符0次或无限次扩展，最小匹配</td>
</tr>
<tr>
<td style="text-align:center"><code>+?</code></td>
<td style="text-align:center">前一个字符1次或无限次扩展，最小匹配</td>
</tr>
<tr>
<td style="text-align:center"><code>??</code></td>
<td style="text-align:center">前一个字符0次或1次扩展，最小匹配</td>
</tr>
<tr>
<td style="text-align:center"><code>{m,n}?</code></td>
<td style="text-align:center">扩展前一个字符m至n次(含n)，最小匹配</td>
</tr>
</tbody>
</table>
</div>
]]></content>
      <categories>
        <category>教程</category>
      </categories>
      <tags>
        <tag>正则表达式</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Attention总结</title>
    <url>/2020/11/12/attention/</url>
    <content><![CDATA[<blockquote>
<p>友情参考：邱锡鹏老师的<a href="https://nndl.github.io/">神经网络与深度学习</a></p>
</blockquote>
<h1 id="注意力机制"><a href="#注意力机制" class="headerlink" title="注意力机制"></a>注意力机制</h1><p>在计算能力有限的情况下，<strong>注意力机制(Attention Machanism)</strong>作为一种资源分配方案，将有限的计算资源用来处理更重要的信息，是解决信息过载问题的主要手段。通俗来说，注意力机制就是只关注和当前需求相关的信息，以阅读理解为例，对于给定的问题，只需要关注和问题相关的一个或几个句子，其余无关的部分不需要关注。</p>
<p>数学思想表达：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.608ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 8872.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{X} = [x_1,x_2,\ldots,x_N]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1231" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2287" y="0"></use>
<g transform="translate(2566,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3592" y="0"></use>
<g transform="translate(4037,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="5064" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="5509" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="6848" y="0"></use>
<g transform="translate(7293,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="8594" y="0"></use>
</g>
</svg>表示N个输入信息，为了节省计算资源，只需要<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.215ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 953.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{X}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
</g>
</svg>中选择一些和任务相关的信息进行计算。</p>
<h1 id="注意力的计算"><a href="#注意力的计算" class="headerlink" title="注意力的计算"></a>注意力的计算</h1><blockquote>
<p>一般情况下，我们使用的是Soft Attention，即各种信息的加权平均。还有一种Hard Attention，下文会讲。</p>
</blockquote>
<p>为了从N个<strong>输入向量</strong><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.608ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 8872.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{X}=[x_1,x_2,\ldots,x_N]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1231" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2287" y="0"></use>
<g transform="translate(2566,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3592" y="0"></use>
<g transform="translate(4037,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="5064" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="5509" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="6848" y="0"></use>
<g transform="translate(7293,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="8594" y="0"></use>
</g>
</svg>中选择出与任务相关的信息，需要引入和任务相关的表示，称为<strong>查询向量</strong><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 550.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{q}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
</g>
</svg>(Query Vector)，并通过一个打分函数计算每个输入向量和查询向量之间的相关性。</p>
<blockquote>
<p>查询向量q可以是动态生成的，也可以是可学习的参数。</p>
</blockquote>
<p>Soft Attention机制示例如下：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/attention_1.png">
</div>



<p>给定查询向量<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 550.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{q}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
</g>
</svg>和输入信息<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.215ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 953.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{X}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
</g>
</svg>，根据“软性”的信息选择机制对输入信息进行汇总：</p>
<script type="math/tex; mode=display">
att(\boldsymbol{X},q)=\sum^N_{n=1} {\alpha_n \boldsymbol{x}_n},\\
=\mathbb{E}_{z \sim p(z|\boldsymbol{X},q)}[\boldsymbol{x}_z]  \tag{1}</script><p>上式中的<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.706ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1165.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\alpha_n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B1" d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3B1" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="905" y="-213"></use>
</g>
</svg>称为<strong>注意力分布</strong>，表示在给定<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 550.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{q}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
</g>
</svg>和<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.215ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 953.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{X}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
</g>
</svg>情况下，选择第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
</g>
</svg>个输入向量的概率，也可以解释为在给定任务相关的查询<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 550.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{q}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
</g>
</svg>时，第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
</g>
</svg>个输入向量受关注的程度：</p>
<script type="math/tex; mode=display">
\alpha_n = p(z=n|\boldsymbol{X},q)\\
=softmax(s(\boldsymbol{x}_n,\boldsymbol{q}))\\
=\frac{\exp{(s(\boldsymbol{x}_n,\boldsymbol{q}))}}{\sum^N_{j=1} \exp{(s(\boldsymbol{x}_j,\boldsymbol{q}))}} \tag{2})</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.744ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2903.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s(\boldsymbol{x},\boldsymbol{q})</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-73" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="469" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-78" x="859" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-71" x="1963" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2514" y="0"></use>
</g>
</svg>为<strong>注意力打分函数</strong>，是注意力机制中最重要的一部分，它主要计算的是注意力分数的大小。可以通过以下几种方式计算：</p>
<ul>
<li><p>加性（感知机）模型</p>
<script type="math/tex; mode=display">
s(\boldsymbol{x},\boldsymbol{q})=\boldsymbol{v}^T \tanh(\boldsymbol{Wx+Uq}) \tag{3}</script></li>
<li><p>点积模型</p>
<script type="math/tex; mode=display">
s(\boldsymbol{x},\boldsymbol{q})=\boldsymbol{x}^T \boldsymbol{q} \tag{4}</script></li>
<li><p>缩放点击模型</p>
<script type="math/tex; mode=display">
s(\boldsymbol{x},\boldsymbol{q})=\frac{\boldsymbol{x}^T \boldsymbol{q}}{\sqrt{D}} \tag{5}</script></li>
<li><p>双线性模型</p>
<script type="math/tex; mode=display">
s(\boldsymbol{x},\boldsymbol{q})=\boldsymbol{x}^T \boldsymbol{Wq}  \tag{6}</script></li>
</ul>
<p>各自的优缺点:</p>
<ol>
<li>加性模型对于大规模数据特别有效，但是训练成本较高。</li>
<li>理论上，点积模型和加性模型复杂度差不多，但是点积模型只利用矩阵相乘，计算效率更高。</li>
<li>输入向量维度较高时，最后得到的权重会增加，为了提升计算效率，防止数据上溢，对齐scaling，即缩放点积模型。</li>
<li>双线性模型通过权重矩阵直接建立x和q的关系映射，比较直接且速度较快。双线性模型的公式也可以写为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="34.596ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 14895.4 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s(\boldsymbol{x},\boldsymbol{q})=\boldsymbol{x}^T \boldsymbol{U}^T \boldsymbol{Vq}=(\boldsymbol{Ux})^T(\boldsymbol{Vq})</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMATHI-54" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-55" d="M856 686Q877 686 877 668Q877 663 873 649T867 631Q861 624 828 624Q762 622 757 617Q757 613 705 409T651 200Q620 112 540 48T328 -16Q251 -16 196 2T113 51T75 112T63 176Q63 202 70 232T117 422Q129 469 141 520T160 598L167 623Q167 624 123 624H96Q79 624 73 626T64 639Q68 678 81 684Q85 686 104 686Q155 684 268 684Q340 684 377 685T418 686Q441 686 441 668Q437 632 425 626Q421 624 371 624H322L270 415Q224 232 217 198T209 141Q209 45 336 45Q372 45 406 52T475 77T540 128T585 211L590 229Q594 247 601 274T617 336T636 409T654 482T670 547T681 595T686 618Q686 620 685 620H683Q681 621 678 621T671 622Q660 622 630 624Q616 624 610 624T598 626T589 630T587 640Q587 647 590 659Q594 677 598 681T613 686Q618 686 653 685T740 684Q775 684 801 684T840 685T856 686Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-56" d="M401 686Q415 680 415 668Q415 651 404 629Q398 624 356 624Q318 624 318 623Q318 620 337 508T377 284L397 174L472 285Q548 396 623 507T699 620Q698 621 652 624Q634 624 627 627T619 641Q619 648 622 658Q627 677 631 681T650 686Q654 686 686 685T766 684Q794 684 823 684T858 685Q874 685 878 683T886 671Q886 667 882 651Q877 632 873 628T850 624Q800 624 779 617Q774 617 770 613Q767 610 560 304T350 -5Q346 -9 332 -16H306H291Q270 -16 267 -2Q267 -1 260 37T238 161T210 313L156 624H116H94Q62 624 62 642Q66 678 78 684Q82 686 99 686Q144 684 246 684Q330 684 368 685L401 686Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-73" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="469" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-78" x="859" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-71" x="1963" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2514" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="3181" y="0"></use>
<g transform="translate(4237,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="932" y="583"></use>
</g>
<g transform="translate(5495,0)">
 <use xlink:href="#E1-MJMATHBI-55" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="1273" y="583"></use>
</g>
<g transform="translate(6994,0)">
 <use xlink:href="#E1-MJMATHBI-56" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-71" x="886" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="8708" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="9765" y="0"></use>
<g transform="translate(10154,0)">
 <use xlink:href="#E1-MJMATHBI-55" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-78" x="877" y="0"></use>
</g>
<g transform="translate(11691,0)">
 <use xlink:href="#E1-MJMAIN-29" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="550" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-28" x="12679" y="0"></use>
<g transform="translate(13068,0)">
 <use xlink:href="#E1-MJMATHBI-56" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-71" x="886" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="14505" y="0"></use>
</g>
</svg>，与点积模型相比，计算相似度时引入了非对称性。</li>
</ol>
<h1 id="注意力机制的变体"><a href="#注意力机制的变体" class="headerlink" title="注意力机制的变体"></a>注意力机制的变体</h1><h2 id="硬性注意力"><a href="#硬性注意力" class="headerlink" title="硬性注意力"></a>硬性注意力</h2><p>上面介绍的是软性注意力，其选择的信息是所有输入向量在注意力分布下的期望。此外，还有一种注意力是只关注某一个输入向量，叫作<strong>硬性注意力(Hard Attention)</strong>。</p>
<p>硬性注意力有两种方式：</p>
<ol>
<li><p>一种是选取最高概率的一个输入向量，即：</p>
<script type="math/tex; mode=display">
att(\boldsymbol{X,q})=\boldsymbol{x}_{\hat{n}}  \tag{7}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 600.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\hat{n}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5E" x="50" y="21"></use>
</g>
</svg>是概率最大的输入向量的下标，即<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.536ex" height="5.176ex" style="vertical-align: -2.005ex;" viewBox="0 -1365.4 6689 2228.5" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\hat{n}=\arg\max^\limits{N}_{n=1} \alpha_n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E2-MJMAIN-5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"></path>
<path stroke-width="1" id="E2-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E2-MJMAIN-61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z"></path>
<path stroke-width="1" id="E2-MJMAIN-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"></path>
<path stroke-width="1" id="E2-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E2-MJMAIN-6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path>
<path stroke-width="1" id="E2-MJMAIN-78" d="M201 0Q189 3 102 3Q26 3 17 0H11V46H25Q48 47 67 52T96 61T121 78T139 96T160 122T180 150L226 210L168 288Q159 301 149 315T133 336T122 351T113 363T107 370T100 376T94 379T88 381T80 383Q74 383 44 385H16V431H23Q59 429 126 429Q219 429 229 431H237V385Q201 381 201 369Q201 367 211 353T239 315T268 274L272 270L297 304Q329 345 329 358Q329 364 327 369T322 376T317 380T310 384L307 385H302V431H309Q324 428 408 428Q487 428 493 431H499V385H492Q443 385 411 368Q394 360 377 341T312 257L296 236L358 151Q424 61 429 57T446 50Q464 46 499 46H516V0H510H502Q494 1 482 1T457 2T432 2T414 3Q403 3 377 3T327 1L304 0H295V46H298Q309 46 320 51T331 63Q331 65 291 120L250 175Q249 174 219 133T185 88Q181 83 181 74Q181 63 188 55T206 46Q208 46 208 23V0H201Z"></path>
<path stroke-width="1" id="E2-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E2-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E2-MJMATHI-3B1" d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-MJMATHI-6E" x="0" y="0"></use>
 <use xlink:href="#E2-MJMAIN-5E" x="50" y="21"></use>
 <use xlink:href="#E2-MJMAIN-3D" x="878" y="0"></use>
<g transform="translate(1934,0)">
 <use xlink:href="#E2-MJMAIN-61"></use>
 <use xlink:href="#E2-MJMAIN-72" x="500" y="0"></use>
 <use xlink:href="#E2-MJMAIN-67" x="893" y="0"></use>
</g>
<g transform="translate(3494,0)">
 <use xlink:href="#E2-MJMAIN-6D"></use>
 <use xlink:href="#E2-MJMAIN-61" x="833" y="0"></use>
 <use xlink:href="#E2-MJMAIN-78" x="1334" y="0"></use>
<g transform="translate(266,-651)">
 <use transform="scale(0.707)" xlink:href="#E2-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-MJMAIN-3D" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-MJMAIN-31" x="1379" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E2-MJMATHI-4E" x="872" y="917"></use>
</g>
<g transform="translate(5523,0)">
 <use xlink:href="#E2-MJMATHI-3B1" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E2-MJMATHI-6E" x="905" y="-213"></use>
</g>
</g>
</svg>.</p>
</li>
<li><p>另一种通过在注意力分布上随机采样的方式实现。</p>
</li>
</ol>
<blockquote>
<p>硬性注意力的缺点是基于最大采样或随机采样的方式选择信息，使得最终的损失函数与注意力分布之间的函数关系不可导，无法使用反向传播算法进行训练，因此，硬性注意力通常需要使用强化学习来进行训练，为了使用反向传播算法，一般使用软性注意力代替硬性注意力。</p>
</blockquote>
<h2 id="键值对注意力"><a href="#键值对注意力" class="headerlink" title="键值对注意力"></a>键值对注意力</h2><p><strong>键值对(key-value pair)注意力</strong>用<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="34.414ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 14817 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">(\boldsymbol{K,V})=[(\boldsymbol{k_1,v_1}),\ldots,(\boldsymbol{k_N,v_N})]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-4B" d="M536 0Q522 6 522 18Q522 35 533 57Q539 62 557 62Q595 62 601 65L472 330L365 255L342 160Q318 65 317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L422 481Q386 339 386 337L785 621Q779 624 749 624Q726 624 726 641Q726 645 730 659Q734 675 736 679T747 686L786 685Q812 684 888 684Q908 684 934 685T968 686Q1003 686 1003 669Q1003 646 991 629Q985 624 967 624Q918 624 888 617Q884 617 874 613L865 609Q864 608 732 515T599 420Q599 418 686 242T775 65Q784 62 829 62Q847 62 850 61T860 54Q862 52 862 43Q862 10 845 1Q844 1 842 1T836 0T797 1T694 2Q599 2 573 1L536 0Z"></path>
<path stroke-width="1" id="E1-MJMAINB-2C" d="M74 85Q74 120 97 145T159 171Q200 171 226 138Q258 101 258 37Q258 -5 246 -44T218 -109T183 -155T152 -184T135 -194Q129 -194 118 -183T106 -164Q106 -157 115 -149Q121 -145 130 -137T161 -100T195 -35Q197 -28 200 -17T204 3T205 11T199 9T183 3T159 0Q120 0 97 26T74 85Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-56" d="M401 686Q415 680 415 668Q415 651 404 629Q398 624 356 624Q318 624 318 623Q318 620 337 508T377 284L397 174L472 285Q548 396 623 507T699 620Q698 621 652 624Q634 624 627 627T619 641Q619 648 622 658Q627 677 631 681T650 686Q654 686 686 685T766 684Q794 684 823 684T858 685Q874 685 878 683T886 671Q886 667 882 651Q877 632 873 628T850 624Q800 624 779 617Q774 617 770 613Q767 610 560 304T350 -5Q346 -9 332 -16H306H291Q270 -16 267 -2Q267 -1 260 37T238 161T210 313L156 624H116H94Q62 624 62 642Q66 678 78 684Q82 686 99 686Q144 684 246 684Q330 684 368 685L401 686Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-6B" d="M99 -8Q71 -8 58 9T45 39Q45 51 116 336L188 622H184Q183 622 179 622T169 623T157 624T146 624T136 624T131 625Q119 628 119 642Q119 647 123 661T129 679Q133 684 144 685T220 690Q293 694 307 694Q324 694 328 679Q328 674 280 482Q231 290 231 287Q231 285 234 286Q259 302 294 334T356 390T420 433T493 452Q528 452 546 427T564 364Q564 308 538 282T480 256Q456 256 441 269T425 308Q425 339 444 359T483 384L502 389Q502 395 496 398Q493 400 483 400Q465 400 449 395T409 374T373 347T323 305T268 257Q274 256 282 256Q312 251 329 247T371 232T411 202Q431 181 431 146Q431 132 427 110T422 73Q422 44 440 44H442Q462 44 478 64T502 102T514 141Q518 157 522 159T547 162H558Q578 162 578 148Q578 118 537 56T440 -7H432Q374 -7 337 21T299 94Q299 103 301 116T304 139Q304 164 281 181T235 202L212 206H211Q176 47 160 24Q137 -8 99 -8Z"></path>
<path stroke-width="1" id="E1-MJMAINB-31" d="M481 0L294 3Q136 3 109 0H96V62H227V304Q227 546 225 546Q169 529 97 529H80V591H97Q231 591 308 647L319 655H333Q355 655 359 644Q361 640 361 351V62H494V0H481Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-76" d="M380 367Q380 397 406 425T465 453Q493 453 516 430T540 357Q540 314 524 250T467 115T373 13Q338 -8 292 -8Q218 -8 167 23T116 129Q116 178 152 275T189 388Q189 396 187 398T176 401Q148 398 125 372T89 304Q84 288 81 285T61 282H55H44Q24 282 24 296Q24 306 34 330T64 382T116 431T189 452Q231 452 269 429T308 362Q308 346 273 255T238 114Q238 43 306 43Q336 43 363 65T407 118T437 182T456 239T462 268Q462 290 417 315Q380 335 380 367Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-4E" d="M258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 344 686H434Q464 686 477 680Q480 677 607 454Q738 227 739 227Q742 227 789 418T836 618Q836 620 835 620L821 622Q811 622 779 624Q755 624 749 625T740 632Q737 635 737 644Q737 656 742 669T754 685Q755 685 757 685T763 686Q768 686 803 685T890 684Q925 684 951 684T990 685T1006 686Q1014 686 1016 684Q1027 679 1027 668Q1023 632 1011 626Q1007 624 978 624Q912 622 907 617Q907 616 831 314T753 8Q749 0 723 0H712Q699 0 692 7Q692 8 671 44T607 155T526 296L361 580L296 323Q234 74 234 68T302 62H307Q334 62 334 44Q330 6 317 2L313 0L280 1Q260 2 181 2Q125 2 96 1T63 0Q48 0 43 15Q43 19 47 35Q52 55 57 58T94 62Q147 64 164 69L233 345Q302 619 302 622Q302 624 258 624Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-28" x="0" y="0"></use>
<g transform="translate(389,0)">
 <use xlink:href="#E1-MJMATHBI-4B" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAINB-2C" x="1003" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-56" x="1489" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2765" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="3432" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="4489" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="4767" y="0"></use>
<g transform="translate(5157,0)">
 <use xlink:href="#E1-MJMATHBI-6B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAINB-31" x="854" y="-213"></use>
 <use xlink:href="#E1-MJMAINB-2C" x="1111" y="0"></use>
<g transform="translate(1597,0)">
 <use xlink:href="#E1-MJMATHBI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAINB-31" x="802" y="-213"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="7829" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="8218" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="8663" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="10003" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="10448" y="0"></use>
<g transform="translate(10837,0)">
 <use xlink:href="#E1-MJMATHBI-6B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHBI-4E" x="854" y="-213"></use>
 <use xlink:href="#E1-MJMAINB-2C" x="1431" y="0"></use>
<g transform="translate(1917,0)">
 <use xlink:href="#E1-MJMATHBI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHBI-4E" x="802" y="-213"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="14149" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5D" x="14538" y="0"></use>
</g>
</svg>表示<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.064ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 888.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4E" x="0" y="0"></use>
</g>
</svg>组输入信息，给定任务相关的查询向量<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 550.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{q}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
</g>
</svg>时，注意力函数为：</p>
<script type="math/tex; mode=display">
att((\boldsymbol{K,V}),\boldsymbol{q})=\sum^N_{n=1}{\alpha_n\boldsymbol{v}_n},\\
=\sum^N_{n=1}{\frac{\exp(s(\boldsymbol{k}_n,\boldsymbol{q}))}{\sum _j \exp(s(\boldsymbol{k}_n,\boldsymbol{q}))}} \boldsymbol{v}_n        \tag{8}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.744ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2903.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">s(\boldsymbol{x},\boldsymbol{q})</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-73" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="469" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-78" x="859" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1518" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-71" x="1963" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2514" y="0"></use>
</g>
</svg>为打分函数，当<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.758ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 3340.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{K=V}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-4B" d="M536 0Q522 6 522 18Q522 35 533 57Q539 62 557 62Q595 62 601 65L472 330L365 255L342 160Q318 65 317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L422 481Q386 339 386 337L785 621Q779 624 749 624Q726 624 726 641Q726 645 730 659Q734 675 736 679T747 686L786 685Q812 684 888 684Q908 684 934 685T968 686Q1003 686 1003 669Q1003 646 991 629Q985 624 967 624Q918 624 888 617Q884 617 874 613L865 609Q864 608 732 515T599 420Q599 418 686 242T775 65Q784 62 829 62Q847 62 850 61T860 54Q862 52 862 43Q862 10 845 1Q844 1 842 1T836 0T797 1T694 2Q599 2 573 1L536 0Z"></path>
<path stroke-width="1" id="E1-MJMAINB-3D" d="M87 333Q64 343 64 362Q64 383 84 391Q89 393 448 393H807Q808 392 811 390T817 386T823 381T827 374T829 363Q829 345 807 333H87ZM87 109Q64 118 64 139Q64 159 86 168Q89 169 448 169H807L812 166Q816 163 818 162T823 157T827 149T829 139Q829 118 807 109H87Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-56" d="M401 686Q415 680 415 668Q415 651 404 629Q398 624 356 624Q318 624 318 623Q318 620 337 508T377 284L397 174L472 285Q548 396 623 507T699 620Q698 621 652 624Q634 624 627 627T619 641Q619 648 622 658Q627 677 631 681T650 686Q654 686 686 685T766 684Q794 684 823 684T858 685Q874 685 878 683T886 671Q886 667 882 651Q877 632 873 628T850 624Q800 624 779 617Q774 617 770 613Q767 610 560 304T350 -5Q346 -9 332 -16H306H291Q270 -16 267 -2Q267 -1 260 37T238 161T210 313L156 624H116H94Q62 624 62 642Q66 678 78 684Q82 686 99 686Q144 684 246 684Q330 684 368 685L401 686Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-4B" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAINB-3D" x="1281" y="0"></use>
 <use xlink:href="#E1-MJMATHBI-56" x="2453" y="0"></use>
</g>
</svg>时，键值对模式就等价于普通的注意力机制。</p>
<p>键值对注意力机制的示例如下图：</p>
<div align="center"> 
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/attention_2.png">
</div>

<h2 id="多头注意力"><a href="#多头注意力" class="headerlink" title="多头注意力"></a>多头注意力</h2><p><strong>多头注意力(Multi-Head Attention)</strong>是利用多个查询<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="17.123ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 7372.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{Q}=[\boldsymbol{q}_1,\ldots,\boldsymbol{q}_M]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-51" d="M53 245Q53 297 70 356T125 478T216 590T349 671T523 703Q656 703 735 637T815 445Q815 410 808 370T781 277T729 178T643 87T519 14L525 4Q540 -19 553 -25T592 -32Q632 -32 654 -24T680 -7T689 10T704 18Q713 18 717 12T722 0Q722 -8 711 -36T681 -101T624 -166T541 -194Q513 -194 494 -183T465 -157T450 -118T444 -79T443 -41V-7L433 -9Q391 -17 344 -17Q301 -17 263 -10T185 15T118 62T71 138T53 245ZM666 482Q666 529 652 563T614 615T565 640T512 648Q412 648 335 573Q268 506 235 389T201 202Q201 164 210 136T230 95T259 66L262 76Q269 109 302 135T382 162Q401 162 415 159T449 140T484 92L491 78L496 82Q502 86 505 88T515 97T528 107T541 120T555 137T570 156T585 179T599 205T612 235Q629 278 647 351T666 482ZM439 56Q439 58 439 62T435 75T426 92T410 106T383 112Q353 112 332 96T311 63Q311 38 355 38H366Q391 39 415 45T439 56Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4D" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-51" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1147" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2203" y="0"></use>
<g transform="translate(2482,0)">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="767" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3478" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="3923" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="5262" y="0"></use>
<g transform="translate(5707,0)">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4D" x="767" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="7093" y="0"></use>
</g>
</svg>，来并行地从输入信息中选取多个多组信息，每个注意力关注输入信息的不同表示空间：</p>
<script type="math/tex; mode=display">
att((\boldsymbol{K,V}),\boldsymbol{Q}) = att((\boldsymbol{K,V}),\boldsymbol{q}_1)) \oplus \ldots \oplus att((\boldsymbol{K,V}),\boldsymbol{q}_M))   \tag{9}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="2.176ex" style="vertical-align: -0.505ex;" viewBox="0 -719.6 778.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\oplus</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-2295" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM364 542Q308 539 251 509T148 418T96 278V270H369V542H364ZM681 278Q675 338 650 386T592 462T522 509T458 535T412 542H409V270H681V278ZM96 222Q104 150 139 95T219 12T302 -29T366 -42H369V230H96V222ZM681 222V230H409V-42H412Q429 -42 456 -36T521 -10T590 37T649 113T681 222Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-2295" x="0" y="0"></use>
</g>
</svg>表示向量拼接。</p>
<p>多头注意力通常用在自注意力之后，详情参见<a href="http://kangshitao.github.io/2020/11/15/transformer/index.html">自注意力和Transformer</a>.</p>
<h2 id="指针网络"><a href="#指针网络" class="headerlink" title="指针网络"></a>指针网络</h2><p>注意力机制主要是用来做信息筛选，从输入信息中选取相关的信息。注意力机制可以分为两步：<strong>一是计算注意力分布<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.488ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 640.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\alpha</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B1" d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3B1" x="0" y="0"></use>
</g>
</svg>，二是根据<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.488ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 640.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\alpha</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B1" d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3B1" x="0" y="0"></use>
</g>
</svg>来计算输入信息的加权平均</strong>。我们可以只利用注意力机制中的第一步，将<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.488ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 640.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\alpha</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B1" d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3B1" x="0" y="0"></use>
</g>
</svg>作为一个软性的<strong>指针(poiner)</strong>来指出相关信息的位置。</p>
<p><a href="https://proceedings.neurips.cc/paper/2015/hash/29921001f2f04bd3baee84a12e98098f-Abstract.html"><strong>指针网络</strong></a>是一种序列到序列模型，输入是长度为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.064ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 888.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4E" x="0" y="0"></use>
</g>
</svg>的向量序列<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.3ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 7018.2 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{X}=\boldsymbol{x}_1,\ldots,\boldsymbol{x}_N</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1231" y="0"></use>
<g transform="translate(2287,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="932" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3400" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="3846" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="5185" y="0"></use>
<g transform="translate(5630,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="932" y="-213"></use>
</g>
</g>
</svg>，输出是长度为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.442ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 1051.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4D" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4D" x="0" y="0"></use>
</g>
</svg>的下标序列<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20.83ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 8968.4 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{c}_{1:M}=c_1,c_2,\ldots,c_M</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-63" d="M362 325Q362 344 371 361T390 386L399 394Q390 401 355 401Q276 401 231 338Q207 301 189 230T170 122Q170 43 264 43Q392 43 457 105Q472 120 480 117Q486 114 497 102T509 83Q509 79 502 70T477 47T432 21T360 1T259 -8Q194 -8 148 9T80 54T49 109T40 167Q40 280 129 365T352 451Q390 451 396 450Q448 442 473 416T499 358T477 302T421 274H417Q393 274 378 288T362 325Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4D" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-63" x="0" y="0"></use>
<g transform="translate(513,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4D" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="2185" y="0"></use>
<g transform="translate(3241,0)">
 <use xlink:href="#E1-MJMATHI-63" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="613" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4129" y="0"></use>
<g transform="translate(4574,0)">
 <use xlink:href="#E1-MJMATHI-63" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="613" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="5461" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="5907" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="7246" y="0"></use>
<g transform="translate(7691,0)">
 <use xlink:href="#E1-MJMATHI-63" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4D" x="613" y="-213"></use>
</g>
</g>
</svg>，其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.443ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 6649.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">c_m \in [1,N],\forall m</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2200" d="M0 673Q0 684 7 689T20 694Q32 694 38 680T82 567L126 451H430L473 566Q483 593 494 622T512 668T519 685Q524 694 538 694Q556 692 556 674Q556 670 426 329T293 -15Q288 -22 278 -22T263 -15Q260 -11 131 328T0 673ZM414 410Q414 411 278 411T142 410L278 55L414 410Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-63" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="613" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1432" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2377" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="2656" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="3156" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4E" x="3601" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5D" x="4490" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="4768" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2200" x="5214" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6D" x="5770" y="0"></use>
</g>
</svg>.</p>
<p>和一般的Seq2Seq任务不同，这里的输出序列是输入序列的下标（索引），比如输入一组乱序的数字，输出为按大小排序的输入数字序列的下标，比如输入为20,5,10，输出是1,3,2。</p>
<p>条件概率<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.463ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.089ex;" viewBox="-38.5 -863.1 5366 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p(c_{1:M}|\boldsymbol{x}_{1:N})</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4D" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-70" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-MJMATHI-63" x="0" y="0"></use>
<g transform="translate(433,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4D" x="779" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-7C" x="2720" y="0"></use>
<g transform="translate(2999,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
<g transform="translate(659,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="779" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="4937" y="0"></use>
</g>
</svg>可以写为：</p>
<script type="math/tex; mode=display">
p(c_{1:M}|\boldsymbol{x}_{1:N}) = \prod^M_{m=1} p(c_m|c_{1:(m-1)},\boldsymbol{x}_{1:N}) \\
\thickapprox {\prod^M_{m=1} p(c_m|\boldsymbol{x}_{c_1},\ldots,\boldsymbol{x}_{c_{m-1}},\boldsymbol{x}_{1:N})}  \tag{10}</script><p>其中条件概率<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="25.936ex" height="3.009ex" style="vertical-align: -1.005ex; margin-left: -0.089ex;" viewBox="-38.5 -863.1 11166.8 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">p(c_m|\boldsymbol{x}_{c_1},\ldots,\boldsymbol{x}_{c_{m-1}},\boldsymbol{x}_{1:N})</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-70" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="503" y="0"></use>
<g transform="translate(893,0)">
 <use xlink:href="#E1-MJMATHI-63" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="613" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-7C" x="2047" y="0"></use>
<g transform="translate(2326,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
<g transform="translate(659,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMAIN-31" x="533" y="-243"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3750" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="4195" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="5534" y="0"></use>
<g transform="translate(5979,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
<g transform="translate(659,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="0" y="0"></use>
<g transform="translate(306,-140)">
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-6D" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMAIN-2212" x="878" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMAIN-31" x="1657" y="0"></use>
</g>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="8355" y="0"></use>
<g transform="translate(8800,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
<g transform="translate(659,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="779" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="10738" y="0"></use>
</g>
</svg>可以通过<strong>注意力分布</strong>来计算。</p>
<p>关于指针网络的详情可以参考<a href="https://zhuanlan.zhihu.com/p/48959800">Pointer Networks简介及其应用</a>.</p>
]]></content>
      <categories>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>Attention</tag>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Conda基础命令</title>
    <url>/2020/10/28/conda/</url>
    <content><![CDATA[<blockquote>
<p>Conda是一个开源的软件包管理系统和环境管理系统，用于安装多个版本的软件包及其依赖关系，并在它们之间轻松切换。</p>
<p><a href="https://www.anaconda.com/">Anaconda</a>是一个开源的Python发行版本，包含了conda、python等180多个科学包及其依赖项。</p>
<p><a href="https://docs.conda.io/en/latest/miniconda.html">Miniconda</a>是最小的conda安装环境，只包含最基本的内容——python和conda，以及相关的必须依赖项。</p>
</blockquote>
<hr>
<blockquote>
<p><strong>参考文档：官方<a href="https://docs.conda.io/projects/conda/en/latest/commands.html">Conda命令参考</a></strong></p>
</blockquote>
<h1 id="Conda-指令"><a href="#Conda-指令" class="headerlink" title="Conda 指令"></a>Conda 指令</h1><h2 id="查看指令"><a href="#查看指令" class="headerlink" title="查看指令"></a>查看指令</h2><figure class="highlight crmsh"><table><tbody><tr><td class="code"><pre><code class="hljs crmsh">conda -V 或 conda --<span class="hljs-keyword">version</span>	<span class="hljs-comment"># 查看conda版本</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">conda</span> env list 或 conda <span class="hljs-literal">info</span> --envs  <span class="hljs-comment"># 查看存在哪些虚拟环境</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="更新Conda"><a href="#更新Conda" class="headerlink" title="更新Conda"></a>更新Conda</h2><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">conda</span> update conda  <span class="hljs-comment"># 检查并更新当前conda</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="创建虚拟环境"><a href="#创建虚拟环境" class="headerlink" title="创建虚拟环境"></a>创建虚拟环境</h2><figure class="highlight sas"><table><tbody><tr><td class="code"><pre><code class="hljs sas">conda <span class="hljs-meta">create</span> -n [env_name] python=<span class="hljs-meta">x</span>.<span class="hljs-meta">x</span>	# 创建python版本号为<span class="hljs-meta">x</span>.<span class="hljs-meta">x</span>的虚拟环境<br></code></pre></td></tr></tbody></table></figure>
<h2 id="激活-切换虚拟环境"><a href="#激活-切换虚拟环境" class="headerlink" title="激活/切换虚拟环境"></a>激活/切换虚拟环境</h2><figure class="highlight apache"><table><tbody><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Windows</span>： activate<span class="hljs-meta"> [env_name]</span><br><span class="hljs-attribute">Linux</span>: source activate<span class="hljs-meta"> [env_name]</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="关闭-退出虚拟环境"><a href="#关闭-退出虚拟环境" class="headerlink" title="关闭/退出虚拟环境"></a>关闭/退出虚拟环境</h2><figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><code class="hljs applescript">conda deactivate  <span class="hljs-comment">#　退出当前虚拟环境</span><br><span class="hljs-built_in">activate</span> [env_name]  <span class="hljs-comment"># 切换到其他环境，也相当于关闭当前环境</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="删除虚拟环境"><a href="#删除虚拟环境" class="headerlink" title="删除虚拟环境"></a>删除虚拟环境</h2><figure class="highlight lua"><table><tbody><tr><td class="code"><pre><code class="hljs lua">conda <span class="hljs-built_in">remove</span> -n [env_name] <span class="hljs-comment">--all</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="设置镜像"><a href="#设置镜像" class="headerlink" title="设置镜像"></a>设置镜像</h2><figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><code class="hljs routeros">conda<span class="hljs-built_in"> config </span>--<span class="hljs-builtin-name">add</span> channels [mirroe_url]   # 添加镜像地址<br>conda<span class="hljs-built_in"> config </span>--<span class="hljs-builtin-name">set</span> show_channel_urls <span class="hljs-literal">yes</span>   # 设置搜索时显示通道地址<br>conda<span class="hljs-built_in"> config </span>--<span class="hljs-builtin-name">get</span> channels                # 查看已经配置的channels<br>conda<span class="hljs-built_in"> config </span>--remove-key channels  	   # 恢复为默认地址(删除所有其他镜像url)<br></code></pre></td></tr></tbody></table></figure>
<hr>
<h1 id="Conda的package管理命令"><a href="#Conda的package管理命令" class="headerlink" title="Conda的package管理命令"></a>Conda的package管理命令</h1><h2 id="查看已安装的包"><a href="#查看已安装的包" class="headerlink" title="查看已安装的包"></a>查看已安装的包</h2><figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><code class="hljs applescript">conda <span class="hljs-built_in">list</span>	<span class="hljs-comment"># 查看当前环境已安装的所有包</span><br>conda <span class="hljs-built_in">list</span> -n [env_name]	<span class="hljs-comment"># 查看指定环境已安装的所有包</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="安装包"><a href="#安装包" class="headerlink" title="安装包"></a>安装包</h2><figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><code class="hljs cmake">conda <span class="hljs-keyword">install</span> [package_name]	<span class="hljs-comment"># 当前环境下安装包</span><br>conda <span class="hljs-keyword">install</span> -n [env_name] [package_name]	<span class="hljs-comment"># 指定环境先安装包</span><br><span class="hljs-comment"># 还可以使用-c参数，指定通过某个channel安装</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="更新包"><a href="#更新包" class="headerlink" title="更新包"></a>更新包</h2><figure class="highlight sql"><table><tbody><tr><td class="code"><pre><code class="hljs sql">conda <span class="hljs-keyword">update</span> [package_name]		<span class="hljs-comment"># 更新当前环境下的包</span><br>conda <span class="hljs-keyword">update</span> -n [env_name] [package_name]	<span class="hljs-comment"># 更新指定环境下的包</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="删除包"><a href="#删除包" class="headerlink" title="删除包"></a>删除包</h2><figure class="highlight cmake"><table><tbody><tr><td class="code"><pre><code class="hljs cmake">conda <span class="hljs-keyword">remove</span> [package_name]		<span class="hljs-comment"># 删除当前环境下的包</span><br>conda <span class="hljs-keyword">remove</span> -n [env_name] [package_name	<span class="hljs-comment"># 删除指定环境下的包</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="查找包的信息"><a href="#查找包的信息" class="headerlink" title="查找包的信息"></a>查找包的信息</h2><figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">conda</span> search [package_name]	<span class="hljs-comment"># 查找指定包的信息</span><br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>教程</category>
      </categories>
      <tags>
        <tag>Conda</tag>
      </tags>
  </entry>
  <entry>
    <title>Python爬虫-m3u8视频爬取</title>
    <url>/2021/01/02/crawler-wuchizhitu/</url>
    <content><![CDATA[<p>m3u8文件+ts文件是很多流媒体网站常用的一种方法，本文作为爬虫练习项目，记录了如何使用python爬虫爬取某视频网站的视频资源。</p>
<h1 id="一、分析"><a href="#一、分析" class="headerlink" title="一、分析"></a>一、分析</h1><p>第一步是确定想要爬取的资源地址，通过网页源代码找到资源的url。</p>
<p>F12进入开发者模式，找到m3u8后缀的文件，可以看到有两个，把第一个m3u8文件下载下来以后发现，其内容是第二个m3u8的地址，第二个m3u8的url才是真实的地址</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/crawler-wuchizhitu1.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/crawler-wuchizhitu3.png"><span class="image-caption">第一个m3u8文件内容</span></p>
<p>可见，第一个m3u8文件的内容，是真正的m3u8的地址。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/crawler-wuchizhitu2.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/crawler-wuchizhitu4.png"><span class="image-caption">第二个m3u8文件内容</span></p>
<p>第二个m3u8文件中的内容才是真正的ts文件的地址。</p>
<p>每一集视频是由多个ts文件构成的，将这些ts文件拼接起来就是完整的一集内容。这些ts文件的url都保存到第二个m3u8文件中。因此可以确定大体流程：</p>
<ol>
<li>获取当前集的m3u8地址，并下载m3u8文件。</li>
<li>从m3u8文件中获取ts视频的url。</li>
<li>根据ts文件的url下载视频。</li>
<li>将多个ts文件合并，得到完整的一集内容，保存到相应路径。</li>
</ol>
<h1 id="二、获取m3u8文件"><a href="#二、获取m3u8文件" class="headerlink" title="二、获取m3u8文件"></a>二、获取m3u8文件</h1><p>分析网页源代码，可以看到m3u8的url保存在一个playurls的列表中，并且一季的所有集的地址都在，因此只需要在其中一集的网页源代码中获取出当前季的所有集的url即可：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 获取每季中每集的m3u8地址,每季只获取一次即可</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_m3u8_list</span>(<span class="hljs-params">url,S</span>):</span><br>    req = requests.get(url)<br>    req.encoding = <span class="hljs-string">'utf-8'</span><br>    html = req.text<br>    <span class="hljs-comment"># 使用正则表达式从网页代码中找到m3u8的地址</span><br>    res_url = re.findall(<span class="hljs-string">r'https:\\/\\/youku.com-youku.net.*?index.m3u8'</span>, html, re.S)<br>    m3u8list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(res_url)):<br>        url = res_url[i].split(<span class="hljs-string">'\\'</span>)<br>        <span class="hljs-comment"># m3u8文件下载下来以后，文件内容才是真正的m3u8地址，这里偷个懒，手动构建url</span><br>        <span class="hljs-comment"># 真正的url多了'1000k/hls',手动添加上即可</span><br>        m3u8list.append(<span class="hljs-string">''</span>.join(url[:<span class="hljs-number">-1</span>])+<span class="hljs-string">'/1000k/hls/index.m3u8'</span>)<br>        print(m3u8list[i])<br>    print(<span class="hljs-string">'第{}季m3u8地址获取完毕'</span>.<span class="hljs-built_in">format</span>(S))<br>    <span class="hljs-keyword">return</span> m3u8list<br></code></pre></td></tr></tbody></table></figure>
<p>常规思路是获取到第一层m3u8文件，然后从中获取到真正的m3u8的地址，通过分析，真正的url是在第一层的url后面两个文件路径(仅对于当前视频网站，具体需要根据实际情况分析)，这里手动添加上了，没有读取文件。</p>
<h1 id="三、获取ts文件url并下载"><a href="#三、获取ts文件url并下载" class="headerlink" title="三、获取ts文件url并下载"></a>三、获取ts文件url并下载</h1><p>获取到m3u8文件的地址后，就可以下载文件，通过读取文件内容，获取到当前集的所有ts文件url，然后下载。</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 下载文件</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download</span>(<span class="hljs-params">m3u8_list,base_path,S</span>):</span>  <span class="hljs-comment"># base_path: "F://Shameless//",S表示当前季数</span><br>    print(<span class="hljs-string">'下载m3u8文件...'</span>)<br>    url = base_path+<span class="hljs-string">'Shameless_'</span>+<span class="hljs-string">'S'</span>+<span class="hljs-built_in">str</span>(S)  <span class="hljs-comment"># F://Shameless//Shameless_S1</span><br>    path = Path(url)<br>    <span class="hljs-comment"># 如果文件夹不存在，则创建</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> path.is_dir():<br>        os.mkdir(url)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(m3u8_list)):<br>        print(<span class="hljs-string">'正在下载第{}集...'</span>.<span class="hljs-built_in">format</span>(i+<span class="hljs-number">1</span>))<br>        start = datetime.datetime.now().replace(microsecond=<span class="hljs-number">0</span>)<br>        time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># sleep一秒</span><br>        ts_urls = []  <span class="hljs-comment"># 保存每一集的ts文件的真实url</span><br>        m3u8 = requests.get(url=m3u8_list[i])<br>        content = m3u8.text.split(<span class="hljs-string">'\n'</span>)<br>        <span class="hljs-comment"># 获取ts文件地址</span><br>        <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> content: <br>            <span class="hljs-keyword">if</span> s.endswith(<span class="hljs-string">'.ts'</span>): <br>                ts_url = m3u8_list[i][:<span class="hljs-number">-10</span>] + s.strip(<span class="hljs-string">'\n'</span>) <span class="hljs-comment"># 生成ts文件的真实url</span><br>                ts_urls.append(ts_url)<br>        download_ts(ts_urls,down_path=url+<span class="hljs-string">'//'</span>+<span class="hljs-string">"E"</span>+<span class="hljs-built_in">str</span>(i+<span class="hljs-number">1</span>)+<span class="hljs-string">'.ts'</span>)  <span class="hljs-comment"># 根据ts的url下载每集的ts文件</span><br>        end = datetime.datetime.now().replace(microsecond=<span class="hljs-number">0</span>)<br>        print(<span class="hljs-string">'耗时：%s'</span> % (end - start))<br>        print(<span class="hljs-string">'第{}集下载完成...'</span>.<span class="hljs-built_in">format</span>(i+<span class="hljs-number">1</span>))<br><br><br><span class="hljs-comment"># 根据ts下载链接下载文件，并合并为完整的视频文件</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download_ts</span>(<span class="hljs-params">ts_urls,down_path</span>):</span><br>    file = <span class="hljs-built_in">open</span>(down_path, <span class="hljs-string">'wb'</span>)  <span class="hljs-comment"># 这里将每个ts文件添加到file里面，即合并</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(ts_urls))):<br>        ts_url = ts_urls[i]  <span class="hljs-comment"># 例:https://youku.com-youku.net/20180626/14084_f3588039/1000k/hls/80ed70a101f861.ts</span><br>        time.sleep(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">try</span>:<br>            response = requests.get(url=ts_url, stream=<span class="hljs-literal">True</span>, verify=<span class="hljs-literal">False</span>)<br>            file.write(response.content)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            print(<span class="hljs-string">'异常请求：%s'</span> % e.args)<br>    file.close()<br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、总结"><a href="#四、总结" class="headerlink" title="四、总结"></a>四、总结</h1><h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p>完整代码如下：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pathlib <span class="hljs-keyword">import</span> Path<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> datetime<br><span class="hljs-keyword">from</span> tqdm <span class="hljs-keyword">import</span> tqdm<br><br><span class="hljs-keyword">import</span> urllib3<br>urllib3.disable_warnings()  <span class="hljs-comment"># 禁用证书认证和警告</span><br><br><br><span class="hljs-comment"># 获取每季中每集的m3u8地址,每季只获取一次即可</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_m3u8_list</span>(<span class="hljs-params">url,S</span>):</span><br>    req = requests.get(url)<br>    req.encoding = <span class="hljs-string">'utf-8'</span><br>    html = req.text<br>    res_url = re.findall(<span class="hljs-string">r'https:\\/\\/youku.com-youku.net.*?index.m3u8'</span>, html, re.S)<br>    m3u8list = []<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(res_url)):<br>        url = res_url[i].split(<span class="hljs-string">'\\'</span>)<br>        <span class="hljs-comment"># m3u8文件下载下来以后，文件内容才是真正的m3u8地址，这里为了方便起见，手动构建url</span><br>        <span class="hljs-comment"># 真正的url多了'1000k/hls',这里手动添加上</span><br>        m3u8list.append(<span class="hljs-string">''</span>.join(url[:<span class="hljs-number">-1</span>])+<span class="hljs-string">'/1000k/hls/index.m3u8'</span>)<br>        print(m3u8list[i])<br>    print(<span class="hljs-string">'第{}季m3u8地址获取完毕'</span>.<span class="hljs-built_in">format</span>(S))<br>    <span class="hljs-keyword">return</span> m3u8list<br><br><br><span class="hljs-comment"># 下载ts文件</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download</span>(<span class="hljs-params">m3u8_list,base_path,S</span>):</span>  <span class="hljs-comment"># base_path: "F://Shameless//",S表示当前季数</span><br>    print(<span class="hljs-string">'下载m3u8文件...'</span>)<br>    url = base_path+<span class="hljs-string">'Shameless_'</span>+<span class="hljs-string">'S'</span>+<span class="hljs-built_in">str</span>(S)  <span class="hljs-comment"># F://Shameless//Shameless_S1</span><br>    path = Path(url)<br>    <span class="hljs-comment"># 如果文件夹不存在，则创建</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> path.is_dir():<br>        os.mkdir(url)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(m3u8_list)):<br>        print(<span class="hljs-string">'正在下载第{}集...'</span>.<span class="hljs-built_in">format</span>(i+<span class="hljs-number">1</span>))<br>        start = datetime.datetime.now().replace(microsecond=<span class="hljs-number">0</span>)<br>        time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># sleep一秒</span><br>        ts_urls = []  <span class="hljs-comment"># 保存每一集的ts文件的真实url</span><br>        m3u8 = requests.get(url=m3u8_list[i])<br>        content = m3u8.text.split(<span class="hljs-string">'\n'</span>)<br>        <span class="hljs-keyword">for</span> s <span class="hljs-keyword">in</span> content:<br>            <span class="hljs-keyword">if</span> s.endswith(<span class="hljs-string">'.ts'</span>):<br>                ts_url = m3u8_list[i][:<span class="hljs-number">-10</span>] + s.strip(<span class="hljs-string">'\n'</span>) <span class="hljs-comment"># 生成ts文件的真实url</span><br>                ts_urls.append(ts_url)<br>        download_ts(ts_urls,down_path=url+<span class="hljs-string">'//'</span>+<span class="hljs-string">"E"</span>+<span class="hljs-built_in">str</span>(i+<span class="hljs-number">1</span>)+<span class="hljs-string">'.ts'</span>)  <span class="hljs-comment"># 根据ts的url下载每集的ts文件</span><br>        end = datetime.datetime.now().replace(microsecond=<span class="hljs-number">0</span>)<br>        print(<span class="hljs-string">'耗时：%s'</span> % (end - start))<br>        print(<span class="hljs-string">'第{}集下载完成...'</span>.<span class="hljs-built_in">format</span>(i+<span class="hljs-number">1</span>))<br><br><br><span class="hljs-comment"># 根据ts下载链接下载文件</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">download_ts</span>(<span class="hljs-params">ts_urls,down_path</span>):</span><br>    file = <span class="hljs-built_in">open</span>(down_path, <span class="hljs-string">'wb'</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> tqdm(<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(ts_urls))):<br>        ts_url = ts_urls[i]  <span class="hljs-comment"># 例:https://youku.com-youku.net/20180626/14084_f3588039/1000k/hls/80ed70a101f861.ts</span><br>        time.sleep(<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">try</span>:<br>            response = requests.get(url=ts_url, stream=<span class="hljs-literal">True</span>, verify=<span class="hljs-literal">False</span>)<br>            file.write(response.content)<br>        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>            print(<span class="hljs-string">'异常请求：%s'</span> % e.args)<br>    file.close()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:<br>    savefile_path = <span class="hljs-string">'F://Shameless//'</span><br>    section_url = [<span class="hljs-string">'http://www.tv3w.com/dushiqinggan/wuchizhitudiyiji/5-1.html'</span>,<br>                   <span class="hljs-string">'http://www.tv3w.com/dushiqinggan/wuchizhitudierji/3-1.html'</span>,<br>                   <span class="hljs-string">'http://www.tv3w.com/dushiqinggan/wuchizhitudisanji/4-1.html'</span>,<br>                   <span class="hljs-string">'http://www.tv3w.com/dushiqinggan/wuchizhitudisiji/4-1.html'</span>,<br>                   <span class="hljs-string">'http://www.tv3w.com/dushiqinggan/wuchizhitudiwuji/7-1.html'</span>,<br>                   <span class="hljs-string">'http://www.tv3w.com/dushiqinggan/wuchizhitudiliuji/7-1.html'</span>,<br>                   <span class="hljs-string">'http://www.tv3w.com/dushiqinggan/wuchizhitudiqiji/6-1.html'</span>]<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(section_url)):<br>        print(<span class="hljs-string">'开始下载第{}季...'</span>.<span class="hljs-built_in">format</span>(i+<span class="hljs-number">1</span>))<br>        episode_url = get_m3u8_list(url=section_url[i],S=i+<span class="hljs-number">1</span>) <span class="hljs-comment"># 获取每季中每一集的m3u8地址</span><br>        download(episode_url,savefile_path,i+<span class="hljs-number">1</span>)    <span class="hljs-comment"># 下载每一季的ts文件并拼接</span><br>    print(<span class="hljs-string">'done'</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>目标网站的资源前七季的源是同一个，这里只获取前七季。</p>
<h2 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h2><p>第一次写完整的爬虫代码，可以改进的地方有很多：</p>
<ol>
<li>可以改为自动获取m3u8真实地址。</li>
<li>使用多线程下载，提高下载速度。</li>
<li>添加文件验证机制，确保下载正确。</li>
</ol>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="　参考链接"></a>　参考链接</h1><ol>
<li><a href="https://blog.csdn.net/kingyuan666/article/details/90247526">Python爬虫——从流媒体网站获取的m3u8爬取视频</a></li>
<li><a href="https://www.cnblogs.com/i-am-normal/p/11624225.html">爬取m3u8视频</a></li>
</ol>
]]></content>
      <categories>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>Git命令</title>
    <url>/2020/10/31/git/</url>
    <content><![CDATA[<hr>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Git">Git</a>是一个开源的分布式版本控制系统，用于在软件开发过程中跟踪源代码的变化。</p>
<p>本文参考：</p>
<ul>
<li><p><a href="https://www.liaoxuefeng.com/wiki/896043488029600">Git教程-廖雪峰的官方网站</a></p>
</li>
<li><p><a href="https://git-scm.com/docs">Git官方文档</a></p>
</li>
<li><p><a href="https://gitee.com/liaoxuefeng/learn-java/raw/master/teach/git-cheatsheet.pdf">Git-cheatsheet</a></p>
</li>
</ul>
</blockquote>
<h1 id="基础指令"><a href="#基础指令" class="headerlink" title="基础指令"></a>基础指令</h1><p>在相关文件目录下，右键打开Git，其中Git Bash Here为命令行窗口，Git GUI Here为GUI界面，这里主要是针对命令行窗口。</p>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> mkdir learngit	<span class="hljs-comment"># 创建learngit文件夹     </span><br><span class="hljs-variable">$</span> torch xx.txt  表示创建xx.txt文件<br><span class="hljs-variable">$</span> <span class="hljs-built_in">cd</span> learngit	<span class="hljs-comment"># 进入文件夹</span><br><span class="hljs-variable">$</span> git init    <span class="hljs-comment"># 将当前文件夹初始化为Git仓库</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> git add &lt;file&gt;  <span class="hljs-comment">#　添加特定文件</span><br><span class="hljs-variable">$</span> git add .     <span class="hljs-comment"># 添加所有改动的文件</span><br><span class="hljs-variable">$</span> git commit <span class="hljs-literal">-m</span> <span class="hljs-string">'提交说明'</span>	<span class="hljs-comment"># 提交当前改动，提交说明要写</span><br><span class="hljs-variable">$</span> git push origin master  <span class="hljs-comment"># 推送到远程库的origin master分支，默认为origin master</span><br><span class="hljs-variable">$</span> git status   <span class="hljs-comment"># 查看当前状态，比如有哪些未提交文件等</span><br><span class="hljs-variable">$</span> git <span class="hljs-built_in">diff</span> 		<span class="hljs-comment"># 查看具体修改了什么内容，即查看工作区和暂存区的区别</span><br><span class="hljs-variable">$</span> git <span class="hljs-built_in">diff</span> -<span class="hljs-literal">-cached</span>    <span class="hljs-comment"># 查看暂存区和最后一次commit的差异</span><br><span class="hljs-variable">$</span> git <span class="hljs-built_in">diff</span> HEAD		<span class="hljs-comment"># 查看工作区和最后一次commit的差异</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="工作区和暂存区"><a href="#工作区和暂存区" class="headerlink" title="工作区和暂存区"></a>工作区和暂存区</h1><ul>
<li><strong>工作区</strong>(working directory)是本地电脑看到的一个目录，比如learngit文件夹，或者说是项目文件夹。</li>
<li>工作区中有.git隐藏文件夹，为Git的版本库，其中包括最重要的<strong>暂存区</strong>(stage/index)。Git会自动创建一个分支master，以及指向master的指针HEAD</li>
<li>add操作是将文件添加到暂存区，commit操作将暂存区的所有内容提交到当前分支(本地仓库)，push操作将本地仓库文件推送到远程仓库。</li>
</ul>
<h1 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h1><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git <span class="hljs-built_in">log</span>		<span class="hljs-comment"># 查看提交记录。如果超过一页，空格向下翻页，b向上翻页，q退出</span><br>$ git <span class="hljs-built_in">log</span> --pretty=oneline		<span class="hljs-comment"># 简化查看提交记录信息，只显示commit id和提交说明</span><br>$ git reset --hard HEAD^  <span class="hljs-comment"># 回退到上个commit版本，两个^^则表示回退到上上个版本，~n表示n个版本</span><br>$ git reset --hard &lt;commit id&gt;  <span class="hljs-comment"># 回到指定id的版本，id只需要前几位字符，能区分出不同commit即可</span><br>$ git reflog		<span class="hljs-comment"># 查看历史commit id变化情况，方便找到想要回到的版本</span><br>$ git <span class="hljs-built_in">log</span> --graph --pretty=oneline --abbrew-commit	<span class="hljs-comment"># 用图形显示提交记录</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p><code>git log</code>命令只能显示当前分支的commit记录，如果版本回退，只能显示回退到的版本及之前的commit记录，这时如果想要查看回退前的较新的版本信息，可以使用<code>git reflog</code>。</p>
<p><code>git reflog</code>可以查看所有分支的所有操作记录，包括分支切换和版本切换的记录，也包括已经被删除的 commit 记录和 reset 的操作</p>
</blockquote>
<h1 id="管理修改"><a href="#管理修改" class="headerlink" title="管理修改"></a>管理修改</h1><blockquote>
<p>Git管理的是修改，而不是文件</p>
</blockquote>
<p>使用add命令添加文件后，如果再次修改，此时提交是不包括第二次修改的。也就是说，每次修改之后都要add之后才能将修改提交到仓库。</p>
<h1 id="撤销修改"><a href="#撤销修改" class="headerlink" title="撤销修改"></a>撤销修改</h1><p>想要撤销修改的话，要根据不同的情况采取不同的操作：</p>
<ul>
<li><strong>没有git add 时</strong>，使用<code>git checkout--&lt;file&gt;</code>命令，file修改后没有放到暂存区，使用此命令回到版本库状态；如果是添加到暂存区后再修改，使用此命令可以回退没修改时的状态。总之，checkout操作让文件回到最近一次commit或者add时的状态。</li>
<li><strong>已经git add到暂存区</strong>，使用<code>git reset HEAD &lt;file&gt;</code>，将暂存区的修改撤销，重新放回工作区</li>
<li><strong>已经commit到版本库</strong>，使用<code>git reset --hard HEAD^</code>回退版本，或者使用回退到指定commit id</li>
<li><strong>已经push到远程仓库</strong>，没救了:(</li>
</ul>
<h1 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h1><p>使用<code>rm &lt;file&gt;</code>指令或者其他方法删除文件后，工作区和仓库文件不一致，这时：</p>
<ul>
<li>如果确定是删除文件，则继续下一步操作即可，<code>git commit -m 'xxx'</code>指令，提交删除，会删除仓库文件</li>
<li>如果是误删，此时仓库还有文件，使用<code>git checkout--&lt;file&gt;</code>恢复即可</li>
</ul>
<h1 id="比较文件差异"><a href="#比较文件差异" class="headerlink" title="比较文件差异"></a>比较文件差异</h1><ul>
<li><code>git diff [文件名]</code><ul>
<li>将工作区的文件和暂存区进行比较</li>
</ul>
</li>
<li><code>git diff [本地库中历史版本][文件名]</code><ul>
<li>将工作区中的文件和本地库历史记录比较</li>
</ul>
</li>
<li>不带文件名则比较工作区中所有文件</li>
</ul>
<h1 id="添加远程库"><a href="#添加远程库" class="headerlink" title="添加远程库"></a>添加远程库</h1><p>在github上创建完仓库(repository)之后，在本地配置好之后，使用push指令可以将本地仓库到远程仓库。前提要求是本地仓库是git仓库，即有init初始化处理、commit等操作。此外，还需要Git配置好SSH环境，参考<a href="https://git-scm.com/book/zh/v2/%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8A%E7%9A%84-Git-%E7%94%9F%E6%88%90-SSH-%E5%85%AC%E9%92%A5">教程</a>。</p>
<p>本地修改首先提交到本地仓库(无需Internet)，然后push到远程：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 第一次推送时，需要先关联远程库。origin表示将远程库地址起别名为origin</span><br>$ git remote add origin git@github.com:&lt;path&gt;<br><span class="hljs-comment"># 第一次push，需要添加-u参数,使用u参数后可以使之后的push操作不需要带参数</span><br><span class="hljs-comment"># 不带参数的push，即simple方式</span><br>$ git push -u origin master     <br><br><span class="hljs-comment"># 推送到指定远程库的指定分支</span><br>$ git push 或者git push origin master  <span class="hljs-comment"># 如果不是第一次push，则无需-u参数，也可以推送到指定分支</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>将远程库地址命名为origin，以后推送时使用origin表示远程库地址.</p>
</blockquote>
<h1 id="从远程库克隆"><a href="#从远程库克隆" class="headerlink" title="从远程库克隆"></a>从远程库克隆</h1><p>SSH方式：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git <span class="hljs-built_in">clone</span> git@github.com:&lt;path&gt;    <span class="hljs-comment"># 后面的地址可以在github上直接复制</span><br></code></pre></td></tr></tbody></table></figure>
<p>http方式：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git <span class="hljs-built_in">clone</span> https://github.com/&lt;path&gt;   <span class="hljs-comment"># 同样，地址可以从github直接复制      </span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>http方式的速度比较慢，ssh方式速度比较快</p>
</blockquote>
<p><code>clone</code>命令的作用效果：</p>
<ul>
<li>完整地把远程库下载到本地</li>
<li>创建origin远程地址别名(即默认将远程地址命名为origin，推送时也可以使用origin)</li>
<li>初始化本地库</li>
</ul>
<h1 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h1><h2 id="创建与分支合并"><a href="#创建与分支合并" class="headerlink" title="创建与分支合并"></a>创建与分支合并</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git branch   <span class="hljs-comment"># 查看分支</span><br>$ git branch &lt;name&gt;   <span class="hljs-comment"># 创建分支</span><br>$ git checkout &lt;name&gt; 或 git switch &lt;name&gt;  <span class="hljs-comment"># 切换分支</span><br>$ git checkout -b &lt;name&gt; 或 git switch -c &lt;name&gt;   <span class="hljs-comment"># 创建并切换分支</span><br>$ git merge &lt;name&gt;   <span class="hljs-comment"># 合并指定分支到当前分支</span><br>$ git branch -d &lt;name&gt;  <span class="hljs-comment"># 删除指定分支</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>Git合并、删除、创建分支的速度非常快，鼓励用分支完成任务再合并，这样过程更安全</p>
</blockquote>
<h2 id="分支冲突"><a href="#分支冲突" class="headerlink" title="分支冲突"></a>分支冲突</h2><p>如果两个分支都修改了同一个文件的相同位置，在分支合并时会产生冲突。</p>
<p>比如，现有文件内容如下：</p>
<figure class="highlight angelscript"><table><tbody><tr><td class="code"><pre><code class="hljs angelscript"><span class="hljs-number">111</span><br><span class="hljs-number">222</span><br></code></pre></td></tr></tbody></table></figure>
<p>在<code>bug_fix</code>分支上对第二行修改，并添加到暂存区，提交到本地库：</p>
<figure class="highlight basic"><table><tbody><tr><td class="code"><pre><code class="hljs basic"><span class="hljs-number">111</span><br><span class="hljs-symbol">222 </span><span class="hljs-keyword">edit</span> by but_fix<br></code></pre></td></tr></tbody></table></figure>
<p>在<code>master</code>分支上也对第二行修改，并添加到暂存区，提交到本地库：</p>
<figure class="highlight basic"><table><tbody><tr><td class="code"><pre><code class="hljs basic"><span class="hljs-number">111</span><br><span class="hljs-symbol">222 </span><span class="hljs-keyword">edit</span> by master<br></code></pre></td></tr></tbody></table></figure>
<p>这时，在<code>bug_fix</code>分支上使用<code>git merge master</code>命令将<code>master</code>分支内容合并过来，会产生冲突，提示自动合并失败。并进入<code>merging</code>状态。</p>
<p>此时需要手动合并文件，进入文件：</p>
<figure class="highlight asciidoc"><table><tbody><tr><td class="code"><pre><code class="hljs asciidoc">111<br>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br>222  edit by hot<span class="hljs-emphasis">_fix</span><br><span class="hljs-emphasis">=======</span><br><span class="hljs-emphasis">222  edit by master</span><br><span class="hljs-emphasis">&gt;&gt;&gt;&gt;&gt;&gt;&gt; master</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>&lt;&lt;&lt;&lt;&lt;&lt;&lt;HEAD</code>和<code>=======</code>之间的内容是当前分支的内容，下方是要合并过来的分支的内容。</p>
<p>根据实际需求，合并文件内容，将git生成的标记内容删除，保存退出。</p>
<p>这时使用<code>git status</code>查看状态，提示有未合并的路径，如果已解决完冲突并想要合并，使用<code>add</code>和<code>commit</code>（注意此时的commit命令不能添加文件名）命令提交，即可完成合并。</p>
<h2 id="分支管理策略"><a href="#分支管理策略" class="headerlink" title="分支管理策略"></a>分支管理策略</h2><p>分支合并时，Git优先用Fastforward模式，这种模式下，删除分支后，会丢掉分支信息。</p>
<p>如果强制禁用Fastforward模式，Git会在merge时生成新的commit，并且在分支历史记录可以看到分支信息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git merge --no-ff -m <span class="hljs-string">'commit information'</span> &lt;brach name&gt;<br><span class="hljs-comment"># 因为no-ff合并要创建新的commit，所以使用-m参数加上提交说明</span><br></code></pre></td></tr></tbody></table></figure>
<p>团队开发中，master分支仅用于发布新版本，日常开发在各自的分支上。</p>
<blockquote>
<p>2020.10.1起，github默认主分支改名为main，不再是master</p>
</blockquote>
<h2 id="bug分支"><a href="#bug分支" class="headerlink" title="bug分支"></a>bug分支</h2><p>当在dev分支工作时，需要临时修复master上一个bug，需要创建临时bug分支，修复、合并，删除分支。</p>
<p>如果dev分支的工作未完成，可以使用<code>$ git stash</code>命令保留现场。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git stash apply stash@{xxx}   <span class="hljs-comment"># 有多个stash是，恢复指定的stash，stash不删除</span><br>$ git stash pop   <span class="hljs-comment"># 恢复stash同时删掉stash内容</span><br>$ git stash list   <span class="hljs-comment"># 查看stash列表</span><br>$ git cherry-pick &lt;commit id&gt;  <span class="hljs-comment"># 用于将某个提交复制到当前分支</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="Feature分支"><a href="#Feature分支" class="headerlink" title="Feature分支"></a>Feature分支</h2><p>项目中开发新功能/特征，最好用新的分支，每个功能一个feature分支，在上面开发，完成后，合并，最后删除feature分支。</p>
<p>如果feature分支还未合并，就需要删除掉，需要使用-D参数强行删除：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git branch -D &lt;branch-name&gt;   <span class="hljs-comment"># 强行删除一个指定的未merge的分支</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="多人协作"><a href="#多人协作" class="headerlink" title="多人协作"></a>多人协作</h2><ol>
<li>情景一，团队内部：如果是同一个企业，不同账户，即多个人同时编写一个项目的场景，需要其他人都是协作者，即有push到远程库的权限。举例，创建者建立远程库，其他人使用<code>clone</code>复制远程库，修改后提交到本地库，然后需要有协作者权限，才能push到远程库。</li>
<li>情景二，跨团队协作：如果希望别的团队可以协助开发项目，但不能直接<code>push</code>，则他们需要先<code>fork</code>项目到自己的远程库，然后<code>clone</code>到本地进行开发，开发完以后，<code>push</code>到自己的远程库，再使用<code>pull request</code>通知项目管理者，管理者审核代码，确认以后进行<code>merge</code>操作。</li>
</ol>
<blockquote>
<p>fork操作完以后，项目相当于属于自己，可以随意进行push。如果想要推送给原有的远程库，需要使用pull request操作。</p>
</blockquote>
<p><strong>拉取操作</strong></p>
<ul>
<li><code>git fetch [远程库地址别名][远程分支名]</code></li>
<li><code>git merge [远程库地址别名/远程分支名]</code></li>
<li><code>git pull</code>：是<code>git fetch</code>和<code>git merge</code>两个操作和合并。</li>
</ul>
<p><strong>多人协作的工作模式</strong>：</p>
<ul>
<li><p>用<code>$ git push origin &lt;branch-name&gt;</code>推送自己的修改</p>
</li>
<li><p>如果推送失败，则因为远程分支比自己的分支更新，需要使用<code>$ git pull</code>命令合并，此命令会自动合并，如果<code>pull</code>请求之后提示<code>no stracking information</code>，说明本地分支和远程分支的链接关系没有创建，使用以下命令：</p>
</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git branch --set-upstream-to=origin/dev &lt;本地branch&gt;<br><span class="hljs-comment"># 设置本地分支和远程origin/dev分支的链接</span><br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><p>如果合并有冲突，则需要解决冲突，然后提交，push</p>
</li>
<li><p>如果没有冲突或者解决掉冲突后，则使用<code>$ git push origin &lt;branch name&gt;</code>推送到远程指定分支</p>
</li>
</ul>
<p>命令总结：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git remote   <span class="hljs-comment"># 查看远程信息</span><br>$ git remote -v  <span class="hljs-comment"># 查看远程库的详细信息</span><br>$ git switch -c &lt;branch-name&gt; origin/&lt;remote-branch-name&gt;  <span class="hljs-comment"># 从本地创建和远程对应的分支</span><br>$ git branch --set-upstream-to=origin/dev &lt;本地branch&gt;  <span class="hljs-comment"># 将本地分支与远程origin/dev分支链接</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="Rebase"><a href="#Rebase" class="headerlink" title="Rebase"></a>Rebase</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git rebase    <span class="hljs-comment"># 把分叉的提交历史“整理”成一条直线，看上去更直观，缺点是本地的分叉提交会被修改</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="标签管理"><a href="#标签管理" class="headerlink" title="标签管理"></a>标签管理</h1><p>标签(tag)也是版本库的一个快照，是指向某个commit的指针，tag比直接使用commit更方便。因此，可以使用tag作为版本号。</p>
<h2 id="创建标签"><a href="#创建标签" class="headerlink" title="创建标签"></a>创建标签</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git tag v1.0  <span class="hljs-comment"># 给当前最新的commit添加标签v1.0</span><br>$ git tag &lt;tag-name&gt; &lt;commit-id&gt;  <span class="hljs-comment"># 给特定的commit添加标签</span><br>$ git tag    <span class="hljs-comment"># 查看所有标签</span><br>$ git show v1.0   <span class="hljs-comment"># 显示标签v1.0的详细信息</span><br>$ git tag -a &lt;tag-name&gt; -m <span class="hljs-string">'说明'</span> &lt;commit-id&gt;		<span class="hljs-comment"># 为特定commit添加标签并添加说明信息</span><br>  <span class="hljs-comment"># 这里的-a 用来指定标签名，-m指定说明文字</span><br></code></pre></td></tr></tbody></table></figure>
<p>标签不会随着push推送到远程仓库，使用以下命令将tag信息push到远程：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git push origin &lt;tagname&gt;   <span class="hljs-comment"># 推送单个标签</span><br>$ git push origin --tags     <span class="hljs-comment"># 推送所有标签</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="操作标签"><a href="#操作标签" class="headerlink" title="操作标签"></a>操作标签</h2><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">$ git tag -d &lt;tag-name&gt;		<span class="hljs-comment"># 删除一个指定的本地标签</span><br>$ git push origin :refs/tags/&lt;tag-name&gt;    <span class="hljs-comment"># 删除远程仓库的指定标签</span><br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>教程</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记01-Java语言概述</title>
    <url>/2021/03/19/java-note-0101/</url>
    <content><![CDATA[<h1 id="一、软件开发介绍"><a href="#一、软件开发介绍" class="headerlink" title="一、软件开发介绍"></a>一、软件开发介绍</h1><h2 id="1、常用的DOS命令"><a href="#1、常用的DOS命令" class="headerlink" title="1、常用的DOS命令"></a>1、常用的DOS命令</h2><ul>
<li>dir：列出当前目录下的文件以及文件夹</li>
<li>md：创建目录</li>
<li>rd：删除目录</li>
<li>cd：进入指定目录</li>
<li>cd..：退回到上一级目录</li>
<li>cd\：退回到根目录</li>
<li>del：删除文件</li>
<li>exit：退出dos命令行</li>
<li>echo：输出内容</li>
</ul>
<h2 id="2、常用快捷键"><a href="#2、常用快捷键" class="headerlink" title="2、常用快捷键"></a>2、常用快捷键</h2><ul>
<li>← →：移动光标</li>
<li>↑ ↓：调阅历史操作命令</li>
<li>Delete和Backspace：删除字符</li>
</ul>
<h1 id="二、计算机编程语言介绍"><a href="#二、计算机编程语言介绍" class="headerlink" title="　二、计算机编程语言介绍"></a>　二、计算机编程语言介绍</h1><ul>
<li>机器语言</li>
<li>汇编语言</li>
<li>高级语言：<ul>
<li>C、Pascal、Fortran面向过程的语言</li>
<li>C++面向过程/面向对象</li>
<li>Java跨平台的纯面向对象的语言</li>
<li>.NET跨语言的平台</li>
<li>Python、Scala</li>
</ul>
</li>
</ul>
<h1 id="三、Java语言概述"><a href="#三、Java语言概述" class="headerlink" title="三、Java语言概述"></a>三、Java语言概述</h1><h2 id="1、Java语言简史"><a href="#1、Java语言简史" class="headerlink" title="1、Java语言简史"></a>1、Java语言简史</h2><ul>
<li>1991年Green项目，开发语言最初命名为Oak (橡树)</li>
<li>1994年，开发组意识到Oak非常适合于互联网</li>
<li>1996年，发布JDK 1.0，约8.3万个网页应用Java技术来制作</li>
<li>1997年，发布JDK1.1，JavaOne会议召开，创当时全球同类会议规模之最</li>
<li>1998年，发布JDK 1.2，同年发布企业平台J2EE</li>
<li>1999年，Java分成J2SE、J2EE和J2ME，JSP/Servlet技术诞生</li>
<li><strong>2004年，发布里程碑式版本：JDK1.5，为突出此版本的重要性，更名为JDK 5.0</strong></li>
<li>2005年，J2SE-&gt; JavaSE，J2EE-&gt; JavaEE，J2ME-&gt; JavaME</li>
<li>2009年，Oracle公司收购SUN，交易价格74亿美元</li>
<li>2011年，发布JDK 7.0</li>
<li><strong>2014年，发布JDK8.0，是继JDK 5.0以来变化最大的版本</strong></li>
<li>2017年，发布JDK9.0，最大限度实现模块化</li>
<li>2018年3月，发布JDK10.0，版本号也称为18.3</li>
<li>2018年9月，发布JDK 11.0，版本号也称为18.9</li>
</ul>
<h2 id="2、Java技术平台"><a href="#2、Java技术平台" class="headerlink" title="2、Java技术平台"></a>2、Java技术平台</h2><ul>
<li><strong>Java SE(Java Standard Edition)标准版</strong>：支持面向桌面级应用（如Windows下的应用程序）的Java平台，提供了完整的Java核心API，此版本以前称为J2SE。</li>
<li><strong>Java EE(Java Enterprise Edition)企业版</strong>：是为开发企业环境下的应用程序提供的一套解决方案。该技术体系中包含的技术如:Servlet、Jsp等，主要针对于Web应用程序开发。版本以前称为J2EE。</li>
<li>Java ME(Java Micro Edition) 小型版</li>
<li>Java Card</li>
</ul>
<h1 id="四、运行机制及运行过程"><a href="#四、运行机制及运行过程" class="headerlink" title="四、运行机制及运行过程"></a>四、运行机制及运行过程</h1><h2 id="1、Java语言的特点"><a href="#1、Java语言的特点" class="headerlink" title="1、Java语言的特点"></a>1、Java语言的特点</h2><ol>
<li><strong>面向对象</strong>：<ul>
<li>两个基本概念：类、对象</li>
<li>三大特征：封装、继承、多态</li>
</ul>
</li>
<li>健壮性：吸收C/C++的优点，去掉了其指针、内存的申请和释放等，提供了相对安全的内存管理和访问机制。</li>
<li>跨平台性：“Write once，Run AnyWhere”，只需要在运行Java应用程序的操作系统上，先安装Java虚拟机(JVM,<strong>J</strong>ava <strong>V</strong>irtual <strong>M</strong>achine)即可。由JVM负责Java程序在系统中的运行。、</li>
</ol>
<h2 id="2、Java两种核心机制"><a href="#2、Java两种核心机制" class="headerlink" title="2、Java两种核心机制"></a>2、Java两种核心机制</h2><ul>
<li>Java虚拟机（Java Virtual Machine）</li>
<li>垃圾收集机制（Garbage Collection）</li>
</ul>
<h2 id="3、Java运行过程"><a href="#3、Java运行过程" class="headerlink" title="3、Java运行过程"></a>3、Java运行过程</h2><p>`<em>.java <code>文件经过编译生成</code>\</em> .class`文件（字节码文件），然后执行</p>
<h1 id="五、Java的环境搭建"><a href="#五、Java的环境搭建" class="headerlink" title="五、Java的环境搭建"></a>五、Java的环境搭建</h1><h2 id="1、环境搭建"><a href="#1、环境搭建" class="headerlink" title="1、环境搭建"></a>1、环境搭建</h2><ul>
<li>下载JDK并安装JDK</li>
<li>配置环境变量（为了在任何目录下都能执行java命令）</li>
<li>使用<code>javac java</code>命令验证是否安装成功</li>
<li>使用编辑器或IDE开发</li>
</ul>
<h2 id="2、JDK、JRE、JVM"><a href="#2、JDK、JRE、JVM" class="headerlink" title="2、JDK、JRE、JVM"></a>2、JDK、JRE、JVM</h2><ul>
<li>JDK（Java Development Kit  Java开发工具包）。JDK是提供给Java开发人员使用的，包含了Java的开发工具（比如编译工具（javac.exe）、打包工具（jar.exe）等），也包含了JRE，安装了JDK就不用再安装JRE。</li>
<li>JRE（Java Runtime Environment Java运行环境）。包括JVM和Java程序所需的核心类库等。只安装JRE就能够运行Java程序。</li>
<li>JVM（Java Virtual Machine）是一个虚拟的计算机，具有指令集并使用不同的存储区域。负责执行指令，管理数据、内存、寄存器。</li>
</ul>
<blockquote>
<p><strong>JDK = JRE+开发工具集（例如Javac编译工具等）</strong></p>
<p><strong>JRE = JVM+Java SE标准类库</strong></p>
</blockquote>
<p>Java SE 8概要图<a href="https://docs.oracle.com/javase/8/docs/">Java Platform Standard Edition 8 Documentation</a>：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-0101_1.png">
</div>

<h1 id="六、运行HelloWorld"><a href="#六、运行HelloWorld" class="headerlink" title="六、运行HelloWorld"></a>六、运行HelloWorld</h1><p>搭建好java环境后，可以在dos窗口编译运行Java程序。</p>
<ul>
<li>将Java代码编写到扩展名为.java的文件中。</li>
<li>通过javac命令对该java文件进行编译。</li>
<li>通过java命令对生成的class文件进行运行。</li>
</ul>
<blockquote>
<p>注意：</p>
<p>1、Java应用程序的执行入口是main()方法。它有固定的书写格式：</p>
<p>​                    public static void main ( String[]args )  {……}</p>
<p>2、<strong>一个源文件中只能有一个public类</strong>。其他类的个数不限，如果源文件中包含一个public类，则文件名必须按照该类名命名。</p>
</blockquote>
<h1 id="七、注释-Comment"><a href="#七、注释-Comment" class="headerlink" title="七、注释(Comment)"></a>七、注释(Comment)</h1><ol>
<li><p>单行注释：<code>//注释内容</code></p>
</li>
<li><p>多行注释：<code>/*注释内容*/</code></p>
</li>
<li><p>文档注释（Java特有）：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">	<span class="hljs-doctag">@author</span> 指定程序作者</span><br><span class="hljs-comment">	<span class="hljs-doctag">@version</span> 指定源文件版本</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h1 id="八、Java-API文档"><a href="#八、Java-API文档" class="headerlink" title="八、Java API文档"></a>八、Java API文档</h1><p><strong>API(Application Programming Interface,应用程序编程接口)</strong>是Java提供的基本编程接口。</p>
<p>JDK下载链接：<a href="https://www.oracle.com/java/technologies/javase-downloads.html">https://www.oracle.com/java/technologies/javase-downloads.html</a></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记02-Java基本语法</title>
    <url>/2021/03/19/java-note-0201/</url>
    <content><![CDATA[<h1 id="一、关键字和保留字"><a href="#一、关键字和保留字" class="headerlink" title="一、关键字和保留字"></a>一、关键字和保留字</h1><h2 id="1、关键字"><a href="#1、关键字" class="headerlink" title="1、关键字"></a>1、关键字</h2><p><a href="https://docs.oracle.com/javase/tutorial/java/nutsandbolts/_keywords.html">Java关键字</a>被Java语言赋予了特殊含义，用做专门用途。一共有如下关键字</p>
<ul>
<li>用于定义数据类型：<code>class</code>、<code>interface</code>、<code>enum</code>、<code>byte</code>、<code>short</code>、<code>int</code>、<code>long</code>、<code>float</code>、<code>double</code>、<code>char</code>、<code>boolean</code>、<code>void</code></li>
<li>用于定义流程控制：<code>if</code>、<code>else</code>、<code>switch</code>、<code>case</code>、<code>default</code>、<code>while</code>、<code>do</code>、<code>for</code>、break<code>、continue</code>、<code>return</code></li>
<li>用于定义访问权限修饰符：<code>private</code>、<code>protected</code>、<code>public</code></li>
<li>用于定义类，函数，变量修饰符：<code>abstract</code>、<code>final</code>、<code>static</code>、<code>synchronized</code></li>
<li>用于定义类与类之间关系：<code>extends</code>、<code>implements</code></li>
<li>用于定义建立实例及引用实例，判断实例：<code>new</code>、<code>this</code>、<code>super</code>、<code>instanceof</code></li>
<li>用于异常处理：<code>try</code>、<code>catch</code>、<code>finally</code>、<code>throw</code>、<code>throws</code></li>
<li>用于包：<code>package</code>、<code>import</code></li>
<li>其他修饰符：<code>native</code>、<code>strictfp</code>、<code>transient</code>、<code>volatile</code>、<code>assert</code></li>
</ul>
<h2 id="2、保留字"><a href="#2、保留字" class="headerlink" title="2、保留字"></a>2、保留字</h2><p>Java保留字指的是现有Java版本尚未使用，但以后版本可能会作为关键字使用。</p>
<p>有两个保留字：goto、const</p>
<h1 id="二、标识符"><a href="#二、标识符" class="headerlink" title="二、标识符"></a>二、标识符</h1><p>标识符（Identifier）是对各种<strong>变量</strong>、<strong>方法</strong>和<strong>类</strong>等要素命名时使用的字符序列。</p>
<ol>
<li><p>标识符命名规则：</p>
<ul>
<li>由26个英文字母大小写，0-9，_或$组成。</li>
<li>不能以数字开头。</li>
<li>不可以使用关键字和保留字，但能包含关键字和保留字。</li>
<li>Java中严格区分大小写，长度无限制。</li>
<li>不能包含空格。</li>
</ul>
</li>
<li><p>Java中命名规范</p>
<ul>
<li>包名：aaabbbccc</li>
<li>类名、接口名：AaaBbbCcc</li>
<li>变量名、方法名：aaaBbbCcc</li>
<li>常量名：AAA_BBB_CCC</li>
</ul>
<blockquote>
<p>起名时要遵循“<strong>见名知意</strong>”的原则。</p>
</blockquote>
</li>
</ol>
<h1 id="三、变量"><a href="#三、变量" class="headerlink" title="三、变量"></a>三、变量</h1><h2 id="1、变量的分类"><a href="#1、变量的分类" class="headerlink" title="1、变量的分类"></a>1、变量的分类</h2><p>变量是程序中最基本的存储单元，包含<strong>变量类型</strong>、<strong>变量名</strong>和存储的<strong>值</strong>。</p>
<p>根据数据类型分：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-0201_01.png">
</div>
​    根据声明的位置：

<div align="center">
   <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-0201_02.jpg">
</div>




<blockquote>
<p><strong>成员变量</strong>是方法体外，类体内声明的变量。</p>
<p><strong>局部变量</strong>是方法体内部声明的变量。</p>
</blockquote>
<p>局部变量除形参外，需要显式初始化。而成员变量有默认的初始化值。</p>
<p>需要注意的点：</p>
<blockquote>
<p><code>long</code>型常量需要在后面加‘l’或‘L’</p>
<p><code>float</code>型常量需要在后面加‘f’或‘F’</p>
<p>Java中整型变量默认为<code>int</code>型，浮点型默认是<code>doule</code>型</p>
</blockquote>
<h2 id="2、自动类型转换"><a href="#2、自动类型转换" class="headerlink" title="2、自动类型转换"></a>2、自动类型转换</h2><h3 id="自动类型转换"><a href="#自动类型转换" class="headerlink" title="自动类型转换"></a>自动类型转换</h3><p>以下几种类型从左到右自动类型提升(转换)：</p>
<p><strong>(byte，char，short) → int → long → float → double</strong></p>
<ul>
<li><code>byte</code>，<code>short</code>，<code>char</code>之间不会相互转换，他们三者在计算时首先转换为<code>int</code>型</li>
<li><code>boolean</code>类型不能与其他数据类型运算</li>
<li>任何基本数据类型和<code>String</code>类型进行连接运算(+)时，基本数据类型会自动转化为<code>String</code>类型</li>
</ul>
<h3 id="强制类型转换"><a href="#强制类型转换" class="headerlink" title="强制类型转换"></a>强制类型转换</h3><p>强制类型转换是自动类型转换的<strong>逆过程</strong>。需要使用强制类型转换符：<code>()</code>，例<code>int a = (int) 3.14;</code></p>
<h1 id="四、运算符"><a href="#四、运算符" class="headerlink" title="四、运算符"></a>四、运算符</h1><h2 id="1、算数运算符"><a href="#1、算数运算符" class="headerlink" title="1、算数运算符"></a>1、算数运算符</h2><p>算数运算符包括：<code>+</code>、<code>-</code>、<code>*</code>、<code>/</code>、<code>%</code>、<code>++</code>、<code>--</code>、<code>+(字符串连接)</code></p>
<h2 id="2、赋值运算符"><a href="#2、赋值运算符" class="headerlink" title="2、赋值运算符"></a>2、赋值运算符</h2><p>赋值运算符包括：<code>=</code>、<code>+=</code>、<code>-=</code>、<code>*=</code>、<code>/=</code>、<code>%=</code></p>
<blockquote>
<p>这里的<code>+=</code>、<code>-=</code>、<code>*=</code>、<code>/=</code>、<code>%=</code>以及<code>++</code>、<code>--</code>运算符，都不会改变变量本身的类型。比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">short</span> s = <span class="hljs-number">10</span>;<br>s = s + <span class="hljs-number">1</span>;  <span class="hljs-comment">//编译错误，因为s+1已经被自动提升为int类型。</span><br>s = (<span class="hljs-keyword">short</span>)(s + <span class="hljs-number">1</span>); <span class="hljs-comment">//使用强制类型转换，正确</span><br>s++;  <span class="hljs-comment">//自增运算符不会改变数据类型，正确</span><br>s += <span class="hljs-number">1</span>; <span class="hljs-comment">//正确。</span><br></code></pre></td></tr></tbody></table></figure>
</blockquote>
<h2 id="3、比较运算符"><a href="#3、比较运算符" class="headerlink" title="3、比较运算符"></a>3、比较运算符</h2><p>比较运算符包括：<code>==</code>、<code>!=</code>、<code>&gt;</code>、<code>&lt;</code>、<code>&gt;=</code>、<code>&lt;=</code>、<code>instanceof</code></p>
<h2 id="4、逻辑运算符"><a href="#4、逻辑运算符" class="headerlink" title="4、逻辑运算符"></a>4、逻辑运算符</h2><p>逻辑运算符包括：<code>&amp;</code>、<code>&amp;&amp;</code>(短路与)、<code>|</code>、<code>||</code>(短路或)、<code>!</code>、<code>^(异或)</code></p>
<h2 id="5、位运算符"><a href="#5、位运算符" class="headerlink" title="5、位运算符"></a>5、位运算符</h2><p>位运算符包括：<code>&lt;&lt;</code>、<code>&gt;&gt;</code>、<code>&gt;&gt;&gt;(无符号右移)</code>、<code>&amp;(按位与)</code>、<code>|(按位或)</code>、<code>^(按位异或)</code>、<code>~(按位取反)</code></p>
<h2 id="6、三元运算符"><a href="#6、三元运算符" class="headerlink" title="6、三元运算符"></a>6、三元运算符</h2><p><code>(条件表达式) ? 表达式1 : 表达式2;</code>表示如果条件表达式为<code>true</code>，则返回表达式1，否则返回表达式2。</p>
<blockquote>
<p>这里的表达式1和表达式2必须是同种类型，或者能够自动类型提升。比如表达式1是<code>int</code>类型，表达式2是<code>double</code>类型，则表达式1会被自动转换为<code>double</code>类型。</p>
</blockquote>
<h1 id="五、程序流程控制"><a href="#五、程序流程控制" class="headerlink" title="五、程序流程控制"></a>五、程序流程控制</h1><h2 id="1、顺序结构"><a href="#1、顺序结构" class="headerlink" title="1、顺序结构"></a>1、顺序结构</h2><p>Java程序从上到下逐行地执行</p>
<h2 id="2、分支结构"><a href="#2、分支结构" class="headerlink" title="2、分支结构"></a>2、分支结构</h2><ul>
<li><strong>if语句</strong></li>
</ul>
<p>用法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//用法1：</span><br><span class="hljs-keyword">if</span>(条件表达式){<br>	执行代码块;<br>}<br><span class="hljs-comment">//用法2：</span><br><span class="hljs-keyword">if</span>(条件表达式){<br>	执行代码块<span class="hljs-number">1</span>;<br>}<span class="hljs-keyword">else</span>{<br>	执行代码块<span class="hljs-number">2</span>;<br>}<br><span class="hljs-comment">//用法3：</span><br><span class="hljs-keyword">if</span>(条件表达式){<br>	执行代码块<span class="hljs-number">1</span>;<br>}<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>{<br>	执行代码块<span class="hljs-number">2</span>;<br>}<br>......<br><span class="hljs-keyword">else</span>{<br>	执行代码块<span class="hljs-number">3</span>;<br>}<br><br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>switch语句</strong></li>
</ul>
<p>用法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">switch</span>(表达式){<br><span class="hljs-keyword">case</span> 常量<span class="hljs-number">1</span>:<br>	语句<span class="hljs-number">1</span>;<br>	<span class="hljs-comment">//break;</span><br><span class="hljs-keyword">case</span> 常量<span class="hljs-number">2</span>:<br>	语句<span class="hljs-number">2</span>;<br>	<span class="hljs-comment">//break;</span><br>......<br><span class="hljs-keyword">case</span> 常量N:<br>	语句N;<br>	<span class="hljs-comment">//break;</span><br><span class="hljs-keyword">default</span>:<br>	语句;<br>	<span class="hljs-comment">//break;</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p><code>switch(表达式)</code>中的表达式必须是<code>byte</code>、<code>short</code>、<code>char</code>、<code>int</code>、<code>枚举</code>、<code>String</code>这几种类型之一。</p>
<p><code>case</code>子句中的值必须是常量，不能是变量名或不确定的表达式值。</p>
<p>同一个<code>switch</code>语句，所有<code>case</code>子句中的常量值互不相同。</p>
<p>如果没有<code>break</code>，程序在运行第一个执行语句以后，会继续向下执行(即使<code>case</code>值不同，也会将下面的所有<code>case</code>中语句运行完)。</p>
<p><code>default</code>语句是可选的，位置也是灵活的。没有匹配<code>case</code>时，会执行<code>default</code>的语句。</p>
<p><code>switch</code>语句效率稍高，情况少的时候尽量不用<code>if</code>，选择<code>switch</code>语句。</p>
</blockquote>
<h2 id="3、循环结构"><a href="#3、循环结构" class="headerlink" title="3、循环结构"></a>3、循环结构</h2><ul>
<li><strong>for语句</strong></li>
</ul>
<p>用法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">for</span>(<span class="hljs-number">1.</span>初始化部分; <span class="hljs-number">2.</span>循环条件; <span class="hljs-number">4.</span>迭代部分){<br>	<span class="hljs-number">3.</span>循环体部分;<br>}<br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><strong>while语句</strong> </li>
</ul>
<p>用法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//用法1</span><br><span class="hljs-number">1.</span>初始化部分<br><span class="hljs-keyword">while</span>(<span class="hljs-number">2.</span>循环条件){<br>	<span class="hljs-number">3.</span>循环体部分;<br>	<span class="hljs-number">4.</span>迭代部分;<br>}<br><span class="hljs-comment">//用法2</span><br><span class="hljs-number">1.</span>初始化部分<br><span class="hljs-keyword">do</span>{<br>	<span class="hljs-number">3.</span>循环体部分;<br>	<span class="hljs-number">4.</span>迭代部分;<br>}<span class="hljs-keyword">while</span>(<span class="hljs-number">2.</span>循环条件)<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、break和continue"><a href="#4、break和continue" class="headerlink" title="4、break和continue"></a>4、break和continue</h2><p><code>break</code>用于终止某个语句块的执行，只能用于<code>switch</code>语句和循环语句，表示跳过循环体，终止循环。</p>
<p><code>continue</code>只能用在循环体中，表示跳过当前循环，继续下一次循环。</p>
<blockquote>
<p><code>break</code>和<code>continue</code>用于循环体内时，都可以使用<code>label</code>指明具体要跳过的循环体是哪个。如果没有明确指明，则都默认对当前循环体起作用，<strong>就近原则</strong>。</p>
</blockquote>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记03-数组</title>
    <url>/2021/03/20/java-note-0301/</url>
    <content><![CDATA[<h1 id="一、数组概述"><a href="#一、数组概述" class="headerlink" title="一、数组概述"></a>一、数组概述</h1><ul>
<li>数组中的元素必须是<strong>同一类型</strong>。</li>
<li>数组本身是<strong>引用数据类型</strong>，数组的元素可以是<strong>任何数据类型</strong>。</li>
<li>数组长度一旦确定就<strong>不能修改</strong>。</li>
</ul>
<p><strong>数组在内存中，数组首地址值存放在栈中，数组中的内容存放在堆中。 </strong></p>
<h1 id="二、一维数组"><a href="#二、一维数组" class="headerlink" title="二、一维数组"></a>二、一维数组</h1><p>初始化方式：</p>
<ul>
<li>动态初始化：<code>int[] arr = new int[5];</code></li>
<li>静态初始化：<code>int[] arr = new int[]{1,2,3,4,5};</code>或<code>int[] arr = {1,2,3,4,5};</code></li>
</ul>
<blockquote>
<p>中括号可以写在类型后面，也可以写在数组名后面，比如<code>int arr[]</code>也是正确的</p>
</blockquote>
<p>数组的<strong>默认初始化值</strong>：</p>
<ul>
<li>整型：<code>0</code></li>
<li>浮点型：<code>0.0</code></li>
<li><code>char</code>型：<code>0</code></li>
<li><code>boolean</code>型：<code>false</code></li>
<li>引用类型：<code>null</code></li>
</ul>
<h1 id="三、二维数组"><a href="#三、二维数组" class="headerlink" title="三、二维数组"></a>三、二维数组</h1><p>初始化方式：</p>
<ul>
<li>动态初始化：<code>int[][] arr = new int[5][4];</code>，<code>int[][] arr = new int[5][];</code>，</li>
<li>静态初始化：<code>int[][] arr = new int[][]{{1,2,3},{2,3},{3}};</code>或<code>int[] arr = {1,2,3,4,5};</code></li>
</ul>
<blockquote>
<p>中括号可以写在类型后面，也可以写在数组名后面，<code>int arr[][]</code>和<code>int []arr[]</code>都是正确的写法。</p>
<p>动态初始化时，第一个维度必须指定，第二个维度可以先不指定。<code>int arr[][] arr = new int[][3]</code>非法。</p>
</blockquote>
<h1 id="四、数组涉及的常见算法"><a href="#四、数组涉及的常见算法" class="headerlink" title="四、数组涉及的常见算法"></a>四、数组涉及的常见算法</h1><ul>
<li>查找算法</li>
<li>排序算法，可以参考<a href="https://kangshitao.github.io/2020/12/27/rank-algorithm/">排序算法总结</a></li>
</ul>
<h1 id="五、Arrays工具类"><a href="#五、Arrays工具类" class="headerlink" title="五、Arrays工具类"></a>五、Arrays工具类</h1><p><code>java.util.Arrays</code>类是操作数组的工具类，以下几个是常用的几个方法：</p>
<ul>
<li><code>boolean equals(int[] a, int[] b)</code>：判断两个数组是否相等</li>
<li><code>String toString(int[] a)</code>：输出数组信息</li>
<li><code>void fill(int[] a, int val)</code>：将指定值填充到数组之中</li>
<li><code>void sort(int[] a)</code>：对数组进行排序</li>
<li><code>int binarySearch(int[] a, int key)</code>：对排序后的数组进行二分法检索指定的值</li>
</ul>
<h1 id="六、数组的常见异常"><a href="#六、数组的常见异常" class="headerlink" title="六、数组的常见异常"></a>六、数组的常见异常</h1><ul>
<li>数组索引越界异常：<code>ArrayIndexOutOfBoundsException</code></li>
<li>空指针异常：<code>NullPointerException</code></li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记04-面向对象编程(上)</title>
    <url>/2021/03/20/java-note-0401/</url>
    <content><![CDATA[<h1 id="一、面向过程和面向对象"><a href="#一、面向过程和面向对象" class="headerlink" title="一、面向过程和面向对象"></a>一、面向过程和面向对象</h1><ul>
<li><p>面向过程(Procedure Oriented Programming)：强调功能行为，以函数为最小单位，考虑怎么做。</p>
</li>
<li><p><strong>面向对象(Object Oriented Programming，OOP)</strong>：将功能封装进对象，强调具备了功能的对象，以类/对象为最小单位，考虑谁来做。</p>
</li>
</ul>
<p>面向对象三大特征：<strong>封装(Encapsulation)</strong>、<strong>继承(Inheritance)</strong>、<strong>多态(Polymorphism)</strong></p>
<h1 id="二、Java基本元素：类和对象"><a href="#二、Java基本元素：类和对象" class="headerlink" title="二、Java基本元素：类和对象"></a>二、Java基本元素：类和对象</h1><ul>
<li>类是对一类事物的描述，是<strong>抽象</strong>的、概念上的定义</li>
<li>对象是<strong>实际存在</strong>的该类事物的每个个体，也称为<strong>实例(instance)</strong></li>
</ul>
<p>设计类，就是设计类的成员：</p>
<ul>
<li><code>属性</code> = <code>成员变量</code> = <code>filed</code> = <code>域</code>、<code>字段</code></li>
<li><code>方法</code> = <code>成员方法</code> = <code>函数</code> = <code>method</code></li>
</ul>
<p>创建类的对象 = 类的实例化 = 实例化类</p>
<p>创建类：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">修饰符 <span class="hljs-class"><span class="hljs-keyword">class</span> 类名</span>{<br>    属性声明;<br>    方法声明;<br>}<br><span class="hljs-comment">//创建Person类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-keyword">int</span> age; <span class="hljs-comment">//成员变量</span><br>    String name; <span class="hljs-comment">//成员变量</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>{ <span class="hljs-comment">//方法</span><br>        System.out.pringln(<span class="hljs-string">"eat"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、对象的创建和使用"><a href="#三、对象的创建和使用" class="headerlink" title="三、对象的创建和使用"></a>三、对象的创建和使用</h1><p>通过 <code>类名 对象名= new 类名();</code>创建对象，通过<code>对象名.对象成员</code>访问对象的属性和方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Person person = <span class="hljs-keyword">new</span> Person();<br><span class="hljs-keyword">int</span> age = person.age;  <span class="hljs-comment">//访问类的属性</span><br>person.eat();  <span class="hljs-comment">//访问类的方法</span><br></code></pre></td></tr></tbody></table></figure>
<p>类的访问机制：</p>
<ul>
<li>同一个类中，类中的方法可以直接访问类中的成员变量（非static）。</li>
<li>不同类中，需要先创建类的对象，通过对象访问类中的成员。</li>
</ul>
<h1 id="四、类的成员之一：属性"><a href="#四、类的成员之一：属性" class="headerlink" title="四、类的成员之一：属性"></a>四、类的成员之一：属性</h1><p>声明格式：<code>修饰符 数据类型 属性名 = 初始化值;</code></p>
<ul>
<li>成员变量：方法体外，类内声明的变量。有默认初始值。</li>
<li>局部变量：方法体内部声明的变量。没有默认初始值，需要显式初始化(形参除外)。</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th></th>
<th>成员变量</th>
<th>局部变量</th>
</tr>
</thead>
<tbody>
<tr>
<td>声明位置</td>
<td>直接声明在类中</td>
<td>方法形参、方法内部、代码块内、构造器内</td>
</tr>
<tr>
<td>修饰符</td>
<td>private、public、static、final等</td>
<td>不能用权限修饰符，可以用final修饰</td>
</tr>
<tr>
<td>初始化值</td>
<td>有默认初始化值(同数组元素初始化)</td>
<td>无默认初始化值，必须显式赋值才能使用</td>
</tr>
<tr>
<td>内存加载位置</td>
<td>堆空间或静态域内</td>
<td>栈空间</td>
</tr>
</tbody>
</table>
</div>
<p>例如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span>()</span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> age; <span class="hljs-comment">//成员变量</span><br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">int</span> hour = <span class="hljs-number">3</span>; <span class="hljs-comment">//局部变量</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、类的成员之二：方法"><a href="#五、类的成员之二：方法" class="headerlink" title="五、类的成员之二：方法"></a>五、类的成员之二：方法</h1><h2 id="1、方法定义"><a href="#1、方法定义" class="headerlink" title="1、方法定义"></a>1、方法定义</h2><p><code>方法(method)</code>用来完成某个功能，实现代码复用，简化代码。</p>
<p>Java里的<code>方法</code>不能独立存在，必须定义在类内。</p>
<p>声明格式：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">修饰符 返回值类型 方法名(参数类型 参数<span class="hljs-number">1</span>,参数类型 参数<span class="hljs-number">2</span>,...){<br>    方法体;<br>    <span class="hljs-keyword">return</span> 返回值;  <br>    <span class="hljs-comment">//返回值类型为void时，可以没有return语句，或使用return;</span><br>}<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showInfo</span><span class="hljs-params">()</span></span>{<br>    System.out.println(<span class="hljs-string">"showInfo"</span>);<br>    <span class="hljs-comment">//return;</span><br>}<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAge</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-keyword">return</span> age;<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>方法中只能调用方法或属性，不能在方法内定义方法。</p>
</blockquote>
<h2 id="2、方法重载"><a href="#2、方法重载" class="headerlink" title="2、方法重载"></a>2、方法重载</h2><p><code>重载(overload)</code>：同一个类中，功能类似，<code>方法名相同</code>的多个方法。<code>参数列表不同</code>（类型，个数，顺序）。返回值类型可以相同也可以不同，但一般返回值类型是相同的。</p>
<p><strong>两同一不同</strong>：类、方法名相同，参数列表不同。</p>
<p>是否重载和权限修饰符、返回值类型、形参变量名、方法体都没有关系。</p>
<p>举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OverLoad</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        OverLoad test = <span class="hljs-keyword">new</span> OverLoad();<br>    }<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getSum</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span>{} <br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getSum</span><span class="hljs-params">(<span class="hljs-keyword">double</span> a, <span class="hljs-keyword">double</span> b)</span></span>{} <span class="hljs-comment">//是重载</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getSum</span><span class="hljs-params">(String s, <span class="hljs-keyword">int</span> i)</span></span>{} <span class="hljs-comment">//是重载</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getSum</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i, String s)</span></span>{} <span class="hljs-comment">//是重载，和上一个也构成重载，顺序不同。</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getSum</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b, <span class="hljs-keyword">int</span> c)</span></span>{ <span class="hljs-comment">//是重载，参数个数不同</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getSum</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span>{<span class="hljs-comment">//不是重载，参数列表相同</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、可变个数形参"><a href="#3、可变个数形参" class="headerlink" title="3、可变个数形参"></a>3、可变个数形参</h2><p>JavaSE 5.0提供了Varargs(variable number of arguments)机制，允许直接定义能和多个实参匹配的形参。</p>
<p>JDK5.0之前，使用数组形参定义方法，传入多个<strong>同一类型</strong>变量:</p>
<p><code>public static void test(int a, String[] books);</code></p>
<p>JDK5.0之后，使用可变形参，传入多个<strong>同一类型</strong>变量：</p>
<p><code>public static void test(int a, String...books);</code></p>
<ul>
<li>可变个数形参的方法，和同名的方法构成重载。</li>
<li>可变个数形参方法的使用，和使用数组时一样，使用索引获取某个参数。</li>
<li>可变形参需要放到参数列表的最后。</li>
<li>一个方法的参数中只能有一个可变个数形参。</li>
<li>如果有参数列表恰好符合的方法，优先调用。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        MethodTest m = <span class="hljs-keyword">new</span> MethodTest();<br>        m.show(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>); <span class="hljs-comment">//method 3，优先调用两个参数的方法。</span><br>        m.show(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[]{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>}); <span class="hljs-comment">//调用可变形参的方法</span><br>        m.show(<span class="hljs-string">"sss"</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>); <span class="hljs-comment">//method 4，两种参数方法都可以。</span><br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-keyword">int</span> i)</span></span>{<br>        System.out.println(<span class="hljs-string">"method 1"</span>);<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-keyword">int</span> ... i)</span></span>{  <span class="hljs-comment">//可以接收任意个数的参数。也可以接受数组类型的参数。</span><br>        System.out.println(<span class="hljs-string">"可变形参"</span>);<br>    }<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a, <span class="hljs-keyword">int</span> b)</span></span>{<br>        System.out.println(<span class="hljs-string">"method 3"</span>);<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span><span class="hljs-params">(String s, <span class="hljs-keyword">int</span> ... i)</span></span>{  <span class="hljs-comment">//可变形参必须放在最后。</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> n = <span class="hljs-number">0</span>; n&lt;i.length; n++){ <span class="hljs-comment">//将i当成数组处理即可。</span><br>        }<br>        System.out.println(<span class="hljs-string">"method 4"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、值传递"><a href="#4、值传递" class="headerlink" title="4、值传递"></a>4、值传递</h2><p><strong>形参</strong>：方法声明时的参数。</p>
<p><strong>实参</strong>：方法调用时实际传给形参的参数值。</p>
<p>Java里的方法参数传递方式只有一种：<strong>值传递</strong>。即将实际参数值的副本(复制品)传入方法内，而参数本身不受影响。</p>
<ul>
<li>形参是<strong>基本数据类型</strong>：将实参基本数据类型变量的<strong>“数据值”</strong>传递给形参。</li>
<li>形参是<strong>引用数据类型</strong>：将实参引用数据类型变量的<strong>“地址值”</strong>传递给形参。</li>
</ul>
<p>值传递练习：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">valueTransfer</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String args[])</span> </span>{<br>        valueTransfer t = <span class="hljs-keyword">new</span> valueTransfer();<br>        t.first();<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">first</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">int</span> i = <span class="hljs-number">5</span>;<br>        Value v = <span class="hljs-keyword">new</span> Value();<br>        v.i = <span class="hljs-number">25</span>;<br>        second(v, i);  <span class="hljs-comment">//经过second函数，v中的i被修改为20</span><br>        System.out.println(v.i);<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">second</span><span class="hljs-params">(Value v, <span class="hljs-keyword">int</span> i)</span> </span>{ <br>        <span class="hljs-comment">//参数的v和i是在栈空间中新建的，这里的v指向传入对象v的地址</span><br>        i = <span class="hljs-number">0</span>;<br>        v.i = <span class="hljs-number">20</span>; <span class="hljs-comment">// 将指向的地址中的i赋值为20</span><br>        Value val = <span class="hljs-keyword">new</span> Value();<br>        v = val;  <span class="hljs-comment">//v指向对象val的地址。</span><br>        System.out.println(v.i + <span class="hljs-string">" "</span> + i);  <span class="hljs-comment">//15 0</span><br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Value</span> </span>{<br>    <span class="hljs-keyword">int</span> i = <span class="hljs-number">15</span>;<br>}<br><span class="hljs-comment">//以上程序输出结果：</span><br><span class="hljs-number">15</span> <span class="hljs-number">0</span><br><span class="hljs-number">20</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、类的成员之三：构造器-构造方法"><a href="#六、类的成员之三：构造器-构造方法" class="headerlink" title="六、类的成员之三：构造器(构造方法)"></a>六、类的成员之三：构造器(构造方法)</h1><p>类的<strong>构造器(构造方法，constructor)</strong>用于给对象进行初始化。</p>
<p><strong>构造器特征</strong>：</p>
<ul>
<li>具有与类相同的名称</li>
<li>不声明返回值类型</li>
<li>不能被<code>static</code>、<code>final</code>、<code>synchronized</code>、<code>abstract</code>、<code>native</code>修饰，不能有<code>return</code>语句返回值</li>
</ul>
<p><strong>声明格式</strong>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">权限修饰符 类名(参数列表){<br>    初始化语句;<br>} <br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Animal</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> legs;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Animal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> l)</span></span>{ <span class="hljs-comment">//构造器1</span><br>        legs = l;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Animal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> l, String n)</span></span>{ <span class="hljs-comment">//构造器2</span><br>        legs = l;<br>        name = n;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>注意：</p>
<ul>
<li>Java中，每个类至少有一个构造器。</li>
<li>如果没有显式地定义类的构造器，系统默认提供一个空参的构造器。</li>
<li>一旦显式地定义了构造器，系统不再提供默认的构造器。</li>
<li>一个类中可以定义多个构造器，构成重载。</li>
</ul>
<blockquote>
<p>在IDEA中，可以右键→generate→Constructor，自动生成构造器</p>
</blockquote>
<p><strong>属性根据以下顺序赋值</strong></p>
<p>① 默认初始化。</p>
<p>② 显式初始化，如<code>int age = 1;</code></p>
<p>③ 构造器中初始化。</p>
<p>④ 通过<code>对象.方法</code> 或 <code>对象.属性</code>的方式赋值。</p>
<h1 id="七、面向对象特征之一：封装与隐藏"><a href="#七、面向对象特征之一：封装与隐藏" class="headerlink" title="七、面向对象特征之一：封装与隐藏"></a>七、面向对象特征之一：封装与隐藏</h1><h2 id="1、封装性"><a href="#1、封装性" class="headerlink" title="1、封装性"></a>1、封装性</h2><p>类的<strong>封装性</strong>是指将对象内部的复杂性隐藏起来，只对外提供必要的接口，便于调用。</p>
<p>如果直接将属性暴露出来，使用者对属性的直接操作可能导致数据错误、混乱或安全性问题。</p>
<p>Java中通过将数据声明为<code>私有的(private)</code>，再提供<code>公共的(public)</code>方法<code>getXxx()</code>和<code>setXxx()</code>实现对该属性的操作，以实现下述目的：</p>
<ul>
<li>隐藏一个类中不需要对外提供的实现细节；</li>
<li>使用者只能通过事先定制好的方法来访问数据，可以方便地加入控制逻辑，限制对属性的不合理操作；</li>
<li>便于修改，增强代码的可维护性；</li>
</ul>
<p>例如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PersonTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Person p = <span class="hljs-keyword">new</span> Person(<span class="hljs-number">20</span>); <span class="hljs-comment">// new 后面的Person()就是构造器。</span><br>        p.setAge(<span class="hljs-number">25</span>); <span class="hljs-comment">//将年龄设置为25</span><br>        <span class="hljs-keyword">int</span> age = p.getAge();  <span class="hljs-comment">// age = 25</span><br>        <span class="hljs-comment">//int age = p.age; 无法直接通过对象调用age属性，因为类中的age是私有的</span><br>    }<br>}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span></span>{ <span class="hljs-comment">//构造器（构造函数）</span><br>        System.out.println(<span class="hljs-string">"constructor"</span>);<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span></span>{ <span class="hljs-comment">//重载的构造器</span><br>        age = a;<br>        System.out.println(<span class="hljs-string">"constructor"</span>);<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> age;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(<span class="hljs-keyword">int</span> a)</span> </span>{<br>        age = a;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>{}<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>同样地，<code>getXxx()</code>和<code>setXxx()</code>方法可以使用自动生成的方法。</p>
<h2 id="2、四种权限修饰符"><a href="#2、四种权限修饰符" class="headerlink" title="2、四种权限修饰符"></a>2、四种权限修饰符</h2><p>权限修饰符可以用来修饰类和方法，其中<code>class</code>只能用<code>public</code>和<code>缺省(default)</code>两种权限修饰符，四种权限修饰符的权限如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>权限修饰符</th>
<th>类内部</th>
<th>同一个包</th>
<th>不同包的子类</th>
<th>同一个工程</th>
</tr>
</thead>
<tbody>
<tr>
<td>private</td>
<td>√</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>缺省(default)</td>
<td>√</td>
<td>√</td>
<td></td>
<td></td>
</tr>
<tr>
<td>protected</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td></td>
</tr>
<tr>
<td>public</td>
<td>√</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
</tbody>
</table>
</div>
<h2 id="3、JavaBean"><a href="#3、JavaBean" class="headerlink" title="3、JavaBean"></a>3、JavaBean</h2><p>JavaBean是一种Java语言写成的可重用组件。</p>
<p>所谓JavaBean，是指符合如下标准的Java类：</p>
<ul>
<li>类是<code>public</code>的。</li>
<li>有一个无参的<code>public</code>构造器。</li>
<li>有属性，且有对应的<code>get</code>、<code>set</code>方法。</li>
</ul>
<h1 id="八、this关键字"><a href="#八、this关键字" class="headerlink" title="八、this关键字"></a>八、this关键字</h1><p><code>this</code>可以用来修饰<code>属性</code>、<code>方法</code>、<code>构造器</code>。</p>
<h2 id="1、修饰属性和方法"><a href="#1、修饰属性和方法" class="headerlink" title="1、修饰属性和方法"></a>1、修饰属性和方法</h2><p><code>this</code>修饰属性和方法时，表示当前对象或当前正在构建的对象。使用<code>this.属性</code>和<code>this.方法</code>的方式，调用当前对象的属性和方法。</p>
<p>通常情况下，省略<code>this</code>，特殊情况下，当参数和属性同名时，必须使用<code>this</code>进行区分。</p>
<h2 id="2、修饰构造器"><a href="#2、修饰构造器" class="headerlink" title="2、修饰构造器"></a>2、修饰构造器</h2><p><code>this</code>修饰构造器：</p>
<ul>
<li>在类的构造器中，可以用<code>this(形参列表)</code>方式，调用<strong>本类中其他构造器</strong>。</li>
<li>构造器不能用<code>this(形参列表)</code>方式调用自己。</li>
<li>如果一个类中有n个构造器，则最多有n-1个构造器中使用了<code>this(形参列表)</code>方式。</li>
<li><code>this(形参列表)</code>必须声明在当前构造器的<strong>首行</strong>。</li>
<li>每个构造器内部，最多只能有一个<code>this(形参列表)</code>的方式。且多个构造器之间调用不能形成环，否则会导致死循环。</li>
</ul>
<p><code>this</code>关键字的用法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span>{  <span class="hljs-comment">//JavaBean的形式构造Person类</span><br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> name;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>{<br>        <span class="hljs-keyword">this</span>.name = name;  <span class="hljs-comment">//使用this区分类的属性name和形参name</span><br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> age;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>{<br>        <span class="hljs-keyword">this</span>.age = age;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span></span>{} <span class="hljs-comment">//构造器（构造函数）</span><br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(String name)</span></span>{<br>        <span class="hljs-keyword">this</span>.name = name;<br>        System.out.println(<span class="hljs-string">"second constructor"</span>);<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> age)</span></span>{<br>        <span class="hljs-keyword">this</span>(name); <span class="hljs-comment">//使用this调用第二个构造器</span><br>        <span class="hljs-keyword">this</span>.age = age;<br>        System.out.println(<span class="hljs-string">"third constructor"</span>);<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>{}<br>}<br><br></code></pre></td></tr></tbody></table></figure>
<h1 id="九、package和import"><a href="#九、package和import" class="headerlink" title="九、package和import"></a>九、package和import</h1><h2 id="1、package"><a href="#1、package" class="headerlink" title="1、package"></a>1、package</h2><p><code>package</code>语句是Java源文件的第一条语句，指明该文件中定义的类所在的包。</p>
<p>比如<code>pack1\pack2\PackageTest.java</code>路径下的类<code>PackageTest</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> pack1.pack2;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PackageTest</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>{<br>        System.out.println(<span class="hljs-string">"PackageTest"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>JDK</code>中常用的包：</p>
<ul>
<li><code>java.lang</code>：包含一些Java语言的核心类，如<code>String</code>、<code>Math</code>、<code>Integer</code>、<code>System</code>和<code>Thread</code>，提供常用功能.</li>
<li><code>java.net</code>：包含执行与网络相关的操作的类和接口。</li>
<li><code>java.io</code>：包含能提供多种输入/输出功能的类。</li>
<li><code>java.util</code>：包含一些实用工具类，如定义系统特性、接口的集合框架类、使用与日期日历相关的函数。</li>
<li><code>java.text</code>：包含了一些java格式化相关的类</li>
<li><code>java.sql</code>：包含了java进行JDBC数据库编程的相关类/接口</li>
<li><code>java.awt</code>：包含了构成抽象窗口工具集（abstract window toolkits）的多个类，这些类被用来构建和管理应用程序的图形用户界面(GUI)。B/S，C/S</li>
</ul>
<h2 id="2、import"><a href="#2、import" class="headerlink" title="2、import"></a>2、import</h2><p><code>import</code>语句用于引入指定包层次下所需要的类。</p>
<p>格式：<code>import 包名.类名;</code></p>
<ul>
<li><code>import</code>语句声明在<code>package</code>声明和类的声明之间；</li>
<li><code>*</code>表示导入包下的所有类，比如<code>import java.util.*;</code>表示导入<code>util</code>包下的所有类或接口。</li>
<li>如果是<code>java.lang</code>包下，或是当前包下的，可以不使用<code>import</code>语句。</li>
<li>如果使用<strong>不同包</strong>下的<strong>同名的类</strong>。那么就需要使用<strong>类的全类名（包名.类名）</strong>的方式指明调用的是哪个类。</li>
<li>如果已经导入<code>java.a</code>包下的类。那么如果需要使用<code>a</code>包的子包下的类的话，仍然需要导入。</li>
</ul>
<h2 id="3、MVC设计模式"><a href="#3、MVC设计模式" class="headerlink" title="3、MVC设计模式"></a>3、MVC设计模式</h2><p>MVC是常用的设计模式之一，将整个程序分为三个层次：<strong>数据模型层(Model)</strong>、<strong>视图层(View)</strong>和<strong>控制器层(Controller)</strong>。各个层的主要内容如下：</p>
<ul>
<li><strong>模型层(Model)</strong>，主要处理数据：<ul>
<li>数据对象封装 ：<code>model.bean/domain</code></li>
<li>数据库操作类：<code>model.dao</code></li>
<li>数据库：<code>model.db</code></li>
</ul>
</li>
<li><strong>视图层(View)</strong>，显示数据：<ul>
<li>相关工具类：<code>view.utils</code></li>
<li>自定义view：<code>view.ui</code></li>
</ul>
</li>
<li><strong>控制层(Controller)</strong>：<ul>
<li>应用界面相关：<code>controller.activity</code></li>
<li>存放fragment：<code>controller.fragment</code></li>
<li>显示列表的适配器：<code>controller.adapte</code></li>
<li>服务相关的：<code>controller.service</code></li>
<li>抽取的基类：<code>controller.base</code></li>
</ul>
</li>
</ul>
<p>MVC模式在项目中的应用：<a href="https://github.com/kangshitao/Java_shangguigu/tree/main/Project2">客户信息管理软件</a></p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记05-面向对象编程(中)</title>
    <url>/2021/03/21/java-note-0501/</url>
    <content><![CDATA[<h1 id="一、面向对象特征之二：继承性"><a href="#一、面向对象特征之二：继承性" class="headerlink" title="一、面向对象特征之二：继承性"></a>一、面向对象特征之二：继承性</h1><p>多个类中存在相同属性和行为时，将这些内容抽取到单独一个类中，那么多个类无需再定义这些属性和行为，只要<strong>继承(extends)</strong>那个类即可。</p>
<p>此处的多个类称为<strong>子类(派生类)</strong>，单独的这个类称为<strong>父类(基类或超类)</strong>。可以理解为:“子类is a父类”，比如<code>Student</code>类继承<code>Person</code>类，可以说Student is Person。</p>
<h2 id="1、优势"><a href="#1、优势" class="headerlink" title="1、优势"></a>1、优势</h2><p>继承有以下作用：</p>
<ul>
<li>减少了代码冗余，提高代码复用性。</li>
<li>便于功能的扩展。</li>
<li>为多态性的使用提供了前提。</li>
</ul>
<h2 id="2、使用"><a href="#2、使用" class="headerlink" title="2、使用"></a>2、使用</h2><p>格式：<code>class A extends B{}</code></p>
<ul>
<li>A：子类、派生类、subclass</li>
<li>B：父类、超类、基类、superclass</li>
<li>子类A继承父类B，则子类A中获取了父类B中声明的结构、属性、方法。</li>
<li>子类能继承到父类的<strong>私有方法和属性</strong>，只是由于封装性的影响，子类无法显式调用。</li>
<li>子类继承父类以后，还可以声明自己特有的属性和方法，实现功能的扩展。</li>
<li>子类和父类的关系，是对父类的“扩展”，不等同于子集和集合的关系。</li>
</ul>
<h2 id="3、规定"><a href="#3、规定" class="headerlink" title="3、规定"></a>3、规定</h2><ul>
<li>一个类可以被多个子类继承，但一个类只能有一个父类。</li>
<li>子父类是一个相对的概念，可以多层继承。A→B→C，其中A是C的间接父类，B是C的直接父类。</li>
<li>子类继承父类以后，就获取了直接父类以及所有间接父类声明的属性和方法。</li>
<li>如果没有显式地声明父类，则此类继承与<code>java.lang.Object</code>类。</li>
<li>所有的java类(除<code>java.lang.Object</code>类以外），都直接或间接地继承于<code>java.lang.Object</code>类，也就是说所有的java类都有<code>java.lang.Object</code>类声明的功能。</li>
</ul>
<p>继承(extends)的使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExtendTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Person p = <span class="hljs-keyword">new</span> Person();<br>        p.age = <span class="hljs-number">1</span>;<br>        Student s = <span class="hljs-keyword">new</span> Student();<br>        s.age = <span class="hljs-number">2</span>; <span class="hljs-comment">//父类的default权限的属性，子类可以直接调用</span><br>    }<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{<br>    String name;<br>    <span class="hljs-keyword">int</span> age;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span> </span>{}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> age)</span> </span>{<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.age = age;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span> </span>{<br>        System.out.println(<span class="hljs-string">"eat"</span>);<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sleep</span><span class="hljs-params">()</span> </span>{<br>        System.out.println(<span class="hljs-string">"sleep"</span>);<br>    }<br>}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span> </span>{<br>    String major; <span class="hljs-comment">//Student类特有的属性</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Student</span><span class="hljs-params">()</span> </span>{}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Student</span><span class="hljs-params">(String name, <span class="hljs-keyword">int</span> age, String major)</span> </span>{<br>        <span class="hljs-keyword">this</span>.name = name;  <span class="hljs-comment">//Student继承了Person类，因此可以使用Person类的属性</span><br>        <span class="hljs-keyword">this</span>.age = age;  <br>        <span class="hljs-keyword">this</span>.major = major;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">study</span><span class="hljs-params">()</span> </span>{ <span class="hljs-comment">//Student类特有的方法</span><br>        System.out.println(<span class="hljs-string">"study"</span>);<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showInfo</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-string">"name:"</span>+name+<span class="hljs-string">"age:"</span>+age);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="二、方法的重写-override-overwrite"><a href="#二、方法的重写-override-overwrite" class="headerlink" title="二、方法的重写(override/overwrite)"></a>二、方法的重写(override/overwrite)</h1><h2 id="1、定义"><a href="#1、定义" class="headerlink" title="1、定义"></a>1、定义</h2><p><strong>重写(override/overwrite)</strong>：在子类根据需要对从父类中继承来的方法进行改造，也称为方法的重置、覆盖。在程序执行时，子类的方法将覆盖父类的方法。</p>
<p>重写以后，子类对象调用此同名同参方法时，实际执行的是子类重写的方法。</p>
<h2 id="2、要求"><a href="#2、要求" class="headerlink" title="2、要求"></a>2、要求</h2><ul>
<li>子类重写的方法与父类被重写的方法，方法名和形参列表相同。</li>
<li>重写方法的<strong>权限不小于</strong>父类被重写的方法，不能重写父类的<code>private</code>方法。</li>
<li>子类重写的方法抛出的异常<strong>类型不大于</strong>父类被重写方法的抛出的异常类型。</li>
<li>返回值类型：<ul>
<li>如果父类方法返回值类型是<code>void</code>，则子类重写方法的返回值必须是<code>void</code>。</li>
<li>如果父类方法返回值类型是<code>A类</code>，则子类重写方法的返回值可以是<code>A类</code>或<code>A类的子类</code>。</li>
<li>如果父类方法返回值类型是<strong>基本数据类型</strong>，则子类重写方法的返回值类型必须是<strong>相同的基本数据类型</strong>。</li>
</ul>
</li>
<li>重写只是对<code>非static</code>方法来说的，对于<code>static</code>方法不是重写。</li>
</ul>
<h2 id="3、重载和重写的区别"><a href="#3、重载和重写的区别" class="headerlink" title="3、重载和重写的区别"></a>3、重载和重写的区别</h2><ul>
<li><strong>重载</strong>：类名、方法名相同，参数列表不同。不表现为多态性。 重载方法的调用地址在编译期就绑定了，称为“早绑定”或“静态绑定”。</li>
<li><strong>重写</strong>：类名、方法名相同，参数列表相同。表现为多态性。运行时才确定要调用的方法，称为“晚绑定”或“动态绑定”。</li>
</ul>
<h1 id="三、super关键字"><a href="#三、super关键字" class="headerlink" title="三、super关键字"></a>三、super关键字</h1><p><code>super</code>理解为“父类的”，可以用来调用父类的：<code>属性</code>、<code>方法</code>、<code>构造器</code>。</p>
<h2 id="1、super调用属性和方法"><a href="#1、super调用属性和方法" class="headerlink" title="1、super调用属性和方法"></a>1、super调用属性和方法</h2><ul>
<li>可以在子类的方法或构造器中，通过<code>super.属性</code>或<code>super.方法</code>的方式，显式地调用父类中声明的属性或方法。但通常情况下省略<code>super.</code>。</li>
<li>当子类和父类中定义了<strong>同名的属性</strong>，如果想在子类中调用父类中的属性，必须使用<code>super.属性</code>的方式，表明调用的是父类中声明的属性。</li>
</ul>
<h2 id="2、super调用构造器"><a href="#2、super调用构造器" class="headerlink" title="2、super调用构造器"></a>2、super调用构造器</h2><ul>
<li>可以在子类中使用<code>super(形参列表)</code>的方式，调用父类中指定的构造器。</li>
<li><code>super</code>调用构造器必须声明在子类构造器的首行。</li>
<li>子类所有构造器<strong>默认</strong>访问父类中的<strong>空参构造器</strong>，除非显式使用<code>super(形参列表)</code>调用父类构造器，或者使用<code>this(形参列表)</code>调用本类的构造器，且二者只能存在一种。</li>
<li>在类的构造器中，至少有一个构造器使用了<code>super(形参列表)</code>，调用父类中的构造器。</li>
</ul>
<h2 id="3、super和this的对比"><a href="#3、super和this的对比" class="headerlink" title="3、super和this的对比"></a>3、super和this的对比</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center"><code>this</code></th>
<th style="text-align:center"><code>super</code></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">访问属性</td>
<td style="text-align:center">访问<strong>本类</strong>中的属性，如果本类没有此属性则从父类中继续查找</td>
<td style="text-align:center">直接访问<strong>父类</strong>中的属性</td>
</tr>
<tr>
<td style="text-align:center">调用方法</td>
<td style="text-align:center">访问<strong>本类</strong>中的方法，如果本类没有此方法则从父类中继续查找</td>
<td style="text-align:center">直接访问<strong>父类</strong>中的方法</td>
</tr>
<tr>
<td style="text-align:center">调用构造器</td>
<td style="text-align:center">调用<strong>本类</strong>构造器，必须放在构造器的首行</td>
<td style="text-align:center">调用<strong>父类</strong>构造器，必须放在子类构造器的首行</td>
</tr>
</tbody>
</table>
</div>
<h1 id="四、子类对象实例化过程"><a href="#四、子类对象实例化过程" class="headerlink" title="四、子类对象实例化过程"></a>四、子类对象实例化过程</h1><ol>
<li><p><strong>从结果上看</strong>：子类继承父类以后，就获取了父类中声明的属性或方法。创建子类对象，在<strong>堆</strong>空间中，就会加载<strong>所有父类中声明的属性</strong>。</p>
</li>
<li><p><strong>从过程上看</strong>：当通过子类的构造器创建子类对象时，一定会直接或间接地调用其父类的构造器，进而向上调用父类的父类的构造器……，直到调用了<code>java.lang.Object</code>类中空参的构造器为止。因为加载过所有的父类的结构，所以才可以看到内存中有父类中的结构，子类对象才可以考虑进行调用。</p>
<blockquote>
<p>虽然创建子类对象时，调用了父类的构造器，但只是创建过一个对象，即<code>new</code>出来的对象。</p>
</blockquote>
</li>
</ol>
<h1 id="五、面向对象特征之三：多态性"><a href="#五、面向对象特征之三：多态性" class="headerlink" title="五、面向对象特征之三：多态性"></a>五、面向对象特征之三：多态性</h1><h2 id="1、多态的使用"><a href="#1、多态的使用" class="headerlink" title="1、多态的使用"></a>1、多态的使用</h2><p>Java中的<strong>多态性(Polymorphism)</strong>，是面向对象中最重要的概念。</p>
<p>对象的多态性：<strong>父类的引用指向子类的对象</strong>，比如<code>Person p = new Student();</code></p>
<p>多态的使用(<strong>虚拟方法调用</strong>)：对于多态，编译时只能调用父类中声明的方法，但在运行时，实际执行的是子类重写的方法，即<strong>编译看左边，运行看右边</strong>。</p>
<p>编译时类型和运行时类型不一致，就出现了对象的多态性。</p>
<ul>
<li>对象的多态性，只适用于方法，不适用于属性（编译和运行都看左边）。</li>
<li>多态性是<strong>运行时</strong>的行为（动态绑定），即只有在运行时才知道具体执行哪个方法，在编译时是不知道的。</li>
<li>子类可以看作是特殊的父类，所以父类类型的引用可以指向子类的对象，即<strong>向上转型(upcasting)</strong>。</li>
<li>当一个对象声明为父类的类型，实际引用的是子类对象，那么该变量不能访问子类中的属性和方法(实际在内存中是加载的，只是不能调用）。</li>
</ul>
<p>多态性的例子：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PersonTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>{<br>        <span class="hljs-comment">//对象的多态性：父类的引用指向子类的对象。</span><br>        Person pm = <span class="hljs-keyword">new</span> Man();<br>        Person pw = <span class="hljs-keyword">new</span> Woman();<br>        <span class="hljs-comment">//多态的引用：当调用子父类同名同参数的方法时，实际执行的是子类重写的父类的方法——虚拟方法调用</span><br>        pm.eat();  <span class="hljs-comment">//Man:eat</span><br>        pw.eat();  <span class="hljs-comment">//Woman：eat</span><br>        <br>        <span class="hljs-comment">//多态的另一种使用方法，传入不同子类对象时，调用其重写的方法，提高了代码复用性</span><br>        PersonTest test = <span class="hljs-keyword">new</span> PersonTest();<br>        test.walkPrint(<span class="hljs-keyword">new</span> Man());  <span class="hljs-comment">//Man：walk</span><br>        test.walkPrint(<span class="hljs-keyword">new</span> Woman());  <span class="hljs-comment">//Woman：walk</span><br>        <br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">walkPrint</span><span class="hljs-params">(Person person)</span></span>{<br>        person.walk();<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span> </span>{}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>{System.out.println(<span class="hljs-string">"Person:eat"</span>); }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">walk</span><span class="hljs-params">()</span></span>{System.out.println(<span class="hljs-string">"Person:walk"</span>);}<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> name;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>{<span class="hljs-keyword">this</span>.name = name;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> age;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(<span class="hljs-keyword">int</span> age)</span> </span>{<span class="hljs-keyword">this</span>.age = age;}<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Man</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isSmoking;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">earnMoney</span><span class="hljs-params">()</span></span>{System.out.println(<span class="hljs-string">"Man:earnMoney"</span>);}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>{ System.out.println(<span class="hljs-string">"Man:eat"</span>);}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">walk</span><span class="hljs-params">()</span></span>{ System.out.println(<span class="hljs-string">"Man:walk"</span>);}<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Woman</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isBeauty;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">goShopping</span><span class="hljs-params">()</span></span>{System.out.println(<span class="hljs-string">"Woman:goShopping"</span>);}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>{System.out.println(<span class="hljs-string">"Woman:eat"</span>);}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">walk</span><span class="hljs-params">()</span></span>{System.out.println(<span class="hljs-string">"Woman:walk"</span>);}<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、instanceof操作符"><a href="#2、instanceof操作符" class="headerlink" title="2、instanceof操作符"></a>2、instanceof操作符</h2><p><code>x instanceof A</code>用于检验x是否是类A的对象，返回<code>boolean</code>值。</p>
<p>要求<code>x</code>所属的类与<code>A类</code>必须是子类和父类的关系，否则编译错误。</p>
<p>如果<code>x</code>属于<code>类B</code>，<code>B extends A</code>，则<code>x instanceof B</code>和<code>x instanceof A</code>都为<code>True</code>。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//对于Person类、Man类，Woman类如下关系：</span><br><span class="hljs-comment">//Man extends Person，Woman extends Person</span><br>Man man = <span class="hljs-keyword">new</span> Man();<br>Person person = <span class="hljs-keyword">new</span> Person();<br>Person pm = <span class="hljs-keyword">new</span> Man();<br>man <span class="hljs-keyword">instanceof</span> Man; <span class="hljs-comment">//true</span><br>man <span class="hljs-keyword">instanceof</span> Person; <span class="hljs-comment">//true</span><br>man <span class="hljs-keyword">instanceof</span> Woman;  <span class="hljs-comment">//编译错误，Man类和Woman类没有关系，不是子类和父类的关系</span><br>person <span class="hljs-keyword">instanceof</span> Person;  <span class="hljs-comment">//true</span><br>person <span class="hljs-keyword">instanceof</span> Man;  <span class="hljs-comment">//false</span><br>pm <span class="hljs-keyword">instanceof</span> Person;  <span class="hljs-comment">//true</span><br>pm <span class="hljs-keyword">instanceof</span> Man;  <span class="hljs-comment">//true</span><br>pm <span class="hljs-keyword">instanceof</span> Woman;  <span class="hljs-comment">//false</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、对象类型转换-Casting"><a href="#3、对象类型转换-Casting" class="headerlink" title="3、对象类型转换(Casting)"></a>3、对象类型转换(Casting)</h2><p>类似于基本数据类型的类型转换，对象也有类型转换。</p>
<ul>
<li><strong>基本数据类型</strong>：<ul>
<li>自动类型转换(提升)：小的数据类型自动转换为大的数据类型，比如<code>int</code>型自动转换为<code>double</code>型：<code>double d = 12;</code>。</li>
<li>强制类型转换：大的数据类型强制转换(casting)为小的数据类型，比如<code>double</code>强转为<code>int</code>型：<code>int a = (int)12.0;</code>。</li>
</ul>
</li>
<li><strong>对象类型</strong>：<ul>
<li>向上转型：子类对象赋给父类对象的引用，即多态性，比如<code>Person person = new Man();</code></li>
<li>向下转型：父类对象强制转换为子类对象，比如：<code>Person person = new Man();Man man=(Man)person;</code>，将父类对象<code>person</code>强制转换为子类类型对象<code>man</code>，向下转型后，<code>man</code>对象就可以使用<code>Man类</code>定义的属性和方法。</li>
</ul>
</li>
</ul>
<blockquote>
<p>自动类型提升和向上转型都可以自动进行。</p>
<p>基本数据类型的强制类型转换可能会带来精度损失。</p>
<p>无继承关系的引用类型间的转换是非法的，编译错误。</p>
<p>对象类型向下转型时，可以使用<code>instanceof</code>关键字进行判断，结果是<code>true</code>时才可以进行转换。</p>
</blockquote>
<h1 id="六、Object类"><a href="#六、Object类" class="headerlink" title="六、Object类"></a>六、Object类</h1><ul>
<li><code>Object</code>类是所有Java类的根父类。</li>
<li>如果类的声明中没有使用<code>extends</code>关键字指明父类，则默认父类为<code>java.lang.Object</code>。</li>
<li><code>Object</code>类中的功能(属性、方法)具有通用性，<code>Object</code>类没有属性，但有常用的方法，比如<code>equals()</code>、<code>toString()</code>、<code>getClass()</code>、<code>hashCode()</code>、<code>clone()</code>、<code>finalize()</code>、<code>wait()</code>、<code>notify()</code>、<code>notifyAll()</code>。</li>
<li><code>Object</code>类只声明了一个空参的构造器。</li>
</ul>
<h1 id="七、包装类"><a href="#七、包装类" class="headerlink" title="七、包装类"></a>七、包装类</h1><p>对于Java中的8种基本数据类型，Java提供了各自对应的包装类，使基本数据类型的变量具有了类的特征。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>基本数据类型</th>
<th>包装类</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>byte</code></td>
<td><code>Byte</code></td>
</tr>
<tr>
<td><code>short</code></td>
<td><code>Short</code></td>
</tr>
<tr>
<td><code>int</code></td>
<td><code>Integer</code></td>
</tr>
<tr>
<td><code>long</code></td>
<td><code>Long</code></td>
</tr>
<tr>
<td><code>float</code></td>
<td><code>Float</code></td>
</tr>
<tr>
<td><code>double</code></td>
<td><code>Double</code></td>
</tr>
<tr>
<td><code>boolean</code></td>
<td><code>Boolean</code></td>
</tr>
<tr>
<td><code>char</code></td>
<td><code>Character</code></td>
</tr>
</tbody>
</table>
</div>
<p>基本数据类型、包装类、String三者之间的相互转换。</p>
<ul>
<li><p>基本数据类型和包装类之间的相互转换</p>
<ul>
<li><p>基本数据类型→包装类，调用包装类的构造器或<code>valueOf()</code>方法：</p>
<ul>
<li><code>Integer i = new Integer(12);</code></li>
<li><code>Integer i = Integer.valueOf(12);</code></li>
</ul>
</li>
<li><p>包装类→基本数据类型，调用包装类的<code>xxxValue()</code>方法：</p>
<ul>
<li><code>int a = i.intValue();</code></li>
</ul>
<blockquote>
<p>JDK 5.0 以后，有了<strong>自动装箱(基本数据类型转换为包装类)</strong>和<strong>自动拆箱</strong>功能，包装类和基本数据类型可以直接相互转换，比如<code>Integer i = 12;</code>，因此，包装类和基本数据类型可以看出一个整体。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>基本数据类型、包装类和String类型之间的相互转换</p>
<ul>
<li>基本数据类型、包装类→String类型，可以使用<code>+</code>连接符，或者String类的<code>valueOf()</code>方法。<ul>
<li>方法1：<code>String s  =  12 + "";</code></li>
<li>方法2：<code>String s  = String.valueOf(12);</code></li>
</ul>
</li>
<li>String类型→基本数据类型、包装类，使用包装类的构造器或者parseXxx()方法：<ul>
<li>例1：<code>int i = new Integer("12");</code></li>
<li>例2：<code>int i = Integer.parseInt("12");</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>特殊说明，<code>Integer</code>内部定义了<code>IntegerCache</code>结构，<code>IntegerCache</code>定义了<code>Integer[]</code>，保存了<code>-128~127</code>范围的整数，使用自动装箱的时候可以直接使用数组的元素，如果不在此范围内，则会<code>new</code>一个对象。比如下面的例子：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Integer m = <span class="hljs-number">1</span>;<br>Integer n = <span class="hljs-number">1</span>;<br>System.out.println(m == n); <span class="hljs-comment">//true</span><br>Integer x = <span class="hljs-number">128</span>;<br>Integer y = <span class="hljs-number">128</span>;<br><span class="hljs-comment">//数字128超出了IntegerCache数组的范围，此时x和y是两个不同的对象</span><br>System.out.println(x == y); <span class="hljs-comment">//false</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="八、-和equals-的区别"><a href="#八、-和equals-的区别" class="headerlink" title="八、== 和equals()的区别"></a>八、== 和equals()的区别</h1><ul>
<li><code>==</code>是运算符，可以使用在基本数据类型和引用数据类型中：<ul>
<li>对于基本数据类型，<code>==</code>操作符比较两个变量保存的数据是否相等。</li>
<li>对于引用数据类型，<code>==</code>比较的是两个对象的地址值是否相同，即两个引用是否指向同一个对象实体。</li>
<li><code>==</code>操作符两边变量的类型不一定相同，但必须要兼容，能够比较，比如<code>10 == 10.0</code>结果为<code>true</code>，<code>int</code>和<code>char</code>类型也能够比较，<code>97 == 'a'</code>结果为<code>true</code>。</li>
</ul>
</li>
<li><code>equals()</code>是方法，只能用于引用数据类型。<ul>
<li><code>Object</code>类中的equals()方法使用的是==运算符，因此比较的是对象的地址。</li>
<li>像<code>String</code>、<code>Date</code>、<code>File</code>、<code>包装类</code>等类，重写了<code>Object</code>类中的<code>equals()</code>方法。重写以后，比较的是两个对象的“<strong>实体内容(各种属性)</strong>”是否相同。</li>
<li>通常，自定义的类如果使用<code>equals()</code>方法，也是比较对象的内容是否相同，需要对<code>equals()</code>重写。重写<code>equals()</code>方法也可以使用自动生成的方法。</li>
</ul>
</li>
</ul>
<blockquote>
<p>判断某个类中的<code>equals()</code>方法的功能，需要看其是否对<code>equals()</code>进行了重写，以及怎样重写的。</p>
</blockquote>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记07-异常处理</title>
    <url>/2021/03/26/java-note-0701/</url>
    <content><![CDATA[<h1 id="一、异常概述与异常体系结构"><a href="#一、异常概述与异常体系结构" class="headerlink" title="一、异常概述与异常体系结构"></a>一、异常概述与异常体系结构</h1><h2 id="1、异常概述"><a href="#1、异常概述" class="headerlink" title="1、异常概述"></a>1、异常概述</h2><p>Java中的异常可以分为两类：</p>
<ul>
<li><code>Error</code>：Java虚拟机无法解决的严重问题，如：JVM系统内部错误、资源耗尽等严重情况。比如<code>StackOverflowError</code>和<code>OOM</code>。对于这类异常一般不编写针对性代码进行处理。</li>
<li><code>Exception</code>：其他因编程错误或偶然的外在因素导致的一般性问题。可以使用针对性代码进行处理，如<ul>
<li>空指针异常：<code>NullPointerException</code></li>
<li>读取不存在的文件：<code>FileNotFoundException</code></li>
<li>类型转换异常：<code>ClassCastException</code></li>
<li>数组索引越界：<code>ArrayIndexOutOfBoundException</code></li>
</ul>
</li>
</ul>
<h2 id="2、异常体系结构"><a href="#2、异常体系结构" class="headerlink" title="2、异常体系结构"></a>2、异常体系结构</h2><p>Java中的异常体系结构如下：</p>
<p><code>java.lang.Throwable</code>有以下继承关系:</p>
<ul>
<li><p><code>java.lang.Error</code>：</p>
<ul>
<li><code>StackOverflowError</code></li>
<li><code>OutOfMemoryError</code></li>
<li><code>...</code></li>
</ul>
</li>
<li><p><code>java.lang.Exception</code>：</p>
<ul>
<li><code>ClassNotFoundException</code></li>
<li><code>CloneNotSupportedException</code></li>
<li><p><code>IOException</code>：</p>
<ul>
<li><code>EOFException</code></li>
<li><code>FileNotFoundException</code></li>
<li><code>MalformedURLException</code></li>
<li><code>UnknowHostException</code></li>
<li><code>...</code></li>
</ul>
</li>
<li><p><code>RuntimeException</code>:</p>
<ul>
<li><code>ArithmeticException</code>：除数是0时报此异常</li>
<li><code>ClassCastException</code></li>
<li><code>IllegalArgumentException</code></li>
<li><code>IllegalStateException</code></li>
<li><code>IndexOutOfBoundsException</code></li>
<li><code>NoSuchElementException</code></li>
<li><code>NullPointerException</code></li>
<li><code>...</code></li>
</ul>
</li>
<li><code>...</code></li>
</ul>
</li>
</ul>
<p>可以看到，<code>Throwable</code>是异常体系的根父类，其有<code>Error</code>和<code>Exception</code>两个子类，<code>Exception</code>分为<strong>运行时异常(RuntimeException)</strong>和<strong>编译时异常(IOException等)</strong>，其中<strong>运行时异常</strong>又可以称为<strong>非受检(unchecked)异常</strong>，<strong>编译时异常</strong>称为<strong>受检(checked)异常</strong>。</p>
<h2 id="3、异常处理"><a href="#3、异常处理" class="headerlink" title="3、异常处理"></a>3、异常处理</h2><p>Java中对于异常处理使用的<strong>抓抛模型</strong>：</p>
<ul>
<li>第一步，“抛”出异常：执行过程中，一旦出现异常，会在代码处生成一个对应异常类的对象，并将此对象抛出，一旦抛出异常对象以后，其后的代码不再执行。<ul>
<li>抛出异常有两种方式：①系统自动生成异常对象并自动抛出。②手动生成异常对象并抛出(<code>throw</code>)</li>
</ul>
</li>
<li>第二步，“抓”住异常(<strong>捕获(catch)异常</strong>)，即异常的处理。<ul>
<li>对于异常处理有两种方法：①<code>try-catch-finally</code>。②使用<code>throws</code>将异常交给方法调用者处理。</li>
</ul>
</li>
</ul>
<h1 id="二、异常处理机制之一：try-catch-finally"><a href="#二、异常处理机制之一：try-catch-finally" class="headerlink" title="二、异常处理机制之一：try-catch-finally"></a>二、异常处理机制之一：try-catch-finally</h1><h2 id="1、try-catch的使用"><a href="#1、try-catch的使用" class="headerlink" title="1、try-catch的使用"></a>1、try-catch的使用</h2><p><code>try-catch-finally</code>的使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">    <span class="hljs-keyword">try</span>{<br>        <span class="hljs-comment">//可能出现异常的代码</span><br>    }<span class="hljs-keyword">catch</span>(异常类型<span class="hljs-number">1</span> 变量名<span class="hljs-number">1</span>){<br>        <span class="hljs-comment">//处理异常的方式1</span><br>    }<span class="hljs-keyword">catch</span>(异常类型<span class="hljs-number">2</span> 变量名<span class="hljs-number">2</span>){<br>        <span class="hljs-comment">//处理异常的方式2</span><br>    }<span class="hljs-keyword">catch</span>(异常类型<span class="hljs-number">3</span> 变量名<span class="hljs-number">3</span>){<br>        <span class="hljs-comment">//处理异常的方式3</span><br>    }<br>    ......<br>    <span class="hljs-keyword">finally</span>{<br>        <span class="hljs-comment">//一定会执行的代码</span><br>    }<br><br><span class="hljs-comment">//例如：</span><br>	<span class="hljs-keyword">try</span>{<br>       ...<span class="hljs-comment">//读取文件的语句</span><br>    }<span class="hljs-keyword">catch</span>(IOException e){<br>        System.out.println(e.getMessage());<br>    }<br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><code>finally</code>是可选的，<code>try-catch-finally</code>结构可以嵌套。</li>
<li>使用<code>try</code>将可能出现异常的代码包装起来，一旦出现异常，会生成一个对应异常类的对象，根据此对象的类型，去<code>catch</code>中匹配。</li>
<li><code>try</code>中的异常对象匹配到某个<code>catch</code>时，就进入<code>catch</code>中处理，处理完成后，跳出<code>try-catch</code>结构(没有<code>finally</code>时)，继续执行其后的代码</li>
<li>catch中的异常类型如果没有子父类关系，则多个<code>catch</code>无关顺序。如果多个<code>catch</code>的异常类型有子父类关系，需要将子类写在父类的前面，否则出错。比如<code>NullPointerException</code>必须写在<code>RuntimeException</code>前面。</li>
<li>常用的异常对象处理的方式：<ul>
<li><code>Sting getMessage()</code>：获取异常信息，返回字符串。</li>
<li><code>printStackTrace()</code>：获取异常类名和异常信息，以及异常出现在程序中的位置，返回值<code>void</code>。</li>
</ul>
</li>
<li><code>try</code>结构中声明的变量，在<code>try</code>结构外面不能调用。可以将变量声明在外面，在<code>try</code>结构中赋值。</li>
</ul>
<h2 id="2、finally"><a href="#2、finally" class="headerlink" title="2、finally"></a>2、finally</h2><p><code>finally</code>的用法：</p>
<ul>
<li><code>finally</code>中声明的是一定会被执行的代码。即使<code>catch</code>中又出现异常、<code>try</code>中有<code>return</code>语句、<code>catch</code>中有<code>return</code>语句，<code>finally</code>中的语句也会执行。</li>
<li>数据库连接、输入输出流、网络编程Socket等资源，JVM不能自动回收，需要手动进行资源的释放。此时的资源释放，需要声明在<code>finally</code>中。</li>
</ul>
<h2 id="3、不捕获异常的情况"><a href="#3、不捕获异常的情况" class="headerlink" title="3、不捕获异常的情况"></a>3、不捕获异常的情况</h2><ul>
<li>使用<code>try-catch-finally</code>处理编译时异常，使程序在编译时不报错，但运行时仍可能报错。相当于使用<code>try-catch-finally</code>将<strong>编译时</strong>可能出现的异常延迟到<strong>运行时</strong>出现。</li>
<li>由于运行时异常比较常见，Java能够自动捕获，因此，对于运行时异常，通常不使用<code>try-catch</code>结构捕获。而对于<strong>编译时异常，必须进行异常处理(捕获异常)</strong>。</li>
</ul>
<h1 id="三、异常处理机制之二：throws"><a href="#三、异常处理机制之二：throws" class="headerlink" title="三、异常处理机制之二：throws"></a>三、异常处理机制之二：throws</h1><h2 id="1、throws的使用"><a href="#1、throws的使用" class="headerlink" title="1、throws的使用"></a>1、throws的使用</h2><p>使用<code>throws</code>声明抛出异常是处理异常的第二种方式。如果一个方法中可能生成某种异常，但不能确定如何处理这种异常，就可以使用<code>throws</code>显式地声明抛出异常，表示该方法不对这些异常处理，而是由调用者负责处理。</p>
<p>当方法体执行时出现异常，会在异常代码处生成一个异常类对象，如果此对象满足throws后的异常类型，就会被抛出(抛给方法的调用者)，异常代码后面的语句不再执行。</p>
<p><code>throws</code>的使用格式为：<code>throws 异常类型</code>，写在方法声明处的方法名后面。</p>
<p>例如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> FileNotFoundException, IOException</span>{<br>    <span class="hljs-comment">//读取文件的语句</span><br>    File file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"xxx.txt"</span>);<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>可以同时声明多个类型的抛出异常。</p>
<p>对于重写的方法，子类重写的方法抛出的异常<strong>不大于</strong>父类被重写的方法抛出的异常类型。</p>
</blockquote>
<h2 id="2、throws和try-catch"><a href="#2、throws和try-catch" class="headerlink" title="2、throws和try-catch"></a>2、throws和try-catch</h2><p><code>throws</code>和<code>try-catch</code>都是异常处理的两种方式，其区别是：</p>
<ul>
<li><code>try-catch-finally</code>真正地将异常处理掉了。</li>
<li><code>throws</code>的方式只是将异常抛给了方法的调用者，没有真正地处理掉异常。</li>
</ul>
<p>如何选择两种处理方式？</p>
<ul>
<li>如果父类中被重写的方法没有<code>throws</code>方式处理异常，则子类重写的方法不能使用<code>throws</code>，如果有异常只能使用<code>try-catch-finally</code>的方式。</li>
<li>如果执行的方法a中先后调用了另外的几个递进关系的方法，建议这几个方法使用<code>throws</code>处理异常，而方法a使用<code>try-catch-finally</code>。</li>
</ul>
<h1 id="四、手动抛出异常：throw"><a href="#四、手动抛出异常：throw" class="headerlink" title="四、手动抛出异常：throw"></a>四、手动抛出异常：throw</h1><p>Java异常类对象除了系统自动生成以外，还可以手动创建异常类对象并抛出。需要先声明异常类对象，然后通过throw语句抛出：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">IOException e = <span class="hljs-keyword">new</span> IOException();  <span class="hljs-comment">//创建异常类对象</span><br><span class="hljs-keyword">throw</span> e;  <span class="hljs-comment">//将异常类对象抛出</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>手动抛出异常的方式，可以用在<code>try-catch</code>结构里和使用了<code>throws</code>的方法中。</p>
</blockquote>
<p><code>throw</code>的应用：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//场景一：</span><br><span class="hljs-keyword">try</span> {<br>    System.out.println(<span class="hljs-string">"try"</span>);<br>    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"制造异常"</span>);<br>} <span class="hljs-keyword">catch</span>{<br>    System.out.println(<span class="hljs-string">"catch"</span>);<br>}<br><span class="hljs-comment">//场景二：</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>    <span class="hljs-keyword">if</span>(xxx){<br>        <span class="hljs-comment">//执行语句</span><br>    }<span class="hljs-keyword">else</span>{<br>        <span class="hljs-comment">//手动抛出异常对象</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"您输入的数据非法！"</span>);<br>        <span class="hljs-comment">//throw new MyException("不能输入负数");  //抛出自定义异常类对象</span><br>    }<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、自定义异常类"><a href="#五、自定义异常类" class="headerlink" title="五、自定义异常类"></a>五、自定义异常类</h1><p>一般来说，自定义异常类都是<code>RuntimeException</code>、<code>Exception</code>的子类，过程如下：</p>
<ul>
<li>编写重载的构造器。</li>
<li>提供<code>serialVersionUID</code></li>
<li>通过<code>throw</code>抛出异常类对象</li>
</ul>
<p>以下是自定义类的举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RuntimeException</span></span>{<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> serialVersionUID = -<span class="hljs-number">1234567890L</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyException</span><span class="hljs-params">()</span></span>{}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MyException</span><span class="hljs-params">(String msg)</span></span>{<br>        <span class="hljs-keyword">super</span>(msg);<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记09(1)-常用类之String</title>
    <url>/2021/04/03/java-note-0901/</url>
    <content><![CDATA[<h1 id="一、String类"><a href="#一、String类" class="headerlink" title="一、String类"></a>一、String类</h1><h2 id="1、字符串的使用"><a href="#1、字符串的使用" class="headerlink" title="1、字符串的使用"></a>1、字符串的使用</h2><p><code>String</code>类的特征：</p>
<ul>
<li><code>String</code>类声明为<code>final</code>的，不可以被继承。</li>
<li><code>String</code>类实现了<code>Serializable</code>接口，表示字符串是支持序列化的。</li>
<li><code>String</code> 类实现了<code>Comparable</code>接口，表示字符串可以比较大小</li>
<li><code>String</code>类内部定义了<code>final char[] value</code>，用于存储字符串数据。数组不能被重新赋值，数组元素不能被修改。（JDK 9.0改为了<code>byte</code>数组）</li>
<li><code>String</code>代表不可变的字符序列，<strong>不可变性</strong>，以下操作需要重写指定内存区域进行赋值，不能使用原有的<code>value</code>进行赋值：<ul>
<li>当对字符串重新赋值时</li>
<li>当对现有的字符串进行连接操作时</li>
<li>当调用String的replace方法修改指定的字符/字符串时</li>
</ul>
</li>
</ul>
<h2 id="2、字符串创建和存储"><a href="#2、字符串创建和存储" class="headerlink" title="2、字符串创建和存储"></a>2、字符串创建和存储</h2><p>字符串有两种创建方式：</p>
<ul>
<li>字面量定义：比如 <code>String s1 = "hello";</code></li>
<li>创建<code>String</code>类对象：比如：<code>String s2 = new String("hello");</code></li>
</ul>
<p>字面量定义的字符串存储在<strong>字符串常量池（位于方法区）</strong>中，目的是共享；通过创建对象构建的字符串存储在<strong>堆</strong>中，堆中的地址值又指向字符串常量池中的值。</p>
<blockquote>
<p>字符串常量池中不会保存内容相同的字符串，每个字符串只保存一份。</p>
<p>通过创建String类对象构造的字符串，内存中一共创建了两个对象，一个String类对象，一个底层的数组对象。</p>
</blockquote>
<p>两种方式定义的字符串，在内存中的区别：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-0901_1.png">
</div>



<p>具体案例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> class <span class="hljs-title">Test</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span></span>{<br>        String s1 = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">//字面量方式定义</span><br>        String s2 = <span class="hljs-string">"hello"</span>;<br>        String s3 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"hello"</span>);  <span class="hljs-comment">//创建对象的方式定义</span><br>        String s4 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"hello"</span>);<br>        <br>        <span class="hljs-comment">//字面量定义的字符串，直接指向常量池，所以地址相等</span><br>        System.out.println(s1 == s2);  <span class="hljs-comment">//true</span><br>        <span class="hljs-comment">//new出来的每个对象有单独的空间和地址，因此地址不同</span><br>        System.out.println(s3 == s4); <span class="hljs-comment">//false</span><br>        System.out.println(s1 == s3); <span class="hljs-comment">//false</span><br>        System.out.println(s1 == s4); <span class="hljs-comment">//false</span><br>        <span class="hljs-comment">//只要其中一个是变量，地址就不相等</span><br>        System.out.println(<span class="hljs-string">"hello"</span>+<span class="hljs-string">"java"</span> == <span class="hljs-string">"hello"</span>+<span class="hljs-string">"java"</span>); <span class="hljs-comment">//true</span><br>        System.out.println(<span class="hljs-string">"hello"</span>+<span class="hljs-string">"java"</span> == <span class="hljs-string">"hellojava"</span>);  <span class="hljs-comment">//true</span><br>        System.out.println((s1+<span class="hljs-string">"java"</span>) == (s1+<span class="hljs-string">"java"</span>)); <span class="hljs-comment">//false</span><br>        System.out.println((s1+<span class="hljs-string">"java"</span>) == (s2+<span class="hljs-string">"java"</span>)); <span class="hljs-comment">//false</span><br>        <span class="hljs-comment">//此时的s5是新创建的字符串，s4本身并没有改变</span><br>        String s5 = s4.replace(<span class="hljs-string">'h'</span>,<span class="hljs-string">'a'</span>); <br>        System.out.println(s4);  <span class="hljs-comment">//hello</span><br>        System.out.println(s5);  <span class="hljs-comment">//aello</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>总结：</p>
<ul>
<li>常量(字面量定义的，或者final修饰的，都是常量)与常量的拼接结果在常量池。且常量池中不会存在相同内容的常量。</li>
<li>只要其中有一个是变量，结果就在堆中，地址也不同。比如<code>s1 + s2</code>、<code>s1+"abc"</code>、<code>s1+="abc"</code>等，用<code>==</code>比较是地址，结果是<code>false</code>，比如<code>s1+"abc" == s1+"abc"</code>为<code>false</code></li>
<li>如果拼接的结果调用<code>intern()</code>方法，返回值就在常量池中。</li>
</ul>
<h1 id="二、String类常用方法"><a href="#二、String类常用方法" class="headerlink" title="二、String类常用方法"></a>二、String类常用方法</h1><p>String类的常用方法：</p>
<p><code>int length()</code>：返回字符串的长度：<code>return value.length</code><br><code>char charAt(int index)</code>：返回某索引处的字符：<code>return value[index]</code><br><code>boolean isEmpty()</code>：判断是否是空字符串：<code>return value.length==0</code><br><code>String toLowerCase()</code>：使用默认语言环境，将String中的所有字符转换为小写<br><code>String toUpperCase()</code>：使用默认语言环境，将String中的所有字符转换为大写<br><code>String trim()</code>：返回字符串的副本，忽略前导空白和尾部空白<br><code>boolean equals(Object obj)</code>：比较字符串的内容是否相同<br><code>boolean equalsIgnoreCase(String anotherString)</code>：与equals方法类似，忽略大小写<br><code>String concat(String str)</code>：将指定字符串连接到此字符串的结尾。等价于用“+”<br><code>int compareTo(String anotherString)</code>：比较两个字符串的大小<br><code>String substring(int beginIndex)</code>：返回一个新的字符串，它是此字符串的从beginIndex开始截取到最后的一个子字符串。<br><code>String substring(int beginIndex,int endIndex)</code>：返回一个新字符串，它是此字符串从beginIndex开始截取到endIndex(不包含)的一个子字符串。<br><code>boolean endsWith(String suffix)</code>：测试此字符串是否以指定的后缀结束<br><code>boolean startsWith(String prefix)</code>：测试此字符串是否以指定的前缀开始<br><code>boolean startsWith(String prefix,int toffset)</code>：测试此字符串从指定索引开始的子字符串是否以指定前缀开始<br><code>boolean contains(CharSequence s)</code>：当且仅当此字符串包含指定的char值序列时，返回true<br><code>int indexOf(String str)</code>：返回指定子字符串在此字符串中第一次出现处的索引<br><code>int indexOf(String str, int fromIndex)</code>：返回指定子字符串在此字符串中第一次出现处的索引，从指定的索引开始<br><code>int lastIndexOf(String str)</code>：返回指定子字符串在此字符串中最右边出现处的索引<br><code>int lastIndexOf(String str, int fromIndex)</code>：返回指定子字符串在此字符串中最后一次出现处的索引，从指定的索引开始反向搜索</p>
<blockquote>
<p>注：<code>indexOf</code>和<code>lastIndexOf</code>方法如果未找到都是返回-1 </p>
</blockquote>
<p><code>String replace(char oldChar,char newChar)</code>：返回一个新的字符串，它是通过用newChar替换此字符串中出现的所有oldChar得到的。<br><code>String replace(CharSequence target,CharSequence replacement)</code>：使用指定的字面值替换序列替换此字符串所有匹配字面值目标序列的子字符串。<br><code>String replaceAll(String regex,String replacement)</code>：使用给定的replacement替换此字符串所有匹配给定的正则表达式的子字符串。<br><code>String replaceFirst(String regex,String replacement)</code>：使用给定的replacement替换此字符串匹配给定的正则表达式的第一个子字符串。<br><code>boolean matches(String regex)</code>：告知此字符串是否匹配给定的正则表达式。<br><code>String[] split(String regex)</code>：根据给定正则表达式的匹配拆分此字符串。<br><code>String[] split(String regex,int limit)</code>：根据匹配给定的正则表达式来拆分此字符串，最多不超过limit个，如果超过了，剩下的全部都放到最后一个元素中。</p>
<h1 id="三、String类与基本数据类型之间的转换"><a href="#三、String类与基本数据类型之间的转换" class="headerlink" title="三、String类与基本数据类型之间的转换"></a>三、String类与基本数据类型之间的转换</h1><h2 id="1、字符串与基本数据类型、包装类"><a href="#1、字符串与基本数据类型、包装类" class="headerlink" title="1、字符串与基本数据类型、包装类"></a>1、字符串与基本数据类型、包装类</h2><ul>
<li>字符串—&gt;基本数据类型、包装类:<ul>
<li><code>Integer</code>包装类的<code>public static int parseInt(String s)</code>可将由“数字”字符组成的字符串转换为整型。类似地,使用<code>java.lang</code>包中的<code>Byte</code>、<code>Short</code>、<code>Long</code>、<code>Float</code>、<code>Double</code>类调相应的类方法可以将由“数字”字符组成的字符串，转化为相应的基本数据类型。</li>
</ul>
</li>
<li>基本数据类型、包装类—&gt;字符串：<ul>
<li>调用<code>String</code>类的<code>public String valueOf(int n)</code>可将<code>int</code>型转换为字符串。相应的<code>valueOf(byte b)</code>、<code>valueOf(long l)</code>、<code>valueOf(float f)</code>、<code>valueOf(double d)</code>、<code>valueOf(boolean b)</code>可由参数的相应类型到字符串的转换。</li>
</ul>
</li>
</ul>
<h2 id="2、字符串与字符数组"><a href="#2、字符串与字符数组" class="headerlink" title="2、字符串与字符数组"></a>2、字符串与字符数组</h2><ul>
<li>字符数组—&gt;字符串：<ul>
<li><code>String</code>类的构造器：<code>String(char[])</code>和<code>String(char[]，int offset，int length)</code>分别用字符数组中的全部字符和部分字符创建字符串对象。</li>
</ul>
</li>
<li>字符串—&gt;字符数组：<ul>
<li><code>public char[] toCharArray()</code>：将字符串中的全部字符存放在一个字符数组中。</li>
<li><code>public void getChars(int srcBegin, int srcEnd, char[]dst, int dstBegin)</code>：提供了将指定索引范围内的字符串存放到数组中的方法。</li>
</ul>
</li>
</ul>
<h2 id="3、字符串与字节数组"><a href="#3、字符串与字节数组" class="headerlink" title="3、字符串与字节数组"></a>3、字符串与字节数组</h2><ul>
<li>字节数组—&gt;字符串：<ul>
<li><code>String(byte[])</code>：通过使用平台的默认字符集解码指定的byte数组，构造一个新的String。</li>
<li><code>String(byte[]，int offset，int length)</code>：用指定的字节数组的一部分，即从数组起始位置offset开始取length个字节构造一个字符串对象。</li>
</ul>
</li>
<li>字符串—&gt;字节数组：<ul>
<li><code>public byte[] getBytes()</code>：使用平台的默认字符集(编码方式)将此String编码为byte序列，并将结果存储到一个新的byte数组中。</li>
<li><code>public byte[] getBytes(String charsetName)</code>：使用指定的字符集将此String编码到byte序列，并将结果存储到新的byte数组。</li>
</ul>
</li>
</ul>
<blockquote>
<p>字节数组转换为字符串的过程，就是解码的过程，反之，字符串变为字节数组是编码的过程。</p>
<p>编码和解码默认使用平台默认字符集。</p>
<p>编码和解码使用的字符集(比如都是UTF-8)应该相同，否则出现乱码。</p>
</blockquote>
<h1 id="四、StringBuffer和StringBuilder"><a href="#四、StringBuffer和StringBuilder" class="headerlink" title="四、StringBuffer和StringBuilder"></a>四、StringBuffer和StringBuilder</h1><p><code>StringBuffer</code>和<code>StringBuilder</code>都是<strong>可变的字符序列</strong>，对字符串修改，不会产生新的对象，直接在原来的字符串对象上进行修改。</p>
<p><code>String</code>、<code>StringBuffer</code>、<code>StringBuilder</code>的异同：</p>
<ul>
<li><code>String</code>： 1.0 ，不可变的字符序列；底层使用char[]来保存</li>
<li><code>StringBuffer</code>：1.0 ，可变的字符序列；<strong>线程安全</strong>的，效率低；底层使用char[]来保存</li>
<li><code>StringBuilder</code>：JDK 5.0新增 ，可变的字符序列；<strong>线程不安全</strong>，效率高；底层使用char[]来保存</li>
</ul>
<blockquote>
<p>JDK9.0之后，三者的底层存储结构都改为了byte[]数组</p>
<p>效率从高到低排列：<code>StringBuilder</code> &gt; <code>StringBuffer</code>&gt; <code>String</code></p>
</blockquote>
<p><code>StringBuffer</code>和<code>StringBuilder</code>在使用方法上类似，提供的方法也相同。这里以<code>StringBuffer</code>为例，讲解其扩容机制以及常用的方法。</p>
<h2 id="1、构造StringBuffer-StringBuilder对象"><a href="#1、构造StringBuffer-StringBuilder对象" class="headerlink" title="1、构造StringBuffer/StringBuilder对象"></a>1、构造StringBuffer/StringBuilder对象</h2><p><code>StringBuffer</code>类不同于<code>String</code>，其对象必须使用构造器生成。有三个构造器：</p>
<ul>
<li><code>StringBuffer()</code>：初始容量为16的字符串缓冲区。</li>
<li><code>StringBuffer(intsize)</code>：构造指定容量的字符串缓冲区。</li>
<li><code>StringBuffer(String str)</code>：将内容初始化为指定字符串内容。</li>
</ul>
<p>举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> class <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title">main</span><span class="hljs-params">(String args[])</span></span>{<br>        StringBuffer sb1 = <span class="hljs-keyword">new</span> StringBuffer(<span class="hljs-string">"abc"</span>);  <span class="hljs-comment">//abc</span><br>        sb1.setCharAt(<span class="hljs-number">0</span>,<span class="hljs-string">'m'</span>); <span class="hljs-comment">//直接修改sb1，不会创建新的对象</span><br>        System.out.println(sb1);  <span class="hljs-comment">//mbc  </span><br><br>        StringBuffer sb2 = <span class="hljs-keyword">new</span> StringBuffer();<br>        System.out.println(sb2.length());  <span class="hljs-comment">//0</span><br>        StringBuffer sb3 = <span class="hljs-keyword">new</span> StringBuffer();<br>        String s = <span class="hljs-keyword">null</span>;<br>        sb3.append(s); <span class="hljs-comment">//append方法可以将null当作字符串添加进去</span><br>        System.out.println(sb3);  <span class="hljs-comment">//此时的sb3为字符串"null"</span><br>        System.out.println(sb3.length()); <span class="hljs-comment">// 4</span><br>        <span class="hljs-comment">//StringBuffer sb4 = new StringBuffer(null); //构造的时候不行</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>String</code>、<code>StringBuffer</code>、<code>StringBuilder</code>三者之间的相互转换：</p>
<ul>
<li><code>String</code>—&gt;<code>StringBuffer</code>、<code>StringBuilder</code>，直接调用两者的构造器：<code>StringBuffer sb = new StringBuffer(str);</code></li>
<li><code>StringBuffer</code>、<code>StringBuilder</code>—&gt;<code>String</code>：<ul>
<li>调用两者的<code>toString()</code>方法</li>
<li>调用<code>String</code>的构造器。<code>String str = new String(sb);</code></li>
</ul>
</li>
</ul>
<h2 id="2、扩容机制"><a href="#2、扩容机制" class="headerlink" title="2、扩容机制"></a>2、扩容机制</h2><p>对于<code>StringBuffer</code>和<code>StringBuilder</code>来说，如果添加的数据，底层数组装不下，就需要扩容底层的数组。</p>
<p>默认情况下，扩容为原来容量的2倍+2（JDK 7.0 ，不同JDK版本可能不同），同时将原有数组中的元素复制到新的数组中。</p>
<blockquote>
<p>关于为什么+2，各种解释：</p>
<p>1、考虑到在创建Sf，Sb设置的初始长度不大时（例如1），+2 可以很大地提升扩容的效率，减少扩容的次数</p>
<p>2、在旧版本的JDK扩容语句是 (value.length + 1) * 2 先加一再乘2，推测原意思是扩容的话至少增添一个空间再乘2，兼顾到扩容的次数和要减少扩容过大浪费的空间</p>
<p>3、newCapacity(int)的传入参数有可能是0，那么在参数是0的情况下，0&lt;&lt;1运算结果也是0，如果没+2，那么在创建数组的时候会创建出MAX_ARRAY_SIZE大小，所以作为设计的安全性考虑，选择了+2。</p>
<p>4、在使用StringBuffer的时候，append()之后，我们一般会在后面在加上一个分隔符，例如逗号，也就是再加上一个char，而char在java中占2个字节，避免了因为添加分隔符而再次引起扩容</p>
</blockquote>
<p>举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">String str = <span class="hljs-keyword">new</span> String();  <span class="hljs-comment">//底层操作：new char[0]</span><br>String str1 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"abc"</span>);<span class="hljs-comment">//底层操作：new char[]{'a','b','c'}</span><br><br>StringBuffer sb = <span class="hljs-keyword">new</span> StringBuffer();   <span class="hljs-comment">//sb.length()是0</span><br><span class="hljs-comment">//默认创建长度为16的内容为空的数组，即char[] value = new char[16]</span><br><span class="hljs-comment">//这里sb.length()的结果是0，返回长度不是底层value数组的长度</span><br>sb.append(<span class="hljs-string">'a'</span>);  <span class="hljs-comment">//底层操作：value[0] = 'a';</span><br><br>StringBuffer sb2 = <span class="hljs-keyword">new</span> StringBuffer(<span class="hljs-string">"abc"</span>); <br><span class="hljs-comment">//构建一个长度为"abc".length()+16的数组，即：</span><br><span class="hljs-comment">//char[] value = new char["abc".length()+16]</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>为了提高效率，建议使用<code>StringBuffer(int capacity)</code> 或 <code>StringBuilder(int capacity)</code>指定初始容量，尽量避免自动扩容。</p>
</blockquote>
<h2 id="3、常用方法"><a href="#3、常用方法" class="headerlink" title="3、常用方法"></a>3、常用方法</h2><ul>
<li><code>String Buffer append(xxx)</code>：提供了很多的append()方法，用于进行字符串拼接。如果参数是null，会被当成字符串添加进去</li>
<li><code>String Buffer delete(int start,int end)</code>：删除指定位置的内容</li>
<li><code>String Buffer replace(int start,int end,String str)</code>：把[start,end)位置替换为str</li>
<li><code>String Buffer insert(int offset,xxx)</code>：在指定位置插入xxx</li>
<li><code>String Buffer reverse()</code>：把当前字符序列逆转</li>
<li><code>public int indexOf(String str)</code></li>
<li><code>public String substring(int start,int end)</code></li>
<li><code>public int length()</code></li>
<li><code>public char charAt(int n )</code></li>
<li><code>public void setCharAt(int n ,char ch)</code></li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记09(3)-常用类之Java比较器和其他常用类</title>
    <url>/2021/04/05/java-note-0903/</url>
    <content><![CDATA[<h1 id="一、Java比较器"><a href="#一、Java比较器" class="headerlink" title="一、Java比较器"></a>一、Java比较器</h1><p>Java实现对象排序有两种方式：</p>
<ul>
<li>自然排序：<code>java.lang.Comparable</code></li>
<li>定制排序：<code>java.util.Comparator</code></li>
</ul>
<h2 id="1、Comparable"><a href="#1、Comparable" class="headerlink" title="1、Comparable"></a>1、Comparable</h2><p><code>Comparable</code>接口强行对实现它的每个类的对象进行整体排序，这种排序称为类的自然排序。</p>
<p>实现<code>Comparable</code>的类，必须实现<code>compareTo(Object obj)</code>方法，从小到大的排序规则如下：</p>
<ul>
<li>如果当前对象this大于obj，返回正整数。</li>
<li>如果当前对象this小于obj，返回负整数。</li>
<li>如果当前对象this等于obj，返回0。</li>
</ul>
<blockquote>
<p>以上规则是从小到大排列，如果想从大到小排列，则正负和上面相反。</p>
</blockquote>
<p><code>String</code>类、包装类等类实现了<code>Comparable</code>接口，并实现了<code>compareTo()</code>方法，进行了从小到大的排列。</p>
<p>实现<code>Comparable</code>接口的对象列表可以通过<code>Collections.sort</code>或<code>Arrays.sort</code>进行自动排序，比如<code>String</code>数组就可以自动比较大小，自动排序：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompareTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>        String[] str = <span class="hljs-keyword">new</span> String[]{<span class="hljs-string">"DD"</span>,<span class="hljs-string">"BB"</span>,<span class="hljs-string">"AA"</span>,<span class="hljs-string">"CC"</span>};<br>        <span class="hljs-comment">//String实现了Comparable接口，String对象可以比较大小</span><br>        Arrays.sort(str);  <span class="hljs-comment">//借助Arrays.sort进行排序</span><br>        System.out.println(Arrays.toString(str));<br>        <span class="hljs-comment">//输出结果为：[AA, BB, CC, DD]</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、Comparator"><a href="#2、Comparator" class="headerlink" title="2、Comparator"></a>2、Comparator</h2><p>当元素的类型没有实现<code>java.lang.Comparable</code>接口而又不方便修改代码，或者实现了<code>java.lang.Comparable</code>接口的排序规则不适合当前的操作，那么可以考虑使用<code>Comparator</code>的对象来排序，强行对多个对象进行整体排序的比较。</p>
<p>实现<code>Comparator</code>接口需要实现其<code>compare(Obj o1, Obj o2)</code>方法，规则和<code>compareTo(Object obj)</code>相同。</p>
<p>同样地，可以将<code>Comparator</code>传递给<code>sort</code>方法（如<code>Collections.sort</code>或<code>Arrays.sort</code>），控制排序规则。还可以使用<code>Comparator</code>来控制某些数据结构（如有序set或有序映射）的顺序，或者为那些没有自然顺序的对象<code>collection</code>提供排序。</p>
<p>举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CompareTest</span> </span>{<br>        <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>        String[] str = <span class="hljs-keyword">new</span> String[]{<span class="hljs-string">"DD"</span>,<span class="hljs-string">"BB"</span>,<span class="hljs-string">"AA"</span>,<span class="hljs-string">"CC"</span>};<br>        <span class="hljs-comment">//实现Comparator接口，自定义排序规则。需要重写compare方法</span><br>        <span class="hljs-comment">//Arrays.sort方法的第二个参数，需要比较器对象，这里使用匿名实现类对象</span><br>        Arrays.sort(str, <span class="hljs-keyword">new</span> Comparator() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Object o1, Object o2)</span> </span>{<br>                <span class="hljs-comment">//如果使用泛型，这里可以不用强制转型</span><br>                <span class="hljs-keyword">if</span>(o1 <span class="hljs-keyword">instanceof</span> String &amp;&amp; o2 <span class="hljs-keyword">instanceof</span> String){<br>                    String s1 = (String) o1;<br>                    String s2 = (String) o2;<br>                    <span class="hljs-keyword">return</span> -s1.compareTo(s2);<br>                }<span class="hljs-keyword">else</span>{ <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"类型错误"</span>);}<br>            }<br>        });<br>        System.out.println(Arrays.toString(str));<br>        <span class="hljs-comment">//临时改变了排序规则，此时输出为[DD, CC, BB, AA]</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p><code>Comparable</code>接口的方式一旦指定，保证<code>Comparable</code>接口实现类的对象在任何位置都可以比较大小。<br><code>Comparator</code>接口属于临时性的比较。</p>
</blockquote>
<h1 id="二、System类"><a href="#二、System类" class="headerlink" title="二、System类"></a>二、System类</h1><p><code>java.lang.System</code>类代表系统，系统级的很多属性和控制方法都放置在该类的内部。</p>
<p><code>System</code>类的构造器是<code>private</code>的，因此无法创建该类的对象，其内的成员变量和成员方法都是<code>static</code>的，可以方便调用。</p>
<p><strong>成员变量</strong>：</p>
<ul>
<li><code>in</code>：标准输入流</li>
<li><code>out</code>：标准输出流</li>
<li><code>err</code>：标准错误输出流</li>
</ul>
<p><strong>成员方法</strong>：</p>
<ul>
<li><p><code>native long currentTimeMillis()</code>：返回当前的计算机时间，时间的表达格式为当前计算机时间和GMT时间(格林威治时间)1970年1月1号0时0分0秒所差的毫秒数。</p>
</li>
<li><p><code>void exit(int status)</code>：退出程序。其中status的值为0代表正常退出，非零代表异常退出。使用该方法可以在图形界面编程中实现程序的退出功能等。</p>
</li>
<li><p><code>void gc()</code>：请求系统进行垃圾回收。至于系统是否立刻回收，则取决于系统中垃圾回收算法的实现以及系统执行时的情况。</p>
</li>
<li><p><code>String getProperty(String key)</code>：获得系统中属性名为key的属性对应的值。系统中常见的属性名以及属性的作用如下：</p>
<ul>
<li><code>java.version</code>：Java运行时环境版本</li>
<li><code>java.home</code>：Java安装目录</li>
<li><code>os.name</code>：操作系统的名称</li>
<li><code>os.version</code>：操作系统的版本</li>
<li><code>user.name</code>：用户名称</li>
<li><code>user.home</code>：用户的主目录</li>
<li><code>user.dir</code>：用户的当前目录</li>
</ul>
<p>代码举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OtherClass</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span> </span>{<br>        System.out.println(<span class="hljs-string">"java的version:"</span> + System.getProperty(<span class="hljs-string">"java.version"</span>));<br>        System.out.println(<span class="hljs-string">"java的home:"</span> + System.getProperty(<span class="hljs-string">"java.home"</span>));<br>        System.out.println(<span class="hljs-string">"os的name:"</span> + System.getProperty(<span class="hljs-string">"os.name"</span>));<br>        System.out.println(<span class="hljs-string">"os的version:"</span> + System.getProperty(<span class="hljs-string">"os.version"</span>));<br>        System.out.println(<span class="hljs-string">"user的name:"</span> + System.getProperty(<span class="hljs-string">"user.name"</span>));<br>        System.out.println(<span class="hljs-string">"user的home:"</span> + System.getProperty(<span class="hljs-string">"user.home"</span>));<br>        System.out.println(<span class="hljs-string">"user的dir:"</span> + System.getProperty(<span class="hljs-string">"user.dir"</span>));<br>    }<br>}<br><span class="hljs-comment">/*以上代码输出结果为：</span><br><span class="hljs-comment">java的version:15.0.1</span><br><span class="hljs-comment">java的home:D:\JDK15</span><br><span class="hljs-comment">os的name:Windows 10</span><br><span class="hljs-comment">os的version:10.0</span><br><span class="hljs-comment">user的name:xxx</span><br><span class="hljs-comment">user的home:C:\Users\xxx</span><br><span class="hljs-comment">user的dir:D:\IntelliJ IDEA\Project\Java_shangguigu\JavaSenior\day04</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h1 id="三、Math类"><a href="#三、Math类" class="headerlink" title="三、Math类"></a>三、Math类</h1><p><code>java.lang.Math</code>类提供了一系列静态方法用于科学计算，其方法的参数和返回值类型一般为<code>double</code>型：</p>
<ul>
<li><code>abs</code>：绝对值</li>
<li><code>acos</code>/<code>asin</code>/<code>atan</code>/<code>cos</code>/<code>sin</code>/<code>tan</code>：三角函数</li>
<li><code>sqrt</code>：平方根</li>
<li><code>pow(double a, double b)</code>：求a的b次幂</li>
<li><code>log</code>：自然对数</li>
<li><code>exp</code>：e为底数</li>
<li><code>max(double a, double b)</code>：求a、b之间的最大值</li>
<li><code>min(double a, double b)</code>：求a、b之间的最小值</li>
<li><code>random()</code>：返回0.0到1.0之间的随机数</li>
<li><code>long round(double a)</code>：double型数据a转换为long型（四舍五入）</li>
<li><code>toDegrees(double angrad)</code>：弧度—&gt;角度</li>
<li><code>toRadians(double angdeg)</code>：角度—&gt;弧度</li>
</ul>
<h1 id="四、BigInteger与BigDecimal"><a href="#四、BigInteger与BigDecimal" class="headerlink" title="四、BigInteger与BigDecimal"></a>四、BigInteger与BigDecimal</h1><h2 id="1、BigInteger"><a href="#1、BigInteger" class="headerlink" title="1、BigInteger"></a>1、BigInteger</h2><p><code>Long</code>是<code>long</code>的包装类，最大值为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.042ex" height="2.843ex" style="vertical-align: -0.505ex;" viewBox="0 -1006.6 3031.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2^{63}-1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"></path>
<path stroke-width="1" id="E1-MJMAIN-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-32" x="0" y="0"></use>
<g transform="translate(500,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-36"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-33" x="500" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2212" x="1530" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="2531" y="0"></use>
</g>
</svg>，如果是再大的数，就需要使用<code>BigInteger</code>类。<code>java.math.BigInteger</code>表示<strong>不可变的任意精度的整数</strong>。<code>BigInteger</code>类用<code>int[]</code>来模拟非常大的整数，<code>BigInteger</code>类对象进行计算的时候只能使用实例方法。</p>
<p>构造器：</p>
<ul>
<li><code>BigInteger(String val)</code>：根据字符串构建BigInteger对象</li>
</ul>
<p>常用方法：</p>
<ul>
<li><code>public BigInteger abs()</code>：返回此BigInteger的绝对值的BigInteger。</li>
<li><code>BigInteger add(BigInteger val)</code>：返回其值为(this + val)的BigInteger</li>
<li><code>BigInteger subtract(BigInteger val)</code>：返回其值为(this-val)的BigInteger</li>
<li><code>BigInteger multiply(BigInteger val)</code>：返回其值为(this * val)的BigInteger</li>
<li><code>BigInteger divide(BigInteger val)</code>：返回其值为(this / val)的BigInteger。整数相除只保留整数部分。</li>
<li><code>BigInteger remainder(BigInteger val)</code>：返回其值为(this % val)的BigInteger。</li>
<li><code>BigInteger[] divideAndRemainder(BigInteger val)</code>：返回包含(this / val)后跟(this % val)的两个BigInteger的数组。</li>
<li><code>BigInteger pow(int exponent)</code>：返回其值为this的exponent次幂的BigInteger。</li>
</ul>
<p>BigInteger和基本数据类型转换：</p>
<ul>
<li>转换为<code>byte</code>：<code>byteValue()</code></li>
<li>转换为<code>short</code>：<code>shortValue()</code></li>
<li>转换为<code>int</code>：<code>intValue()</code></li>
<li>转换为<code>long</code>：<code>longValue()</code></li>
<li>转换为<code>float</code>：<code>floatValue()</code></li>
<li>转换为<code>double</code>：<code>doubleValue()</code></li>
</ul>
<blockquote>
<p>直接调用以上方法，如果超出范围，不会抛出异常，会导致结果不正确。</p>
<p>调用<code>xxxValueExact()</code>方法，转换超出范围时，会抛出<code>ArithmeticException</code>异常，以保证结果准确。</p>
</blockquote>
<h2 id="2、BigDecimal"><a href="#2、BigDecimal" class="headerlink" title="2、BigDecimal"></a>2、BigDecimal</h2><p><code>java.math.BigDecimal</code>表示一个任意大小且精度完全准确的浮点数，同样是不可变的。</p>
<p><code>BigDecimal</code>用<code>scale()</code>表示小数位数，小数末尾是0的时候也计算在内。如果调用<code>scale()</code>方法，返回值为负数，比如<code>-2</code>，表示这个数是整数，并且末尾有两个0。</p>
<p>构造器：</p>
<ul>
<li><code>public BigDecimal(double val)</code></li>
<li><code>public BigDecimal(String val)</code></li>
</ul>
<p>常用方法：</p>
<ul>
<li><code>public BigDecimal setScale(int newScale)</code>：设置当前BigDecimal的精度，如果比原始值低，根据指定的处理方式进行四舍五入或者直接截断。</li>
<li><code>public BigDecimal stripTrailingZeros()</code>：将一个BigDecimal格式化为一个相等的，但去掉了末尾0的BigDecimal</li>
<li><code>public BigDecimal add(BigDecimal augend)</code></li>
<li><code>public BigDecimal subtract(BigDecimal subtrahend)</code></li>
<li><code>public BigDecimal multiply(BigDecimal multiplicand)</code></li>
<li><code>public BigDecimal divide(BigDecimal divisor,int scale,int roundingMode)</code>：如果除不尽，会报<code>ArithmeticException</code>异常，此时必须指定精度以及如何截断。</li>
</ul>
<p>说明：</p>
<ol>
<li>通过源码可知，一个<code>BigDecimal</code>是通过一个<code>BigInteger</code>和一个<code>scale</code>来表示的，即<code>BigInteger</code>表示一个完整的整数，而<code>scale</code>表示小数位数。</li>
<li>比较两个<code>BigDecimal</code>数的大小，应该使用<code>compareTo()</code>方法，根据两个值的大小分别返回<code>-1</code>、<code>1</code>和<code>0</code>，分别表示小于、大于和等于。</li>
<li><code>compareTo()</code>比较的是两个数值的大小，而<code>equals()</code>方法不但要求两个<code>BigDecimal</code>的值相等，还要求它们的<code>scale()</code>相等：</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">BigDecimal d1 = <span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-string">"123.456"</span>);<br>BigDecimal d2 = <span class="hljs-keyword">new</span> BigDecimal(<span class="hljs-string">"123.45600"</span>);<br>System.out.println(d1.equals(d2)); <span class="hljs-comment">// false, 因为scale不同</span><br><br><span class="hljs-comment">// true,因为d2去除尾部0后scale变为2</span><br>System.out.println(d1.equals(d2.stripTrailingZeros()));<br>System.out.println(d1.compareTo(d2)); <span class="hljs-comment">// 0，表示相等</span><br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记12-泛型</title>
    <url>/2021/04/11/java-note-1201/</url>
    <content><![CDATA[<h1 id="一、泛型的引入"><a href="#一、泛型的引入" class="headerlink" title="一、泛型的引入"></a>一、泛型的引入</h1><p>JDK 5.0引入了<strong>泛型(Genetic)</strong>。JDK 5.0之前的集合容器类在声明阶段无法确定容器内存的什么类型数据，JDK 5.0中将元素类型设计为一个参数，这个类型参数就是泛型。例如<code>Collection&lt;E&gt;</code>、<code>List&lt;E&gt;</code>、<code>ArrayList&lt;E&gt;</code>中的<code>&lt;E&gt;</code>就是类型参数，即泛型。</p>
<p><strong>定义</strong>：泛型就是允许在定义类、接口时通过一个标识表示类中某个属性的类型或者是某个方法的返回值及参数类型。这个类型参数将在使用时（例如继承或实现这个接口、用这个类型声明变量、创建对象时）确定（即传入实际的类型参数，也称为类型实参）。</p>
<p>如果没有泛型，任何类型都可以添加到集合中，类型不安全，且读取出来的对象需要强制转换，可能会有<code>ClassCastException</code>异常。使用泛型可以在编译时就检查，只有指定类型才可以添加到集合中。</p>
<h1 id="二、在集合中使用泛型"><a href="#二、在集合中使用泛型" class="headerlink" title="二、在集合中使用泛型"></a>二、在集合中使用泛型</h1><p>集合接口或集合类在jdk5.0时都修改为带泛型的结构。</p>
<p>在实例化集合类时，可以指明具体的泛型类型。指明完以后，在集合类或接口中凡是定义类或接口时，内部结构（比如：方法、构造器、属性等）使用到类的泛型的位置，都指定为实例化的泛型类型。比如：<code>add(E e)</code>，实例化以后：<code>add(Integer e)</code></p>
<p>注意点：</p>
<ul>
<li><strong>泛型的类型必须是类，不能是基本数据类型。需要用到基本数据类型的位置，用包装类替换</strong>。</li>
<li>如果实例化时没有指明泛型的类型，默认类型为<code>java.lang.Object</code>类型。</li>
<li>以<code>List</code>为例，<code>List</code>实际上表示<strong>持有任何Object类型的原生List</strong>，而<code>List&lt;?&gt;</code>表示<strong>具有某种特定类型的非原生List，只是我们不知道哪种类型是什么</strong></li>
</ul>
<p>集合中使用泛型的例子：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenericTest</span> </span>{<br>    <span class="hljs-comment">//在集合中使用泛型,以ArrayList为例</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//指定泛型类型，只能添加Integer类型</span><br>        ArrayList&lt;Integer&gt; list =  <span class="hljs-keyword">new</span> ArrayList&lt;Integer&gt;();<br>        <span class="hljs-comment">//也可以写成以下形式，JDK 7.0新增的类型推断功能</span><br>        <span class="hljs-comment">//ArrayList&lt;Integer&gt; list =  new ArrayList&lt;&gt;();</span><br>        list.add(<span class="hljs-number">78</span>);<br>        list.add(<span class="hljs-number">87</span>);<br>        <span class="hljs-comment">//编译时，就会进行类型检查，保证数据的安全</span><br>        <span class="hljs-comment">//添加的类型不是Integer时，编译时就会报错</span><br>        <span class="hljs-comment">//list.add("Tom"); </span><br>        <br>        <span class="hljs-comment">//迭代器中使用泛型</span><br>    	Interator&lt;Integer&gt; iterator = list.iterator();<br>        <span class="hljs-keyword">while</span>(iterator.hasNext()){<br>            <span class="hljs-comment">//不需要判断类型，一定是Integer</span><br>            <span class="hljs-keyword">int</span> num = iterator.next();<br>            System.out.println(num);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>泛型的嵌套使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenericTest</span> </span>{<br>    <span class="hljs-comment">//在集合中使用泛型的情况：以HashMap为例</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>		<span class="hljs-comment">//Map&lt;String,Integer&gt; map = new HashMap&lt;String,Integer&gt;();</span><br>        <span class="hljs-comment">//类型推断</span><br>        Map&lt;String,Integer&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        map.put(<span class="hljs-string">"Tom"</span>,<span class="hljs-number">87</span>);<br>        map.put(<span class="hljs-string">"Jerry"</span>,<span class="hljs-number">87</span>);<br>        map.put(<span class="hljs-string">"Jack"</span>,<span class="hljs-number">67</span>);<br>        <br>        <span class="hljs-comment">//泛型的嵌套</span><br>        Set&lt;Map.Entry&lt;String,Integer&gt;&gt; entry = map.entrySet();<br>        Iterator&lt;Map.Entry&lt;String, Integer&gt;&gt; iterator = entry.iterator();<br>        <span class="hljs-keyword">while</span>(iterator.hasNext()){<br>            Map.Entry&lt;String, Integer&gt; e = iterator.next();<br>            String key = e.getKey();<br>            Integer value = e.getValue();<br>            System.out.println(key + <span class="hljs-string">"="</span> + value);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、自定义泛型结构"><a href="#三、自定义泛型结构" class="headerlink" title="三、自定义泛型结构"></a>三、自定义泛型结构</h1><p>可以在类、接口以及方法上使用泛型，分别为泛型类、泛型接口、泛型方法。</p>
<h2 id="1、泛型类与泛型接口"><a href="#1、泛型类与泛型接口" class="headerlink" title="1、泛型类与泛型接口"></a>1、泛型类与泛型接口</h2><ul>
<li><p>泛型类可以有多个参数，此时应将多个参数一起放在尖括号内，比如<code>class Test&lt;E1,E2,E3&gt;</code>。</p>
</li>
<li><p>泛型类的构造器不能有尖括号结构，和一般类的构造器一样。</p>
</li>
<li><p>类实例化以后，操作原来泛型位置的结构必须与指定的泛型类型一致。</p>
</li>
<li><p>泛型不同的引用不能相互赋值，比如<code>List&lt;Object&gt; list = new ArrayList&lt;String&gt;();</code>是错误的，提示无法类型转换。</p>
</li>
<li><p>泛型如果不指定，将被擦除，泛型对应的类型均按照<code>Object</code>处理，但不等价于<code>Object</code>。建议如果使用泛型就一直使用泛型，如果不使用就都不使用。泛型擦除后，编译不会进行类型检查。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//使用时：类似于Object，但不等同于Object</span><br>        ArrayList list = <span class="hljs-keyword">new</span> ArrayList();<br>        list.add(<span class="hljs-number">33</span>);<br>        test(list); <span class="hljs-comment">//泛型擦除，编译不会类型检查</span><br>        <br>        <span class="hljs-comment">//一旦指定Object，编译会类型检查，必须按照Object处理</span><br>        ArrayList&lt;Object&gt; list2 = <span class="hljs-keyword">new</span> ArrayList&lt;Object&gt;();<br>        <span class="hljs-comment">//test(list2); //会报错，类型必须相同</span><br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">(ArrayList&lt;Integer&gt; list)</span> </span>{ }<br>}<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>如果泛型结构是接口或抽象类，则不可创建泛型类的对象。</p>
</li>
<li><p>在类/接口上声明的泛型，在本类或本接口中即代表某种类型，可以作为<strong>非静态属性的类型</strong>、<strong>非静态方法的参数类型</strong>、<strong>非静态方法的返回值类型</strong>。但在<strong>静态方法中不能使用类的泛型</strong>，因为类的泛型是在实例化时指定的，静态方法不需要通过对象调用。</p>
</li>
<li><p><strong>异常类不能是泛型的</strong>，try-catch中不能用泛型。</p>
</li>
<li><p>不能实例化泛型，即不能<code>new E[]</code>，可以先声明<code>Object</code>类型的数组，然后强制转换：<code>E[] elements = (E[])new Object[capacity];</code>参考<code>ArrayList</code>源码中的声明<code>Object[] elementData;</code>，而非泛型参数类型数组。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Order</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Order</span><span class="hljs-params">()</span></span>{<br>        T[] arr = <span class="hljs-keyword">new</span> T[<span class="hljs-number">10</span>]; <span class="hljs-comment">//错误，编译不通过</span><br>        T[] arr = (T[]) <span class="hljs-keyword">new</span> Object[<span class="hljs-number">10</span>]; <span class="hljs-comment">//正确，编译通过</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>父类有泛型，子类可以选择<strong>指定泛型类型</strong>或者<strong>保留泛型</strong>：</p>
<ul>
<li>子类不保留父类的泛型：按需实现<ul>
<li>如果没有类型，则进行擦除</li>
<li>指定具体类型</li>
</ul>
</li>
<li>子类保留父类的泛型：泛型子类。泛型子类在实例化时可以指定泛型类型<ul>
<li>全部保留</li>
<li>部分保留</li>
</ul>
</li>
</ul>
<blockquote>
<p>结论：子类必须在保留或者指定二者之间做出选择。此外，子类除了指定或保留父类的泛型，还可以额外增加自己的泛型。</p>
</blockquote>
<p>比如下面的例子：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Father</span>&lt;<span class="hljs-title">T1</span>,<span class="hljs-title">T2</span>&gt;</span>{}<br><span class="hljs-comment">//子类不保留父类泛型</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Son1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Father</span></span>{} <span class="hljs-comment">//1.没有类型，擦除</span><br><span class="hljs-comment">//2.指定类具体类型。这时的Son2类不是泛型子类，只是个普通的类。</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Son2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Father</span>&lt;<span class="hljs-title">Integer</span>,<span class="hljs-title">String</span>&gt;</span>{} <br><br><span class="hljs-comment">//子类保留父类泛型</span><br><span class="hljs-comment">//Son3和Son4都是泛型子类，因为它们都有泛型</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Son3</span>&lt;<span class="hljs-title">T</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">Father</span>&lt;<span class="hljs-title">T1</span>,<span class="hljs-title">T2</span>&gt;</span>{} <span class="hljs-comment">//1.全部保留。子类可以有自己的泛型</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Son4</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Father</span>&lt;<span class="hljs-title">Integer</span>,<span class="hljs-title">T2</span>&gt;</span>{} <span class="hljs-comment">//2.部分保留</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="2、泛型方法"><a href="#2、泛型方法" class="headerlink" title="2、泛型方法"></a>2、泛型方法</h2><p>方法中也可以使用泛型，泛型方法中可以定义泛型参数，此时参数的类型就是传入数据的类型。</p>
<p>泛型方法的泛型与类的泛型无关，即泛型方法所在的类是不是泛型类没有关系。</p>
<p>只使用类的泛型的方法不是泛型方法。</p>
<p><strong>泛型方法可以是静态的</strong>，因为静态方法在调用的时候会指定泛型方法的类型参数。</p>
<p>泛型方法的格式：</p>
<p><code>权限符 &lt;泛型&gt; 返回类型 方法名（泛型 参数1，...）</code></p>
<p>比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>{<br>    <span class="hljs-comment">//返回值前面的&lt;E&gt;泛型必须要有。参数传入的泛型类型就是E的类型</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;E&gt; <span class="hljs-function">List&lt;E&gt; <span class="hljs-title">copyFromArrayToList</span><span class="hljs-params">(E[] arr)</span></span>{ <span class="hljs-comment">//泛型方法</span><br>        <span class="hljs-comment">//传入的String类型，此时方法中用到泛型的地方都是String类型</span><br>        ArrayList&lt;E&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(arr));<br>        System.out.println(list);<br>        <span class="hljs-keyword">return</span> list;<br>    }<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>        String[] a = <span class="hljs-keyword">new</span> String[]{<span class="hljs-string">"AA"</span>,<span class="hljs-string">"BB"</span>,<span class="hljs-string">"CC"</span>};<br>        copyFromArrayToList(a); <span class="hljs-comment">//传入的String类型</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、泛型在继承上的体现"><a href="#四、泛型在继承上的体现" class="headerlink" title="四、泛型在继承上的体现"></a>四、泛型在继承上的体现</h1><p>如果类<code>A</code>是类<code>B</code>的父类，那么<code>class &lt;A&gt;</code> 和<code>class &lt;B&gt;</code>二者不具备子父类关系，二者是并列关系。</p>
<p>比如<code>ArrayList&lt;Object&gt; list1</code>和<code>ArrayList&lt;String&gt; list2</code>，那么<code>list1 = list2</code>是错误的。</p>
<p>如果<code>A</code>是类<code>B</code>的父类，<code>A&lt;E&gt;</code>是 <code>B&lt;E&gt;</code>的父类。</p>
<p>举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenericTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        Object obj = <span class="hljs-keyword">null</span>;<br>        String str = <span class="hljs-keyword">null</span>;<br>        obj = str;  <span class="hljs-comment">//正确，String是Object的子类</span><br>        <br>        List&lt;Object&gt; list1 = <span class="hljs-keyword">null</span>;<br>        List&lt;String&gt; list2 = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;();<br>        <span class="hljs-comment">//此时的list1和list2的类型不具有子父类关系</span><br>        list1 = list2;  <span class="hljs-comment">//错误，编译不通过</span><br>        <span class="hljs-comment">/*反证法：</span><br><span class="hljs-comment">        假设list1 = list2正确</span><br><span class="hljs-comment">        那么list1.add(123)会导致混入非String的数据，出错。</span><br><span class="hljs-comment">         */</span><br>    }<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>        List&lt;String&gt; list1 = <span class="hljs-keyword">null</span>;<br>        ArrayList&lt;String&gt; list2 = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-comment">//ArrayList是List的实现类，可以赋值，但是必须保证泛型参数相同</span><br>        list1 = list2;  <br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、通配符"><a href="#五、通配符" class="headerlink" title="五、通配符"></a>五、通配符</h1><p>通配符<code>?</code>代表具体的类型参数，例如<code>List&lt;?&gt;</code>是<code>List&lt;String&gt;</code>、<code>List&lt;Object&gt;</code>等各种泛型<code>List</code>的父类。</p>
<p>假设现在有<code>List&lt;?&gt;</code>的一个对象<code>list</code>，那么可以安全<strong>读取</strong><code>list</code>中的元素，因为一定是<code>Object</code>类型的。不可以向<code>list</code>中<strong>写入</strong>元素，因为不知道<code>list</code>中元素的类型，但是可以写入<code>null</code>，其他都都不可以。</p>
<p>代码举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{<br>	<span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>        List&lt;Object&gt; list1 = <span class="hljs-keyword">null</span>;<br>        List&lt;String&gt; list2 = <span class="hljs-keyword">null</span>;<br>        List&lt;?&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(); <span class="hljs-comment">//list是list1和list2的父类</span><br>        <br>        list = list1;<span class="hljs-comment">//正确</span><br>        list = list2;<span class="hljs-comment">//正确</span><br><br>        <span class="hljs-comment">//添加(写入)：对于List&lt;?&gt;不能向其内部添加数据。</span><br>        <span class="hljs-comment">//除了添加null之外。</span><br>        list.add(<span class="hljs-string">"DD"</span>); <span class="hljs-comment">//错误</span><br>        list.add(<span class="hljs-keyword">null</span>); <span class="hljs-comment">//正确</span><br><br>        <span class="hljs-comment">//获取(读取)：允许读取数据，读取的数据类型为Object。</span><br>        Object o = list.get(<span class="hljs-number">0</span>); <span class="hljs-comment">//可以读取数据，类型是Object</span><br>        System.out.println(o);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>注意点：</p>
<ul>
<li><code>public static &lt;?&gt; void test(ArrayList&lt;?&gt; list){}</code>编译错误，不能用在泛型方法声明上，返回值类型前面<code>&lt;&gt;</code>不能使用<code>?</code>通配符。返回值必须是确定的类型。</li>
<li><code>class GenericTypeClass&lt;?&gt;{}</code>编译错误，<code>?</code>不能用在泛型类的声明上。</li>
<li><code>ArrayList&lt;?&gt; list2 = new ArrayList&lt;?&gt;();</code>编译错误，<code>?</code>不能用在创建对象上，右边属于创建集合对象，必须是确定的类型。</li>
</ul>
<p><strong>有限制的通配符</strong></p>
<ul>
<li><code>? extends A</code>：理解为&lt;=A类，类型限定了只能是A类或者是A类的子类。<ul>
<li><code>class&lt;? extends A&gt;</code>可以作为<code>class&lt;A&gt;</code>和<code>class&lt;B&gt;</code>的父类，其中B是A的子类</li>
</ul>
</li>
<li><code>? super A</code>：理解为&gt;=A类，类型限定了只能是A类或者是A类的父类。<ul>
<li><code>class&lt;? super A&gt;</code>可以作为<code>class&lt;A&gt;</code>和<code>class&lt;B&gt;</code>的父类，其中B是A的父类</li>
</ul>
</li>
<li>对于接口，<code>&lt;? extends Comparable&gt;</code>表示只允许泛型为实现<code>Comparable</code>接口的实现类的引用调用。</li>
</ul>
<p>使用举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenericTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span></span>{<br>        List&lt;? extends Person&gt; list1 = <span class="hljs-keyword">null</span>; <span class="hljs-comment">//只能是Person或Person的子类</span><br>        List&lt;? <span class="hljs-keyword">super</span> Person&gt; list2 = <span class="hljs-keyword">null</span>; <span class="hljs-comment">//只能是Person或Person的父类</span><br>        <br>        List&lt;Student&gt; list3 = <span class="hljs-keyword">new</span> ArrayList&lt;Student&gt;();<br>        List&lt;Person&gt; list4 = <span class="hljs-keyword">new</span> ArrayList&lt;Person&gt;(); <span class="hljs-comment">//Person是Student的父类</span><br>        List&lt;Object&gt; list5 = <span class="hljs-keyword">new</span> ArrayList&lt;Object&gt;();<br><br>        list1 = list3;	<span class="hljs-comment">//正确</span><br>        list1 = list4;  <span class="hljs-comment">//正确</span><br>        list1 = list5;  <span class="hljs-comment">//错误</span><br><br>        list2 = list3;  <span class="hljs-comment">//错误</span><br>        list2 = list4;	<span class="hljs-comment">//正确</span><br>        list2 = list5;	<span class="hljs-comment">//正确</span><br><br>        <span class="hljs-comment">//读取数据：</span><br>        list1 = list3;<br>        Person p = list1.get(<span class="hljs-number">0</span>); <span class="hljs-comment">//要用最大类型接收</span><br>        <span class="hljs-comment">//编译不通过，因为如果是Person类型，不能赋给Student引用</span><br>        <span class="hljs-comment">//Student s = list1.get(0);</span><br><br>        list2 = list4;<br>        Object obj = list2.get(<span class="hljs-number">0</span>); <span class="hljs-comment">//用Object类型接收</span><br>        <span class="hljs-comment">//编译不通过，因为如果是Person的父类，不能赋给Person引用</span><br>		<span class="hljs-comment">//Person obj = list2.get(0);</span><br><br>        <span class="hljs-comment">//写入数据：</span><br>        <span class="hljs-comment">//编译不通过，extends不能写</span><br>		<span class="hljs-comment">//list1.add(new Student()); </span><br><br>        <span class="hljs-comment">//编译通过</span><br>        <span class="hljs-comment">//super可以写</span><br>        list2.add(<span class="hljs-keyword">new</span> Person());<br>        list2.add(<span class="hljs-keyword">new</span> Student());<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>总结：</p>
<ul>
<li>使用<code>extends</code>通配符只能读，不能写(只能写<code>null</code>)，类似于<code>?</code>通配符。因为有上限，返回的任意类型都能够向上转型到确定的类型，但是不允许使用<code>set</code>方法传入引用(<code>null</code>除外)。</li>
<li>使用<code>super</code>通配符可以写，也可以读。写的时候可以安全地向上转型，读的时候，只能使用<code>Object</code>类型接收，因为<code>Object</code>是所有类的根父类，可以向上转型为<code>Object</code>。</li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Junit5与单元测试</title>
    <url>/2021/07/10/junit-5/</url>
    <content><![CDATA[<h1 id="一、JUnit5-介绍"><a href="#一、JUnit5-介绍" class="headerlink" title="一、JUnit5 介绍"></a>一、JUnit5 介绍</h1><h2 id="1-1-介绍"><a href="#1-1-介绍" class="headerlink" title="1.1 介绍"></a>1.1 介绍</h2><p>Junit5 = JUnit Platform + JUnit Jupiter + JUnit Vintage</p>
<p><strong>JUnit Platform</strong>：Junit Platform是在JVM上启动测试框架的基础，不仅支持Junit自制的测试引擎，其他测试引擎也都可以接入。</p>
<p><strong>JUnit Jupiter</strong>：JUnit Jupiter提供了JUnit5的新的编程模型，是JUnit5新特性的<strong>核心</strong>。内部包含了一个<strong>测试引擎</strong>，用于在Junit Platform上运行。</p>
<p><strong>JUnit Vintage</strong>：由于JUint已经发展多年，为了照顾老的项目，JUnit Vintage提供了兼容JUnit4.x,Junit3.x的测试引擎。</p>
<p>SpringBoot2.4以上版本移除了JUnit Vintage的依赖，如果需要兼容JUnit4，需要自行引入依赖。</p>
<h2 id="1-2-JUnit5常用注解"><a href="#1-2-JUnit5常用注解" class="headerlink" title="1.2 JUnit5常用注解"></a>1.2 JUnit5常用注解</h2><p>与JUnit4的差异：<a href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-annotations">Annotations</a></p>
<p>JUnit5的@Test：</p>
<figure class="highlight css"><table><tbody><tr><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.junit</span><span class="hljs-selector-class">.jupiter</span><span class="hljs-selector-class">.api</span><span class="hljs-selector-class">.Test</span>;<br></code></pre></td></tr></tbody></table></figure>
<p>JUnit4的@Test</p>
<figure class="highlight actionscript"><table><tbody><tr><td class="code"><pre><code class="hljs actionscript"><span class="hljs-meta"><span class="hljs-meta-keyword">import</span> org.junit.Test;</span><br></code></pre></td></tr></tbody></table></figure>
<p>SpringBoot中使用JUnit5，只需要在测试类上使用<code>@SpringBootTest</code>注解，使用这个注解以后，测试类就具有SpringBoot的功能，比如自动装配、事务功能等。包括<code>@Autowired</code>、<code>@Transactional</code>等。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//测试类使用@SpringBootTest标注</span><br><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Springboot05WebAdminApplicationTest</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    UserMapper userMapper;<br>    <br>    <span class="hljs-comment">//测试方法使用@Test标注</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">userMapperTest</span><span class="hljs-params">()</span></span>{<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>JUnit4中实现上述功能则需要@SpringBootTest+@RunWith(SpringRunner.class)</p>
</blockquote>
<ul>
<li><strong>@Test </strong>:表示方法是测试方法。但是与JUnit4的@Test不同，他的职责非常单一不能声明任何属性，拓展的测试将会由Jupiter提供额外测试</li>
<li><p><strong>@ParameterizedTest </strong>：表示方法是参数化测试</p>
</li>
<li><p><strong>@RepeatedTest </strong>：表示方法可重复执行</p>
</li>
<li><p><strong>@DisplayName</strong>：为测试类或者测试方法设置展示名称</p>
</li>
<li><p><strong>@BeforeEach </strong>：表示在每个单元测试之前执行</p>
</li>
<li><p><strong>@AfterEach </strong>：表示在每个单元测试之后执行</p>
</li>
<li><p><strong>@BeforeAll </strong>：表示在所有单元测试之前执行；测试方法必须是静态的，或者测试类标注了@TestInstance(Lifecycle.PER_CLASS)</p>
</li>
<li><p><strong>@AfterAll </strong>：表示在所有单元测试之后执行；测试方法必须是静态的，或者测试类标注了@TestInstance(Lifecycle.PER_CLASS)</p>
</li>
<li><p><strong>@Tag </strong>：表示单元测试类别，类似于JUnit4中的@Categories</p>
</li>
<li><p><strong>@Disabled </strong>：表示测试类或测试方法不执行，类似于JUnit4中的@Ignore</p>
</li>
<li><p><strong>@Timeout </strong>：表示测试方法运行如果超过了指定时间将会返回错误</p>
</li>
<li><strong>@ExtendWith</strong>：为测试类或测试方法提供扩展类引用</li>
</ul>
<h1 id="二、断言"><a href="#二、断言" class="headerlink" title="二、断言"></a>二、断言</h1><p>断言是测试方法中的核心，用来对测试需要满足的条件进行验证。</p>
<p>如果一个方法有多个断言，如果前边的断言失败，后边的代码都不能执行。</p>
<h2 id="2-1-简单断言"><a href="#2-1-简单断言" class="headerlink" title="2.1 简单断言"></a>2.1 简单断言</h2><p>用来对单个值进行简单的验证：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>assertEquals</td>
<td>判断两个对象或两个原始类型是否相等</td>
</tr>
<tr>
<td>assertNotEquals</td>
<td>判断两个对象或两个原始类型是否不相等</td>
</tr>
<tr>
<td>assertSame</td>
<td>判断两个对象引用是否指向同一个对象</td>
</tr>
<tr>
<td>assertNotSame</td>
<td>判断两个对象引用是否指向不同的对象</td>
</tr>
<tr>
<td>assertTrue</td>
<td>判断给定的布尔值是否为 true</td>
</tr>
<tr>
<td>assertFalse</td>
<td>判断给定的布尔值是否为 false</td>
</tr>
<tr>
<td>assertNull</td>
<td>判断给定的对象引用是否为 null</td>
</tr>
<tr>
<td>assertNotNull</td>
<td>判断给定的对象引用是否不为 null</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@DisplayName("simple assertion")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">simple</span><span class="hljs-params">()</span> </span>{<br>    assertEquals(<span class="hljs-number">3</span>, <span class="hljs-number">1</span> + <span class="hljs-number">2</span>, <span class="hljs-string">"simple math"</span>);<br>    assertNotEquals(<span class="hljs-number">3</span>, <span class="hljs-number">1</span> + <span class="hljs-number">1</span>);<br><br>    assertNotSame(<span class="hljs-keyword">new</span> Object(), <span class="hljs-keyword">new</span> Object());<br>    Object obj = <span class="hljs-keyword">new</span> Object();<br>    assertSame(obj, obj);<br><br>    assertFalse(<span class="hljs-number">1</span> &gt; <span class="hljs-number">2</span>);<br>    assertTrue(<span class="hljs-number">1</span> &lt; <span class="hljs-number">2</span>);<br><br>    assertNull(<span class="hljs-keyword">null</span>);<br>    assertNotNull(<span class="hljs-keyword">new</span> Object());<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-2-数组断言"><a href="#2-2-数组断言" class="headerlink" title="2.2 数组断言"></a>2.2 数组断言</h2><p>使用<code>assertArrayEquals</code>方法来判断两个对象或原始类型的数组是否相等：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@DisplayName("array assertion")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">array</span><span class="hljs-params">()</span> </span>{<br>    assertArrayEquals(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[]{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>}, <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[] {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>});<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-3-组合断言"><a href="#2-3-组合断言" class="headerlink" title="2.3 组合断言"></a>2.3 组合断言</h2><p><code>assertAll</code>方法接受多个<code>org.junit.jupiter.api.Executable</code>函数式接口的实例作为要验证的断言，可以通过 lambda表达式很容易的提供这些断言:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@DisplayName("assert all")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">all</span><span class="hljs-params">()</span> </span>{<br>    assertAll(<span class="hljs-string">"Math"</span>,<br>              () -&gt; assertEquals(<span class="hljs-number">2</span>, <span class="hljs-number">1</span> + <span class="hljs-number">1</span>),<br>              () -&gt; assertTrue(<span class="hljs-number">1</span> &gt; <span class="hljs-number">0</span>)<br>             );<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-4-异常断言"><a href="#2-4-异常断言" class="headerlink" title="2.4 异常断言"></a>2.4 异常断言</h2><p>JUnit5提供了一种新的异常断言方式<code>Assertions.assertThrows()</code>，配合函数式编程就可以进行使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@DisplayName("异常测试")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exceptionTest</span><span class="hljs-params">()</span> </span>{<br>    ArithmeticException exception = Assertions.assertThrows(<br>        <span class="hljs-comment">//扔出断言异常</span><br>        ArithmeticException.class, () -&gt; System.out.println(<span class="hljs-number">1</span> % <span class="hljs-number">0</span>));<br><br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-5-超时断言"><a href="#2-5-超时断言" class="headerlink" title="2.5 超时断言"></a>2.5 超时断言</h2><p>Junit5还提供了<code>Assertions.assertTimeout()</code> 为测试方法设置了超时时间</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@DisplayName("超时测试")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">timeoutTest</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-comment">//如果测试方法时间超过1s将会异常</span><br>    Assertions.assertTimeout(Duration.ofMillis(<span class="hljs-number">1000</span>), () -&gt; Thread.sleep(<span class="hljs-number">500</span>));<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-6-快速失败"><a href="#2-6-快速失败" class="headerlink" title="2.6 快速失败"></a>2.6 快速失败</h2><p>通过<code>fail</code>方法直接使得测试失败：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-meta">@DisplayName("fail")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">shouldFail</span><span class="hljs-params">()</span> </span>{<br>    fail(<span class="hljs-string">"This should fail"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、-前置条件"><a href="#三、-前置条件" class="headerlink" title="三、 前置条件"></a>三、 前置条件</h1><p>JUnit 5 中的前置条件（assumptions）类似于断言，不同之处在于<strong>不满足的断言会使得测试方法失败</strong>，而<strong>不满足的前置条件只会使得测试方法的执行终止</strong>。</p>
<p>前置条件可以看成是测试方法执行的前提，当该前提不满足时，就没有继续执行的必要。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DisplayName("前置条件")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AssumptionsTest</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String environment = <span class="hljs-string">"DEV"</span>;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-meta">@DisplayName("simple")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">simpleAssume</span><span class="hljs-params">()</span> </span>{<br>        assumeTrue(Objects.equals(<span class="hljs-keyword">this</span>.environment, <span class="hljs-string">"DEV"</span>));<br>        assumeFalse(() -&gt; Objects.equals(<span class="hljs-keyword">this</span>.environment, <span class="hljs-string">"PROD"</span>));<br>    }<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-meta">@DisplayName("assume then do")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">assumeThenDo</span><span class="hljs-params">()</span> </span>{<br>        assumingThat(<br>            Objects.equals(<span class="hljs-keyword">this</span>.environment, <span class="hljs-string">"DEV"</span>),<br>            () -&gt; System.out.println(<span class="hljs-string">"In DEV"</span>)<br>        );<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>assumeTrue</code>和<code>assumFalse</code>确保给定的条件为<code>true</code>或<code>false</code>，不满足条件会使得测试执行终止。</p>
<p><code>assumingThat</code>的参数是表示条件的布尔值和对应的<code>Executable</code>接口的实现对象。只有条件满足时，Executable 对象才会被执行；当条件不满足时，测试执行并不会终止。</p>
<h1 id="四、嵌套测试"><a href="#四、嵌套测试" class="headerlink" title="四、嵌套测试"></a>四、嵌套测试</h1><p>JUnit5可以通过 Java 中的内部类和<code>@Nested</code>注解实现嵌套测试</p>
<p>嵌套测试情况下，外层的Test不能驱动内层的<code>@BeforeEach</code>、<code>@AfterAll</code>之类的方法提前/之后运行。</p>
<p>而内层的Test可以驱动外层的<code>@BeforeEach</code>、<code>@AfterAll</code>之类的方法。也就是说各个层是从外向内运行的，Before、After之类的方法也只是在本层生效。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@DisplayName("A stack")</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestingAStackDemo</span> </span>{<br>    Stack&lt;Object&gt; stack;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-meta">@DisplayName("is instantiated with new Stack()")</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">isInstantiatedWithNew</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">new</span> Stack&lt;&gt;();<br>    }<br><br>    <span class="hljs-meta">@Nested</span><br>    <span class="hljs-meta">@DisplayName("when new")</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WhenNew</span> </span>{<br>        <span class="hljs-meta">@BeforeEach</span><br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">createNewStack</span><span class="hljs-params">()</span> </span>{<br>            stack = <span class="hljs-keyword">new</span> Stack&lt;&gt;();<br>        }<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-meta">@DisplayName("is empty")</span><br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">isEmpty</span><span class="hljs-params">()</span> </span>{<br>            assertTrue(stack.isEmpty());<br>        }<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-meta">@DisplayName("throws EmptyStackException when popped")</span><br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">throwsExceptionWhenPopped</span><span class="hljs-params">()</span> </span>{<br>            assertThrows(EmptyStackException.class, stack::pop);<br>        }<br><br>        <span class="hljs-meta">@Test</span><br>        <span class="hljs-meta">@DisplayName("throws EmptyStackException when peeked")</span><br>        <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">throwsExceptionWhenPeeked</span><span class="hljs-params">()</span> </span>{<br>            assertThrows(EmptyStackException.class, stack::peek);<br>        }<br><br>        <span class="hljs-meta">@Nested</span><br>        <span class="hljs-meta">@DisplayName("after pushing an element")</span><br>        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AfterPushing</span> </span>{<br><br>            String anElement = <span class="hljs-string">"an element"</span>;<br><br>            <span class="hljs-meta">@BeforeEach</span><br>            <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">pushAnElement</span><span class="hljs-params">()</span> </span>{<br>                stack.push(anElement);<br>            }<br><br>            <span class="hljs-meta">@Test</span><br>            <span class="hljs-meta">@DisplayName("it is no longer empty")</span><br>            <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">isNotEmpty</span><span class="hljs-params">()</span> </span>{<br>                assertFalse(stack.isEmpty());<br>            }<br><br>            <span class="hljs-meta">@Test</span><br>            <span class="hljs-meta">@DisplayName("returns the element when popped and is empty")</span><br>            <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">returnElementWhenPopped</span><span class="hljs-params">()</span> </span>{<br>                assertEquals(anElement, stack.pop());<br>                assertTrue(stack.isEmpty());<br>            }<br><br>            <span class="hljs-meta">@Test</span><br>            <span class="hljs-meta">@DisplayName("returns the element when peeked but remains not empty")</span><br>            <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">returnElementWhenPeeked</span><span class="hljs-params">()</span> </span>{<br>                assertEquals(anElement, stack.peek());<br>                assertFalse(stack.isEmpty());<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、参数化测试"><a href="#五、参数化测试" class="headerlink" title="五、参数化测试"></a>五、参数化测试</h1><p>参数化测试是JUnit5很重要的一个新特性，它使得用不同的参数多次运行测试成为了可能，也为我们的单元测试带来许多便利。</p>
<p>利用<code>@ValueSource</code>等注解，指定入参，我们将可以使用不同的参数进行多次单元测试，而不需要每新增一个参数就新增一个单元测试，省去了很多冗余代码。</p>
<p><strong>@ValueSource</strong>: 为参数化测试指定入参来源，支持八大基础类以及String类型,Class类型</p>
<p><strong>@NullSource</strong>: 表示为参数化测试提供一个null的入参</p>
<p><strong>@EnumSource</strong>: 表示为参数化测试提供一个枚举入参</p>
<p><strong>@CsvFileSource</strong>：表示读取指定CSV文件内容作为参数化测试入参</p>
<p><strong>@MethodSource</strong>：表示读取指定方法的返回值作为参数化测试入参(注意方法返回需要是一个流)</p>
<p>参数化测试可以<strong>支持外部的各类入参</strong>。如CSV、YML、JSON 文件甚至方法的返回值也可以作为入参。只需要去实现<code>ArgumentsProvider</code>接口，任何外部文件都可以作为它的入参。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ParameterizedTest</span><br><span class="hljs-meta">@ValueSource(strings = {"one", "two", "three"})</span><br><span class="hljs-meta">@DisplayName("参数化测试1")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parameterizedTest1</span><span class="hljs-params">(String string)</span> </span>{<br>    System.out.println(string);<br>    Assertions.assertTrue(StringUtils.isNotBlank(string));<br>}<br><br><br><span class="hljs-meta">@ParameterizedTest</span><br><span class="hljs-meta">@MethodSource("method")</span>    <span class="hljs-comment">//指定方法名</span><br><span class="hljs-meta">@DisplayName("方法来源参数")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testWithExplicitLocalMethodSource</span><span class="hljs-params">(String name)</span> </span>{<br>    System.out.println(name);<br>    Assertions.assertNotNull(name);<br>}<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> Stream&lt;String&gt; <span class="hljs-title">method</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-keyword">return</span> Stream.of(<span class="hljs-string">"apple"</span>, <span class="hljs-string">"banana"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、从JUnit4到JUnit5"><a href="#六、从JUnit4到JUnit5" class="headerlink" title="六、从JUnit4到JUnit5"></a>六、从JUnit4到JUnit5</h1><p>在进行迁移的时候需要注意如下的变化：</p>
<ul>
<li>注解在<code>org.junit.jupiter.api</code>包中，断言在<code>org.junit.jupiter.api.Assertions</code>类中，前置条件在 <code>org.junit.jupiter.api.Assumptions</code>类中。</li>
<li><p>把<code>@Before</code> 和<code>@After</code> 替换成<code>@BeforeEach</code> 和<code>@AfterEach</code>。</p>
</li>
<li><p>把<code>@BeforeClass</code> 和<code>@AfterClass</code> 替换成<code>@BeforeAll</code> 和<code>@AfterAll</code>。</p>
</li>
<li><p>把<code>@Ignore</code> 替换成<code>@Disabled</code>。</p>
</li>
<li><p>把<code>@Category</code>替换成<code>@Tag</code>。</p>
</li>
<li>把<code>@RunWith</code>、<code>@Rule</code> 和<code>@ClassRule</code> 替换成<code>@ExtendWith</code>。</li>
</ul>
<p>参考官方文档：<a href="https://junit.org/junit5/docs/current/user-guide/#migrating-from-junit4">Migrating from JUnit 4</a></p>
<hr>
<p>参考链接：<a href="https://www.yuque.com/atguigu/springboot/ksndgx">https://www.yuque.com/atguigu/springboot/ksndgx</a></p>
]]></content>
      <categories>
        <category>Tools</category>
      </categories>
      <tags>
        <tag>Junit5</tag>
      </tags>
  </entry>
  <entry>
    <title>Markdown简单教程</title>
    <url>/2020/10/25/markdown/</url>
    <content><![CDATA[<p><em>本文作为 Markdown基础语法教程，同时作为个人笔记 &amp;练习。使用 Typora工具，语法可能略有不同，以实际平台为准</em></p>
<h1 id="标题"><a href="#标题" class="headerlink" title="标题"></a>标题</h1><p>Markdown标题有两种格式</p>
<h2 id="使用-和-标记一级和二级标签"><a href="#使用-和-标记一级和二级标签" class="headerlink" title="使用 = 和 - 标记一级和二级标签"></a>使用 = 和 - 标记一级和二级标签</h2><p>语法如下：</p>
<figure class="highlight asciidoc"><table><tbody><tr><td class="code"><pre><code class="hljs asciidoc">一级标题<br>=====<br><br>二级标题<br>-----<br></code></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/markdown_1.png">
</div>



<h2 id="使用-号标记"><a href="#使用-号标记" class="headerlink" title="使用#号标记"></a>使用#号标记</h2><p>语法如下：</p>
<figure class="highlight clean"><table><tbody><tr><td class="code"><pre><code class="hljs clean"># 一级标题<br>## 二级标题<br>### 三级标题<br>#### 四级标题<br>##### 五级标题<br>###### 六级标题<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>注意：#号后面要加一个空格</p>
</blockquote>
<h1 id="段落"><a href="#段落" class="headerlink" title="段落"></a>段落</h1><p>换行：使用shift+enter键换行。</p>
<p>换段：Markdown的段落要求前后保留一个空行，Typora编辑器直接回车即可，或者先换行再加一个空行，表示更换段落。</p>
<blockquote>
<p>两个或以上的空格+shift+enter，实现段内强制换行（行尾有↓箭头）。</p>
</blockquote>
<h1 id="字体格式"><a href="#字体格式" class="headerlink" title="字体格式"></a>字体格式</h1><p>字体格式：</p>
<figure class="highlight maxima"><table><tbody><tr><td class="code"><pre><code class="hljs maxima">*斜体文本*<br><span class="hljs-symbol">_</span>斜体文本<span class="hljs-symbol">_</span><br>**粗体文本**<br><span class="hljs-symbol">__</span>粗体文本<span class="hljs-symbol">__</span><br>***粗斜体文本***<br>___粗斜体文本___<br></code></pre></td></tr></tbody></table></figure>
<p>显示效果如下：<br><em>斜体文本</em><br><em>斜体文本</em><br><strong>粗体文本</strong><br><strong>粗体文本</strong><br><strong><em>粗斜体文本</em></strong><br><strong><em>粗斜体文本</em></strong></p>
<h1 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h1><p>Markdown支持无序列表和有序列表。</p>
<h2 id="无序列表："><a href="#无序列表：" class="headerlink" title="无序列表："></a>无序列表：</h2><p>无序列表有三种写法，<code>+</code> 或<code>-</code>或<code>*</code>后加空格即可：</p>
<figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">+</span> 第一项<br><span class="hljs-bullet">*</span> 第一项<br><span class="hljs-bullet">-</span> 第一项<br></code></pre></td></tr></tbody></table></figure>
<p>显示效果：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/markdown_2.png">
</div>



<h2 id="有序列表"><a href="#有序列表" class="headerlink" title="有序列表"></a>有序列表</h2><p>有序列表使用数字和<code>.</code>再加上空格即可：</p>
<figure class="highlight angelscript"><table><tbody><tr><td class="code"><pre><code class="hljs angelscript"><span class="hljs-number">1.</span> 第一项<br><span class="hljs-number">2.</span> 第二项<br><span class="hljs-number">3.</span> 第三项<br></code></pre></td></tr></tbody></table></figure>
<p>显示效果：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/markdown_3.png">
</div>



<h2 id="列表嵌套"><a href="#列表嵌套" class="headerlink" title="列表嵌套"></a>列表嵌套</h2><p>列表嵌套需要在子列表选项前加四个空格：</p>
<figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 第一项：<br><span class="hljs-bullet">    -</span> 第一项的第一个元素<br><span class="hljs-bullet">    -</span> 第一项的第二个元素<br><span class="hljs-bullet">2.</span> 第二项：<br><span class="hljs-bullet">    -</span> 第二项的第一个元素<br><span class="hljs-bullet">    -</span> 第二项的第二个元素<br></code></pre></td></tr></tbody></table></figure>
<p>显示效果：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/markdown_4.png">
</div>



<blockquote>
<p>Typora中，子列表选项前不加空格也可以。</p>
</blockquote>
<h1 id="插入区块和分隔线"><a href="#插入区块和分隔线" class="headerlink" title="插入区块和分隔线"></a>插入区块和分隔线</h1><h2 id="区块"><a href="#区块" class="headerlink" title="区块"></a>区块</h2><p>Markdown的区块引用是在段落开头使用<code>&gt;</code> 号和空格：</p>
<figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><code class="hljs markdown"><span class="hljs-quote">&gt; 区块引用</span><br></code></pre></td></tr></tbody></table></figure>
<p>显示效果：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/markdown_5.png">
</div>


<p>另外，区块引用也可以像列表一样嵌套，一个<code>&gt;</code> 表示第一层，两个<code>&gt;</code> 表示第二层，以此类推：</p>
<figure class="highlight ruby"><table><tbody><tr><td class="code"><pre><code class="hljs ruby">&gt; 第一层<br><span class="hljs-meta">&gt;&gt;</span> 第二层<br><span class="hljs-meta">&gt;&gt;</span>&gt; 第三层<br></code></pre></td></tr></tbody></table></figure>
<p>区块中也可以使用列表，同样，列表中也可以使用区块。</p>
<h2 id="分隔线"><a href="#分隔线" class="headerlink" title="分隔线"></a>分隔线</h2><p>在一个空行中，使用三个或以上的<code>*</code>、<code>+</code>、<code>-</code>、<code>_</code>来创建分隔线：</p>
<figure class="highlight asciidoc"><table><tbody><tr><td class="code"><pre><code class="hljs asciidoc">**<span class="hljs-strong">*</span><br><span class="hljs-strong">++++</span><br><span class="hljs-strong">-----</span><br><span class="hljs-strong">______</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="插入代码"><a href="#插入代码" class="headerlink" title="插入代码"></a>插入代码</h1><h2 id="句中代码"><a href="#句中代码" class="headerlink" title="句中代码"></a>句中代码</h2><p>如果是句中的代码片段或函数，只需要一对反引号<code>` </code>即可 (位于Tab键上面):</p>
<figure class="highlight autohotkey"><table><tbody><tr><td class="code"><pre><code class="hljs autohotkey">`printf()`函数<br></code></pre></td></tr></tbody></table></figure>
<p>显示效果：</p>
<p><code>pringf()</code>函数</p>
<h2 id="代码块"><a href="#代码块" class="headerlink" title="代码块"></a>代码块</h2><p>代码块需要两个以上反引号，可以指定语言，以下为python语言的代码块：</p>
<figure class="highlight isbl"><table><tbody><tr><td class="code"><pre><code class="hljs isbl">​```<br><span class="hljs-variable">def</span> <span class="hljs-function"><span class="hljs-title">main</span>():</span><br><span class="hljs-function">	<span class="hljs-title">print</span>(<span class="hljs-string">'hello world'</span>)</span><br>​```<br></code></pre></td></tr></tbody></table></figure>
<p>显示效果：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span>():</span><br>	print(<span class="hljs-string">'hello world'</span>)<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>还可以使用缩进式方法，使用四个空格或者一个制表符(Tab键)，一段代码会持续到没有缩进的那一行</p>
</blockquote>
<h1 id="插入链接和图片"><a href="#插入链接和图片" class="headerlink" title="插入链接和图片"></a>插入链接和图片</h1><h2 id="插入链接"><a href="#插入链接" class="headerlink" title="插入链接"></a>插入链接</h2><p>插入链接有两种方法：</p>
<figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><code class="hljs markdown">[<span class="hljs-string">链接名称</span>](<span class="hljs-link">链接地址</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>或者：</p>
<figure class="highlight apache"><table><tbody><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-section">&lt;链接地址&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>例如：<br>方法一：<a href="https://github.com/">github</a><br>方法二：<a href="https://github.com/">https://github.com/</a></p>
<h2 id="插入图片"><a href="#插入图片" class="headerlink" title="插入图片"></a>插入图片</h2><p>插入图片的方法与插入链接的方法区别在于，插入图片的语法前加<code>!</code>号：</p>
<figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><code class="hljs markdown">![<span class="hljs-string">属性名称</span>](<span class="hljs-link">图片地址</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>还可以使用<img>标签，用来指定图片大小：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><code class="hljs routeros">&lt;img <span class="hljs-attribute">src</span>=<span class="hljs-string">"图片地址"</span> <span class="hljs-attribute">width</span>=<span class="hljs-string">"80%"</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>Markdown需要以链接的形式插入图片，如果md文件发布到网站，则链接可能会失效，所以建议使用图床保存图片，这样无论md文件在哪里，只要链接不失效，就可以看到图片。</p>
</blockquote>
<h2 id="高级链接"><a href="#高级链接" class="headerlink" title="高级链接"></a>高级链接</h2><p>可以通过变量来设置一个链接，在文档末尾为变量赋值：</p>
<figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><code class="hljs markdown">网址链接[<span class="hljs-string">链接名称</span>][<span class="hljs-symbol">1</span>]<br>插入图片![][2]<br>[<span class="hljs-symbol">1</span>]:<span class="hljs-link">https://github.com/</span><br>[<span class="hljs-symbol">2</span>]:<span class="hljs-link">https://www.google.com.hk/images/branding/googlelogo/1x/googlelogo_color_272x92dp.png</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="插入表格"><a href="#插入表格" class="headerlink" title="插入表格"></a>插入表格</h1><p>Markdown制作表格使用<code>|</code> 来分隔不同的单元格，使用<code>-</code>分隔表头和其他行，代码如下：</p>
<figure class="highlight gherkin"><table><tbody><tr><td class="code"><pre><code class="hljs gherkin">|<span class="hljs-string"> 表头 </span>|<span class="hljs-string"> 表头</span>|<br>|<span class="hljs-string"> --- </span>|<span class="hljs-string"> ---</span>|<br>|<span class="hljs-string">单元格</span>|<span class="hljs-string">单元格</span>|<br>|<span class="hljs-string">单元格</span>|<span class="hljs-string">单元格</span>|<br></code></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>表头</th>
<th>表头</th>
</tr>
</thead>
<tbody>
<tr>
<td>单元格</td>
<td>单元格</td>
</tr>
<tr>
<td>单元格</td>
<td>单元格</td>
</tr>
</tbody>
</table>
</div>
<p><strong>对齐方式</strong> ：</p>
<ul>
<li><code>-:</code>设置内容和标题栏居右对齐</li>
<li><code>:-</code>设置内容和标题栏居左对齐</li>
<li><code>:-:</code>设置内容和标题栏居中对齐</li>
</ul>
<p>代码如下：</p>
<figure class="highlight gherkin"><table><tbody><tr><td class="code"><pre><code class="hljs gherkin">|<span class="hljs-string">左对齐</span>|<span class="hljs-string">右对齐</span>|<span class="hljs-string">居中对齐</span>|<br>|<span class="hljs-string">：---</span>|<span class="hljs-string">---：</span>|<span class="hljs-string">：----：</span>|<br>|<span class="hljs-string">单元格</span>|<span class="hljs-string">单元格</span>|<span class="hljs-string">单元格</span>|<br>|<span class="hljs-string">单元格</span>|<span class="hljs-string">单元格</span>|<span class="hljs-string">单元格</span>|<br></code></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">左对齐</th>
<th style="text-align:right">右对齐</th>
<th style="text-align:center">居中对齐</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">单元格</td>
<td style="text-align:right">单元格</td>
<td style="text-align:center">单元格</td>
</tr>
<tr>
<td style="text-align:left">单元格</td>
<td style="text-align:right">单元格</td>
<td style="text-align:center">单元格</td>
</tr>
</tbody>
</table>
</div>
<h1 id="HTML元素"><a href="#HTML元素" class="headerlink" title="HTML元素"></a>HTML元素</h1><p>Markdown支持部分html标签，比如：<code>&lt;kbd&gt;</code>、<code>&lt;b&gt;</code>、<code>&lt;i&gt;</code>、<code>&lt;em&gt;</code>、<code>&lt;sup&gt;</code>、<code>&lt;sub&gt;</code>、<code>&lt;br&gt;</code>，以及<code>&lt;fond&gt;</code>等html标签：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">使用 <span class="hljs-tag">&lt;<span class="hljs-name">kbd</span>&gt;</span>Ctrl<span class="hljs-tag">&lt;/<span class="hljs-name">kbd</span>&gt;</span>+<span class="hljs-tag">&lt;<span class="hljs-name">kbd</span>&gt;</span>c<span class="hljs-tag">&lt;/<span class="hljs-name">kbd</span>&gt;</span> 复制<br><span class="hljs-tag">&lt;<span class="hljs-name">font</span> <span class="hljs-attr">color</span>=<span class="hljs-string">"red"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">5</span>&gt;</span>我是红色字体,大小为<span class="hljs-tag">&lt;/<span class="hljs-name">font</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<p>使用 <kbd>Ctrl</kbd>+<kbd>c</kbd> 复制</p>
<font color="red" size="5">
我是红色字体,大小为5</font>

<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="页内跳转"><a href="#页内跳转" class="headerlink" title="页内跳转"></a>页内跳转</h2><p>使用<strong>页内跳转</strong>可以用来进行引用等功能的快速跳转。</p>
<p>具体实现方法：</p>
<ol>
<li>定义锚点(id)：在跳转到的目标处添加<code>&lt;span&gt;</code>标签或者<code>&lt;div&gt;</code>标签，比如<code>&lt;span id="refer-1"&gt;参考链接1&lt;/span&gt;</code></li>
<li>使用Markdown语法：在想要跳转的地点，使用<code>[点击跳转](#refer-1)</code>语句，如果想要“点击跳转”内容是上标的形式，可以将其放到<code>&lt;sup&gt;</code>标签中，即<code>[&lt;sup&gt;点击跳转&lt;/sup&gt;](#refer-1)</code></li>
</ol>
<h2 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h2><p>使用<code>\</code>符号转移特殊字符：</p>
<figure class="highlight taggerscript"><table><tbody><tr><td class="code"><pre><code class="hljs taggerscript">**文本加粗**<br><span class="hljs-symbol">\*</span><span class="hljs-symbol">\*</span>正常显示星号<span class="hljs-symbol">\*</span><span class="hljs-symbol">\*</span><br></code></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<p><strong>文本加粗</strong><br>**正常显示星号**</p>
<h2 id="插入公式"><a href="#插入公式" class="headerlink" title="插入公式"></a>插入公式</h2><p>使用两个美元符号$$$$将TeX或LaTeX格式的数字公式包裹，即可插入公式：</p>
<blockquote>
<p>更多Markdown公式表示方法参考：<a href="https://ericp.cn/cmd">Cmd Markdown公式指导手册</a></p>
</blockquote>
<figure class="highlight gams"><table><tbody><tr><td class="code"><pre><code class="hljs gams"><span class="hljs-symbol">$</span><br>\<span class="hljs-built_in">sqrt</span>{ {x^<span class="hljs-number">2</span>}+{y^<span class="hljs-number">2</span>} }+v_1+v_2<br><span class="hljs-symbol">$</span><br></code></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<p><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="19.807ex" height="4.843ex" style="vertical-align: -1.671ex;" viewBox="0 -1365.4 8528.1 2085" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\sqrt{ {x^2}+{y^2} }+v_1+v_2</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJSZ2-221A" d="M1001 1150Q1017 1150 1020 1132Q1020 1127 741 244L460 -643Q453 -650 436 -650H424Q423 -647 423 -645T421 -640T419 -631T415 -617T408 -594T399 -560T385 -512T367 -448T343 -364T312 -259L203 119L138 41L111 67L212 188L264 248L472 -474L983 1140Q988 1150 1001 1150Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJSZ2-221A" x="0" y="65"></use>
<rect stroke="none" width="3202" height="60" x="1000" y="1156"></rect>
<g transform="translate(1000,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="809" y="583"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1248" y="0"></use>
<g transform="translate(2249,0)">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="706" y="583"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-2B" x="4425" y="0"></use>
<g transform="translate(5426,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2B" x="6587" y="0"></use>
<g transform="translate(7588,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="686" y="-213"></use>
</g>
</g>
</svg></p>
<h2 id="插入流程图"><a href="#插入流程图" class="headerlink" title="插入流程图"></a>插入流程图</h2><p>Typora插入横向流程图：</p>
<figure class="highlight coq"><table><tbody><tr><td class="code"><pre><code class="hljs coq">​```mermaid<br>graph LR<br>A[方形] --&gt;B(圆角)<br>    B --&gt; C{条件a}<br>    C --&gt;|<span class="hljs-type">a</span>=<span class="hljs-number">1</span>| <span class="hljs-type">D</span>[结果<span class="hljs-number">1</span>]<br>    C --&gt;|<span class="hljs-type">a</span>=<span class="hljs-number">2</span>| <span class="hljs-type">E</span>[结果<span class="hljs-number">2</span>]<br>    F[横向流程图]<br>​```<br></code></pre></td></tr></tbody></table></figure>
<p>效果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/markdown_6.png"><span class="image-caption">6</span></p>
<blockquote>
<p>更多类型的流程图、顺序图等可以参考：<a href="https://jingyan.baidu.com/article/48b558e3035d9a7f38c09aeb.html">typora画流程图、时序图(顺序图)、甘特图</a></p>
</blockquote>
<hr>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><blockquote>
<ul>
<li><a href="https://www.jianshu.com/p/335db5716248">最完整的Markdown教程-简书</a></li>
<li><a href="https://www.runoob.com/markdown/md-tutorial.html">Markdown教程|菜鸟教程</a></li>
</ul>
</blockquote>
]]></content>
      <categories>
        <category>教程</category>
      </categories>
      <tags>
        <tag>Markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM-不同JDK版本中方法区的演变</title>
    <url>/2021/05/09/method-area-evolution/</url>
    <content><![CDATA[<h1 id="1、方法区的演变"><a href="#1、方法区的演变" class="headerlink" title="1、方法区的演变"></a>1、方法区的演变</h1><p>方法区（Method Area）存放的内容为：类型信息、常量、静态变量、即时编译器编译后的代码缓存、域信息、方法信息等。</p>
<p>HotSpot虚拟机中，<strong>方法区(Method Area)</strong>在JDK8中经历了重要的变化。</p>
<p>JDK 8之前，HotSpot虚拟机中，<strong>使用永久代实现方法区</strong>，永久代与方法区的概念并不等价，永久代只是方法区的实现而已。</p>
<p>方法区只是逻辑上的分区概念，真正实现方式是永久代或元空间。</p>
<p>从JDK6版本有了移除永久代的计划，直到JDK 8版本，永久代被彻底移除，取而代之的是<strong>元空间（Meta-space）</strong>，具体演变过程如下（参考《深入理解Java虚拟机 第三版》P46；JVM<strong><a href="https://www.bilibili.com/video/BV1PJ411n7xZ?p=97">教程</a></strong>）：</p>
<ul>
<li><p>JDK 6版本及之前，使用永久代实现方法区，此时的永久代，或者说方法区，使用的是JVM内存。</p>
</li>
<li><p>JDK 7版本，把原本在永久代的<strong>字符串常量池</strong>、<strong>静态变量</strong>等移出到了<strong>堆</strong>中，永久代仍然使用JVM内存。</p>
<blockquote>
<p>静态变量仅是指的引用名（变量本身），只是引用名的位置发生了改变，new出来的对象实体，一直是保存在堆中。参考《深入理解Java虚拟机》P152的案例。</p>
</blockquote>
</li>
<li><p>JDK 8版本，将永久代中剩余的内容，包括类型信息、字段、方法、常量等，移出到了<strong>元空间</strong>中。彻底废弃了永久代的概念。元空间使用的是<strong>本地内存（Native Memory）</strong>。注意，JDK8中仍然有方法区的概念，不过是实现方法变成了本地内存的元空间。</p>
</li>
</ul>
<p>如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/method-area-evolution_1.jpg"></p>
<h1 id="2、为什么要废弃永久代"><a href="#2、为什么要废弃永久代" class="headerlink" title="2、为什么要废弃永久代"></a>2、为什么要废弃永久代</h1><p>关于为什么要废弃永久代，使用本地内存的元空间代替，官方解释原因参考(<a href="http://openjdk.java.net/jeps/122">来源</a>)：</p>
<p><strong>Motivation</strong></p>
<p>This is part of the JRockit and Hotspot convergence effort. JRockit customers do not need to configure the permanent generation (since JRockit does not have a permanent generation) and are accustomed to not configuring the permanent generation.</p>
<p>上述内容简单来说，是因为Oracle官方想要将JRockit虚拟机的优秀功能移植到HotSpot虚拟机中，而JRockit虚拟机不存在永久代的概念，为了保持一致，将HotSpot虚拟机中的永久代移除。</p>
<p>这种说法并未从深层次解释原因，关于为什么不使用永久代的原因，需要从永久代本身的一些特点来解释：</p>
<ul>
<li><p><strong>为永久代设置空间大小是很难确定的</strong>。某些场景下，如果动态加载类过多，容易产生永久代(Perm)的OOM问题。因为永久代有<code>-XX:MaxPermSize</code>参数，限制了永久代的上限空间，32位系统默认大小是4GB。而JRockit虚拟机没有这种限制，只要不超过线程可用本地内存上限，就不会有问题。<strong>元空间不在虚拟机中，而是使用本地内存，默认情况下只受本地内存大小限制</strong>。</p>
<blockquote>
<p>HotSpot虚拟机中的永久代，设计初衷是将收集器的分代机制扩展至方法区，即使用永久代实现方法区，方便垃圾收集器能够像管理Java堆一样管理这部分内存，省去专门为方法区编写内存管理代码的工作。现在回头看来，这种做法并不是好主意。</p>
</blockquote>
</li>
<li><p><strong>对永久代的调优很困难</strong>。对方法区的垃圾回收，涉及到常量池回收和<strong>类型的卸载</strong>（类的回收）等，类型回收的条件相当苛刻，比较消耗时间。</p>
</li>
</ul>
<h1 id="3、为什么要移动字符串常量池"><a href="#3、为什么要移动字符串常量池" class="headerlink" title="3、为什么要移动字符串常量池"></a>3、为什么要移动字符串常量池</h1><p>JDK 7中将String Table（字符串常量池）放到了堆空间中。因为永久代的回收效率很低，在full GC时才会回收永久代。而full GC在老年代空间不足、永久代空间不足时才会触发，这就导致StringTable的回收效率并不高。开发中会有大量的字符串被创建，如果回收效率低，会导致永久代内存不足。放到堆里面，能及时回收内存。</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>JVM</tag>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx安装与配置</title>
    <url>/2021/10/09/nginx/</url>
    <content><![CDATA[<h1 id="一、安装Nginx"><a href="#一、安装Nginx" class="headerlink" title="一、安装Nginx"></a>一、安装Nginx</h1><p><strong>环境：</strong></p>
<ul>
<li>CentOS 7.9</li>
<li>Nginx 8.45</li>
</ul>
<p><strong>安装步骤：</strong></p>
<p>1、<strong>首先需要确保系统已经安装了编译工具和库文件，可以使用<code>yum</code>命令安装</strong>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 安装 make、zlib、zlib-devel、gcc-c++、libtool、openssl、openssl-devel</span><br>yum -y install make zlib zlib-devel gcc-c++ libtool openssl openssl-devel<br></code></pre></td></tr></tbody></table></figure>
<p>2、<strong>需要PCRE的支持</strong></p>
<p>Nginx的安装需要PCRE的支持，PCRE的作用是让Nginx支持Rewrite功能。安装PCRE的步骤如下：</p>
<ul>
<li><p>可以手动去<a href="https://sourceforge.net/projects/pcre/files/pcre/">官网</a>下载安装包，或者使用<code>wget</code>命令下载：</p>
<p>首先进入<code>/usr/src/</code>目录，将pcre下载到这个目录</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost /]<span class="hljs-comment"># cd /usr/src/  </span><br>[root@localhost src]<span class="hljs-comment"># wget https://sourceforge.net/projects/pcre/files/pcre/8.45/pcre-8.45.tar.gz/download</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>解压文件</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost src]<span class="hljs-comment"># tar -zxvf download</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>解压后进入安装包目录</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost src]<span class="hljs-comment"># cd pcre-8.45/</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>执行<code>configure</code>文件，编译并安装</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost pcre-8.45]<span class="hljs-comment"># ./configure</span><br>[root@localhost pcre-8.45]<span class="hljs-comment"># make &amp;&amp; make install</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>查看版本号，安装成功</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost pcre-8.45]<span class="hljs-comment"># pcre-config --version</span><br>8.45<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>3、<strong>安装Nginx</strong></p>
<p>手动下载，或者使用<code>wget</code>下载安装包。</p>
<p>同样在<code>/usr/src/</code>目录下下载安装包：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost src]<span class="hljs-comment"># ls</span><br>debug  kernels  nginx-1.20.1.tar.gz  pcre-8.45<br></code></pre></td></tr></tbody></table></figure>
<p>然后解压：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost src]<span class="hljs-comment"># tar -zxvf nginx-1.20.1.tar.gz</span><br></code></pre></td></tr></tbody></table></figure>
<p>解压完后，进入<code>nginx-1.20.1</code>文件夹中，执行<code>configure</code>文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost nginx-1.20.1]<span class="hljs-comment"># ./configure</span><br></code></pre></td></tr></tbody></table></figure>
<p>编译并安装：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost nginx-1.20.1]<span class="hljs-comment"># make &amp;&amp; make install</span><br></code></pre></td></tr></tbody></table></figure>
<p>安装完成后，在<code>/usr/local/</code>目录会生成<code>nginx</code>的安装包：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost <span class="hljs-built_in">local</span>]<span class="hljs-comment"># ls</span><br>bin  etc  games  include  lib  lib64  libexec  mysql  nginx  redis  sbin  share  src<br></code></pre></td></tr></tbody></table></figure>
<p>4、<strong>启动并测试Nginx</strong></p>
<p>在<code>/usr/local/nginx/sbin</code>目录下就包括了Nginx的启动脚本。直接执行脚本即可启动Nginx服务：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost sbin]<span class="hljs-comment"># ./nginx</span><br></code></pre></td></tr></tbody></table></figure>
<p>在<code>/usr/local/nginx/conf/</code>目录下包括了各种配置文件，其中<code>nginx.conf</code>为nginx的配置文件，里面配置了Nginx的默认监听端口为<code>80</code>，我们可以使用<code>curl</code>命令访问测试：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost conf]<span class="hljs-comment"># curl localhost:80</span><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br>&lt;style&gt;<br>    body {<br>        width: 35em;<br>        margin: 0 auto;<br>        font-family: Tahoma, Verdana, Arial, sans-serif;<br>    }<br>&lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br>&lt;p&gt;If you see this page, the nginx web server is successfully installed and<br>working. Further configuration is required.&lt;/p&gt;<br><br>&lt;p&gt;For online documentation and support please refer to<br>&lt;a href=<span class="hljs-string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;<br>Commercial support is available at<br>&lt;a href=<span class="hljs-string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;<br><br>&lt;p&gt;&lt;em&gt;Thank you <span class="hljs-keyword">for</span> using nginx.&lt;/em&gt;&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，返回了html页面的内容，说明安装成功，并能够连接到Nginx。</p>
<p>5、<strong>修改端口号</strong></p>
<p>默认情况下，由于防火墙限制，外界是无法直接访问Linux中Nginx的，有两个解决方法：</p>
<ul>
<li><p>关闭Linux的防火墙。</p>
</li>
<li><p>开放访问的端口号，不需要关闭防火墙。</p>
<ul>
<li><p>查看开放的端口号：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">firewall-cmd --list-all<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>设置要开放的端口号：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 将80端口开放，并使其永久生效</span><br>firewall-cmd --add-port=80/tcp --permanent<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>重启防火墙即可生效。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">firewall-cmd --reload<br></code></pre></td></tr></tbody></table></figure>
<p>或者使用：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">systemctl restart firewalld.service<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>这样，即使不关闭防火墙，外界也能通过地址访问到Nginx。</p>
</li>
</ul>
<h1 id="二、常用命令"><a href="#二、常用命令" class="headerlink" title="二、常用命令"></a>二、常用命令</h1><p>如果不配置环境变量，则使用Nginx命令需要在按照目录下面的<code>sbin/</code>目录中使用，即<code>/usr/local/nginx/sbin/</code>目录里面。</p>
<p>1、查看Nginx的版本号：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost sbin]<span class="hljs-comment"># ./nginx -v</span><br>nginx version: nginx/1.20.1<br></code></pre></td></tr></tbody></table></figure>
<p>2、查看帮助：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost sbin]<span class="hljs-comment"># ./nginx -h</span><br>nginx version: nginx/1.20.1<br>Usage: nginx [-?hvVtTq] [-s signal] [-p prefix]<br>             [-e filename] [-c filename] [-g directives]<br><br>Options:<br>  -?,-h         : this <span class="hljs-built_in">help</span><br>  -v            : show version and <span class="hljs-built_in">exit</span><br>  -V            : show version and configure options <span class="hljs-keyword">then</span> <span class="hljs-built_in">exit</span><br>  -t            : <span class="hljs-built_in">test</span> configuration and <span class="hljs-built_in">exit</span><br>  -T            : <span class="hljs-built_in">test</span> configuration, dump it and <span class="hljs-built_in">exit</span><br>  -q            : suppress non-error messages during configuration testing<br>  -s signal     : send signal to a master process: stop, quit, reopen, reload<br>  -p prefix     : <span class="hljs-built_in">set</span> prefix path (default: /usr/<span class="hljs-built_in">local</span>/nginx/)<br>  -e filename   : <span class="hljs-built_in">set</span> error <span class="hljs-built_in">log</span> file (default: logs/error.log)<br>  -c filename   : <span class="hljs-built_in">set</span> configuration file (default: conf/nginx.conf)<br>  -g directives : <span class="hljs-built_in">set</span> global directives out of configuration file<br><br></code></pre></td></tr></tbody></table></figure>
<p>3、启动Nginx：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost sbin]<span class="hljs-comment"># ./nginx</span><br></code></pre></td></tr></tbody></table></figure>
<p>4、关闭Nginx：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost sbin]<span class="hljs-comment"># ./nginx -s stop</span><br></code></pre></td></tr></tbody></table></figure>
<p>5、重新加载Nginx，即不需要重启，只重新加载配置文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">[root@localhost sbin]<span class="hljs-comment"># ./nginx -s reload</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、Nginx配置文件"><a href="#三、Nginx配置文件" class="headerlink" title="三、Nginx配置文件"></a>三、Nginx配置文件</h1><p>Nginx的配置文件默认为<code>/usr/local/nginx/conf/nginx.conf</code>。</p>
<p><code>nginx.conf</code>配置文件主要有三部分组成：</p>
<p><strong>第一部分：全局块</strong></p>
<p>全局块指的是配置文件开始到events块之间的内容。主要配置服务器整体运行的配置指令，比如配置运行Nginx服务器的用户（组）、允许生成的worker process数，进程PID存放路径、日志存放路径和类型以及配置文件的引入等。</p>
<p><strong>第二部分：events块</strong></p>
<p>events块主要影响Nginx服务器和用户的网络连接。常用的设置包括是否开启对多work process下的网络连接进行序列化，是否允许同时接收多个网络连接，选取哪种事件驱动模型来处理连接请求，每个word process可以同时支持的最大连接数等。</p>
<p>这部分配置对Nginx的性能影响较大。</p>
<p><strong>第三部分：http块</strong></p>
<p>http块是Nginx服务器配置中最频繁的部分，代理、缓存和日志定义等绝大多数功能和第三方模块的配置都在这里。</p>
<p>http块又分为<strong>http全局块</strong>和<strong>server块</strong>。</p>
<ul>
<li>http全局块：包括文件引入、MIME-TYPE定义、日志自定义、连接超时时间、单链接请求数上限等。</li>
<li>server块：每个http块可以包括多个server块，每个server块相当于一个虚拟主机。每个server块也分为全局server块和location块：<ul>
<li>全局server块：常见的配置包括本虚拟主机的监听配置、名称或IP配置</li>
<li>location块：一个server块可以配置多个location块。主要作用是基于Nginx服务器接收到的请求字符串，对虚拟主机名称之外的字符串进行匹配，对特定的请求进行处理。地址定向、数据缓存和应答控制等功能，以及一些第三方模块的配置也在这里进行。</li>
</ul>
</li>
</ul>
<h1 id="四、反向代理"><a href="#四、反向代理" class="headerlink" title="四、反向代理"></a>四、反向代理</h1><h2 id="1、概念"><a href="#1、概念" class="headerlink" title="1、概念"></a>1、概念</h2><p><strong>正向代理：代理的对象是客户端。</strong>客户端通过代理访问服务器，但服务端不知道具体的客户端是谁。</p>
<p><strong>反向代理：代理的对象是服务器。</strong>客户端直接访问代理，代理去访问服务器，客户端只知道代理是谁，不知道服务器是谁。</p>
<h2 id="2、实例一"><a href="#2、实例一" class="headerlink" title="2、实例一"></a>2、实例一</h2><p><strong>实现效果</strong>：在浏览器中访问<code>www.hellonginx.com</code>，跳转到Linux系统tomcat主页面中。</p>
<blockquote>
<p>流程：<code>www.hellonginx.com</code>—-&gt;Nginx代理服务器—-&gt;tomcat服务器</p>
</blockquote>
<p><strong>准备工作</strong>：</p>
<ul>
<li>确保Linux系统安装了tomcat，这里使用默认端口8080。</li>
<li>确保外界能够访问到Linux系统中的tomcat。可以通过设置开放端口、直接关闭防火墙两种方式。</li>
</ul>
<p><strong>具体配置</strong>：</p>
<p>1、将域名和Nginx主机地址做映射。</p>
<p>在Windows系统的host文件中进行域名和ip对应关系的配置，即域名对应Nginx的主机地址，例<code>www.hellonginx.com</code>—-<code>192.168.198.198:80</code>。</p>
<p>在<code>C:\Windows\System32\drivers\etc\hosts</code>文件中，添加内容：</p>
<figure class="highlight accesslog"><table><tbody><tr><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">192.168.198.198</span> www.hellonginx.com<br></code></pre></td></tr></tbody></table></figure>
<p>配置好以后，在Windows系统浏览器中输入<code>www.hellonginx.com</code>就会访问Linux系统的Nginx，因为http默认端口就是80端口。</p>
<p>2、在Nginx中进行请求转发的配置（反向代理配置）。</p>
<p>在Nginx的配置文件<code>nginx.conf</code>中，在http块的server块中，将主机名改为主机ip地址，然后在<code>location</code>块中，添加请求转发的地址：</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><code class="hljs awk">proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">8080</span><br></code></pre></td></tr></tbody></table></figure>
<p>配置好以后的内容如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/nginx_1.png"><span class="image-caption">反向代理配置</span></p>
<p>保存以后，重启Nginx服务即可生效。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/nginx_2.png"><span class="image-caption">反向代理成功</span></p>
<h2 id="3、实例二"><a href="#3、实例二" class="headerlink" title="3、实例二"></a>3、实例二</h2><p><strong>实现效果</strong>：使用Nginx反向代理，根据访问的路径跳转到不同端口的服务中。</p>
<p>比如Nginx的监听端口为9001：</p>
<ul>
<li>访问<code>http://192.168.198.198:9001/edu/</code>，直接跳转到<code>192.168.198.198:8080</code></li>
<li>访问<code>http://192.168.198.198:9001/vod/</code>，直接跳转到<code>192.168.198.198:8081</code></li>
</ul>
<p><strong>准备工作</strong>：</p>
<p>1、需要准备两个tomcat服务器，一个是8080端口，一个是8081端口。</p>
<p>可以使用docker容器，创建两个容器，分别用两个端口映射。也可以使用基础的方法，安装两个tomcat，将其中一个tomcat的默认端口号改为<code>8081</code>，在安装目录的<code>server.xml</code>文件中修改端口号。</p>
<p>启动两个tomcat。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/nginx_3.png"><span class="image-caption">成功启动两个tomcat</span></p>
<p>2、在两个tomcat服务器中分别准备两个测试页面。</p>
<ul>
<li>在8080端口的tomcat服务器的<code>webapps</code>文件夹中创建目录<code>edu</code>，然后创建文件<code>edu/0.html</code>，测试通过<code>192.168.198.198:8080/edu/0.html</code>能够访问成功。</li>
<li>在8081端口的tomcat服务器的<code>webapps</code>文件夹中创建目录<code>vod</code>，然后创建文件<code>edu/1.html</code>，测试通过<code>192.168.198.198:8081/edu/1.html</code>能够访问成功。</li>
</ul>
<p><strong>具体配置：</strong></p>
<p>在Nginx的配置中，在http块中添加一个server块，内容如下</p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">server</span> {<br>    <span class="hljs-attribute">listen</span>       <span class="hljs-number">9001</span>;    <span class="hljs-comment"># 监听端口9001</span><br>    <span class="hljs-attribute">server_name</span>  <span class="hljs-number">192.168.198.198</span>;  <span class="hljs-comment">#代理服务器ip</span><br>  <br>    <span class="hljs-attribute">location</span> ~/edu/ {  <span class="hljs-comment"># 添加规则：如果请求中包括edu，则跳转到http://127.0.0.1:8080</span><br>        <span class="hljs-attribute">proxy_pass</span>   http://127.0.0.1:8080;<br>    }<br>    <span class="hljs-attribute">location</span> ~/vod/ {<br>        <span class="hljs-attribute">proxy_pass</span>   http://127.0.0.1:8081;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>location后面的<code>~</code>表示后面的字符串是正则表达式形式。</p>
<p>注意：如果是在外面系统访问Linux中的Nginx，记得开放端口，9001、8080、8081都需要开放。</p>
</blockquote>
<p><strong>代理结果</strong></p>
<p>配置好以后，重新加载Nginx或者重启服务即可。就可以实现根据条件代理到不同服务器的效果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/nginx_4.png"><span class="image-caption">反向代理不同服务器</span></p>
<blockquote>
<p>浏览器访问192.168.198.198:9001/edu/0.html，通过Nginx反向代理，会访问192.168.198.198:8080/edu/0.html</p>
<p>关于location反向代理的匹配规则，可以参考：<a href="https://segmentfault.com/a/1190000009651161">https://segmentfault.com/a/1190000009651161</a></p>
</blockquote>
<h1 id="五、负载均衡"><a href="#五、负载均衡" class="headerlink" title="五、负载均衡"></a>五、负载均衡</h1><h2 id="1、实例"><a href="#1、实例" class="headerlink" title="1、实例"></a>1、实例</h2><p><strong>实现目标</strong></p>
<p>在浏览器输入<code>http://192.168.198.198/edu/a.html</code>，通过负载均衡，将请求平均分发到<code>8080</code>和<code>8081</code>两个tomcat服务器上。</p>
<p><strong>准备工作</strong></p>
<p>准备两台tomcat服务器，一台端口为是<code>8080</code>，另一台为<code>8081</code>。确保在Linux系统外都能够访问到这两个服务器。</p>
<p>在两个tomcat服务器的<code>webapps</code>目录下，创建<code>edu/a.html</code>文件，用于测试</p>
<p><strong>具体配置</strong></p>
<p>在Nginx的配置文件<code>nginx.conf</code>中配置。</p>
<ul>
<li>在<strong>http块</strong>中添加<code>upstream</code>，命名为<code>myserver</code>，然后列出服务器的列表。</li>
<li>在<strong>server块</strong>中的<code>location</code>中添加规则，设置<code>proxy_pass</code>的值为<code>http://myserver</code>。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/nginx_5.png"><span class="image-caption">负载均衡配置</span></p>
<p>重新加载Nginx即可生效。这样，每次访问<code>192.168.198.198:80</code>时，Nginx服务器会将请求根据配置要求分发到<code>myserver</code>列出的服务器中。</p>
<h2 id="2、分配策略"><a href="#2、分配策略" class="headerlink" title="2、分配策略"></a>2、分配策略</h2><p>Nginx的实现负载均衡有以下几种分配服务器策略：</p>
<p><strong>1、轮询（默认）</strong></p>
<p>轮询方式是Nginx默认的分配方式。</p>
<p>轮询是指每个请求按时间顺序<strong>逐一分配</strong>到不同的后端服务器，如果后端服务器down掉，能自动剔除。</p>
<p><strong>2、权重weight</strong></p>
<p>weight表示权重，默认为1，权重越高被分配的客户端越多。</p>
<p>配置方式：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><code class="hljs routeros">upstream server_pool{<br><span class="hljs-built_in">	server </span>192.168.198.198:8080 <span class="hljs-attribute">weight</span>=5;<br><span class="hljs-built_in">	server </span>192.168.198.198:8081 <span class="hljs-attribute">weight</span>=10;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、ip_hash</strong></p>
<p>每个请求按访问ip的hash结果分配，这样同一个ip地址每次访问固定的一个后端服务器，可以解决session共享的问题。</p>
<p>配置方式：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><code class="hljs routeros">upstream server_pool{<br>	ip_hash;<br><span class="hljs-built_in">	server </span>192.168.198.198:8080;<br><span class="hljs-built_in">	server </span>192.168.198.198:8081;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、fair</strong></p>
<p>按照后端服务器的响应时间分配请求，响应时间短的优先分配。</p>
<p>配置方式：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><code class="hljs routeros">upstream server_pool{<br><span class="hljs-built_in">	server </span>192.168.198.198:8080;<br><span class="hljs-built_in">	server </span>192.168.198.198:8081;<br>	fair;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、动静分离"><a href="#六、动静分离" class="headerlink" title="六、动静分离"></a>六、动静分离</h1><h2 id="1、概念-1"><a href="#1、概念-1" class="headerlink" title="1、概念"></a>1、概念</h2><p>动静分离：将<strong>动态请求</strong>和<strong>静态请求</strong>分开，可以理解为使用Nginx处理静态页面，Tomcat处理动态页面。</p>
<blockquote>
<p>静态请求比如html页面、css样式、image图片等。</p>
<p>动态请求比如请求数据库的数据等。</p>
</blockquote>
<p>动静分离有两种实现方式：</p>
<ul>
<li>第一种是将静态文件独立成单独的域名，放在独立的服务器上。是目前常用的方法。</li>
<li>第二种是动态和静态文件混合在一起发布，通过Nginx分开。</li>
</ul>
<blockquote>
<p>通过配置文件的<code>location</code>可以指定不同的后缀名实现不同的请求转发。</p>
<p>expires参数可以设置浏览器缓存的过期时间。每次请求时，会对比服务器文件的更新时间，如果没有变化，则直接从浏览器缓存中取数据，否则才会从服务器下载。适合不经常变动的资源。</p>
</blockquote>
<h2 id="2、实例"><a href="#2、实例" class="headerlink" title="2、实例"></a>2、实例</h2><p><strong>实现目标</strong></p>
<p>对于静态资源，使用Nginx访问，不通过tomcat服务器。</p>
<p><strong>资源准备</strong></p>
<p>准备好<code>a.html</code>和一个图片，例如<code>/data/www/a.html</code>和<code>/data/image/abc.jpg</code>。</p>
<p><strong>具体配置</strong></p>
<p>主要配置是在<code>server块</code>的<code>location</code>中：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/nginx_6.png"><span class="image-caption">动静分离配置</span></p>
<p><code>root</code>表示根目录，以<code>/www/</code>为例，当访问<code>192.168.198.198/www/a.html</code>时，Nginx会去访问<code>/data/www/a.html</code>。</p>
<p><code>index</code>用于查找主页。</p>
<p><code>autoindex on</code>表示开启自动显示目录。</p>
<p>效果如下，这样的静态请求不会经过tomcat，由Nginx代理直接访问指定的目录。因此即使tomcat关闭，不会影响以下请求：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/nginx_7.png"><span class="image-caption">动静分离实现效果</span></p>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>论文阅读-Star Graph Neural Networks for Session-based Recommendation</title>
    <url>/2020/11/05/paper-SGNN-HN/</url>
    <content><![CDATA[<blockquote>
<p>2020年10月份<a href="https://www.cikm2020.org/accepted-papers/accepted-research-papers/">CIKM</a>会议的一篇论文，主要内容是提出了带有Highway Network的Star-GNN模型，简称为SGNN-HN模型，原文<a href="https://dl.acm.org/doi/abs/10.1145/3340531.3412014">链接</a></p>
</blockquote>
<h1 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h1><p>现有基于GNN的模型，有两个缺陷：</p>
<ol>
<li>一般的GNN模型只考虑了相邻item的转换信息，忽略了来自不相邻item的高阶转换信息。</li>
<li>一般的GNN模型，如果想要捕获高阶转换信息，必须要增加层数，这样就面临严重的过拟合问题</li>
</ol>
<p>为了解决上述两个问题，作者提出了Star Graph Neural Networks with Highway Networks (SGNN-HN)模型：</p>
<ol>
<li>对于问题1，使用Star GNN(SGNN)学习当前session中不相邻item的复杂转换信息。</li>
<li>对于问题2，使用Highway Networks(HN)自适应地从item表示中选择嵌入信息，缓解过拟合问题。</li>
</ol>
<h1 id="一、介绍"><a href="#一、介绍" class="headerlink" title="一、介绍"></a>一、介绍</h1><p>基于session的推荐系统是根据当前正在进行的session生成推荐，SBRS没有用户的历史交互信息，只有当前session中的item信息，并且是很有限的。使用RNN考虑session的序列信息(如GRU4Rec)，或者使用注意力机制考虑主要目的(如NARM)，都不能完全考虑到item的复杂转换信息。后来的GNN模型(如SRGNN、TAGNN等)，虽然利用GNN的优势，考虑了item间的复杂转换信息，但是面临上述两个问题，即高阶转换信息和过拟合问题。</p>
<p>因此，作者提出了SGNN-HN模型，<strong>首先</strong>在图中加入star节点，构建SGNN，建立当前session复杂item转换信息的模型，解决长距离信息传播问题。<strong>然后</strong>使用HN，在SGNN前后动态选择item表示，解决过拟合问题。<strong>最后</strong>使用注意力机制将item表示融合，得到session表示，用于推荐。</p>
<h1 id="二、相关工作"><a href="#二、相关工作" class="headerlink" title="二、相关工作"></a>二、相关工作</h1><ul>
<li>一般推荐模型：CF、MF、NCF、Item-KNN等</li>
<li>序列推荐模型：MC、FPMC、GRU4Rec、NARM、KNN、CSRM</li>
<li>注意力模型：STAMP、Co-Attention模型</li>
<li>GNN模型：SRGNN、FGNN</li>
</ul>
<h1 id="三、本文模型"><a href="#三、本文模型" class="headerlink" title="三、本文模型"></a>三、本文模型</h1><p>本文模型结构图如下：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/paper-SGNN-HN_1.png">
</div>


<h2 id="3-1-问题定义"><a href="#3-1-问题定义" class="headerlink" title="3.1 问题定义"></a>3.1 问题定义</h2><p><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="21.325ex" height="3.176ex" style="vertical-align: -1.171ex;" viewBox="0 -863.1 9181.5 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title"> V=\{v_1,v_2,\dots,v_{|V|}\} </title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-56" d="M52 648Q52 670 65 683H76Q118 680 181 680Q299 680 320 683H330Q336 677 336 674T334 656Q329 641 325 637H304Q282 635 274 635Q245 630 242 620Q242 618 271 369T301 118L374 235Q447 352 520 471T595 594Q599 601 599 609Q599 633 555 637Q537 637 537 648Q537 649 539 661Q542 675 545 679T558 683Q560 683 570 683T604 682T668 681Q737 681 755 683H762Q769 676 769 672Q769 655 760 640Q757 637 743 637Q730 636 719 635T698 630T682 623T670 615T660 608T652 599T645 592L452 282Q272 -9 266 -16Q263 -18 259 -21L241 -22H234Q216 -22 216 -15Q213 -9 177 305Q139 623 138 626Q133 637 76 637H59Q52 642 52 648Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-56" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1047" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="2103" y="0"></use>
<g transform="translate(2604,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3543" y="0"></use>
<g transform="translate(3988,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4928" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="5373" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="6712" y="0"></use>
<g transform="translate(7157,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
<g transform="translate(485,-187)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-7C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-56" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-7C" x="1048" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="8681" y="0"></use>
</g>
</svg> 表示所有session中的item集合，其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.081ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 1326.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">|V|</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path>
<path stroke-width="1" id="E1-MJMATHI-56" d="M52 648Q52 670 65 683H76Q118 680 181 680Q299 680 320 683H330Q336 677 336 674T334 656Q329 641 325 637H304Q282 635 274 635Q245 630 242 620Q242 618 271 369T301 118L374 235Q447 352 520 471T595 594Q599 601 599 609Q599 633 555 637Q537 637 537 648Q537 649 539 661Q542 675 545 679T558 683Q560 683 570 683T604 682T668 681Q737 681 755 683H762Q769 676 769 672Q769 655 760 640Q757 637 743 637Q730 636 719 635T698 630T682 623T670 615T660 608T652 599T645 592L452 282Q272 -9 266 -16Q263 -18 259 -21L241 -22H234Q216 -22 216 -15Q213 -9 177 305Q139 623 138 626Q133 637 76 637H59Q52 642 52 648Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-7C" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-56" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7C" x="1048" y="0"></use>
</g>
</svg> 表示item的个数。</p>
<p><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="26.976ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 11614.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">S=\{v_1,v_2,\dots,v_t,\dots,v_n\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-53" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-53" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="923" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="1979" y="0"></use>
<g transform="translate(2480,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3419" y="0"></use>
<g transform="translate(3864,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4804" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="5249" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="6588" y="0"></use>
<g transform="translate(7033,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="7874" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="8319" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="9658" y="0"></use>
<g transform="translate(10104,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="11114" y="0"></use>
</g>
</svg> 是给定的当前session，包含n个item。</p>
<p>模型的目标是预测<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.447ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1914.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">v_{n+1}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
<g transform="translate(485,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-2B" x="600" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="1379" y="0"></use>
</g>
</g>
</svg> ，具体来说，对于每个session，输出<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="21.364ex" height="3.176ex" style="vertical-align: -1.171ex;" viewBox="0 -863.1 9198.2 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\widehat{y}=\{\widehat{y}_1,\widehat{y}_2,\dots,\widehat{y}_{|V|}\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C6" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path>
<path stroke-width="1" id="E1-MJMATHI-56" d="M52 648Q52 670 65 683H76Q118 680 181 680Q299 680 320 683H330Q336 677 336 674T334 656Q329 641 325 637H304Q282 635 274 635Q245 630 242 620Q242 618 271 369T301 118L374 235Q447 352 520 471T595 594Q599 601 599 609Q599 633 555 637Q537 637 537 648Q537 649 539 661Q542 675 545 679T558 683Q560 683 570 683T604 682T668 681Q737 681 755 683H762Q769 676 769 672Q769 655 760 640Q757 637 743 637Q730 636 719 635T698 630T682 623T670 615T660 608T652 599T645 592L452 282Q272 -9 266 -16Q263 -18 259 -21L241 -22H234Q216 -22 216 -15Q213 -9 177 305Q139 623 138 626Q133 637 76 637H59Q52 642 52 648Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-79" x="1" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C6" x="60" y="21"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="838" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="1894" y="0"></use>
<g transform="translate(2395,0)">
 <use xlink:href="#E1-MJMATHI-79" x="1" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C6" x="60" y="21"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="792" y="-342"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3409" y="0"></use>
<g transform="translate(3854,0)">
 <use xlink:href="#E1-MJMATHI-79" x="1" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C6" x="60" y="21"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="792" y="-342"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4869" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="5314" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="6653" y="0"></use>
<g transform="translate(7099,0)">
 <use xlink:href="#E1-MJMATHI-79" x="1" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C6" x="60" y="21"></use>
<g transform="translate(560,-242)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-7C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-56" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-7C" x="1048" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="8697" y="0"></use>
</g>
</svg> ，表示所有item的预测分数，最后取分数最高的K个作为推荐item。</p>
<h2 id="3-2-构建星型图"><a href="#3-2-构建星型图" class="headerlink" title="3.2 构建星型图"></a>3.2 构建星型图</h2><p>对于每个session <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="26.976ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 11614.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">S=\{v_1,v_2,\dots,v_t,\dots,v_n\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-53" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-53" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="923" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="1979" y="0"></use>
<g transform="translate(2480,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3419" y="0"></use>
<g transform="translate(3864,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4804" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="5249" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="6588" y="0"></use>
<g transform="translate(7033,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="7874" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="8319" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="9658" y="0"></use>
<g transform="translate(10104,0)">
 <use xlink:href="#E1-MJMATHI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="686" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="11114" y="0"></use>
</g>
</svg>,构建为一个星型图，表示为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.279ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 6147.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">G_s=\{\mathcal{V}_s,{\Large{\varepsilon}}_s\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-47" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJCAL-56" d="M25 633Q25 647 47 665T100 683Q291 683 291 306Q291 264 288 213T282 132L279 102Q281 102 308 126T378 191T464 279T545 381T596 479Q600 490 600 502Q600 527 581 550T523 577Q505 577 505 601Q505 622 516 647T542 681Q546 683 558 683Q605 679 631 645T658 559Q658 423 487 215Q409 126 308 37T190 -52Q177 -52 177 -28Q177 -26 183 15T196 127T203 270Q203 356 192 421T165 523T126 583T83 613T41 620Q25 620 25 633Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-3B5" d="M190 -22Q124 -22 76 11T27 107Q27 174 97 232L107 239L99 248Q76 273 76 304Q76 364 144 408T290 452H302Q360 452 405 421Q428 405 428 392Q428 381 417 369T391 356Q382 356 371 365T338 383T283 392Q217 392 167 368T116 308Q116 289 133 272Q142 263 145 262T157 264Q188 278 238 278H243Q308 278 308 247Q308 206 223 206Q177 206 142 219L132 212Q68 169 68 112Q68 39 201 39Q253 39 286 49T328 72T345 94T362 105Q376 103 376 88Q376 79 365 62T334 26T275 -8T190 -22Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-47" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="1112" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1496" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="2552" y="0"></use>
<g transform="translate(3053,0)">
 <use xlink:href="#E1-MJCAL-56" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="867" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4098" y="0"></use>
<g transform="translate(4543,0)">
 <use transform="scale(1.44)" xlink:href="#E1-MJMATHI-3B5" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="950" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="5647" y="0"></use>
</g>
</svg>。</p>
<p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.528ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 11852.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathcal{V_s}=\{\{x_1,x_2,\dots,x_m\},x_s\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJCAL-56" d="M25 633Q25 647 47 665T100 683Q291 683 291 306Q291 264 288 213T282 132L279 102Q281 102 308 126T378 191T464 279T545 381T596 479Q600 490 600 502Q600 527 581 550T523 577Q505 577 505 601Q505 622 516 647T542 681Q546 683 558 683Q605 679 631 645T658 559Q658 423 487 215Q409 126 308 37T190 -52Q177 -52 177 -28Q177 -26 183 15T196 127T203 270Q203 356 192 421T165 523T126 583T83 613T41 620Q25 620 25 633Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJCAL-56" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="867" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1323" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="2379" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="2880" y="0"></use>
<g transform="translate(3380,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4406" y="0"></use>
<g transform="translate(4852,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="5878" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="6323" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="7662" y="0"></use>
<g transform="translate(8108,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="9401" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="9902" y="0"></use>
<g transform="translate(10347,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="11351" y="0"></use>
</g>
</svg>表示图中的所有节点。前半部分<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.31ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 7022.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\{x_1,x_2,\ldots,x_m\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-7B" x="0" y="0"></use>
<g transform="translate(500,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="1526" y="0"></use>
<g transform="translate(1972,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="2998" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="3443" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="4782" y="0"></use>
<g transform="translate(5227,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="6521" y="0"></use>
</g>
</svg>表示<strong>satellite</strong>节点，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.333ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1004.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="809" y="-213"></use>
</g>
</svg>表示<strong>star</strong>节点。注意这里的<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.534ex" height="2.176ex" style="vertical-align: -0.505ex;" viewBox="0 -719.6 2813.1 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">m\leqslant n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E2-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E2-MJAMS-2A7D" d="M674 636Q682 636 688 630T694 615T687 601Q686 600 417 472L151 346L399 228Q687 92 691 87Q694 81 694 76Q694 58 676 56H670L382 192Q92 329 90 331Q83 336 83 348Q84 359 96 365Q104 369 382 500T665 634Q669 636 674 636ZM94 170Q102 172 104 172Q110 171 254 103T535 -30T678 -98Q694 -106 694 -118Q694 -136 676 -138H670L382 -2Q92 135 90 137Q83 142 83 154Q84 164 94 170Z"></path>
<path stroke-width="1" id="E2-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E2-MJMATHI-6D" x="0" y="0"></use>
 <use xlink:href="#E2-MJAMS-2A7D" x="1156" y="0"></use>
 <use xlink:href="#E2-MJMATHI-6E" x="2212" y="0"></use>
</g>
</svg>，因为session中可能会有重复出现的item。</p>
<p><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.564ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1103.7 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">{\Large\varepsilon}_s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B5" d="M190 -22Q124 -22 76 11T27 107Q27 174 97 232L107 239L99 248Q76 273 76 304Q76 364 144 408T290 452H302Q360 452 405 421Q428 405 428 392Q428 381 417 369T391 356Q382 356 371 365T338 383T283 392Q217 392 167 368T116 308Q116 289 133 272Q142 263 145 262T157 264Q188 278 238 278H243Q308 278 308 247Q308 206 223 206Q177 206 142 219L132 212Q68 169 68 112Q68 39 201 39Q253 39 286 49T328 72T345 94T362 105Q376 103 376 88Q376 79 365 62T334 26T275 -8T190 -22Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use transform="scale(1.44)" xlink:href="#E1-MJMATHI-3B5" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="950" y="-213"></use>
</g>
</svg>是图中的边集合，包括<strong>satellite连接</strong>(图2中实线)和<strong>star连接</strong>(图2中虚线)两种有向边：</p>
<ul>
<li><strong>Satellite connections</strong>：satellite连接用来传递session中的相邻item间的信息。论文中使用GGNN为例，实现相邻节点之间的信息传播，并且按照satellite边构建输入和输出矩阵，例如对于session <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="26.396ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 11364.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">S=\{x_2,x_3,x_5,x_4,x_5,x_7\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-53" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path>
<path stroke-width="1" id="E1-MJMAIN-35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path>
<path stroke-width="1" id="E1-MJMAIN-34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path>
<path stroke-width="1" id="E1-MJMAIN-37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-53" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="923" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="1979" y="0"></use>
<g transform="translate(2480,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3506" y="0"></use>
<g transform="translate(3951,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-33" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4978" y="0"></use>
<g transform="translate(5423,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-35" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="6449" y="0"></use>
<g transform="translate(6894,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-34" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="7921" y="0"></use>
<g transform="translate(8366,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-35" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="9392" y="0"></use>
<g transform="translate(9837,0)">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-37" x="809" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-7D" x="10864" y="0"></use>
</g>
</svg>，构建的输入输出矩阵如图3：</li>
</ul>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/paper-SGNN-HN_2.png" style="width:50%; height:50%">
</div>




<ul>
<li><strong>Star connections</strong>：受<a href="https://arxiv.org/abs/1902.09113">Star-Transformer</a>模型启发，在图中添加Star节点，构建星型图。star节点和satellite节点之间的边就是Star连接，如图2，Star连接是双向边，分别代表两种信息传递方向，更新两种节点。一方面，以star节点作为中间节点，非相邻的item之间能够以two-hop的方式进行信息传播，来更新satellite节点。另一方面，另一个方向的边能够用来考虑所有satellite节点的信息，生成准确的star节点表示。</li>
</ul>
<p>本文模型使用门控网络控制分别从邻居节点和star节点获取信息量的多少。</p>
<h2 id="3-3-学习item嵌入"><a href="#3-3-学习item嵌入" class="headerlink" title="3.3 学习item嵌入"></a>3.3 学习item嵌入</h2><p>学习satellite节点和star节点表示</p>
<h3 id="3-3-1-初始化"><a href="#3-3-1-初始化" class="headerlink" title="3.3.1 初始化"></a>3.3.1 初始化</h3><ul>
<li>satellite节点：使用item的embedding</li>
</ul>
<script type="math/tex; mode=display">
h^0=\{x_1,x_2,\ldots,x_m\} \tag{1}</script><ul>
<li>star节点：对satellite节点进行平均池化，得到star节点初始状态</li>
</ul>
<script type="math/tex; mode=display">
x_s^0 = \frac 1{m}\sum\limits^{m}_{i=1} {x_i} \tag{2}</script><h3 id="3-3-2-更新节点"><a href="#3-3-2-更新节点" class="headerlink" title="3.3.2 更新节点"></a>3.3.2 更新节点</h3><p><strong>1、Satellite节点更新</strong></p>
<p>对于每个satellite节点，邻居节点信息包括<strong>相邻节点信息</strong>和<strong>star节点信息</strong>，分别对应来自直接相连节点和没有直接相连节点的信息。</p>
<ul>
<li><p>首先，考虑相邻节点信息，使用GGNN网络更新节点。对于图的第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.693ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 298.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6C" x="0" y="0"></use>
</g>
</svg>层每个satellite节点<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.129ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 916.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="809" y="-213"></use>
</g>
</svg>，使用出度和入度矩阵获得传播的信息：</p>
<script type="math/tex; mode=display">
\begin{align}
a_i^l = Concat(\mathbf{A}_i^I([\mathbf{x}_1^{l-1},\mathbf{x}_2^{l-1},\ldots,\mathbf{x}_m^{l-1}]^{\mathbf{T}}\mathbf{W}^I+\mathbf{b}^I),\\
\mathbf{A}_i^O([\mathbf{x}_1^{l-1},\mathbf{x}_2^{l-1},\ldots,\mathbf{x}_m^{l-1}]^{\mathbf{T}}\mathbf{W}^O+\mathbf{b}^O)) \tag{3}
\end{align}</script><p>其中，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.914ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 6851.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{A}_i^I,\mathbf{A}_i^O \in \mathbb{R}^{1\times m}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-41" d="M296 0Q278 3 164 3Q58 3 49 0H40V62H92Q144 62 144 64Q388 682 397 689Q403 698 434 698Q463 698 471 689Q475 686 538 530T663 218L724 64Q724 62 776 62H828V0H817Q796 3 658 3Q509 3 485 0H472V62H517Q561 62 561 63L517 175H262L240 120Q218 65 217 64Q217 62 261 62H306V0H296ZM390 237L492 238L440 365Q390 491 388 491Q287 239 287 237H390Z"></path>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-41" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-49" x="1229" y="602"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="1229" y="-350"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1326" y="0"></use>
<g transform="translate(1771,0)">
 <use xlink:href="#E1-MJMAINB-41" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4F" x="1229" y="602"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="1229" y="-350"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="3558" y="0"></use>
<g transform="translate(4503,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="1279" y="0"></use>
</g>
</g>
</g>
</svg>，分别为入度和出度矩阵的第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
</g>
</svg>行，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.855ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 7257.2 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{W}^I,\mathbf{W}^O \in \mathbb{R}^{d \times d}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-57" d="M915 686L1052 683Q1142 683 1157 686H1164V624H1073L957 320Q930 249 900 170T855 52T839 10Q834 0 826 -5Q821 -7 799 -7H792Q777 -7 772 -5T759 10Q759 11 748 39T716 122T676 228L594 442L512 228Q486 159 455 78Q433 19 428 9T416 -5Q411 -7 389 -7H379Q356 -7 349 10Q349 12 334 51T288 170T231 320L116 624H24V686H35Q44 683 183 683Q331 683 355 686H368V624H323Q278 624 278 623L437 207L499 369L561 531L526 624H434V686H445Q454 683 593 683Q741 683 765 686H778V624H733Q688 624 688 623L847 207Q848 207 927 415T1006 624H905V686H915Z"></path>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-49" x="1682" y="585"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1646" y="0"></use>
<g transform="translate(2091,0)">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4F" x="1682" y="585"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="4198" y="0"></use>
<g transform="translate(5143,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>是参数矩阵，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.162ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 5236.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{b}^I,\mathbf{b}^O \in \mathbb{R}^d</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-62" d="M32 686L123 690Q214 694 215 694H221V409Q289 450 378 450Q479 450 539 387T600 221Q600 122 535 58T358 -6H355Q272 -6 203 53L160 1L129 0H98V301Q98 362 98 435T99 525Q99 591 97 604T83 620Q69 624 42 624H29V686H32ZM227 105L232 99Q237 93 242 87T258 73T280 59T306 49T339 45Q380 45 411 66T451 131Q457 160 457 230Q457 264 456 284T448 329T430 367T396 389T343 398Q282 398 235 355L227 348V105Z"></path>
<path stroke-width="1" id="E1-MJMATHI-49" d="M43 1Q26 1 26 10Q26 12 29 24Q34 43 39 45Q42 46 54 46H60Q120 46 136 53Q137 53 138 54Q143 56 149 77T198 273Q210 318 216 344Q286 624 286 626Q284 630 284 631Q274 637 213 637H193Q184 643 189 662Q193 677 195 680T209 683H213Q285 681 359 681Q481 681 487 683H497Q504 676 504 672T501 655T494 639Q491 637 471 637Q440 637 407 634Q393 631 388 623Q381 609 337 432Q326 385 315 341Q245 65 245 59Q245 52 255 50T307 46H339Q345 38 345 37T342 19Q338 6 332 0H316Q279 2 179 2Q143 2 113 2T65 2T43 1Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-62" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-49" x="904" y="596"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1096" y="0"></use>
<g transform="translate(1541,0)">
 <use xlink:href="#E1-MJMAINB-62" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4F" x="904" y="596"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="3098" y="0"></use>
<g transform="translate(4043,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1021" y="583"></use>
</g>
</g>
</svg>是偏置向量。最终得到的<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.563ex" height="3.343ex" style="vertical-align: -1.005ex;" viewBox="0 -1006.6 4547.8 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">a_i^l \in \mathbb{R}^{1\times 2d}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-61" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6C" x="748" y="500"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="748" y="-430"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1151" y="0"></use>
<g transform="translate(2096,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="1279" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1779" y="0"></use>
</g>
</g>
</g>
</svg>表示节点<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.129ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 916.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="809" y="-213"></use>
</g>
</svg>的传播信息，然后继续使用GGNN网络计算：</p>
<script type="math/tex; mode=display">
\begin{align}
\mathbf{z}_i^l=\sigma(\mathbf{W}_z\mathbf{a}_i^l+\mathbf{U}_z\mathbf{h}_i^{l-1}),\\
\mathbf{r}_i^l=\sigma(\mathbf{W}_r\mathbf{a}_i^l+\mathbf{U}_r\mathbf{h}_i^{l-1}),\\
\mathbf{\tilde{h}}_i^l=\tanh(\mathbf{W}_h\mathbf{a}_i^l+\mathbf{U}_h(\mathbf{r}_i^l\odot \mathbf{h}_i^{l-1}),\\
\mathbf{\hat{h}}_i^l=(1-\mathbf{z}_i^l)\odot \mathbf{h}_i^{l-1} + \mathbf{z}_i^l \odot \mathbf{\tilde{h}}_l \tag{4}
\end{align}</script><p>其中，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="22.082ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 9507.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{W}_z,\mathbf{W}_r,\mathbf{W}_h \in \mathbb{R}^{d\times 2d}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-57" d="M915 686L1052 683Q1142 683 1157 686H1164V624H1073L957 320Q930 249 900 170T855 52T839 10Q834 0 826 -5Q821 -7 799 -7H792Q777 -7 772 -5T759 10Q759 11 748 39T716 122T676 228L594 442L512 228Q486 159 455 78Q433 19 428 9T416 -5Q411 -7 389 -7H379Q356 -7 349 10Q349 12 334 51T288 170T231 320L116 624H24V686H35Q44 683 183 683Q331 683 355 686H368V624H323Q278 624 278 623L437 207L499 369L561 531L526 624H434V686H445Q454 683 593 683Q741 683 765 686H778V624H733Q688 624 688 623L847 207Q848 207 927 415T1006 624H905V686H915Z"></path>
<path stroke-width="1" id="E1-MJMATHI-7A" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-7A" x="1682" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1620" y="0"></use>
<g transform="translate(2065,0)">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-72" x="1682" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3674" y="0"></use>
<g transform="translate(4119,0)">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-68" x="1682" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="6094" y="0"></use>
<g transform="translate(7040,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="1302" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1802" y="0"></use>
</g>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="19.141ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 8241.4 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{U}_z,\mathbf{U}_r,\mathbf{U}_h \in \mathbb{R}^{d\times d}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-55" d="M570 686Q588 683 703 683T836 686H845V624H737V420Q737 390 737 345T738 284Q738 205 729 164T689 83Q614 -11 465 -11Q321 -11 240 51T148 207Q147 214 147 421V624H39V686H51Q75 683 226 683Q376 683 400 686H412V624H304V405V370V268Q304 181 311 146T346 87Q387 52 466 52Q642 52 667 195Q668 204 669 415V624H561V686H570Z"></path>
<path stroke-width="1" id="E1-MJMATHI-7A" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-55" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-7A" x="1252" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1316" y="0"></use>
<g transform="translate(1761,0)">
 <use xlink:href="#E1-MJMAINB-55" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-72" x="1252" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3066" y="0"></use>
<g transform="translate(3511,0)">
 <use xlink:href="#E1-MJMAINB-55" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-68" x="1252" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="5182" y="0"></use>
<g transform="translate(6128,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>是参数矩阵，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.33ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 572.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\sigma</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3C3" d="M184 -11Q116 -11 74 34T31 147Q31 247 104 333T274 430Q275 431 414 431H552Q553 430 555 429T559 427T562 425T565 422T567 420T569 416T570 412T571 407T572 401Q572 357 507 357Q500 357 490 357T476 358H416L421 348Q439 310 439 263Q439 153 359 71T184 -11ZM361 278Q361 358 276 358Q152 358 115 184Q114 180 114 178Q106 141 106 117Q106 67 131 47T188 26Q242 26 287 73Q316 103 334 153T356 233T361 278Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3C3" x="0" y="0"></use>
</g>
</svg>表示<em>sigmoid</em>激活函数，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="2.176ex" style="vertical-align: -0.505ex;" viewBox="0 -719.6 778.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\odot</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-2299" d="M56 250Q56 394 156 488T384 583Q530 583 626 485T722 250Q722 110 625 14T390 -83Q249 -83 153 14T56 250ZM682 250Q682 322 649 387T546 497T381 542Q272 542 184 459T95 250Q95 132 178 45T389 -42Q515 -42 598 45T682 250ZM311 250Q311 285 332 304T375 328Q376 328 382 328T392 329Q424 326 445 305T466 250Q466 217 445 195T389 172Q354 172 333 195T311 250Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-2299" x="0" y="0"></use>
</g>
</svg>表示向量的对应元素点乘。使用这种方式，相邻节点的信息能够在星型图中传播。</p>
</li>
<li><p>然后，考虑来自star节点的信息，对于每个satellite节点<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.129ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 916.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="809" y="-213"></use>
</g>
</svg>，使用门控机制考虑应该从相邻节点和star节点分别获取多少信息。具体来说，使用自注意力计算<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.129ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 916.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="809" y="-213"></use>
</g>
</svg>和star节点<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.333ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1004.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="809" y="-213"></use>
</g>
</svg>的相似度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.287ex" height="3.176ex" style="vertical-align: -1.005ex;" viewBox="0 -934.9 984.8 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\alpha_i^l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B1" d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3B1" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6C" x="905" y="500"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="905" y="-430"></use>
</g>
</svg>:</p>
<script type="math/tex; mode=display">
\alpha_i^l=\frac{(\mathbf{W}_{q1} \mathbf{\hat{h}}_i^l)^\mathbf{T} \mathbf{W}_{k1} \mathbf{x}_s^{l-1}}
{\sqrt{d}} \tag{5}</script><p>其中，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="18.03ex" height="3.343ex" style="vertical-align: -1.005ex;" viewBox="0 -1006.6 7762.7 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{W}_{q1},\mathbf{W}_{k1} \in \mathbb{R}^{d\times d}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-57" d="M915 686L1052 683Q1142 683 1157 686H1164V624H1073L957 320Q930 249 900 170T855 52T839 10Q834 0 826 -5Q821 -7 799 -7H792Q777 -7 772 -5T759 10Q759 11 748 39T716 122T676 228L594 442L512 228Q486 159 455 78Q433 19 428 9T416 -5Q411 -7 389 -7H379Q356 -7 349 10Q349 12 334 51T288 170T231 320L116 624H24V686H35Q44 683 183 683Q331 683 355 686H368V624H323Q278 624 278 623L437 207L499 369L561 531L526 624H434V686H445Q454 683 593 683Q741 683 765 686H778V624H733Q688 624 688 623L847 207Q848 207 927 415T1006 624H905V686H915Z"></path>
<path stroke-width="1" id="E1-MJMATHI-71" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
<g transform="translate(1189,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="460" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="1969" y="0"></use>
<g transform="translate(2414,0)">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
<g transform="translate(1189,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="521" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="4704" y="0"></use>
<g transform="translate(5649,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>是参数矩阵，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.285ex" height="3.843ex" style="vertical-align: -0.838ex;" viewBox="0 -1293.7 983.8 1654.5" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{\hat{h}}_i^l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-68" d="M40 686L131 690Q222 694 223 694H229V533L230 372L238 381Q248 394 264 407T317 435T398 450Q428 450 448 447T491 434T529 402T551 346Q553 335 554 198V62H623V0H614Q596 3 489 3Q374 3 365 0H356V62H425V194V275Q425 348 416 373T371 399Q326 399 288 370T238 290Q236 281 235 171V62H304V0H295Q277 3 171 3Q64 3 46 0H37V62H106V332Q106 387 106 453T107 534Q107 593 105 605T91 620Q77 624 50 624H37V686H40Z"></path>
<path stroke-width="1" id="E1-MJMAINB-5E" d="M207 632L287 694Q289 693 368 632T448 570T431 545T413 520Q410 520 350 559L287 597L224 559Q164 520 161 520Q160 520 143 544T126 570T207 632Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-68" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAINB-5E" x="32" y="283"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6C" x="904" y="997"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="904" y="-350"></use>
</g>
</svg>是<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.129ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 916.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="809" y="-213"></use>
</g>
</svg>的表示向量。然后计算<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.129ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 916.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="809" y="-213"></use>
</g>
</svg>最终的节点表示：</p>
<script type="math/tex; mode=display">
\mathbf{h}_i^l = (1-\alpha_i^l) \mathbf{\hat{h}}_i^l + \alpha_i^l \mathbf{x}_s^{l-1} \tag{6}</script><blockquote>
<p>注意，这里的star节点是上一层的，因为这一层的star节点还没有更新，star节点需要在satellite节点更新完之后再更新。</p>
</blockquote>
</li>
</ul>
<p><strong>2、Star节点更新</strong></p>
<p>star节点是根据最新的satellite节点表示来更新的，同样使用self-attention，将star节点作为Query向量：</p>
<script type="math/tex; mode=display">
\beta = softmax(\frac{\mathbf{K}^ \mathbf{T} \mathbf{q}}{\sqrt{d}})
= softmax(\frac{(\mathbf{W}_{k2} \mathbf{h}^l)^ \mathbf{T} \mathbf{W}_{q2} \mathbf{x}_s^{l-1}}{\sqrt{d}}) \tag{7}\\</script><p><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="18.03ex" height="3.343ex" style="vertical-align: -1.005ex;" viewBox="0 -1006.6 7762.7 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{W}_{k2},\mathbf{W}_{q2} \in \mathbb{R}^{d\times d}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-57" d="M915 686L1052 683Q1142 683 1157 686H1164V624H1073L957 320Q930 249 900 170T855 52T839 10Q834 0 826 -5Q821 -7 799 -7H792Q777 -7 772 -5T759 10Q759 11 748 39T716 122T676 228L594 442L512 228Q486 159 455 78Q433 19 428 9T416 -5Q411 -7 389 -7H379Q356 -7 349 10Q349 12 334 51T288 170T231 320L116 624H24V686H35Q44 683 183 683Q331 683 355 686H368V624H323Q278 624 278 623L437 207L499 369L561 531L526 624H434V686H445Q454 683 593 683Q741 683 765 686H778V624H733Q688 624 688 623L847 207Q848 207 927 415T1006 624H905V686H915Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-71" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
<g transform="translate(1189,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="521" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="2012" y="0"></use>
<g transform="translate(2457,0)">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
<g transform="translate(1189,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="460" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="4704" y="0"></use>
<g transform="translate(5649,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>是对应的参数矩阵。最后计算得到star节点的向量表示</p>
<script type="math/tex; mode=display">
\mathbf{x}_s^l = \beta \mathbf{h}^l \tag{8}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.526ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 3240.2 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\beta \in \mathbb{R}^m</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B2" d="M29 -194Q23 -188 23 -186Q23 -183 102 134T186 465Q208 533 243 584T309 658Q365 705 429 705H431Q493 705 533 667T573 570Q573 465 469 396L482 383Q533 332 533 252Q533 139 448 65T257 -10Q227 -10 203 -2T165 17T143 40T131 59T126 65L62 -188Q60 -194 42 -194H29ZM353 431Q392 431 427 419L432 422Q436 426 439 429T449 439T461 453T472 471T484 495T493 524T501 560Q503 569 503 593Q503 611 502 616Q487 667 426 667Q384 667 347 643T286 582T247 514T224 455Q219 439 186 308T152 168Q151 163 151 147Q151 99 173 68Q204 26 260 26Q302 26 349 51T425 137Q441 171 449 214T457 279Q457 337 422 372Q380 358 347 358H337Q258 358 258 389Q258 396 261 403Q275 431 353 431Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3B2" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="851" y="0"></use>
<g transform="translate(1796,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="1021" y="583"></use>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.54ex" height="2.676ex" style="vertical-align: -0.338ex;" viewBox="0 -1006.6 4538 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{h}^l \in \mathbb{R}^{d\times m}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-68" d="M40 686L131 690Q222 694 223 694H229V533L230 372L238 381Q248 394 264 407T317 435T398 450Q428 450 448 447T491 434T529 402T551 346Q553 335 554 198V62H623V0H614Q596 3 489 3Q374 3 365 0H356V62H425V194V275Q425 348 416 373T371 399Q326 399 288 370T238 290Q236 281 235 171V62H304V0H295Q277 3 171 3Q64 3 46 0H37V62H106V332Q106 387 106 453T107 534Q107 593 105 605T91 620Q77 624 50 624H37V686H40Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-68" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6C" x="904" y="596"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1228" y="0"></use>
<g transform="translate(2173,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="1302" y="0"></use>
</g>
</g>
</g>
</svg></p>
<h3 id="3-3-3-Highway-Networks"><a href="#3-3-3-Highway-Networks" class="headerlink" title="3.3.3 Highway Networks"></a>3.3.3 Highway Networks</h3><p>上述节点更新的过程可以多次迭代，即堆叠多层SGNN，第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.693ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 298.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">l</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6C" x="0" y="0"></use>
</g>
</svg>层SGNN可以表示为：</p>
<script type="math/tex; mode=display">
\mathbf{h}^l,\mathbf{x}_x^l = SGNN(\mathbf{h}^{l-1},\mathbf{x}_s^{l-1},\mathbf{A}^I,\mathbf{A}^O) \tag{9}</script><p>多层图结构可以传播大量节点间的信息，同样也会带来偏差，导致过拟合，为了处理这个问题，使用highway networks从多层SGNN之前和之后选择性地获取信息。</p>
<p>用<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.41ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 2760 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{h}^0,\mathbf{h}^L</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-68" d="M40 686L131 690Q222 694 223 694H229V533L230 372L238 381Q248 394 264 407T317 435T398 450Q428 450 448 447T491 434T529 402T551 346Q553 335 554 198V62H623V0H614Q596 3 489 3Q374 3 365 0H356V62H425V194V275Q425 348 416 373T371 399Q326 399 288 370T238 290Q236 281 235 171V62H304V0H295Q277 3 171 3Q64 3 46 0H37V62H106V332Q106 387 106 453T107 534Q107 593 105 605T91 620Q77 624 50 624H37V686H40Z"></path>
<path stroke-width="1" id="E1-MJMAIN-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4C" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-68" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-30" x="904" y="596"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1093" y="0"></use>
<g transform="translate(1538,0)">
 <use xlink:href="#E1-MJMAINB-68" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4C" x="904" y="596"></use>
</g>
</g>
</svg>分别表示多层SGNN之前和多层SGNN之后的satellite节点表示，HN网络用以下公式表示：</p>
<script type="math/tex; mode=display">
\mathbf{h}^f = \mathbf{g} \odot \mathbf{h}^0 +(1-\mathbf{g})\odot \mathbf{h}^L \tag{10}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.669ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 4162.9 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{g} \in \mathbb{R}^{d\times m}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-67" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-67" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="853" y="0"></use>
<g transform="translate(1798,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>，是由SGNN的输入输出决定的：</p>
<script type="math/tex; mode=display">
\mathbf{g} = \sigma(\mathbf{W}_g[\mathbf{h}^0;\mathbf{h}^L]) \tag{11}</script><p><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.355ex" height="3.343ex" style="vertical-align: -1.005ex;" viewBox="0 -1006.6 5319.6 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{W}_g \in \mathbb{R}^{d\times2d}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-57" d="M915 686L1052 683Q1142 683 1157 686H1164V624H1073L957 320Q930 249 900 170T855 52T839 10Q834 0 826 -5Q821 -7 799 -7H792Q777 -7 772 -5T759 10Q759 11 748 39T716 122T676 228L594 442L512 228Q486 159 455 78Q433 19 428 9T416 -5Q411 -7 389 -7H379Q356 -7 349 10Q349 12 334 51T288 170T231 320L116 624H24V686H35Q44 683 183 683Q331 683 355 686H368V624H323Q278 624 278 623L437 207L499 369L561 531L526 624H434V686H445Q454 683 593 683Q741 683 765 686H778V624H733Q688 624 688 623L847 207Q848 207 927 415T1006 624H905V686H915Z"></path>
<path stroke-width="1" id="E1-MJMATHI-67" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-67" x="1682" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1907" y="0"></use>
<g transform="translate(2852,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="1302" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1802" y="0"></use>
</g>
</g>
</g>
</svg>。</p>
<p>HN网络处理之后，得到satellite节点和star节点的最终表示<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.622ex" height="2.676ex" style="vertical-align: -0.338ex;" viewBox="0 -1006.6 1128.8 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{h}^f</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-68" d="M40 686L131 690Q222 694 223 694H229V533L230 372L238 381Q248 394 264 407T317 435T398 450Q428 450 448 447T491 434T529 402T551 346Q553 335 554 198V62H623V0H614Q596 3 489 3Q374 3 365 0H356V62H425V194V275Q425 348 416 373T371 399Q326 399 288 370T238 290Q236 281 235 171V62H304V0H295Q277 3 171 3Q64 3 46 0H37V62H106V332Q106 387 106 453T107 534Q107 593 105 605T91 620Q77 624 50 624H37V686H40Z"></path>
<path stroke-width="1" id="E1-MJMATHI-66" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-68" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-66" x="904" y="596"></use>
</g>
</svg>和<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.762ex" height="2.843ex" style="vertical-align: -0.671ex;" viewBox="0 -934.9 1189.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{x}_s^L</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-78" d="M227 0Q212 3 121 3Q40 3 28 0H21V62H117L245 213L109 382H26V444H34Q49 441 143 441Q247 441 265 444H274V382H246L281 339Q315 297 316 297Q320 297 354 341L389 382H352V444H360Q375 441 466 441Q547 441 559 444H566V382H471L355 246L504 63L545 62H586V0H578Q563 3 469 3Q365 3 347 0H338V62H366Q366 63 326 112T285 163L198 63L217 62H235V0H227Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4C" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 217 683Q271 680 344 680Q485 680 506 683H518Q524 677 524 674T522 656Q517 641 513 637H475Q406 636 394 628Q387 624 380 600T313 336Q297 271 279 198T252 88L243 52Q243 48 252 48T311 46H328Q360 46 379 47T428 54T478 72T522 106T564 161Q580 191 594 228T611 270Q616 273 628 273H641Q647 264 647 262T627 203T583 83T557 9Q555 4 553 3T537 0T494 -1Q483 -1 418 -1T294 0H116Q32 0 32 10Q32 17 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4C" x="859" y="490"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="859" y="-212"></use>
</g>
</svg>(简写为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.414ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1039.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{x}_s</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-78" d="M227 0Q212 3 121 3Q40 3 28 0H21V62H117L245 213L109 382H26V444H34Q49 441 143 441Q247 441 265 444H274V382H246L281 339Q315 297 316 297Q320 297 354 341L389 382H352V444H360Q375 441 466 441Q547 441 559 444H566V382H471L355 246L504 63L545 62H586V0H578Q563 3 469 3Q365 3 347 0H338V62H366Q366 63 326 112T285 163L198 63L217 62H235V0H227Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-73" x="859" y="-213"></use>
</g>
</svg>)​。将以上步骤用算法流程表示：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/paper-SGNN-HN_3.jpg">
</div>
##  3.4 Session表示和预测

将<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.954ex" height="2.676ex" style="vertical-align: -0.338ex;" viewBox="0 -1006.6 4716.2 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{h}^f \in \mathbb{R}^{d\times m}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-68" d="M40 686L131 690Q222 694 223 694H229V533L230 372L238 381Q248 394 264 407T317 435T398 450Q428 450 448 447T491 434T529 402T551 346Q553 335 554 198V62H623V0H614Q596 3 489 3Q374 3 365 0H356V62H425V194V275Q425 348 416 373T371 399Q326 399 288 370T238 290Q236 281 235 171V62H304V0H295Q277 3 171 3Q64 3 46 0H37V62H106V332Q106 387 106 453T107 534Q107 593 105 605T91 620Q77 624 50 624H37V686H40Z"></path>
<path stroke-width="1" id="E1-MJMATHI-66" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-68" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-66" x="904" y="596"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1406" y="0"></use>
<g transform="translate(2351,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>用<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.361ex" height="2.676ex" style="vertical-align: -0.338ex;" viewBox="0 -1006.6 4030.3 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{u}\in \mathbb{R}^{d\times n}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-75" d="M40 442L134 446Q228 450 229 450H235V273V165Q235 90 238 74T254 52Q268 46 304 46H319Q352 46 380 67T419 121L420 123Q424 135 425 199Q425 201 425 207Q425 233 425 249V316Q425 354 423 363T410 376Q396 380 369 380H356V442L554 450V267Q554 84 556 79Q561 62 610 62H623V31Q623 0 622 0Q603 0 527 -3T432 -6Q431 -6 431 25V56L420 45Q373 6 332 -1Q313 -6 281 -6Q208 -6 165 14T109 87L107 98L106 230Q106 358 104 366Q96 380 50 380H37V442H40Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-75" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="917" y="0"></use>
<g transform="translate(1862,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>表示，然后加入可学习的位置编码<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.361ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 4030.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{p}\in \mathbb{R}^{d\times n}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-70" d="M32 442L123 446Q214 450 215 450H221V409Q222 409 229 413T251 423T284 436T328 446T382 450Q480 450 540 388T600 223Q600 128 539 61T361 -6H354Q292 -6 236 28L227 34V-132H296V-194H287Q269 -191 163 -191Q56 -191 38 -194H29V-132H98V113V284Q98 330 97 348T93 370T83 376Q69 380 42 380H29V442H32ZM457 224Q457 303 427 349T350 395Q282 395 235 352L227 345V104L233 97Q274 45 337 45Q383 45 420 86T457 224Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-70" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="917" y="0"></use>
<g transform="translate(1862,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>，则satellite节点表示变为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.454ex" height="2.676ex" style="vertical-align: -0.671ex;" viewBox="0 -863.1 4931.5 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{u}^p = \mathbf{u}+\mathbf{p}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-75" d="M40 442L134 446Q228 450 229 450H235V273V165Q235 90 238 74T254 52Q268 46 304 46H319Q352 46 380 67T419 121L420 123Q424 135 425 199Q425 201 425 207Q425 233 425 249V316Q425 354 423 363T410 376Q396 380 369 380H356V442L554 450V267Q554 84 556 79Q561 62 610 62H623V31Q623 0 622 0Q603 0 527 -3T432 -6Q431 -6 431 25V56L420 45Q373 6 332 -1Q313 -6 281 -6Q208 -6 165 14T109 87L107 98L106 230Q106 358 104 366Q96 380 50 380H37V442H40Z"></path>
<path stroke-width="1" id="E1-MJMATHI-70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMAINB-70" d="M32 442L123 446Q214 450 215 450H221V409Q222 409 229 413T251 423T284 436T328 446T382 450Q480 450 540 388T600 223Q600 128 539 61T361 -6H354Q292 -6 236 28L227 34V-132H296V-194H287Q269 -191 163 -191Q56 -191 38 -194H29V-132H98V113V284Q98 330 97 348T93 370T83 376Q69 380 42 380H29V442H32ZM457 224Q457 303 427 349T350 395Q282 395 235 352L227 345V104L233 97Q274 45 337 45Q383 45 420 86T457 224Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-70" x="904" y="583"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1373" y="0"></use>
 <use xlink:href="#E1-MJMAINB-75" x="2429" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="3291" y="0"></use>
 <use xlink:href="#E1-MJMAINB-70" x="4292" y="0"></use>
</g>
</svg>。

考虑使用用户的全局偏好和最近兴趣来生成session表示，使用最后一个点击item作为最近兴趣，即<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.964ex" height="2.843ex" style="vertical-align: -0.671ex;" viewBox="0 -934.9 3428.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{z}_r=\mathbf{u}_n^p</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-7A" d="M48 262Q48 264 54 349T60 436V444H252Q289 444 336 444T394 445Q441 445 450 441T459 418Q459 406 458 404Q456 399 327 229T194 55H237Q260 56 268 56T297 58T325 65T348 77T370 98T384 128T395 170Q400 197 400 216Q400 217 431 217H462V211Q461 208 453 108T444 6V0H245Q46 0 43 2Q32 7 32 28V33Q32 41 40 52T84 112Q129 170 164 217L298 393H256Q189 392 165 380Q124 360 115 303Q110 280 110 256Q110 254 79 254H48V262Z"></path>
<path stroke-width="1" id="E1-MJMATHI-72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAINB-75" d="M40 442L134 446Q228 450 229 450H235V273V165Q235 90 238 74T254 52Q268 46 304 46H319Q352 46 380 67T419 121L420 123Q424 135 425 199Q425 201 425 207Q425 233 425 249V316Q425 354 423 363T410 376Q396 380 369 380H356V442L554 450V267Q554 84 556 79Q561 62 610 62H623V31Q623 0 622 0Q603 0 527 -3T432 -6Q431 -6 431 25V56L420 45Q373 6 332 -1Q313 -6 281 -6Q208 -6 165 14T109 87L107 98L106 230Q106 358 104 366Q96 380 50 380H37V442H40Z"></path>
<path stroke-width="1" id="E1-MJMATHI-70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-7A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-72" x="723" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1208" y="0"></use>
<g transform="translate(2264,0)">
 <use xlink:href="#E1-MJMAINB-75" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-70" x="904" y="682"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="904" y="-212"></use>
</g>
</g>
</svg>，然后计算全局偏好：
$$
\mathbf{z}_g = \sum _{i=1}^n \gamma_i \mathbf{u}_i^p \tag{12}
$$

$$
\gamma_i = \mathbf{W}_0^ \mathbf{T} \sigma(\mathbf{W}_1 \mathbf{u}_i^p+
\mathbf{W}_2 \mathbf{x}_s + \mathbf{W}_3 \mathbf{z}_r + \mathbf{b}) \tag{13}
$$

<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.947ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 5143.8 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{W}_0,\mathbf{b} \in \mathbb{R}^d</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-57" d="M915 686L1052 683Q1142 683 1157 686H1164V624H1073L957 320Q930 249 900 170T855 52T839 10Q834 0 826 -5Q821 -7 799 -7H792Q777 -7 772 -5T759 10Q759 11 748 39T716 122T676 228L594 442L512 228Q486 159 455 78Q433 19 428 9T416 -5Q411 -7 389 -7H379Q356 -7 349 10Q349 12 334 51T288 170T231 320L116 624H24V686H35Q44 683 183 683Q331 683 355 686H368V624H323Q278 624 278 623L437 207L499 369L561 531L526 624H434V686H445Q454 683 593 683Q741 683 765 686H778V624H733Q688 624 688 623L847 207Q848 207 927 415T1006 624H905V686H915Z"></path>
<path stroke-width="1" id="E1-MJMAIN-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAINB-62" d="M32 686L123 690Q214 694 215 694H221V409Q289 450 378 450Q479 450 539 387T600 221Q600 122 535 58T358 -6H355Q272 -6 203 53L160 1L129 0H98V301Q98 362 98 435T99 525Q99 591 97 604T83 620Q69 624 42 624H29V686H32ZM227 105L232 99Q237 93 242 87T258 73T280 59T306 49T339 45Q380 45 411 66T451 131Q457 160 457 230Q457 264 456 284T448 329T430 367T396 389T343 398Q282 398 235 355L227 348V105Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-30" x="1682" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1643" y="0"></use>
 <use xlink:href="#E1-MJMAINB-62" x="2088" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="3005" y="0"></use>
<g transform="translate(3951,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1021" y="583"></use>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="21.268ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 9156.9 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{W}_1,\mathbf{W}_2,\mathbf{W}_3 \in \mathbb{R}^{d\times d}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-57" d="M915 686L1052 683Q1142 683 1157 686H1164V624H1073L957 320Q930 249 900 170T855 52T839 10Q834 0 826 -5Q821 -7 799 -7H792Q777 -7 772 -5T759 10Q759 11 748 39T716 122T676 228L594 442L512 228Q486 159 455 78Q433 19 428 9T416 -5Q411 -7 389 -7H379Q356 -7 349 10Q349 12 334 51T288 170T231 320L116 624H24V686H35Q44 683 183 683Q331 683 355 686H368V624H323Q278 624 278 623L437 207L499 369L561 531L526 624H434V686H445Q454 683 593 683Q741 683 765 686H778V624H733Q688 624 688 623L847 207Q848 207 927 415T1006 624H905V686H915Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="1682" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1643" y="0"></use>
<g transform="translate(2088,0)">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="1682" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3731" y="0"></use>
<g transform="translate(4177,0)">
 <use xlink:href="#E1-MJMAINB-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-33" x="1682" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="6098" y="0"></use>
<g transform="translate(7043,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="1302" y="0"></use>
</g>
</g>
</g>
</svg>。

然后计算最终的session表示：
$$
\mathbf{z}_h = \mathbf{W}_4[\mathbf{z}_g;\mathbf{z}_r] \tag{14}
$$
考虑到长尾效应，参考[NISER](https://arxiv.org/abs/1909.04276)，对session表示<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.367ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1019.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{z}_h</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-7A" d="M48 262Q48 264 54 349T60 436V444H252Q289 444 336 444T394 445Q441 445 450 441T459 418Q459 406 458 404Q456 399 327 229T194 55H237Q260 56 268 56T297 58T325 65T348 77T370 98T384 128T395 170Q400 197 400 216Q400 217 431 217H462V211Q461 208 453 108T444 6V0H245Q46 0 43 2Q32 7 32 28V33Q32 41 40 52T84 112Q129 170 164 217L298 393H256Q189 392 165 380Q124 360 115 303Q110 280 110 256Q110 254 79 254H48V262Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-7A" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-68" x="723" y="-213"></use>
</g>
</svg>和候选item <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.211ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 951.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{v}_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-76" d="M401 444Q413 441 495 441Q568 441 574 444H580V382H510L409 156Q348 18 339 6Q331 -4 320 -4Q318 -4 313 -4T303 -3H288Q273 -3 264 12T221 102Q206 135 197 156L96 382H26V444H34Q49 441 145 441Q252 441 270 444H279V382H231L284 264Q335 149 338 149Q338 150 389 264T442 381Q442 382 418 382H394V444H401Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="859" y="-213"></use>
</g>
</svg>的嵌入向量进行层标准化处理，即:
$$
\tilde{\mathbf{z}}_h = LayerNorm(\mathbf{z}_h) = \frac{\mathbf{z}_h}{\Vert \mathbf{z}_h \Vert _2} \\
\tilde{\mathbf{v}}_i = LayerNorm(\mathbf{v}_i)= \frac{\mathbf{v}_i}{\Vert \mathbf{v}_i \Vert _2}
$$
然后计算推荐分数：
$$
\tilde{\mathbf{y}_i} = \tilde{\mathbf{z}}_h^{\mathbf{T}}\tilde{\mathbf{v}_i} \tag{15}
$$
最后使用softmax函数进行归一化，根据[论文](https://dl.acm.org/doi/10.1145/3123266.3123359)，由于余弦相似度的值在<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.461ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2781.7 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">[-1,1]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-5B" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2212" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1057" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="1557" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="2002" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5D" x="2503" y="0"></use>
</g>
</svg>之间，可能导致softmax损失很大，以致模型无法收敛，因此使用缩放因子用来帮助模型更好地收敛：
$$
\hat{\mathbf{y}} = \frac{\exp(\tau \tilde{\mathbf{y}_i})}
{\sum \nolimits_i \tau \hat{\mathbf{y}_i}}, \forall i=1,2,\ldots,|V| \tag{16}
$$
其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="21.283ex" height="3.176ex" style="vertical-align: -1.171ex;" viewBox="0 -863.1 9163.5 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\hat{\mathbf{y}}=(\hat{\mathbf{y}}_1,\hat{\mathbf{y}}_2,\ldots,\hat{\mathbf{y}}_{|V|})</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-79" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5E" d="M112 560L249 694L257 686Q387 562 387 560L361 531Q359 532 303 581L250 627L195 580Q182 569 169 557T148 538L140 532Q138 530 125 546L112 560Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path>
<path stroke-width="1" id="E1-MJMATHI-56" d="M52 648Q52 670 65 683H76Q118 680 181 680Q299 680 320 683H330Q336 677 336 674T334 656Q329 641 325 637H304Q282 635 274 635Q245 630 242 620Q242 618 271 369T301 118L374 235Q447 352 520 471T595 594Q599 601 599 609Q599 633 555 637Q537 637 537 648Q537 649 539 661Q542 675 545 679T558 683Q560 683 570 683T604 682T668 681Q737 681 755 683H762Q769 676 769 672Q769 655 760 640Q757 637 743 637Q730 636 719 635T698 630T682 623T670 615T660 608T652 599T645 592L452 282Q272 -9 266 -16Q263 -18 259 -21L241 -22H234Q216 -22 216 -15Q213 -9 177 305Q139 623 138 626Q133 637 76 637H59Q52 642 52 648Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-79" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5E" x="53" y="22"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="885" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="1941" y="0"></use>
<g transform="translate(2331,0)">
 <use xlink:href="#E1-MJMAINB-79" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5E" x="53" y="22"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="859" y="-335"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3392" y="0"></use>
<g transform="translate(3837,0)">
 <use xlink:href="#E1-MJMAINB-79" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5E" x="53" y="22"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="859" y="-335"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="4899" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="5344" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="6683" y="0"></use>
<g transform="translate(7128,0)">
 <use xlink:href="#E1-MJMAINB-79" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5E" x="53" y="22"></use>
<g transform="translate(607,-237)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-7C" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-56" x="278" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-7C" x="1048" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="8774" y="0"></use>
</g>
</svg>。损失函数使用交叉熵：

$$
L(\hat{\mathbf{y}})=-\sum\limits_{i=1}^{|V|} \mathbf{y}_i \log(\hat{\mathbf{y}}_i)+
(1-\mathbf{y}_i)\log(1-\hat{\mathbf{y}}_i) \tag{17}
$$
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.462ex" height="2.343ex" style="vertical-align: -0.838ex;" viewBox="0 -647.8 2782.4 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{y}_i \in \mathbf{y}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-79" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-79" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="859" y="-335"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1229" y="0"></use>
 <use xlink:href="#E1-MJMAINB-79" x="2174" y="0"></use>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.411ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 607.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{y}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-79" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-79" x="0" y="0"></use>
</g>
</svg>是one-hot向量，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.472ex" height="2.676ex" style="vertical-align: -0.838ex;" viewBox="0 -791.3 2786.4 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mathbf{y}_i=1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAINB-79" d="M84 -102Q84 -110 87 -119T102 -138T133 -149Q148 -148 162 -143T186 -131T206 -114T222 -95T234 -76T243 -59T249 -45T252 -37L269 0L96 382H26V444H34Q49 441 146 441Q252 441 270 444H279V382H255Q232 382 232 380L337 151L442 382H394V444H401Q413 441 495 441Q568 441 574 444H580V382H510L406 152Q298 -84 297 -87Q269 -139 225 -169T131 -200Q85 -200 54 -172T23 -100Q23 -64 44 -50T87 -35Q111 -35 130 -50T152 -92V-100H84V-102Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAINB-79" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="859" y="-335"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1229" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="2285" y="0"></use>
</g>
</svg>表示第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
</g>
</svg>个item是给定session的目标item。

# 四、实验

实验数据和处理方式同SRGNN、NARM等模型，并且同样使用了数据增强的方法，具体细节见原文。

实验数据：

<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/paper-SGNN-HN_4.png">
</div>

<p>评估指标使用Precision和MRR。</p>
<h1 id="五、实验结果"><a href="#五、实验结果" class="headerlink" title="五、实验结果"></a>五、实验结果</h1><h2 id="5-1-与SOTA模型对比"><a href="#5-1-与SOTA模型对比" class="headerlink" title="5.1 与SOTA模型对比"></a>5.1 与SOTA模型对比</h2><p></p><div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/paper-SGNN-HN_5.png">
</div><p></p>
<h2 id="5-2-SGNN网络的作用"><a href="#5-2-SGNN网络的作用" class="headerlink" title="5.2 SGNN网络的作用"></a>5.2 SGNN网络的作用</h2><p>分别用自注意力网络(SAT)和门控图神经网络(GGNN)代替SGNN：</p>
<p></p><div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/paper-SGNN-HN_6.png">
</div><p></p>
<h2 id="5-3-HN网络层的作用"><a href="#5-3-HN网络层的作用" class="headerlink" title="5.3 HN网络层的作用"></a>5.3 HN网络层的作用</h2><p>HN网络对于不同数量GNN层的作用：</p>
<p></p><div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/paper-SGNN-HN_7.png">
</div><p></p>
<h2 id="5-4-Session长度的影响"><a href="#5-4-Session长度的影响" class="headerlink" title="5.4 Session长度的影响"></a>5.4 Session长度的影响</h2><p></p><div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/paper-SGNN-HN_8.png">
</div><p></p>
<h1 id="六、结论"><a href="#六、结论" class="headerlink" title="六、结论"></a>六、结论</h1><p>本文提出了SGNN-HN模型，一方面解决了一般GNN模型不能考虑高阶信息转换的问题，另一方面解决了GNN模型容易过拟合的问题。</p>
]]></content>
      <categories>
        <category>论文笔记</category>
      </categories>
      <tags>
        <tag>Attention</tag>
        <tag>深度学习</tag>
        <tag>SBRS</tag>
        <tag>paper</tag>
        <tag>GNN</tag>
      </tags>
  </entry>
  <entry>
    <title>PyTorch各种维度变换函数总结</title>
    <url>/2020/11/21/pytorch-function/</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>本文对于PyTorch中的各种维度变换的函数进行总结，包括<code>reshape()</code>、<code>view()</code>、<code>resize_()</code>、<code>transpose()</code>、<code>permute()</code>、<code>squeeze()</code>、<code>unsqeeze()</code>、<code>expand()</code>、<code>repeat()</code>函数的介绍和对比。</p>
<h1 id="contiguous"><a href="#contiguous" class="headerlink" title="contiguous"></a>contiguous</h1><p>区分各个维度转换函数的前提是需要了解<strong>contiguous</strong>。在PyTorch中，contiguous指的是<strong>Tensor底层一维数组的存储顺序和其元素顺序一致</strong>。</p>
<p>Tensor是以一维数组的形式存储的，C/C++使用<strong>行优先</strong>(按行展开)的方式，Python中的Tensor底层实现使用的是C，因此PyThon中的Tensor也是按行展开存储的，如果其<strong>存储顺序</strong>和<strong>按行优先展开的一维数组元素顺序</strong>一致，就说这个Tensor是连续(contiguous)的。</p>
<p><strong>形式化定义：</strong></p>
<p>对于任意的<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.216ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 523.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">d</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
</g>
</svg>维张量<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
</g>
</svg>，如果满足对于所有的<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
</g>
</svg>，第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
</g>
</svg>维相邻元素间隔=第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i+1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1568" y="0"></use>
</g>
</svg>维相邻元素间隔<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.808ex" height="1.509ex" style="vertical-align: 0.019ex; margin-bottom: -0.19ex;" viewBox="0 -576.1 778.5 649.8" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\times</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-D7" x="0" y="0"></use>
</g>
</svg>第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.805ex" height="2.343ex" style="vertical-align: -0.505ex;" viewBox="0 -791.3 2068.9 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i+1</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="567" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1568" y="0"></use>
</g>
</svg>维长度的乘积，则<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
</g>
</svg>是连续的：</p>
<script type="math/tex; mode=display">
stride[i]=stride[i+1]\times size[i+1],\forall i=0,\ldots,d-1(i\neq d-1)</script><ul>
<li><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.177ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3520.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">stride[i]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-73" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="469" y="0"></use>
 <use xlink:href="#E1-MJMATHI-72" x="831" y="0"></use>
 <use xlink:href="#E1-MJMATHI-69" x="1282" y="0"></use>
 <use xlink:href="#E1-MJMATHI-64" x="1628" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="2151" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2618" y="0"></use>
 <use xlink:href="#E1-MJMATHI-69" x="2896" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5D" x="3242" y="0"></use>
</g>
</svg>表示第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
</g>
</svg>维相邻元素之间间隔的位数，称为步长，可通过<code>stride()</code>方法获得。</li>
<li><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.161ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2652.5 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">size[i]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-7A" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-73" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-69" x="469" y="0"></use>
 <use xlink:href="#E1-MJMATHI-7A" x="815" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="1283" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="1750" y="0"></use>
 <use xlink:href="#E1-MJMATHI-69" x="2028" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5D" x="2374" y="0"></use>
</g>
</svg>表示固定其他维度时，第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
</g>
</svg>维的元素数量，即第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.802ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 345.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
</g>
</svg>维的长度，通过<code>size()</code>方法获得。</li>
</ul>
<blockquote>
<p>Python中的多维张量按照<strong>行优先展开</strong>的方式存储，访问矩阵中下一个元素是通过偏移来实现的，这个偏移量称为<strong>步长(stride)</strong>，比如python中，访问<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.165ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2223.9 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2\times3</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMAIN-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-32" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-D7" x="722" y="0"></use>
 <use xlink:href="#E1-MJMAIN-33" x="1723" y="0"></use>
</g>
</svg>矩阵的同一行中的相邻元素，物理结构需要偏移1个位置，即步长为1，同一列中的两个相邻元素则步长为3。</p>
</blockquote>
<p>举例说明：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python">&gt;&gt;&gt;t = torch.arange(<span class="hljs-number">12</span>).reshape(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)<br>&gt;&gt;&gt;t<br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>        [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],<br>        [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])<br>&gt;&gt;&gt;t.stride(),t.stride(<span class="hljs-number">0</span>),t.stride(<span class="hljs-number">1</span>) <span class="hljs-comment"># 返回t两个维度的步长，第0维的步长，第1维的步长</span><br>((<span class="hljs-number">4</span>,<span class="hljs-number">1</span>),<span class="hljs-number">4</span>,<span class="hljs-number">1</span>)<br><span class="hljs-comment"># 第0维的步长，表示沿着列的两个相邻元素，比如‘0’和‘4’两个元素的步长为4</span><br>&gt;&gt;&gt;t.size(<span class="hljs-number">1</span>)<br><span class="hljs-number">4</span><br><span class="hljs-comment"># 对于i=0，满足stride[0]=stride[1] * size[1]=1*4=4，那么t是连续的。</span><br></code></pre></td></tr></tbody></table></figure>
<p>PyTorch中的有一些操作没有真正地改变tensor的内容，只是改变了索引和元素的对应关系，操作之前和操作之后的数据是共享的。这些操作包括<code>narrow(),view(),expand(),transpose()</code>等<a href="#2"><sup>[2]</sup></a>。当执行这些函数时，原来语义上相邻、内存里也相邻的元素，可能会出现语义上相邻，但内存上不相邻的情况，就不连续(not contiguous)了。</p>
<p>PyTorch提供了两个关于contiguous的方法：</p>
<p><code>is_contiguous()</code>     : 判断Tensor是否是连续的<br><code>contiguous()</code>           : 返回新的Tensor，重新开辟一块内存，并且是连续的</p>
<p>举例说明(参考<a href="#1">[1]</a>)：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python">&gt;&gt;&gt;t = torch.arange(<span class="hljs-number">12</span>).reshape(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)<br>&gt;&gt;&gt;t<br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>        [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],<br>        [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])<br>&gt;&gt;&gt;t2 = t.transpose(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)<br>&gt;&gt;&gt;t2<br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">8</span>],<br>        [ <span class="hljs-number">1</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">9</span>],<br>        [ <span class="hljs-number">2</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>],<br>        [ <span class="hljs-number">3</span>,  <span class="hljs-number">7</span>, <span class="hljs-number">11</span>]])<br>&gt;&gt;&gt;t.data_ptr() == t2.data_ptr()  <span class="hljs-comment"># 返回两个张量的首元素的内存地址</span><br><span class="hljs-literal">True</span>    	<span class="hljs-comment">#说明底层数据是同一个一维数组</span><br>&gt;&gt;&gt;t.is_contiguous(),t2.is_contiguous()  <span class="hljs-comment"># t连续，t2不连续</span><br>(<span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>)<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，t和t2共享内存中的数据。如果对t2使用<code>contiguous()</code>方法，会开辟新的内存空间：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python">&gt;&gt;&gt;t3 = t2.contiguous()<br>&gt;&gt;&gt;t3<br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">8</span>],<br>        [ <span class="hljs-number">1</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">9</span>],<br>        [ <span class="hljs-number">2</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>],<br>        [ <span class="hljs-number">3</span>,  <span class="hljs-number">7</span>, <span class="hljs-number">11</span>]])<br>&gt;&gt;&gt;t3.data_ptr() == t2.data_ptr() <span class="hljs-comment"># 底层数据不是同一个一维数组</span><br><span class="hljs-literal">False</span><br>&gt;&gt;&gt;t3.is_contiguous()<br><span class="hljs-literal">True</span><br></code></pre></td></tr></tbody></table></figure>
<p>关于contiguous的更深入的解释可以参考<a href="#1">[1]</a>.</p>
<h1 id="view-reshape"><a href="#view-reshape" class="headerlink" title="view()/reshape()"></a>view()/reshape()</h1><h2 id="view"><a href="#view" class="headerlink" title="view()"></a>view()</h2><p>tensor.<a href="https://pytorch.org/docs/master/tensors.html?highlight=view#torch.Tensor.view">view()</a>函数返回一个和tensor共享底层数据，但不同形状的tensor。使用<code>view()</code>函数的要求是<strong>tensor必须是contiguous的</strong>。</p>
<p>用法如下：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python">&gt;&gt;&gt;t<br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>        [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],<br>        [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])<br>&gt;&gt;&gt;t2 = t.view(<span class="hljs-number">2</span>,<span class="hljs-number">6</span>)<br>&gt;&gt;&gt;t2<br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>],<br>        [ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])<br>&gt;&gt;&gt;t.data_ptr() == t2.data_ptr()	<span class="hljs-comment"># 二者的底层数据是同一个一维数组</span><br><span class="hljs-literal">True</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="reshape"><a href="#reshape" class="headerlink" title="reshape()"></a>reshape()</h2><p>tensor.<a href="https://pytorch.org/docs/master/generated/torch.reshape.html#torch.reshape">reshape()</a>类似于<code>tensor.contigous().view()</code>操作，如果tensor是连续的，则reshape()操作和view()相同，返回指定形状、共享底层数据的tensor；如果tensor是不连续的，则会开辟新的内存空间，返回指定形状的tensor，底层数据和原来的tensor是独立的，相当于先执行<code>contigous()</code>，再执行<code>view()</code>。</p>
<blockquote>
<p>如果不在意底层数据是否使用新的内存，建议使用<code>reshape()</code>代替<code>view()</code>.</p>
</blockquote>
<h1 id="resize"><a href="#resize" class="headerlink" title="resize_()"></a>resize_()</h1><p>tensor.<a href="https://pytorch.org/docs/master/tensors.html?highlight=resize#torch.Tensor.resize_">resize_()</a>函数，返回指定形状的tensor，与<code>reshape()</code>和<code>view()</code>不同的是，<code>resize_()</code>可以只截取tensor一部分数据，或者是元素个数大于原tensor也可以，会自动扩展新的位置。</p>
<p><code>resize_()</code>函数对于tensor的连续性无要求，且返回的值是共享的底层数据（同<code>view()</code>），也就是说只返回了指定形状的索引，底层数据不变的。</p>
<h1 id="transpose-permute"><a href="#transpose-permute" class="headerlink" title="transpose()/permute()"></a>transpose()/permute()</h1><blockquote>
<p><code>permute()</code>和<code>transpose()</code>还有<code>t()</code>是PyTorch中的转置函数，其中<code>t()</code>函数只适用于2维矩阵的转置，是这三个函数里面最”弱”的。</p>
</blockquote>
<h2 id="transpose"><a href="#transpose" class="headerlink" title="transpose()"></a>transpose()</h2><p>tensor.<a href="https://pytorch.org/docs/master/generated/torch.transpose.html#torch.transpose">transpose()</a>，返回tensor的指定维度的转置，底层数据共享，与<code>view()/reshape()</code>不同的是，<code>transpose()</code>只能实现维度上的转置，不能任意改变维度大小。</p>
<p>对于维度交换来说，<code>view()/reshape()</code>和<code>transpose()</code>有很大的区别，一定不要混用！混用了以后虽然不会报错，但是数据是乱的，血坑。</p>
<blockquote>
<p><code>reshape()/view()</code>和<code>transpose()</code>的区别在于对于维度改变的方式不同，前者是在存储顺序的基础上对维度进行划分，也就是说将存储的一维数组根据shape大小重新划分，而<code>transpose()</code>则是真正意义上的转置，比如二维矩阵的转置。</p>
</blockquote>
<p>举个例子：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python">&gt;&gt;&gt;t<br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>        [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],<br>        [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.transpose(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)	<span class="hljs-comment"># 交换t的前两个维度，即对t进行转置。</span><br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">8</span>],<br>        [ <span class="hljs-number">1</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">9</span>],<br>        [ <span class="hljs-number">2</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>],<br>        [ <span class="hljs-number">3</span>,  <span class="hljs-number">7</span>, <span class="hljs-number">11</span>]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>a.reshape(<span class="hljs-number">4</span>,<span class="hljs-number">3</span>)     <span class="hljs-comment"># 使用reshape()/view()的方法，虽然形状一样，但是数据排列完全不同</span><br>tensor([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>],<br>        [ <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>],<br>        [ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>],<br>        [ <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])<br></code></pre></td></tr></tbody></table></figure>
<h2 id="permute"><a href="#permute" class="headerlink" title="permute()"></a>permute()</h2><p>tensor.<a href="https://pytorch.org/docs/master/tensors.html?highlight=permute#torch.Tensor.permute">permute()</a>函数，以view的形式返回矩阵指定维度的转置，和<code>transpose()</code>功能相同。</p>
<p>与<code>transpose()</code>不同的是，<code>permute()</code>同时对多个维度进行转置，且参数是<strong>期望的维度的顺序</strong>，而<code>transpose()</code>只能同时对<strong>两个维度</strong>转置，即参数只能是两个，这两个参数没有顺序，只代表了哪两个维度进行转置。</p>
<p>举个例子：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>t				<span class="hljs-comment"># t的形状为(2,3,2)</span><br>tensor([[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>],<br>         [ <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>         [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>]],<br><br>        [[ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],<br>         [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>],<br>         [<span class="hljs-number">10</span>, <span class="hljs-number">11</span>]]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.transpose(<span class="hljs-number">0</span>,<span class="hljs-number">1</span>)   <span class="hljs-comment"># 使用transpose()将前两个维度进行转置，返回(3,2,2)</span><br>tensor([[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>],<br>         [ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>]],<br><br>        [[ <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>         [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>]],<br><br>        [[ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>],<br>         [<span class="hljs-number">10</span>, <span class="hljs-number">11</span>]]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.permute(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>)   <span class="hljs-comment"># 使用permute()按照指定的维度序列对t转置，返回(3,2,2)</span><br>tensor([[[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>],<br>         [ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>]],<br><br>        [[ <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],<br>         [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>]],<br><br>        [[ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>],<br>         [<span class="hljs-number">10</span>, <span class="hljs-number">11</span>]]])<br></code></pre></td></tr></tbody></table></figure>
<h1 id="squeeze-unsqueeze"><a href="#squeeze-unsqueeze" class="headerlink" title="squeeze()/unsqueeze()"></a>squeeze()/unsqueeze()</h1><h2 id="squeeze"><a href="#squeeze" class="headerlink" title="squeeze()"></a>squeeze()</h2><p>tensor.<a href="https://pytorch.org/docs/master/generated/torch.squeeze.html?highlight=squeeze#torch.squeeze">squeeze()</a>返回去除size为1的维度的tensor，默认去除所有size=1的维度，也可以指定去除某一个size=1的维度，并返回去除后的结果。</p>
<p>举个例子：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>t.shape <br>torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.squeeze().shape  <span class="hljs-comment"># 去除所有size=1的维度</span><br>torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">4</span>])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.squeeze(<span class="hljs-number">1</span>).shape  <span class="hljs-comment"># 去除第1维</span><br>torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.squeeze(<span class="hljs-number">0</span>).shape  <span class="hljs-comment">#　如果指定的维度size不等于1，则不执行任何操作。</span><br>torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>])<br></code></pre></td></tr></tbody></table></figure>
<h2 id="unsqueeze"><a href="#unsqueeze" class="headerlink" title="unsqueeze()"></a>unsqueeze()</h2><p>tensor.<a href="https://pytorch.org/docs/master/generated/torch.unsqueeze.html#torch.unsqueeze">unsqueeze()</a>与<code>squeeze()</code>相反，是在tensor插入新的维度，插入的维度size=1，用于维度扩展。</p>
<p>举个例子：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>t.shape<br>torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.unsqueeze(<span class="hljs-number">1</span>).shape   <span class="hljs-comment"># 在指定的位置上插入新的维度，size=1</span><br>torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>]) <br><span class="hljs-meta">&gt;&gt;&gt; </span>t.unsqueeze(<span class="hljs-number">-1</span>).shape  <span class="hljs-comment"># 参数为-1时表示在最后一维添加新的维度，size=1</span><br>torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.unsqueeze(<span class="hljs-number">4</span>).shape   <span class="hljs-comment"># 和dim=-1等价</span><br>torch.Size([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br></code></pre></td></tr></tbody></table></figure>
<h1 id="expand-repeat"><a href="#expand-repeat" class="headerlink" title="expand()/repeat()"></a>expand()/repeat()</h1><h2 id="expand"><a href="#expand" class="headerlink" title="expand()"></a>expand()</h2><p>tensor.<a href="https://pytorch.org/docs/master/tensors.html?highlight=tensor%20expand#torch.Tensor.expand">expand()</a>的功能是扩展tensor中的size为1的维度，且只能扩展size=1的维度。以view的形式返回tensor，即不改变原来的tensor，只是以视图的形式返回数据。</p>
<p>举个例子：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>t<br>tensor([[[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>         [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.shape<br>torch.Size([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.expand(<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)  <span class="hljs-comment"># 将第0维扩展为3，可见其将第0维复制了3次</span><br>tensor([[[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>         [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]],<br><br>        [[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>         [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]],<br><br>        [[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>         [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.expand(<span class="hljs-number">3</span>,<span class="hljs-number">-1</span>,<span class="hljs-number">-1</span>) <span class="hljs-comment"># dim=-1表示固定这个维度，效果是一样的，这样写更方便</span><br>tensor([[[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>         [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]],<br><br>        [[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>         [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]],<br><br>        [[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>         [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.expand(<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>).storage()    <span class="hljs-comment"># expand不扩展新的内存空间</span><br> <span class="hljs-number">0</span><br> <span class="hljs-number">1</span><br> <span class="hljs-number">2</span><br> <span class="hljs-number">3</span><br> <span class="hljs-number">4</span><br> <span class="hljs-number">5</span><br>[torch.LongStorage of size <span class="hljs-number">6</span>]<br></code></pre></td></tr></tbody></table></figure>
<h2 id="repeat"><a href="#repeat" class="headerlink" title="repeat()"></a>repeat()</h2><p>tensor.<a href="https://pytorch.org/docs/master/tensors.html?highlight=repeat#torch.Tensor.repeat">repeat()</a>用于维度复制，可以将size为任意大小的维度复制为n倍，和<code>expand()</code>不同的是，<code>repeat()</code>会分配新的存储空间，是真正的复制数据。</p>
<p>举个例子：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span>t<br>tensor([[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>        [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.shape<br>torch.Size([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.repeat(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>)  <span class="hljs-comment"># 将两个维度分别复制2、3倍</span><br>tensor([[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>        [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],<br>        [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],<br>        [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]])<br><span class="hljs-meta">&gt;&gt;&gt; </span>t.repeat(<span class="hljs-number">2</span>,<span class="hljs-number">3</span>).storage()   <span class="hljs-comment"># repeat()是真正的复制，会分配新的空间</span><br> <span class="hljs-number">0</span><br> <span class="hljs-number">1</span><br> <span class="hljs-number">2</span><br> <span class="hljs-number">0</span><br> <span class="hljs-number">1</span><br> <span class="hljs-number">2</span><br> <span class="hljs-number">0</span><br> <span class="hljs-number">1</span><br> <span class="hljs-number">2</span><br> <span class="hljs-number">3</span><br> <span class="hljs-number">4</span><br> <span class="hljs-number">5</span><br> ......<br> <span class="hljs-number">3</span><br> <span class="hljs-number">4</span><br> <span class="hljs-number">5</span><br>[torch.LongStorage of size <span class="hljs-number">36</span>]<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>如果维度size=1的时候，<code>repeat()</code>和<code>expand()</code>的作用是一样的，但是<code>expand()</code>不会分配新的内存，所以优先使用<code>expand()</code>函数。</p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li><code>view()/reshape()</code>两个函数用于<strong>将tensor变换为任意形状</strong>，本质是将所有的元素<strong>重新分配</strong>。</li>
<li><code>t()/transpose()/permute()</code>用于<strong>维度的转置</strong>，转置和<code>reshape()</code>操作是有区别的，注意区分。</li>
<li><code>squeeze()/unsqueeze()</code>用于<strong>压缩/扩展维度</strong>，仅在维度的<strong>个数</strong>上去除/添加，且去除/添加的维度size=1。</li>
<li><code>expand()/repeat()</code>用于<strong>数据的复制</strong>，对一个或多个维度上的数据进行复制。</li>
<li>以上提到的函数仅有两种会分配新的内存空间：<code>reshape()</code>操作处理非连续的tensor时，返回tensor的copy数据会分配新的内存；<code>repeat()</code>操作会分配新的内存空间。其余的操作都是返回的视图，底层数据是共享的，仅在索引上重新分配。</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><span id="1">1. </span><a href="https://zhuanlan.zhihu.com/p/64551412">PyTorch中的contiguous</a></p>
<p><span id="2">2. </span><a href="https://stackoverflow.com/questions/48915810/pytorch-contiguous#">stackoverflow-pytorch-contiguous</a></p>
<p><span id="3">3. </span><a href="https://pytorch.org/docs/master/index.html">PyTorch官方文档</a></p>
]]></content>
      <categories>
        <category>PyTorch</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>PyTorch</tag>
      </tags>
  </entry>
  <entry>
    <title>单链表反转</title>
    <url>/2020/12/05/reverse-linkedlist/</url>
    <content><![CDATA[<blockquote>
<p>前几天做题遇到了链表反转的问题，即<a href="https://leetcode-cn.com/problems/cong-wei-dao-tou-da-yin-lian-biao-lcof/">剑指offer06</a>和<a href="https://leetcode-cn.com/problems/fan-zhuan-lian-biao-lcof/">24</a>，涉及到了链表反转的知识。奈何本人太菜，早已忘了数据结构课本中链表反转的具体操作，这里记录并复习一下有关单向链表反转的几种方法。</p>
<p>参考链接：<a href="http://c.biancheng.net/view/8105.html">单链表反转详解</a></p>
</blockquote>
<h1 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h1><p>链表节点定义如下(python)：</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ListNode</span>:</span>		<span class="hljs-comment"># 定义链表节点</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, x</span>):</span><br>        self.val = x<br>        self.<span class="hljs-built_in">next</span> = <span class="hljs-literal">None</span><br></code></pre></td></tr></tbody></table></figure>
<p>原链表：1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL</p>
<p>反转后：5-&gt;4-&gt;3-&gt;2-&gt;1-&gt;NULL</p>
<h1 id="新建链表法"><a href="#新建链表法" class="headerlink" title="新建链表法"></a>新建链表法</h1><p>新建链表法的主要思想是新建一个链表，保证其与原链表顺序相反，然后返回新链表，实现原链表的反转。新建反转链表有两种方法，一种是使用头插法新建链表，另一种是使用辅助栈(或者数组等)。这类方法的主要特点是需要使用额外的存储空间。</p>
<h2 id="头插法"><a href="#头插法" class="headerlink" title="头插法"></a>头插法</h2><p>使用头插法新建一个链表(虽说是新链表，只是换了个头指针，但没有使用新的存储空间)，每次将新节点插入到新链表头节点之后，然后返回新链表实现反转。</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reverseList</span>(<span class="hljs-params">self, head: ListNode</span>) -&gt; ListNode:</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> head <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> head.<span class="hljs-built_in">next</span>: <span class="hljs-keyword">return</span> head<br>    new_head = <span class="hljs-literal">None</span>         <span class="hljs-comment"># 新链表的头指针</span><br>    tmp = <span class="hljs-literal">None</span>				<span class="hljs-comment"># 临时指针tmp，用于保存原链表的当前头节点</span><br>    <span class="hljs-keyword">while</span> head:<br>        tmp = head			<span class="hljs-comment"># 指向当前头节点</span><br>        head = head.<span class="hljs-built_in">next</span>	<span class="hljs-comment"># 当前头指针后移。这条语句一定要在tmp.next=new_head的前面</span><br><br>        <span class="hljs-comment"># 将tmp节点加入到新链表的头节点后面(头插法)</span><br>        tmp.<span class="hljs-built_in">next</span> = new_head <br>        new_head = tmp<br>    <span class="hljs-keyword">return</span> new_head<br></code></pre></td></tr></tbody></table></figure>
<ul>
<li>时间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2431 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(N)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2041" y="0"></use>
</g>
</svg>：遍历链表使用线性大小空间。</li>
<li>空间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg>：只需要两个额外的指针，没有额外使用存储空间</li>
</ul>
<h2 id="辅助栈新建链表"><a href="#辅助栈新建链表" class="headerlink" title="辅助栈新建链表"></a>辅助栈新建链表</h2><p>第二种方式是使用辅助栈的方法，将原链表依次入栈，然后新建链表，将栈中的元素依次出栈作为新链表的下一个节点，则新链表即为原链表的反转链表。</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reverseList</span>(<span class="hljs-params">self, head: ListNode</span>) -&gt; ListNode:</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> head <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> head.<span class="hljs-built_in">next</span>: <span class="hljs-keyword">return</span> head<br>    stack = []   	<span class="hljs-comment"># 用列表表示栈</span><br>    <span class="hljs-keyword">while</span> head:		<span class="hljs-comment"># 将原链表的值依次入栈</span><br>        stack.append(head.val)<br>        head = head.<span class="hljs-built_in">next</span><br>    new_head = ListNode(stack.pop())  <span class="hljs-comment"># 注意这里的头节点是有值的</span><br>    cur = new_head		<span class="hljs-comment"># cur用于尾插法构建新链表，理解为向后移动的指针</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(stack)): 	<span class="hljs-comment"># 将栈中数据出栈，并构建新链表</span><br>        cur.<span class="hljs-built_in">next</span> = ListNode(stack.pop())<br>        cur = cur.<span class="hljs-built_in">next</span><br>    <span class="hljs-keyword">return</span> new_head			<span class="hljs-comment"># 返回新链表。将new_head和cur都理解为指针</span><br></code></pre></td></tr></tbody></table></figure>
<ul>
<li>时间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2431 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(N)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2041" y="0"></use>
</g>
</svg>：遍历链表使用线性大小空间。</li>
<li>空间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2431 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(N)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2041" y="0"></use>
</g>
</svg>：额外辅助空间和新建链表的存储空间，均为线性大小。</li>
</ul>
<h1 id="迭代遍历法-双指针"><a href="#迭代遍历法-双指针" class="headerlink" title="迭代遍历法(双指针)"></a>迭代遍历法(双指针)</h1><p>迭代反转法(原地反转法)，从当前链表的头结点开始，一直遍历到链表的最后一个节点，期间逐个改变节点指针的方向，使其指向前一个节点，返回最后一个位置的指针(或者说将头指针指向最后一个位置)。参考<a href="https://leetcode-cn.com/problems/fan-zhuan-lian-biao-lcof/solution/jian-zhi-offer-24-fan-zhuan-lian-biao-die-dai-di-2/">链接</a></p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reverseList</span>(<span class="hljs-params">self, head: ListNode</span>) -&gt; ListNode:</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> head <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> head.<span class="hljs-built_in">next</span>: <span class="hljs-keyword">return</span> head<br>    pre,cur = <span class="hljs-literal">None</span>, head  <span class="hljs-comment"># pre初始化为空节点，可以理解为头节点的前一个节点</span><br>    <span class="hljs-keyword">while</span> cur:<br>        tmp = cur.<span class="hljs-built_in">next</span>	<span class="hljs-comment"># 暂时存放当前节点的后继节点</span><br>        cur.<span class="hljs-built_in">next</span> = pre	<span class="hljs-comment"># 修改当前节点的指针方向</span><br>        pre = cur		<span class="hljs-comment"># pre暂存cur(pre右移)</span><br>        cur = tmp		<span class="hljs-comment"># cur指针右移，访问下一节点</span><br>    <span class="hljs-keyword">return</span> pre  		<span class="hljs-comment"># 最后返回pre指针，作为头指针，或者说是将头指针指向pre，实现反转。 </span><br></code></pre></td></tr></tbody></table></figure>
<ul>
<li>时间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2431 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(N)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2041" y="0"></use>
</g>
</svg>：遍历链表使用线性大小空间。</li>
<li>空间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg>：变量<code>pre</code>和<code>cur</code>使用常数大小额外空间。</li>
</ul>
<h1 id="就地逆置法"><a href="#就地逆置法" class="headerlink" title="就地逆置法"></a>就地逆置法</h1><p>就地逆置法(也叫头插法)，与头插法新建链表类似，不同的是不需要新链表，只需要用两个指针对原链表本身进行操作，将每个节点依次插入到头节点后面，最后返回头节点。</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reverseList</span>(<span class="hljs-params">self, head: ListNode</span>) -&gt; ListNode:</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> head <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> head.<span class="hljs-built_in">next</span>: <span class="hljs-keyword">return</span> head<br>    pre, cur = head, head.<span class="hljs-built_in">next</span><br>    <span class="hljs-keyword">while</span> cur:<br>        pre.<span class="hljs-built_in">next</span> = cur.<span class="hljs-built_in">next</span>		<span class="hljs-comment"># 将cur指向的节点"摘除"</span><br>        cur.nxet = head		<span class="hljs-comment"># 将上一步“摘除”的节点放到head的前面，此时头节点为cur指向的节点</span><br>        head = cur		<span class="hljs-comment"># head更新，重新指向头节点</span><br>        cur = pre.<span class="hljs-built_in">next</span>		<span class="hljs-comment"># cur重新指向pre的next节点</span><br>    <span class="hljs-keyword">return</span> head<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>此方法和上面提到的头插法大同小异，一个是返回原来的头指针,一个是返回新指针。此方法中的<strong>原链表头指针不动</strong>，上面的头插法的原链表头指针是移动的。</p>
<p>这两种方法都可以叫做头插法。</p>
</blockquote>
<ul>
<li>时间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2431 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(N)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2041" y="0"></use>
</g>
</svg>：遍历链表使用线性大小空间。</li>
<li>空间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg>：变量<code>pre</code>和<code>cur</code>使用常数大小额外空间。</li>
</ul>
<h1 id="递归法"><a href="#递归法" class="headerlink" title="递归法"></a>递归法</h1><p>递归法的思想是递归到停止条件，即链尾，然后逐层返回递归结果(从后向前将链表的指向反向)。</p>
<figure class="highlight python"><table><tbody><tr><td class="code"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">reverseList</span>(<span class="hljs-params">self, head: ListNode</span>) -&gt; ListNode:</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> head <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> head.<span class="hljs-built_in">next</span>: <span class="hljs-keyword">return</span> head<br>    new_head = self.reverseList(head.<span class="hljs-built_in">next</span>)   <span class="hljs-comment"># 一直递归，找到链表中最后一个节点</span><br>    <br>    <span class="hljs-comment"># 当逐层退出时，new_head 的指向都不变，一直指向原链表中最后一个节点；</span><br>    <span class="hljs-comment"># 递归每退出一层，函数中 head 指针的指向都会发生改变，都指向上一个节点。</span><br>    <br>    <span class="hljs-comment"># 每退出一层，都需要改变 head-&gt;next 节点指针域的指向，同时令 head 所指节点的指针域为None。</span><br>    head.<span class="hljs-built_in">next</span>.<span class="hljs-built_in">next</span> = head<br>    head.<span class="hljs-built_in">next</span> = <span class="hljs-literal">None</span><br>    <br>    <span class="hljs-comment"># 每一层递归结束，都要将新的头指针返回给上一层。</span><br>    <span class="hljs-comment"># 由此，即可保证整个递归过程中，能够一直找得到新链表的表头。</span><br>    <span class="hljs-keyword">return</span> new_head<br>    <br></code></pre></td></tr></tbody></table></figure>
<ul>
<li>时间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.646ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2431 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(N)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="2041" y="0"></use>
</g>
</svg>：一遍递归深入并返回</li>
<li>空间复杂度<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg>：不需要额外空间，只需要两个指针(但迭代过程需要一直创建/释放)</li>
</ul>
<blockquote>
<p>这递归太难理解了 :-( ，建议看大佬题解<a href="https://leetcode-cn.com/problems/fan-zhuan-lian-biao-lcof/solution/dong-hua-yan-shi-duo-chong-jie-fa-206-fan-zhuan-li/">剑指offer24题解</a>或者<a href="http://c.biancheng.net/view/8105.html">单链表反转详解</a>。</p>
</blockquote>
]]></content>
      <categories>
        <category>算法笔记</category>
      </categories>
      <tags>
        <tag>链表</tag>
        <tag>数据结构</tag>
      </tags>
  </entry>
  <entry>
    <title>自注意力和Transformer</title>
    <url>/2020/11/15/transformer/</url>
    <content><![CDATA[<blockquote>
<p>参考链接：</p>
<p>[1] 邱锡鹏：<a href="https://nndl.github.io/">神经网络与深度学习</a></p>
<p>[2] Jay Alammar：<a href="http://jalammar.github.io/illustrated-transformer/">Illustrated Transformer</a></p>
<p>[3] <a href="https://zhuanlan.zhihu.com/p/105493618">深度学习-图解Transformer(变形金刚)</a></p>
<p>[4] <a href="https://zhuanlan.zhihu.com/p/48508221">详解Transformer</a></p>
</blockquote>
<h1 id="自注意力"><a href="#自注意力" class="headerlink" title="自注意力"></a>自注意力</h1><p>在讲述Transformer之前，首先介绍Self-Attention模型。</p>
<p>传统的RNN虽然理论上可以建立输入信息的长距离依赖关系，但是由于信息传递的容量和梯度消失的问题，实际上只能建立短距离（局部）依赖关系。为了建立输入序列之间的长距离依赖关系，并利用注意力机制来“动态”地生成不同连接的权重，诞生了<strong>自注意力模型(Self-Attention Model)</strong></p>
<p>自注意力模型采用查询-键-值(Query-Key-Value,QKV)模式，计算过程如下图，红色字母表示维度：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/transformer_1.png" <="" img="">
</div>

<p>计算过程：</p>
<ul>
<li><p>输入序列<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.371ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 11784.7 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{X}=[\boldsymbol{x}_1,\ldots,\boldsymbol{x}_N]\in \mathbb{R}^{D_x \times N}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1231" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2287" y="0"></use>
<g transform="translate(2566,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="932" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3679" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="4124" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="5463" y="0"></use>
<g transform="translate(5908,0)">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="932" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="7296" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="7853" y="0"></use>
<g transform="translate(8798,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-78" x="1020" y="-185"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1393" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="2171" y="0"></use>
</g>
</g>
</g>
</svg></p>
</li>
<li><p>生成三个向量序列：</p>
<script type="math/tex; mode=display">
\begin{align}
\boldsymbol{Q}=\boldsymbol{W}_q \boldsymbol{X} \in \mathbb{R}^{D_k \times N}  \tag{1}\\
\boldsymbol{K}=\boldsymbol{W}_k \boldsymbol{X} \in \mathbb{R}^{D_k \times N}  \tag{2}\\
\boldsymbol{V}=\boldsymbol{W}_v \boldsymbol{X} \in \mathbb{R}^{D_v \times N}  \tag{3}
\end{align}</script><p>其中，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.066ex" height="3.343ex" style="vertical-align: -1.005ex;" viewBox="0 -1006.6 6056.3 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{W}_q \in \mathbb{R}^{D_k \times D_x}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-57" d="M111 624Q109 624 102 624T91 623Q61 623 61 640Q61 660 70 678Q78 686 98 686Q140 684 239 684Q277 684 309 684T360 685T383 686H385Q407 686 407 668Q404 634 391 626Q387 624 348 624Q307 624 307 622Q307 618 332 409Q359 198 359 195L570 532L564 576L558 622V624H522H504Q472 624 472 641Q475 678 488 684L493 686L529 685Q551 684 645 684Q716 684 753 685T795 686Q818 686 818 669Q815 632 802 626Q798 624 759 624Q718 624 718 622Q718 615 743 410Q770 199 770 196Q770 195 806 253T903 406Q1035 618 1035 619Q1025 624 968 624Q943 624 943 641Q943 648 946 659Q950 675 952 679T963 686L998 685Q1020 684 1093 684Q1113 684 1139 685T1173 686Q1207 686 1207 669Q1207 664 1204 652Q1199 631 1194 628T1164 624Q1113 622 1101 615Q1098 612 905 305Q715 -1 709 -7Q699 -17 673 -17Q645 -17 639 -8L581 441Q581 444 442 221Q331 44 314 18T288 -14Q279 -17 263 -17H254Q229 -17 227 -5Q225 2 186 311L147 620V624H111Z"></path>
<path stroke-width="1" id="E1-MJMATHI-71" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-71" x="1546" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1796" y="0"></use>
<g transform="translate(2742,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-6B" x="1020" y="-271"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1351" y="0"></use>
<g transform="translate(1506,0)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-78" x="1020" y="-185"></use>
</g>
</g>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.166ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 6099.4 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{W}_k \in \mathbb{R}^{D_k \times D_x}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-57" d="M111 624Q109 624 102 624T91 623Q61 623 61 640Q61 660 70 678Q78 686 98 686Q140 684 239 684Q277 684 309 684T360 685T383 686H385Q407 686 407 668Q404 634 391 626Q387 624 348 624Q307 624 307 622Q307 618 332 409Q359 198 359 195L570 532L564 576L558 622V624H522H504Q472 624 472 641Q475 678 488 684L493 686L529 685Q551 684 645 684Q716 684 753 685T795 686Q818 686 818 669Q815 632 802 626Q798 624 759 624Q718 624 718 622Q718 615 743 410Q770 199 770 196Q770 195 806 253T903 406Q1035 618 1035 619Q1025 624 968 624Q943 624 943 641Q943 648 946 659Q950 675 952 679T963 686L998 685Q1020 684 1093 684Q1113 684 1139 685T1173 686Q1207 686 1207 669Q1207 664 1204 652Q1199 631 1194 628T1164 624Q1113 622 1101 615Q1098 612 905 305Q715 -1 709 -7Q699 -17 673 -17Q645 -17 639 -8L581 441Q581 444 442 221Q331 44 314 18T288 -14Q279 -17 263 -17H254Q229 -17 227 -5Q225 2 186 311L147 620V624H111Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6B" x="1546" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1840" y="0"></use>
<g transform="translate(2785,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-6B" x="1020" y="-271"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1351" y="0"></use>
<g transform="translate(1506,0)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-78" x="1020" y="-185"></use>
</g>
</g>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="14.059ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 6053.3 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{W}_v \in \mathbb{R}^{D_v \times D_x}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-57" d="M111 624Q109 624 102 624T91 623Q61 623 61 640Q61 660 70 678Q78 686 98 686Q140 684 239 684Q277 684 309 684T360 685T383 686H385Q407 686 407 668Q404 634 391 626Q387 624 348 624Q307 624 307 622Q307 618 332 409Q359 198 359 195L570 532L564 576L558 622V624H522H504Q472 624 472 641Q475 678 488 684L493 686L529 685Q551 684 645 684Q716 684 753 685T795 686Q818 686 818 669Q815 632 802 626Q798 624 759 624Q718 624 718 622Q718 615 743 410Q770 199 770 196Q770 195 806 253T903 406Q1035 618 1035 619Q1025 624 968 624Q943 624 943 641Q943 648 946 659Q950 675 952 679T963 686L998 685Q1020 684 1093 684Q1113 684 1139 685T1173 686Q1207 686 1207 669Q1207 664 1204 652Q1199 631 1194 628T1164 624Q1113 622 1101 615Q1098 612 905 305Q715 -1 709 -7Q699 -17 673 -17Q645 -17 639 -8L581 441Q581 444 442 221Q331 44 314 18T288 -14Q279 -17 263 -17H254Q229 -17 227 -5Q225 2 186 311L147 620V624H111Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-76" x="1546" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1814" y="0"></use>
<g transform="translate(2759,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-76" x="1020" y="-185"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1322" y="0"></use>
<g transform="translate(1485,0)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-78" x="1020" y="-185"></use>
</g>
</g>
</g>
</g>
</svg>分别为线性映射的参数矩阵，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.856ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 7257.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{Q}=[\boldsymbol{q}_1,\ldots,\boldsymbol{q}_N]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-51" d="M53 245Q53 297 70 356T125 478T216 590T349 671T523 703Q656 703 735 637T815 445Q815 410 808 370T781 277T729 178T643 87T519 14L525 4Q540 -19 553 -25T592 -32Q632 -32 654 -24T680 -7T689 10T704 18Q713 18 717 12T722 0Q722 -8 711 -36T681 -101T624 -166T541 -194Q513 -194 494 -183T465 -157T450 -118T444 -79T443 -41V-7L433 -9Q391 -17 344 -17Q301 -17 263 -10T185 15T118 62T71 138T53 245ZM666 482Q666 529 652 563T614 615T565 640T512 648Q412 648 335 573Q268 506 235 389T201 202Q201 164 210 136T230 95T259 66L262 76Q269 109 302 135T382 162Q401 162 415 159T449 140T484 92L491 78L496 82Q502 86 505 88T515 97T528 107T541 120T555 137T570 156T585 179T599 205T612 235Q629 278 647 351T666 482ZM439 56Q439 58 439 62T435 75T426 92T410 106T383 112Q353 112 332 96T311 63Q311 38 355 38H366Q391 39 415 45T439 56Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-51" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1147" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2203" y="0"></use>
<g transform="translate(2482,0)">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="767" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3478" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="3923" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="5262" y="0"></use>
<g transform="translate(5707,0)">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="767" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="6978" y="0"></use>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="17.455ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 7515.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{K}=[\boldsymbol{k}_1,\ldots,\boldsymbol{k}_N]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-4B" d="M536 0Q522 6 522 18Q522 35 533 57Q539 62 557 62Q595 62 601 65L472 330L365 255L342 160Q318 65 317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L422 481Q386 339 386 337L785 621Q779 624 749 624Q726 624 726 641Q726 645 730 659Q734 675 736 679T747 686L786 685Q812 684 888 684Q908 684 934 685T968 686Q1003 686 1003 669Q1003 646 991 629Q985 624 967 624Q918 624 888 617Q884 617 874 613L865 609Q864 608 732 515T599 420Q599 418 686 242T775 65Q784 62 829 62Q847 62 850 61T860 54Q862 52 862 43Q862 10 845 1Q844 1 842 1T836 0T797 1T694 2Q599 2 573 1L536 0Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-6B" d="M99 -8Q71 -8 58 9T45 39Q45 51 116 336L188 622H184Q183 622 179 622T169 623T157 624T146 624T136 624T131 625Q119 628 119 642Q119 647 123 661T129 679Q133 684 144 685T220 690Q293 694 307 694Q324 694 328 679Q328 674 280 482Q231 290 231 287Q231 285 234 286Q259 302 294 334T356 390T420 433T493 452Q528 452 546 427T564 364Q564 308 538 282T480 256Q456 256 441 269T425 308Q425 339 444 359T483 384L502 389Q502 395 496 398Q493 400 483 400Q465 400 449 395T409 374T373 347T323 305T268 257Q274 256 282 256Q312 251 329 247T371 232T411 202Q431 181 431 146Q431 132 427 110T422 73Q422 44 440 44H442Q462 44 478 64T502 102T514 141Q518 157 522 159T547 162H558Q578 162 578 148Q578 118 537 56T440 -7H432Q374 -7 337 21T299 94Q299 103 301 116T304 139Q304 164 281 181T235 202L212 206H211Q176 47 160 24Q137 -8 99 -8Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-4B" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1281" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2337" y="0"></use>
<g transform="translate(2616,0)">
 <use xlink:href="#E1-MJMATHBI-6B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="854" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3674" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="4119" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="5458" y="0"></use>
<g transform="translate(5903,0)">
 <use xlink:href="#E1-MJMATHBI-6B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="854" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="7236" y="0"></use>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="17.011ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 7324.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{V}=[\boldsymbol{v}_1,\ldots,\boldsymbol{v}_N]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-56" d="M401 686Q415 680 415 668Q415 651 404 629Q398 624 356 624Q318 624 318 623Q318 620 337 508T377 284L397 174L472 285Q548 396 623 507T699 620Q698 621 652 624Q634 624 627 627T619 641Q619 648 622 658Q627 677 631 681T650 686Q654 686 686 685T766 684Q794 684 823 684T858 685Q874 685 878 683T886 671Q886 667 882 651Q877 632 873 628T850 624Q800 624 779 617Q774 617 770 613Q767 610 560 304T350 -5Q346 -9 332 -16H306H291Q270 -16 267 -2Q267 -1 260 37T238 161T210 313L156 624H116H94Q62 624 62 642Q66 678 78 684Q82 686 99 686Q144 684 246 684Q330 684 368 685L401 686Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-76" d="M380 367Q380 397 406 425T465 453Q493 453 516 430T540 357Q540 314 524 250T467 115T373 13Q338 -8 292 -8Q218 -8 167 23T116 129Q116 178 152 275T189 388Q189 396 187 398T176 401Q148 398 125 372T89 304Q84 288 81 285T61 282H55H44Q24 282 24 296Q24 306 34 330T64 382T116 431T189 452Q231 452 269 429T308 362Q308 346 273 255T238 114Q238 43 306 43Q336 43 363 65T407 118T437 182T456 239T462 268Q462 290 417 315Q380 335 380 367Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-56" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1164" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2220" y="0"></use>
<g transform="translate(2499,0)">
 <use xlink:href="#E1-MJMATHBI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="802" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3520" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="3965" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="5304" y="0"></use>
<g transform="translate(5749,0)">
 <use xlink:href="#E1-MJMATHBI-76" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="802" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="7045" y="0"></use>
</g>
</svg>分别是由<strong>查询向量</strong>、<strong>键向量</strong>和<strong>值向量</strong>构成的矩阵。</p>
<blockquote>
<p>注意：Self-Attention中通常使用点积来计算注意力打分，这里的查询向量Q和键向量K的维度是相同的。</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>最终的输出序列是<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="27.469ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 11826.8 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{H}=[\boldsymbol{h}_1,\ldots,\boldsymbol{h}_N]\in \mathbb{R}^{D_v \times N}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-48" d="M258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L399 389Q399 388 547 388H695L753 623Q753 624 709 624H686Q665 624 660 626T650 639Q653 678 668 684Q672 686 681 686Q685 686 726 685T847 684Q902 684 937 684T986 685T1004 686Q1027 686 1027 668Q1023 632 1011 626Q1006 624 957 624H908L839 344Q768 64 768 63T812 62H839Q871 62 871 44Q867 6 854 2L850 0L808 1Q782 2 675 2Q600 2 560 1T516 0Q499 0 494 15Q498 54 511 60Q515 62 564 62H613L614 66L679 324Q679 326 531 326H383L382 322L317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-68" d="M477 56Q477 48 479 46T490 43Q522 45 544 75T577 140Q582 156 585 159T605 162H611H622Q642 162 642 148Q642 138 632 114T602 62T550 13T478 -8Q429 -8 394 17T358 83Q358 95 395 199T433 350Q433 400 394 400H388H383Q335 400 291 363Q256 332 236 298Q233 293 202 170T169 40Q160 18 141 5T99 -8Q70 -8 58 9T45 39Q45 51 116 336L188 622H184Q183 622 179 622T169 623T157 624T146 624T136 624T131 625Q119 628 119 642Q119 647 123 661T129 679Q133 684 144 685T220 690Q293 694 307 694Q324 694 328 679Q328 672 294 540Q286 507 278 473T264 420L260 403Q260 400 269 408Q327 451 393 451H401H410Q425 451 439 450T476 442T515 424T544 391T556 337Q556 286 517 179T477 56Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-48" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="1305" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2361" y="0"></use>
<g transform="translate(2640,0)">
 <use xlink:href="#E1-MJMATHBI-68" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="945" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3762" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="4207" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="5546" y="0"></use>
<g transform="translate(5991,0)">
 <use xlink:href="#E1-MJMATHBI-68" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="945" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="7388" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="7945" y="0"></use>
<g transform="translate(8890,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-76" x="1020" y="-185"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1322" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4E" x="2101" y="0"></use>
</g>
</g>
</g>
</svg>，其中的输出向量<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.771ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 1193.1 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{h}_n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-68" d="M477 56Q477 48 479 46T490 43Q522 45 544 75T577 140Q582 156 585 159T605 162H611H622Q642 162 642 148Q642 138 632 114T602 62T550 13T478 -8Q429 -8 394 17T358 83Q358 95 395 199T433 350Q433 400 394 400H388H383Q335 400 291 363Q256 332 236 298Q233 293 202 170T169 40Q160 18 141 5T99 -8Q70 -8 58 9T45 39Q45 51 116 336L188 622H184Q183 622 179 622T169 623T157 624T146 624T136 624T131 625Q119 628 119 642Q119 647 123 661T129 679Q133 684 144 685T220 690Q293 694 307 694Q324 694 328 679Q328 672 294 540Q286 507 278 473T264 420L260 403Q260 400 269 408Q327 451 393 451H401H410Q425 451 439 450T476 442T515 424T544 391T556 337Q556 286 517 179T477 56Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-68" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="945" y="-213"></use>
</g>
</svg>使用键值对计算方法计算：</p>
<script type="math/tex; mode=display">
\begin{align}
\boldsymbol{h}_n &= \mbox{att}((\boldsymbol{K},\boldsymbol{V}),\boldsymbol{q}_n)\\
&=\sum_{j=1}^N \alpha_{nj} \boldsymbol{v}_j \\
&=\sum_{j=1}^N \mbox{softmax}(s(\boldsymbol{k}_j,\boldsymbol{q}_n)) \boldsymbol{v}_j \tag{4}
\end{align}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.781ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 5072.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n,j\in[1,N]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6A" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4E" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="600" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6A" x="1045" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1735" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="2681" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="2959" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="3460" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4E" x="3905" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5D" x="4793" y="0"></use>
</g>
</svg>为输出和输入向量序列的位置，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.384ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1456.8 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\alpha_{nj}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B1" d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6A" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3B1" x="0" y="0"></use>
<g transform="translate(640,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6A" x="600" y="0"></use>
</g>
</g>
</svg>表示第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.395ex" height="1.676ex" style="vertical-align: -0.338ex;" viewBox="0 -576.1 600.5 721.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">n</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
</g>
</svg>个输出关注到第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.985ex" height="2.509ex" style="vertical-align: -0.671ex; margin-left: -0.027ex;" viewBox="-11.5 -791.3 424 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6A" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6A" x="0" y="0"></use>
</g>
</svg>个输入的权重。</p>
</li>
<li><p>如果使用<strong>缩放点积</strong>来作为打分函数的话，输出向量序列可以简写为：</p>
<script type="math/tex; mode=display">
\boldsymbol{H}=\mbox{softmax}(\frac{\boldsymbol{Q} \boldsymbol{K}^T}{\sqrt{D_k}}) \boldsymbol{V} \tag{5}</script></li>
</ul>
<blockquote>
<p>公式(5)的写法中，softmax函数<strong>按行</strong>进行归一化，即每一行进行归一化，归一化方法根据公式的写法决定。</p>
</blockquote>
<p>自注意力模型可以作为神经网络的一层来使用，既可以用来替换卷积层和循环层，也可以和它们一起交替使用。</p>
<p>由于自注意力模型的权重<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.965ex" height="2.343ex" style="vertical-align: -1.005ex;" viewBox="0 -576.1 1276.5 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\alpha_{ij}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-3B1" d="M34 156Q34 270 120 356T309 442Q379 442 421 402T478 304Q484 275 485 237V208Q534 282 560 374Q564 388 566 390T582 393Q603 393 603 385Q603 376 594 346T558 261T497 161L486 147L487 123Q489 67 495 47T514 26Q528 28 540 37T557 60Q559 67 562 68T577 70Q597 70 597 62Q597 56 591 43Q579 19 556 5T512 -10H505Q438 -10 414 62L411 69L400 61Q390 53 370 41T325 18T267 -2T203 -11Q124 -11 79 39T34 156ZM208 26Q257 26 306 47T379 90L403 112Q401 255 396 290Q382 405 304 405Q235 405 183 332Q156 292 139 224T121 120Q121 71 146 49T208 26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6A" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-3B1" x="0" y="0"></use>
<g transform="translate(640,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6A" x="345" y="0"></use>
</g>
</g>
</svg>只依赖于<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.837ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 790.8 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">q_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-71" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-71" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="631" y="-213"></use>
</g>
</svg>和<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.121ex" height="2.843ex" style="vertical-align: -1.005ex;" viewBox="0 -791.3 913.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">k_j</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6A" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6B" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6A" x="737" y="-213"></use>
</g>
</svg>的相关性，忽略了输入信息的位置信息，因此单独使用时，一般需要加入位置编码信息进行修正，Transformer中就是这么做的。</p>
<h1 id="多头自注意力"><a href="#多头自注意力" class="headerlink" title="多头自注意力"></a>多头自注意力</h1><p><strong>多头自注意力(Multi-Head Self-Attention)</strong>在多个不同的投影空间中捕捉不同的交互信息。假设在M个投影空间中分别应用自注意力模型，则：</p>
<script type="math/tex; mode=display">
\begin{align}
\mbox{MultiHead}(\boldsymbol{H}) &= \boldsymbol{W}_o[\mbox{head}_1;\ldots;\mbox{head}_M]  \tag{6}\\
\mbox{head}_m &= \mbox{self-att}(\boldsymbol{Q}_m,\boldsymbol{K}_m,\boldsymbol{V}_m) \tag{7}\\
\forall m\in {1,\ldots,M},
\boldsymbol{Q}_m &=\boldsymbol{W}_q^m \boldsymbol{H},
\boldsymbol{Q}_m =\boldsymbol{W}_k^m \boldsymbol{H},
\boldsymbol{Q}_m =\boldsymbol{W}_v^m \boldsymbol{H} \tag{8}
\end{align}</script><p>其中，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.164ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 6529.1 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{W}_o \in \mathbb{R}^{D_v \times Md_v}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-57" d="M111 624Q109 624 102 624T91 623Q61 623 61 640Q61 660 70 678Q78 686 98 686Q140 684 239 684Q277 684 309 684T360 685T383 686H385Q407 686 407 668Q404 634 391 626Q387 624 348 624Q307 624 307 622Q307 618 332 409Q359 198 359 195L570 532L564 576L558 622V624H522H504Q472 624 472 641Q475 678 488 684L493 686L529 685Q551 684 645 684Q716 684 753 685T795 686Q818 686 818 669Q815 632 802 626Q798 624 759 624Q718 624 718 622Q718 615 743 410Q770 199 770 196Q770 195 806 253T903 406Q1035 618 1035 619Q1025 624 968 624Q943 624 943 641Q943 648 946 659Q950 675 952 679T963 686L998 685Q1020 684 1093 684Q1113 684 1139 685T1173 686Q1207 686 1207 669Q1207 664 1204 652Q1199 631 1194 628T1164 624Q1113 622 1101 615Q1098 612 905 305Q715 -1 709 -7Q699 -17 673 -17Q645 -17 639 -8L581 441Q581 444 442 221Q331 44 314 18T288 -14Q279 -17 263 -17H254Q229 -17 227 -5Q225 2 186 311L147 620V624H111Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6F" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4D" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6F" x="1546" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1814" y="0"></use>
<g transform="translate(2759,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-76" x="1020" y="-185"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1322" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-4D" x="2101" y="0"></use>
<g transform="translate(2229,0)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-76" x="641" y="-185"></use>
</g>
</g>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.102ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 6502.4 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{W}_q^m \in \mathbb{R}^{D_k \times D_h}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-57" d="M111 624Q109 624 102 624T91 623Q61 623 61 640Q61 660 70 678Q78 686 98 686Q140 684 239 684Q277 684 309 684T360 685T383 686H385Q407 686 407 668Q404 634 391 626Q387 624 348 624Q307 624 307 622Q307 618 332 409Q359 198 359 195L570 532L564 576L558 622V624H522H504Q472 624 472 641Q475 678 488 684L493 686L529 685Q551 684 645 684Q716 684 753 685T795 686Q818 686 818 669Q815 632 802 626Q798 624 759 624Q718 624 718 622Q718 615 743 410Q770 199 770 196Q770 195 806 253T903 406Q1035 618 1035 619Q1025 624 968 624Q943 624 943 641Q943 648 946 659Q950 675 952 679T963 686L998 685Q1020 684 1093 684Q1113 684 1139 685T1173 686Q1207 686 1207 669Q1207 664 1204 652Q1199 631 1194 628T1164 624Q1113 622 1101 615Q1098 612 905 305Q715 -1 709 -7Q699 -17 673 -17Q645 -17 639 -8L581 441Q581 444 442 221Q331 44 314 18T288 -14Q279 -17 263 -17H254Q229 -17 227 -5Q225 2 186 311L147 620V624H111Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-71" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="1756" y="499"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-71" x="1546" y="-211"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="2240" y="0"></use>
<g transform="translate(3185,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-6B" x="1020" y="-271"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1351" y="0"></use>
<g transform="translate(1506,0)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-68" x="1020" y="-271"></use>
</g>
</g>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.102ex" height="3.343ex" style="vertical-align: -1.005ex;" viewBox="0 -1006.6 6502.4 1439.2" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{W}_k^m \in \mathbb{R}^{D_k \times D_h}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-57" d="M111 624Q109 624 102 624T91 623Q61 623 61 640Q61 660 70 678Q78 686 98 686Q140 684 239 684Q277 684 309 684T360 685T383 686H385Q407 686 407 668Q404 634 391 626Q387 624 348 624Q307 624 307 622Q307 618 332 409Q359 198 359 195L570 532L564 576L558 622V624H522H504Q472 624 472 641Q475 678 488 684L493 686L529 685Q551 684 645 684Q716 684 753 685T795 686Q818 686 818 669Q815 632 802 626Q798 624 759 624Q718 624 718 622Q718 615 743 410Q770 199 770 196Q770 195 806 253T903 406Q1035 618 1035 619Q1025 624 968 624Q943 624 943 641Q943 648 946 659Q950 675 952 679T963 686L998 685Q1020 684 1093 684Q1113 684 1139 685T1173 686Q1207 686 1207 669Q1207 664 1204 652Q1199 631 1194 628T1164 624Q1113 622 1101 615Q1098 612 905 305Q715 -1 709 -7Q699 -17 673 -17Q645 -17 639 -8L581 441Q581 444 442 221Q331 44 314 18T288 -14Q279 -17 263 -17H254Q229 -17 227 -5Q225 2 186 311L147 620V624H111Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="1756" y="499"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6B" x="1546" y="-463"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="2240" y="0"></use>
<g transform="translate(3185,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-6B" x="1020" y="-271"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1351" y="0"></use>
<g transform="translate(1506,0)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-68" x="1020" y="-271"></use>
</g>
</g>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.054ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 6481.7 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{W}_v^m \in \mathbb{R}^{D_v \times D_h}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-57" d="M111 624Q109 624 102 624T91 623Q61 623 61 640Q61 660 70 678Q78 686 98 686Q140 684 239 684Q277 684 309 684T360 685T383 686H385Q407 686 407 668Q404 634 391 626Q387 624 348 624Q307 624 307 622Q307 618 332 409Q359 198 359 195L570 532L564 576L558 622V624H522H504Q472 624 472 641Q475 678 488 684L493 686L529 685Q551 684 645 684Q716 684 753 685T795 686Q818 686 818 669Q815 632 802 626Q798 624 759 624Q718 624 718 622Q718 615 743 410Q770 199 770 196Q770 195 806 253T903 406Q1035 618 1035 619Q1025 624 968 624Q943 624 943 641Q943 648 946 659Q950 675 952 679T963 686L998 685Q1020 684 1093 684Q1113 684 1139 685T1173 686Q1207 686 1207 669Q1207 664 1204 652Q1199 631 1194 628T1164 624Q1113 622 1101 615Q1098 612 905 305Q715 -1 709 -7Q699 -17 673 -17Q645 -17 639 -8L581 441Q581 444 442 221Q331 44 314 18T288 -14Q279 -17 263 -17H254Q229 -17 227 -5Q225 2 186 311L147 620V624H111Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-57" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6D" x="1756" y="499"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-76" x="1546" y="-212"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="2240" y="0"></use>
<g transform="translate(3185,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-76" x="1020" y="-185"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="1322" y="0"></use>
<g transform="translate(1485,0)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-68" x="1020" y="-271"></use>
</g>
</g>
</g>
</g>
</svg>为投影矩阵，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.989ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 6884.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">m\in\{1,\ldots,M\}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-6D" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7B" d="M434 -231Q434 -244 428 -250H410Q281 -250 230 -184Q225 -177 222 -172T217 -161T213 -148T211 -133T210 -111T209 -84T209 -47T209 0Q209 21 209 53Q208 142 204 153Q203 154 203 155Q189 191 153 211T82 231Q71 231 68 234T65 250T68 266T82 269Q116 269 152 289T203 345Q208 356 208 377T209 529V579Q209 634 215 656T244 698Q270 724 324 740Q361 748 377 749Q379 749 390 749T408 750H428Q434 744 434 732Q434 719 431 716Q429 713 415 713Q362 710 332 689T296 647Q291 634 291 499V417Q291 370 288 353T271 314Q240 271 184 255L170 250L184 245Q202 239 220 230T262 196T290 137Q291 131 291 1Q291 -134 296 -147Q306 -174 339 -192T415 -213Q429 -213 431 -216Q434 -219 434 -231Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-4D" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"></path>
<path stroke-width="1" id="E1-MJMAIN-7D" d="M65 731Q65 745 68 747T88 750Q171 750 216 725T279 670Q288 649 289 635T291 501Q292 362 293 357Q306 312 345 291T417 269Q428 269 431 266T434 250T431 234T417 231Q380 231 345 210T298 157Q293 143 292 121T291 -28V-79Q291 -134 285 -156T256 -198Q202 -250 89 -250Q71 -250 68 -247T65 -230Q65 -224 65 -223T66 -218T69 -214T77 -213Q91 -213 108 -210T146 -200T183 -177T207 -139Q208 -134 209 3L210 139Q223 196 280 230Q315 247 330 250Q305 257 280 270Q225 304 212 352L210 362L209 498Q208 635 207 640Q195 680 154 696T77 713Q68 713 67 716T65 731Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-6D" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1156" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7B" x="2101" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="2602" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="3102" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="3547" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="4886" y="0"></use>
 <use xlink:href="#E1-MJMATHI-4D" x="5332" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7D" x="6383" y="0"></use>
</g>
</svg>.</p>
<p>也就是说，多头自注意力是将多个不同参数的自注意力的结果进行拼接，如图：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/transformer_2.png">
    
</div>

<h1 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h1><p>Transformer是2017年Google团队提出的一个基于Mult-Head Attention的Seq2Seq模型，整个网络结构由<strong>编码器</strong>和<strong>解码器</strong>两部分组成，原文链接<a href="https://arxiv.org/abs/1706.03762">Attention Is All you Need</a>.</p>
<p>Transformer的主要结构如下：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/transformer_3.png" <="" img="">
</div>

<p>上图是来自原文的结构图，左边是N个编码器，右边是N个解码器，Transformer中的N为6，下图是Jay Alammar博客中的简化图：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/transformer_4.png">
    
</div>

<h2 id="编码器"><a href="#编码器" class="headerlink" title="编码器"></a>编码器</h2><p>Transformer中的编码器部分一共有6个相同的编码器层组成，下面以单个层为例。如下图，每个编码器都有两个子层，即<strong>多头自注意力层</strong>(Multi-Head Attention)层和<strong>逐位置的前馈神经网络</strong>(Position-wise Feed-Forward Network)。在每个子层后面都有<strong>残差连接</strong>（图中的虚线）和<strong>层归一化</strong>（LayerNorm）操作，二者合起来称为<strong>Add&amp;Norm</strong>操作。</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/transformer_5.png">
</div>

<p>编码器的输入为序列<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.2ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1808.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{x}_{1:T}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-54" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
<g transform="translate(659,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="779" y="0"></use>
</g>
</g>
</svg>，输出为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.269ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 10018.4 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{H}^{enc}=[\boldsymbol{h}_1^{enc},\ldots,\boldsymbol{h}_T^{env}]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-48" d="M258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L399 389Q399 388 547 388H695L753 623Q753 624 709 624H686Q665 624 660 626T650 639Q653 678 668 684Q672 686 681 686Q685 686 726 685T847 684Q902 684 937 684T986 685T1004 686Q1027 686 1027 668Q1023 632 1011 626Q1006 624 957 624H908L839 344Q768 64 768 63T812 62H839Q871 62 871 44Q867 6 854 2L850 0L808 1Q782 2 675 2Q600 2 560 1T516 0Q499 0 494 15Q498 54 511 60Q515 62 564 62H613L614 66L679 324Q679 326 531 326H383L382 322L317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-68" d="M477 56Q477 48 479 46T490 43Q522 45 544 75T577 140Q582 156 585 159T605 162H611H622Q642 162 642 148Q642 138 632 114T602 62T550 13T478 -8Q429 -8 394 17T358 83Q358 95 395 199T433 350Q433 400 394 400H388H383Q335 400 291 363Q256 332 236 298Q233 293 202 170T169 40Q160 18 141 5T99 -8Q70 -8 58 9T45 39Q45 51 116 336L188 622H184Q183 622 179 622T169 623T157 624T146 624T136 624T131 625Q119 628 119 642Q119 647 123 661T129 679Q133 684 144 685T220 690Q293 694 307 694Q324 694 328 679Q328 672 294 540Q286 507 278 473T264 420L260 403Q260 400 269 408Q327 451 393 451H401H410Q425 451 439 450T476 442T515 424T544 391T556 337Q556 286 517 179T477 56Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMATHI-54" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-48" x="0" y="0"></use>
<g transform="translate(1041,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="2479" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="3536" y="0"></use>
<g transform="translate(3814,0)">
 <use xlink:href="#E1-MJMATHBI-68" x="0" y="0"></use>
<g transform="translate(668,353)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="945" y="-435"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="5644" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="6089" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="7428" y="0"></use>
<g transform="translate(7873,0)">
 <use xlink:href="#E1-MJMATHBI-68" x="0" y="0"></use>
<g transform="translate(668,352)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-76" x="1067" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="945" y="-446"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="9739" y="0"></use>
</g>
</svg>，然后用两个矩阵将<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.114ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2202.1 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{H}^{enc}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-48" d="M258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L399 389Q399 388 547 388H695L753 623Q753 624 709 624H686Q665 624 660 626T650 639Q653 678 668 684Q672 686 681 686Q685 686 726 685T847 684Q902 684 937 684T986 685T1004 686Q1027 686 1027 668Q1023 632 1011 626Q1006 624 957 624H908L839 344Q768 64 768 63T812 62H839Q871 62 871 44Q867 6 854 2L850 0L808 1Q782 2 675 2Q600 2 560 1T516 0Q499 0 494 15Q498 54 511 60Q515 62 564 62H613L614 66L679 324Q679 326 531 326H383L382 322L317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-48" x="0" y="0"></use>
<g transform="translate(1041,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
</g>
</svg>映射到<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.05ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2174.2 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{K}^{enc}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-4B" d="M536 0Q522 6 522 18Q522 35 533 57Q539 62 557 62Q595 62 601 65L472 330L365 255L342 160Q318 65 317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L422 481Q386 339 386 337L785 621Q779 624 749 624Q726 624 726 641Q726 645 730 659Q734 675 736 679T747 686L786 685Q812 684 888 684Q908 684 934 685T968 686Q1003 686 1003 669Q1003 646 991 629Q985 624 967 624Q918 624 888 617Q884 617 874 613L865 609Q864 608 732 515T599 420Q599 418 686 242T775 65Q784 62 829 62Q847 62 850 61T860 54Q862 52 862 43Q862 10 845 1Q844 1 842 1T836 0T797 1T694 2Q599 2 573 1L536 0Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-4B" x="0" y="0"></use>
<g transform="translate(1013,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
</g>
</svg>和<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.901ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2110 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{V}^{enc}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-56" d="M401 686Q415 680 415 668Q415 651 404 629Q398 624 356 624Q318 624 318 623Q318 620 337 508T377 284L397 174L472 285Q548 396 623 507T699 620Q698 621 652 624Q634 624 627 627T619 641Q619 648 622 658Q627 677 631 681T650 686Q654 686 686 685T766 684Q794 684 823 684T858 685Q874 685 878 683T886 671Q886 667 882 651Q877 632 873 628T850 624Q800 624 779 617Q774 617 770 613Q767 610 560 304T350 -5Q346 -9 332 -16H306H291Q270 -16 267 -2Q267 -1 260 37T238 161T210 313L156 624H116H94Q62 624 62 642Q66 678 78 684Q82 686 99 686Q144 684 246 684Q330 684 368 685L401 686Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-56" x="0" y="0"></use>
<g transform="translate(948,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
</g>
</svg>作为键值对供解码器使用：</p>
<script type="math/tex; mode=display">
\begin{align}
\boldsymbol{K}^{enc}=\boldsymbol{W}'_k \boldsymbol{H}^{enc} \tag{9}\\
\boldsymbol{V}^{enc}=\boldsymbol{W}'_v \boldsymbol{H}^{enc} \tag{10}
\end{align}</script><p>编码器中的关键步骤：</p>
<ol>
<li><p><strong>位置编码</strong></p>
<p>由于自注意力模型忽略了序列<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.2ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1808.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{x}_{1:T}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-54" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
<g transform="translate(659,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="779" y="0"></use>
</g>
</g>
</svg>中每个<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.358ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1015.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{x}_t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="932" y="-213"></use>
</g>
</svg>的位置信息（即使句子结构混乱也能得到类似的结果），因此需要在初始的输入序列中加入位置编码来进行修正，对于输入序列<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="12.748ex" height="3.009ex" style="vertical-align: -0.671ex;" viewBox="0 -1006.6 5488.5 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{x}_{1:T}\in \mathbb{R}^{D\times T}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-54" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
<g transform="translate(659,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="2086" y="0"></use>
<g transform="translate(3031,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
<g transform="translate(722,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-D7" x="828" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="1606" y="0"></use>
</g>
</g>
</g>
</svg>，令：</p>
<script type="math/tex; mode=display">
\boldsymbol{H}^{(0)} = [\boldsymbol{e}_{x_1}+\boldsymbol{p}_1,\ldots,\boldsymbol{e}_{x_T}+\boldsymbol{p}_T] \tag{11}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.218ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 3968.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{e}_{x_t} \in \mathbb{R}^D</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-65" d="M260 -8Q196 -8 151 9T83 54T52 111T42 169Q42 188 44 210Q50 240 58 266Q127 434 335 451L338 452Q342 452 345 452Q347 452 353 452T363 451Q426 451 464 424T502 352Q502 289 442 250Q381 211 222 211H184Q184 210 181 196T175 162T171 126Q171 43 264 43Q391 43 457 105Q472 120 480 117Q486 114 497 102T509 83Q509 79 502 70T477 47T432 21T360 1T260 -8ZM237 262Q427 266 427 349Q427 368 409 384T354 401Q316 401 287 388T242 354T216 314T202 278L197 263Q197 262 237 262Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-65" x="0" y="0"></use>
<g transform="translate(554,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.574)" xlink:href="#E1-MJMATHI-74" x="705" y="-203"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2208" x="1615" y="0"></use>
<g transform="translate(2560,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="1021" y="583"></use>
</g>
</g>
</svg>是词<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.156ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 928.1 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">x_t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-78" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="809" y="-213"></use>
</g>
</svg>的嵌入向量表示，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.387ex" height="3.009ex" style="vertical-align: -0.671ex; margin-left: -0.052ex;" viewBox="-22.5 -1006.6 3611 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{p}_t \in \mathbb{R}^D</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-70" d="M24 296Q25 302 27 312T41 350T65 397T103 435T157 452Q235 452 273 404Q336 452 409 452Q434 452 458 448T507 432T550 402T581 354T593 285Q593 221 564 159T480 53Q401 -8 302 -8Q290 -8 279 -7T259 -3T242 3T228 9T218 14T212 18L209 20Q208 19 190 -55T171 -131T198 -132H213Q240 -132 240 -150Q237 -187 223 -192Q219 -194 212 -194Q208 -194 176 -193T95 -192Q48 -192 24 -193T-3 -194Q-11 -194 -16 -190T-22 -182T-23 -176Q-20 -142 -7 -134Q-3 -132 20 -132H44L164 354Q165 357 165 372Q165 401 148 401Q113 401 90 310Q85 289 82 286T60 282H55H44Q24 282 24 296ZM465 339Q465 373 447 387T403 401Q375 401 347 387T303 360T288 341Q288 338 257 216L227 93Q248 43 306 43Q332 43 361 59T410 115Q425 147 445 224Q465 309 465 339Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJAMS-52" d="M17 665Q17 672 28 683H221Q415 681 439 677Q461 673 481 667T516 654T544 639T566 623T584 607T597 592T607 578T614 565T618 554L621 548Q626 530 626 497Q626 447 613 419Q578 348 473 326L455 321Q462 310 473 292T517 226T578 141T637 72T686 35Q705 30 705 16Q705 7 693 -1H510Q503 6 404 159L306 310H268V183Q270 67 271 59Q274 42 291 38Q295 37 319 35Q344 35 353 28Q362 17 353 3L346 -1H28Q16 5 16 16Q16 35 55 35Q96 38 101 52Q106 60 106 341T101 632Q95 645 55 648Q17 648 17 665ZM241 35Q238 42 237 45T235 78T233 163T233 337V621L237 635L244 648H133Q136 641 137 638T139 603T141 517T141 341Q141 131 140 89T134 37Q133 36 133 35H241ZM457 496Q457 540 449 570T425 615T400 634T377 643Q374 643 339 648Q300 648 281 635Q271 628 270 610T268 481V346H284Q327 346 375 352Q421 364 439 392T457 496ZM492 537T492 496T488 427T478 389T469 371T464 361Q464 360 465 360Q469 360 497 370Q593 400 593 495Q593 592 477 630L457 637L461 626Q474 611 488 561Q492 537 492 496ZM464 243Q411 317 410 317Q404 317 401 315Q384 315 370 312H346L526 35H619L606 50Q553 109 464 243Z"></path>
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-70" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="850" y="-213"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="1234" y="0"></use>
<g transform="translate(2180,0)">
 <use xlink:href="#E1-MJAMS-52" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-44" x="1021" y="583"></use>
</g>
</g>
</svg>是位置 <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
</g>
</svg> 的向量表示，即<strong>位置编码</strong>。位置编码通过下面的公式预定义：</p>
<script type="math/tex; mode=display">
\begin{align}
\boldsymbol{p}_{t,2i} &=\sin (\frac{t}{10000^{\frac{2i}{D}}}) \\
\boldsymbol{p}_{t,2i+1} &=\cos (\frac{t}{10000^{\frac{2i}{D}}}) \tag{12}
\end{align}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.122ex" height="2.343ex" style="vertical-align: -1.005ex; margin-left: -0.052ex;" viewBox="-22.5 -576.1 1774.8 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{p}_{t,2i}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-70" d="M24 296Q25 302 27 312T41 350T65 397T103 435T157 452Q235 452 273 404Q336 452 409 452Q434 452 458 448T507 432T550 402T581 354T593 285Q593 221 564 159T480 53Q401 -8 302 -8Q290 -8 279 -7T259 -3T242 3T228 9T218 14T212 18L209 20Q208 19 190 -55T171 -131T198 -132H213Q240 -132 240 -150Q237 -187 223 -192Q219 -194 212 -194Q208 -194 176 -193T95 -192Q48 -192 24 -193T-3 -194Q-11 -194 -16 -190T-22 -182T-23 -176Q-20 -142 -7 -134Q-3 -132 20 -132H44L164 354Q165 357 165 372Q165 401 148 401Q113 401 90 310Q85 289 82 286T60 282H55H44Q24 282 24 296ZM465 339Q465 373 447 387T403 401Q375 401 347 387T303 360T288 341Q288 338 257 216L227 93Q248 43 306 43Q332 43 361 59T410 115Q425 147 445 224Q465 309 465 339Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-70" x="0" y="0"></use>
<g transform="translate(601,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-2C" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="640" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="1140" y="0"></use>
</g>
</g>
</svg>表示第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
</g>
</svg>个位置的编码向量的第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.965ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 846 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-32" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-69" x="500" y="0"></use>
</g>
</svg>维，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.924ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 828.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">D</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-44" d="M287 628Q287 635 230 637Q207 637 200 638T193 647Q193 655 197 667T204 682Q206 683 403 683Q570 682 590 682T630 676Q702 659 752 597T803 431Q803 275 696 151T444 3L430 1L236 0H125H72Q48 0 41 2T33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM703 469Q703 507 692 537T666 584T629 613T590 629T555 636Q553 636 541 636T512 636T479 637H436Q392 637 386 627Q384 623 313 339T242 52Q242 48 253 48T330 47Q335 47 349 47T373 46Q499 46 581 128Q617 164 640 212T683 339T703 469Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-44" x="0" y="0"></use>
</g>
</svg>是编码向量的维度。</p>
<blockquote>
<p>Transformer里的位置编码是没有梯度的，不参与训练，每个位置上的值是固定的。</p>
</blockquote>
</li>
</ol>
<ol>
<li><p><strong>层归一化和残差连接(Add&amp;Norm)</strong></p>
<p>每个子层后都跟着Add&amp;Norm层，包括<strong>残差连接</strong>和<strong>层归一化</strong>操作：</p>
<script type="math/tex; mode=display">
\mbox{LayerNorm}(\boldsymbol{X}+\mbox{Sublayer}(\boldsymbol{X}))  \tag{13}</script><p>其中<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.215ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 953.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{X}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
</g>
</svg>是来自上个子层的输出，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.54ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 4968.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mbox{LayerNorm}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-4C" d="M128 622Q121 629 117 631T101 634T58 637H25V683H36Q48 680 182 680Q324 680 348 683H360V637H333Q273 637 258 635T233 622L232 342V129Q232 57 237 52Q243 47 313 47Q384 47 410 53Q470 70 498 110T536 221Q536 226 537 238T540 261T542 272T562 273H582V268Q580 265 568 137T554 5V0H25V46H58Q100 47 109 49T128 61V622Z"></path>
<path stroke-width="1" id="E1-MJMAIN-61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z"></path>
<path stroke-width="1" id="E1-MJMAIN-79" d="M69 -66Q91 -66 104 -80T118 -116Q118 -134 109 -145T91 -160Q84 -163 97 -166Q104 -168 111 -168Q131 -168 148 -159T175 -138T197 -106T213 -75T225 -43L242 0L170 183Q150 233 125 297Q101 358 96 368T80 381Q79 382 78 382Q66 385 34 385H19V431H26L46 430Q65 430 88 429T122 428Q129 428 142 428T171 429T200 430T224 430L233 431H241V385H232Q183 385 185 366L286 112Q286 113 332 227L376 341V350Q376 365 366 373T348 383T334 385H331V431H337H344Q351 431 361 431T382 430T405 429T422 429Q477 429 503 431H508V385H497Q441 380 422 345Q420 343 378 235T289 9T227 -131Q180 -204 113 -204Q69 -204 44 -177T19 -116Q19 -89 35 -78T69 -66Z"></path>
<path stroke-width="1" id="E1-MJMAIN-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"></path>
<path stroke-width="1" id="E1-MJMAIN-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"></path>
<path stroke-width="1" id="E1-MJMAIN-4E" d="M42 46Q74 48 94 56T118 69T128 86V634H124Q114 637 52 637H25V683H232L235 680Q237 679 322 554T493 303L578 178V598Q572 608 568 613T544 627T492 637H475V683H483Q498 680 600 680Q706 680 715 683H724V637H707Q634 633 622 598L621 302V6L614 0H600Q585 0 582 3T481 150T282 443T171 605V345L172 86Q183 50 257 46H274V0H265Q250 3 150 3Q48 3 33 0H25V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6D" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-4C"></use>
 <use xlink:href="#E1-MJMAIN-61" x="625" y="0"></use>
 <use xlink:href="#E1-MJMAIN-79" x="1126" y="0"></use>
 <use xlink:href="#E1-MJMAIN-65" x="1654" y="0"></use>
 <use xlink:href="#E1-MJMAIN-72" x="2099" y="0"></use>
 <use xlink:href="#E1-MJMAIN-4E" x="2491" y="0"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="3242" y="0"></use>
 <use xlink:href="#E1-MJMAIN-72" x="3742" y="0"></use>
 <use xlink:href="#E1-MJMAIN-6D" x="4135" y="0"></use>
</g>
</svg>表示层归一化操作，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.858ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 3814 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mbox{Sublayer}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-53" d="M55 507Q55 590 112 647T243 704H257Q342 704 405 641L426 672Q431 679 436 687T446 700L449 704Q450 704 453 704T459 705H463Q466 705 472 699V462L466 456H448Q437 456 435 459T430 479Q413 605 329 646Q292 662 254 662Q201 662 168 626T135 542Q135 508 152 480T200 435Q210 431 286 412T370 389Q427 367 463 314T500 191Q500 110 448 45T301 -21Q245 -21 201 -4T140 27L122 41Q118 36 107 21T87 -7T78 -21Q76 -22 68 -22H64Q61 -22 55 -16V101Q55 220 56 222Q58 227 76 227H89Q95 221 95 214Q95 182 105 151T139 90T205 42T305 24Q352 24 386 62T420 155Q420 198 398 233T340 281Q284 295 266 300Q261 301 239 306T206 314T174 325T141 343T112 367T85 402Q55 451 55 507Z"></path>
<path stroke-width="1" id="E1-MJMAIN-75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z"></path>
<path stroke-width="1" id="E1-MJMAIN-62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z"></path>
<path stroke-width="1" id="E1-MJMAIN-79" d="M69 -66Q91 -66 104 -80T118 -116Q118 -134 109 -145T91 -160Q84 -163 97 -166Q104 -168 111 -168Q131 -168 148 -159T175 -138T197 -106T213 -75T225 -43L242 0L170 183Q150 233 125 297Q101 358 96 368T80 381Q79 382 78 382Q66 385 34 385H19V431H26L46 430Q65 430 88 429T122 428Q129 428 142 428T171 429T200 430T224 430L233 431H241V385H232Q183 385 185 366L286 112Q286 113 332 227L376 341V350Q376 365 366 373T348 383T334 385H331V431H337H344Q351 431 361 431T382 430T405 429T422 429Q477 429 503 431H508V385H497Q441 380 422 345Q420 343 378 235T289 9T227 -131Q180 -204 113 -204Q69 -204 44 -177T19 -116Q19 -89 35 -78T69 -66Z"></path>
<path stroke-width="1" id="E1-MJMAIN-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"></path>
<path stroke-width="1" id="E1-MJMAIN-72" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T98 122T98 161T98 203Q98 234 98 269T98 328L97 351Q94 370 83 376T38 385H20V408Q20 431 22 431L32 432Q42 433 60 434T96 436Q112 437 131 438T160 441T171 442H174V373Q213 441 271 441H277Q322 441 343 419T364 373Q364 352 351 337T313 322Q288 322 276 338T263 372Q263 381 265 388T270 400T273 405Q271 407 250 401Q234 393 226 386Q179 341 179 207V154Q179 141 179 127T179 101T180 81T180 66V61Q181 59 183 57T188 54T193 51T200 49T207 48T216 47T225 47T235 46T245 46H276V0H267Q249 3 140 3Q37 3 28 0H20V46H36Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-53"></use>
 <use xlink:href="#E1-MJMAIN-75" x="556" y="0"></use>
 <use xlink:href="#E1-MJMAIN-62" x="1113" y="0"></use>
 <use xlink:href="#E1-MJMAIN-6C" x="1669" y="0"></use>
 <use xlink:href="#E1-MJMAIN-61" x="1948" y="0"></use>
 <use xlink:href="#E1-MJMAIN-79" x="2448" y="0"></use>
 <use xlink:href="#E1-MJMAIN-65" x="2977" y="0"></use>
 <use xlink:href="#E1-MJMAIN-72" x="3421" y="0"></use>
</g>
</svg>表示上个子层的函数，即<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="11.627ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 5006 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mbox{Multi-Head}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-4D" d="M132 622Q125 629 121 631T105 634T62 637H29V683H135Q221 683 232 682T249 675Q250 674 354 398L458 124L562 398Q666 674 668 675Q671 681 683 682T781 683H887V637H854Q814 636 803 634T785 622V61Q791 51 802 49T854 46H887V0H876Q855 3 736 3Q605 3 596 0H585V46H618Q660 47 669 49T688 61V347Q688 424 688 461T688 546T688 613L687 632Q454 14 450 7Q446 1 430 1T410 7Q409 9 292 316L176 624V606Q175 588 175 543T175 463T175 356L176 86Q187 50 261 46H278V0H269Q254 3 154 3Q52 3 37 0H29V46H46Q78 48 98 56T122 69T132 86V622Z"></path>
<path stroke-width="1" id="E1-MJMAIN-75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z"></path>
<path stroke-width="1" id="E1-MJMAIN-69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2D" d="M11 179V252H277V179H11Z"></path>
<path stroke-width="1" id="E1-MJMAIN-48" d="M128 622Q121 629 117 631T101 634T58 637H25V683H36Q57 680 180 680Q315 680 324 683H335V637H302Q262 636 251 634T233 622L232 500V378H517V622Q510 629 506 631T490 634T447 637H414V683H425Q446 680 569 680Q704 680 713 683H724V637H691Q651 636 640 634T622 622V61Q628 51 639 49T691 46H724V0H713Q692 3 569 3Q434 3 425 0H414V46H447Q489 47 498 49T517 61V332H232V197L233 61Q239 51 250 49T302 46H335V0H324Q303 3 180 3Q45 3 36 0H25V46H58Q100 47 109 49T128 61V622Z"></path>
<path stroke-width="1" id="E1-MJMAIN-65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"></path>
<path stroke-width="1" id="E1-MJMAIN-61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z"></path>
<path stroke-width="1" id="E1-MJMAIN-64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-4D"></use>
 <use xlink:href="#E1-MJMAIN-75" x="917" y="0"></use>
 <use xlink:href="#E1-MJMAIN-6C" x="1474" y="0"></use>
 <use xlink:href="#E1-MJMAIN-74" x="1752" y="0"></use>
 <use xlink:href="#E1-MJMAIN-69" x="2142" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2D" x="2420" y="0"></use>
 <use xlink:href="#E1-MJMAIN-48" x="2754" y="0"></use>
 <use xlink:href="#E1-MJMAIN-65" x="3504" y="0"></use>
 <use xlink:href="#E1-MJMAIN-61" x="3949" y="0"></use>
 <use xlink:href="#E1-MJMAIN-64" x="4449" y="0"></use>
</g>
</svg>或者<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.004ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2154.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mbox{FNN}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-46" d="M128 619Q121 626 117 628T101 631T58 634H25V680H582V676Q584 670 596 560T610 444V440H570V444Q563 493 561 501Q555 538 543 563T516 601T477 622T431 631T374 633H334H286Q252 633 244 631T233 621Q232 619 232 490V363H284Q287 363 303 363T327 364T349 367T372 373T389 385Q407 403 410 459V480H450V200H410V221Q407 276 389 296Q381 303 371 307T348 313T327 316T303 317T284 317H232V189L233 61Q240 54 245 52T270 48T333 46H360V0H348Q324 3 182 3Q51 3 36 0H25V46H58Q100 47 109 49T128 61V619Z"></path>
<path stroke-width="1" id="E1-MJMAIN-4E" d="M42 46Q74 48 94 56T118 69T128 86V634H124Q114 637 52 637H25V683H232L235 680Q237 679 322 554T493 303L578 178V598Q572 608 568 613T544 627T492 637H475V683H483Q498 680 600 680Q706 680 715 683H724V637H707Q634 633 622 598L621 302V6L614 0H600Q585 0 582 3T481 150T282 443T171 605V345L172 86Q183 50 257 46H274V0H265Q250 3 150 3Q48 3 33 0H25V46H42Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-46"></use>
 <use xlink:href="#E1-MJMAIN-4E" x="653" y="0"></use>
 <use xlink:href="#E1-MJMAIN-4E" x="1404" y="0"></use>
</g>
</svg>.</p>
<blockquote>
<p>Transoformer中的子层和Add&amp;Norm层之间有dropout操作。</p>
</blockquote>
</li>
<li><p><strong>逐位置的前馈神经网络(Position-wise-Feed-Forward Network)</strong></p>
<p>逐位置的前馈神经网络是一个简单的两层网络，对于序列的每个位置上的向量<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.593ex" height="2.843ex" style="vertical-align: -0.338ex;" viewBox="0 -1078.4 3699.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{x}\in\boldsymbol{X}^{(l)}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-78" d="M74 282H63Q43 282 43 296Q43 298 45 307T56 332T76 365T110 401T159 433Q200 451 233 451H236Q273 451 282 450Q358 437 382 400L392 410Q434 452 483 452Q538 452 568 421T599 346Q599 303 573 280T517 256Q494 256 478 270T462 308Q462 343 488 367Q501 377 520 385Q520 386 516 389T502 396T480 400T462 398Q429 383 415 341Q354 116 354 80T405 44Q449 44 485 74T535 142Q539 156 542 159T562 162H568H579Q599 162 599 148Q599 135 586 111T550 60T485 12T397 -8Q313 -8 266 35L258 44Q215 -7 161 -7H156Q99 -7 71 25T43 95Q43 143 70 165T125 188Q148 188 164 174T180 136Q180 101 154 77Q141 67 122 59Q124 54 136 49T161 43Q183 43 200 61T226 103Q287 328 287 364T236 400Q200 400 164 377T107 302Q103 288 100 285T80 282H74Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-58" d="M931 686Q953 686 953 670Q953 650 944 632Q936 624 924 624H914Q823 624 803 611Q800 609 696 503T591 396Q591 394 667 229L743 62H787H814Q846 62 846 44Q843 7 829 2Q825 0 817 0Q813 0 775 1T664 2Q590 2 551 1T508 0H507Q484 0 484 18Q484 19 488 37Q492 56 497 58T534 62L566 63Q567 64 520 169T471 274Q469 274 369 172T268 67L315 62Q320 62 328 62L335 61Q347 58 347 44Q344 10 331 2L326 0L287 1Q263 2 177 2Q95 2 78 1L53 0Q38 6 38 17Q38 40 50 57Q56 62 78 62Q169 62 188 75Q194 77 435 324L444 334L439 347Q437 351 373 492L313 624H268H246Q220 624 212 632Q210 636 210 642Q210 655 215 669T227 684Q230 686 247 686Q295 684 398 684Q438 684 472 684T527 685T551 686Q567 686 572 671Q572 667 568 651Q563 631 558 628T523 624T492 623H488L526 540Q563 457 564 457Q564 456 574 466T604 496T645 537L724 619Q716 622 677 624H673Q645 624 645 640Q645 660 654 678Q659 683 666 686L704 685Q728 684 813 684Q847 684 873 684T913 685T931 686Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-78" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2208" x="937" y="0"></use>
<g transform="translate(1882,0)">
 <use xlink:href="#E1-MJMATHBI-58" x="0" y="0"></use>
<g transform="translate(955,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-28" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6C" x="389" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-29" x="688" y="0"></use>
</g>
</g>
</g>
</svg>执行以下操作：</p>
<script type="math/tex; mode=display">
\mbox{FFN}(\boldsymbol{x})=\boldsymbol{W}_2 \mbox{ReLu}(\boldsymbol{W}_1\boldsymbol{x}+\boldsymbol{b}_1)+\boldsymbol{b}_2  \tag{14}</script></li>
</ol>
<h2 id="解码器"><a href="#解码器" class="headerlink" title="解码器"></a>解码器</h2><p>解码器部分同样由6个相同的层组成，每层都采用自回归的方式生成目标序列，接收来自编码器的输出<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.05ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2174.2 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{K}^{enc}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-4B" d="M536 0Q522 6 522 18Q522 35 533 57Q539 62 557 62Q595 62 601 65L472 330L365 255L342 160Q318 65 317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L422 481Q386 339 386 337L785 621Q779 624 749 624Q726 624 726 641Q726 645 730 659Q734 675 736 679T747 686L786 685Q812 684 888 684Q908 684 934 685T968 686Q1003 686 1003 669Q1003 646 991 629Q985 624 967 624Q918 624 888 617Q884 617 874 613L865 609Q864 608 732 515T599 420Q599 418 686 242T775 65Q784 62 829 62Q847 62 850 61T860 54Q862 52 862 43Q862 10 845 1Q844 1 842 1T836 0T797 1T694 2Q599 2 573 1L536 0Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-4B" x="0" y="0"></use>
<g transform="translate(1013,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
</g>
</svg>和<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.901ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2110 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{V}^{enc}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-56" d="M401 686Q415 680 415 668Q415 651 404 629Q398 624 356 624Q318 624 318 623Q318 620 337 508T377 284L397 174L472 285Q548 396 623 507T699 620Q698 621 652 624Q634 624 627 627T619 641Q619 648 622 658Q627 677 631 681T650 686Q654 686 686 685T766 684Q794 684 823 684T858 685Q874 685 878 683T886 671Q886 667 882 651Q877 632 873 628T850 624Q800 624 779 617Q774 617 770 613Q767 610 560 304T350 -5Q346 -9 332 -16H306H291Q270 -16 267 -2Q267 -1 260 37T238 161T210 313L156 624H116H94Q62 624 62 642Q66 678 78 684Q82 686 99 686Q144 684 246 684Q330 684 368 685L401 686Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-56" x="0" y="0"></use>
<g transform="translate(948,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
</g>
</svg>，以及上一层解码器的输出（用来生成查询向量<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.019ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 869.5 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{Q}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-51" d="M53 245Q53 297 70 356T125 478T216 590T349 671T523 703Q656 703 735 637T815 445Q815 410 808 370T781 277T729 178T643 87T519 14L525 4Q540 -19 553 -25T592 -32Q632 -32 654 -24T680 -7T689 10T704 18Q713 18 717 12T722 0Q722 -8 711 -36T681 -101T624 -166T541 -194Q513 -194 494 -183T465 -157T450 -118T444 -79T443 -41V-7L433 -9Q391 -17 344 -17Q301 -17 263 -10T185 15T118 62T71 138T53 245ZM666 482Q666 529 652 563T614 615T565 640T512 648Q412 648 335 573Q268 506 235 389T201 202Q201 164 210 136T230 95T259 66L262 76Q269 109 302 135T382 162Q401 162 415 159T449 140T484 92L491 78L496 82Q502 86 505 88T515 97T528 107T541 120T555 137T570 156T585 179T599 205T612 235Q629 278 647 351T666 482ZM439 56Q439 58 439 62T435 75T426 92T410 106T383 112Q353 112 332 96T311 63Q311 38 355 38H366Q391 39 415 45T439 56Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-51" x="0" y="0"></use>
</g>
</svg>）。同样以单层为例，每层包括三个子层：<strong>掩蔽自注意力层</strong>(Masked Self-Attention)、<strong>Encoder-Decoder注意力层</strong>、<strong>逐位置的前馈神经网络</strong>，同样，每个子层后面都有<strong>Add&amp;Norm</strong>操作，具体结构如图：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/transformer_6.png">
    
</div>

<p>解码器中的关键步骤：</p>
<ol>
<li><p><strong>掩蔽自注意力</strong> (Masked Self-Attention)</p>
<p>第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
</g>
</svg>步时，使用掩蔽自注意力模块对已经生成的前缀序列<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.857ex" height="2.509ex" style="vertical-align: -1.171ex;" viewBox="0 -576.1 2952.2 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{y}_{0:(t-1)}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-79" d="M206 -150Q240 -150 268 -134T314 -95T344 -48T362 -7T367 14Q339 -7 280 -7Q230 -7 195 5T144 39T122 79T115 122Q115 175 152 274T189 388Q189 396 187 398T176 401Q148 398 125 372T89 304Q84 288 81 285T61 282H55H44Q24 282 24 296Q24 306 34 329T64 381T116 431T188 452Q239 452 273 427T308 361Q308 347 273 253T237 109Q237 43 291 43T388 98Q388 99 425 246T463 396Q471 414 490 429T534 444T573 430T587 399Q587 386 537 186T483 -25Q461 -84 410 -126T296 -188Q248 -202 204 -202Q127 -202 96 -175T64 -114Q64 -82 86 -57T144 -31Q169 -31 184 -45T199 -83Q199 -89 198 -94T196 -104T193 -113T189 -120T184 -128T179 -134T173 -141T168 -147Q189 -150 206 -150Z"></path>
<path stroke-width="1" id="E1-MJMAIN-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-79" x="0" y="0"></use>
<g transform="translate(590,-187)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-30" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-28" x="779" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="1168" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-2212" x="1530" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="2308" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-29" x="2809" y="0"></use>
</g>
</g>
</svg>进行编码，得到<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="23.269ex" height="3.009ex" style="vertical-align: -1.005ex;" viewBox="0 -863.1 10018.4 1295.7" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{H}^{enc}=[\boldsymbol{h}_1^{enc},\ldots,\boldsymbol{h}_t^{env}]</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-48" d="M258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L399 389Q399 388 547 388H695L753 623Q753 624 709 624H686Q665 624 660 626T650 639Q653 678 668 684Q672 686 681 686Q685 686 726 685T847 684Q902 684 937 684T986 685T1004 686Q1027 686 1027 668Q1023 632 1011 626Q1006 624 957 624H908L839 344Q768 64 768 63T812 62H839Q871 62 871 44Q867 6 854 2L850 0L808 1Q782 2 675 2Q600 2 560 1T516 0Q499 0 494 15Q498 54 511 60Q515 62 564 62H613L614 66L679 324Q679 326 531 326H383L382 322L317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path>
<path stroke-width="1" id="E1-MJMATHBI-68" d="M477 56Q477 48 479 46T490 43Q522 45 544 75T577 140Q582 156 585 159T605 162H611H622Q642 162 642 148Q642 138 632 114T602 62T550 13T478 -8Q429 -8 394 17T358 83Q358 95 395 199T433 350Q433 400 394 400H388H383Q335 400 291 363Q256 332 236 298Q233 293 202 170T169 40Q160 18 141 5T99 -8Q70 -8 58 9T45 39Q45 51 116 336L188 622H184Q183 622 179 622T169 623T157 624T146 624T136 624T131 625Q119 628 119 642Q119 647 123 661T129 679Q133 684 144 685T220 690Q293 694 307 694Q324 694 328 679Q328 672 294 540Q286 507 278 473T264 420L260 403Q260 400 269 408Q327 451 393 451H401H410Q425 451 439 450T476 442T515 424T544 391T556 337Q556 286 517 179T477 56Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2026" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60ZM525 60Q525 84 542 102T585 120Q609 120 627 104T646 61Q646 36 629 18T586 0T543 17T525 60ZM972 60Q972 84 989 102T1032 120Q1056 120 1074 104T1093 61Q1093 36 1076 18T1033 0T990 17T972 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-76" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMAIN-5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-48" x="0" y="0"></use>
<g transform="translate(1041,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
 <use xlink:href="#E1-MJMAIN-3D" x="2479" y="0"></use>
 <use xlink:href="#E1-MJMAIN-5B" x="3536" y="0"></use>
<g transform="translate(3814,0)">
 <use xlink:href="#E1-MJMATHBI-68" x="0" y="0"></use>
<g transform="translate(668,353)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="945" y="-435"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="5644" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2026" x="6089" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="7428" y="0"></use>
<g transform="translate(7873,0)">
 <use xlink:href="#E1-MJMATHBI-68" x="0" y="0"></use>
<g transform="translate(668,352)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-76" x="1067" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="945" y="-395"></use>
</g>
 <use xlink:href="#E1-MJMAIN-5D" x="9739" y="0"></use>
</g>
</svg>，使<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
</g>
</svg>之后的序列不可见。</p>
</li>
<li><p><strong>Encoder-Decoder注意力</strong></p>
<p>将<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.123ex" height="3.176ex" style="vertical-align: -1.005ex;" viewBox="0 -934.9 1775.1 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{h}_t^{dec}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-68" d="M477 56Q477 48 479 46T490 43Q522 45 544 75T577 140Q582 156 585 159T605 162H611H622Q642 162 642 148Q642 138 632 114T602 62T550 13T478 -8Q429 -8 394 17T358 83Q358 95 395 199T433 350Q433 400 394 400H388H383Q335 400 291 363Q256 332 236 298Q233 293 202 170T169 40Q160 18 141 5T99 -8Q70 -8 58 9T45 39Q45 51 116 336L188 622H184Q183 622 179 622T169 623T157 624T146 624T136 624T131 625Q119 628 119 642Q119 647 123 661T129 679Q133 684 144 685T220 690Q293 694 307 694Q324 694 328 679Q328 672 294 540Q286 507 278 473T264 420L260 403Q260 400 269 408Q327 451 393 451H401H410Q425 451 439 450T476 442T515 424T544 391T556 337Q556 286 517 179T477 56Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-68" x="0" y="0"></use>
<g transform="translate(668,353)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="990" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="945" y="-395"></use>
</g>
</svg>进行线性映射得到<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.854ex" height="3.176ex" style="vertical-align: -1.005ex;" viewBox="0 -934.9 1659.5 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{q}_t^{dec}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
<g transform="translate(552,353)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="990" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="767" y="-395"></use>
</g>
</svg>，将<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.854ex" height="3.176ex" style="vertical-align: -1.005ex;" viewBox="0 -934.9 1659.5 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{q}_t^{dec}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-71" d="M38 159Q38 209 58 260T113 355T205 425T327 452Q338 452 348 451T366 449T382 444T394 440T405 434T414 429T422 423T429 418Q440 429 481 440T533 452Q540 452 545 447T550 437Q550 432 481 152Q410 -130 410 -131T437 -132H452Q479 -132 479 -150Q476 -187 462 -192Q458 -194 451 -194Q447 -194 414 -193T330 -192Q277 -192 249 -193T217 -194Q202 -194 197 -179Q197 -175 201 -159Q206 -139 211 -136T243 -132H283L319 15L307 10Q295 4 270 -2T220 -8Q134 -8 86 37T38 159ZM402 353Q402 358 395 368T369 390T324 401Q301 401 282 394T249 369T226 338T208 297T196 258T186 218Q166 141 166 107Q166 44 229 44Q265 44 294 61T337 95Q341 100 371 222T402 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-71" x="0" y="0"></use>
<g transform="translate(552,353)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-64" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="523" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="990" y="0"></use>
</g>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="767" y="-395"></use>
</g>
</svg>作为查询向量，通过键值对注意力机制，来从输入(<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.05ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2174.2 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{K}^{enc}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-4B" d="M536 0Q522 6 522 18Q522 35 533 57Q539 62 557 62Q595 62 601 65L472 330L365 255L342 160Q318 65 317 64Q317 62 361 62H388Q420 62 420 44Q416 6 403 2L399 0L357 1Q331 2 224 2Q149 2 109 1T65 0Q48 0 43 15Q47 54 60 60Q64 62 113 62H162L302 623Q302 624 258 624H235Q214 624 209 626T199 639Q203 678 216 684Q220 686 239 686Q290 684 403 684Q475 684 512 685T553 686Q576 686 576 668Q572 632 560 626Q555 624 506 624H457L422 481Q386 339 386 337L785 621Q779 624 749 624Q726 624 726 641Q726 645 730 659Q734 675 736 679T747 686L786 685Q812 684 888 684Q908 684 934 685T968 686Q1003 686 1003 669Q1003 646 991 629Q985 624 967 624Q918 624 888 617Q884 617 874 613L865 609Q864 608 732 515T599 420Q599 418 686 242T775 65Q784 62 829 62Q847 62 850 61T860 54Q862 52 862 43Q862 10 845 1Q844 1 842 1T836 0T797 1T694 2Q599 2 573 1L536 0Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-4B" x="0" y="0"></use>
<g transform="translate(1013,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
</g>
</svg>，<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.901ex" height="2.343ex" style="vertical-align: -0.338ex;" viewBox="0 -863.1 2110 1008.6" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{V}^{enc}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-56" d="M401 686Q415 680 415 668Q415 651 404 629Q398 624 356 624Q318 624 318 623Q318 620 337 508T377 284L397 174L472 285Q548 396 623 507T699 620Q698 621 652 624Q634 624 627 627T619 641Q619 648 622 658Q627 677 631 681T650 686Q654 686 686 685T766 684Q794 684 823 684T858 685Q874 685 878 683T886 671Q886 667 882 651Q877 632 873 628T850 624Q800 624 779 617Q774 617 770 613Q767 610 560 304T350 -5Q346 -9 332 -16H306H291Q270 -16 267 -2Q267 -1 260 37T238 161T210 313L156 624H116H94Q62 624 62 642Q66 678 78 684Q82 686 99 686Q144 684 246 684Q330 684 368 685L401 686Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-56" x="0" y="0"></use>
<g transform="translate(948,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-65" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="466" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-63" x="1067" y="0"></use>
</g>
</g>
</svg>)中选取有用的信息。</p>
</li>
<li><p><strong>逐位置的前馈神经网络</strong></p>
<p>同编码器的<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="5.004ex" height="2.176ex" style="vertical-align: -0.338ex;" viewBox="0 -791.3 2154.5 936.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\mbox{FNN}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-46" d="M128 619Q121 626 117 628T101 631T58 634H25V680H582V676Q584 670 596 560T610 444V440H570V444Q563 493 561 501Q555 538 543 563T516 601T477 622T431 631T374 633H334H286Q252 633 244 631T233 621Q232 619 232 490V363H284Q287 363 303 363T327 364T349 367T372 373T389 385Q407 403 410 459V480H450V200H410V221Q407 276 389 296Q381 303 371 307T348 313T327 316T303 317T284 317H232V189L233 61Q240 54 245 52T270 48T333 46H360V0H348Q324 3 182 3Q51 3 36 0H25V46H58Q100 47 109 49T128 61V619Z"></path>
<path stroke-width="1" id="E1-MJMAIN-4E" d="M42 46Q74 48 94 56T118 69T128 86V634H124Q114 637 52 637H25V683H232L235 680Q237 679 322 554T493 303L578 178V598Q572 608 568 613T544 627T492 637H475V683H483Q498 680 600 680Q706 680 715 683H724V637H707Q634 633 622 598L621 302V6L614 0H600Q585 0 582 3T481 150T282 443T171 605V345L172 86Q183 50 257 46H274V0H265Q250 3 150 3Q48 3 33 0H25V46H42Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-46"></use>
 <use xlink:href="#E1-MJMAIN-4E" x="653" y="0"></use>
 <use xlink:href="#E1-MJMAIN-4E" x="1404" y="0"></use>
</g>
</svg>网络，用来综合得到所有的信息。</p>
</li>
</ol>
<p>与编码器一致，解码器也包括层归一化、残差连接的操作，其计算方式也相同，这里不再具体介绍。</p>
<p>解码器的解码过程可以参考下图：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/transformer_7.gif
">

</div>


<p>然后重复以上步骤，直到句子结束：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/transformer_8.gif
">
</div>


<p>解码器初始的输入要有<strong>起始符</strong>来激活解码器，这里用<code>&lt;s&gt;</code>表示(上图中没体现)，起始符是通过<strong>右移</strong>(shifted right)操作事先给定好的。结束符用p表示。将图中的例子用语言描述：</p>
<figure class="highlight vim"><table><tbody><tr><td class="code"><pre><code class="hljs vim">Step <span class="hljs-number">1</span><br>起始输入：起始符<span class="hljs-symbol">&lt;s&gt;</span>+<span class="hljs-keyword">p</span><br>中间输入：K、V<br>最终输出：I<br><br>Step <span class="hljs-number">2</span><br>起始输入：起始符<span class="hljs-symbol">&lt;s&gt;</span>+<span class="hljs-string">'I'</span>+<span class="hljs-keyword">p</span><br>中间输入：K、V<br>最终输出：I <span class="hljs-keyword">am</span><br><br>Step <span class="hljs-number">3</span><br>起始输入：起始符<span class="hljs-symbol">&lt;s&gt;</span>+<span class="hljs-string">'I'</span>+<span class="hljs-string">'am'</span>+<span class="hljs-keyword">p</span><br>中间输入：K、V<br>最终输出：I <span class="hljs-keyword">am</span> <span class="hljs-keyword">a</span><br><br>Step <span class="hljs-number">4</span><br>起始输入：起始符<span class="hljs-symbol">&lt;s&gt;</span>+<span class="hljs-string">'I'</span>+<span class="hljs-string">'am'</span>+<span class="hljs-string">'a'</span>+<span class="hljs-keyword">p</span><br>中间输入：K、V<br>最终输出：I <span class="hljs-keyword">am</span> <span class="hljs-keyword">a</span> student<br><br>Step <span class="hljs-number">5</span><br>起始输入：起始符<span class="hljs-symbol">&lt;s&gt;</span>+<span class="hljs-string">'I'</span>+<span class="hljs-string">'am'</span>+<span class="hljs-string">'a'</span>+<span class="hljs-string">'student'</span>+<span class="hljs-keyword">p</span><br>中间输入：K、V<br>最终输出：I <span class="hljs-keyword">am</span> <span class="hljs-keyword">a</span> student &lt;end of sentence&gt;<br></code></pre></td></tr></tbody></table></figure>
<hr>
<p>补充说明：</p>
<ol>
<li><p>关于<strong>掩蔽自注意力</strong>：</p>
<p>在训练过程中，为了能够一次性完成以上步骤以提高效率，将<strong>右移的目标序列</strong>(Right-Shifted Output) <svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.42ex" height="2.509ex" style="vertical-align: -1.171ex;" viewBox="0 -576.1 3194.7 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">\boldsymbol{y}_{0:(T-1)}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHBI-79" d="M206 -150Q240 -150 268 -134T314 -95T344 -48T362 -7T367 14Q339 -7 280 -7Q230 -7 195 5T144 39T122 79T115 122Q115 175 152 274T189 388Q189 396 187 398T176 401Q148 398 125 372T89 304Q84 288 81 285T61 282H55H44Q24 282 24 296Q24 306 34 329T64 381T116 431T188 452Q239 452 273 427T308 361Q308 347 273 253T237 109Q237 43 291 43T388 98Q388 99 425 246T463 396Q471 414 490 429T534 444T573 430T587 399Q587 386 537 186T483 -25Q461 -84 410 -126T296 -188Q248 -202 204 -202Q127 -202 96 -175T64 -114Q64 -82 86 -57T144 -31Q169 -31 184 -45T199 -83Q199 -89 198 -94T196 -104T193 -113T189 -120T184 -128T179 -134T173 -141T168 -147Q189 -150 206 -150Z"></path>
<path stroke-width="1" id="E1-MJMAIN-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3A" d="M78 370Q78 394 95 412T138 430Q162 430 180 414T199 371Q199 346 182 328T139 310T96 327T78 370ZM78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-54" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHBI-79" x="0" y="0"></use>
<g transform="translate(590,-187)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-30" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-3A" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-28" x="779" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-54" x="1168" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-2212" x="1873" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="2651" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-29" x="3152" y="0"></use>
</g>
</g>
</svg>作为解码器输入， 即在第<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
</g>
</svg>个位置的输入为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.066ex" height="2.009ex" style="vertical-align: -0.671ex;" viewBox="0 -576.1 1750.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">y_{t-1}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-79" d="M21 287Q21 301 36 335T84 406T158 442Q199 442 224 419T250 355Q248 336 247 334Q247 331 231 288T198 191T182 105Q182 62 196 45T238 27Q261 27 281 38T312 61T339 94Q339 95 344 114T358 173T377 247Q415 397 419 404Q432 431 462 431Q475 431 483 424T494 412T496 403Q496 390 447 193T391 -23Q363 -106 294 -155T156 -205Q111 -205 77 -183T43 -117Q43 -95 50 -80T69 -58T89 -48T106 -45Q150 -45 150 -87Q150 -107 138 -122T115 -142T102 -147L99 -148Q101 -153 118 -160T152 -167H160Q177 -167 186 -165Q219 -156 247 -127T290 -65T313 -9T321 21L315 17Q309 13 296 6T270 -6Q250 -11 231 -11Q185 -11 150 11T104 82Q103 89 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-79" x="0" y="0"></use>
<g transform="translate(490,-150)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-2212" x="361" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="1140" y="0"></use>
</g>
</g>
</svg>，通过<strong>掩码(Mask)</strong>来阻止每个位置选择后面的输入信息，只能看到<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="0.84ex" height="2.009ex" style="vertical-align: -0.338ex;" viewBox="0 -719.6 361.5 865.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">t</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-74" x="0" y="0"></use>
</g>
</svg>之前的解码结果，这种方法就称为<strong>掩蔽自注意力</strong>(Masked Self-Attention)。例如，一个3*3的矩阵，矩阵的每一行对应于解码的每一步：</p>
<script type="math/tex; mode=display">
\mbox{Mask}:
\left[
\begin{array}
{cccc}
1&0&0&0\\
1&1&0&0\\
1&1&1&0\\
1&1&1&1\\
\end{array}
\right]</script><p>而在测试/预测过程中，解码过程是一步一步计算的。每一步中解码器输出的矩阵取最后一行用来预测下一个词。</p>
</li>
<li><p>关于<strong>右移(Shifted Right)</strong>操作</p>
<p>右移操作是为了在编码器的初始输入中添加起始符<code>&lt;s&gt;</code>,例如，正常的输出序列位置关系：</p>
<figure class="highlight less"><table><tbody><tr><td class="code"><pre><code class="hljs less"><span class="hljs-attribute">0</span>:<span class="hljs-string">'I'</span><br><span class="hljs-number">1</span>:<span class="hljs-string">'am'</span><br><span class="hljs-number">2</span>:<span class="hljs-string">'a'</span><br><span class="hljs-number">3</span>:<span class="hljs-string">'student'</span><br></code></pre></td></tr></tbody></table></figure>
<p>通过右移操作后的输入序列：</p>
<figure class="highlight elixir"><table><tbody><tr><td class="code"><pre><code class="hljs elixir">0<span class="hljs-symbol">:&lt;s&gt;</span><br><span class="hljs-number">1</span><span class="hljs-symbol">:<span class="hljs-string">'I'</span></span><br><span class="hljs-number">2</span><span class="hljs-symbol">:<span class="hljs-string">'am'</span></span><br><span class="hljs-number">3</span><span class="hljs-symbol">:<span class="hljs-string">'a'</span></span><br><span class="hljs-number">4</span><span class="hljs-symbol">:<span class="hljs-string">'student'</span></span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>参考链接<a href="https://zhuanlan.zhihu.com/p/48508221">[4]</a>的内容，说明了Transformer的优缺点：</p>
<p>优点：</p>
<ul>
<li>Transformer设计足够有创新，其抛弃了在NLP中最根本的RNN或者CNN并且取得了非常不错的效果。</li>
<li>Transformer的设计最大的带来性能提升的关键是将任意两个单词的距离是1，这对解决NLP中棘手的长期依赖问题非常有效。</li>
<li>Transformer不仅可以应用在NLP的机器翻译领域，还可以应用在其他非NLP领域。</li>
<li>Transformer算法并行性很好，符合目前硬件(主要指GPU)环境。</li>
</ul>
<p>缺点：</p>
<ul>
<li>粗暴的抛弃RNN和CNN使模型丧失了捕捉局部特征的能力，RNN + CNN + Transformer的结合可能会带来更好的效果。</li>
<li>Transformer失去的位置信息在NLP中非常重要，而论文中在特征向量中加入Position Embedding只是一个权宜之计，并没有改变Transformer结构上的固有缺陷。</li>
</ul>
]]></content>
      <categories>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>Attention</tag>
        <tag>深度学习</tag>
        <tag>transformer</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM垃圾回收相关概念补充</title>
    <url>/2021/05/11/gc-related-concepts-supplement/</url>
    <content><![CDATA[<h1 id="一、System-gc-的理解"><a href="#一、System-gc-的理解" class="headerlink" title="一、System.gc()的理解"></a>一、System.gc()的理解</h1><p>默认情况下，调用<code>System.gc()</code>或者<code>Runtime.getRuntime().gc()</code>（<code>System.gc()</code>的底层方法）方法，会显式触发Full GC，同时对老年代和新生代进行回收，尝试释放被丢弃对象占用的内存。</p>
<p><code>System.gc()</code>调用附带一个免责声明，无法保证对垃圾收集器的调用，也就是说，这个方法只是提醒垃圾收集器进行垃圾回收，具体什么时候会进行垃圾回收就不一定了，此方法不保证一定会回收。</p>
<p>JVM实现者可以通过<code>System.gc()</code>调用来决定JVM的GC行为。而一般情况下，垃圾回收应该是自动进行的，无须手动触发，否则就太麻烦了。在一些特殊情况下，如我们正在编写一个性能基准，我们可以在运行之间调用<code>System.gc()</code>。</p>
<p>例一：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemGCTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-keyword">new</span> SystemGCTest();<br>        System.gc();<span class="hljs-comment">//提醒jvm的垃圾回收器执行gc,但是不确定是否马上执行gc</span><br>        <span class="hljs-comment">//与Runtime.getRuntime().gc();的作用一样。</span><br><br>        <span class="hljs-comment">//此方法会强制调用失去引用对象的finalize()方法</span><br>        <span class="hljs-comment">//System.runFinalization();</span><br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finalize</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Throwable </span>{<br>        System.out.println(<span class="hljs-string">"SystemGCTest 重写了finalize()"</span>);<br>    }<br>}<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">如果不使用System.runFinalization()方法，由于System.gc()不保证一定执行垃圾回收，</span><br><span class="hljs-comment">因此执行上述代码，finalize()方法可能会被调用，也可能不会被调用</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>例二，调用<code>System.gc()</code>进行垃圾回收：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LocalVarGC</span> </span>{<br>    <span class="hljs-comment">//buffer不会被回收</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC1</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<span class="hljs-comment">//10MB</span><br>        System.gc(); <br>    }<br><br>    <span class="hljs-comment">//buffer会被回收</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC2</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>        buffer = <span class="hljs-keyword">null</span>;<br>        System.gc();<br>    }<br>    <br>    <span class="hljs-comment">/*buffer不会被回收。</span><br><span class="hljs-comment">    查看字节码文件可知，局部变量表中存放了this和buffer两个变量,</span><br><span class="hljs-comment">    垃圾回收时发现buffer在变量表中，属于GC roots，因此不会被回收</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC3</span><span class="hljs-params">()</span> </span>{<br>        {<br>            <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>        }<br>        System.gc();<br>    }<br><br>    <span class="hljs-comment">/*buffer会被回收。</span><br><span class="hljs-comment">    查看字节码文件可知，首先局部变量表中存放了this和buffer两个变量,</span><br><span class="hljs-comment">    然后，在代码块执行完后，超出了buffer的作用范围，value重用了buffer的变量槽</span><br><span class="hljs-comment">    因此垃圾回收时，buffer会被回收。</span><br><span class="hljs-comment">    可以参考《深入理解JVM 第三版》P296</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC4</span><span class="hljs-params">()</span> </span>{<br>        {<br>            <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">10</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>];<br>        }<br>        <span class="hljs-keyword">int</span> value = <span class="hljs-number">10</span>;<br>        System.gc();<br>    }<br><br>    <span class="hljs-comment">//在localvarGC1中时，buffer没有被回收，localvarGC5中，buffer被回收。</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">localvarGC5</span><span class="hljs-params">()</span> </span>{<br>        localvarGC1();<br>        System.gc();<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        LocalVarGC local = <span class="hljs-keyword">new</span> LocalVarGC();<br>        local.localvarGC1();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="二、内存溢出与内存泄漏"><a href="#二、内存溢出与内存泄漏" class="headerlink" title="二、内存溢出与内存泄漏"></a>二、内存溢出与内存泄漏</h1><h2 id="1、内存溢出"><a href="#1、内存溢出" class="headerlink" title="1、内存溢出"></a>1、内存溢出</h2><p>内存溢出（OutOfMemoryError）：没有空间内存，并且垃圾收集器也无法提供更多内存。</p>
<p>JVM堆、方法区、虚拟机栈和本地方法栈都可能出现OOM问题，其中堆内存溢出的情况最为常见</p>
<blockquote>
<p>栈除了存在OOM的情况，当还存在StackOverflow的情况。如果线程请求的栈深度大于虚拟机所允许的最大深度，将抛出StackOverflowError异常；如果虚拟机的栈内存允许动态扩展，当扩展栈容量无法申请到足够的内存时，将抛出OOM异常。也就是说，如果栈不支持扩展，除非在创建线程申请内存时就因无法获得足够内存而出现OOM异常，否则在线程运行时是不会因为扩展而导致内存溢出的，只会因为栈容量无法容纳新的栈帧而导致StackOverflowError异常。</p>
</blockquote>
<p>导致OOM的原因有：</p>
<ul>
<li><p><strong>Java虚拟机的堆内存设置不够</strong>。可以通过<code>-Xms</code>、<code>-Xmx</code>参数来调整</p>
</li>
<li><p><strong>代码中创建了大量大对象，并且长时间不能被垃圾收集器收集（存在被引用）</strong>。比如JDK6之前的永久代，空间很小，且使用的是JVM内存，容易出现OOM问题。</p>
<blockquote>
<p>在抛出OOM之前，通常会触发一次GC，尽其所能去清理出空间。例如在引用机制分析中，涉及到JVM会去尝试回收软引用指向的对象等。在java.nio.BIts.reserveMemory()方法中，我们能清楚的看到，System.gc()会被调用，以清理空间。</p>
</blockquote>
</li>
<li><p>不是在任何情况下垃圾收集器都会被触发。比如，当分配一个超大对象，其所需空间超过堆的最大值时，JVM可以判断出垃圾收集并不能解决这个问题，所以直接抛出OutOfMemoryError。</p>
</li>
</ul>
<h2 id="2、内存泄漏"><a href="#2、内存泄漏" class="headerlink" title="2、内存泄漏"></a>2、内存泄漏</h2><p>内存泄露（Memory Leak），也称作“存储渗漏”，<strong>严格上来讲</strong>，内存泄漏指的是对象不会被程序使用了，但是GC又不能回收他们。比如不使用的对象没有断开和GC Roots引用链的连接，所以这些对象还是可达状态，无法被回收。</p>
<p>Java中会出现的内存泄漏情况：</p>
<ul>
<li>单例模式。单例的生命周期和应用程序是一样长的，所以单例程序中，如果持有对外部对象的引用的话，那么这个外部对象是不能被回收的，则会导致内存泄漏的产生。<code>java.lang.Runtime</code>类就是单例模式。</li>
<li>一些提供close的资源未关闭导致内存泄漏。比如数据库连接（<code>dataSourse.getConnection()</code>)，网络连接(<code>socket</code>)和IO连接必须手动close，否则是不能被回收的。</li>
</ul>
<blockquote>
<p>引用计数算法无法解决循环引用问题，会导致内存泄露，但是Java中不会出现这种内存泄漏，因为Java没有使用引用计数算法。</p>
</blockquote>
<p>实际情况中，一些不太好的实践或疏忽导致对象的生命周期变得很长甚至导致OOM，也可以叫做<em>宽泛意义上的“内存泄漏”</em>。</p>
<p>尽管内存泄漏并不会立刻引起程序崩溃，但是一旦发生内存泄漏，程序中的可用内存就会被逐步蚕食，直至耗尽所有内存，最终出现OOM异常，导致程序崩溃。</p>
<blockquote>
<p>这里的存储空间并不是指物理内存，而是指虚拟内存大小，这个虚拟内存大小取决于磁盘交换区设定的大小。 </p>
</blockquote>
<p>内存泄露并不一定会（或者说立即）导致内存溢出。</p>
<h1 id="三、Stop-The-World"><a href="#三、Stop-The-World" class="headerlink" title="三、Stop The World"></a>三、Stop The World</h1><p>Stop-The-World，简称STW，指的是GC事件发生过程中，会产生应用程序的停顿。<strong>停顿产生时整个应用程序所有工作线程都会被暂停，没有任何响应</strong>，有点像卡死的感觉，这个停顿称为STW。比如：</p>
<ul>
<li>可达性分析算法中枚举根节点(GC Roots)会导致所有Java执行线程停顿。<ul>
<li>分析工作必须在一个能确保一致性的快照中进行。</li>
<li>一致性指整个分析期间整个执行系统看起来像被冻结在某个时间点上。</li>
<li>如果出现分析过程中对象引用关系还在不断变化，则分析结果的准确性无法保证。</li>
</ul>
</li>
</ul>
<p>被STW中断的应用程序线程会在完成GC之后恢复，频繁中断会让用户感觉像是网速不快造成电影卡带一样，影响用户体验。所以我们需要减少STW的发生。</p>
<p>STW的发生和采用哪款GC无关，所有的GC都有这种情况。即使是号称停顿时间可控，或者（几乎）不会发生停顿的CMS、G1、ZGC收集器也不能完全避免STW情况发生，枚举根节点时也必须要停顿的。只能说垃圾回收器越来越优秀，回收效率越来越高，尽可能地缩短了暂停时间。</p>
<p>STW是JVM在后台自动发起和自动完成的。在用户不可见的情况下，把用户正常的工作线程全部停掉。</p>
<p>开发中不要用<code>system.gc ();</code>，这个方法会触发Full GC，进而导致STW的发生。</p>
<h1 id="四、垃圾回收的并行与并发"><a href="#四、垃圾回收的并行与并发" class="headerlink" title="四、垃圾回收的并行与并发"></a>四、垃圾回收的并行与并发</h1><h2 id="1、并发"><a href="#1、并发" class="headerlink" title="1、并发"></a>1、并发</h2><p>并发(Concurrent)是指<strong>一个时间段中</strong>有几个程序都处于已启动运行到运行完毕之间，且这几个程序都是在<strong>同一个处理器</strong>上运行。</p>
<p>并发不是真正意义上的同时进行，只是CPU把一个时间段划分成几个时间片段(时间区间)，然后在这几个时间区间之间来回切换，由于CPU处理的速度非常快，只要时间间隔处理得当，即可让用户感觉是多个应用程序同时在进行。</p>
<blockquote>
<p>在某个时刻，实际只有一个程序正在运行。</p>
</blockquote>
<p>比如：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/gc-related-concepts-supplement_1.png"></p>
<h2 id="2、并行"><a href="#2、并行" class="headerlink" title="2、并行"></a>2、并行</h2><p>并行(Parallel)是指当系统有一个以上CPU时，当一个CPU执行一个进程时，另一个CPU可以执行另一个进程，两个进程互不抢占CPU资源，可以同时进行。</p>
<p>决定并行的因素不是CPU的数量，而是CPU的核心数量，比如一个CPU多个核也可以并行。</p>
<p>并行适合科学计算，后台处理等弱交互场景。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/gc-related-concepts-supplement_2.png"></p>
<p>并行和并发的对比：</p>
<ul>
<li>并发指的是<strong>多个事件在同一时间段内同时发生</strong>。并行指的是<strong>多个事件在同一时刻同时发生</strong>。</li>
<li>并发的多个任务之间是互相抢占资源的。并行的多个任务之间是不互相抢占资源的。</li>
<li>只有在多CPU或者一个CPU多核的情况中，才会发生并行。否则，看似同时发注的事情，其实都是并发执行的。</li>
</ul>
<h2 id="3、垃圾回收的并行和并发"><a href="#3、垃圾回收的并行和并发" class="headerlink" title="3、垃圾回收的并行和并发"></a>3、垃圾回收的并行和并发</h2><p>对于垃圾收集器来说，并行和并发的概念具体指的是：</p>
<ul>
<li>并行(Parallel)：指多条垃圾收集线程并行工作，但此时用户线程仍处于等待状态。如ParNew、Parallel scavenge、Parallel old收集器。</li>
<li>串行(Serial)：相较于并行的概念，单线程收集。如果内存不够，则程序暂停，启动JVM垃圾回收器进行垃圾回收。回收完，再启动<br>程序的线程。比如Serial、Serial Old收集器。</li>
<li>并发(Concurrent)：指用户线程与垃圾收集线程同时执行（但不一定是并行的，可能会交替执行)，垃圾回收线程在执行时不会停顿用户程序的运行。用户程序在继续运行，而垃圾收集程序线程运行于另一个CPU上。比如CMS、G1收集器。</li>
</ul>
<h1 id="五、再谈引用"><a href="#五、再谈引用" class="headerlink" title="五、再谈引用"></a>五、再谈引用</h1><p>JDK1.2之前，Java对象只有“被引用”和“未被引用”两种状态，这些对象要么被回收，要么不能被回收。对于那些“食之无味弃之可惜”的对象，比如我们希望能描述这样一种对象：当内存空间足够时，能保存在内存中，如果内存空间在进行垃圾回收后仍然非常紧张，那就可以抛弃这些对象，类似于缓存功能，这种情况下只有“被引用”和“未被引用”两种状态是不够的。</p>
<p>JDK 1.2之后，Java对引用的概念进行了扩充，将引用分为强引用(Strongly Reference)、软引用(Soft Reference)、弱引用(Weak Reference)和虚引用(Phantom Reference)4种，这4种引用强度依次逐渐减弱。</p>
<p>如图（其中FinalReference表示终结器引用）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/gc-related-concepts-supplement_3.png"></p>
<p>4种引用关系概述：</p>
<ul>
<li><strong>强引用(StrongReference)</strong>：最传统的“引用”的定义，是指在程序代码之中普遍存在的引用赋值，即类似<code>Object obj=new O bject()</code>这种引用关系。无论任何情况下只要强引用关系还存在，垃圾收集器永远不会回收掉被强引用的对象。<strong>不回收</strong></li>
<li><strong>软引用(SoftReference)</strong>：用于描述一些“还有用，但非必须的对象”。被软引用关联着的对象，在系统将要发生内存溢出之前，将会把这些对象列入回收范围之中进行第二次回收。如果这次回收后还没有足够的内存，才会抛出内存溢出异常。<strong>内存不足即回收</strong></li>
<li><strong>弱引用（weakReference)</strong>：用于描述非必须对象。被弱引用关联的对象只能生存到下一次垃圾收集之前。当垃圾收集器工作时，无论内存空间是否足够，都会回收掉被弱引用关联的对象。<strong>发现即回收</strong></li>
<li><strong>虚引用(PhantomReference)</strong>：一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用来获得一个对象的实例。为一个对象设置虚引用关联的唯一目的就是能在这个对象被收集器回收时收到一个系统通知。<strong>对象回收跟踪</strong></li>
</ul>
<h2 id="1、强引用"><a href="#1、强引用" class="headerlink" title="1、强引用"></a>1、强引用</h2><p>强引用关联对象的主要特点是<strong>不回收</strong>。</p>
<p>在Java程序中，最常见的引用类型是强引用（普通系统99%以上都是强引用)，也就是我们最常见的普通对象引用，也是默认的引用类型。</p>
<p>当在Java语言中使用new操作符创建一个新的对象，并将其赋值给一个变量的时候，这个变量就成为指向该对象的一个强引用。</p>
<p><strong>强引用的对象是可触及的（可达的），垃圾收集器永远不会回收强引用的对象</strong>。</p>
<p>对于一个普通的对象，如果没有其他的引用关系，只要超过了引用的作用域或者显式地将相应（强）引用赋值为<code>null</code>，就是可以当做垃圾被收集了，当然具体回收时机还是要看垃圾收集策略。</p>
<p>相对的，软引用、弱引用和虚引用的对象是软可触及、弱可触及和虚可触及的，在一定条件下，都是可以被回收的。所以，<strong>强引用是造成Java内存泄漏的主要原因之一</strong>。</p>
<p>看下面的例子：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StrongReferenceTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        StringBuffer str = <span class="hljs-keyword">new</span> StringBuffer (<span class="hljs-string">"Hello"</span>);<br>        StringBuffer str1 = str;<br>        <br>        str = <span class="hljs-keyword">null</span>;<span class="hljs-comment">//取消str对“Hello”的引用</span><br>        System.gc(); <br>        <br>        <span class="hljs-keyword">try</span> {<span class="hljs-comment">//暂停一段时间，保证GC会被触发</span><br>            Thread.sleep(<span class="hljs-number">3000</span>);<br>        } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>            e.printStackTrace();<br>        }<br>        <span class="hljs-comment">//“Hello”对象不会被回收，因此可以打印出内容</span><br>        System.out.println(str1); <span class="hljs-comment">//"Hello"</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上述程序执行时，主动触发GC机制，正常来讲，GC会将str关联的“Hello”对象回收，但“Hello”被str1强引用关联着，因此实际上“Hello”对象不会被回收。</p>
<p>本例中的两个引用，都是强引用，强引用具备以下特点：</p>
<ul>
<li>强引用可以直接访问目标对象。</li>
<li>强引用所指向的对象在<strong>任何时候都不会被系统回收</strong>，虚拟机宁可抛出OOM异常，也不会回收强引用所指向对象。</li>
<li>强引用可能导致内存泄漏。</li>
</ul>
<h2 id="2、软引用"><a href="#2、软引用" class="headerlink" title="2、软引用"></a>2、软引用</h2><p>软引用关联对象的主要特点是<strong>内存不足即回收</strong>， 内存足够时不会回收软引用关联的对象。</p>
<p>软引用是用来描述一些还有用，但非必需的对象。只被软引用关联着的对象，在系统将要发生内存溢出异常前，会把这些对象列进回收范围之中进行第二次回收（第一次回收是指回收不可达对象），如果这次回收还没有足够的内存，才会抛出内存溢出异常。</p>
<blockquote>
<p>这时出现OOM异常，并不是软引用对象导致的，因为软引用对象二次回收已经被回收掉了。</p>
</blockquote>
<p>软引用通常用来实现内存敏感的缓存。比如高速缓存，如果还有空闲内存，就可以暂时保留缓存，当内存不足时清理掉，这样就保证了使用缓存的同时，不会耗尽内存。</p>
<p>垃圾回收器在某个时刻决定回收软可达的对象的时候，会清理软引用，并可选地把引用存放到一个引用队列(Reference Queue) 。</p>
<p>类似弱引用，区别是Java虚拟机会尽量让软引用的存活时间长一些，迫不得已才清理。</p>
<p>案例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SoftReferenceTest</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, String name)</span> </span>{<br>            <span class="hljs-keyword">this</span>.id = id;<br>            <span class="hljs-keyword">this</span>.name = name;<br>        }<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> id;<br>        <span class="hljs-keyword">public</span> String name;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">"[id="</span> + id + <span class="hljs-string">", name="</span> + name + <span class="hljs-string">"] "</span>;<br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//创建对象，建立软引用</span><br>        SoftReference&lt;User&gt; userSoftRef = <br>            <span class="hljs-keyword">new</span> SoftReference&lt;User&gt;(<span class="hljs-keyword">new</span> User(<span class="hljs-number">1</span>, <span class="hljs-string">"John"</span>));<br>        <span class="hljs-comment">/*上面的一行代码，等价于如下的三行代码</span><br><span class="hljs-comment">        User u1 = new User(1,"songhk");//先建立一个强引用</span><br><span class="hljs-comment">        //将创建软引用，指向强引用关联的对象</span><br><span class="hljs-comment">        SoftReference&lt;User&gt; userSoftRef = new SoftReference&lt;User&gt;(u1);</span><br><span class="hljs-comment">        u1 = null;//取消强引用，只保留软引用对对象的关联</span><br><span class="hljs-comment">        */</span><br><br>        <span class="hljs-comment">//从软引用中获得对象</span><br>        System.out.println(userSoftRef.get());<span class="hljs-comment">//[id=1, name=John]</span><br><br>        System.gc();<br>        System.out.println(<span class="hljs-string">"After GC:"</span>);<br>        <span class="hljs-comment">//由于堆空间内存足够，不会回收软引用的可达对象。</span><br>        System.out.println(userSoftRef.get());<br>        <span class="hljs-keyword">try</span> {<span class="hljs-comment">//模拟堆内存不足的情况，-Xms10m,-Xmx10m</span><br>            <span class="hljs-comment">//会发生OOM的情况</span><br>            <span class="hljs-keyword">byte</span>[] b = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">7</span>];<br>        } <span class="hljs-keyword">catch</span> (Throwable e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-comment">//再次从软引用中获取数据</span><br>            <span class="hljs-comment">//OOM之前，垃圾回收器会回收软引用的可达对象。输出null</span><br>            System.out.println(userSoftRef.get());<span class="hljs-comment">//null</span><br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>执行以上程序，发现当内存足够时，软引用关联的对象并没有被回收，接下来试图创建大对象，导致堆空间内存不足，触发GC，这时会将软引用关联的对象回收掉。最后的结果输出为<code>null</code>，说明软引用对象确实被回收掉了。</p>
<blockquote>
<p>并不是要发生OOM时才会回收软引用关联的对象，只要堆内存不能存储软引用关联的对象时，就会将软引用关联的对象回收。</p>
</blockquote>
<h2 id="3、弱引用"><a href="#3、弱引用" class="headerlink" title="3、弱引用"></a>3、弱引用</h2><p>弱引用关联对象的主要特点是<strong>发现即回收</strong>。</p>
<p>弱引用也是用来描述那些非必需对象，<strong>只被弱引用关联的对象只能生存到下一次垃圾收集发生为止</strong>。在系统GC时，<strong>只要发现弱引用，不管系统堆空间使用是否充足，都会回收掉只被弱引用关联的对象</strong>。</p>
<p>但是，由于垃圾回收器的线程通常优先级很低，因此，并不一定能很快地发现持有弱引用的对象。在这种情况下，弱引用对象可以存在较长的时间。</p>
<p>弱引用和软引用一样，在构造弱引用时，也可以指定一个引用队列，当弱引用对象被回收时，就会加入指定的引用队列，通过这个队列可以跟踪对象的回收情况。</p>
<p>软引用、弱引用都非常适合来保存那些可有可无的缓存数据。如果这么做，当系统内存不足时，这些缓存数据会被回收，不会导致内存溢出。而当内存资源充足时，这些缓存数据又可以存在相当长的时间，从而起到加速系统的作用。</p>
<p>弱引用的案例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WeakReferenceTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//构造了弱引用</span><br>        WeakReference&lt;User&gt; userWeakRef = <br>            <span class="hljs-keyword">new</span> WeakReference&lt;User&gt;(<span class="hljs-keyword">new</span> User(<span class="hljs-number">1</span>, <span class="hljs-string">"John"</span>));<br>        <span class="hljs-comment">//从弱引用中获取对象</span><br>        System.out.println(userWeakRef.get()); <span class="hljs-comment">//[id=1, name=John]</span><br><br>        System.gc();<br>        <span class="hljs-comment">//不管当前内存空间足够与否，都会回收它的内存</span><br>        System.out.println(<span class="hljs-string">"After GC:"</span>);<br>        <span class="hljs-comment">//重新尝试从弱引用中获取对象</span><br>        System.out.println(userWeakRef.get()); <span class="hljs-comment">//null</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>执行上述代码，最后一行输出结果为<code>null</code>，说明弱引用关联的对象被回收了。只要GC回收执行，弱引用关联的对象就会被回收。</p>
<h2 id="4、虚引用"><a href="#4、虚引用" class="headerlink" title="4、虚引用"></a>4、虚引用</h2><p>虚引用关联对象的主要特点是<strong>对象回收跟踪</strong>。</p>
<p>虚引用也称为“幽灵引用”或者“幻影引用”，是所有引用类型中最弱的一个。</p>
<p>一个对象是否有虚引用的存在，完全不会决定对象的生命周期。如果一个对象<strong>仅持有虚引用，那么它和没有引用几乎是一样的，随时都可能被垃圾回收器回收</strong>。</p>
<p>它不能单独使用，也<strong>无法通过虚引用来获取被引用的对象</strong>。当试图通过虚引用的get()方法取得对象时，总是nu11。</p>
<p><strong>为一个对象设置虚引用关联的唯一目的在于跟踪垃圾回收过程</strong>。比如:能在这个对象被收集器回收时收到一个系统通知。</p>
<p>虚引用必须和<strong>引用队列</strong>一起使用。虚引用在创建时必须提供一个引用队列作为参数。当垃圾回收器准备回收一个对象时，如果发现它还有虚引用，就会在回收对象后，将这个虚引用加入引用队列，以通知应用程序对象的回收情况。</p>
<p>由于虚引用可以跟踪对象的回收时间，因此，也可以将一些资源释放操作放置在虚引用中执行和记录。</p>
<p>案例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PhantomReferenceTest</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> PhantomReferenceTest obj;<span class="hljs-comment">//当前类对象的声明</span><br>    <span class="hljs-keyword">static</span> ReferenceQueue&lt;PhantomReferenceTest&gt; phantomQueue = <span class="hljs-keyword">null</span>;<span class="hljs-comment">//引用队列</span><br><br>    <span class="hljs-comment">//创建线程，一直检测引用队列，如果虚引用对象被回收了，引用队列不为空，打印回收记录</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckRefQueue</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span> </span>{<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {<br>                <span class="hljs-keyword">if</span> (phantomQueue != <span class="hljs-keyword">null</span>) {<br>                    PhantomReference&lt;PhantomReferenceTest&gt; objt = <span class="hljs-keyword">null</span>;<br>                    <span class="hljs-keyword">try</span> {<br>                        objt = (PhantomReference&lt;PhantomReferenceTest&gt;) phantomQueue.remove();<br>                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {e.printStackTrace();}<br>                    <span class="hljs-keyword">if</span> (objt != <span class="hljs-keyword">null</span>) {<br>                        System.out.println(<span class="hljs-string">"追踪垃圾回收过程：PhantomReferenceTest实例被GC了"</span>);<br>                    }<br>                }<br>            }<br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Thread t = <span class="hljs-keyword">new</span> CheckRefQueue();<br>        t.setDaemon(<span class="hljs-keyword">true</span>);<span class="hljs-comment">//设置为守护线程：当程序中没有非守护线程时，守护线程也就执行结束。</span><br>        t.start();<br><br>        phantomQueue = <span class="hljs-keyword">new</span> ReferenceQueue&lt;PhantomReferenceTest&gt;();<br>        obj = <span class="hljs-keyword">new</span> PhantomReferenceTest();<br>        <span class="hljs-comment">//构造了 PhantomReferenceTest 对象的虚引用，并指定了引用队列</span><br>        PhantomReference&lt;PhantomReferenceTest&gt; phantomRef = <span class="hljs-keyword">new</span> <br>            PhantomReference&lt;PhantomReferenceTest&gt;(obj, phantomQueue);<br><br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">//无法通过虚引用获取其关联的对象</span><br>            System.out.println(phantomRef.get()); <span class="hljs-comment">//null</span><br>            <span class="hljs-comment">//将强引用去除</span><br>            obj = <span class="hljs-keyword">null</span>;<br>            System.out.println(<span class="hljs-string">"调用GC"</span>);<br>            System.gc(); <span class="hljs-comment">//一旦将obj对象回收，就会将此虚引用存放到引用队列中。</span><br>            Thread.sleep(<span class="hljs-number">1000</span>);<br>            <span class="hljs-keyword">if</span> (obj == <span class="hljs-keyword">null</span>) {<br>                System.out.println(<span class="hljs-string">"obj 是 null"</span>);<br>            } <span class="hljs-keyword">else</span> {<br>                System.out.println(<span class="hljs-string">"obj 可用"</span>);<br>            }<br>        } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>            e.printStackTrace();<br>        }<br>    }<br>}<br><span class="hljs-comment">/*执行结果</span><br><span class="hljs-comment">null</span><br><span class="hljs-comment">调用GC</span><br><span class="hljs-comment">追踪垃圾回收过程：PhantomReferenceTest实例被GC了</span><br><span class="hljs-comment">obj 是 null</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="5、终结器引用"><a href="#5、终结器引用" class="headerlink" title="5、终结器引用"></a>5、终结器引用</h2><p><strong>终结器引用（Final Reference）</strong>用以实现对象的<code>finalize ()</code>方法。无需手动编码，其内部配合引用队列使用。</p>
<p>在GC时，终结器引用入队。由<code>Finalizer</code>线程通过终结器引用找到被引用对象并调用它的<code>finalize ()</code>方法，第二次GC时才能回收被引用对象。</p>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记06-面向对象编程(下)</title>
    <url>/2021/03/26/java-note-0601/</url>
    <content><![CDATA[<h1 id="一、关键字：static"><a href="#一、关键字：static" class="headerlink" title="一、关键字：static"></a>一、关键字：static</h1><h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p><code>static</code>：静态的，可以用来修饰属性、方法、代码块、内部类。</p>
<p>被<code>static</code>修饰的成员，有以下特点：</p>
<ul>
<li>随着类的加载而加载。</li>
<li>优先于对象存在。</li>
<li>修饰的成员，被所有对象共享。</li>
<li>访问权限允许时，可不创建对象，直接被类调用。</li>
</ul>
<blockquote>
<p>有关<code>static</code>修饰的成员特点，都可以从生命周期的角度来解释。</p>
</blockquote>
<h2 id="2、修饰属性"><a href="#2、修饰属性" class="headerlink" title="2、修饰属性"></a>2、修饰属性</h2><p><code>static</code>修饰的属性称为<strong>静态变量(类变量，类属性)</strong>，静态变量<strong>随着类的加载而加载</strong>，可以通过<code>类名.静态变量</code>的方法调用。静态变量的加载早于对象的创建，且在<strong>内存中只会存在一份</strong>，保存在<strong>方法区</strong>的<strong>静态域</strong>中。常见的静态变量：<code>System.out</code>、<code>Math.PI</code>等。</p>
<p><strong>静态变量(类变量)</strong> vs <strong>非静态变量(实例变量)</strong>：</p>
<ul>
<li>静态变量：可以通过<code>类.静态变量</code>和<code>对象.静态变量</code>两种方法调用。多个对象共享一个静态变量，通过一个对象修改此属性，其他对象调用时是被修改后的值。</li>
<li>实例变量：只能通过<code>对象.实例变量</code>的方式调用。每个对象都独立地拥有一套类中的实例变量，实例对象归具体的某个对象所有，修改某个对象的实例变量，不会影响其他对象同样的变量。</li>
</ul>
<h2 id="3、修饰方法"><a href="#3、修饰方法" class="headerlink" title="3、修饰方法"></a>3、修饰方法</h2><p><strong>静态方法</strong>vs<strong>非静态方法</strong>：</p>
<ul>
<li>静态方法：可以通过<code>类.方法</code>和<code>对象.方法</code>两种方法调用。静态方法只能调用静态方法和属性，可以通过创建对象的方法调用非静态方法和属性。静态方法不能使用<code>this</code>、<code>super</code>关键字。</li>
<li>非静态方法：既可以调用静态方法，也可以调用非静态方法。</li>
</ul>
<blockquote>
<p>静态方法不可以被重写。</p>
</blockquote>
<h2 id="4、使用场景"><a href="#4、使用场景" class="headerlink" title="4、使用场景"></a>4、使用场景</h2><ol>
<li>判断属性是否要声明为静态的：<ul>
<li>属性可以被多个对象共享，不会随着对象的不同而不同，比如银行利率。</li>
<li>类中的常量一般声明为<code>static final</code>的。</li>
</ul>
</li>
<li>判断方法是否要声明为静态的：<ul>
<li>操作静态属性的方法一般声明为静态的。</li>
<li>工具类中的方法习惯上声明为静态的，比如<code>Math</code>、<code>Arrays</code>、<code>Collections</code></li>
</ul>
</li>
</ol>
<h2 id="5、单例模式"><a href="#5、单例模式" class="headerlink" title="5、单例模式"></a>5、单例模式</h2><p><strong>单例模式</strong>，就是采取一定的方法保证在整个的软件系统中，对某个类只能存在一个对象实例，并且该类只提供一个取得其对象实例的方法。</p>
<p>设计单例模式根据以下思路：</p>
<ol>
<li>想让类只能存在一个对象实例，就要将构造器权限设置为<code>private</code>，在类内部创建此对象。这样外部不能用<code>new</code>操作符创建新的对象。</li>
<li>外部想要得到这个类的对象，就需要调用<code>public</code>的<code>static</code>方法得到此对象。</li>
<li>获取对象的方法是<code>static</code>的，则指向类内部产生的该类对象的变量也必须是<code>static</code>的。</li>
</ol>
<p>根据以上思路，有两种单例模式写法，<code>饿汉式</code>和<code>懒汉式</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//饿汉式单例模式</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bank</span></span>{<br>    <span class="hljs-comment">//1.私有化类的构造器</span><br>    <span class="hljs-keyword">private</span> Bank{}<br>    <br>    <span class="hljs-comment">//2.创建类的私有对象属性</span><br>    <span class="hljs-comment">//4.方法是静态的，则此对象属性必须是静态的</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Bank instance = <span class="hljs-keyword">new</span> Bank();<br>    <br>    <span class="hljs-comment">//3.提供公共的静态方法，返回类的对象</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bank <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> instance;<br>    }<br>}<br><br><span class="hljs-comment">//懒汉式单例模式</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bank</span></span>{<br>    <span class="hljs-comment">//1.私有化类的构造器</span><br>    <span class="hljs-keyword">private</span> Bank{}<br>    <br>    <span class="hljs-comment">//2.创建类的私有对象属性,先不初始化</span><br>    <span class="hljs-comment">//4.方法是静态的，则此对象属性必须是静态的</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Bank instance;<br>    <br>    <span class="hljs-comment">//3.提供公共的静态方法，返回类的对象</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Bank <span class="hljs-title">getInstance</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">if</span> (instance == <span class="hljs-keyword">null</span>){<br>            instance = <span class="hljs-keyword">new</span> Bank();<br>        }<br>        <span class="hljs-keyword">return</span> instance;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>饿汉式单例模式vs懒汉式单例模式：</p>
<ul>
<li>饿汉式：无论有没有使用，都创建对象实例，对象加载时间较长；但饿汉式单例模式线程安全的。</li>
<li>懒汉式：延迟对象的创建；以上写法是线程不安全的，可以修改为线程安全的。</li>
</ul>
<p>单例模式的应用：</p>
<ul>
<li>网站的计数器</li>
<li>应用程序的日志应用</li>
<li>数据库连接池</li>
<li>读取配置文件的类</li>
<li>Application</li>
<li>Windows任务管理器</li>
<li>Windows回收站</li>
</ul>
<h1 id="二、理解main方法"><a href="#二、理解main方法" class="headerlink" title="二、理解main方法"></a>二、理解main方法</h1><p><code>main()</code>方法是程序的入口，其形式为：<code>public static void main(String[] args){}</code>，从形式上可知：</p>
<ul>
<li><code>main()</code>方法也是普通的静态方法，可以通过<code>类名.main()</code>的方式调用。<code>main()</code>方法调用其他非静态方法需要创建对象，然后使用<code>对象.非静态方法</code>的方式调用。</li>
<li><code>main()</code>有参数，可以作为与控制台交互的方式。</li>
</ul>
<h1 id="三、类的成员之四：代码块"><a href="#三、类的成员之四：代码块" class="headerlink" title="三、类的成员之四：代码块"></a>三、类的成员之四：代码块</h1><ol>
<li><p>代码块没有名字，自动执行。</p>
</li>
<li><p>作用：代码块用于对Java类或对象进行初始化。</p>
</li>
<li>一个类中可以定义多个代码块，按照先后顺序执行。</li>
<li>代码块如果有修饰符，只能使用<code>static</code>修饰。</li>
<li><strong>静态代码块</strong>：<ul>
<li>内部可以有输出语句。</li>
<li><strong>随着类的加载而执行</strong>，只会执行一次。</li>
<li>作用：用来初始化类的信息，比如对类变量赋值。</li>
</ul>
</li>
<li><strong>非静态代码块</strong>：<ul>
<li>内部可以有输出语句。</li>
<li>随着对象的创建而执行，每创建一次对象就执行一次。</li>
<li><strong>非静态代码块先于构造器执行</strong>。</li>
<li>作用：可以在创建对象时，对对象的属性进行初始化。</li>
</ul>
</li>
<li>静态代码块和静态方法类似，只能直接调用静态方法和属性。</li>
<li>代码块应用举例：</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BlockTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Student student = <span class="hljs-keyword">new</span> Student();<br>    }<br>    <span class="hljs-keyword">static</span> { <span class="hljs-comment">//先加载BlockTest类，再加载Person类</span><br>        System.out.println(<span class="hljs-string">"BlockTest block"</span>);<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span></span>{}<br>    <span class="hljs-comment">//非静态代码块</span><br>    {System.out.println(<span class="hljs-string">"Person block"</span>);}<br>    <br>    <span class="hljs-comment">//静态代码块</span><br>    <span class="hljs-keyword">static</span>{System.out.println(<span class="hljs-string">"Person static block"</span>);}<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Student</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-string">"Student constructor"</span>);<br>    }<br>    <br>    {System.out.println(<span class="hljs-string">"Student block"</span>);}<br>    <br>    <span class="hljs-keyword">static</span> {System.out.println(<span class="hljs-string">"Student static block"</span>);}<br>}<br><span class="hljs-comment">/* </span><br><span class="hljs-comment">以上程序运行结果：</span><br><span class="hljs-comment">BlockTest block         //先加载主类</span><br><span class="hljs-comment">Person static block	//声明子类对象变量时，先加载父类，执行父类的静态代码块</span><br><span class="hljs-comment">Student static block	//然后加载子类，执行子类的静态代码块</span><br><span class="hljs-comment">Person block		//执行new语句通过构造器创建对象时，先执行父类非静态代码块</span><br><span class="hljs-comment">Student block		//然后执行子类代码块</span><br><span class="hljs-comment">Student constructor     //最后执行构造器</span><br><span class="hljs-comment">/*</span><br></code></pre></td></tr></tbody></table></figure>
<p>以上结论可以总结为：<strong>由父及子，静态先行</strong>。</p>
<p><strong>属性赋值的方式以及顺序</strong>：</p>
<ol>
<li>默认初始化</li>
<li>显式初始化；多个代码块赋值(这两种方式根据代码顺序执行)</li>
<li>构造器初始化</li>
<li>创建对象以后，通过对象调用属性或方法进行赋值</li>
</ol>
<h1 id="四、关键字：final"><a href="#四、关键字：final" class="headerlink" title="四、关键字：final"></a>四、关键字：final</h1><p><code>final</code>：最后的，可以用来修饰<code>类</code>、<code>方法</code>、<code>变量</code>。</p>
<ul>
<li><code>final</code>修饰<code>类</code>：表示此<code>类</code>不能被其他类继承，比如<code>String</code>类、<code>System</code>类、<code>StringBuffer</code>类等</li>
<li><code>final</code>修饰<code>方法</code>：表明此<code>方法</code>不能被重写，比如<code>Object</code>类的<code>getClass()</code>方法</li>
<li><code>final</code>修饰<code>变量</code>：包括<code>属性</code>和<code>局部变量</code>，表示变量的值不允许被修改，此时的变量称为<code>常量</code>。<ul>
<li><code>final</code>修饰<code>属性</code>，可以直接赋值，也可以先声明，然后在<code>代码块</code>中、<code>构造器</code>中再初始化赋值。</li>
<li><code>构造器</code>中初始化常量，可以通过<code>形参</code>为每个对象设置不同的常量值，比如身份证号。</li>
<li><code>final</code>修饰<code>局部变量</code>时，对于方法内部的<code>局部变量</code>，使用<code>final</code>修饰变为<code>常量</code>；对于<code>final</code>修饰的<code>形参</code>，调用方法的时候赋值，然后不允许再修改。</li>
</ul>
</li>
</ul>
<blockquote>
<p><code>static final</code>用来修饰的<code>属性</code>，称为<code>全局常量</code>。</p>
</blockquote>
<h1 id="五、抽象类与抽象方法"><a href="#五、抽象类与抽象方法" class="headerlink" title="五、抽象类与抽象方法"></a>五、抽象类与抽象方法</h1><p><code>abstract</code>：抽象的，可以用来修饰<code>类</code>、<code>方法</code>。</p>
<h2 id="1、抽象类"><a href="#1、抽象类" class="headerlink" title="1、抽象类"></a>1、抽象类</h2><p><code>abstract</code>修饰的类称为抽象类。</p>
<ul>
<li>抽象类<strong>不能实例化对象</strong>，可以使用多态。</li>
<li>抽象类中<strong>一定有构造器</strong>，便于子类实例化时调用。</li>
<li>实际开发中会提供抽象类的子类，让子类对象实例化，完成相关操作。</li>
</ul>
<h2 id="2、抽象方法"><a href="#2、抽象方法" class="headerlink" title="2、抽象方法"></a>2、抽象方法</h2><p><code>abstract</code>修饰的方法称为<code>抽象方法</code>。</p>
<ul>
<li>抽象方法只有方法的声明，没有方法体（没有<code>{}</code>），例：<code>public void showInfo();</code></li>
<li>包含抽象方法的类一定是抽象类，反之，抽象类可以没有抽象方法。</li>
<li>只有子类<strong>实现</strong>（类似于重写）了父类中的<strong>所有抽象方法</strong>(包括<strong>直接父类</strong>和<strong>间接父类</strong>的所有抽象方法)，此子类才可以实例化，否则该子类也是抽象类。</li>
</ul>
<blockquote>
<p>1.<code>abstract</code>不能修饰变量、构造器、代码块。</p>
<p>2.因为抽象方法必须要被实现(重写)，所以<code>abstract</code>不能用来修饰<code>private</code>方法、<code>static</code>方法、<code>final</code>的方法。同样，<code>abstract</code>也不能修饰<code>final</code>的类。</p>
</blockquote>
<h2 id="3、匿名子类"><a href="#3、匿名子类" class="headerlink" title="3、匿名子类"></a>3、匿名子类</h2><p>定义抽象类<code>Person</code>的匿名子类：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Person p = <span class="hljs-keyword">new</span> Person(){<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>{ <br>        System.out.println(<span class="hljs-string">"eat"</span>);<br>    }<br>}; <span class="hljs-comment">//匿名子类需要重写父类的抽象方法</span><br><br><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">()</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、接口-interface"><a href="#六、接口-interface" class="headerlink" title="六、接口(interface)"></a>六、接口(interface)</h1><p><code>interface</code>：接口。接口定义的是一组规则，是和类并列的结构。继承是一种“是不是”的关系，而接口是“能不能“的关系。定义接口：<code>interface Flyable{}</code></p>
<ul>
<li><code>JDK 7</code>及以前，接口中只能定义全局常量和抽象方法。<ul>
<li>全局常量：默认权限是<code>public static final</code>，关键字可以省略不写。全局常量可以通过<code>接口.常量</code>调用。</li>
<li>抽象方法：默认权限是<code>public abstract</code>，关键字同样可以不写</li>
</ul>
</li>
<li><p><code>JDK 8</code>及以后，接口中除了能够定义全局常量和抽象方法以外，还能够定义静态方法，默认(<code>default</code>)方法。</p>
<ul>
<li>接口中定义的静态方法，只能使用接口调用，即<code>接口.静态方法</code>。</li>
<li>实现类如果调用接口的默认方法，使用<code>接口.super.默认方法</code>的方式调用。</li>
<li>通过实现类的对象，可以调用接口的默认方法。<strong>默认方法可以被重写，但不是必须的，不强制，接口中的抽象方法必须被重写</strong>。</li>
<li>如果子类继承的父类和实现的接口中声明了同名同参的方法，如果子类没有重写，默认调用的是父类中的方法。(类优先原则)</li>
<li>如果实现类同时实现了多个接口，这多个接口中定义了同名同参的默认方法，实现类必须重写此方法，否则报错。(接口冲突)</li>
</ul>
</li>
<li><p>接口中<strong>不能定义构造器</strong>，即接口不能够实例化。</p>
</li>
<li>接口通过被类<code>实现(implements)</code>来使用。实现类必须实现接口的所有抽象方法，此类才能被实例化，否则此类必须定义为抽象类。</li>
<li>Java类可以同时实现多个接口，弥补了Java无法多继承的缺陷。<code>implements</code>关键字在<code>extends</code>后面，比如父类B的子类A，实现了C、D两个接口：<code>class A extends B implements C,D{}</code></li>
<li>接口和接口之间可以继承，而且可以多继承。接口的具体使用体现了多态性。</li>
<li>接口的匿名实现类，格式和抽象类的匿名子类相同。</li>
</ul>
<h1 id="七、类的成员之五：内部类"><a href="#七、类的成员之五：内部类" class="headerlink" title="七、类的成员之五：内部类"></a>七、类的成员之五：内部类</h1><p>Java中允许将一个<code>类A</code>声明在另一个<code>类B</code>中，则<code>类A</code>是<code>内部类</code>，<code>类B</code>是<code>外部类</code>。<code>内部类</code>和<code>外部类</code>的类名不能相同。</p>
<p>根据声明的位置不同，内部类又分为<code>成员内部类</code>和<code>局部内部类</code>(方法内、代码块内、构造器内)</p>
<h2 id="1、成员内部类"><a href="#1、成员内部类" class="headerlink" title="1、成员内部类"></a>1、成员内部类</h2><p>成员内部类直接声明在类的内部，有两种身份：<strong>作为类的成员</strong>，<strong>作为一个类</strong>。</p>
<p>作为类的成员，具有类的成员的特征：</p>
<ul>
<li>可以调用外部类的结构</li>
<li>可以被<code>static</code>修饰</li>
<li>可以被四种不同的权限修饰符修饰</li>
</ul>
<p>作为一个类，具有类的功能：</p>
<ul>
<li>成员内部类内可以定义属性、方法、构造器等，和一般的类定义相同</li>
<li>可以被<code>final</code>修饰，表示不可以被继承。不加<code>final</code>则表示可以被继承</li>
<li>可以被<code>abstract</code>修饰</li>
</ul>
<blockquote>
<p>1.非static的成员内部类中的成员不能声明为static的，只有外部类，或者static的成员内部类中才可以声明static成员。</p>
<p>2.外部类访问成员内部类的成员，通过<code>内部类.成员</code>或<code>内部类对象.成员</code>的方式。</p>
<p>3.成员内部类可以直接使用外部类的所有成员，包括私有的数据。</p>
</blockquote>
<h2 id="2、局部内部类"><a href="#2、局部内部类" class="headerlink" title="2、局部内部类"></a>2、局部内部类</h2><p><strong>局部内部类</strong>是声明在方法内、代码块内、构造器内的类。</p>
<p>局部内部类只能在声明它的方法或代码块中使用，但是局部内部类的对象可以通过外部方法的返回值返回使用，返回值类型只能是局部内部类的父类或父接口类型。</p>
<ul>
<li>局部内部类可以使用外部类的成员，包括私有的。</li>
<li>局部内部类可以使用外部方法的局部变量，但必须是<code>final</code>的。JDK 8之后可以省略<code>final</code>关键字。</li>
<li>和局部变量类似，局部内部类不能使用四种权限修饰符。</li>
<li>局部内部类不能使用<code>static</code>修饰，也不能包含静态成员。</li>
</ul>
<h2 id="3、内部类的使用"><a href="#3、内部类的使用" class="headerlink" title="3、内部类的使用"></a>3、内部类的使用</h2><p>实例化<strong>成员内部类</strong>的对象：</p>
<ul>
<li>静态成员内部类：<code>外部类.内部类 对象名 = new 外部类.内部类();</code></li>
<li>非静态成员内部类：①创建外部类对象：<code>外部类 p = new 外部类();</code>②<code>外部类.内部类 对象名 = p.new 内部类();</code></li>
</ul>
<p>在成员内部类中区分调用外部类的结构：</p>
<ul>
<li><code>this.属性</code>表示内部类的属性</li>
<li><code>外部类.this.属性</code>表示调用外部类的属性</li>
</ul>
<p>局部内部类中的使用案例：如下面代码中的<code>public Comparable getComparable(){}</code></p>
<p>内部类的使用代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-comment">//静态成员内部类</span><br>    <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Brain</span></span>{<br>    }<br>    <br>    <span class="hljs-comment">//非静态成员内部类</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Heart</span></span>{ }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">int</span> num = <span class="hljs-number">10</span>;<br>        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AA</span></span>{<br>            <span class="hljs-keyword">int</span> aa = num;<br>        } <span class="hljs-comment">//方法中的局部内部类</span><br>        <span class="hljs-comment">//num = 20; //编译错误。局部内部类调用了num，则num是final的，不可以被修改。</span><br>    }<br>    <br>    {<br>        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BB</span></span>{} <span class="hljs-comment">//代码块中的局部内部类</span><br>    }<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CC</span></span>{} <span class="hljs-comment">//构造器中的局部内部类</span><br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Comparable <span class="hljs-title">getComparable</span><span class="hljs-params">()</span></span>{  <span class="hljs-comment">//返回一个实现了Comparable接口的类的对象</span><br>        <span class="hljs-comment">//方式一，定义局部内部类</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        class MyComparable implements Comparable{</span><br><span class="hljs-comment">            public int compareTo(Object o){</span><br><span class="hljs-comment">                return 0;</span><br><span class="hljs-comment">            }</span><br><span class="hljs-comment">        }</span><br><span class="hljs-comment">        return new MyComparable();</span><br><span class="hljs-comment">        */</span><br><br>        <span class="hljs-comment">//方式二：使用匿名实现类，返回匿名实现类的匿名对象</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Comparable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compareTo</span><span class="hljs-params">(Object o)</span> </span>{<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;}<br>        };<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>内部类在编译后，也会生成字节码文件：</p>
<p>①成员内部类：<code>外部类$内部类名.class</code></p>
<p>​                            例如：<code>Person$Brain.class</code></p>
<p>②局部内部类：<code>外部类$数字 内部类名.class</code></p>
<p>​                            例如：<code>Person$1AA.class</code></p>
</blockquote>
<h2 id="4、匿名内部类"><a href="#4、匿名内部类" class="headerlink" title="4、匿名内部类"></a>4、匿名内部类</h2><p><strong>匿名内部类</strong>不能定义任何静态成员、方法和类，只能创建匿名内部类的一个实例。一个匿名内部类一定是在<code>new</code>的后面，用其隐含实现一个接口或实现一个类。</p>
<p>格式：</p>
<p><code>new 父类构造器(实参列表)|实现接口(){</code></p>
<p>​        <code>//匿名内部类的类体部分</code></p>
<p>​    <code>}</code></p>
<p>匿名内部类特点：</p>
<ul>
<li>匿名内部类必须继承父类或实现接口。</li>
<li>只能有一个对象。</li>
<li>对象只能使用多态形式引用。</li>
</ul>
<p>匿名内部类举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Product</span></span>{<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getPrice</span><span class="hljs-params">()</span></span>;<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span></span>;<br>}<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnonymousTest</span></span>{<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">(Product p)</span></span>{<br>		System.out.println(<span class="hljs-string">"购买了一个"</span> + p.getName() + <span class="hljs-string">"，花掉了"</span> + p.getPrice());<br>	}<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>		AnonymousTest ta = <span class="hljs-keyword">new</span> AnonymousTest();<br>		<span class="hljs-comment">//调用test方法时，需要传入一个Product参数，</span><br>		<span class="hljs-comment">//此处传入其匿名实现类的实例，匿名内部类。</span><br>		ta.test(<span class="hljs-keyword">new</span> Product(){ <br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> <span class="hljs-title">getPrice</span><span class="hljs-params">()</span></span>{<br>				<span class="hljs-keyword">return</span> <span class="hljs-number">567.8</span>;<br>			}<br>			<span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span></span>{<br>				<span class="hljs-keyword">return</span> <span class="hljs-string">"AGP显卡"</span>;<br>			}<br>		});<br>	}<br>}<br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记08-多线程</title>
    <url>/2021/04/03/java-note-0801/</url>
    <content><![CDATA[<h1 id="一、程序、进程、线程"><a href="#一、程序、进程、线程" class="headerlink" title="一、程序、进程、线程"></a>一、程序、进程、线程</h1><ul>
<li><strong>程序(program)</strong>：是为完成特定任务、用某种语言编写的一组指令的集合，即指一段静态的代码，静态对象。</li>
<li><strong>进程(process)</strong>：是程序的一次执行过程，是正在运行的一个程序。<ul>
<li>是一个动态的过程，有自身的产生、存在和消亡的过程——即<strong>生命周期</strong>。</li>
<li>程序是<strong>静态</strong>的，进程是<strong>动态</strong>的。</li>
<li><strong>进程是资源分配的单位</strong>，系统在运行时会为每个进程分配不同的内存区域。</li>
</ul>
</li>
<li><strong>线程(thread)</strong>：进程可进一步细化为线程，是一个<strong>程序内部的一条执行路径</strong>。 <ul>
<li>若一个进程同一时间并行执行多个线程，就是支持<strong>多线程</strong>的。</li>
<li><strong>线程是调度和执行的单位</strong>，每个线程拥有独立的<strong>运行栈</strong>和<strong>程序计数器(pc)</strong>，线程切换开销小。 </li>
<li>一个进程的多个线程共享进程的<strong>堆</strong>和<strong>方法区</strong>，每个线程有自己的<strong>程序计数器、虚拟机栈和本地方法栈</strong>，这些线程从同一堆中分配对象，可以访问相同的变量和对象。</li>
<li>多个线程操作共享的系统资源可能会带来安全的隐患。</li>
</ul>
</li>
</ul>
<blockquote>
<p>一个Java程序java.exe，至少有三个线程：main()主线程、gc()垃圾回收线程、异常处理线程。</p>
</blockquote>
<p>JVM结构：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-0801_1.jpg">
</div>

<ol>
<li><strong>方法区(Method Area)</strong>：存储类结构信息，包括常量池、静态变量、构造函数等。JVM规范把方法区描述为堆的一个逻辑部分，但它有个别名non-heap(非堆)。方法区还包含运行时常量池</li>
<li><strong>堆(Heap)</strong>：存储Java实例或者对象，是GC的主要区域。</li>
<li><strong>虚拟机栈(VM Stack，Stack，Java Stack)</strong>：即Java栈，每当创建一个线程时，JVM就会为这个线程创建一个其私有的Java栈。在这个栈中包含多个栈帧，每运行一个方法就创建一个栈帧，用于存储局部变量表、操作栈、方法返回值等。每一个方法从调用直至执行完成的过程，就对应一个栈帧在Java栈中入栈到出栈的过程。</li>
<li><strong>程序计数器(PC Register)</strong>：保存当前线程执行的内存地址。由于JVM程序是多线程执行的（线程轮流切换），所以为了保证线程切换回来后，还能恢复到原先状态，就需要一个独立的计数器，记录之前中断的地方。</li>
<li><strong>本地方法栈(Native Method Stack)</strong>：和Java栈的作用类似，只不过是为JVM使用到的native方法服务的。</li>
</ol>
<p>参考：<a href="https://www.zhihu.com/question/264627396">java中进程与线程的概念</a></p>
<p>并行和并发：</p>
<ul>
<li>并行：多个CPU同时执行多个任务。</li>
<li>并发：一个CPU(采用时间片)同时执行多个任务。</li>
</ul>
<h1 id="二、线程的创建和使用"><a href="#二、线程的创建和使用" class="headerlink" title="二、线程的创建和使用"></a>二、线程的创建和使用</h1><p>线程的创建方式共有四种：继承<code>Thread</code>类、实现<code>Runnable</code>接口、实现<code>Callable</code>接口(5.0新增)、使用线程池(5.0新增)。</p>
<h2 id="1、Thread类"><a href="#1、Thread类" class="headerlink" title="1、Thread类"></a>1、Thread类</h2><p>创建线程的第一种方式是继承<code>Thread</code>类：</p>
<ul>
<li>创建继承<code>Thread</code>类的子类。</li>
<li>重写<code>run()</code>方法，将此线程执行的操作声明的此方法中。</li>
<li>创建子类的对象，然后使用此对象调用<code>start()</code>方法。</li>
</ul>
<blockquote>
<p>①<code>start()</code>方法的作用：启动当前线程；调用当前线程的<code>run()</code>方法。</p>
<p>②启动多线程，必须调用<code>start()</code>方法，不能通过直接调用<code>run()</code>的方式启动线程。</p>
<p>③不能让已经<code>start()</code>的线程再<code>start()</code>，即一个线程不能启动多次，否则报<code>IllegalThreadStateException</code>异常。</p>
<p>④如果想创建多个线程，需要创建多个对象。</p>
</blockquote>
<p>实现代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//3.创建Thread类的子类的对象</span><br>        MyThread1 mt = <span class="hljs-keyword">new</span> MyThread1();<br>        <span class="hljs-comment">//4.通过此对象调用start()方法</span><br>        mt.start(); <span class="hljs-comment">//主线程使用mt对象调用了start方法，启动新线程。</span><br>        <span class="hljs-comment">// start方法能够使线程执行，JVM调用这个线程的run方法</span><br><br>        <span class="hljs-comment">//这里是主线程运行</span><br>        <span class="hljs-comment">//同时运行两个线程，输出顺序就不确定，每个线程的输出也可能交叉</span><br>        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100</span>;i++){<br>            <span class="hljs-keyword">if</span>(i % <span class="hljs-number">2</span> != <span class="hljs-number">0</span>)<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">":"</span>+i);<br>        }<br>    }<br>}<br><span class="hljs-comment">// 1.创建一个继承于Thread类的子类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thread</span></span>{<br>    <span class="hljs-comment">//2.重写Thread的run()</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt;<span class="hljs-number">100</span>;i++){<br>            <span class="hljs-keyword">if</span>(i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">":"</span>+i);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>Thread</code>类的相关方法：</p>
<ul>
<li><code>start()</code>：启动线程，并执行对象的run()方法</li>
<li><code>run()</code>：线程被调度时执行的操作</li>
<li><code>currentThread()</code>：返回当前线程，在Thread子类中就是this，通常用于主线程和Runnable实现类</li>
<li><code>getName()</code>：返回线程名称</li>
<li><code>setName()</code>：设置线程名称</li>
<li><code>yield()</code>：线程让步，释放当前cpu的执行权。暂停当前正在执行的线程，把执行机会让给优先级相同或更高的线程。</li>
<li><code>join()</code>：在线程A中调用线程B的<code>join()</code>方法，此时A进入阻塞状态，直到线程B完全执行完以后，线程A才结束阻塞状态</li>
<li><code>sleep(long millitime)</code>：让当前线程指定时间内放弃对CPU的控制。指定的毫秒时间内，当前线程是阻塞状态。</li>
<li><code>isAlive()</code>：判断线程是否活着</li>
<li><code>stop()</code>：已过时。强制结束当前线程</li>
<li><code>suspend()</code>：已过时</li>
<li><code>resume()</code>：已过时</li>
</ul>
<p>线程的优先级：</p>
<p><code>MAX_PRIORITY</code>：10</p>
<p><code>MIN_PRIORITY</code>：1</p>
<p><code>NORM_PRIORITY</code>：5</p>
<p>方法：</p>
<ul>
<li><code>getPriority()</code>：返回线程优先级</li>
<li><code>setPriority(int newPriority)</code>：改变线程优先级</li>
</ul>
<blockquote>
<p>线程创建时继承父线程的优先级</p>
<p>低优先级的线程只是获得调度的概率低，并不是说低优先级线程一定在高优先级线程执行完之后执行。</p>
</blockquote>
<p><strong>守护线程</strong>和<strong>用户线程</strong></p>
<ul>
<li>二者几乎每个方面都是相同的，唯一的区别是判断JVM何时离开。</li>
<li>守护线程是用来服务用户线程的，可以通过在<code>start()</code>方法前调用<code>thread.setDaemon(true)</code>把用户线程变成守护线程。</li>
<li>守护线程比如Java垃圾回收。当JVM中都是守护线程时，当前JVM将退出</li>
</ul>
<h2 id="2、Runnable接口"><a href="#2、Runnable接口" class="headerlink" title="2、Runnable接口"></a>2、Runnable接口</h2><p>创建线程的第二种方式是实现<code>Runnable</code>接口：</p>
<ul>
<li>创建类，实现实现<code>Runnable</code>接口。</li>
<li>重写<code>run()</code>方法。</li>
<li>创建实现类对象，作为参数传入<code>Thread</code>类的构造器。</li>
<li><code>Thread</code>类的对象调用<code>start()</code>方法启动线程。</li>
</ul>
<blockquote>
<p>①实现接口的方法，避免了单继承的局限性。</p>
<p>②多个线程共享一个接口实现类的对象，非常适合多个相同线程处理同一份资源。</p>
<p>③和方法一相比，实现<code>Runnable</code>接口的方法优先使用。</p>
</blockquote>
<p>实现代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadTest2</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        MyThread2 mt = <span class="hljs-keyword">new</span> MyThread2();<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(mt,<span class="hljs-string">"Thread-1"</span>);<br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(mt,<span class="hljs-string">"Thread-2"</span>);<br>        <span class="hljs-comment">//启动多个线程，只需要新建Thread对象，两个线程共享Runnable实现类对象</span><br>        t1.start();<br>        t2.start();<br>    }<br>}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span></span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i&lt; <span class="hljs-number">100</span>; i++)<br>            System.out.println(Thread.currentThread().getName());<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、Callable接口"><a href="#3、Callable接口" class="headerlink" title="3、Callable接口"></a>3、Callable接口</h2><p>创建线程的第三种方法是实现<code>Callable</code>接口(JDK 5.0新增)：</p>
<ul>
<li>声明实现<code>Callable</code>接口的实现类。</li>
<li>重写<code>call()</code>方法。</li>
<li>声明实现类对象，比如<code>mt3</code>。</li>
<li>声明<code>FutureTask</code>类对象<code>ft</code>，构造器参数为实现类对象<code>mt3</code>。</li>
<li>声明<code>Thread</code>类对象<code>t</code>，构造器参数为<code>FutureTask</code>类对象<code>ft</code>。</li>
<li>通过对象<code>t</code>调用<code>start()</code>方法，启动并运行线程。</li>
</ul>
<blockquote>
<p>①<code>Future</code>接口可以对具体<code>Runnable</code>、<code>Callable</code>任务的执行结果进行取消、查询是否完成、获取结果等。</p>
<p>②<code>FutureTask</code>是<code>Future</code>接口唯一的实现类。</p>
<p>③<code>FutrueTask</code>同时实现了<code>Runnable</code>、<code>Future</code>接口，它<strong>既可以作为<code>Runnable</code>被线程执行</strong>，<strong>也可以作为<code>Future</code>得到<code>Callable</code>的返回值</strong>。</p>
</blockquote>
<p>实现<code>Callable</code>接口和实现<code>Runnable</code>接口相比，前者更强大，因为：</p>
<ul>
<li><code>call()</code>方法可以有返回值。</li>
<li><code>call()</code>可以抛出异常，被外面的操作捕获，获取异常信息</li>
<li><code>Callable</code>支持泛型。</li>
</ul>
<p>实现代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadThree</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//创建实现类的对象</span><br>        NumThread numThread = <span class="hljs-keyword">new</span> NumThread(); <br>        <span class="hljs-comment">//创建FutureTask类对象，将实现类对象作为参数</span><br>        FutureTask futureTask = <span class="hljs-keyword">new</span> FutureTask(numThread); <br>        <span class="hljs-comment">//创建Thread类对象，将futureTask作为Runnable被线程执行</span><br>        <span class="hljs-keyword">new</span> Thread(futureTask).start();  <br><br>        <span class="hljs-comment">//FutureTask作为Future得到Callable的返回值</span><br>        <span class="hljs-keyword">try</span> {<span class="hljs-comment">//get的返回值即numThread重写的call的返回值</span><br>            Object num = futureTask.get();  <br>            System.out.println(num);<br>        } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">catch</span> (ExecutionException e) {<br>            e.printStackTrace();<br>        }<br>    }<br>}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NumThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Callable</span></span>{ <span class="hljs-comment">//实现Callable接口，并重写call方法</span><br>    <span class="hljs-comment">//call()函数有返回值，且能够抛出异常</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        <span class="hljs-keyword">int</span> sum = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">100</span>; i++) {<br>            <span class="hljs-keyword">if</span>(i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>){<br>                System.out.println(i);<br>                sum += i;<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> sum;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、线程池"><a href="#4、线程池" class="headerlink" title="4、线程池"></a>4、线程池</h2><p>创建线程的第四种方式是使用线程池(JDK 5.0新增)。</p>
<p>经常创建和销毁、使用量特别大的资源，比如并发情况下的线程，对性能影响很大。线程池的思想是提前创建好多个线程，放入线程池中，使用时直接获取，使用完放回池中。可以避免频繁创建销毁、实现重复利用。</p>
<p>线程池的优势：</p>
<ul>
<li>提高响应速度（减少了创建新线程的时间）。</li>
<li>降低资源消耗（重复利用线程池中线程，不需要每次都创建）。</li>
<li>便于线程管理。</li>
</ul>
<p>JDK 5.0 提供了线程池相关的API：<code>ExecutorService</code>接口和<code>Executors</code>工具类。</p>
<ul>
<li><p><code>ThreadPoolExecutor</code>是<code>ExecutorService</code>的常见实现类，其中的常用方法：</p>
<ul>
<li><code>corePoolSize</code>：核心池大小</li>
<li><code>maximumPoolSize</code>：最大线程数</li>
<li><code>keepAliveTime</code>：线程没有任务时，最多保持多长时间后会终止</li>
</ul>
</li>
<li><p><code>ExecutorService</code>：真正的线程池接口，常见的实现类为<code>ThreadPoolExecutor</code></p>
<ul>
<li><code>void execute(Runnable command)</code>:执行任务/命令，一般用来执行<code>Runnable</code></li>
<li><code>&lt;T&gt;Future&lt;T&gt; submit(Callable&lt;T&gt; task)</code>:执行任务，有返回值，一般用来执行<code>Callable</code></li>
<li><code>void shutdown()</code>：关闭连接池。</li>
</ul>
</li>
<li><p><code>Executors</code>：工具类、线程池的工厂类，用于创建并返回不同类型的线程池。</p>
<ul>
<li><code>Executors.newCachedThreadPool()</code>：创建一个可根据需要创建新线程的线程池</li>
<li><code>Executors.newFixedThreadPool(n)</code>：创建一个可重用的固定线程数的线程池</li>
<li><code>Executors.newSingleThreadExecutor()</code>：创建一个只有一个线程的线程池</li>
<li><code>Executors.newScheduledThreadPool(n)</code>：创建一个线程池，可安排在给定延迟后运行命令或者定期地执行</li>
</ul>
</li>
</ul>
<p>使用步骤：<br>    1.提供指定线程数量的线程池：调用工具类的方法创建线程池，返回ThreadPoolExecutor对象。<br>    2.执行指定的线程的操作，需要提供实现Runnable接口或Callable接口实现类的对象。<br>    3.关闭线程池。</p>
<p>具体代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadPool</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//1.提供指定线程数量的线程池</span><br>        ExecutorService service = Executors.newFixedThreadPool(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">//ThreadPoolExecutor类实现了ExecutorService接口</span><br>        ThreadPoolExecutor service1 = (ThreadPoolExecutor) service;<br>        <span class="hljs-comment">//通过service1，可以设置线程池的属性...</span><br>        service1.setMaximumPoolSize(<span class="hljs-number">15</span>);<br><br>        <span class="hljs-comment">//2.执行指定的线程的操作，需要提供实现Runnable接口或Callable接口实现类的对象</span><br>        service.execute(<span class="hljs-keyword">new</span> NumThreadFour()); <span class="hljs-comment">//适合于Runnable,分配线程1</span><br>        service.execute(<span class="hljs-keyword">new</span> NumThreadFour2()); <span class="hljs-comment">//适合于Runnable，分配线程2</span><br>        service.submit(<span class="hljs-keyword">new</span> FutureTask(<span class="hljs-keyword">new</span> NumThreadFour3())); <span class="hljs-comment">//适合于Callable，分配线程3</span><br>        <span class="hljs-comment">//3.关闭线程池</span><br>        service.shutdown();<br>    }<br>}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NumThreadFour</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>{...}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NumThreadFour2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>{...}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NumThreadFour3</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Callable</span> </span>{...}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、线程的生命周期"><a href="#三、线程的生命周期" class="headerlink" title="三、线程的生命周期"></a>三、线程的生命周期</h1><p>一个线程的完整生命周期有六种状态，在<code>Thread</code>类中的<code>State</code>枚举类定义了线程的五种状态：</p>
<ul>
<li><strong>新建(NEW)</strong>：执行new指令，新创建的线程的状态</li>
<li><strong>运行(RUNNABLE)</strong>：运行状态包括就绪(READY)和正在运行(RUNNING)两个状态。<ul>
<li><strong>就绪(READY)</strong>：执行start方法以后进入就绪状态，已经具备了运行的条件，只有分配到CPU资源以后才进入RUNNING状态。</li>
<li><strong>正在运行(RUNNING)</strong>：就绪的线程分配到CPU资源(时间片)时，便进入RUNNING状态，<code>run()</code>方法定义了线程的操作和功能。</li>
</ul>
</li>
<li><strong>阻塞(BLOCKED)</strong>：线程进入synchronized方法/代码块中时，要判断同步锁是否被释放，等待同步锁被释放的状态就是阻塞状态。获取到同步锁以后进入就绪状态。</li>
<li><strong>等待(WAITING)</strong>：等待状态下的线程不会被分配CPU时间片，必须被显式唤醒，即<code>notify()</code>/<code>notifyAll()</code>，否则会处于无限期等待的状态</li>
<li><strong>超时等待(TIMED_WAITING)</strong>：超时等待状态下的线程不会被分配CPU时间片，无须被显式唤醒，在达到一定时间后会自动唤醒。</li>
<li><strong>终止(TERMINATED)</strong>：线程的<code>run()</code>方法完成时，或者被强制终止，或出现异常导致结束，线程进入终止状态。</li>
</ul>
<blockquote>
<p>1、执行<code>Object</code>中的<code>wait()</code>方法后，线程释放同步锁并进入等待状态，只有被显示唤醒，比如<code>notify()</code>/<code>notifyAll()</code>，才能进入阻塞状态，等待同步锁被释放然后进入就绪状态。</p>
<p>2、执行<code>sleep()</code>、<code>join()</code>、IO操作以后，线程进入超时等待状态，等时间到或者操作结束，自动进入就绪状态。</p>
</blockquote>
<p><strong>线程的状态转换图</strong>(图中的阻塞状态包括了阻塞、等待、超时等待三个状态)：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-0801_2.png">
</div>



<h1 id="四、线程的同步"><a href="#四、线程的同步" class="headerlink" title="四、线程的同步"></a>四、线程的同步</h1><h2 id="1、介绍"><a href="#1、介绍" class="headerlink" title="1、介绍"></a>1、介绍</h2><p>多条语句在操作共享数据时，如果某个线程操作尚未完成时，其他线程参与进来，会导致共享数据出现错误，这就导致了线程安全问题。</p>
<p>比如有三个窗口共同卖100张票，如下的代码就会有线程安全问题：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WindowTest2</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Window2 w2 = <span class="hljs-keyword">new</span> Window2();<br>        <span class="hljs-comment">//创建三个线程，即三个窗口</span><br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(w2,<span class="hljs-string">"窗口1"</span>);<br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(w2,<span class="hljs-string">"窗口2"</span>);<br>        Thread t3 = <span class="hljs-keyword">new</span> Thread(w2,<span class="hljs-string">"窗口3"</span>);<br>        t1.start();<br>        t2.start();<br>        t3.start();<br>    }<br>}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Window2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> ticket = <span class="hljs-number">100</span>;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>){<br>            <span class="hljs-keyword">if</span>(ticket &gt; <span class="hljs-number">0</span>){<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"票号为:"</span>+ticket);<br>                ticket--;<br>            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br>        }<br>    }<br>}<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">三个线程共享100张票，在其中一个窗口操作的同时，其他线程参与进来，导致票数出现异常</span><br><span class="hljs-comment">以下是部分执行结果：</span><br><span class="hljs-comment">窗口2票号为:23</span><br><span class="hljs-comment">窗口2票号为:7</span><br><span class="hljs-comment">窗口2票号为:6</span><br><span class="hljs-comment">窗口1票号为:8</span><br><span class="hljs-comment">窗口3票号为:19</span><br><span class="hljs-comment">窗口1票号为:4</span><br><span class="hljs-comment">窗口1票号为:2</span><br><span class="hljs-comment">窗口2票号为:5</span><br><span class="hljs-comment">窗口1票号为:1</span><br><span class="hljs-comment">窗口3票号为:3</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>为了解决类似于以上的线程安全问题，需要保证当前线程操作时，其他线程不能参与进来，直到当前线程操作完，其他线程才可以操作。即使当前线程出现了阻塞，也不能被改变。</p>
<p>Java中使用<strong>同步机制</strong>解决线程安全问题，包括<strong>同步代码块</strong>、<strong>同步方法</strong>、<strong>Lock锁(JDK 5.0新增)</strong>三种方法实现同步机制。其中同步代码块和同步方法都是使用<code>synchronized</code>关键字。</p>
<h2 id="2、方法一：同步代码块"><a href="#2、方法一：同步代码块" class="headerlink" title="2、方法一：同步代码块"></a>2、方法一：同步代码块</h2><p>格式和代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//格式：</span><br><span class="hljs-keyword">synchronized</span>(同步监视器){<br>    <span class="hljs-comment">//需要被同步的代码</span><br>}<br><span class="hljs-comment">//具体使用：</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TicketSell</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Window w = <span class="hljs-keyword">new</span> Window();<br>        <span class="hljs-comment">//创建三个线程，即三个窗口</span><br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(w, <span class="hljs-string">"窗口1"</span>);<br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(w, <span class="hljs-string">"窗口2"</span>);<br>        Thread t3 = <span class="hljs-keyword">new</span> Thread(w, <span class="hljs-string">"窗口3"</span>);<br>        t1.start();<br>        t2.start();<br>        t3.start();<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Window</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> ticket = <span class="hljs-number">100</span>;<br>    Object obj = <span class="hljs-keyword">new</span> Object(); <span class="hljs-comment">//同步监视器(同步锁)</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {<br>            <span class="hljs-comment">//synchronized (this){ //也可以使用当前对象</span><br>            <span class="hljs-comment">//synchronized (Window.class){  //当前类也可以作为同步锁</span><br>            <span class="hljs-keyword">synchronized</span> (obj) { <span class="hljs-comment">//以下为同步代码</span><br>                <span class="hljs-keyword">if</span> (ticket &gt; <span class="hljs-number">0</span>) {<br>                    System.out.println(Thread.currentThread().getName() + <br>                                       <span class="hljs-string">"票号为:"</span> + ticket);<br>                    ticket--;<br>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>说明：</p>
<ul>
<li>操作共享数据的代码，即为需要被同步的代码，同步代码不能多也不能少，否则容易导致错误。</li>
<li>共享数据：多个线程共同操作的数据，比如本例的ticket。</li>
<li>同步监视器，即“同步锁”：任何一个类的对象都可以充当同步锁。同步锁被某个线程持有的时候，只有当其执行完同步代码，然后释放同步锁以后，其他线程才可以继续执行。</li>
<li>要求多个线程必须共用同一把同步锁，即<strong>多个线程的同步锁必须是同一个对象</strong>，才能保证同步。</li>
<li>实现<code>Runnable</code>接口创建多线程的方式中，因为只创建一个实现类对象，可以考虑使用<code>this</code>充当同步锁。而在继承<code>Thread</code>类创建多线程的方式中，要慎用<code>this</code>作为锁，根据实际情况判断<code>this</code>是不是唯一的。</li>
<li>也可以考虑当前类作为同步锁(类也是对象，即<code>当前类.class</code>。</li>
</ul>
<h2 id="3、方法二：同步方法"><a href="#3、方法二：同步方法" class="headerlink" title="3、方法二：同步方法"></a>3、方法二：同步方法</h2><p>如果操作共享数据的代码完整的声明在一个方法中，可以使用<code>synchrozied</code>将此方法声明为同步的。可以将多个方法都使用<code>synchronized</code>监视起来，解决这几个方法的线程安全问题。</p>
<p>格式和使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//格式：</span><br>权限修饰符 <span class="hljs-keyword">synchronized</span> 返回值类型 方法名(参数){<br>    <span class="hljs-comment">//操作共享数据的代码</span><br>}<br><br><span class="hljs-comment">//具体使用：</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Window3</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> ticket = <span class="hljs-number">100</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {<br>            show();<br>        }<br>    }<br>	<span class="hljs-comment">//同步方法。非静态方法默认的同步监视器是this</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">if</span> (ticket &gt; <span class="hljs-number">0</span>) {<br>            System.out.println(Thread.currentThread().getName() + <span class="hljs-string">"票号为:"</span> + ticket);<br>            ticket--;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>说明：</p>
<ul>
<li>同步方法仍然涉及到同步监视器，不需要显式声明。</li>
<li>对于非静态的同步方法，同步监视器是this</li>
<li>对于静态的同步方法，同步监视器是当前类本身(<code>类名.class</code>，类也是对象)。</li>
</ul>
<h2 id="4、方法三：Lock锁"><a href="#4、方法三：Lock锁" class="headerlink" title="4、方法三：Lock锁"></a>4、方法三：Lock锁</h2><p>Lock锁是JDK 5.0新增的解决线程安全问题的一种方式，通过显式定义同步锁对象来实现同步。同步锁使用Lock对象充当。</p>
<p><code>java.util.concurrent.locks.Lock</code>接口是控制多个线程对共享资源进行访问的工具。锁提供了对共享资源的独占访问，每次只能有一个线程对Lock对象加锁，线程开始访问共享资源之前应先获得Lock对象。<br><code>ReentrantLock</code>类实现了<code>Lock</code>接口，它拥有与<code>synchronized</code>相同的并发性和内存语义，在实现线程安全的控制中，比较常用的是<code>ReentrantLock</code>，可以显式加锁、释放锁。</p>
<p>使用方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//首先需要声明ReentrantLock对象</span><br><span class="hljs-comment">//然后调用lock方法加锁</span><br><span class="hljs-comment">//最后调用unlock方法释放锁</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Window</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> ticket = <span class="hljs-number">100</span>;<br>    <span class="hljs-keyword">private</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock(); <span class="hljs-comment">//步骤一</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {<br>            lock.lock(); <span class="hljs-comment">//步骤二，加锁</span><br>            <span class="hljs-keyword">try</span> {<br>                <span class="hljs-keyword">if</span> (ticket &gt; <span class="hljs-number">0</span>) {<br>                    System.out.println(Thread.currentThread().getName() <br>                                       + <span class="hljs-string">":"</span> + ticket);<br>                    ticket--;<br>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br>            } <span class="hljs-keyword">finally</span> {<br>                lock.unlock(); <span class="hljs-comment">//步骤三，解锁</span><br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>使用Lock接口进行同步的时候，同样需要保证多个线程使用同一个ReentrantLock对象。</p>
<p>比较<code>synchronized</code>和<code>Lock</code>的异同：</p>
<ul>
<li><code>synchronized</code>是隐式锁，在执行完相应的同步代码后，自动释放同步锁(同步监视器)。</li>
<li><code>Lock</code>是显式锁，需要手动启动同步（执行<code>Lock()</code>），结束时也需要手动关闭（执行<code>unLock()</code>），<code>try-catch</code>结构中，解锁代码需要写在<code>finally</code>中，保证<code>unlock()</code>一定会被执行。</li>
<li><code>Lock</code>只有代码块锁，<code>synchronized</code>有代码块锁和方法锁。</li>
</ul>
<p>三种实现同步的方式，使用的优先顺序为：Lock—&gt;同步代码块(已经进入了方法体，分配了相应资源)—&gt;同步方法</p>
<h2 id="5、死锁"><a href="#5、死锁" class="headerlink" title="5、死锁"></a>5、死锁</h2><p>同的线程分别占用对方需要的同步资源(同步锁)不放弃，都在等待对方放弃自己需要的同步资源，就形成了线程的死锁。A线程持有锁a，等待操作b，而B线程持有锁b，等待操作a(此时a被A当作同步锁持有，没有被释放)，这就形成了死锁。</p>
<p>举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadLock</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        StringBuffer s1 = <span class="hljs-keyword">new</span> StringBuffer();<br>        StringBuffer s2 = <span class="hljs-keyword">new</span> StringBuffer();<br>        <span class="hljs-keyword">new</span> Thread() {<span class="hljs-comment">//Thread的匿名实现类</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">synchronized</span> (s1) {<br>                    s2.append(<span class="hljs-string">"a"</span>); <span class="hljs-comment">//持有同步锁 s1，等待s2被释放</span><br>                    System.out.println(getName() + <span class="hljs-string">":"</span> + s1);<br>                    System.out.println(getName() + <span class="hljs-string">":"</span> + s2);<br>                }<br>            }<br>        }.start();<br>        <span class="hljs-keyword">new</span> Thread() { <span class="hljs-comment">//Thread的匿名实现类</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">synchronized</span> (s2) {<br>                    s1.append(<span class="hljs-string">"b"</span>);<span class="hljs-comment">//持有同步锁 s2，等待s1被释放，造成死锁</span><br>                    System.out.println(getName() + <span class="hljs-string">":"</span> + s1);<br>                    System.out.println(getName() + <span class="hljs-string">":"</span> + s2);<br>                }<br>            }<br>        }.start();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>解决方法：<br>1.专门的算法、原则<br>2.尽量减少同步资源的定义<br>3.尽量避免嵌套同步</p>
<h1 id="五、线程的通信"><a href="#五、线程的通信" class="headerlink" title="五、线程的通信"></a>五、线程的通信</h1><p>线程的通信涉及到三个方法：</p>
<ul>
<li><code>wait()</code>：使当前线程进入等待状态(排队等待同步资源)，并释放同步锁(同步监视器)。</li>
<li><code>notify()</code>：唤醒排队等待同步资源的一个进程，如果有多个线程排队等待同步资源，唤醒优先级高的线程。</li>
<li><code>notifyAll()</code>：唤醒所有排队等待同步资源的线程。</li>
</ul>
<blockquote>
<p>调用以上三个方法的必要条件是当前线程具有对当前对象的监控权，即持有同步锁。这三个方法只能在同步代码块或同步方法中使用。</p>
<p>任意对象都能作为同步锁，因此以上三个方法在Object类中声明。</p>
</blockquote>
<p><code>sleep()</code>和<code>wait()</code>两个方法的异同：</p>
<ul>
<li>都可以使当前线程进入阻塞状态，<code>sleep</code>使线程进入的是<strong>超时等待(TIMED_WAITING)</strong>状态，<code>wait</code>使线程进入<strong>等待(WAITING)</strong>状态。</li>
<li>声明位置不同，<code>sleep</code>声明在<code>Thread</code>类中，<code>wait</code>方法声明在<code>Object</code>类中。</li>
<li>调用的要求不同。<code>sleep</code>可以在任何需要的场景下使用。<code>wait</code>只能在同步代码块/同步方法中。</li>
<li>是否释放同步锁：两个方法都使用在同步代码块/同步方法中时，<code>sleep</code>不会释放同步锁，<code>wait</code>会释放同步锁。</li>
</ul>
<p>总结：</p>
<p>能够释放锁的操作有以下几种：</p>
<ul>
<li>线程的同步方法、同步代码块执行结束。</li>
<li>执行过程中遇到<code>break</code>、<code>return</code>终止了执行操作。</li>
<li>有未处理的<code>Error</code>和<code>Exception</code>，导致异常结束。</li>
<li>执行线程的<code>wait()</code>方法，使线程释放锁，并进入等待状态。</li>
</ul>
<blockquote>
<p><code>sleep</code>、<code>yield</code>方法以及<code>suspend</code>方法不会释放同步锁。</p>
<p>尽量避免使用<code>suspend</code>和<code>resume</code>方法控制线程。</p>
</blockquote>
<p>线程通信举例：创建两个线程，交替输出从1-100的数据</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommunicationTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        CommunicationThread ct = <span class="hljs-keyword">new</span> CommunicationThread();<br>        Thread t1 = <span class="hljs-keyword">new</span> Thread(ct, <span class="hljs-string">"Thread-1"</span>);<br>        Thread t2 = <span class="hljs-keyword">new</span> Thread(ct, <span class="hljs-string">"Thread-2"</span>);<br>        t1.start();<br>        t2.start();<br>    }<br>}<br><span class="hljs-comment">//这里使用实现Runnable接口的方式</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CommunicationThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {<br>            <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>) {<br>                notify(); <span class="hljs-comment">//唤醒另一个线程，只有两个线程，也可以使用notifyAll</span><br>                <span class="hljs-keyword">if</span> (number &lt; <span class="hljs-number">100</span>) {<br>                    number++;<br>                    System.out.println(Thread.currentThread().getName() <br>                                       + <span class="hljs-string">":"</span> + number);<br>                    <span class="hljs-keyword">try</span> {<br>                        wait(); <span class="hljs-comment">//当前线程进入阻塞状态</span><br>                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                        e.printStackTrace();<br>                    }<br>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>;<br><br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记09(2)-常用类之日期类</title>
    <url>/2021/04/04/java-note-0902/</url>
    <content><![CDATA[<h1 id="一、JDK8之前的日期时间API"><a href="#一、JDK8之前的日期时间API" class="headerlink" title="一、JDK8之前的日期时间API"></a>一、JDK8之前的日期时间API</h1><p>JDK8.0之前，日期和时间的API主要有：</p>
<ul>
<li><code>java.lang.System</code>类中的<code>public static long currentTimeMillis()</code>方法，用来返回当前时间与1970年1月1日0时0分0秒之间以毫秒为单位的时间差(毫秒数)，这个毫秒数称为时间戳。</li>
<li><code>java.util.Date</code> 和<code>java.sql.Date</code>类。<code>java.sql.Date</code>类是<code>java.util.Date</code>类的子类。</li>
<li><code>java.text.SimpleDateFormat</code></li>
<li><code>Calendar</code></li>
</ul>
<h2 id="1、Date类"><a href="#1、Date类" class="headerlink" title="1、Date类"></a>1、Date类</h2><p><code>Date</code>类有两个，一般使用的是<code>java.util.Date</code>类，<code>java.sql.Date</code>类是数据库中使用的日期类。</p>
<p><code>java.util.Date</code>类有两个构造器：</p>
<ul>
<li><code>Date()</code>：创建一个对应当前时间的Date对象。</li>
<li><code>Date(long date)</code>：创建指定毫秒数的Date对象。</li>
</ul>
<p>两个方法(大部分方法都过时了)：</p>
<ul>
<li><code>toString()</code>：显示当前的年、月、日、时、分、秒。默认格式为 <code>EEE MMM dd HH:mm:ss zzz yyyy</code>，比如<code>Sat Feb 16 16:35:31 GMT+08:00 2019</code></li>
<li><code>getTime()</code>：获取当前Date对象对应的毫秒数（时间戳）。</li>
</ul>
<p><code>java.sql.Date</code>类没有空参的构造器：</p>
<ul>
<li><code>Date(long date)</code>：创建指定毫秒数的Date对象。</li>
<li><code>Date(int year, int month, int day)</code>，已过时。</li>
</ul>
<p>将<code>java.util.Date</code>对象转换为<code>java.sql.Date</code>对象，具体见代码：</p>
<p>实现代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DateTimeTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//构造器一：Date()：创建一个对应当前时间的Date对象</span><br>        Date date1 = <span class="hljs-keyword">new</span> Date();<br>        System.out.println(date1.toString());<span class="hljs-comment">//Sat Feb 16 16:35:31 GMT+08:00 2019</span><br>        System.out.println(date1.getTime());<span class="hljs-comment">//1550306204104</span><br><br>        <span class="hljs-comment">//构造器二：创建指定毫秒数的Date对象</span><br>        Date date2 = <span class="hljs-keyword">new</span> Date(<span class="hljs-number">155030620410L</span>);<br><br>        <span class="hljs-comment">//创建java.sql.Date对象</span><br>        java.sql.Date date3 = <span class="hljs-keyword">new</span> java.sql.Date(<span class="hljs-number">35235325345L</span>);<br>        System.out.println(date3);<span class="hljs-comment">//1971-02-13</span><br><br>        <span class="hljs-comment">//如何将java.util.Date对象转换为java.sql.Date对象</span><br>        <span class="hljs-comment">//情况一：</span><br>        <span class="hljs-comment">//Date date4 = new java.sql.Date(2343243242323L);</span><br>        <span class="hljs-comment">//java.sql.Date date5 = (java.sql.Date) date4;</span><br>        <span class="hljs-comment">//情况二：</span><br>        Date date6 = <span class="hljs-keyword">new</span> Date();<br>        java.sql.Date date7 = <span class="hljs-keyword">new</span> java.sql.Date(date6.getTime());<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、SimpleDateFormat"><a href="#2、SimpleDateFormat" class="headerlink" title="2、SimpleDateFormat"></a>2、SimpleDateFormat</h2><p><code>java.text.SimpleDateFormat</code>是用来<strong>格式化</strong>和<strong>解析</strong>日期的具体类。</p>
<p>格式化：日期—&gt;文本</p>
<p>解析：文本—&gt;日期</p>
<p>格式化：</p>
<ul>
<li><code>public SimpleDateFormat()</code>：根据默认的模式和语言环境创建对象。</li>
<li><code>public SimpleDateFormat(String pattern)</code>：用参数pattern指定的格式创建一个对象。</li>
<li><code>public String format(Date date)</code>：<code>SimpleDateFormat</code>类对象调用此方法来格式化Date类对象。</li>
</ul>
<p>解析：</p>
<ul>
<li><code>public Date parse(String source)</code>：从给定字符串的开始解析文本，生成一个Date类对象。</li>
</ul>
<p>代码举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DateTimeTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSimpleDateFormat</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> ParseException </span>{<br>        <span class="hljs-comment">//实例化SimpleDateFormat:使用默认的构造器</span><br>        SimpleDateFormat sdf = <span class="hljs-keyword">new</span> SimpleDateFormat();<br><br>        <span class="hljs-comment">//格式化：日期 ---&gt;字符串</span><br>        Date date = <span class="hljs-keyword">new</span> Date();  <br>        System.out.println(date); <span class="hljs-comment">//格式化前：Sun Apr 04 20:51:54 CST 2021</span><br><br>        String format = sdf.format(date);<br>        System.out.println(format); <span class="hljs-comment">// 格式化后：4/4/21 下午8:51</span><br><br>        <span class="hljs-comment">//解析：格式化的逆过程，字符串 ---&gt; 日期</span><br>        String str = <span class="hljs-string">"4/4/21 下午9:00"</span>; <span class="hljs-comment">//解析前</span><br>        Date date1 = sdf.parse(str);<br>        System.out.println(date1);  <span class="hljs-comment">//解析后：Sun Apr 04 21:00:00 CST 2021</span><br>        <span class="hljs-comment">//System.out.println(date1.toString()); //自动调用toString()方法</span><br>        <br><br>        <span class="hljs-comment">//*************按照指定的方式格式化和解析：调用带参的构造器*****************</span><br>        SimpleDateFormat sdf2 = <span class="hljs-keyword">new</span> SimpleDateFormat(<span class="hljs-string">"yyyy-MM-dd hh:mm:ss"</span>);<br>        <span class="hljs-comment">//格式化：2021-04-04 09:00:32</span><br>        System.out.println(sdf2.format(date)); <br>        <span class="hljs-comment">//解析：Sun Apr 04 09:00:32 CST 2021</span><br>        System.out.println(sdf2.parse(sdf2.format(date))); <br>    }<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>解析的时候要求字符串必须和格式化时的格式相同(通过构造器参数体现)，否则抛异常。</p>
</blockquote>
<h2 id="3、Calendar"><a href="#3、Calendar" class="headerlink" title="3、Calendar"></a>3、Calendar</h2><p><code>Date</code>类不能转换时区，除了<code>toGMTString()</code>可以按<code>GMT+0:00</code>输出外，<code>Date</code>总是以当前计算机系统的默认时区为基础进行输出。此外，我们也很难对日期和时间进行加减，计算两个日期相差多少天，计算某个月第一个星期一的日期等。</p>
<p><code>java.util.Calendar</code>类是一个抽象类，JDK 1.1版本引入，可以用于获取并设置年、月、日、时、分、秒，它和<code>Date</code>比，主要多了一个可以做简单的日期和时间运算的功能。</p>
<p><code>Calendar</code>类实例化有两种方式：</p>
<ul>
<li>a.创建其子类<code>GregorianCalendar</code>的对象获取实例。</li>
<li>b.调用其静态方法<code>getInstance()</code>获取实例。(通过getClass可知，类型还是<code>GregorianCalendar</code>)</li>
</ul>
<p><code>Calendar</code>类常用方法：</p>
<p>一个<code>Calendar</code>的实例是系统时间的抽象表示，通过<code>public int get(int field)</code>方法来取得想要的时间信息。参数<code>field</code>是<code>Calendar</code>中的静态变量，比如<code>YEAR</code>、<code>MONTH</code>、<code>DAY_OF_WEEK</code>、<code>HOUR_OF_DAY</code>、<code>MINUTE</code>、<code>SECOND</code>等。</p>
<ul>
<li><code>public void set(int field,int value)</code>：将给定的字段设置为给定值。</li>
<li><code>public void add(int field,int amount)</code>：在给定的字段中添加或减去指定的时间。</li>
<li><code>public final Date getTime()</code>：日历类—&gt;Date类</li>
<li><code>public final void setTime(Date date)</code>：Date类—&gt;日历类</li>
</ul>
<blockquote>
<p>获取月份时：一月是0，二月是1，以此类推，12月是11<br>获取星期时：周日是1，周二是2，……周六是7</p>
</blockquote>
<p>代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">calendarTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testCalendar</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-keyword">new</span> Date()); <span class="hljs-comment">//当前时间：Sun Apr 04 21:40:07 CST 2021</span><br>        <span class="hljs-comment">//1.实例化</span><br>        <span class="hljs-comment">//方式一：创建其子类（GregorianCalendar）的对象</span><br>        <span class="hljs-comment">//方式二：调用其静态方法getInstance()</span><br>        Calendar calendar = Calendar.getInstance();<br>        System.out.println(calendar.getClass()); <span class="hljs-comment">//class java.util.GregorianCalendar</span><br><br>        <span class="hljs-comment">//2.常用方法</span><br>        <span class="hljs-comment">//get()</span><br>        <span class="hljs-keyword">int</span> days = calendar.get(Calendar.DAY_OF_MONTH);<br>        System.out.println(<span class="hljs-string">"今天是本月的第"</span>+days+<span class="hljs-string">"天"</span>); <span class="hljs-comment">// 今天是本月的第4天</span><br><br>        <span class="hljs-comment">//set()</span><br>        <span class="hljs-comment">//calendar可变性</span><br>        calendar.set(Calendar.DAY_OF_MONTH,<span class="hljs-number">22</span>); <span class="hljs-comment">//设置calendar为本月的第22天</span><br>        days = calendar.get(Calendar.DAY_OF_MONTH);<br>        System.out.println(days);  <span class="hljs-comment">// 22，此时的calendar是本月的第22天，即4月22日</span><br><br>        <span class="hljs-comment">//add()</span><br>        calendar.add(Calendar.DAY_OF_MONTH,-<span class="hljs-number">3</span>); <span class="hljs-comment">//calendar减去3天</span><br>        days = calendar.get(Calendar.DAY_OF_MONTH);<br>        System.out.println(days); <span class="hljs-comment">// 19，此时的calendar是本月的第19天，即4月19日</span><br><br>        <span class="hljs-comment">//getTime():日历类---&gt; Date</span><br>        Date date = calendar.getTime();<br>        System.out.println(date); <span class="hljs-comment">// Mon Apr 19 21:40:07 CST 2021</span><br><br>        <span class="hljs-comment">//setTime():Date ---&gt; 日历类</span><br>        Date date1 = <span class="hljs-keyword">new</span> Date();  <span class="hljs-comment">//当前日期</span><br>        calendar.setTime(date1);<br>        days = calendar.get(Calendar.DAY_OF_MONTH);<br>        System.out.println(days);  <span class="hljs-comment">//4, 今天是本月的第4天</span><br>    }<br>}<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">以上程序输出结果：</span><br><span class="hljs-comment">Sun Apr 04 21:40:07 CST 2021</span><br><span class="hljs-comment">class java.util.GregorianCalendar</span><br><span class="hljs-comment">今天是本月的第4天</span><br><span class="hljs-comment">22</span><br><span class="hljs-comment">19</span><br><span class="hljs-comment">Mon Apr 19 21:40:07 CST 2021</span><br><span class="hljs-comment">4</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="二、JDK8的新日期时间API"><a href="#二、JDK8的新日期时间API" class="headerlink" title="二、JDK8的新日期时间API"></a>二、JDK8的新日期时间API</h1><h2 id="1、新日期API"><a href="#1、新日期API" class="headerlink" title="1、新日期API"></a>1、新日期API</h2><p><code>Calendar</code>类和<code>Date</code>类存在的问题：</p>
<ul>
<li>可变性：像日期和时间这样的类应该是不可变的。</li>
<li>偏移性：Date中的年份是从1900开始的，而月份都从0开始。</li>
<li>格式化：格式化只对Date有用，Calendar则不行。</li>
</ul>
<p>此外，它们也不是线程安全的；不能处理闰秒等。</p>
<p>JDK 8.0提供了<code>java.time</code>这个API，其包含了所有关于本地日期（<code>LocalDate</code>）、本地时间（<code>LocalTime</code>）、本地日期时间（<code>LocalDateTime</code>）、时区（<code>ZonedDateTime</code>）和持续时间（<code>Duration</code>）的类。</p>
<p>JDK 8.0新增了<code>toInstant()</code>方法，用于把Date转换成新的表示形式。这些新增的本地化时间日期API大大简化了日期时间和本地化的管理。</p>
<p>和旧的API相比，新API严格区分了时刻、本地日期、本地时间和带时区的日期时间，并且，对日期和时间进行运算更加方便。</p>
<p>此外，新API修正了旧API不合理的常量设计：</p>
<ul>
<li>Month的范围用1~12表示1月到12月；</li>
<li>Week的范围用1~7表示周一到周日。</li>
</ul>
<p>最后，新API的类型几乎全部是不变类型（和String类似），可以放心使用不必担心被修改。</p>
<p>新日期API包含：</p>
<ul>
<li><code>java.time</code>：包含值对象的基础包。常用</li>
<li><code>java.time.chrono</code>：提供对不同的日历系统的访问。</li>
<li><code>java.time.format</code>：格式化和解析时间和日期。常用</li>
<li><code>java.time.temporal</code>：包括底层框架和扩展特性。</li>
<li><code>java.time.zone</code>：包含时区支持的类。</li>
</ul>
<p>新日期API和旧日期API的对应关系：</p>
<ul>
<li><code>java.util.Date</code>和<code>java.sql.Date</code>  对应(类似) <code>Instant</code></li>
<li><code>SimpleDateFormat</code>  对应(类似)<code>DateTimeFormatter</code></li>
<li><code>Calendar</code> 对应(类似) <code>LocalDate</code>、<code>LocalTime</code>、<code>LocalDateTime</code></li>
</ul>
<h2 id="2、常用的三个类"><a href="#2、常用的三个类" class="headerlink" title="2、常用的三个类"></a>2、常用的三个类</h2><p>其中三个比较重要的类，这三个类的实例是<strong>不可变对象</strong>：</p>
<ul>
<li>LocalDate代表IOS格式（yyyy-MM-dd）的日期,可以存储生日、纪念日等日期。</li>
<li>LocalTime表示一个时间，而不是日期。</li>
<li>LocalDateTime是用来表示日期和时间的，这是一个最常用的类之一。</li>
</ul>
<p>这几个类常用的方法如下：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-0902_1.png">
</div>

<p>实现代码参考：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JDK8Time</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//now():获取当前的日期、时间、日期+时间</span><br>        LocalDate localDate = LocalDate.now();<br>        LocalTime localTime = LocalTime.now();<br>        LocalDateTime localDateTime = LocalDateTime.now();<br>        System.out.println(localDate); <span class="hljs-comment">//2021-04-04</span><br>        System.out.println(localTime); <span class="hljs-comment">//22:10:12.279529500</span><br>        System.out.println(localDateTime); <span class="hljs-comment">//2021-04-04T22:10:12.279529500</span><br><br>        <span class="hljs-comment">//of():设置指定的年、月、日、时、分、秒。没有偏移量</span><br>        LocalDateTime localDateTime1 = LocalDateTime.of(<span class="hljs-number">2020</span>, <span class="hljs-number">10</span>, <span class="hljs-number">6</span>, <span class="hljs-number">13</span>, <span class="hljs-number">23</span>, <span class="hljs-number">43</span>);<br>        System.out.println(localDateTime1); <span class="hljs-comment">//2020-10-06T13:23:43</span><br><br><br>        <span class="hljs-comment">//getXxx()：获取相关的属性</span><br>        System.out.println(localDateTime.getDayOfMonth());  <span class="hljs-comment">//4</span><br>        System.out.println(localDateTime.getDayOfWeek());  <span class="hljs-comment">//SUNDAY</span><br>        System.out.println(localDateTime.getMonth());  <span class="hljs-comment">//APRIL</span><br>        System.out.println(localDateTime.getMonthValue()); <span class="hljs-comment">//4</span><br>        System.out.println(localDateTime.getMinute());  <span class="hljs-comment">//10</span><br><br>        <span class="hljs-comment">//体现不可变性</span><br>        <span class="hljs-comment">//withXxx():设置相关的属性</span><br>        LocalDate localDate1 = localDate.withDayOfMonth(<span class="hljs-number">22</span>); <span class="hljs-comment">//返回新的对象</span><br>        System.out.println(localDate); <span class="hljs-comment">//2021-04-04，原来的对象不会被修改</span><br>        System.out.println(localDate1); <span class="hljs-comment">//2021-04-22</span><br><br>        <span class="hljs-comment">//不可变性，不会改变原有对象</span><br>        LocalDateTime localDateTime3 = localDateTime.plusMonths(<span class="hljs-number">3</span>); <span class="hljs-comment">//加3个月</span><br>        System.out.println(localDateTime); <span class="hljs-comment">//2021-04-04T22:10:12.279529500</span><br>        System.out.println(localDateTime3); <span class="hljs-comment">//2021-07-04T22:10:12.279529500</span><br><br>        LocalDateTime localDateTime4 = localDateTime.minusDays(<span class="hljs-number">6</span>); <span class="hljs-comment">//减6天</span><br>        System.out.println(localDateTime); <span class="hljs-comment">//2021-04-04T22:10:12.279529500</span><br>        System.out.println(localDateTime4); <span class="hljs-comment">//2021-03-29T22:10:12.279529500</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、Instant"><a href="#3、Instant" class="headerlink" title="3、Instant"></a>3、Instant</h2><p><code>java.time.Instant</code>用来表示时间戳，它只是简单的表示自1970年1月1日0时0分0秒（UTC）开始的秒数。<code>java.time</code>包是基于纳秒计算的，<code>Instant</code>的精度可以达到纳秒级。</p>
<p>常用方法：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>public static Instant now()</code></td>
<td>静态方法，返回默认UTC时区的Instant类的对象</td>
</tr>
<tr>
<td><code>public static Instant ofEpochMilli(long epochMilli)</code></td>
<td>静态方法，返回在1970-01-01 00:00:00基础上加上指定毫秒数之后的<code>Instant</code>类的对象</td>
</tr>
<tr>
<td><code>public long toEpochMilli()</code></td>
<td>返回1970-01-01 00:00:00到当前时间的毫秒数，即为时间戳</td>
</tr>
<tr>
<td><code>public OffsetDateTime atOffset(ZoneOffset offet)</code></td>
<td>结合即时的偏移来创建一个<code>OffsetDateTime</code></td>
</tr>
</tbody>
</table>
</div>
<p>实现代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JDK8Time</span> </span>{<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">   Instant的使用</span><br><span class="hljs-comment">   类似于 java.util.Date类</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//now():获取本初子午线对应的标准时间</span><br>        Instant instant = Instant.now();<br>        System.out.println(instant);<span class="hljs-comment">//2021-04-05T03:02:58.898817900Z</span><br><br>        <span class="hljs-comment">//添加时间的偏移量</span><br>        OffsetDateTime offsetDateTime = instant.atOffset(ZoneOffset.ofHours(<span class="hljs-number">8</span>));<br>        System.out.println(offsetDateTime);<span class="hljs-comment">//2021-04-05T11:02:58.898817900+08:00</span><br><br>        <span class="hljs-comment">//toEpochMilli():获取自1970年1月1日0时0分0秒（UTC）开始的毫秒数</span><br>        <span class="hljs-comment">//相当于 Date类的getTime()</span><br>        <span class="hljs-keyword">long</span> milli = instant.toEpochMilli();<br>        System.out.println(milli); <span class="hljs-comment">//1617591778898</span><br><br>        <span class="hljs-comment">//ofEpochMilli():通过给定的毫秒数，获取Instant实例</span><br>        <span class="hljs-comment">//相当于Date(long millis)</span><br>        Instant instant1 = Instant.ofEpochMilli(<span class="hljs-number">1550475314878L</span>);<br>        System.out.println(instant1); <span class="hljs-comment">//2019-02-18T07:35:14.878Z</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、DateTimeFormatter"><a href="#4、DateTimeFormatter" class="headerlink" title="4、DateTimeFormatter"></a>4、DateTimeFormatter</h2><p>使用<code>Date</code>对象时，用<code>SimpleDateFormat</code>进行格式化显示。使用新的<code>LocalDateTime</code>或<code>ZonedLocalDateTime</code>时，使用<code>java.time.format.DateTimeFormatter</code>进行格式化显示。</p>
<p>和<code>SimpleDateFormat</code>不同的是，<code>DateTimeFormatter</code>是不变对象，并且是线程安全的。因为<code>SimpleDateFormat</code>不是线程安全的，使用的时候，只能在方法内部创建新的局部变量。而<code>DateTimeFormatter</code>可以只创建一个实例，到处引用。</p>
<p><code>DateTimeFormatter</code>类有三种格式化方法：</p>
<ul>
<li>预定义的标准格式。如：<code>ISO_LOCAL_DATE_TIME</code>、<code>ISO_LOCAL_DATE</code>、<code>ISO_LOCAL_TIME</code></li>
<li>本地化相关的格式。如：<code>ofLocalizedDateTime(FormatStyle.LONG)</code></li>
<li><strong>自定义的格式</strong>。如：<code>ofPattern(“yyyy-MM-ddhh:mm:ss”)</code>，常用</li>
</ul>
<p>同样地，<code>DateTimeFormatter</code>类也提供了相应的格式化和解析的函数：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>public static DateTimeFormatter ofPattern(String pattern)</code></td>
<td style="text-align:left">静态方法，返回一个指定字符串格式的<code>DateTimeFormatter</code></td>
</tr>
<tr>
<td style="text-align:left"><code>public String format(Temporal Accessort)</code></td>
<td style="text-align:left">格式化一个日期、时间，返回字符串</td>
</tr>
<tr>
<td style="text-align:left"><code>public TemporalAccessor parse(CharSequence text)</code></td>
<td style="text-align:left">将指定格式的字符序列解析为一个日期、时间</td>
</tr>
</tbody>
</table>
</div>
<p>代码使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JDK8Time</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>   	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//方式一：预定义的标准格式。如：ISO_LOCAL_DATE_TIME;</span><br>        <span class="hljs-comment">//ISO_LOCAL_DATE;ISO_LOCAL_TIME</span><br>        DateTimeFormatter formatter = DateTimeFormatter.ISO_LOCAL_DATE_TIME;<br>        <span class="hljs-comment">//格式化:日期--&gt;字符串</span><br>        LocalDateTime localDateTime = LocalDateTime.now();<br>        String str1 = formatter.format(localDateTime);<br>        System.out.println(localDateTime);<br>        System.out.println(str1);<span class="hljs-comment">//2019-02-18T15:42:18.797</span><br><br>        <span class="hljs-comment">//解析：字符串 --&gt;日期</span><br>        TemporalAccessor parse = formatter.parse(<span class="hljs-string">"2019-02-18T15:42:18.797"</span>);<br>        System.out.println(parse);<br>        <br>        <span class="hljs-comment">//方式二：</span><br>        <span class="hljs-comment">//本地化相关的格式。如：ofLocalizedDateTime()，适用于LocalDateTime</span><br>        <span class="hljs-comment">//FormatStyle.LONG / FormatStyle.MEDIUM / FormatStyle.SHORT :</span><br>        DateTimeFormatter formatter1 = DateTimeFormatter.<br>            ofLocalizedDateTime(FormatStyle.LONG);<br>        <span class="hljs-comment">//格式化</span><br>        String str2 = formatter1.format(localDateTime);<br>        System.out.println(str2);<span class="hljs-comment">//2019年2月18日 下午03时47分16秒</span><br><br>        <span class="hljs-comment">//本地化相关的格式。如：ofLocalizedDate()，适用于LocalDate</span><br>        <span class="hljs-comment">//FormatStyle.FULL / FormatStyle.LONG / FormatStyle.MEDIUM / </span><br>        <span class="hljs-comment">//FormatStyle.SHORT</span><br>        DateTimeFormatter formatter2 = DateTimeFormatter.<br>            ofLocalizedDate(FormatStyle.MEDIUM);<br>        <span class="hljs-comment">//格式化</span><br>        String str3 = formatter2.format(LocalDate.now());<br>        System.out.println(str3);<span class="hljs-comment">//2019-2-18</span><br><br><br>        <span class="hljs-comment">//方式三：自定义的格式。如：ofPattern(“yyyy-MM-dd hh:mm:ss”)</span><br>        DateTimeFormatter formatter3 = DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd hh:mm:ss"</span>);<br>        <span class="hljs-comment">//格式化</span><br>        String str4 = formatter3.format(LocalDateTime.now());<br>        System.out.println(str4);<span class="hljs-comment">//2019-02-18 03:52:09</span><br><br>        <span class="hljs-comment">//解析</span><br>        TemporalAccessor accessor = formatter3.parse(<span class="hljs-string">"2019-02-18 03:52:09"</span>);<br>        System.out.println(accessor);<br>        <span class="hljs-comment">//{HourOfAmPm=3, MinuteOfHour=52, MicroOfSecond=0, SecondOfMinute=9,</span><br>        <span class="hljs-comment">//NanoOfSecond=0, MilliOfSecond=0},ISO resolved to 2019-02-18</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="5、其他API"><a href="#5、其他API" class="headerlink" title="5、其他API"></a>5、其他API</h2><ul>
<li><code>ZoneId</code>：该类中包含了所有的时区信息，一个时区的ID，如Europe/Paris</li>
<li>ZonedDateTime`：一个在ISO-8601日历系统时区的日期时间，如2007-12-03T10:15:30+01:00Europe/Paris。其中每个时区都对应着ID，地区ID都为“{区域}/{城市}”的格式，例如：Asia/Shanghai等</li>
<li><code>Clock</code>：使用时区提供对当前即时、日期和时间的访问的时钟。</li>
<li>持续时间：<code>Duration</code>，用于计算两个“时间”间隔</li>
<li>日期间隔：<code>Period</code>，用于计算两个“日期”间隔</li>
<li><code>TemporalAdjuster</code> :时间校正器。有时我们可能需要获取例如：将日期调整到“下一个工作日”等操作。</li>
<li><code>TemporalAdjusters</code> :该类通过静态方法(<code>firstDayOfXxx()</code>/<code>lastDayOfXxx()</code>/<code>nextXxx()</code>)提供了大量的常用<code>TemporalAdjuster</code>的实现。</li>
</ul>
<h2 id="6、新旧日期转换"><a href="#6、新旧日期转换" class="headerlink" title="6、新旧日期转换"></a>6、新旧日期转换</h2><div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-0902_02.jpg
">
</div>

]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记10-枚举类与注解</title>
    <url>/2021/04/05/java-note-1001/</url>
    <content><![CDATA[<h1 id="一、枚举类"><a href="#一、枚举类" class="headerlink" title="一、枚举类"></a>一、枚举类</h1><h2 id="1、什么是枚举类"><a href="#1、什么是枚举类" class="headerlink" title="1、什么是枚举类"></a>1、什么是枚举类</h2><p>类的对象只有<strong>有限个</strong>，<strong>确定的</strong>，称此类为<strong>枚举类</strong>。比如星期、性别、季节、xx状态等。</p>
<p>当需要定义一组常量时，强烈建议使用枚举类。</p>
<p>如果枚举类中只有一个对象，则可以作为单例模式的实现方式。</p>
<p>属性：</p>
<ul>
<li>枚举类对象的<strong>属性不应允许被改动</strong>，所以应该使用<code>private final</code>修饰。</li>
<li>枚举类中使用<code>private final</code>修饰的属性应该在构造器中为其赋值。</li>
<li>若枚举类显式地定义了带参数的构造器，则在列出枚举值时也应该对应地传入参数。</li>
</ul>
<h2 id="2、自定义枚举类"><a href="#2、自定义枚举类" class="headerlink" title="2、自定义枚举类"></a>2、自定义枚举类</h2><p>JDK 5.0之前，没有<code>enum</code>关键字，只能自定义枚举类，步骤为：</p>
<ul>
<li>私有化类的构造器，保证不能在类的外部创建其对象。</li>
<li>在类的内部创建枚举类的实例，声明为：<code>public static final</code></li>
<li>对象如果有实例变量，应该声明为<code>private final</code>，并在构造器中初始化。</li>
</ul>
<p>举例说明：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SeasonTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Season spring = Season.SPRING;<br>        System.out.println(spring);<br>    }<br>}<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Season</span></span>{<br>    <span class="hljs-comment">//1.声明对象属性为private final</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String seasonName; <span class="hljs-comment">//季节名字</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String seasonDec;  <span class="hljs-comment">//季节描述</span><br>    <span class="hljs-comment">//2.构造器应该是private的</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">Season</span><span class="hljs-params">(String seasonName,String seasonDec)</span></span>{<br>        <span class="hljs-keyword">this</span>.seasonName = seasonName;<br>        <span class="hljs-keyword">this</span>.seasonDec = seasonDec;  <span class="hljs-comment">//{seasonName='春天', seasonDec='春暖花开'}</span><br>    }<br>    <span class="hljs-comment">//3.创建确定个数的实例public static final</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Season SPRING = <span class="hljs-keyword">new</span> Season(<span class="hljs-string">"春天"</span>,<span class="hljs-string">"春暖花开"</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Season SUMMER = <span class="hljs-keyword">new</span> Season(<span class="hljs-string">"夏天"</span>,<span class="hljs-string">"夏日炎炎"</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Season AUTUMN = <span class="hljs-keyword">new</span> Season(<span class="hljs-string">"秋天"</span>,<span class="hljs-string">"秋高气爽"</span>);<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Season WINTER = <span class="hljs-keyword">new</span> Season(<span class="hljs-string">"冬天"</span>,<span class="hljs-string">"冰天雪地"</span>);<br><br>    <span class="hljs-comment">//4.根据需求，可以选择性地创建其他函数</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSeasonName</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> seasonName;}<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSeasonDec</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> seasonDec;}<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"{"</span> +<br>                <span class="hljs-string">"seasonName='"</span> + seasonName + <span class="hljs-string">'\''</span> +<br>                <span class="hljs-string">", seasonDec='"</span> + seasonDec + <span class="hljs-string">'\''</span> +<br>                <span class="hljs-string">'}'</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、使用enum定义枚举类"><a href="#3、使用enum定义枚举类" class="headerlink" title="3、使用enum定义枚举类"></a>3、使用enum定义枚举类</h2><p>JDK 5.0新增了<code>enum</code>定义枚举类的方式，使用<code>enum</code>定义的枚举类默认继承了<code>java.lang.Enum</code>类，因此不能再继承其他类。</p>
<p>使用说明：</p>
<ul>
<li>枚举类的构造器只能使用<code>private</code>权限修饰符。</li>
<li>枚举类的所有实例必须在枚举类中显式列出（<strong>以<code>,</code>分隔，以<code>;</code>结尾</strong>）。列出的实例，系统会自动添加<code>public static final</code>修饰。</li>
<li><strong>必须在枚举类的第一行声明枚举类对象</strong>。</li>
</ul>
<p>JDK 5.0中，<code>switch</code>表达式中可以使用枚举类对象，<code>case</code>子句可以直接使用枚举值的名字，无需添加枚举类作为限定。</p>
<p>使用<code>enum</code>定义枚举类：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Season</span></span>{<br>    <span class="hljs-comment">//1.提供当前枚举类的对象，多个对象之间用","隔开，末尾对象";"结束</span><br>    SPRING(<span class="hljs-string">"春天"</span>,<span class="hljs-string">"春暖花开"</span>),<br>    SUMMER(<span class="hljs-string">"夏天"</span>,<span class="hljs-string">"夏日炎炎"</span>),<br>    AUTUMN(<span class="hljs-string">"秋天"</span>,<span class="hljs-string">"秋高气爽"</span>),<br>    WINTER(<span class="hljs-string">"冬天"</span>,<span class="hljs-string">"冰天雪地"</span>);<br>    <span class="hljs-comment">//2.声明Season对象的属性:private final修饰</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String seasonName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String seasonDesc;<br><br>    <span class="hljs-comment">//3.构造器应该是private的，enum里面可以省略private关键字</span><br>    Season(String seasonName,String seasonDesc){<br>        <span class="hljs-keyword">this</span>.seasonName = seasonName;<br>        <span class="hljs-keyword">this</span>.seasonDesc = seasonDesc;<br>    }<br>    <br>    <span class="hljs-comment">//可以根据需要声明其他方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSeasonName</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> seasonName;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSeasonDesc</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> seasonDesc;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、Enum类"><a href="#4、Enum类" class="headerlink" title="4、Enum类"></a>4、Enum类</h2><p><code>Enum</code>类有以下几个常用方法：</p>
<ul>
<li><code>values()</code>：静态方法，枚举类调用此方法返回包含此枚举类中所有枚举对象的<strong>枚举类型的对象数组</strong>。这个方法是Java编译器在编译枚举类的时候自动添加的方法。</li>
<li><code>valueOf(String str)</code>：把一个字符串str转为对应的枚举类对象。要求str‘必须是枚举类对象的“名字”。如不是，会有运行时异常<code>IllegalArgumentException</code>。</li>
<li><code>toString</code>：可以被重写</li>
<li><code>public final boolean equals</code>：枚举类中可以直接使用<code>==</code>比较两个枚举常量是否相等，Enum类中的<code>equals</code>方法也是直接使用<code>==</code>实现的，此方法是为了在Set、List和Map中使用。</li>
<li><code>public final int hashCode</code></li>
<li><code>getDeclaringClass</code>：得到枚举常量所属枚举类型的Class对象，可以用来判断两个枚举常量是否属于同一个枚举类型</li>
<li><code>name</code>：得到当前枚举常量的名字。</li>
<li><code>ordinal</code>：得到当前枚举常量的次序。</li>
<li><code>compareTo</code>：枚举类型实现了Comparable接口，比较两个枚举常量的大小(按照声明的顺序排列)</li>
<li><code>protected final Object clone</code>：枚举类型不能被Clone，为了防止子类实现克隆方法，Enum实现了一个仅抛出<code>CloneNotSupportedException</code>异常的<code>final</code>方法<code>clone()</code>。</li>
</ul>
<p>代码举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SeasonTest2</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//toString方法：</span><br>        System.out.println(Season2=.SPRING); <span class="hljs-comment">//SPRING</span><br>        <span class="hljs-comment">//父类是Enum类</span><br>        System.out.println(Season2.class.getSuperclass()); <span class="hljs-comment">//class java.lang.Enum</span><br><br>        <span class="hljs-comment">//values方法</span><br>        Season[] values = Season.values();<br>        <span class="hljs-keyword">for</span>(Season i: values){<br>            System.out.println(i);<br>        }<br>        <span class="hljs-comment">/*输出：</span><br><span class="hljs-comment">        SPRING</span><br><span class="hljs-comment">        SUMMER</span><br><span class="hljs-comment">        AUTUMN</span><br><span class="hljs-comment">        WINTER</span><br><span class="hljs-comment">        */</span><br><br>        <span class="hljs-comment">//valueOf(String str)方法,返回枚举类中，对象名是str的枚举类对象</span><br>        Season winter = Season.valueOf(<span class="hljs-string">"WINTER"</span>);<br>        System.out.println(winter.toString()); <span class="hljs-comment">//WINTER</span><br>        <span class="hljs-comment">//等同于Systou.out.println(winter)</span><br><br>        <span class="hljs-comment">//枚举类在switch中的应用</span><br>        Season season = Season.SPRING;<br>        <span class="hljs-keyword">switch</span> (season){<br>            <span class="hljs-keyword">case</span> SPRING:<br>                System.out.println(<span class="hljs-string">"春天"</span>); <span class="hljs-comment">//输出：春天</span><br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> SUMMER:<br>                System.out.println(<span class="hljs-string">"夏天"</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> AUTUMN:<br>                System.out.println(<span class="hljs-string">"秋天"</span>);<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> WINTER:<br>                System.out.println(<span class="hljs-string">"冬天"</span>);<br>                <span class="hljs-keyword">break</span>;<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="5、枚举类实现接口"><a href="#5、枚举类实现接口" class="headerlink" title="5、枚举类实现接口"></a>5、枚举类实现接口</h2><p>和普通Java类一样，枚举类可以实现一个或多个接口：</p>
<ul>
<li>若每个枚举值在调用实现的接口方法呈现相同的行为方式，则只要统一实现该方法即可。</li>
<li>若需要每个枚举值在调用实现的接口方法<strong>呈现出不同的行为方式</strong>,则可以让<strong>每个枚举值分别来实现该方法</strong>。</li>
</ul>
<p>比如下面的代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SeasonTest2</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//values方法</span><br>        Season2[] values = Season2.values();<br>        <span class="hljs-keyword">for</span>(Season2 i: values){<br>            System.out.println(i);<br>            i.info();<br>        }<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">Season2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Info</span></span>{<br>    <span class="hljs-comment">//每个枚举变量单独实现Info接口中的方法</span><br>    SPRING (<span class="hljs-string">"春天"</span>,<span class="hljs-string">"春暖花开"</span>){<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">info</span><span class="hljs-params">()</span></span>{<br>            System.out.println(<span class="hljs-string">"spring"</span>);<br>        }<br>    },<br>    SUMMER (<span class="hljs-string">"夏天"</span>,<span class="hljs-string">"夏日炎炎"</span>){<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">info</span><span class="hljs-params">()</span></span>{<br>            System.out.println(<span class="hljs-string">"summer"</span>);<br>        }<br>    },<br>    AUTUMN (<span class="hljs-string">"秋天"</span>,<span class="hljs-string">"秋高气爽"</span>){<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">info</span><span class="hljs-params">()</span></span>{<br>            System.out.println(<span class="hljs-string">"autumn"</span>);<br>        }<br>    },<br>    WINTER(<span class="hljs-string">"冬天"</span>,<span class="hljs-string">"冰天雪地"</span>){<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">info</span><span class="hljs-params">()</span></span>{<br>            System.out.println(<span class="hljs-string">"winter"</span>);<br>        }<br>    };<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String seasonName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String seasonDec;<br>    Season2(String seasonName,String seasonDec){<br>        <span class="hljs-keyword">this</span>.seasonName = seasonName;<br>        <span class="hljs-keyword">this</span>.seasonDec = seasonDec;<br>    }<br><br>}<br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Info</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">info</span><span class="hljs-params">()</span></span>;<br>}<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">输出结果为：</span><br><span class="hljs-comment">SPRING</span><br><span class="hljs-comment">spring</span><br><span class="hljs-comment">SUMMER</span><br><span class="hljs-comment">summer</span><br><span class="hljs-comment">AUTUMN</span><br><span class="hljs-comment">autumn</span><br><span class="hljs-comment">WINTER</span><br><span class="hljs-comment">winter</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="二、注解"><a href="#二、注解" class="headerlink" title="二、注解"></a>二、注解</h1><h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p>JDK 5.0开始支持注解（Annotation），注解是代码里的特殊标记，可以在编译、类加载、运行时被读取，并执行相应的处理。通过使用注解，可以在不改变原有逻辑的情况下，在源文件中嵌入一些补充信息。代码分析工具、开发工具和部署工具可以通过这些补充信息进行验证或者部署。</p>
<p>Annotation可以像修饰符一样被使用,可用于<strong>修饰包,类,构造器,方法,成员变量,参数,局部变量的声明</strong>，这些信息被保存在Annotation的“name=value”对中。</p>
<p>在JavaSE中，注解的使用目的比较简单，例如标记过时的功能，忽略警告等。在JavaEE/Android中注解占据了更重要的角色，例如用来配置应用程序的任何切面，代替JavaEE旧版中所遗留的繁冗代码和XML配置等。</p>
<p><strong>框架 = 注解 + 反射 + 设计模式</strong></p>
<h2 id="2、常见注解"><a href="#2、常见注解" class="headerlink" title="2、常见注解"></a>2、常见注解</h2><p>常见的注解主要用三种用处：</p>
<p>1、生成文档相关的注解。</p>
<ul>
<li><p>@author标明开发该类模块的作者，多个作者之间使用,分割</p>
</li>
<li><p>@version标明该类模块的版本@see参考转向，也就是相关主题</p>
</li>
<li><p>@since表示从哪个版本开始增加的</p>
</li>
<li><p>@param对方法中某参数的说明，如果没有参数就不能写</p>
</li>
<li><p>@return对方法返回值的说明，如果方法的返回值类型是void就不能写</p>
</li>
<li><p>@exception对方法可能抛出的异常进行说明，如果方法没有用throws显式抛出的异常就不能写</p>
<p>其中</p>
<ul>
<li>@param@return和@exception这三个标记都是只用于方法的。</li>
<li>@param的格式要求：@param形参名形参类型形参说明</li>
<li>@return的格式要求：@return返回值类型返回值说明</li>
<li>@exception的格式要求：@exception异常类型异常说明</li>
<li>@param和@exception可以并列多个</li>
</ul>
</li>
</ul>
<p>例如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment">*<span class="hljs-doctag">@author</span> xxx</span><br><span class="hljs-comment">*<span class="hljs-doctag">@version</span> 1.0</span><br><span class="hljs-comment">*<span class="hljs-doctag">@see</span> Math.java</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>2、编译时进行格式检查（JDK内置的三个基本注解）</p>
<ul>
<li><code>@Override</code>：限定重写父类方法，该注解只能用于方法。</li>
<li><code>@Deprecated</code>：用于表示所修饰的元素(类、方法等)已过时。通常是因为所修饰的结构危险或存在更好的选择</li>
<li><code>@SuppressWarnings</code>：抑制编译器警告。</li>
</ul>
<p>3、跟踪代码依赖性，实现替代配置文件的功能。例如Serverlet3.0中注解使得不再需要在web.xml文件中进行Servlet部署：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1001_1.jpg">
</div>

<h2 id="3、自定义注解"><a href="#3、自定义注解" class="headerlink" title="3、自定义注解"></a>3、自定义注解</h2><p>自定义注解使用<code>@interface</code>关键字，并且自动继承了<code>java.lang.annotation.Annotation</code>接口。</p>
<ul>
<li><p>注解的成员变量在Annotation定义中以<strong>无参数方法</strong>的形式来声明。其方法名和返回值定义了该成员的名字和类型，称之为配置参数。类型只能是<strong>八种基本数据类型、String类型、Class类型、enum类型、Annotation类型以及以上类型的数组</strong>。</p>
</li>
<li><p>定义注解成员变量时如果指定初始值，可以使用<code>default</code>关键字。</p>
</li>
<li>如果只有一个参数成员，建议使用参数名为<code>value</code></li>
<li>如果定义的注解含有配置参数，那么<strong>使用时必须指定参数值</strong>，除非它有默认值。格式是<code>参数名=参数值</code>，如果只有一个参数成员，且名称为<code>value</code>，可以省略<code>value=</code></li>
<li>没有成员定义的<code>Annotation</code>称为<code>标记</code>；包含成员变量的<code>Annotation</code>称为<code>元数据Annotation</code>。</li>
</ul>
<blockquote>
<p>自定义注解必须配上注解的信息处理流程才有意义。</p>
</blockquote>
<p>自定义注解举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hello</span> </span>{<br>    <span class="hljs-comment">//使用是指定配置参数</span><br>    <span class="hljs-meta">@Report(type = 3,level = "level",value = "string")</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> n;<br>    <br>    <span class="hljs-comment">//指定部分参数</span><br>    <span class="hljs-meta">@Report(level = "level",value = "string")</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> p;<br><br>    <span class="hljs-meta">@Report(value = "string")</span> <span class="hljs-comment">// 只对value赋值，等同于@Report("string")</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> x;<br><br>    <span class="hljs-meta">@Report</span>  <span class="hljs-comment">//对所有参数使用默认值</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> y;<br>}<br><span class="hljs-comment">//以下是自定义的一个注解，如果是public修饰的，必须单独放在一个java文件中</span><br><span class="hljs-comment">//三个配置参数都有默认值，因此使用的时候可以指定，也可以不指定</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Report {<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">type</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> 0</span>;  <span class="hljs-comment">//类型为int，配置参数名为type，默认值是0</span><br>    <span class="hljs-function">String <span class="hljs-title">level</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> "info"</span>;<br>    <span class="hljs-function">String <span class="hljs-title">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> ""</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、元注解"><a href="#4、元注解" class="headerlink" title="4、元注解"></a>4、元注解</h2><p>用于修饰其他注解的注解，就是<code>元注解(meta-annotation)</code>。</p>
<p>JDK 5.0提供了4个标准的元注解：</p>
<ul>
<li><code>@Retention</code>：指定被修饰的注解的生命周期。</li>
<li><code>@Target</code>：指定被修饰的注解能够用于修饰哪些程序元素。</li>
<li><code>@Documented</code>：表示所修饰的注解在被<code>javadoc</code>解析时保留下来。</li>
<li><code>@Inherited</code>：被修饰的注解将具有继承性。</li>
</ul>
<p><strong>1、@Retention</strong></p>
<p><code>@Retentio</code>元注解用于定义<code>Annotation</code>的生命周期，其包含一个<code>RetentionPolicy</code>类型的成员变量，使用<code>@Retention</code>元注解时，必须为该成员变量指定值，有以下三种值(枚举变量)：</p>
<ul>
<li><code>RetentionPolicy.SOURCE</code>：在源文件中有效（即源文件中保留），编译器直接丢弃这种策略的注释</li>
<li><code>RetentionPolicy.CLASS</code>：在class文件中有效（即class保留），运行Java程序时，JVM不会保留这种注解。<strong>这是默认值</strong>。</li>
<li><code>RetentionPolicy.RUNTIME</code>：<strong>在运行时有效（即运行时保留），运行Java程序时，JVM会保留注释。程序可以通过反射获取该注释</strong>。</li>
</ul>
<p>如下图：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1001_2.jpg">
</div>

<p>使用举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyAnnotation {<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">type</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> 0</span>;<br>    <span class="hljs-function">String <span class="hljs-title">level</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> "info"</span>;<br>    <span class="hljs-function">String <span class="hljs-title">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> ""</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、@Target</strong></p>
<p><code>@Target</code>用于指定被修饰的<code>Annotation</code>能用于修饰哪些元素，<code>@Target</code>包含一个名为value的数组成员变量，可以取以下的值：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>取值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ElementType.CONSTRUCTOR</code></td>
<td>用于描述构造器</td>
</tr>
<tr>
<td><code>ElementType.PACKAGE</code></td>
<td>用于描述包</td>
</tr>
<tr>
<td><code>ElementType.FIELD</code></td>
<td>用于描述域(包括枚举常量)</td>
</tr>
<tr>
<td><code>ElementType.TYPE</code></td>
<td>用于描述类、接口(包括注解类型)或enum声明</td>
</tr>
<tr>
<td><code>ElementType.METHOD</code></td>
<td>用于描述方法</td>
</tr>
<tr>
<td><code>ElementType.LOCAL_VARIABLE</code></td>
<td>用于描述局部变量</td>
</tr>
<tr>
<td><code>ElementType.PARAMETER</code></td>
<td>用于描述参数</td>
</tr>
</tbody>
</table>
</div>
<p><strong>3、@Documented</strong></p>
<p><code>@Documented</code>用于指定被改元注解修饰的注解类将被<code>javadoc</code>工具提取成文档。默认情况下，<code>javadoc</code>不包括注解。</p>
<p>定义为<code>Documented</code>的注解必须设置<code>Retention</code>的值为<code>RUNTIME</code>。</p>
<p><strong>4、@Inherited</strong></p>
<p><code>@Inherited</code>修饰的注解具有继承性，其子类自动具有该注解，即该注解类的子类可以继承父类级别的注解。</p>
<h2 id="5、反射获取注解信息"><a href="#5、反射获取注解信息" class="headerlink" title="5、反射获取注解信息"></a>5、反射获取注解信息</h2><p>JDK 5.0在java.lang.reflect包下新增了AnnotatedElement接口,该接口代表<strong>程序中可以接受注解的程序元素</strong>。</p>
<p>当一个Annotation类型被定义为运行时Annotation后,该注解才是运行时可见,当class文件被载入时保存在class文件中的Annotation才会被虚拟机读取。</p>
<p>程序可以调用AnnotatedElement对象的如下方法来访问Annotation信息：</p>
<ul>
<li><code>getAnnotation(Class&lt;T&gt; annotatoinClass)</code></li>
<li><code>getAnnotations()</code></li>
<li><code>getDeclaredAnnotations()</code></li>
<li><code>isAnnotationPresent(Class&lt;? extends Annotation&gt; annotationClass)</code></li>
</ul>
<h2 id="6、JDK-8中注解新特征"><a href="#6、JDK-8中注解新特征" class="headerlink" title="6、JDK 8中注解新特征"></a>6、JDK 8中注解新特征</h2><p>JDK 8.0新增了<strong>可重复注解</strong>和<strong>类型注解</strong>。</p>
<p><strong>1、可重复注解</strong></p>
<ul>
<li>a. 在<code>MyAnnotation</code>上声明<code>@Repeatable</code>，成员值为<code>MyAnnotations.class</code>，此时的<code>MyAnnotations</code>为容器注解。</li>
<li>b. 要求<code>MyAnnotation</code>的<code>@Target</code>和<code>@Retention</code>等元注解与<code>MyAnnotations</code>相同。</li>
</ul>
<p>使用示例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//注意：这三个类都是public的，需要分别写在三个文件中</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span> <br><span class="hljs-meta">@Target({TYPE, FIELD, METHOD, PARAMETER, CONSTRUCTOR, LOCAL_VARIABLE})</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyAnnotations {<br>    MyAnnotation[] value();<br>}<br><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@Repeatable(MyAnnotations.class)</span> <span class="hljs-comment">//Repeatable的参数是容器注解的类型</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Target({TYPE, FIELD, METHOD, PARAMETER, CONSTRUCTOR, LOCAL_VARIABLE,</span><br><span class="hljs-meta">         TYPE_PARAMETER,TYPE_USE})</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MyAnnotation {<br>    <span class="hljs-function">String <span class="hljs-title">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> "hello"</span>;<br>}<br><br><span class="hljs-comment">//此时MyAnnotation注解可以重复使用</span><br><span class="hljs-meta">@MyAnnotation(value="hi")</span>  <br><span class="hljs-meta">@MyAnnotation(value="abc")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span></span>{}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、类型注解</strong></p>
<p>JDK 8.0之后，元注解<code>@Target</code>的参数类型<code>ElementType</code>枚举值多了两个：<code>TYPE_PARAMETER</code>和<code>TYPE_USE</code>。在JDK 8.0之前，注解只能是在声明的地方所使用，Java8开始，注解可以应用在任何地方。</p>
<ul>
<li><code>ElementType.TYPE_PARAMETER</code>：表示该注解能写在类型变量的声明语句中（如：泛型声明）。</li>
<li><code>ElementType.TYPE_USE</code>：表示该注解能写在使用类型的任何语句中。</li>
</ul>
<p>比如，同样使用上面的<code>@MyAnnotation</code>，其元注解<code>@Target</code>的参数包括了<code>TYPE_PARAMETER</code>和<code>TYPE_USE</code>，表明该注解可以写在类型变量的声明语句中，也能写在使用类型的任何语句中：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span>&lt;@<span class="hljs-title">MyAnnotation</span> <span class="hljs-title">T</span>&gt;</span>{ <span class="hljs-comment">//写在声明语句中</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">show</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> @MyAnnotation RuntimeException</span>{<br>        ArrayList&lt;<span class="hljs-meta">@MyAnnotation</span> String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">int</span> num = (<span class="hljs-meta">@MyAnnotation</span> <span class="hljs-keyword">int</span>) <span class="hljs-number">10L</span>; <span class="hljs-comment">//写在任何语句中</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记11-Java集合</title>
    <url>/2021/04/09/java-note-1101/</url>
    <content><![CDATA[<h1 id="一、Java集合框架概述"><a href="#一、Java集合框架概述" class="headerlink" title="一、Java集合框架概述"></a>一、Java集合框架概述</h1><h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p><strong>Java集合</strong>像一种容器，可以动态地把多个对象的引用放入容器中。</p>
<p>数组在存储方面的特点：</p>
<ul>
<li>数组初始化以后长度确定。</li>
<li>声明的类型决定了元素初始化时的类型。</li>
</ul>
<p>数组存储数据的缺点：</p>
<ul>
<li>初始化以后长度就不可变，不便于扩展。</li>
<li>提供的属性和方法少，不便于添加删除、插入等操作，效率不高，无法直接获取元素个数。</li>
<li>数据有序、可以重复，存储数据的特点单一。</li>
</ul>
<p><strong>Java集合类</strong>可以用户存储数量不等的多个<strong>对象</strong>，还可用于保存具有映射关系的关联数组。</p>
<h2 id="2、集合框架"><a href="#2、集合框架" class="headerlink" title="2、集合框架"></a>2、集合框架</h2><p>Java 集合框架图：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1101_1.png">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1101_2.png">
</div>

<p>Java集合框架主要有两个接口，<code>Collection</code>接口和<code>Map</code>接口：</p>
<p><code>Collection</code>接口：单列集合，其包括以下几个接口</p>
<ul>
<li><code>List</code>接口：存储<strong>有序(指存储位置有序)、可重复</strong>的数据<ul>
<li>常用实现类为<code>ArrayList</code>、<code>LinkedList</code>、<code>Vector</code></li>
</ul>
</li>
<li><code>Set</code>接口：存储<strong>无序、不可重复</strong>的数据<ul>
<li>常用实现类有<code>HashSet</code>、<code>LinkedHashSet</code>、<code>TreeSet</code></li>
</ul>
</li>
<li><code>Queue</code>接口：先进先出<ul>
<li>常用实现类有<code>LinkedList</code>、<code>PriorityQueue</code></li>
</ul>
</li>
</ul>
<p><code>Map</code>接口：<strong>双列集合，用来存储成对的(key-value)数据</strong></p>
<ul>
<li>常用实现类有<code>HashMap</code>、<code>LinkedHashMap</code>、<code>TreeMap</code>、<code>Hashtable</code>、<code>Properties</code></li>
</ul>
<blockquote>
<p><strong>无序性</strong>指的是存储的数据在底层数组中并非按照数组索引的顺序添加，而是根据数据的哈希值决定的。</p>
</blockquote>
<h1 id="二、Collection接口方法"><a href="#二、Collection接口方法" class="headerlink" title="二、Collection接口方法"></a>二、Collection接口方法</h1><p>向<code>Collection</code>接口的实现类对象中添加数据时，要求此数据所在的类要重写<code>equals()</code>方法。</p>
<p><code>Collection</code>接口定义了能够用于<code>List</code>/<code>Set</code>/<code>Queue</code>的方法。包括以下方法：</p>
<p>1、添加元素：<code>add(Object obj)</code>、<code>addAll(Collection coll)</code><br>2、获取有效元素的个数：<code>int size()</code><br>3、清空集合：<code>void clear()</code><br>4、是否是空集合：<code>boolean isEmpty()</code><br>5、是否包含某个元素：</p>
<ul>
<li><code>boolean contains(Object obj)</code>：是通过元素的equals方法来判断是否是同一个对象</li>
<li><code>boolean containsAll(Collection c)</code>：也是调用元素的equals方法来比较。拿两个集合的元素挨个比较。</li>
</ul>
<p>6、删除：</p>
<ul>
<li><code>boolean remove(Object obj)</code>：通过元素的equals方法判断是否是要删除的那个元素。只会删除找到的第一个元素。</li>
<li><code>boolean removeAll(Collection coll)</code>：取当前集合的差集。</li>
</ul>
<p>7、取两个集合的交集：<code>boolean retainAll(Collection c)</code>：把交集的结果存在当前集合中，不影响c本身</p>
<p>8、集合是否相等：<code>boolean equals(Object obj)</code></p>
<p>9、转成对象数组：<code>Object[] toArray()</code></p>
<blockquote>
<p>数组转换为集合，调用数组的<code>asList()</code>方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">List arr1 = Arrays.asList(<span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[]{<span class="hljs-number">123</span>, <span class="hljs-number">456</span>});<br>System.out.println(arr1.size());<span class="hljs-comment">//1，此时添加的是int[]数组对象引用，长度是1</span><br><br>List&lt;Integer&gt; arr2 = Arrays.asList(<span class="hljs-keyword">new</span> Integer[]{<span class="hljs-number">123</span>, <span class="hljs-number">456</span>});<br>System.out.println(arr2.size());<span class="hljs-comment">//2，添加的是Integer数组，有两个元素</span><br></code></pre></td></tr></tbody></table></figure>
</blockquote>
<p>10、获取对象哈希值：<code>hashCode()</code></p>
<p>11、遍历：<code>iterator()</code>，返回迭代器对象，用于集合遍历</p>
<h1 id="三、Iterator迭代器接口"><a href="#三、Iterator迭代器接口" class="headerlink" title="三、Iterator迭代器接口"></a>三、Iterator迭代器接口</h1><p><code>Collection</code>接口继承了<code>Iterator&lt;E&gt;</code>接口，该接口有<code>iterator()</code>方法，因此<code>Collection</code>的实现类都有这个方法，调用此方法返回一个实现了<code>Iterator</code>接口的对象，可以用于遍历：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Collection coll = <span class="hljs-keyword">new</span> ArrayList(); <span class="hljs-comment">//以ArrayList为例</span><br>Iterator iterator = coll.iterator();  <span class="hljs-comment">//返回一个迭代器对象</span><br><span class="hljs-comment">// Iterator&lt;Integer&gt; iterator = coll.iterator();  //Iterator是泛型类</span><br><span class="hljs-keyword">while</span>(iterator.hasNext()){<br>    Object obj = iterator.next();<br>    <span class="hljs-keyword">if</span>(obj.equals(<span class="hljs-string">"xxx"</span>)){<br>        iter.remove();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>Iterator接口的三个方法：</p>
<ul>
<li><code>boolean hasNext()</code>：判断是否有下一个值</li>
<li><code>E next()</code>：指针下移，并返回下移以后指向的值，E是泛型</li>
<li><code>void remove()</code>：移除当前指向的值。执行remove操作后，需要执行next才能进行下一步操作</li>
</ul>
<blockquote>
<p>迭代器指针初始第一个元素之前，需要next()操作才指向第一个值。</p>
<p>集合对象每次调用<code>iterator()</code>方法都得到一个全新的迭代器对象，默认游标都在集合的第一个元素之前。</p>
</blockquote>
<p>JDK 5.0新增了<code>foreach</code>循环，用于遍历集合、数组，foreach内部仍然使用了迭代器：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">for (元素类型 局部变量：集合或数组对象){</span><br><span class="hljs-comment">	//方法体</span><br><span class="hljs-comment">}</span><br><span class="hljs-comment">*/</span><br><span class="hljs-comment">//遍历集合</span><br>ArrayList&lt;Integer&gt; a = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br><span class="hljs-keyword">for</span>(Integer i : a){<br>    System.out.println(i);<br>}<br><span class="hljs-comment">//遍历数组</span><br><span class="hljs-keyword">int</span>[] array = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[]{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>};<br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i:array){<br>    System.out.println(i);<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、Collection子接口一：List"><a href="#四、Collection子接口一：List" class="headerlink" title="四、Collection子接口一：List"></a>四、Collection子接口一：List</h1><h2 id="1、List接口方法"><a href="#1、List接口方法" class="headerlink" title="1、List接口方法"></a>1、List接口方法</h2><p>除了从<code>Collection</code>接口继承的方法以外，<code>List</code>接口还新增了一些<strong>根据索引操作集合元素</strong>的方法：</p>
<ul>
<li><p><code>void add(int index, Object ele)</code>:在index位置插入ele元素</p>
</li>
<li><p><code>boolean addAll(int index, Collection eles)</code>:从index位置开始将eles中的所有元素添加进来</p>
</li>
<li><p><code>Object get(int index)</code>:获取指定index位置的元素</p>
</li>
<li><p><code>int indexOf(Object obj)</code>:返回obj在集合中首次出现的位置</p>
</li>
<li><p><code>int lastIndexOf(Object obj)</code>:返回obj在当前集合中末次出现的位置</p>
</li>
<li><p><code>Object remove(int index)</code>:移除指定index位置的元素，并返回此元素</p>
<blockquote>
<p>List接口继承了Collection中的方法，包括<code>remove(Object obj)</code>方法。<code>remove(2)</code>默认认为是索引<code>2</code>，<code>remove(new Integer(2))</code>才认为删除的是对象。</p>
</blockquote>
</li>
<li><p><code>Object set(int index, Object ele)</code>:设置指定index位置的元素为ele</p>
</li>
<li><p><code>List subList(int fromIndex, int toIndex)</code>:返回从fromIndex到toIndex位置的子集合</p>
</li>
</ul>
<h2 id="2、实现类"><a href="#2、实现类" class="headerlink" title="2、实现类"></a>2、实现类</h2><p><code>List</code>存储<strong>有序的、可重复</strong>的数据，常用实现类，三者的对比：</p>
<ul>
<li><p><code>ArrayList</code>：List接口主要实现类，<strong>适合频繁查找</strong>；<strong>线程不安全</strong>，效率高；底层使用<strong>数组</strong>实现：<code>Object[] elementData</code>；扩容时默认为原来的1.5倍</p>
</li>
<li><p><code>LinkedList</code>：<strong>适合频繁插入、删除</strong>操作；<strong>线程不安全</strong>；底层使用<strong>双向链表存储</strong>；</p>
</li>
</ul>
<ul>
<li><code>Vector</code>：List接口的早期实现类，与ArrayList几乎相同；<strong>线程安全</strong>，因此效率低；底层同样使用数组实现；与ArrayList另一点不同是扩容时扩大为原来的2倍 (JDK15中，Vector和ArrayList扩容机制相同)。此外，Vector还有一个子类Stack。</li>
</ul>
<h2 id="3、ArrayList"><a href="#3、ArrayList" class="headerlink" title="3、ArrayList"></a>3、ArrayList</h2><p><code>ArrayList</code>对象在JDK 7.0和JDK 8.0中的创建过程不同，JDK 7.0中创建<code>ArrayList</code>对象类似于单例模式的饿汉式，8.0中类似于单例模式的懒汉式，延迟了数组的创建，节省内存。</p>
<ol>
<li><p>JDK 7.0中，创建<code>ArrayList</code>对象的过程：</p>
<p><code>ArrayList list = new ArrayList();</code>    初始化时底层创建<strong>长度是10</strong>的Object[]数组elementData<br><code>list.add(123);</code>    底层执行elementData[0] = new Integer(123);操作<br>…<br><code>list.add(11);</code>    如果此次的添加导致底层elementData数组容量不够，则扩容。<br>默认情况下，扩容为原来的容量的<code>1.5</code>倍，同时需要将原有数组中的数据复制到新的数组中。</p>
<p>结论：建议开发中使用带参的构造器：<code>ArrayList list = new ArrayList(int capacity)</code>，防止频繁扩容降低效率</p>
</li>
<li><p>JDK 8.0中，创建<code>ArrayList</code>对象过程：</p>
<p><code>ArrayList list = new ArrayList();</code>    底层Object[] elementData初始化为{}，并没有创建长度为10的数组</p>
<p><code>list.add(123);</code>    第一次调用add()时，底层才创建了<strong>长度10</strong>的数组，并将数据123添加到elementData[0]<br>…<br>后续的添加和扩容操作与JDK 7 无异。</p>
</li>
</ol>
<h2 id="4、LinkedList"><a href="#4、LinkedList" class="headerlink" title="4、LinkedList"></a>4、LinkedList</h2><p><code>LinkedList</code>类新增了其特有的方法，方便对双向链表操作：</p>
<ul>
<li><code>void addFirst(Object obj)</code></li>
<li><code>void addLast(Object obj)</code></li>
<li><code>Object getFirst()</code></li>
<li><code>Object getLast()</code></li>
<li><code>Object removeFirst()</code></li>
<li><code>Object removeLast()</code></li>
</ul>
<p>LinkedList创建对象的过程：</p>
<p><code>LinkedList list = new LinkedList();</code>    内部声明了<code>Node</code>类型的first和last属性，默认值为null<br><code>list.add(123);</code>    将123封装到Node中，创建了<code>Node</code>对象(创建链表节点，add方法用尾插法插入节点)。</p>
<p>其中，<code>LinkedList</code>的<strong>双向链表</strong>中的节点用<code>Node</code>表示，实现如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinkedList</span>&lt;<span class="hljs-title">E</span>&gt;...</span>{<br>    ...<br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span>&lt;<span class="hljs-title">E</span>&gt; </span>{ <span class="hljs-comment">//内部类：Node，构造每个链表节点</span><br>        E item;<br>        Node&lt;E&gt; next;<br>        Node&lt;E&gt; prev;<br>        Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) { <span class="hljs-comment">//构造器</span><br>            <span class="hljs-keyword">this</span>.item = element;<br>            <span class="hljs-keyword">this</span>.next = next;<br>            <span class="hljs-keyword">this</span>.prev = prev;<br>        }<br>    }<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、Collection子接口二：Set"><a href="#五、Collection子接口二：Set" class="headerlink" title="五、Collection子接口二：Set"></a>五、Collection子接口二：Set</h1><h2 id="1、Set概述"><a href="#1、Set概述" class="headerlink" title="1、Set概述"></a>1、Set概述</h2><p><code>Set</code>接口是<code>Collection</code>的子接口，Set接口没有提供额外的方法。</p>
<p><code>Set</code>存储无序、不可重复的数据。添加相同的元素会添加失败。</p>
<p><code>Set</code>根据<code>equals</code>判断两个对象是否相同。</p>
<p><code>Set</code>接口的常用实现类有：</p>
<ul>
<li><code>HashSet</code>：是Set接口的主要实现类；线程不安全；可以存储null值<ul>
<li><code>LinkedHashSet</code>：<code>HashSet</code>的子类；遍历其内部数据时按照添加的顺序遍历，对于频繁的遍历操作效率高于<code>HashSet</code></li>
</ul>
</li>
<li><code>TreeSet</code>：按照添加对象的制定属性进行排序。</li>
</ul>
<p>向Set(主要指：<code>HashSet</code>、<code>LinkedHashSet</code>)中添加的数据，其所在的类一定要重写<code>hashCode()</code>和<code>equals()</code>。因为添加数据时要用到两个方法进行判断。</p>
<p>重写的<code>hashCode()</code>和<code>equals()</code>尽可能保持一致性：相等(equals返回true)的对象必须具有相等的散列码，不相等的对象尽量有不同的散列码。</p>
<blockquote>
<p>对象中用作 equals() 方法比较的 Field，都应该用来计算 hashCode 值。</p>
</blockquote>
<p>重写hashCode方法中，用到<code>31</code>这个数字的原因：</p>
<ul>
<li>选择系数的时候要选择尽量大的系数。因为如果计算出来的hash地址越大，哈希冲突出现的次数越少，查找起来效率也会提高。（减少哈希冲突）</li>
<li>并且31只占用5bits,相乘造成数据溢出的概率较小。</li>
<li>31可以由<code>i*31== (i&lt;&lt;5)-1</code>来表示,现在很多虚拟机里面都有做相关优化。（提高算法效率）</li>
<li>31是一个素数，素数作用就是如果我用一个数字来乘以这个素数，那么最终出来的结果只能被素数本身和被乘数还有1来整除！(减少冲突)</li>
</ul>
<blockquote>
<p>哈希冲突指不同的哈希值(不同的数据)通过哈希函数得到的哈希值(索引位置)是相同的。解决哈希冲突的方法有：开放地址法、链式地址法(HashMap采用的方法)、建立公共溢出区、再哈希法。</p>
</blockquote>
<h2 id="2、HashSet"><a href="#2、HashSet" class="headerlink" title="2、HashSet"></a>2、HashSet</h2><p><code>HashSet</code>底层采用<code>HashMap</code>实现，Set就是HashMap中的Key，Value是统一定义的空对象，源代码中的Value：<code>private static final Object PRESENT = new Object();</code></p>
<p>其底层原理和HashMap相同，使用了数组和链表（JDK8中加入了红黑树），具体见HashMap解析。</p>
<p>HashSet添加元素的过程，与HashMap相同，实现原理参考下文的<a href="#HashMap">HashMap</a>。</p>
<h2 id="3、TreeSet"><a href="#3、TreeSet" class="headerlink" title="3、TreeSet"></a>3、TreeSet</h2><p><code>TreeSet</code>中添加的数据要求是相同类的对象，其可以根据<strong>自然排序</strong>和<strong>定制排序</strong>两种方式排序。</p>
<p><code>TreeSet</code>中比较两个对象是否相同的标准是<code>compareTo()</code>/<code>compare()</code>返回0。</p>
<p><code>TreeSet</code>用<code>TreeMap</code>实现，底层使用红黑树结构存储数据。</p>
<p><strong>红黑树</strong>：</p>
<p>红黑树是一种自平衡的二叉查找树。红黑树牺牲部分平衡性，换取插入/删除操作时少量的旋转次数，但是搜索效率下降，总体性能优于AVL树（平衡二叉搜索树）。</p>
<p>红黑树定义：</p>
<ul>
<li>结点是红色或黑色。</li>
<li>根节点是黑色。</li>
<li>所有叶子节点都是黑色(叶子节点是NIL节点，即空对象)</li>
<li>每个红色节点的两个子节点都是黑色。（从每个叶子到根的所有路径上不能有两个连续的红色结点）</li>
<li>从任意一个节点到其每个叶子节点的所有路径，包含相同数量的黑色节点。（保证了从根到叶子节点的最长路径不超过最短路径的两倍长，最多是两倍 ）</li>
</ul>
<h1 id="六、Map接口"><a href="#六、Map接口" class="headerlink" title="六、Map接口"></a>六、Map接口</h1><h2 id="1、概述-1"><a href="#1、概述-1" class="headerlink" title="1、概述"></a>1、概述</h2><p><code>Map</code>与<code>Collection</code>并列存在，用于保存具有<strong>映射关系</strong>的双列数据：<code>key-value</code>对。</p>
<p><code>Map</code>结构的理解：</p>
<ul>
<li><code>key</code>：使用<code>Set</code>存放key，无序，不可重复，key所在类必须重写<code>hashCode()</code>和<code>equals()</code>方法，因为添加数据时要用到，而Object类中的<code>hashCode()</code>没有方法体。</li>
<li><code>value</code>：用<code>Collection</code>存放，无序，可重复，value所在的类要重写<code>equals()</code>方法。</li>
<li><code>entry</code>：一个<code>key-value</code>构成一个<code>entry</code>，entry构成的集合是<code>Set</code>，是无序，不可重复的。</li>
<li>两个<code>key</code>相同需要保证：<strong>equals方法返回true</strong>并且<strong>hashCode得到的值相等</strong>：<ul>
<li>如果<code>a</code>和<code>b</code>相等，那么<code>a.equals(b)</code>一定为<code>true</code>，则<code>a.hashCode()</code>必须等于<code>b.hashCode()</code>；</li>
<li>如果<code>a</code>和<code>b</code>不相等，那么<code>a.equals(b)</code>一定为<code>false</code>，则<code>a.hashCode()</code>和<code>b.hashCode()</code>尽量不要相等。</li>
</ul>
</li>
</ul>
<p><code>Map</code>接口几个实现类的对比：</p>
<ul>
<li><code>HashMap</code>：Map的主要实现类；<strong>线程不安全</strong>，效率高；允许存储null的key和value<ul>
<li><code>LinkedHashMap</code>：HashMap子类，在原有的HashMap基础上添加了一对指针，指向前一个元素和后一个元素，因此可以按照添加的顺序遍历。对于频繁遍历操作，效率高于HashMap。</li>
</ul>
</li>
<li><code>TreeMap</code>：保证按照添加的key-value对进行排序，实现排序遍历；根据key进行自然排序或定制排序；底层使用红黑树</li>
<li><code>Hashtable</code>：原始的Map实现类；<strong>线程安全</strong>，效率低；不能存储null的key和value<ul>
<li><code>Properties</code>：Hashtable的子类，常用来处理配置文件，其key和value都是String类型。</li>
</ul>
</li>
</ul>
<h2 id="2、Map接口方法"><a href="#2、Map接口方法" class="headerlink" title="2、Map接口方法"></a>2、Map接口方法</h2><p>Map接口中定义的方法如下：</p>
<p>添加、删除、修改操作：</p>
<ul>
<li><code>V put(K key,V value)</code>：将指定key-value添加到(或修改)当前map对象中，并返回value的值</li>
<li><code>void putAll(Map m)</code>:将m中的所有key-value对存放到当前map中</li>
<li><code>V remove(Object key)</code>：移除指定key的key-value对，并返回value</li>
<li><code>boolean remove(Object key, Object value)</code>：移除指定key和value的key-value对，并返回boolean类型</li>
<li><code>void clear()</code>：清空当前map中的所有数据</li>
</ul>
<p>元素查询的操作：</p>
<ul>
<li><code>V get(Object key)</code>：获取指定key对应的value</li>
<li><code>V getOrDefault(Object key, V defaultValue)</code>：如果指定的key值不存在，返回defaultValue</li>
<li><code>boolean containsKey(Object key)</code>：是否包含指定的key</li>
<li><code>boolean containsValue(Object value)</code>：是否包含指定的value</li>
<li><code>int size()</code>：返回map中key-value对的个数</li>
<li><code>boolean isEmpty()</code>：判断当前map是否为空</li>
<li><code>boolean equals(Object obj)</code>：判断当前map和参数对象obj是否相等</li>
</ul>
<p>元视图操作的方法：</p>
<ul>
<li><p><code>Set&lt;K&gt; keySet()</code>：返回所有key构成的Set集合</p>
</li>
<li><p><code>Collection&lt;V&gt; values()</code>：返回所有value构成的Collection集合</p>
</li>
<li><p><code>Set&lt;Entry&lt;K,V&gt;&gt; entrySet()</code>：返回所有key-value对构成的Set集合</p>
</li>
</ul>
<h2 id="3、HashMap"><a href="#3、HashMap" class="headerlink" title="3、HashMap"></a>3、HashMap</h2><p><span id="HashMap"><code>HashMap</code></span>是Map接口最常用的实现类。在JDK 7.0版本和JDK 8.0版本中，<code>HashMap</code>的底层实现原理不同。</p>
<p><code>HashMap</code>中的<code>Entry数组</code>，这个数组中可以存储元素的位置称为“<code>桶(bucket)</code>”，每个<code>bucket</code>都有指定的索引，系统可以根据索引快速访问该<code>bucket</code>里存储的元素。</p>
<p><strong>JDK 7.0中创建HashMap对象的过程</strong>：</p>
<p><code>HashMap map = new HashMap();</code> 实例化，底层创建了<strong>长度是16</strong>的一维数组<strong>Entry[] table</strong>。<br><code>map.put(key1,value1);</code>执行put操作，首先，调用key1所在类的<code>hashCode()</code>和HashMap中的扰动方法<code>hash()</code>计算key1哈希值，此哈希值经过某种算法(<code>int index = (n - 1) &amp; hash;</code>)计算以后，得到在Entry数组中的存放位置。</p>
<ul>
<li>如果此位置上的数据为空，此时的key1-value1添加成功。 ——&gt;情况1</li>
<li>如果此位置上的数据不为空(<strong>哈希冲突/碰撞</strong>。此位置上的存在一个或多个数据以链表形式存在),比较key1和已经存在的一个或多个数据的哈希值（这里比较的是经过<code>hash()</code>方法计算得出的哈希值）：<ul>
<li>如果key1的哈希值与已经存在的数据的哈希值都不相同，此时key1-value1添加成功。——&gt;情况2</li>
<li>如果key1的哈希值和已经存在的某一个数据(key2-value2)的哈希值相同，继续比较：调用key1所在类的equals(key2)方法：<ul>
<li>如果equals()返回false：此时key1-value1添加成功。——&gt;情况3</li>
<li>如果equals()返回true：使用value1替换value2（如果在HashSet中，这种情况会添加失败，但是在Map中则是进行value覆盖）。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>对于添加成功的情况2和情况3而言：元素a 与已经存在指定索引位置上数据以链表的方式存储。</p>
<p><strong>关于HashMap的说明</strong></p>
<ul>
<li><p><code>hashCode()</code>得到原始的哈希值，Java中又使用了<code>hash()</code>方法进行扰动，得到哈希值以后没有直接作为索引(直接将哈希值作为索引，数值太大)，而是使用<code>与</code>操作计算在数组中的索引，JDK7和8中的计算索引方法相同：<code>int index = (table.length - 1) &amp; hash;</code></p>
</li>
<li><p>扰动函数<code>hash()</code>的作用（源码注释：JDK7中为了防止低效的哈希函数，JDK8中是为了解决JDK7中只考虑低位的缺陷），JDK8中，改变了<code>hash()</code>的实现，将哈希值的高位和低位混合，加大低位的随机性，从而在获得数组索引时减少冲突（这种冲突是由于计算索引值引起的），因为只算低位的话，就算哈希值不同，也可能得到相同的索引值引起冲突。如果是<code>hashCode()</code>计算出不同数据的哈希值相同（哈希冲突），<code>hash()</code>方法是解决不了的。<code>hash()</code>的具体解析可以参考<a href="https://www.zhihu.com/question/20733617/answer/111577937">链接</a>。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//JDK 7中的hash方法</span><br>	<span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object k)</span> </span>{<br>        <span class="hljs-keyword">int</span> h = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (useAltHashing) {<br>            <span class="hljs-keyword">if</span> (k <span class="hljs-keyword">instanceof</span> String) {<br>                <span class="hljs-keyword">return</span> sun.misc.Hashing.stringHash32((String) k);<br>            }<br>            h = hashSeed;<br>        }<br>        h ^= k.hashCode();<br>        h ^= (h &gt;&gt;&gt; <span class="hljs-number">20</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">12</span>);<br>        <span class="hljs-keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="hljs-number">7</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">4</span>);<br>    }}<br><br><span class="hljs-comment">//JDK 8中的hash方法</span><br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>{<br>        <span class="hljs-keyword">int</span> h;<br>        <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>    }<span class="hljs-comment">//将原始哈希值的高位和其本身异或，减少计算索引时出现的冲突。</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>哈希冲突指的是不同的数据映射到了相同的位置（不同数据的哈希值相同），在HashMap中出现冲突有两个原因，一个是<code>hashCode()</code>计算的哈希值相同引起的哈希冲突，另一个是不同哈希值但是经过索引计算映射到了同一个位置。JDK8中hashCode()得到的哈希值相同，则hash()得到的也相同，hashCode()得到的哈希值不同，那么hash()得到的值肯定也不同。</p>
</li>
<li><p>所以在添加数据时，如果此位置上已有数据（出现哈希冲突），需要判断哈希值（<code>hash()</code>返回值）是否相同，如果哈希值不同却出现在了同一个位置（情况2），是由于Java中计算索引的方法导致的，可以直接添加；如果哈希值相同（hashCode()计算出的哈希值相同引起哈希冲突），这时只能通过<code>equals()</code>方法比较是不是相同的数据，如果是相同的数据，则进行覆盖，否则就添加。</p>
</li>
</ul>
<p><strong>JDK 8.0创建HashMap对象与JDK 7.0其他的不同</strong>：</p>
<ul>
<li><p>new HashMap()初始化时，底层没有创建一个长度为16的数组，首次调用put()方法时才创建，这一点类比于ArrayList在两个版本的区别。</p>
</li>
<li><p>JDK 8.0<strong>底层数组是Node[]</strong>，而非Entry[]，实际上<strong>内部类Node</strong>实现了<strong>内部接口Entry</strong>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HashMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;...</span>{<br>    <span class="hljs-comment">//内部类Node</span><br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Node</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>.<span class="hljs-title">Entry</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; </span>{<br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> hash;<br>        <span class="hljs-keyword">final</span> K key;<br>        V value;<br>        Node&lt;K,V&gt; next; <br>        <span class="hljs-comment">//Node[]数组中每个位置存储一个Node对象，每个对象的next引用指向下一个元素</span><br>        <span class="hljs-comment">//在JDK 7中，同样，每个Entry[]数组的每个位置存储一个Entry对象，有next指针</span><br><br>        Node(<span class="hljs-keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) {<br>            <span class="hljs-keyword">this</span>.hash = hash;<br>            <span class="hljs-keyword">this</span>.key = key;<br>            <span class="hljs-keyword">this</span>.value = value;<br>            <span class="hljs-keyword">this</span>.next = next;<br>        }<br>        ... <span class="hljs-comment">//内部类中的其他方法，比如实现的getKey()、getValue()等</span><br>    }<br>    <span class="hljs-comment">//内部接口 Entry</span><br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Entry</span>&lt;<span class="hljs-title">K</span>, <span class="hljs-title">V</span>&gt; </span>{<br>        <span class="hljs-function">K <span class="hljs-title">getKey</span><span class="hljs-params">()</span></span>;<br>        <span class="hljs-function">V <span class="hljs-title">getValue</span><span class="hljs-params">()</span></span>;<br>        ...<br>    }<br>    ...<span class="hljs-comment">//HashMap中的其他方法</span><br>}<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>JDK 7.0底层结构是<strong>数组+链表</strong>，JDK 8.0底层结构是<strong>数组+链表+红黑树</strong>，因此添加到已有元素的位置上时，需要判断是链表节点还是树节点。</p>
</li>
<li><p>JDK 8.0中，当某个bucket的链表长度<code>&gt;8</code>，并且数组长度（容量,capacity,table的长度）<code>&gt;64</code>时，才将链表改为红黑树。如果仅是长度&gt;8，数组容量不到64，会进行扩容。</p>
</li>
<li><p>如果映射关系被移除，下次resize方法时判断树的节点个数<code>&lt;6</code>，会将树转为链表。这里为了避免树和链表频繁转换带来的效率损失，才使用6，而没有直接选择8。</p>
</li>
<li><p>形成链表时，和ArrayList相同（七上八下）。JDK 7.0中，冲突时使用头插法将新节点插入到链表，由于是线程不安全的，可能导致出现<strong>环形链表(链表死循环)</strong>。JDK 8.0使用尾插法解决了这一问题。</p>
</li>
</ul>
<p><strong>HashMap的重要常量</strong>：</p>
<ul>
<li><code>DEFAULT_INITIAL_CAPACITY</code>：HashMap的默认容量，<code>16</code></li>
<li><code>DEFAULT_LOAD_FACTOR</code>：HashMap的默认加载因子：<code>0.75</code></li>
<li><code>threshold</code>：扩容的临界值 = 容量 x 填充因子，比如<code>16*0.75=12</code></li>
<li><code>TREEIFY_THRESHOLD</code>：Bucket中链表长度大于改值时，就转化为红黑树：<code>8</code></li>
<li><code>MIN_TREEIFY_CAPACITY</code>：桶中的Node被树化时最小的hash表容量：<code>64</code></li>
<li><code>MAXIMUM_CAPACITY</code>：HashMap最大支持容量：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.676ex" style="vertical-align: -0.338ex;" viewBox="0 -1006.6 1308.3 1152.1" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">2^{30}</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path>
<path stroke-width="1" id="E1-MJMAIN-30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-32" x="0" y="0"></use>
<g transform="translate(500,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-33"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-30" x="500" y="0"></use>
</g>
</g>
</svg></li>
<li><code>table</code>：存储元素的数组，总是2的n次幂</li>
<li><code>entrySet</code>：存储所有entry元素的集合（Set）</li>
<li><code>size</code>：存储的键值对的数量</li>
<li><code>modCount</code>：HashMap扩容和结构改变的次数。</li>
</ul>
<blockquote>
<p>链表长度大于8并且容量大于64时，才变为红黑树，为什么是8？为什么容量要大于64？</p>
<p>答：阈值为8是出于时间和空间两方面权衡。哈希值离散性理想情况下，链表长度达到8的几率很小，bin中的节点分布频率服从泊松分布，链表长度大于8的几率小于千万分之一，此情况下如果仍达到了8个节点，说明节点数以后很可能还会继续增加，需要使用红黑树优化查找效率。另一方面，树节点占用空间是普通节点的2倍，如果阈值太小，频繁使用树结构会造成空间浪费。</p>
<p>关于容量大于64，源码中解释：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">The smallest table capacity for which bins may be treeified.</span><br><span class="hljs-comment">(Otherwise the table is resized if too many nodes in a bin.)</span><br><span class="hljs-comment">Should be at least 4 * TREEIFY_THRESHOLD to avoid conflicts </span><br><span class="hljs-comment">between resizing and treeification thresholds.</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>也就是说，为了避免扩容和树化阈值之间的冲突，至少需要4x8=32个bin，如果长度太小，树化以后，如果扩容可能还需要树化，降低了效率。底层数组容量一直是2的n次幂，要想保证32个位置有元素，考虑0.75负载因子，至少需要64的长度。</p>
</blockquote>
<p><strong>HashMap的扩容机制</strong>：</p>
<p>添加数据时，当<strong>当前存放的值（size）超出临界值（threshold）且要存放的位置非空时</strong>会扩容，默认的扩容方式是扩容为原来容量的2倍，然后重新计算旧数组中节点的存储位置并复制过去。由于是扩容为2倍，索引计算方式为哈希值和数组长度-1进行与操作，得到的新数组索引要么是原下标位置，要么是原下标+原数组大小。</p>
<p>JDK 7采用<strong>头插法</strong>将每个bucket上的链表依次取出并放到新数组指定的位置，结果是链表顺序会变反。并且在多线程的情况下，容易导致链表循环。想要线程安全，可以使用<code>ConcurrentHashMap</code></p>
<p>JDK 8采用<strong>尾插法</strong>，解决了链表循环的问题。</p>
<p><strong>Java的HashMap解决哈希冲突的方法</strong>：</p>
<ul>
<li>使用链地址法，链接相同位置上的数据。</li>
<li>使用2次扰动函数（源码中的<code>hash()</code>函数），将<code>hashCode()</code>得到的哈希值的高位和低位混合，加大低位的随机性，使哈希值映射到数组索引更平均。</li>
<li>JDK 8.0中又引入红黑树，进一步降低遍历的时间复杂度，使遍历更快</li>
</ul>
<p><strong>LinkedHashMap</strong></p>
<p><code>LinkedHashMap</code>是<code>HashMap</code>的子类，其在<code>HashMap</code>的存储基础上，使用双向链表记录添加元素的顺序。</p>
<p>与<code>LinkedHashSet</code>类似，<code>LinkedHashMap</code>可以维护<code>Map</code>的迭代顺序，迭代顺序与Key-value对插入顺序一致。</p>
<p><code>LinkedHashMap</code>中的存储结构：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LinkedHashMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; </span><br><span class="hljs-class">    <span class="hljs-keyword">extends</span> <span class="hljs-title">HashMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;</span><br><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">Map</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;</span><br><span class="hljs-class"></span>{<br>    ...<br>	<span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Entry</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title">HashMap</span>.<span class="hljs-title">Node</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt; </span>{<br>        <span class="hljs-comment">//Entry有两个额外的指针，分别指向上一个和下一个节点</span><br>        Entry&lt;K,V&gt; before, after; <br>        Entry(<span class="hljs-keyword">int</span> hash, K key, V value, Node&lt;K,V&gt; next) {<br>            <span class="hljs-keyword">super</span>(hash, key, value, next);<br>        }<br>    }<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>JDK 8中HashMap添加数据的过程源码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HashMap</span>&lt;<span class="hljs-title">K</span>,<span class="hljs-title">V</span>&gt;...</span>{<br>    ...<br>	<span class="hljs-function"><span class="hljs-keyword">final</span> V <span class="hljs-title">putVal</span><span class="hljs-params">(<span class="hljs-keyword">int</span> hash, K key, V value, <span class="hljs-keyword">boolean</span> onlyIfAbsent,</span></span><br><span class="hljs-function"><span class="hljs-params">                   <span class="hljs-keyword">boolean</span> evict)</span> </span>{<br>        Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="hljs-keyword">int</span> n, i;<br>        <span class="hljs-comment">//如果table为空，扩容</span><br>        <span class="hljs-keyword">if</span> ((tab = table) == <span class="hljs-keyword">null</span> || (n = tab.length) == <span class="hljs-number">0</span>)<br>            n = (tab = resize()).length; <br>        <span class="hljs-comment">//如果目标位置为空，创建新节点并添加</span><br>        <span class="hljs-keyword">if</span> ((p = tab[i = (n - <span class="hljs-number">1</span>) &amp; hash]) == <span class="hljs-keyword">null</span>)<br>            tab[i] = newNode(hash, key, value, <span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">//如果目标位置有值，进一步判断</span><br>        <span class="hljs-keyword">else</span> {<br>            Node&lt;K,V&gt; e; K k;<br>            <span class="hljs-comment">//如果目标位置的值，hash值和数据都相同，进行覆盖</span><br>            <span class="hljs-keyword">if</span> (p.hash == hash &amp;&amp;<br>                ((k = p.key) == key || (key != <span class="hljs-keyword">null</span> &amp;&amp; key.equals(k))))<br>                e = p;<br>            <span class="hljs-comment">//如果目标位置的值和要添加的值不同，则添加。</span><br>            <span class="hljs-comment">//判断是链表节点还是树节点，如果是树节点，调用putTreeVal</span><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (p <span class="hljs-keyword">instanceof</span> TreeNode)<br>                e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="hljs-keyword">this</span>, tab, hash, key, value);<br>            <span class="hljs-comment">//如果是链表节点，需要依次往下遍历</span><br>            <span class="hljs-keyword">else</span> {<br>                <span class="hljs-comment">//遍历当前链表</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> binCount = <span class="hljs-number">0</span>; ; ++binCount) {<br>                    <span class="hljs-comment">//如果到达链表尾部，则新建链表节点，并不马上插入节点</span><br>                    <span class="hljs-comment">//需要判断当前已有节点个数，是否需要树化</span><br>                    <span class="hljs-keyword">if</span> ((e = p.next) == <span class="hljs-keyword">null</span>) {<br>                        p.next = newNode(hash, key, value, <span class="hljs-keyword">null</span>);<br>                        <span class="hljs-comment">//如果此时链表已经有了8个节点，调用treeifyBin树化</span><br>                        <span class="hljs-keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="hljs-number">1</span>) <span class="hljs-comment">// -1 for 1st</span><br>                            <span class="hljs-comment">//此方法会额外判断table数组长度是否大于64，</span><br>                            <span class="hljs-comment">//如果大于64才构造红黑树，否则执行扩容操作</span><br>                            treeifyBin(tab, hash);<br>                        <span class="hljs-keyword">break</span>;<br>                    }<br>                    <span class="hljs-comment">//如果找到和待添加的值相同的数据，则break</span><br>                    <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp;<br>                        ((k = e.key) == key || (key != <span class="hljs-keyword">null</span> &amp;&amp; key.equals(k))))<br>                        <span class="hljs-keyword">break</span>;<br>                    <span class="hljs-comment">//如果既没有到达末尾，也没有找到相同数据，则将e赋给p，继续向后找</span><br>                    p = e;<br>                }<br>            }<br>            <span class="hljs-comment">//进行value覆盖</span><br>            <span class="hljs-keyword">if</span> (e != <span class="hljs-keyword">null</span>) { <span class="hljs-comment">// existing mapping for key</span><br>                V oldValue = e.value;<br>                <span class="hljs-keyword">if</span> (!onlyIfAbsent || oldValue == <span class="hljs-keyword">null</span>)<br>                    e.value = value;<br>                afterNodeAccess(e);<br>                <span class="hljs-keyword">return</span> oldValue;<br>            }<br>        }<br>        ++modCount;<br>        <span class="hljs-keyword">if</span> (++size &gt; threshold)<br>            resize(); <span class="hljs-comment">//判断添加数据以后是否需要扩容</span><br>        afterNodeInsertion(evict);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    }<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>关于HashMap的常见问题，可以参考<a href="https://www.cnblogs.com/Young111/p/11519952.html">HashMap数据结构相关知识总结</a></p>
<h2 id="4、TreeMap"><a href="#4、TreeMap" class="headerlink" title="4、TreeMap"></a>4、TreeMap</h2><p>保证按照添加的<code>key-value</code>对进行排序，实现排序遍历。只考虑<code>key</code>的<strong>自然排序或定制排序</strong>。使用自然排序或定制排序的方法比较<code>key</code>的大小，而不是<code>equals()</code>方法。</p>
<p>底层使用红黑树结构。</p>
<h2 id="5、Hashtable"><a href="#5、Hashtable" class="headerlink" title="5、Hashtable"></a>5、Hashtable</h2><p><strong>HashMap 和 Hashtable 的区别</strong></p>
<ul>
<li>HashMap 是线程不安全的，Hashtable 是线程安全的；</li>
<li>由于线程安全，所以 Hashtable 的效率比不上 HashMap；</li>
<li>HashMap最多只允许一条记录的键为null，允许多条记录的值为null，而 Hashtable 不允许key和value的值为null；</li>
<li>HashMap 默认初始化数组的大小为16，Hashtable 为 11，前者扩容时，扩大两倍，后者扩大两倍+1；</li>
<li>HashMap 在hashCode基础上需要重新计算 hash 值，而 Hashtable 直接使用对象的 hashCode。</li>
</ul>
<p><strong>Properties</strong></p>
<p><code>Properties</code>是<code>Hashtable</code>的子类，用于处理属性文件。</p>
<p>由于属性文件里的<code>key</code>、<code>value</code>都是字符串类型，所以<code>Properties</code>里的<code>key</code>和<code>value</code>都是字符串类型</p>
<p>存取数据时，建议使用<code>setProperty(String key,String value)</code>方法和<code>getProperty(String key)</code>方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Properties pros = <span class="hljs-keyword">new</span> Properties();<br>pros.load(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"jdbc.properties"</span>));<br>String user = pros.getProperty(<span class="hljs-string">"user"</span>);<br>System.out.println(user);<br></code></pre></td></tr></tbody></table></figure>
<h1 id="七、Collections工具类"><a href="#七、Collections工具类" class="headerlink" title="七、Collections工具类"></a>七、Collections工具类</h1><p>和操作数组的工具类<code>Arrays</code>类似，<code>Collections</code>是操作<code>Set</code>、<code>List</code>、<code>Map</code>等集合的工具类。</p>
<p><code>Collections</code>提供了一系列静态方法，用于对集合元素的排序、查询和修改等操作：</p>
<ul>
<li><code>reverse(List)</code>：反转 List 中元素的顺序</li>
<li><code>shuffle(List)</code>：对 List 集合元素进行随机排序</li>
<li><code>sort(List)</code>：根据元素的自然顺序对指定 List 集合元素按升序排序</li>
<li><code>sort(List，Comparator)</code>：根据指定的 Comparator 产生的顺序对 List 集合元素进行排序</li>
<li><code>swap(List，int i， int j)</code>：将指定 list 集合中的 i 处元素和 j 处元素进行交换</li>
<li><code>Object max(Collection)</code>：根据元素的自然顺序，返回给定集合中的最大元素</li>
<li><code>Object max(Collection，Comparator)</code>：根据 Comparator 指定的顺序，返回给定集合中的最大元素</li>
<li><code>Object min(Collection)</code></li>
<li><code>Object min(Collection，Comparator)</code></li>
<li><code>int frequency(Collection，Object)</code>：返回指定集合中指定元素的出现次数</li>
<li><code>void copy(List dest,List src)</code>：将src中的内容复制到dest中</li>
<li><code>boolean replaceAll(List list，Object oldVal，Object newVal)</code>：使用新值替换 List 对象的所有旧值</li>
</ul>
<p>此外，<code>Collections</code>类还提供了多个<code>synchronizedXxx()</code> 方法，该方法可使将指定集合包装成线程同步的集合，从而可以解决多线程并发访问集合时的线程安全问题：</p>
<ul>
<li><code>static &lt;T&gt; Collection&lt;T&gt; synchronizedCollection(Collection&lt;T&gt; c)</code></li>
<li><code>static &lt;T&gt; Set&lt;T&gt; synchronizedSet(Set&lt;T&gt; s)</code></li>
<li><code>static &lt;T&gt; List&lt;T&gt; synchronizedList(List&lt;T&gt; list)</code></li>
<li><code>static &lt;K,V&gt; Map&lt;K,V&gt; synchronizedMap(Map&lt;K,V&gt; m)</code></li>
<li><code>static &lt;K,V&gt; NavigableMap&lt;K,V&gt; synchronizedNavigableMap(NavigableMap&lt;K,V&gt; m)</code></li>
<li><code>static &lt;T&gt; NavigableSet&lt;T&gt; synchronizedNavigableSet(NavigableSet&lt;T&gt; s)</code></li>
<li><code>static &lt;K,V&gt; SortedMap&lt;K,V&gt; synchronizedSortedMap(SortedMap&lt;K,V&gt; m)</code></li>
<li><code>static &lt;T&gt; SortedSet&lt;T&gt; synchronizedSortedSet(SortedSet&lt;T&gt; s)</code></li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记14-网络编程</title>
    <url>/2021/04/17/java-note-1401/</url>
    <content><![CDATA[<h1 id="一、网络编程概述"><a href="#一、网络编程概述" class="headerlink" title="一、网络编程概述"></a>一、网络编程概述</h1><p>Java提供了网络类库，可以轻松实现网络连接，底层细节隐藏在Java的本机安装系统里，由JVM控制。Java实现了一个跨平台的网络库，程序员面对的是一个统一的网络编程环境。</p>
<p>网络编程的目的：直接或间接地通过网络协议与其它计算机实现数据交换，进行通讯。</p>
<p>实现网络编程面对的两个问题：</p>
<ul>
<li>如何准确定位某台主机，如何定位主机上的特定应用。<ul>
<li>解决方法：使用IP地址定位主机，端口号定位特定应用</li>
</ul>
</li>
<li>找到主机后如何可靠高效地进行数据传输。<ul>
<li>解决方法：提供网络通信协议。</li>
</ul>
</li>
</ul>
<h1 id="二、网络通信两个要素"><a href="#二、网络通信两个要素" class="headerlink" title="二、网络通信两个要素"></a>二、网络通信两个要素</h1><p>想要实现网络中的主机互相通信，需要满足两个条件：</p>
<ul>
<li>已知通信双方的地址，包括<strong>IP和端口号</strong>。</li>
<li>一定的规则，即网络通信协议。有OSI和TCP/IP两个参考模型 ，OSI参考模型过于理想化，主要是使用<strong>TCP/IP参考模型（TCP/IP协议）</strong>。</li>
</ul>
<table>
    <tbody><tr>
        <td><font color="red"><b>OSI参考模型</b></font></td>
        <td><font color="red"><b>TCP/IP参考模型</b></font></td>
        <td><font color="red"><b>TCP/IP参考模型各层对应协议</b></font></td>
    </tr>
    <tr>
        <td>应用层</td>
        <td rowspan="3">应用层</td>
        <td rowspan="3">HTTP、FTP、Telnet、DNS...</td>
    </tr>
    <tr>
        <td>表示层</td>
    </tr>
    <tr>
        <td>会话层</td>
    </tr>
    <tr>
        <td>传输层</td>
        <td>传输层</td>
        <td>TCP、UDP...</td>
    </tr>
    <tr>
        <td>网络层</td>
        <td>网络层</td>
        <td>IP、ICMP、ARP...</td>
    </tr>
    <tr>
        <td>数据链路层</td>
        <td rowspan="2">物理+数据链路层</td>
        <td rowspan="2">以太网、无线LAN...</td>
    </tr>
    <tr>
        <td>物理层</td>
    </tr>
</tbody></table>





<h2 id="1、IP和端口号"><a href="#1、IP和端口号" class="headerlink" title="1、IP和端口号"></a>1、IP和端口号</h2><p><strong>IP地址</strong></p>
<p>IP：唯一的标识Internet上的计算机（通信实体），Java中使用<code>InetAddress</code>类代表IP。</p>
<p>Internet上的主机有两种方式表示地址：</p>
<ul>
<li>域名(hostName，主机名)：比如 www.baidu.com。其中本地主机名用localhost表示</li>
<li>IP地址(hostAddress)：比如 182.61.200.7。本地地址用127.0.0.1表示</li>
</ul>
<p><code>InetAddress</code>没有公共的构造器，提供了两个静态方法用于实例化：</p>
<ul>
<li><code>public static InetAddress getLocalHost()</code>：返回localhost地址的InetAddress对象</li>
<li><code>public static InetAddress getByName(String host)</code>：返回指定主机地址的InetAddress对象，host参数可以是域名或者ip地址。</li>
</ul>
<p><code>InetAddress</code>常用的方法：</p>
<ul>
<li><code>public String getHostName()</code>：返回当前主机的域名(主机名)</li>
<li><code>public String getHostAddress()</code>：返回当前主机的ip地址</li>
<li><code>public boolean isReachable(int timeout)</code>：测试指定时间内是否可以到达当前地址</li>
</ul>
<p>应用实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InetAddressTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        InetAddress inet1 = InetAddress.getByName(<span class="hljs-string">"www.baidu.com"</span>);<br>        System.out.println(inet1.getHostAddress()); <span class="hljs-comment">// 182.61.200.7</span><br>        System.out.println(inet1.getHostName()); <span class="hljs-comment">// www.baidu.com</span><br><br>        InetAddress inet2 = InetAddress.getByName(<span class="hljs-string">"182.61.200.7"</span>);<br>        System.out.println(inet2.getHostAddress()); <span class="hljs-comment">// 182.61.200.7</span><br>        System.out.println(inet2.getHostName()); <span class="hljs-comment">// 182.61.200.7</span><br>        <br>        System.out.println(inet1.isReachable(<span class="hljs-number">500</span>)); <span class="hljs-comment">//true</span><br>        System.out.println(inet2.isReachable(<span class="hljs-number">500</span>)); <span class="hljs-comment">//true</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>端口号</strong></p>
<p>端口号用来标识正在计算机上运行的程序（进程）。<strong>不同的进程有不同的端口号</strong>，端口号用一个16位的整数表示，范围是<code>0-65535</code></p>
<p>端口分类：</p>
<ul>
<li>公认端口：<code>0-1023</code>。被预先定义的服务通信占用，如HTTP占用端口80，FTP占用端口21，Telnet占用端口23等。</li>
<li>注册端口：<code>1024-49151</code>，分配给用户进程或应用程序。比如Tomcat占用端口8080，MySQL占用端口3306，Oracle占用端口1521等。</li>
<li>动态/私有端口：<code>49152-65535</code>，即<code>1100 0000 0000 0000-1111 1111 1111 1111</code></li>
</ul>
<p>端口号和IP地址的组合，得到<strong>网络套接字：Socket</strong>。</p>
<h2 id="2、网络通信协议"><a href="#2、网络通信协议" class="headerlink" title="2、网络通信协议"></a>2、网络通信协议</h2><p>网络通信协议对速率、传输代码、代码结构、传输控制步骤、出错控制等制定标准。</p>
<p>以<strong>TCP/IP协议</strong>为例。TCP/IP协议将网络协议分成了<strong>物理链路层</strong>、<strong>网络层</strong>、<strong>传输层</strong>和<strong>应用层</strong>四层，其中传输层有两个非常重要的协议：</p>
<ul>
<li><strong>TCP</strong>(Transmission Control Protocol)：传输控制协议。<ul>
<li>使用TCP协议前，须先建立TCP连接，形成传输数据通道。</li>
<li>传输前，采用“三次握手”方式，点对点通信，<strong>是可靠的</strong>。</li>
<li>TCP协议进行通信的两个应用进程：客户端、服务端。</li>
<li>在连接中可<strong>进行大数据量的传输</strong>。</li>
<li>传输完毕，<strong>需释放已建立的连接，效率低</strong>。</li>
</ul>
</li>
<li><strong>UDP</strong>(User Datagram Protocol)：用户数据报协议。<ul>
<li>将数据、源、目的封装成数据包，<strong>不需要建立连接</strong>。</li>
<li>每个数据报的大小限制在64K内。</li>
<li>发送不管对方是否准备好，接收方收到也不确认，<strong>是不可靠的</strong>。</li>
<li>可以广播发送。</li>
<li>发送数据结束时<strong>无需释放资源，开销小，速度快</strong>。</li>
</ul>
</li>
</ul>
<p>TCP的三次握手和四次挥手：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1401_1.png">
</div>

<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1401_2.png">
</div>






<p><strong>Socket</strong></p>
<p>网络上具有唯一标识的<strong>IP地址</strong>和<strong>端口号</strong>组合在一起，构成唯一能识别的标识符<strong>套接字(Socket)</strong>。</p>
<p>通信的两端都要有Socket，是两台机器间通信的端点。</p>
<p>网络通信其实就是Socket间的通信。</p>
<p>Socket允许程序把网络连接当成一个流，数据在两个Socket间通过IO传输。</p>
<p>一般主动发起通信的应用程序属<strong>客户端</strong>，等待通信请求的为<strong>服务端</strong>。</p>
<p><strong>Socket分类</strong>：</p>
<ul>
<li>流套接字（stream socket）：使用<strong>TCP</strong>提供<strong>可依赖</strong>的字节流服务。</li>
<li>数据报套接字（datagram socket）：使用<strong>UDP</strong>提供<strong>“尽力而为”</strong>的数据报服务。</li>
</ul>
<p><strong><code>Socket</code>类的常用构造器</strong>：</p>
<ul>
<li><code>public Socket(InetAddress address, int port)</code>：创建一个流套接字并将其连接到指定IP地址的指定端口号。</li>
<li><code>public Socket(String host, int port)</code>：创建一个流套接字并将其连接到指定主机上的指定端口号。</li>
</ul>
<p><strong><code>Socket</code>类的常用方法</strong>：</p>
<ul>
<li><code>public InputStream getInputStream()</code>：返回此套接字的输入流。可以用于接收网络消息</li>
<li><code>public OutputStream getOutputStream()</code>：返回此套接字的输出流。可以用于发送网络消息</li>
<li><code>public InetAddress getInetAddress()</code>：此套接字连接到的远程IP地址；如果套接字是未连接的，则返回null。</li>
<li><code>public InetAddress getLocalAddress()</code>：获取套接字绑定的本地地址。即本端的IP地址</li>
<li><code>public int getPort()</code>：此套接字连接到的远程端口号；如果尚未连接套接字，则返回0。</li>
<li><code>public int getLocalPort()</code>：返回此套接字绑定到的本地端口。如果尚未绑定套接字，则返回-1。即本端的端口号。</li>
<li><code>public void close()</code>：关闭此套接字。套接字被关闭后，便不可在以后的网络连接中使用（即无法重新连接或重新绑定）。需要创建新的套接字对象。关闭此套接字也将会关闭该套接字的InputStream和OutputStream。</li>
<li><code>public void shutdownInput()</code>：如果在套接字上调用shutdownInput()后从套接字输入流读取内容，则流将返回EOF（文件结束符）。即不能在从此套接字的输入流中接收任何数据。</li>
<li><code>public void shutdownOutput()</code>：禁用此套接字的输出流。对于TCP套接字，任何以前写入的数据都将被发送，并且后跟TCP的正常连接终止序列。如果在套接字上调用shutdownOutput()后写入套接字输出流，则该流将抛出IOException。即不能通过此套接字的输出流发送任何数据。</li>
</ul>
<h1 id="三、TCP网络编程"><a href="#三、TCP网络编程" class="headerlink" title="三、TCP网络编程"></a>三、TCP网络编程</h1><h2 id="1、TCP通信流程"><a href="#1、TCP通信流程" class="headerlink" title="1、TCP通信流程"></a>1、TCP通信流程</h2><p><strong>TCP连接的套接字函数</strong>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1401_3.png" style="transform:scale(0.8)"></p>
<p>基于Socket的TCP编程，基本步骤：</p>
<p><strong>客户端</strong>：</p>
<ul>
<li><strong>创建Socket</strong>：根据指定服务端的IP地址或端口号构造Socket类对象（使用Socket类的两个构造器方法）。若服务器端响应，则建立客户端到服务器的通信线路。若连接失败，会出现异常。</li>
<li><strong>打开连接到Socket的输入/输出流</strong>：用getInputStream()方法获得输入流，使用getOutputStream()方法获得输出流，进行数据传输。</li>
<li><strong>按照一定的协议对Socket进行读/写操作</strong>：通过输入流读取服务器放入线路的信息（但不能读取自己放入线路的信息），通过输出流将信息写入线程。</li>
<li><strong>关闭Socket</strong>：断开客户端到服务器的连接，释放线路。</li>
</ul>
<blockquote>
<p>客户端建立socketAtClient对象的过程就是向服务器发出套接字连接请求。</p>
<p>客户端可以自定义，可以是浏览器</p>
</blockquote>
<p><strong>服务器</strong>：</p>
<ul>
<li><strong>调用ServerSocket（int port）</strong>：创建一个服务端套接字，并绑定到指定端口上，用于监听客户端的请求。</li>
<li><strong>调用accept（）</strong>：监听连接请求，如果客户端请求连接，则接受连接。此方法返回通信套接字对象。</li>
<li><strong>调用返回的Socket类对象的getOutputStream()和getInputStream()</strong>：获取输出流和输入流，开始网络数据的发送和接收。</li>
<li><strong>关闭ServerSocket和Socket对象</strong>：客户端访问结束，关闭通信套接字。</li>
</ul>
<blockquote>
<p>ServerSocket对象负责等待客户端请求建立套接字连接。服务器必须实现建立一个等待客户请求建立socket连接的ServerSocket对象。</p>
<p>accept接收客户的socket请求，并返回一个socket对象。</p>
<p>服务端可以自定义，可以是Tomcat服务器</p>
</blockquote>
<h2 id="2、TCP网络编程案例"><a href="#2、TCP网络编程案例" class="headerlink" title="2、TCP网络编程案例"></a>2、TCP网络编程案例</h2><p>应用举例1，客户端发送文件给服务端， 服务端保存到本地，并返回“接收成功”给客户端：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TCPTest3</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">client</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        <span class="hljs-comment">//1.创建Socket，指定要连接的主机地址和端口号</span><br>        Socket socket = <span class="hljs-keyword">new</span> Socket(InetAddress.getByName(<span class="hljs-string">"127.0.0.1"</span>),<span class="hljs-number">9090</span>);<br>        <span class="hljs-comment">//2.打开连接到socket的输出流</span><br>        OutputStream os = socket.getOutputStream();<br>        <span class="hljs-comment">//3.建立文件流</span><br>        FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"beauty.jpg"</span>));<br>        <span class="hljs-comment">//4.写数据</span><br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">int</span> len;<br>        <span class="hljs-keyword">while</span>((len = fis.read(buffer)) != -<span class="hljs-number">1</span>){<br>            os.write(buffer,<span class="hljs-number">0</span>,len);<br>        }<br>        <span class="hljs-comment">//写完数据以后要关闭数据输出流，不然会一直处于阻塞状态</span><br>        socket.shutdownOutput(); <br>        <span class="hljs-comment">//5.接收来自于服务器端的数据，并显示到控制台上</span><br>        InputStream is = socket.getInputStream();<br>        ByteArrayOutputStream baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>        <span class="hljs-keyword">byte</span>[] bufferr = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">20</span>];<br>        <span class="hljs-keyword">int</span> len1;<br>        <span class="hljs-keyword">while</span>((len1 = is.read(buffer)) != -<span class="hljs-number">1</span>){<br>            baos.write(buffer,<span class="hljs-number">0</span>,len1);<br>        }<br><br>        System.out.println(baos.toString());<br>        <span class="hljs-comment">//6.关闭流</span><br>        fis.close();<br>        os.close();<br>        socket.close();<br>        is.close();<br>        baos.close();<br>    }<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">server</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        <span class="hljs-comment">//1.创建ServerSocket对象，设置端口为9090</span><br>        ServerSocket ss = <span class="hljs-keyword">new</span> ServerSocket(<span class="hljs-number">9090</span>);<br>        <span class="hljs-comment">//2.调用accept监听连接请求，连接成功后才会执行下面的代码</span><br>        Socket socket = ss.accept();<br>        <span class="hljs-comment">//3.获取输入流</span><br>        InputStream is = socket.getInputStream();<br>        <span class="hljs-comment">//4.构建节点流</span><br>        FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"beauty2.jpg"</span>));<br>        <span class="hljs-comment">//5.将输入流内容写到文件中</span><br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">int</span> len;<br>        <span class="hljs-keyword">while</span>((len = is.read(buffer)) != -<span class="hljs-number">1</span>){<br>            fos.write(buffer,<span class="hljs-number">0</span>,len);<br>        }<br><br>        System.out.println(<span class="hljs-string">"文件传输完成"</span>);<br>        <span class="hljs-comment">//6.服务器端给予客户端反馈</span><br>        OutputStream os = socket.getOutputStream();<br>        os.write(<span class="hljs-string">"我是服务器，文件已收到"</span>.getBytes());<br><br>        <span class="hljs-comment">//7.关闭连接。这里需要使用try-catch捕获异常。</span><br>        fos.close();<br>        is.close();<br>        socket.close();<br>        ss.close();<br>        os.close();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>应用举例2，客户端向服务器发送信息，服务器返回接受成功，直到输入“exit”断开连接：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Client.java文件</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">package</span> com.atguigu.Exer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.io.OutputStream;<br><span class="hljs-keyword">import</span> java.net.InetAddress;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><span class="hljs-keyword">import</span> java.nio.charset.StandardCharsets;<br><span class="hljs-keyword">import</span> java.util.Scanner;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Client</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-keyword">new</span> Client().start();<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>{<br>        Socket socket = <span class="hljs-keyword">null</span>;<br>        OutputStream os = <span class="hljs-keyword">null</span>;<br>        Scanner sc = <span class="hljs-keyword">null</span>;<br>        ByteArrayOutputStream baos = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {<br>            <span class="hljs-keyword">try</span> {<br>                <span class="hljs-comment">//1.</span><br>                socket = <span class="hljs-keyword">new</span> Socket(InetAddress.getByName(<span class="hljs-string">"127.0.0.1"</span>), <span class="hljs-number">9999</span>);<br>                <span class="hljs-comment">//2.</span><br>                os = socket.getOutputStream();<br>                <span class="hljs-comment">//3.</span><br>                System.out.println(<span class="hljs-string">"Input message："</span>);<br>                sc = <span class="hljs-keyword">new</span> Scanner(System.in);<br>                String message = sc.next();<br>                os.write(message.getBytes(StandardCharsets.UTF_8));<br>                socket.shutdownOutput();<span class="hljs-comment">//写完数据以后要关闭数据输出流</span><br>                <span class="hljs-comment">//接收来自服务器的消息</span><br>                InputStream is = socket.getInputStream();<br><br>                baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>                <span class="hljs-keyword">int</span> len = <span class="hljs-number">0</span>;<br>                <span class="hljs-keyword">while</span> ((len = is.read()) != -<span class="hljs-number">1</span>) {<br>                    baos.write(len);<br>                }<br>                System.out.println(baos.toString());<br><br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">"exit"</span>.equals(message)) <span class="hljs-keyword">break</span>;<br>            } <span class="hljs-keyword">catch</span> (IOException e) {<br>                e.printStackTrace();<br>            } <span class="hljs-keyword">finally</span> {<br>                <span class="hljs-keyword">if</span> (os != <span class="hljs-keyword">null</span>) {<br>                    <span class="hljs-keyword">try</span> {<br>                        os.close();<br>                    } <span class="hljs-keyword">catch</span> (IOException e) {<br>                        e.printStackTrace();<br>                    }<br>                }<br>                <span class="hljs-keyword">if</span> (socket != <span class="hljs-keyword">null</span>) {<br>                    <span class="hljs-keyword">try</span> {<br>                        socket.close();<br>                    } <span class="hljs-keyword">catch</span> (IOException e) {<br>                        e.printStackTrace();<br>                    }<br>                }<br>            }<br>        }<br>    }<br>}<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">Server.java文件</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">package</span> com.atguigu.Exer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><span class="hljs-keyword">import</span> java.net.ServerSocket;<br><span class="hljs-keyword">import</span> java.net.Socket;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Server</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-keyword">new</span> Server().start();<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>{<br>        ServerSocket ss = <span class="hljs-keyword">null</span>;<br>        Socket socket = <span class="hljs-keyword">null</span>;<br>        InputStream is = <span class="hljs-keyword">null</span>;<br>        ByteArrayOutputStream baos = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            ss = <span class="hljs-keyword">new</span> ServerSocket(<span class="hljs-number">9999</span>);<br>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {<br>                socket = ss.accept();<br>                is = socket.getInputStream();<br>                <span class="hljs-keyword">int</span> len = <span class="hljs-number">0</span>;<br>                baos = <span class="hljs-keyword">new</span> ByteArrayOutputStream();<br>                <span class="hljs-keyword">while</span> ((len = is.read()) != -<span class="hljs-number">1</span>) {<br>                    baos.write(len);<br>                }<br>                String message = baos.toString();<br>                System.out.print(<span class="hljs-string">"From "</span> + socket.getInetAddress().getHostName() <br>                                 + <span class="hljs-string">": "</span>);<br>                System.out.println(message);<br>                socket.getOutputStream().write(<br>                    <span class="hljs-string">"-----Message received-----"</span>.getBytes());<br>                socket.shutdownOutput();<span class="hljs-comment">//写完数据以后要关闭数据输出流</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">"exit"</span>.equals(message)) <span class="hljs-keyword">break</span>;<br>            }<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-keyword">if</span> (ss != <span class="hljs-keyword">null</span>) {<br>                <span class="hljs-keyword">try</span> { ss.close(); }<br>                <span class="hljs-keyword">catch</span> (IOException e) { e.printStackTrace(); }<br>            }<br>            <span class="hljs-keyword">if</span> (socket != <span class="hljs-keyword">null</span>) {<br>                <span class="hljs-keyword">try</span> { socket.close(); }<br>                <span class="hljs-keyword">catch</span> (IOException e) { e.printStackTrace(); }<br>            }<br>            <span class="hljs-keyword">if</span> (is != <span class="hljs-keyword">null</span>) {<br>                <span class="hljs-keyword">try</span> { is.close(); }<br>                <span class="hljs-keyword">catch</span> (IOException e) { e.printStackTrace(); }<br>            }<br>            <span class="hljs-keyword">if</span> (baos != <span class="hljs-keyword">null</span>) {<br>                <span class="hljs-keyword">try</span> { baos.close(); }<br>                <span class="hljs-keyword">catch</span> (IOException e) { e.printStackTrace(); }<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、UDP网络编程"><a href="#四、UDP网络编程" class="headerlink" title="四、UDP网络编程"></a>四、UDP网络编程</h1><h2 id="1、UDP通信流程"><a href="#1、UDP通信流程" class="headerlink" title="1、UDP通信流程"></a>1、UDP通信流程</h2><p><strong>UDP连接的套接字函数</strong>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1401_4.png" style="transform:scale(0.8)"></p>
<p>类<code>DatagramSocket</code>和<code>DatagramPacket</code>实现了基于UDP协议网络程序。</p>
<p><code>DatagramSocket</code>，数据报套接字，负责发送和接收UDP数据报(数据包)，系统不保证UDP数据报一定能够安全送到目的地，也不能确定什么时候可以抵达。</p>
<p><code>DatagramPacket</code>对象封装了UDP数据报(数据包)，在数据报中包含了发送端的IP地址和端口号以及接收端的IP地址和端口号。</p>
<p>UDP协议中每个数据报都给出了完整的地址信息，因此无须建立发送方和接收方的连接。如同发快递包裹一样。</p>
<p><strong>DatagramSocket类的常用方法</strong>：</p>
<ul>
<li><code>public DatagramSocket(int port)</code>：创建数据报套接字并将其绑定到本地主机上的指定端口。套接字将被绑定到通配符地址，IP地址由内核来选择。</li>
<li><code>public DatagramSocket(int port,InetAddress laddr)</code>：创建数据报套接字，将其绑定到指定的本地地址。本地端口必须在0到65535之间（包括两者）。如果IP地址为0.0.0.0，套接字将被绑定到通配符地址，IP地址由内核选择。</li>
<li><code>public void close()</code>：关闭此数据报套接字。</li>
<li><code>public void send(DatagramPacket p)</code>：从此套接字发送数据报包。DatagramPacket包含的信息指示：将要发送的数据、其长度、远程主机的IP地址和远程主机的端口号。</li>
<li><code>public void receive(DatagramPacket p)</code>：从此套接字接收数据报包。当此方法返回时，DatagramPacket的缓冲区填充了接收的数据。数据报包也包含发送方的IP地址和发送方机器上的端口号。此方法在接收到数据报前一直阻塞。数据报包对象的length字段包含所接收信息的长度。如果信息比包的长度长，该信息将被截短。</li>
<li><code>public InetAddress getLocalAddress()</code>：获取套接字绑定的本地地址。</li>
<li><code>public int getLocalPort()</code>：返回此套接字绑定的本地主机上的端口号。</li>
<li><code>public InetAddress getInetAddress()</code>：返回此套接字连接的地址。如果套接字未连接，则返回null。</li>
<li><code>public int getPort()</code>：返回此套接字的端口。如果套接字未连接，则返回-1。</li>
</ul>
<p><strong>DatagramPacket类的常用方法</strong>：</p>
<ul>
<li><code>public DatagramPacket(byte[] buf,int length)</code>：构造DatagramPacket，用来接收长度为length的数据包。length参数必须小于等于buf.length。</li>
<li><code>public DatagramPacket(byte[] buf,int length,InetAddress address,int port)</code>：构造数据报包，用来将长度为length的包发送到指定主机上的指定端口号。length参数必须小于等于buf.length。</li>
<li><code>public InetAddress getAddress()</code>：返回某台机器的IP地址，此数据报将要发往该机器或者是从该机器接收到的。</li>
<li><code>public int getPort()</code>：返回某台远程主机的端口号，此数据报将要发往该主机或者是从该主机接收到的。</li>
<li><code>public byte[] getData()</code>：返回数据缓冲区。接收到的或将要发送的数据从缓冲区中的偏移量offset处开始，持续length长度。</li>
<li><code>public int getLength()</code>：返回将要发送或接收到的数据的长度。</li>
</ul>
<p><strong>UDP网络通信步骤</strong>：</p>
<p>由于UDP通信不需要建立连接，因此客户端和服务端步骤相同。</p>
<ul>
<li>使用DatagramSocket创建socket。</li>
<li>使用DatagramPacket建立数据包，将要发送/接收的数据、IP地址、端口号封装到数据包中。</li>
<li>调用socket的发送、接收方法。</li>
<li>关闭socket。</li>
</ul>
<h2 id="2、UDP网络编程案例"><a href="#2、UDP网络编程案例" class="headerlink" title="2、UDP网络编程案例"></a>2、UDP网络编程案例</h2><p>应用实例，发送端向接收端发送信息：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UDPTest</span> </span>{<br><br>    <span class="hljs-comment">//发送端</span><br>    <span class="hljs-meta">@Test</span>  <span class="hljs-comment">//为了看着简洁，使用throws处理异常。正确方式是try-catch</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sender</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        <span class="hljs-comment">//1.创建数据包套接字对象</span><br>        DatagramSocket socket = <span class="hljs-keyword">new</span> DatagramSocket();<br>        String str = <span class="hljs-string">"我是UDP发送端"</span>;<br>        <span class="hljs-keyword">byte</span>[] data = str.getBytes();<br>        InetAddress inet = InetAddress.getLocalHost();<br>        <span class="hljs-comment">//2.将要发送的数据以及IP和端口号封装到数据包中</span><br>        DatagramPacket packet = <span class="hljs-keyword">new</span> DatagramPacket(data,<span class="hljs-number">0</span>,data.length,inet,<span class="hljs-number">9090</span>);<br>        <span class="hljs-comment">//3.发送数据</span><br>        socket.send(packet);<br>        <span class="hljs-comment">//4.关闭socket，这里同样应该使用try-catch处理异常。</span><br>        socket.close();<br>    }<br>    <span class="hljs-comment">//接收端</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiver</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        DatagramSocket socket = <span class="hljs-keyword">new</span> DatagramSocket(<span class="hljs-number">9090</span>);<br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">100</span>];<br>        DatagramPacket packet = <span class="hljs-keyword">new</span> DatagramPacket(buffer,<span class="hljs-number">0</span>,buffer.length);<br>        <span class="hljs-comment">//将接收的数据存入数据包</span><br>        socket.receive(packet);<br>        System.out.println(<span class="hljs-keyword">new</span> String(packet.getData(),<span class="hljs-number">0</span>,packet.getLength()));<br>        socket.close();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、URL编程"><a href="#五、URL编程" class="headerlink" title="五、URL编程"></a>五、URL编程</h1><h2 id="1、URL介绍"><a href="#1、URL介绍" class="headerlink" title="1、URL介绍"></a>1、URL介绍</h2><p><strong>URL（Uniform Resource Locator）</strong>：统一资源定位符，表示Internet上某一资源的地址。</p>
<p>通过url可以访问Internet上的各种网络资源，浏览器通过解析给定的url，在网络上查找相应的文件或其他资源。</p>
<p>URL基本结构有5部分：<code>&lt;传输协议&gt;://&lt;主机名&gt;:&lt;端口号&gt;/&lt;文件名&gt;#片段名?参数列表</code>。</p>
<p>例如：<code>http://127.0.0.1:8080/helloworld/index.jsp#a?username=admin&amp;password=123</code></p>
<blockquote>
<p><strong>#片段名</strong>：即锚点，例如小说定位到章节。</p>
<p><strong>参数列表格式</strong>：参数名=参数值&amp;参数名=参数值…</p>
</blockquote>
<h2 id="2、URL类"><a href="#2、URL类" class="headerlink" title="2、URL类"></a>2、URL类</h2><p><code>java.net.URL</code>类用于表示URL，其有四种构造器：</p>
<ul>
<li><code>public URL (String spec)</code>：通过一个表示URL地址的字符串可以构造一个URL对象。<ul>
<li>例如：<code>URL url= new URL ("http://www.baidu.com/");</code></li>
</ul>
</li>
<li><code>public URL(URL context, String spec)</code>：通过基URL和相对URL构造一个URL对象。<ul>
<li>例如：<code>URL downloadUrl= new URL(url, “download.html");</code></li>
</ul>
</li>
<li><code>public URL(String protocol, String host, String file)</code><ul>
<li>例如：<code>newURL("http","www.baidu.com",“download.html");</code></li>
</ul>
</li>
<li><code>public URL(String protocol, String host,intport, String file);</code><ul>
<li>例如:<code>URL gamelan = newURL("http","www.baidu.com", 80,“download.html");</code></li>
</ul>
</li>
</ul>
<blockquote>
<p>URL类的构造器都声明抛出非运行时异常，必须对这种异常进行处理，通常使用try-catch语句捕获。</p>
</blockquote>
<p><strong>URL类的常用方法</strong>：</p>
<ul>
<li><code>public String getProtocol()</code>：获取该URL的协议名</li>
<li><code>public String getHost()</code>：获取该URL的主机名</li>
<li><code>public String getPort()</code>：获取该URL的端口号</li>
<li><code>public String getPath()</code>：获取该URL的文件路径</li>
<li><code>public String getFile()</code>：获取该URL的文件名</li>
<li><code>publicString getQuery()</code>：获取该URL的查询名</li>
</ul>
<h2 id="3、URL编程"><a href="#3、URL编程" class="headerlink" title="3、URL编程"></a>3、URL编程</h2><p>URL的方法<code>openStream()</code>能从网络上读取数据。</p>
<p>若希望输出数据，例如向服务器端的CGI（公共网关接口-Common GatewayInterface-的简称，是用户浏览器和服务器端的应用程序进行连接的接口）程序发送一些数据，则必须先与URL建立连接，然后才能对其进行读写，此时需要使用<code>URLConnection</code>类。</p>
<p><code>URLConnection</code>是抽象类，<code>HttpURLConnection</code>抽象类继承了<code>URLConnection</code>，<code>HttpsURLConnectionImpl</code>继承了<code>HttpURLConnection</code>抽象类。</p>
<p><code>URLConnection</code>表示到URL所引用的远程对象的连接。当与一个URL建立连接时，首先要在一个URL对象上通过方法<code>openConnection()</code>生成对应的<code>URLConnection</code>对象。如果连接过程失败，将产生IOException.</p>
<ul>
<li><code>URL url = new URL ("http://www.baidu.com/index.html");</code></li>
<li><code>URLConnectonn u = url.openConnection( );</code></li>
</ul>
<p>通过<code>URLConnection</code>对象获取的输入流和输出流，可以与现有的CGI程序进行交互。</p>
<ul>
<li><code>public Object getContent() throws IOException</code></li>
<li><code>public int getContentLength( )</code></li>
<li><code>public String getContentType( )</code></li>
<li><code>public long getDate( )</code></li>
<li><code>public long getLastModified( )</code></li>
<li><code>public InputStream getInputStream( ) throws IOException</code></li>
<li><code>public OutputSteram getOutputStream( ) throws IOException</code></li>
</ul>
<p>应用实例，使用URL编程下载网络资源文件：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">URLTest1</span> </span>{<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br><br>        HttpURLConnection urlConnection = <span class="hljs-keyword">null</span>;<br>        InputStream is = <span class="hljs-keyword">null</span>;<br>        FileOutputStream fos = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">//1.构造URL对象</span><br>            URL url = <span class="hljs-keyword">new</span> URL(<span class="hljs-string">"https://www.baidu.com/img/</span><br><span class="hljs-string">                              PCtm_d9c8750bed0b3c7d089fa7d55720d6cf.png"</span>);<br>            <span class="hljs-comment">//2.生成URLConnection对象，其实是HttpsURLConnectionImpl对象</span><br>            urlConnection = (HttpURLConnection) url.openConnection();<br>            <span class="hljs-comment">//3.建立连接</span><br>            urlConnection.connect();<br>            <span class="hljs-comment">//4.获取并下载资源</span><br>            is = urlConnection.getInputStream();<br>            fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">"D:\\BaiduLogo.jpg"</span>);<br>                            <br>            <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-keyword">int</span> len;<br>            <span class="hljs-keyword">while</span>((len = is.read(buffer)) != -<span class="hljs-number">1</span>){<br>                fos.write(buffer,<span class="hljs-number">0</span>,len);<br>            }<br>            System.out.println(<span class="hljs-string">"下载完成"</span>);<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-comment">//5.关闭资源</span><br>            <span class="hljs-keyword">if</span>(is != <span class="hljs-keyword">null</span>){<br>                <span class="hljs-keyword">try</span> {is.close();} <br>                <span class="hljs-keyword">catch</span> (IOException e) {e.printStackTrace();}<br>            }<br>            <span class="hljs-keyword">if</span>(fos != <span class="hljs-keyword">null</span>){<br>                <span class="hljs-keyword">try</span> {fos.close();} <br>                <span class="hljs-keyword">catch</span> (IOException e) {e.printStackTrace();}<br>            }<br>            <span class="hljs-keyword">if</span>(urlConnection != <span class="hljs-keyword">null</span>){urlConnection.disconnect();}<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、URI、URL和URN的区别"><a href="#4、URI、URL和URN的区别" class="headerlink" title="4、URI、URL和URN的区别"></a>4、URI、URL和URN的区别</h2><p><strong>URI(uniform resource identifier)</strong>，统一资源标识符，用来唯一的标识一个资源。</p>
<p><strong>URL(uniform resource locator)</strong>，统一资源定位符，它是一种具体的URI，即URL可以用来标识一个资源，而且还指明了如何locate这个资源。</p>
<p><strong>URN(uniform resource name)</strong>，统一资源命名，通过名字来标识资源，比如<code>mailto:java-net@java.sun.com</code>。</p>
<p>也就是说，URI是以一种抽象的，高层次概念定义统一资源标识，而<strong>URL和URN则是具体的资源标识的方式，URL和URN都是一种URI</strong>。</p>
<p>在Java的URI中，一个URI实例可以代表绝对的，也可以是相对的，只要符合URI语法规则即可。而URL类不仅符合语义，还包含了定位该资源的信息，因此它不能是相对的。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记15-反射</title>
    <url>/2021/04/18/java-note-1501/</url>
    <content><![CDATA[<h1 id="一、Java反射机制概述"><a href="#一、Java反射机制概述" class="headerlink" title="一、Java反射机制概述"></a>一、Java反射机制概述</h1><p><strong>Reflection(反射)</strong>是被视为动态语言的关键，反射机制允许程序在执行期间借助于Reflection API取得任何类的内部信息，并能直接操作任意对象的内部属性及方法。</p>
<p>类加载完之后，在堆内存的方法区中产生了一个Class类型的对象（一个类只有一个Class对象），这个对象包含了完整的类的结构信息。可以通过这个对象看到类的结构。</p>
<p>反射就是通过实例化对象反向得到其所属类的全部信息：实例化对象—&gt;getClass()方法—&gt;得到完整的“包类”名称。</p>
<p><strong>动态语言与静态语言</strong></p>
<p>动态语言是运行时可以改变结构的语言，例如新的函数、对象等，主要有：C#、JavaScript、PHP、Python、Erlang等。</p>
<p>静态语言是运行时结构不可变的语言，比如Java、C、C++</p>
<p>Java虽然不是动态语言，但是可以使用反射机制、字节码操作获得类似动态语言的特性。</p>
<h1 id="二、理解Class类并获取Class实例"><a href="#二、理解Class类并获取Class实例" class="headerlink" title="二、理解Class类并获取Class实例"></a>二、理解Class类并获取Class实例</h1><h2 id="1、Class类"><a href="#1、Class类" class="headerlink" title="1、Class类"></a>1、Class类</h2><p>在Object类中定义了如下方法，此方法被所有子类继承：</p>
<p><code>public final Class getClass()</code></p>
<p>返回值是Class类型，<strong>Class类是用来描述类的类</strong>，此类是Java反射的源头，也就是说可以通过反射求出类的名称。</p>
<p>程序经过javac.exe命令以后，会生成一个或多个字节码文件(.class结尾)。使用java.exe命令对某个字节码文件进行解释运行。相当于将某个字节码文件加载到内存中。此过程就称为<strong>类的加载</strong>。加载到内存中的类，称为<strong>运行时类</strong>，此运行时类，就作为Class的一个<strong>实例</strong>。</p>
<p>加载到内存中的运行时类，会缓存一定的时间。在此时间之内，可以通过不同的方式来获取此运行时类。</p>
<p>对于每个类而言，JRE都为其保留一个不变的<strong>Class类型</strong>的对象。一个Class对象包含了特定某个结构<code>(class/interface/enum/annotation/primitive type/void/[])</code>的有关信息。</p>
<ul>
<li>Class本身也是一个类。</li>
<li>Class对象只能由系统建立对象。</li>
<li>一个加载的类在JVM中只会有一个Class实例，Class的实例就对应着一个运行时类。</li>
<li>一个Class对象对应的是一个加载到JVM中的一个.class文件。</li>
<li>每个类的实例都会记得自己是由哪个Class实例所生成。</li>
<li>通过Class可以完整地得到一个类中的所有被加载的结构。</li>
<li>Class类是Reflection的根源，任何想动态加载、运行的类，必须先获得相应的Class对象。</li>
</ul>
<h2 id="2、获取Class类实例"><a href="#2、获取Class类实例" class="headerlink" title="2、获取Class类实例"></a>2、获取Class类实例</h2><p>Class对象只能由系统创建，我们四种方式获取此实例，以String类为例：</p>
<ul>
<li>通过类的<code>class属性</code>获取，前提是已知具体的类。此方法最安全可靠，程序性能最高：<ul>
<li><code>Class clazz = String.class;</code></li>
</ul>
</li>
<li>调用实例的<code>getClass()方法</code>，前提是已知当前类的实例：<ul>
<li><code>Class clazz = "hello".getClass();</code></li>
</ul>
</li>
<li>使用Class类的静态方法<code>forName()</code>获取，前提是已知一个类的全类名。可能抛出<code>ClassNotFoundException</code>异常：<ul>
<li><code>Class clazz = Class.forName("java.lang.String");</code></li>
</ul>
</li>
<li>其他方式：<ul>
<li><code>ClassLoader cl = this.getClass().getClassLoader();</code></li>
<li><code>Class clazz = cl.loadClass("java.lang.String");</code></li>
</ul>
</li>
</ul>
<p><strong>哪些类可以有Class对象？</strong></p>
<ul>
<li><code>class</code>：类，外部类，成员类（成员内部类、静态内部类），局部内部类，匿名内部类。</li>
<li><code>interface</code>：接口</li>
<li><code>[]</code>：数组</li>
<li><code>enum</code>：枚举类</li>
<li><code>annotation</code>：注解@interface</li>
<li><code>primitive type</code>：基本数据类型</li>
<li><code>void</code></li>
</ul>
<h1 id="三、类的加载与ClassLoader的理解"><a href="#三、类的加载与ClassLoader的理解" class="headerlink" title="三、类的加载与ClassLoader的理解"></a>三、类的加载与ClassLoader的理解</h1><h2 id="1、类的加载过程"><a href="#1、类的加载过程" class="headerlink" title="1、类的加载过程"></a>1、类的加载过程</h2><p>程序使用某个类时，如果该类没有加载到内存中，会通过以下三个主要步骤对类初始化：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1501_1.png"></p>
<ul>
<li><strong>加载</strong>：将class文件字节码内容加载到内存中，并将这些静态数据转换成方法区的运行时数据结构，然后<strong>生成一个代表这个类的java.lang.Class对象</strong>，作为方法区中类数据的访问入口（即引用地址）。所有需要访问和使用类数据只能通过这个Class对象。这个加载的过程需要<strong>类加载器</strong>参与。</li>
<li><strong>链接</strong>：将Java类的二进制代码合并到JVM的运行状态之中的过程。包括三个阶段：<ul>
<li><strong>验证</strong>：确保加载的类信息符合JVM规范，例如：以cafe开头，没有安全方面的问题</li>
<li><strong>准备</strong>：正式为类变量（static）分配内存并设置类变量默认初始值的阶段，这些内存都将在方法区中进行分配。</li>
<li><strong>解析</strong>：虚拟机常量池内的符号引用（常量名）替换为直接引用（地址）的过程。</li>
</ul>
</li>
<li><strong>初始化</strong>：执行行类构造器<code>&lt;clinit&gt;()</code>方法的过程。类构造器<code>&lt;clinit&gt;()</code>方法是由编译期自动收集类中所有类变量的赋值动作和静态代码块中的语句合并产生的（类构造器是构造类信息的，不是构造该类对象的构造器）。当初始化一个类的时候，如果发现其父类还没有进行初始化，则需要先触发其父类的初始化。虚拟机会保证一个类的<code>&lt;clinit&gt;()</code>方法在多线程环境中被正确加锁和同步。</li>
</ul>
<p><strong>什么时候会发生类初始化?</strong></p>
<p>详细可参考《深入理解Java虚拟机 第3版》第7章 虚拟机类加载机制。</p>
<p><strong>类的主动引用（一定会发生类的初始化）</strong>:</p>
<ul>
<li>当虚拟机启动，先初始化main方法所在的类</li>
<li>new一个类的对象</li>
<li>调用类的静态成员（除了final常量）和静态方法</li>
<li>使用java.lang.reflect包的方法对类进行反射调用</li>
<li>当初始化一个类，如果其父类没有被初始化，则先会初始化它的父类</li>
</ul>
<p><strong>类的被动引用（不会发生类的初始化）</strong>：</p>
<ul>
<li>当访问一个静态域时，只有真正声明这个域的类才会被初始化</li>
<li>当通过子类引用父类的静态变量，不会导致子类初始化</li>
<li>通过数组定义某个类的引用，不会触发此类的初始化</li>
<li>引用常量不会触发此类的初始化（常量在链接阶段就存入调用类的常量池中了）</li>
</ul>
<h2 id="2、类加载器"><a href="#2、类加载器" class="headerlink" title="2、类加载器"></a>2、类加载器</h2><p><strong>类加载器</strong>的作用：在加载阶段，类加载器将class文件字节码内容加载到内存中，并将这些静态数据转换成方法区的运行时数据结构然后在堆中生成一个代表这个类的java.lang.Class对象，作为方法区中类数据的访问入口。<br><strong>类缓存</strong>：标准的JavaSE类加载器可以按要求查找类，但一旦某个类被加载到类加载器中，它将维持加载（缓存）一段时间。不过JVM垃圾回收机制可以回收这些Class对象。</p>
<p>JVM规范定义了如下类型的类加载器：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1501_2.png"></p>
<p>引导类加载器用来装载核心类库，无法直接获取。</p>
<p>代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoaderTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//对于自定义类，使用系统类加载器进行加载</span><br>        ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();<br>        System.out.println(classLoader);<br>        <span class="hljs-comment">//jdk.internal.loader.ClassLoaders$AppClassLoader@2f0e140b</span><br><br>        <span class="hljs-comment">//调用系统类加载器的getParent()：获取扩展类加载器</span><br>        ClassLoader classLoader1 = classLoader.getParent();<br>        System.out.println(classLoader1); <br>        <span class="hljs-comment">//jdk.internal.loader.ClassLoaders$PlatformClassLoader@2aaf7cc2</span><br><br>        <span class="hljs-comment">//调用扩展类加载器的getParent()：无法获取引导类加载器</span><br>        <span class="hljs-comment">//引导类加载器主要负责加载java的核心类库，无法加载自定义类。</span><br>        ClassLoader classLoader2 = classLoader1.getParent();<br>        System.out.println(classLoader2); <span class="hljs-comment">//null</span><br>        ClassLoader classLoader3 = String.class.getClassLoader();<br>        System.out.println(classLoader3); <span class="hljs-comment">//null。核心类</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>类加载器的<code>getResourceAsStream(String str)</code>方法可以用来获取类路径下指定文件的输入流，可以用来加载properties配置文件：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ClassLoaderTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        Properties pros =  <span class="hljs-keyword">new</span> Properties();<br>        <span class="hljs-comment">//此时的文件默认在当前的module下。</span><br>        <span class="hljs-comment">//读取配置文件的方式一：</span><br>        <span class="hljs-comment">//FileInputStream fis = new FileInputStream("jdbc.properties");</span><br>        <span class="hljs-comment">//FileInputStream fis = new FileInputStream("src\\jdbc1.properties");</span><br>        <span class="hljs-comment">//pros.load(fis);</span><br><br>        <span class="hljs-comment">//读取配置文件的方式二：使用ClassLoader</span><br>        <span class="hljs-comment">//配置文件默认识别为：当前module的src下</span><br>        ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();<br>        InputStream is = classLoader.getResourceAsStream(<span class="hljs-string">"jdbc1.properties"</span>);<br>        pros.load(is);<br><br>        String user = pros.getProperty(<span class="hljs-string">"user"</span>);<br>        String password = pros.getProperty(<span class="hljs-string">"password"</span>);<br>        System.out.println(<span class="hljs-string">"user = "</span> + user + <span class="hljs-string">",password = "</span> + password);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、创建运行时类的对象"><a href="#四、创建运行时类的对象" class="headerlink" title="四、创建运行时类的对象"></a>四、创建运行时类的对象</h1><p>获得了Class对象以后，可以创建运行时类的对象。</p>
<p>有两种方法创建运行时类对象：</p>
<ul>
<li>调用Class对象的<code>newInstance()</code>方法。使用此方法有两个要求：<ul>
<li>要求运行时类必须有一个无参数的构造器。</li>
<li>要求运行时类的构造器的访问权限需要足够，一般为public</li>
</ul>
</li>
<li>调用Class对象的<code>getDeclaredConstructor(Class&lt;?&gt;... parameterTypes)</code>，参数就是运行时类对应构造器的参数，返回<code>Constructor</code>类对象，<code>Constructor</code>类中也有<code>newInstance()</code>方法，可以构造运行时类对象。这种方法不要求运行时类必须有无参构造器。</li>
</ul>
<p>代码实例，通过反射，创建运行时类对象：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NewInstanceTest</span> </span>{<br>    <span class="hljs-comment">//反射的动态性</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;i &lt; <span class="hljs-number">10</span>;i++){<br>            <span class="hljs-keyword">int</span> num = <span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">2</span>);<span class="hljs-comment">//0,1</span><br>            String classPath = <span class="hljs-string">""</span>;<br>            <span class="hljs-comment">//只有在运行时才知道具体的类</span><br>            <span class="hljs-keyword">switch</span>(num){<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>                    classPath = <span class="hljs-string">"java.util.Date"</span>;<br>                    <span class="hljs-keyword">break</span>;<br>                <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>                    classPath = <span class="hljs-string">"java.lang.Object"</span>;<br>                    <span class="hljs-keyword">break</span>;<br>            }<br>            <span class="hljs-keyword">try</span> {<br>                Object obj = getInstance(classPath);<br>                System.out.println(obj);<br>            } <span class="hljs-keyword">catch</span> (Exception e) {e.printStackTrace();}<br>        }<br>    }<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    创建一个指定类的对象。</span><br><span class="hljs-comment">    classPath:指定类的全类名</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">getInstance</span><span class="hljs-params">(String classPath)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>       Class clazz =  Class.forName(classPath);<br>       <span class="hljs-keyword">return</span> clazz.newInstance();<span class="hljs-comment">//方式一</span><br>        <span class="hljs-comment">//方式二</span><br>       <span class="hljs-comment">//return clazz.getDeclaredConstructor().newInstance();</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上述代码，体现了<strong>反射的动态性，运行时动态创建指定类的对象</strong>，这是反射机制应用最多的地方。</p>
<h1 id="五、获取运行时类的完整结构"><a href="#五、获取运行时类的完整结构" class="headerlink" title="五、获取运行时类的完整结构"></a>五、获取运行时类的完整结构</h1><p>通过反射不仅可以创建运行时类的对象，还可以获取运行时类的完整结构，包括以下所有结构，这些操作都是基于Class类，使用Class类对象调用Class类的相关方法：</p>
<ul>
<li>运行时类实现的全部接口</li>
<li>所继承的父类</li>
<li>全部的构造器</li>
<li>全部的方法</li>
<li>全部的Field</li>
</ul>
<h2 id="1、获取运行时类实现的接口"><a href="#1、获取运行时类实现的接口" class="headerlink" title="1、获取运行时类实现的接口"></a>1、获取运行时类实现的接口</h2><p>调用<code>public Class&lt;?&gt;[]getInterfaces()</code>方法获取运行时类实现的所有接口。</p>
<h2 id="2、获取运行时类继承的父类"><a href="#2、获取运行时类继承的父类" class="headerlink" title="2、获取运行时类继承的父类"></a>2、获取运行时类继承的父类</h2><p>调用<code>public Class&lt;? Super T&gt;getSuperclass()</code>返回此Class所表示的实体（类、接口、基本类型）的父类的Class。</p>
<h2 id="3、获取运行时类的构造器"><a href="#3、获取运行时类的构造器" class="headerlink" title="3、获取运行时类的构造器"></a>3、获取运行时类的构造器</h2><p>获取运行时类的构造器：</p>
<ul>
<li><code>public Constructor&lt;T&gt;[] getConstructors()</code>：返回此Class对象所表示的类的所有public构造方法。</li>
<li><code>public Constructor&lt;T&gt;[] getDeclaredConstructors()</code>：返回此Class对象表示的类声明的所有构造方法。</li>
</ul>
<p>返回的<code>Constructor</code>类，有以下方法：</p>
<ul>
<li><code>public int getModifiers()</code>：取得修饰符:</li>
<li><code>public StringgetName()</code>：取得方法名称:</li>
<li><code>public Class&lt;?&gt;[] getParameterTypes()</code>：取得参数的类型</li>
<li><code>public T newInstance(Object ... initargs)</code>：构建运行时类的实例</li>
</ul>
<h2 id="4、获取运行时类的方法"><a href="#4、获取运行时类的方法" class="headerlink" title="4、获取运行时类的方法"></a>4、获取运行时类的方法</h2><p>获取运行时类的方法：</p>
<ul>
<li><code>public Method[] getDeclaredMethods()</code>：返回此Class对象所表示的类或接口的全部方法</li>
<li><code>public Method[] getMethods()</code>：返回此Class对象所表示的类或接口的public的方法</li>
</ul>
<p>返回的<code>Method</code>类中有以下方法：</p>
<ul>
<li><code>public Class&lt;?&gt; getReturnType()</code>：取得全部的返回值</li>
<li><code>public Class&lt;?&gt;[] getParameterTypes()</code>：取得全部的参数</li>
<li><code>public int getModifiers()</code>：取得修饰符</li>
<li><code>public Class&lt;?&gt;[] getExceptionTypes()</code>：取得异常信息</li>
</ul>
<h2 id="5、获取运行时类的Field"><a href="#5、获取运行时类的Field" class="headerlink" title="5、获取运行时类的Field"></a>5、获取运行时类的Field</h2><p>获取Field：</p>
<ul>
<li><code>public Field[] getFields()</code>：返回此Class对象所表示的类或接口的public的Field。</li>
<li><code>public Field[] getDeclaredFields()</code>：返回此Class对象所表示的类或接口的全部Field。</li>
</ul>
<p>返回的<code>Field</code>类中有以下方法：</p>
<ul>
<li><code>public int getModifiers()</code>：以整数形式返回此Field的修饰符</li>
<li><code>public Class&lt;?&gt; getType()</code>：得到Field的属性类型</li>
<li><code>public String getName()</code>：返回Field的名称。</li>
</ul>
<h2 id="6、获取运行时类其他结构"><a href="#6、获取运行时类其他结构" class="headerlink" title="6、获取运行时类其他结构"></a>6、获取运行时类其他结构</h2><p><strong>获取注解相关内容</strong></p>
<ul>
<li><code>public &lt;A extends Annotation&gt; A getAnnotation(Class&lt;T&gt; annotationClass)</code></li>
<li><code>public &lt;A extends Annotation&gt; A getDeclaredAnnotation(Class&lt;A&gt; annotationClass)</code></li>
</ul>
<p><strong>泛型相关</strong></p>
<ul>
<li><code>public Type getGenericSuperclass()</code>：获取父类泛型类型</li>
<li><code>ParameterizedType</code>：泛型类型，继承了Type接口。<code>ParameterizedTypeImpl</code>类实现了此接口。</li>
<li><code>getActualTypeArguments()</code>：<code>ParameterizedType</code>中定义的<code>Type[]</code>类型数组，用于获取实际的泛型类型参数数组</li>
</ul>
<p><strong>类所在的包</strong></p>
<ul>
<li><code>public Package getPackage()</code></li>
</ul>
<h1 id="六、调用运行时类的指定结构"><a href="#六、调用运行时类的指定结构" class="headerlink" title="六、调用运行时类的指定结构"></a>六、调用运行时类的指定结构</h1><p>使用反射获取不仅可以一次获取所有的结构，也可以获取指定的某个结构，然后调用此结构。</p>
<h2 id="1、调用指定方法"><a href="#1、调用指定方法" class="headerlink" title="1、调用指定方法"></a>1、调用指定方法</h2><p>可以使用反射获取指定的方法，并调用此方法。步骤如下：</p>
<ul>
<li><code>getMethod(Stringname,Class…parameterTypes)</code>方法取得指定的Method对象，并设置此方法操作时所需要的参数类型。</li>
<li>使用<code>Object invoke(Objectobj, Object[]args)</code>进行调用，并向方法中传递要设置的obj对象的参数信息。</li>
</ul>
<blockquote>
<p>invoke方法的说明：</p>
<ol>
<li>Object对应原方法的返回值，若原方法无返回值，此时返回null</li>
<li>若原方法若为静态方法，此时形参Object obj可为null</li>
<li>若原方法形参列表为空，则Object[] args为null</li>
<li>若原方法声明为private,则需要在调用此invoke()方法前，显式调用方法对象的setAccessible(true)方法，设置可见性，然后即可访问private的方法。</li>
</ol>
</blockquote>
<p>代码实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReflectionTest</span></span>{<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    Person类中有非静态方法show，和静态方法showDesc()</span><br><span class="hljs-comment">    private static void showDesc()</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testMethod</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        Class clazz = Person.class;<br>        <span class="hljs-comment">//创建运行时类的对象</span><br>        Person p = (Person) clazz.newInstance();<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        1.获取指定的某个方法</span><br><span class="hljs-comment">        getDeclaredMethod():</span><br><span class="hljs-comment">        参数1：指明获取的方法的名称  </span><br><span class="hljs-comment">        参数2：指明获取的方法的形参列表</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//获取Person类中的show方法</span><br>        Method show = clazz.getDeclaredMethod(<span class="hljs-string">"show"</span>, String.class);<br>        <span class="hljs-comment">//2.保证当前方法是可访问的</span><br>        show.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        3. 调用方法的invoke()方法:</span><br><span class="hljs-comment">        参数1：方法的调用者，指明是哪个对象的方法  </span><br><span class="hljs-comment">        参数2：给方法形参赋值的实参</span><br><span class="hljs-comment">        invoke()的返回值即为对应类中调用的方法的返回值。</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-comment">//类似于String nation = p.show("CHN");</span><br>        Object returnValue = show.invoke(p,<span class="hljs-string">"CHN"</span>); <br>        System.out.println(returnValue);<br>        <br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        调用静态方法</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-comment">//调用showDesc方法</span><br>        Method showDesc = clazz.getDeclaredMethod(<span class="hljs-string">"showDesc"</span>);<br>        showDesc.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">//如果调用的运行时类中的方法没有返回值，则此invoke()返回null</span><br>        Object returnVal = showDesc.invoke(Person.class);<br>        <span class="hljs-comment">//这两种写法都可以，参数为空即可，不需要指明对象，</span><br>        <span class="hljs-comment">//因为静态方法不需要通过对象调用，类中的静态方法是已知的。</span><br>        <span class="hljs-comment">//Object returnVal2 = showDesc.invoke(clazz);</span><br>        <span class="hljs-comment">//Object returnVal3 = showDesc.invoke(null);</span><br>        System.out.println(returnVal);<span class="hljs-comment">//null</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、调用指定属性"><a href="#2、调用指定属性" class="headerlink" title="2、调用指定属性"></a>2、调用指定属性</h2><p>同样，反射机制可以调用指定的某个属性，并且可以直接通过Field类操作类中的属性，通过Field类提供的set()和get()方法就可以完成设置和取得属性内容的操作。</p>
<p><strong>获取指定属性</strong> ：</p>
<ul>
<li><code>public Field getField(String name)</code>：返回此Class对象表示的类或接口的指定的public的Field。</li>
<li><code>public Field getDeclaredField(String name)</code>：返回此Class对象表示的类或接口的指定的Field。</li>
</ul>
<p><strong>Field中的方法</strong>：</p>
<ul>
<li><code>public Object get(Object obj)</code>：取得指定对象obj上此Field的属性内容</li>
<li><code>public void set(Object obj,Object value)</code>：设置指定对象obj上此Field的属性内容</li>
</ul>
<p>代码实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReflectionTes</span></span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testField1</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        <span class="hljs-comment">//创建Class类实例</span><br>        Class clazz = Person.class;<br>        <span class="hljs-comment">//创建运行时类的对象</span><br>        Person p = (Person) clazz.newInstance();<br>        <span class="hljs-comment">//1. 获取运行时类中指定变量名的属性，获取Person中的name属性</span><br>        Field name = clazz.getDeclaredField(<span class="hljs-string">"name"</span>);<br>        <span class="hljs-comment">//2.保证当前属性是可访问的</span><br>        name.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">//3.获取、设置对象p的name属性值为“Tom”</span><br>        name.set(p,<span class="hljs-string">"Tom"</span>);<br>        System.out.println(name.get(p));  <span class="hljs-comment">// Tom</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、调用指定构造器"><a href="#3、调用指定构造器" class="headerlink" title="3、调用指定构造器"></a>3、调用指定构造器</h2><p>通过反射获取指定的构造器，也可以创建运行时类的对象。</p>
<p><strong>获取指定构造器</strong>：</p>
<ul>
<li><code>public Constructor&lt;T&gt; getConstructor(Class&lt;?&gt;... parameterTypes)</code>：获取public的参数类型为指定类型的构造器。</li>
<li><code>public Constructor&lt;T&gt; getDeclaredConstructor(Class&lt;?&gt;... parameterTypes)</code>：获取运行时类声明的<strong>参数类型为指定参数</strong>的构造器，</li>
</ul>
<p>代码实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReflectionTest</span></span>{<br>    <span class="hljs-comment">//Person类中有以下构造器</span><br>    <span class="hljs-comment">//private Person(String name)</span><br>     <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testConstructor</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        Class clazz = Person.class;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        1.获取指定的构造器</span><br><span class="hljs-comment">        getDeclaredConstructor():参数：指明构造器的参数列表</span><br><span class="hljs-comment">         */</span><br>        Constructor constructor = clazz.getDeclaredConstructor(String.class);<br>        <span class="hljs-comment">//2.保证此构造器是可访问的</span><br>        constructor.setAccessible(<span class="hljs-keyword">true</span>);<br>        <span class="hljs-comment">//3.调用此构造器创建运行时类的对象</span><br>        Person per = (Person) constructor.newInstance(<span class="hljs-string">"Tom"</span>);<br>        System.out.println(per);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>关于setAccessible方法的说明</strong></p>
<p><code>Method</code>和<code>Field</code>、<code>Constructor</code>对象都有<code>setAccessible()</code>方法。</p>
<p><code>setAccessible</code>用于启动和禁用访问安全检查的开关：</p>
<ul>
<li>参数值为<code>true</code>指示反射的对象在使用时应该取消Java语言访问检查。有以下作用：<ul>
<li>提高反射的效率。如果代码中必须用反射，而该句代码需要频繁的被调用，需要设置为<code>true</code>。</li>
<li>使得原本无法访问的私有成员也可以访问。</li>
</ul>
</li>
<li>参数值为<code>false</code>指示反射的对象应该实施Java语言访问检查。</li>
</ul>
<h1 id="七、反射的应用：动态代理"><a href="#七、反射的应用：动态代理" class="headerlink" title="七、反射的应用：动态代理"></a>七、反射的应用：动态代理</h1><h2 id="1、动态代理概述"><a href="#1、动态代理概述" class="headerlink" title="1、动态代理概述"></a>1、动态代理概述</h2><p><strong>代理模式</strong>：使用一个代理将对象包装起来,然后用该代理对象取代原始对象。任何对原始对象的调用都要通过代理。代理对象决定是否以及何时将方法调用转到原始对象上。代理类和被代理类要实现同一个接口。</p>
<p><strong>静态代理</strong>：代理类和目标对象的类都是在编译期间确定下来，不利于程序的扩展。每一个代理类只能为一个接口服务，这样程序开发中必然产生过多的代理。</p>
<p><strong>动态代理</strong>：通过一个代理类完成全部的代理功能。在程序运行时根据需要动态创建目标类的代理对象。</p>
<p>动态代理使用场合：</p>
<ul>
<li>调试</li>
<li>远程方法调用</li>
</ul>
<p>动态代理相比于静态代理的优点：抽象角色中（接口）声明的所有方法都被转移到调用处理器一个集中的方法中处理，这样，可以更加灵活和统一的处理众多的方法。</p>
<p>一种<strong>静态代理</strong>实现举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.java;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">静态代理举例</span><br><span class="hljs-comment">特点：代理类和被代理类在编译期间，就确定了。</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//共同接口</span><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ClothFactory</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">produceCloth</span><span class="hljs-params">()</span></span>;<br>}<br><br><span class="hljs-comment">//代理类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyClothFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ClothFactory</span></span>{<br>    <span class="hljs-keyword">private</span> ClothFactory factory;<span class="hljs-comment">//用被代理类对象进行实例化</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ProxyClothFactory</span><span class="hljs-params">(ClothFactory factory)</span></span>{<br>        <span class="hljs-keyword">this</span>.factory = factory;<br>    }<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produceCloth</span><span class="hljs-params">()</span> </span>{<br>        System.out.println(<span class="hljs-string">"代理工厂做一些准备工作"</span>);<br>        factory.produceCloth();<br>        System.out.println(<span class="hljs-string">"代理工厂做一些后续的收尾工作"</span>);<br>    }<br>}<br><br><span class="hljs-comment">//被代理类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NikeClothFactory</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ClothFactory</span></span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">produceCloth</span><span class="hljs-params">()</span> </span>{<br>        System.out.println(<span class="hljs-string">"Nike工厂生产一批运动服"</span>);<br>    }<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StaticProxyTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//创建被代理类的对象</span><br>        ClothFactory nike = <span class="hljs-keyword">new</span> NikeClothFactory();<br>        <span class="hljs-comment">//创建代理类的对象</span><br>        ClothFactory proxyClothFactory = <span class="hljs-keyword">new</span> ProxyClothFactory(nike);<br>        <span class="hljs-comment">//调用代理类的方法</span><br>        proxyClothFactory.produceCloth();<br>    }<br>}<br><span class="hljs-comment">/*输出结果</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">代理工厂做一些准备工作</span><br><span class="hljs-comment">Nike工厂生产一批运动服</span><br><span class="hljs-comment">代理工厂做一些后续的收尾工作</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、动态代理实现"><a href="#2、动态代理实现" class="headerlink" title="2、动态代理实现"></a>2、动态代理实现</h2><p>Java中提供了<code>Proxy</code>类，专门用于完成代理操作。其是所有动态代理类的父类。通过此类为一个或多个接口动态地生成实现类。</p>
<p><code>Proxy</code>类提供用于创建动态代理类和动态代理对象的静态方法:</p>
<ul>
<li><code>static Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;...interfaces)</code>：创建<br>一个动态代理类所对应的Class对象</li>
<li><code>static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces
InvocationHandler h)</code>：直接创建一个动态代理对象。第一个参数是类加载器，第二个参数是被代理类实现的全部接口，第三个参数是<code>InvocationHandler</code>接口的实现类实例。</li>
</ul>
<p>动态代理实现步骤：</p>
<ul>
<li>创建一个实现接口<code>InvocationHandler</code>的类，它必须实现<code>invoke</code>方法，以完成代理的具体操作。</li>
<li>创建被代理的类以及接口。</li>
<li>通过<code>Proxy</code>的静态方法<code>new ProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)</code>创建一个Subject接口代理。</li>
<li>通过<code>Subject</code>代理调用<code>RealSubject</code>实现类的方法。</li>
</ul>
<p>以上步骤很难体现出动态代理的优势，下面的例子是更实用的动态代理机制的代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.atguigu.java;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">  动态代理的举例</span><br><span class="hljs-comment"> */</span><br><span class="hljs-comment">//步骤2.创建实现的共同接口和被代理类</span><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Human</span></span>{ <br>    <span class="hljs-function">String <span class="hljs-title">getBelief</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">(String food)</span></span>;<br>}<br><span class="hljs-comment">//被代理类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SuperMan</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Human</span></span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getBelief</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"I believe I can fly!"</span>;<br>    }<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eat</span><span class="hljs-params">(String food)</span> </span>{<br>        System.out.println(<span class="hljs-string">"我喜欢吃"</span> + food);<br>    }<br>}<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HumanUtil</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method1</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-string">"*****通用方法一*****"</span>);<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method2</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-string">"*****通用方法二*****"</span>);<br>    }<br>}<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">要想实现动态代理，需要解决的问题？</span><br><span class="hljs-comment">问题一：如何根据加载到内存中的被代理类，动态的创建一个代理类及其对象。</span><br><span class="hljs-comment">问题二：当通过代理类的对象调用方法a时，如何动态的去调用被代理类中的同名方法a。</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">//步骤3.创建Subject接口代理。</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyFactory</span></span>{<br>    <span class="hljs-comment">//调用此方法，返回一个代理类的对象。解决问题一</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">getProxyInstance</span><span class="hljs-params">(Object obj)</span></span>{<span class="hljs-comment">//obj:被代理类的对象</span><br>        MyInvocationHandler handler = <span class="hljs-keyword">new</span> MyInvocationHandler();<br>        handler.bind(obj);<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(obj.getClass().getClassLoader(),<br>                                      obj.getClass().getInterfaces(),<br>                                      handler);}<br>}<br><br><span class="hljs-comment">//步骤1.创建实现InvocationHandler接口的类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span></span>{<br>    <span class="hljs-keyword">private</span> Object obj;<span class="hljs-comment">//需要使用被代理类的对象进行赋值</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">bind</span><span class="hljs-params">(Object obj)</span></span>{<br>        <span class="hljs-keyword">this</span>.obj = obj;<br>    }<br>    <span class="hljs-comment">//当我们通过代理类的对象，调用方法a时，就会自动的调用如下的方法：invoke()</span><br>    <span class="hljs-comment">//将被代理类要执行的方法a的功能就声明在invoke()中</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> Throwable </span><br><span class="hljs-function">    </span>{<br>        HumanUtil util = <span class="hljs-keyword">new</span> HumanUtil();<br>        util.method1();<br>        <span class="hljs-comment">//method:即为代理类对象调用的方法，此方法也就作为了被代理类对象要调用的方法</span><br>        <span class="hljs-comment">//obj:被代理类的对象</span><br>        Object returnValue = method.invoke(obj,args);<br>        util.method2();<br>        <span class="hljs-comment">//上述方法的返回值就作为当前类中的invoke()的返回值。</span><br>        <span class="hljs-keyword">return</span> returnValue;<br>    }<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        SuperMan superMan = <span class="hljs-keyword">new</span> SuperMan();<br>        <span class="hljs-comment">//proxyInstance:代理类的对象。通过指定的被代理类，创建代理类对象</span><br>        Human proxyInstance = (Human) ProxyFactory.getProxyInstance(superMan);<br>        <span class="hljs-comment">//当通过代理类对象调用方法时，会自动的调用被代理类中同名的方法</span><br>        String belief = proxyInstance.getBelief();<br>        System.out.println(belief);<br>        proxyInstance.eat(<span class="hljs-string">"火锅"</span>);<br>    }<br>}<br><span class="hljs-comment">/*输出结果</span><br><span class="hljs-comment">*****通用方法一*****</span><br><span class="hljs-comment">*****通用方法二*****</span><br><span class="hljs-comment">I believe I can fly!</span><br><span class="hljs-comment">*****通用方法一*****</span><br><span class="hljs-comment">我喜欢吃火锅</span><br><span class="hljs-comment">*****通用方法二*****</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、动态代理与AOP"><a href="#3、动态代理与AOP" class="headerlink" title="3、动态代理与AOP"></a>3、动态代理与AOP</h2><p>AOP（Aspect Orient Programming），面向切片编程。</p>
<p>使用Proxy生成一个动态代理时，往往并不会凭空产生一个动态代理，这样没有太大的意义。通常都是为指定的目标对象生成动态代理。</p>
<p>这种动态代理在AOP中被称为AOP代理，AOP代理可代替目标对象，AOP代理包含了目标对象的全部方法。但AOP代理中的方法与目标对象的方法存在差异：<strong>AOP代理里的方法可以在执行目标方法之前、之后插入一些通用处理</strong>。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记16-Java8的其它新特征</title>
    <url>/2021/04/18/java-note-1601/</url>
    <content><![CDATA[<h1 id="Java-8-简介"><a href="#Java-8-简介" class="headerlink" title="Java 8 简介"></a>Java 8 简介</h1><p>Java 8的特征：</p>
<ul>
<li>速度更快</li>
<li>代码更少，因为新加入了Lambda表达式</li>
<li>强大的Stream API</li>
<li>便于并行</li>
<li>最大化减少空指针异常：Optional</li>
<li>Nashorn引擎，允许在JVM上运行JS应用。</li>
</ul>
<p>Java 8主要更新内容参考官方说明 <a href="https://www.oracle.com/java/technologies/javase/8-whats-new.html">What’s New in JDK 8</a></p>
<p>新特性总结：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1601_1.png"></p>
<p><strong>并行流与串行流</strong><br><strong>并行流</strong>就是把一个内容分成多个数据块，并用不同的线程分别处理每个数据块的流。相比较串行的流，并行的流可以很大程度上提高程序的执行效率。</p>
<p>Java 8中将并行进行了优化，可以很容易的对数据进行并行操作。Stream API可以使用parallel()与sequential()方法在并行流与顺序流之间进行切换。</p>
<h1 id="一、Lambda表达式"><a href="#一、Lambda表达式" class="headerlink" title="一、Lambda表达式"></a>一、Lambda表达式</h1><p>Lambda表达式是JDK 8中新的语法，操作符为<code>-&gt;</code>，一个Lambda表达式由3部分构成：</p>
<p><code>左侧-&gt;右侧</code></p>
<p>其中操作符左侧指定Lambda表达式需要的参数列表，右侧指定了Lambda体，是抽象方法的实现逻辑，即Lambda表达式要执行的功能。</p>
<p>Lambda表达式的<strong>本质是函数式接口的实例</strong>，其作为接口的实例出现。</p>
<p>具体使用方式：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//情况1:无参，无返回值</span><br>Runnable r = ()-&gt;{System.out.println(<span class="hljs-string">"hello"</span>);};<br><br><span class="hljs-comment">//情况2，一个参数，无返回值</span><br>Consumer&lt;String&gt; con = (String str) -&gt;{System.out.println(str);};<br><br><span class="hljs-comment">//情况3，数据类型可以省略，编译器可以推断，即类型推断</span><br>Consumer&lt;String&gt; con = (str) -&gt;{System.out.println(str);};<br><br><span class="hljs-comment">//情况4，如果只有一个参数，参数的小括号可以省略</span><br>Consumer&lt;String&gt; con = str -&gt;{System.out.println(str);};<br><br><span class="hljs-comment">//情况5，可以有两个及以上的参数，多条执行语句，有返回值</span><br>Comparator&lt;Integer&gt; com = (x,y)-&gt;{<br>    System.out.println(<span class="hljs-string">"hello"</span>);<br>    <span class="hljs-keyword">return</span> Integer.compare(x,y);<br>};<br><br><span class="hljs-comment">//情况6，只有一条语句时，{}和return可以省略</span><br>Comparator&lt;Integer&gt; com = (x,y)-&gt;Integer.compare(x,y);<br></code></pre></td></tr></tbody></table></figure>
<p>总结：</p>
<ul>
<li><p>左边：lambda形参列表的参数类型可以省略(类型推断)；如果lambda形参列表只有一个参数，其一对()也可以省略。</p>
</li>
<li><p>右边：lambda体应该使用一对<code>{}</code>包裹；如果lambda体只有一条执行语句（可能是return语句），省略<code>{}</code>和<code>return</code>。如果有返回值，则<code>return</code>和<code>{}</code>必须都有。因此<code>{}</code>和<code>return</code>要么都有，要么都没有。</p>
</li>
</ul>
<h1 id="二、函数式-Functional-接口"><a href="#二、函数式-Functional-接口" class="headerlink" title="二、函数式(Functional)接口"></a>二、函数式(Functional)接口</h1><p><strong>函数式接口指的是只包含一个抽象方法的接口</strong>。可以用注解<code>@FunctionalInterface</code>检查。</p>
<p>可以通过Lambda表达式创建函数式接口的对象，执行体就是实现抽象方法的代码。如果Lambda表达式抛出非运行时异常，该异常需要在目标接口的抽象方法上声明。</p>
<p><strong>Lambda表达式是一个函数式接口的实例</strong>，只要一个对象是函数式接口的实例对象，就可以用Lambda表达式来表达。所以说<strong>实现函数式接口的匿名实现类的表示方式都可以改成Lambda表达式</strong>的形式。</p>
<p><code>java.util.function</code>包下定义了Java8的丰富的函数式接口，其中有四种核心的函数式接口：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">函数式接口</th>
<th style="text-align:center">参数类型</th>
<th style="text-align:center">返回类型</th>
<th style="text-align:left">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">消费型接口<code>Consumer&lt;T&gt;</code></td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:center"><code>void</code></td>
<td style="text-align:left">对类型为<code>T</code>的对象应用操作，包含方法<code>void accept(T t)</code>，相当于消费者</td>
</tr>
<tr>
<td style="text-align:left">供给型接口<code>Supplier&lt;T&gt;</code></td>
<td style="text-align:center">无</td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:left">返回类型为<code>T</code>的对象，包含方法：<code>T get()</code>，相当于供给者，用户获取对象</td>
</tr>
<tr>
<td style="text-align:left">函数型接口<code>Function&lt;T, R&gt;</code></td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:center"><code>R</code></td>
<td style="text-align:left">对类型为<code>T</code>的对象应用操作，并返回结果是<code>R</code>类型的对象。包含方法：<code>R apply(T t)</code>，用于类型转换</td>
</tr>
<tr>
<td style="text-align:left">断定型接口<code>Predicate&lt;T&gt;</code></td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:center"><code>boolean</code></td>
<td style="text-align:left">确定类型为<code>T</code>的对象是否满足某约束，并返回<code>boolean</code>值。包含方法：<code>boolean test(T t)</code>，用于判断</td>
</tr>
</tbody>
</table>
</div>
<p>其他函数式接口：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">函数式接口</th>
<th style="text-align:center">参数类型</th>
<th style="text-align:center">返回类型</th>
<th style="text-align:left">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>BiFunction&lt;T,U,R&gt;</code></td>
<td style="text-align:center"><code>T</code>, <code>U</code></td>
<td style="text-align:center"><code>R</code></td>
<td style="text-align:left">对类型为<code>T</code>,<code>U</code>参数应用操作，返回R类型的结果。包含方法为：<code>R apply(T t, U u);</code></td>
</tr>
<tr>
<td style="text-align:left"><code>UnaryOperator&lt;T&gt;</code><br>(<code>Function</code>子接口)</td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:left">对类型为<code>T</code>的对象进行一元运算，并返回T类型的结果。包含方法为：<code>T apply(T t);</code></td>
</tr>
<tr>
<td style="text-align:left"><code>BinaryOperator&lt;T&gt;</code><br>(<code>BiFunction</code>子接口)</td>
<td style="text-align:center"><code>T</code>,<code>T</code></td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:left">对类型为<code>T</code>的对象进行二元运算，并返回<code>T</code>类型的结果。<br>包含方法为：<code>T apply(Tt 1,Tt 2);</code></td>
</tr>
<tr>
<td style="text-align:left"><code>BiConsumer&lt;T,U&gt;</code></td>
<td style="text-align:center"><code>T</code>, <code>U</code></td>
<td style="text-align:center"><code>void</code></td>
<td style="text-align:left">对类型为<code>T</code>,<code>U</code>参数应用操作。<br>包含方法为：<code>void accept(T t,U u);</code></td>
</tr>
<tr>
<td style="text-align:left"><code>BiPredicate&lt;T,U&gt;</code></td>
<td style="text-align:center"><code>T</code>, <code>U</code></td>
<td style="text-align:center"><code>boolean</code></td>
<td style="text-align:left">包含方法为：<code>boolean test(T t,U u);</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ToIntFunction&lt;T&gt;</code><br><code>ToLongFunction&lt;T&gt;</code><br><code>ToDoubleFunction&lt;T&gt;</code></td>
<td style="text-align:center"><code>T</code></td>
<td style="text-align:center"><code>int</code><br><code>long</code><br><code>double</code></td>
<td style="text-align:left">分别计算<code>int</code>、<code>long</code>、<code>double</code>值的函数</td>
</tr>
<tr>
<td style="text-align:left"><code>IntFunction&lt;R&gt;</code><br><code>LongFunction&lt;R&gt;</code><br><code>DoubleFunction&lt;R&gt;</code></td>
<td style="text-align:center"><code>int</code><br><code>long</code><br><code>double</code></td>
<td style="text-align:center"><code>R</code></td>
<td style="text-align:left">参数分别为<code>int</code>、<code>long</code>、<code>double</code>类型的函数</td>
</tr>
</tbody>
</table>
</div>
<p>使用实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LambdaTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//方法一，使用匿名实现类，重写accept方法。</span><br>        happyTime(<span class="hljs-number">500</span>, <span class="hljs-keyword">new</span> Consumer&lt;Double&gt;() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">accept</span><span class="hljs-params">(Double m)</span> </span>{<br>                System.out.println(<span class="hljs-string">"价格为："</span> + m);<br>            }<br>        });<br>        System.out.println(<span class="hljs-string">"********************"</span>);<br>        <span class="hljs-comment">//方法二，使用Lambda表达式，执行体就是相当于重写accept方法。</span><br>        happyTime(<span class="hljs-number">400</span>,money -&gt; System.out.println(<span class="hljs-string">"价格为："</span> + money));<br>    }<br>    <span class="hljs-comment">//happyTime方法第二个参数是消费型接口类型的实例</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">happyTime</span><span class="hljs-params">(<span class="hljs-keyword">double</span> money, Consumer&lt;Double&gt; con)</span></span>{<br>        con.accept(money);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、方法引用与构造器引用"><a href="#三、方法引用与构造器引用" class="headerlink" title="三、方法引用与构造器引用"></a>三、方法引用与构造器引用</h1><h2 id="1、方法引用"><a href="#1、方法引用" class="headerlink" title="1、方法引用"></a>1、方法引用</h2><p>当要传给Lambda体的操作，已经有实现的方法了，可以使用<strong>方法引用</strong>。</p>
<p>方法引用，本质上是Lambda表达式，可以认为是Lambda表达式的一个语法糖。所以<strong>方法引用也是函数式接口的实例</strong>。方法引用的操作符为<code>::</code></p>
<p>方法引用有三种方式：</p>
<ul>
<li>对象::实例方法名</li>
<li>类::静态方法名</li>
<li>类::实例方法名</li>
</ul>
<p>对于前两种方式，要求接口中的<strong>抽象方法的形参列表和返回值类型</strong>必须和<strong>方法引用的方法的形参列表和返回值类型</strong>相同。</p>
<p>使用举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">自定义Employee类。包含空参构造器和带参构造器。</span><br><span class="hljs-comment">其中getName()方法定义如下</span><br><span class="hljs-comment">public String getName() {return name;}</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodRefTest</span> </span>{<br>	<span class="hljs-comment">// 情况一：对象 :: 实例方法</span><br>	<span class="hljs-comment">/*例1：</span><br><span class="hljs-comment">	Consumer中的void accept(T t)</span><br><span class="hljs-comment">	PrintStream中的void println(T t)，二者都是返回某个类型的对象。</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-meta">@Test</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span> </span>{<br>		<span class="hljs-comment">//Lambda表达式写法</span><br>		Consumer&lt;String&gt; con1 = str -&gt; System.out.println(str);<br>		con1.accept(<span class="hljs-string">"北京"</span>);<br>		<span class="hljs-comment">//方法引用写法</span><br>		PrintStream ps = System.out;<br>		Consumer&lt;String&gt; con2 = ps::println;<br>		<span class="hljs-comment">//Consumer&lt;String&gt; con2 = System.out::println;  //和上面相同</span><br>		con2.accept(<span class="hljs-string">"beijing"</span>);<br>	}<br>	<span class="hljs-comment">/*</span><br><span class="hljs-comment">	例2，</span><br><span class="hljs-comment">	Supplier中的T get()</span><br><span class="hljs-comment">	Employee类中的String getName()，二者都是返回某个类型的对象。</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-meta">@Test</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span> </span>{<br>		Employee emp = <span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1001</span>,<span class="hljs-string">"Tom"</span>,<span class="hljs-number">23</span>,<span class="hljs-number">5600</span>);<br>		<span class="hljs-comment">//Lambda表达式写法</span><br>		Supplier&lt;String&gt; sup1 = () -&gt; emp.getName();<br>		System.out.println(sup1.get());<br>		<span class="hljs-comment">//方法引用写法</span><br>		Supplier&lt;String&gt; sup2 = emp::getName;<br>		System.out.println(sup2.get());<br>	}<br><br>	<span class="hljs-comment">// 情况二：类 :: 静态方法</span><br>	<span class="hljs-comment">/*例1：</span><br><span class="hljs-comment">	Comparator中的int compare(T t1,T t2)</span><br><span class="hljs-comment">	Integer中的int compare(T t1,T t2)，二者实现方法相同</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-meta">@Test</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span> </span>{<br>		<span class="hljs-comment">//Lambda表达式写法</span><br>		Comparator&lt;Integer&gt; com1 = (t1,t2) -&gt; Integer.compare(t1,t2);<br>		System.out.println(com1.compare(<span class="hljs-number">12</span>,<span class="hljs-number">21</span>));<br>		<span class="hljs-comment">//方法引用写法</span><br>		Comparator&lt;Integer&gt; com2 = Integer::compare;<br>		System.out.println(com2.compare(<span class="hljs-number">12</span>,<span class="hljs-number">3</span>));<br>	}<br>	<span class="hljs-comment">/*例2：</span><br><span class="hljs-comment">	Function中的R apply(T t)</span><br><span class="hljs-comment">	Math中的Long round(Double d)</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-meta">@Test</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span> </span>{<br>		<span class="hljs-comment">//匿名实现类写法</span><br>		Function&lt;Double,Long&gt; func = <span class="hljs-keyword">new</span> Function&lt;Double, Long&gt;() {<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">apply</span><span class="hljs-params">(Double d)</span> </span>{<span class="hljs-keyword">return</span> Math.round(d);}<br>		};<br>		<span class="hljs-comment">//Lambda表达式写法</span><br>		Function&lt;Double,Long&gt; func1 = d -&gt; Math.round(d);<br>		System.out.println(func1.apply(<span class="hljs-number">12.3</span>));<br>		<span class="hljs-comment">//方法引用写法</span><br>		Function&lt;Double,Long&gt; func2 = Math::round;<br>		System.out.println(func2.apply(<span class="hljs-number">12.6</span>));<br>	}<br><br>	<span class="hljs-comment">// 情况三：类 :: 实例方法</span><br>	<span class="hljs-comment">/*例1：</span><br><span class="hljs-comment">	Comparator中的int comapre(T t1,T t2)</span><br><span class="hljs-comment">	String中的int t1.compareTo(t2)</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-meta">@Test</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test5</span><span class="hljs-params">()</span> </span>{<br>		<span class="hljs-comment">//Lambda表达式写法</span><br>		Comparator&lt;String&gt; com1 = (s1,s2) -&gt; s1.compareTo(s2);<br>		System.out.println(com1.compare(<span class="hljs-string">"abc"</span>,<span class="hljs-string">"abd"</span>));<br>		<span class="hljs-comment">//方法引用写法</span><br>		Comparator&lt;String&gt; com2 = String :: compareTo;<br>		System.out.println(com2.compare(<span class="hljs-string">"abd"</span>,<span class="hljs-string">"abm"</span>));<br>	}<br>	<span class="hljs-comment">/*例2：</span><br><span class="hljs-comment">	BiPredicate中的boolean test(T t1, T t2);</span><br><span class="hljs-comment">	String中的boolean t1.equals(t2)</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-meta">@Test</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test6</span><span class="hljs-params">()</span> </span>{<br>		<span class="hljs-comment">//Lambda表达式写法</span><br>		BiPredicate&lt;String,String&gt; pre1 = (s1,s2) -&gt; s1.equals(s2);<br>		System.out.println(pre1.test(<span class="hljs-string">"abc"</span>,<span class="hljs-string">"abc"</span>));<br>		<span class="hljs-comment">//方法引用写法</span><br>		BiPredicate&lt;String,String&gt; pre2 = String :: equals;<br>		System.out.println(pre2.test(<span class="hljs-string">"abc"</span>,<span class="hljs-string">"abd"</span>));<br>	}<br>	<span class="hljs-comment">/*例3：</span><br><span class="hljs-comment">	Function中的R apply(T t)</span><br><span class="hljs-comment">	Employee中的String getName();</span><br><span class="hljs-comment">	*/</span><br>	<span class="hljs-meta">@Test</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test7</span><span class="hljs-params">()</span> </span>{<br>		Employee employee = <span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1001</span>, <span class="hljs-string">"Jerry"</span>, <span class="hljs-number">23</span>, <span class="hljs-number">6000</span>);<br>		<span class="hljs-comment">//Lambda表达式写法</span><br>		Function&lt;Employee,String&gt; func1 = e -&gt; e.getName();<br>		System.out.println(func1.apply(employee));<br>		<span class="hljs-comment">//方法引用写法</span><br>		Function&lt;Employee,String&gt; func2 = Employee::getName;<br>		System.out.println(func2.apply(employee));<br>	}<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、构造器引用"><a href="#2、构造器引用" class="headerlink" title="2、构造器引用"></a>2、构造器引用</h2><p>格式：<code>ClassName::new</code></p>
<p>和方法引用类似，要求函数式接口的<strong>抽象方法的形参列表</strong>和<strong>构造器的形参列表</strong>一致。</p>
<p>抽象方法的返回值类型即为构造器所属的类的类型。</p>
<p>代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConstructorRefTest</span> </span>{<br>    <span class="hljs-comment">//构造器引用</span><br>    <span class="hljs-comment">/*例1：</span><br><span class="hljs-comment">    Supplier中的T get()</span><br><span class="hljs-comment">    Employee的空参构造器：Employee()</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//匿名实现类写法</span><br>        Supplier&lt;Employee&gt; sup = <span class="hljs-keyword">new</span> Supplier&lt;Employee&gt;() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> Employee <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Employee();}<br>        };<br>        <span class="hljs-comment">//Lambda表达式写法</span><br>        Supplier&lt;Employee&gt;  sup1 = () -&gt; <span class="hljs-keyword">new</span> Employee();<br>        System.out.println(sup1.get());<br>        <span class="hljs-comment">//构造器引用写法</span><br>        Supplier&lt;Employee&gt;  sup2 = Employee :: <span class="hljs-keyword">new</span>;<br>        System.out.println(sup2.get());<br>    }<br>    <span class="hljs-comment">/*例2：</span><br><span class="hljs-comment">    BiFunction中的R apply(T t,U u)</span><br><span class="hljs-comment">    Employee的带参构造器：Employee(int id, String name)</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//Lambda表达式写法</span><br>        BiFunction&lt;Integer,String,Employee&gt; func1 = <br>            (id,name) -&gt; <span class="hljs-keyword">new</span> Employee(id,name);<br>        System.out.println(func1.apply(<span class="hljs-number">1001</span>,<span class="hljs-string">"Tom"</span>));<br>        <span class="hljs-comment">//构造器引用写法</span><br>        BiFunction&lt;Integer,String,Employee&gt; func2 = Employee :: <span class="hljs-keyword">new</span>;<br>        System.out.println(func2.apply(<span class="hljs-number">1002</span>,<span class="hljs-string">"Tom"</span>));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、数组引用"><a href="#3、数组引用" class="headerlink" title="3、数组引用"></a>3、数组引用</h2><p>格式：<code>type[]::new</code>，其中type表示数组类型。</p>
<p>可以将数组看成一个特殊的类，写法与构造器引用一致。</p>
<p>代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ArrayRefTest</span> </span>{<br>    <span class="hljs-comment">//数组引用</span><br>    <span class="hljs-comment">//Function中的R apply(T t)</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//Lambda表达式写法</span><br>        Function&lt;Integer,String[]&gt; func1 = length -&gt; <span class="hljs-keyword">new</span> String[length];<br>        String[] arr1 = func1.apply(<span class="hljs-number">5</span>);<br>        System.out.println(Arrays.toString(arr1));<br>        <span class="hljs-comment">//数组引用写法</span><br>        Function&lt;Integer,String[]&gt; func2 = String[] :: <span class="hljs-keyword">new</span>;<br>        String[] arr2 = func2.apply(<span class="hljs-number">10</span>);<br>        System.out.println(Arrays.toString(arr2));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、强大的Stream-API"><a href="#四、强大的Stream-API" class="headerlink" title="四、强大的Stream API"></a>四、强大的Stream API</h1><h2 id="1、Stream简介"><a href="#1、Stream简介" class="headerlink" title="1、Stream简介"></a>1、Stream简介</h2><p><strong>Stream API ( java.util.stream)</strong>把真正的函数式编程风格引入到Java中。这是目前为止对Java类库最好的补充，Stream API可以极大提高Java程序员的生产力。</p>
<p><strong>Stream</strong>是数据渠道，用于操作数据源(集合、数组等)所生成的元素序列。</p>
<p><strong>Stream API</strong>可以对集合进行操作，可以执行非常复杂的<strong>查找</strong>、<strong>过滤</strong>和<strong>映射数据</strong>等操作，类似于使用SQL执行的数据库查询。<br>也可以使用Stream API来并行执行操作。简言之，Stream API提供了一种高效且易于使用的处理数据的方式。</p>
<p><strong>Stream和Collection集合的区别</strong>：</p>
<p><code>Collection</code>是一种静态的内存数据结构。主要面向内存，存储在内存中。</p>
<p><code>Stream</code>是有关计算的。主要是面向CPU，通过CPU实现计算。</p>
<p><strong>Stream的特点</strong>：</p>
<ul>
<li>Stream 自己不会存储元素。</li>
<li>Stream 不会改变源对象，会返回一个持有结果的新Stream，类似于视图(Collections工具类会对集合本身进行修改，比如排序操作)。</li>
<li>Stream 操作是延迟执行的，即会等到需要结果的时候才执行，执行终止操作的时候才执行中间操作。</li>
</ul>
<h2 id="2、使用Stream"><a href="#2、使用Stream" class="headerlink" title="2、使用Stream"></a>2、使用Stream</h2><p>想要使用Stream，需要执行以下三个步骤：</p>
<ul>
<li>实例化<code>Stream</code>类(<code>java.util.stream.Stream</code>)，得到<code>Stream</code>类对象<code>stream</code>。</li>
<li>中间操作。中间操作链，对数据源的数据进行处理，比如排序，筛选，映射等。</li>
<li>终止操作。执行终止操作时才会执行中间操作，并产生结果。终止操作后，<code>stream</code>不能再被使用。</li>
</ul>
<h2 id="3、Stream实例化"><a href="#3、Stream实例化" class="headerlink" title="3、Stream实例化"></a>3、Stream实例化</h2><p>Stream类有四种实例化方法：</p>
<ul>
<li>通过集合。Java 8的<code>Collection</code>接口被扩展，提供了两个获取<code>Stream</code>实例的方法：<ul>
<li><code>default Stream&lt;E&gt; stream()</code>：返回一个顺序流</li>
<li><code>default Stream&lt;E&gt; parallelStream()</code>:返回一个并行流</li>
</ul>
</li>
<li>通过数组。<code>Arrays</code>工具类提供了<code>stream()</code>方法，用于获取数组流，对于不同的数据类型，提供了其重载方法，返回的类型也不同：<ul>
<li><code>public static &lt;T&gt; Stream&lt;T&gt; stream(T[] array)</code>：返回<code>Stream</code>实例。</li>
<li><code>public static IntStream stream(int[] array)</code>：对于<code>int</code>型数组，返回<code>IntStream</code>实例。</li>
<li><code>public static LongStream stream(long[] array)</code>：对于<code>long</code>型数组，返回<code>LongStream</code>实例。</li>
<li><code>public static DoubleStream stream(double[] array)</code>：对于<code>double</code>型数组，返回<code>DoubleStream</code>实例。</li>
</ul>
</li>
<li>通过<code>Stream</code>类的<code>of()</code>方法。<ul>
<li><code>public static&lt;T&gt; Stream&lt;T&gt; of(T...values)</code>：参数可以是单个数据，或者多个数据。如果直接将数组或者是集合作为参数，默认当作一个参数。参数不能为单个<code>null</code>，但是可以是多个<code>null</code></li>
</ul>
</li>
<li>通过<code>Stream</code>类静态方法创建无限流。创建无限流有两种方式：<ul>
<li><code>public static&lt;T&gt; Stream&lt;T&gt; iterate(final T seed, final UnaryOperator&lt;T&gt; f)</code>：迭代</li>
<li><code>public static&lt;T&gt; Stream&lt;T&gt; generate(Supplier&lt;T&gt; s)</code>：生成</li>
</ul>
</li>
</ul>
<p>代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StreamAPITest</span> </span>{<br>    <span class="hljs-comment">//创建 Stream方式一：通过集合</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        List&lt;Employee&gt; employees = EmployeeData.getEmployees();<br>        <span class="hljs-comment">//返回一个顺序流</span><br>        Stream&lt;Employee&gt; stream = employees.stream();<br>		<br>        <span class="hljs-comment">//返回一个并行流</span><br>        Stream&lt;Employee&gt; parallelStream = employees.parallelStream();<br>    }<br><br>    <span class="hljs-comment">//创建 Stream方式二：通过数组</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//对于int、long、double类型数组，返回特定的stream</span><br>        <span class="hljs-keyword">int</span>[] arr = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[]{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>};<br>        IntStream stream = Arrays.stream(arr);<br><br>        <span class="hljs-comment">//传入对象数组</span><br>        Employee e1 = <span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1001</span>,<span class="hljs-string">"Tom"</span>);<br>        Employee e2 = <span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1002</span>,<span class="hljs-string">"Jerry"</span>);<br>        Employee[] arr1 = <span class="hljs-keyword">new</span> Employee[]{e1,e2};<br>        Stream&lt;Employee&gt; stream1 = Arrays.stream(arr1);<br>    }<br>    <span class="hljs-comment">//创建 Stream方式三：通过Stream的of()</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//注意传入的参数个数</span><br>        List&lt;Integer&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        Stream&lt;List&lt;Integer&gt;&gt; list1 = Stream.of(list);<br>        Stream&lt;Object&gt; objectStream = Stream.of(list.toArray());<br><br>        <span class="hljs-comment">//直接传入集合或数组，当成一个参数</span><br>        <span class="hljs-keyword">int</span>[] array = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">3</span>];<br>        Stream&lt;<span class="hljs-keyword">int</span>[]&gt; array1 = Stream.of(array);<br>        <br>        Stream&lt;Integer&gt; stream = Stream.of(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>);<br>    }<br>    <span class="hljs-comment">//方式四：创建无限流</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//迭代</span><br>        <span class="hljs-comment">//遍历前10个偶数</span><br>        Stream.iterate(<span class="hljs-number">0</span>, t -&gt; t + <span class="hljs-number">2</span>).limit(<span class="hljs-number">10</span>).forEach(System.out::println);<br>		<br>        <span class="hljs-comment">//生成</span><br>        Stream.generate(Math::random).limit(<span class="hljs-number">10</span>).forEach(System.out::println);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、Stream中间操作"><a href="#4、Stream中间操作" class="headerlink" title="4、Stream中间操作"></a>4、Stream中间操作</h2><p>有了<code>Stream</code>类的对象以后，可以执行中间操作。中间操作可以链式操作，只有遇到终止操作的时候，中间操作才会一次性执行，称为“惰性求值”。</p>
<p>中间操作分成以下3种：</p>
<p>①<strong>筛选与切片</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>filter(Predicate p)</code></td>
<td style="text-align:left">接收Lambda表达式，从流中排除某些元素</td>
</tr>
<tr>
<td style="text-align:left"><code>distinct()</code></td>
<td style="text-align:left">筛选，通过流所生成元素的<code>hashCode()</code>和<code>equals()</code>去除重复元素</td>
</tr>
<tr>
<td style="text-align:left"><code>limit(long maxSize)</code></td>
<td style="text-align:left">截断流，使其元素不超过给定数量</td>
</tr>
<tr>
<td style="text-align:left"><code>skip(long n)</code></td>
<td style="text-align:left">跳过元素，返回一个跳过前n个元素的流。<br>若流中元素不足n个，则返回一个空流。与<code>limit(n)</code>操作互补</td>
</tr>
</tbody>
</table>
</div>
<p>②<strong>映射</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>map(Functionf)</code></td>
<td style="text-align:left">接收一个函数作为参数，该函数会被应用到每个元素上，<br>并将其映射成一个新的元素。</td>
</tr>
<tr>
<td style="text-align:left"><code>mapToDouble(ToDoubleFunction f)</code></td>
<td style="text-align:left">接收一个函数作为参数，该函数会被应用到每个元素上，<br>产生一个新的<code>DoubleStream</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>mapToInt(ToIntFunction f)</code></td>
<td style="text-align:left">接收一个函数作为参数，该函数会被应用到每个元素上，<br>产生一个新的<code>IntStream</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>mapToLong(ToLongFunction f)</code></td>
<td style="text-align:left">接收一个函数作为参数，该函数会被应用到每个元素上，<br>产生一个新的<code>LongStream</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>flatMap(Function f)</code></td>
<td style="text-align:left">接收一个函数作为参数，将流中的每个值都换成另一个流，<br>然后把所有流连接成一个流</td>
</tr>
</tbody>
</table>
</div>
<p>③<strong>排序</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>sorted()</code></td>
<td style="text-align:left">产生一个新流，按自然顺序排序</td>
</tr>
<tr>
<td style="text-align:left"><code>sorted(Comparator com)</code></td>
<td style="text-align:left">产生一个新流，按比较器顺序排序</td>
</tr>
</tbody>
</table>
</div>
<h2 id="5、Stream终止操作"><a href="#5、Stream终止操作" class="headerlink" title="5、Stream终止操作"></a>5、Stream终止操作</h2><p>终止操作会从流的流水线生成结果。其结果可以是任何不是流的值，例如：<code>List</code>、<code>Integer</code>，甚至是<code>void</code>。</p>
<p>流进行了终止操作后，不能再次被使用。</p>
<p>终止操作有以下几种：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>count()</code></td>
<td style="text-align:left">返回流中元素总数</td>
</tr>
<tr>
<td style="text-align:left"><code>max(Comparator c)</code></td>
<td style="text-align:left">返流中最大值</td>
</tr>
<tr>
<td style="text-align:left"><code>min(Comparator)</code></td>
<td style="text-align:left">返回流中最小值</td>
</tr>
<tr>
<td style="text-align:left"><code>forEach(Consumer c)</code></td>
<td style="text-align:left">内部迭代<br>(使用<code>Collection</code>接口需要用户去做迭代，称为外部迭代)</td>
</tr>
<tr>
<td style="text-align:left"><code>reduce(T iden,BinaryOperator b)</code>，   规约</td>
<td style="text-align:left">可以将流中元素反复结合起来，得到一个值。<br>返回<code>T</code></td>
</tr>
<tr>
<td style="text-align:left"><code>reduce(BinaryOperator b)</code>，   规约</td>
<td style="text-align:left">可以将流中元素反复结合起来，得到一个值。<br>返回<code>Optional</code><t></t></td>
</tr>
<tr>
<td style="text-align:left"><code>collect(Collector c)</code>，收集</td>
<td style="text-align:left">将流转换为其他形式。<br>接收一个<code>Collector</code>接口的实现，用于给<code>Stream</code>中元素做汇总的方法</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>map和reduce的连接通常称为map-reduce模式。</p>
</blockquote>
<p><code>Collector</code>接口（收集器）中方法的实现决定了如何对流执行收集的操作(如收集到<code>List</code>、<code>Set</code>、<code>Map</code>)。<br>另外，<code>Collectors</code>类提供了很多静态方法，可以方便地创建<code>Collector</code>实例，具体方法如下表：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">返回类型</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>toList</code></td>
<td style="text-align:left"><code>List&lt;T&gt;</code></td>
<td style="text-align:left">把流中元素收集到<code>List</code></td>
</tr>
<tr>
<td style="text-align:left"><code>toSet</code></td>
<td style="text-align:left"><code>Set&lt;T&gt;</code></td>
<td style="text-align:left">把流中元素收集到<code>Set</code></td>
</tr>
<tr>
<td style="text-align:left"><code>toCollection</code></td>
<td style="text-align:left"><code>Collection&lt;T&gt;</code></td>
<td style="text-align:left">把流中元素收集到创建的集合</td>
</tr>
<tr>
<td style="text-align:left"><code>counting</code></td>
<td style="text-align:left"><code>Long</code></td>
<td style="text-align:left">计算流中元素的个数</td>
</tr>
<tr>
<td style="text-align:left"><code>summingInt</code></td>
<td style="text-align:left"><code>Integer</code></td>
<td style="text-align:left">对流中元素的整数属性求和</td>
</tr>
<tr>
<td style="text-align:left"><code>averagingInt</code></td>
<td style="text-align:left"><code>Double</code></td>
<td style="text-align:left">计算流中元素<code>Integer</code>属性的平均值</td>
</tr>
<tr>
<td style="text-align:left"><code>summarizingInt</code></td>
<td style="text-align:left"><code>IntSummaryStatistics</code></td>
<td style="text-align:left">收集流中<code>Integer</code>属性的统计值。如：平均值</td>
</tr>
<tr>
<td style="text-align:left"><code>joining</code></td>
<td style="text-align:left"><code>String</code></td>
<td style="text-align:left">连接流中每个字符串</td>
</tr>
<tr>
<td style="text-align:left"><code>maxBy</code></td>
<td style="text-align:left"><code>Optional&lt;T&gt;</code></td>
<td style="text-align:left">根据比较器选择最大值</td>
</tr>
<tr>
<td style="text-align:left"><code>minBy</code></td>
<td style="text-align:left"><code>Optional&lt;T&gt;</code></td>
<td style="text-align:left">根据比较器选择最小值</td>
</tr>
<tr>
<td style="text-align:left"><code>reducing</code></td>
<td style="text-align:left">归约产生的类型</td>
<td style="text-align:left">从一个作为累加器的初始值开始，利用<code>BinaryOperator</code>与流中元素逐个结合，从而归约成单个值</td>
</tr>
<tr>
<td style="text-align:left"><code>collectingAndThen</code></td>
<td style="text-align:left">转换函数返回的类型</td>
<td style="text-align:left">包裹另一个收集器，对其结果转换函数</td>
</tr>
<tr>
<td style="text-align:left"><code>groupingBy</code></td>
<td style="text-align:left"><code>Map&lt;K, List&lt;T&gt;&gt;</code></td>
<td style="text-align:left">根据某属性值对流分组，属性为<code>K</code>结果为<code>V</code></td>
</tr>
<tr>
<td style="text-align:left"><code>partitioningBy</code></td>
<td style="text-align:left"><code>Map&lt;Boolean,List&lt;T&gt;&gt;</code></td>
<td style="text-align:left">根据<code>true</code>或<code>false</code>进行分区</td>
</tr>
</tbody>
</table>
</div>
<p>代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Employee的带参构造器声明：</span><br><span class="hljs-comment">public Employee(int id, String name, int age, double salary)</span><br><span class="hljs-comment">*/</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmployeeData</span> </span>{<br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;Employee&gt; <span class="hljs-title">getEmployees</span><span class="hljs-params">()</span></span>{<br>		List&lt;Employee&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>		list.add(<span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1001</span>, <span class="hljs-string">"马化腾"</span>, <span class="hljs-number">34</span>, <span class="hljs-number">6000.38</span>));<br>		list.add(<span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1002</span>, <span class="hljs-string">"马云"</span>, <span class="hljs-number">12</span>, <span class="hljs-number">9876.12</span>));<br>		list.add(<span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1003</span>, <span class="hljs-string">"刘强东"</span>, <span class="hljs-number">33</span>, <span class="hljs-number">3000.82</span>));<br>		list.add(<span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1004</span>, <span class="hljs-string">"雷军"</span>, <span class="hljs-number">26</span>, <span class="hljs-number">7657.37</span>));<br>		list.add(<span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1005</span>, <span class="hljs-string">"李彦宏"</span>, <span class="hljs-number">65</span>, <span class="hljs-number">5555.32</span>));<br>		list.add(<span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1006</span>, <span class="hljs-string">"比尔盖茨"</span>, <span class="hljs-number">42</span>, <span class="hljs-number">9500.43</span>));<br>		list.add(<span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1007</span>, <span class="hljs-string">"任正非"</span>, <span class="hljs-number">26</span>, <span class="hljs-number">4333.32</span>));<br>		list.add(<span class="hljs-keyword">new</span> Employee(<span class="hljs-number">1008</span>, <span class="hljs-string">"扎克伯格"</span>, <span class="hljs-number">35</span>, <span class="hljs-number">2500.32</span>));<br>		<span class="hljs-keyword">return</span> list;<br>	}<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StreamAPITest2</span> </span>{<br>    <span class="hljs-comment">//1-匹配与查找</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        List&lt;Employee&gt; employees = EmployeeData.getEmployees();<br>        <span class="hljs-comment">//练习：判断是否所有的员工的年龄都大于18</span><br>        <span class="hljs-keyword">boolean</span> allMatch = employees.stream().allMatch(e -&gt; e.getAge() &gt; <span class="hljs-number">18</span>);<br>        System.out.println(allMatch);<br><br>        <span class="hljs-comment">//练习：判断是否存在员工姓“雷”</span><br>        <span class="hljs-keyword">boolean</span> noneMatch = employees.stream().<br>            noneMatch(e -&gt; e.getName().startsWith(<span class="hljs-string">"雷"</span>));<br>        System.out.println(noneMatch);<br>        <br>        <span class="hljs-comment">//返回第一个元素</span><br>        Optional&lt;Employee&gt; employee = employees.stream().findFirst();<br>        System.out.println(employee);<br>        <br>        <span class="hljs-comment">//返回当前流中的任意元素</span><br>        Optional&lt;Employee&gt; employee1 = employees.parallelStream().findAny();<br>        System.out.println(employee1);<br>    }<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>        List&lt;Employee&gt; employees = EmployeeData.getEmployees();<br>        <span class="hljs-comment">// 返回流中元素的总个数</span><br>        <span class="hljs-keyword">long</span> count = employees.stream().f<br>            ilter(e -&gt; e.getSalary() &gt; <span class="hljs-number">5000</span>).<br>            count();<br>        System.out.println(count);<br>		<br>        <span class="hljs-comment">//返回流中最大值</span><br>        <span class="hljs-comment">//练习：返回最高的工资</span><br>        Stream&lt;Double&gt; salaryStream = employees.stream().map(e -&gt; e.getSalary());<br>        Optional&lt;Double&gt; maxSalary = salaryStream.max(Double::compare);<br>        System.out.println(maxSalary);<br>       <br>        <span class="hljs-comment">//返回流中最小值</span><br>        <span class="hljs-comment">//练习：返回最低工资的员工</span><br>        Optional&lt;Employee&gt; employee = employees.stream().<br>            min((e1, e2) -&gt; Double.compare(e1.getSalary(), e2.getSalary()));<br>        System.out.println(employee);<br>        <br>        <span class="hljs-comment">//内部迭代</span><br>        employees.stream().forEach(System.out::println);<br>        <br>        <span class="hljs-comment">//使用集合的遍历操作</span><br>        employees.forEach(System.out::println);<br>    }<br>    <br>    <span class="hljs-comment">//2-归约</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//练习1：计算1-10的自然数的和</span><br>        List&lt;Integer&gt; list = Arrays.asList(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>);<br>        Integer sum = list.stream().reduce(<span class="hljs-number">0</span>, Integer::sum);<br>        System.out.println(sum);<br><br>        <span class="hljs-comment">//练习2：计算公司所有员工工资的总和</span><br>        List&lt;Employee&gt; employees = EmployeeData.getEmployees();<br>        <br>        Stream&lt;Double&gt; salaryStream = employees.stream().map(Employee::getSalary);<br>        Optional&lt;Double&gt; sumMoney = salaryStream.reduce((d1,d2) -&gt; d1 + d2);<br>        System.out.println(sumMoney.get());<br>    }<br>    <br>    <span class="hljs-comment">//3-收集</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//练习1：查找工资大于6000的员工，结果返回为一个List或Set</span><br>        List&lt;Employee&gt; employees = EmployeeData.getEmployees();<br>       <br>        <span class="hljs-comment">//返回List</span><br>        List&lt;Employee&gt; employeeList = employees.stream().<br>            filter(e -&gt; e.getSalary() &gt; <span class="hljs-number">6000</span>).<br>            collect(Collectors.toList());<br>        employeeList.forEach(System.out::println);<br>        <br>        <span class="hljs-comment">//返回Set</span><br>        Set&lt;Employee&gt; employeeSet = employees.stream().<br>            filter(e -&gt; e.getSalary() &gt; <span class="hljs-number">6000</span>).<br>            collect(Collectors.toSet());<br>        employeeSet.forEach(System.out::println);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、Optional类"><a href="#五、Optional类" class="headerlink" title="五、Optional类"></a>五、Optional类</h1><p><code>Optional&lt;T&gt;</code>类(<code>java.util.Optional</code>)是一个容器类，它可以保存类型<code>T</code>的值，代表这个值存在。或者仅仅保存<code>null</code>，表示这个值不存在。是为了避免出现空指针异常而创建的。</p>
<blockquote>
<p>Optional容器类，存放的是对象</p>
</blockquote>
<p>原来用<code>null</code>表示一个值不存在，现在<code>Optional</code>可以更好的表达这个概念。并且可以避免空指针异常。</p>
<p><code>Optional</code>类提供了如下方法，利用这些方法，可以不用显式进行空值检测：<br><strong>创建Optional类对象的方法</strong>：</p>
<ul>
<li><code>Optional.of(T t)</code>：创建一个<code>Optional</code>实例，<code>t</code>必须非空；</li>
<li><code>Optional.empty()</code>：创建一个空的<code>Optional</code>实例</li>
<li><code>Optional.ofNullable(T t)</code>：<code>t</code>可以为<code>null</code></li>
</ul>
<p><strong>判断Optional容器中是否包含对象</strong>：</p>
<ul>
<li><code>boolean isPresent()</code>：判断是否包含对象</li>
<li><code>void ifPresent(Consumer&lt;? super T&gt; consumer)</code>：如果有值，就执行<code>Consumer</code>接口的实现代码，并且该值会作为参数传给它。</li>
</ul>
<p><strong>获取Optional容器的对象</strong>：</p>
<ul>
<li><code>T get()</code>:如果调用对象包含值，返回该值，否则抛异常</li>
<li><code>T orElse(T other)</code>：如果有值则将其返回，否则返回指定的other对象。</li>
<li><code>T orElseGet(Supplier&lt;? extends T&gt; other)</code>：如果有值则将其返回，否则返回由<code>Supplier</code>接口实现类提供的对象。</li>
<li><code>T orElseThrow(Supplier&lt;? extends X&gt; exceptionSupplier)</code>：如果有值则将其返回，否则抛出由<code>Supplier</code>接口实现类提供的异常。</li>
</ul>
<p>应用举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Girl</span></span>{<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Girl</span><span class="hljs-params">()</span> </span>{}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Girl</span><span class="hljs-params">(String name)</span> </span>{<span class="hljs-keyword">this</span>.name = name;}<br>}<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptionalTest</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Girl girl = <span class="hljs-keyword">new</span> Girl(<span class="hljs-string">"Jack"</span>);<br>        <span class="hljs-comment">//如果值为空，则返回指定的对象</span><br>        <span class="hljs-comment">//值非空，返回非空值： Girl{name='Jack'}</span><br>        System.out.println(Optional.ofNullable(girl).<br>                           orElse(<span class="hljs-keyword">new</span> Girl(<span class="hljs-string">"Jessica"</span>)));<br>        <span class="hljs-comment">//值为空，返回指定值：Girl{name='Tom'}</span><br>        System.out.println(Optional.ofNullable(<span class="hljs-keyword">null</span>).<br>                           orElse(<span class="hljs-keyword">new</span> Girl(<span class="hljs-string">"Tom"</span>)));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记17-Java9&amp;10&amp;11新特征</title>
    <url>/2021/04/19/java-note-1701/</url>
    <content><![CDATA[<h1 id="一、Java-9新特性"><a href="#一、Java-9新特性" class="headerlink" title="一、Java 9新特性"></a>一、Java 9新特性</h1><p>Java 9的新特性官方<a href="https://docs.oracle.com/javase/9/whatsnew/toc.htm#JSNEW-GUID-C23AFD78-C777-460B-8ACE-58BE5EA681F6">文档</a></p>
<p>从Java 9发布开始，Java的计划发布周期变为6个月。</p>
<p>总的来说，Java 9的新特性主要有：</p>
<ul>
<li><strong>模块化系统</strong></li>
<li><strong>jShell命令</strong></li>
<li>多版本兼容jar包</li>
<li><strong>接口的私有方法</strong></li>
<li><strong>钻石操作符的使用升级</strong></li>
<li><strong>语法改进：try语句</strong></li>
<li><strong>String存储结构变更</strong></li>
<li><strong>便利的集合特性：of()</strong></li>
<li><strong>增强的StreamAPI</strong></li>
<li><strong>全新的HTTP客户端API</strong></li>
<li><strong>Deprecated的相关API</strong></li>
<li>javadoc的HTML5支持</li>
<li>Javascript引擎升级：Nashorn</li>
<li>java的动态编译器</li>
</ul>
<h2 id="1、JDK和JRE目录结构改变"><a href="#1、JDK和JRE目录结构改变" class="headerlink" title="1、JDK和JRE目录结构改变"></a>1、JDK和JRE目录结构改变</h2><p>Java 9开始，JDK的目录结构发生改变。</p>
<p><strong>Java 9之前的JDK目录</strong>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1701_1.png"></p>
<p><strong>Java 9及以后的JDK目录结构</strong>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1701_2.png"></p>
<h2 id="2、模块化系统"><a href="#2、模块化系统" class="headerlink" title="2、模块化系统"></a>2、模块化系统</h2><p>Java 9之前的项目，存在的缺陷：</p>
<ul>
<li><strong>Java运行环境的膨胀和臃肿</strong>。每次JVM启动的时候，至少会有30～60MB的内存加载，主要原因是JVM需要加载rt.jar，不管其中的类是否被classloader加载，第一步整个jar都会被JVM加载到内存当中去（而模块化可以根据模块的需要加载程序运行需要的class）</li>
<li><strong>当代码库越来越大，创建复杂，代码交错的几率呈指数级的增长</strong>。不同版本的类库交叉依赖导致让人头疼的问题，这些都阻碍了Java开发和运行效率的提升。</li>
<li><strong>很难真正地对代码进行封装</strong>，而系统并没有对不同部分（也就是JAR文件）之间的依赖关系有个明确的概念。<strong>每一个公共类都可以被类路径之下任何其它的公共类所访问到，这样就会导致无意中使用了并不想被公开访问的API</strong>。</li>
</ul>
<p>Java 9提出Jigsaw(积木，拼图)项目的概念，之后的版本改名为Modularity，表示模块化项目。</p>
<p>本质上来说，模块(module)的概念其实就是package外再裹一层，就是用模块来管理各个package，通过声明某个package暴露，不声明默认就是隐藏。因此，模块化使得代码组织上更安全，因为它可以指定哪些部分可以暴露，哪些部分隐藏。<br><strong>模块化的实现目标</strong>：</p>
<ul>
<li>模块化的主要目的在于减少内存的开销</li>
<li>只须必要模块，而非全部jdk模块，可简化各种类库和大型应用的开发和维护</li>
<li>改进Java SE平台，使其可以适应不同大小的计算设备</li>
<li>改进其安全性，可维护性，提高性能</li>
</ul>
<p><strong>模块化的使用</strong></p>
<p>模块将由<strong>通常的类</strong>和新的<strong>模块声明文件</strong>（<code>module-info.java</code>）组成。该文件位于java代码结构的顶层，描述符明确地定义了模块需要什么依赖关系，以及哪些模块被外部使用。在<code>exports</code>子句中未提及的所有包默认情况下将封装在模块中，不能在外部使用。</p>
<p>如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1701_3.png"></p>
<p>要想在<code>java9demo</code>模块中调用<code>java9test</code>模块下包中的结构，需要在<code>java9test</code>的<code>module-info.java</code>中声明：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">module</span> java9test{<br>    <span class="hljs-comment">//将想要对外暴露的包，使用exports导出。</span><br>    <span class="hljs-comment">//没有使用exports语句导出的包，默认被封装到模块里面</span><br>    <span class="hljs-keyword">exports</span> com.atguigu.bean;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>对应地，需要在<code>java9demo</code>模块的src下，创建<code>module-info.java</code>文件，声明下面语句：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">module</span> java9demo{<br>    <span class="hljs-comment">//requires指明对其他模块的依赖</span><br>    <span class="hljs-keyword">requires</span> java9test;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、jShell命令"><a href="#3、jShell命令" class="headerlink" title="3、jShell命令"></a>3、jShell命令</h2><p><strong>交互式编程环境REPL</strong>(read-evaluate-print-loop)指的是以交互式的方式对语句和表达式求值。</p>
<p><strong>jShell</strong>是Java语言在Java 9新增的REPL工具，让Java像脚本语言一样运行。无需创建Java文件就可以运行程序。</p>
<p>jShell也可以从文件中加载语句或者将语句保存到文件中。</p>
<p>jShell也可以使用tab键进行自动补全和自动添加分号。</p>
<p><strong>使用方法</strong></p>
<p>启动：在命令提示符窗口中输入<code>jshell</code>（Windows的DOS命令不区分大小写）即可打开jShell</p>
<p>使用：</p>
<ul>
<li><code>/help intro</code>：获取帮助</li>
<li><code>/list</code>：控制正在执行的操作</li>
<li><code>/help</code>：获取有关命令的列表</li>
<li><code>/exit</code>：退出jShell</li>
</ul>
<blockquote>
<p>jShell环境下，语句末尾的<code>;</code>可以省略，为了提高代码可读性，建议不要省略。</p>
<p>jShell中没有受检异常(编译时异常)</p>
</blockquote>
<h2 id="4、语法改进：接口的私有方法"><a href="#4、语法改进：接口的私有方法" class="headerlink" title="4、语法改进：接口的私有方法"></a>4、语法改进：接口的私有方法</h2><p>Java 8中对于接口添加了静态方法和默认方法，Java 9中加入了私有方法。接口更像一个抽象类了。</p>
<h2 id="5、语法改进：钻石操作符使用升级"><a href="#5、语法改进：钻石操作符使用升级" class="headerlink" title="5、语法改进：钻石操作符使用升级"></a>5、语法改进：钻石操作符使用升级</h2><p>钻石操作符（diamond operator)：<code>&lt;&gt;</code></p>
<p>Java 9中钻石操作符可以和匿名实现类共同使用：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//匿名操作类后面可以使用&lt;&gt;操作符</span><br>Comparator&lt;Object&gt; com = <span class="hljs-keyword">new</span> Comparator&lt;&gt;(){<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">compare</span><span class="hljs-params">(Object o1, Object o2)</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>}<br><span class="hljs-comment">//Java 9以前这样写会报编译异常：Cannot use“&lt;&gt;”with anonymous inner classes</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="6、语法改进：try语句"><a href="#6、语法改进：try语句" class="headerlink" title="6、语法改进：try语句"></a>6、语法改进：try语句</h2><p>Java 8中，可以实现资源的自动关闭，但是要求<strong>执行后必须关闭的所有资源必须在try子句中初始化</strong>，否则编译不通过：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span>(InputStreamReader reader = <span class="hljs-keyword">new</span> InputStreamReader(System.in)){<br>    <span class="hljs-comment">//读取数据细节省略</span><br>}<span class="hljs-keyword">catch</span>(IOException e){<br>    e.printStackTrace();<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>Java9中，用资源语句编写try将更容易，<strong>可以在try子句中使用已经初始化过的资源</strong>，但是此时的资源是<code>final</code>的，无法再被修改：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">InputStreamReader reader = <span class="hljs-keyword">new</span> InputStreamReader(System.in);<br>OutputStreamWriter writer = <span class="hljs-keyword">new</span> OutputStreamWriter(System.out);<br><span class="hljs-keyword">try</span>(reader; writer){<br>    <span class="hljs-comment">//reader是final的，不可再被赋值</span><br>    <span class="hljs-comment">//reader = null;  //会报错</span><br>    <span class="hljs-comment">//具体读写操作省略</span><br>}<span class="hljs-keyword">catch</span>(IOException e) {<br>    e.printStackTrace();<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="7、String存储结构改变"><a href="#7、String存储结构改变" class="headerlink" title="7、String存储结构改变"></a>7、String存储结构改变</h2><p>Java 9开始，String（包括StringBuffer、StringBuilder）的底层存储结构不再是char型数组，而是用<strong>byte数组加编码标记</strong>，节省空间。</p>
<h2 id="8、集合工厂方法"><a href="#8、集合工厂方法" class="headerlink" title="8、集合工厂方法"></a>8、集合工厂方法</h2><p>Java 9之前，如果想创建一个只读、不可改变的集合，需要好几步：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">List&lt;String&gt; namesList =newArrayList &lt;&gt;(); <span class="hljs-comment">//创建集合</span><br>namesList.add(<span class="hljs-string">"Joe"</span>); <span class="hljs-comment">//添加元素</span><br>namesList.add(<span class="hljs-string">"Bob"</span>);<br>namesList.add(<span class="hljs-string">"Bill"</span>);<br>namesList = Collections.unmodifiableList(namesList); <span class="hljs-comment">//更改为不可变集合</span><br>System.out.println(namesList);<br><br><span class="hljs-comment">//下面这种方法得到的也是只读集合</span><br>List&lt;Integer&gt; list = Arrays.asList(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>); <br></code></pre></td></tr></tbody></table></figure>
<p>Java 9为集合类添加了静态方法<code>of()</code>，用于构建只读集合。包括<code>List</code>、<code>Set</code>、<code>Map</code>。只读集合如果添加元素，会导致<code>UnsupportedOperationException</code>异常。</p>
<p>List中的<code>of()</code>方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1701_4.png"></p>
<p>Map中的<code>of()</code>方法</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1701_5.png"></p>
<h2 id="9、InputStream加强"><a href="#9、InputStream加强" class="headerlink" title="9、InputStream加强"></a>9、InputStream加强</h2><p>InputStream添加<code>transferTo</code>方法，可以用来将数据直接传输到<code>OutputStream</code>，这是在处理原始数据流时非常常见的一种用法:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">ClassLoader cl =<span class="hljs-keyword">this</span>.getClass().getClassLoader();<br><span class="hljs-keyword">try</span>(InputStream is = cl.getResourceAsStream(<span class="hljs-string">"hello.txt"</span>);<br>    OutputStream os = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">"src\\hello1.txt"</span>)) {<br>    is.transferTo(os);<span class="hljs-comment">//把输入流中的所有数据直接自动地复制到输出流中</span><br>}<span class="hljs-keyword">catch</span>(IOException e) {<br>    e.printStackTrace();<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="10、增强的Stream-API"><a href="#10、增强的Stream-API" class="headerlink" title="10、增强的Stream API"></a>10、增强的Stream API</h2><p>Java 9中，Stream接口中添加了4个新的方法：</p>
<ul>
<li><code>default Stream&lt;T&gt; takeWhile(Predicate&lt;? super T&gt; predicate)</code>：返回从开头开始，按照指定规则的尽量多的元素（一旦遇到不符合条件的数据，就停止）。</li>
<li><code>default Stream&lt;T&gt; dropWhile(Predicate&lt;? super T&gt; predicate)</code>：返回符合条件的前n个元素之后的元素，与<code>takeWhile</code>互补。</li>
<li><code>public static&lt;T&gt; Stream&lt;T&gt; ofNullable(T t)</code>：创建一个单元素的<code>Stream</code>实例，<code>t</code>可以为空（Java 8中的<code>of()</code>方法不能为单个<code>null</code>）</li>
<li><code>public static&lt;T&gt; Stream&lt;T&gt; iterate(T seed, Predicate&lt;? super T&gt; hasNext, UnaryOperator&lt;T&gt; next)</code>：<code>iterate</code>的重载方法，可以提供一个<code>Predicate</code> (判断条件)来指定什么时候结束迭代。</li>
</ul>
<h2 id="11、Optional创建Stream对象"><a href="#11、Optional创建Stream对象" class="headerlink" title="11、Optional创建Stream对象"></a>11、Optional创建Stream对象</h2><p>除了对<code>Stream</code>本身的扩展，<code>Optional</code>和<code>Stream</code>之间的结合也得到了改进。</p>
<p>现在可以通过<code>Optional</code>的新方法<code>stream()</code>将一个<code>Optional</code>对象转换为一个(可能是空的) <code>Stream</code>对象。</p>
<p>比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>        List&lt;String&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        list.add(<span class="hljs-string">"Tom"</span>);<br>        list.add(<span class="hljs-string">"Jerry"</span>);<br>        Optional&lt;List&lt;String&gt;&gt; optional = Optional.ofNullable(list);<br>        Stream&lt;List&lt;String&gt;&gt; stream = optional.stream();<br>        stream.flatMap(x -&gt; x.stream()).forEach(System.out::println);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="12、JavaScript引擎升级"><a href="#12、JavaScript引擎升级" class="headerlink" title="12、JavaScript引擎升级"></a>12、JavaScript引擎升级</h2><p>Nashorn项目在Java 9中得到改进。</p>
<h1 id="二、Java-10新特性"><a href="#二、Java-10新特性" class="headerlink" title="二、Java 10新特性"></a>二、Java 10新特性</h1><p>Java 10共定义了109个新特性，其中包含12个<strong>JEP(JDK Enhancement Proposal)</strong>，还有新API和JVM规范以及Java语言规范上的改动。</p>
<p>12个JEP：</p>
<ul>
<li>286:Local-Variable Type Inference：局部变量类型推断</li>
<li>296:Consolidate the JDK Forest into a Single Repository：JDK库的合并</li>
<li>304:Garbage-Collector Interface：统一的垃圾回收接口</li>
<li>307:Parallel Full GC for G1：为G1提供并行的Full GC</li>
<li>310:Application Class-Data Sharing：应用程序类数据（AppCDS）共享</li>
<li>312:Thread-Local Handshakes  ThreadLocal：握手交互</li>
<li>313:Remove the Native-Header Generation Tool (javah)：移除JDK中附带的javah工具</li>
<li>314:Additional Unicode Language-Tag Extensions：使用附加的Unicode语言标记扩展</li>
<li>316:Heap Allocation on Alternative Memory Devices：能将堆内存占用分配给用户指定的备用内存设备</li>
<li>317:Experimental Java-Based JIT Compiler：使用基于Java的JIT编译器</li>
<li>319:Root Certificates：根证书</li>
<li>322:Time-Based Release Versioning：基于时间的发布版本</li>
</ul>
<p>其中值得关注的是：<strong>Local-Variable Type Inference，局部变量类型推断</strong>。</p>
<h2 id="1、局部变量类型推断"><a href="#1、局部变量类型推断" class="headerlink" title="1、局部变量类型推断"></a>1、局部变量类型推断</h2><p>使用<code>var</code>代替<strong>局部变量</strong>的显示类型声明，适用于编译器可以推断出类型的地方，包括以下三种情况：</p>
<ul>
<li>局部变量的初始化</li>
<li>增强for循环中的索引</li>
<li>传统for循环中的索引</li>
</ul>
<p>代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-comment">//1.声明变量时，根据所附的值，推断变量的类型</span><br>        <span class="hljs-keyword">var</span> num = <span class="hljs-number">10</span>;<br>        <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> ArrayList&lt;Integer&gt;();<br>        list.add(<span class="hljs-number">123</span>);<br>        <br>        <span class="hljs-comment">//2.遍历操作</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i : list) {System.out.println(i);}<br>        <span class="hljs-comment">//3.普通的遍历操作</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {System.out.println(i);}<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>var</code>不适用于以下情况：</p>
<ul>
<li>没有初始化的局部变量声明</li>
<li>方法的返回类型</li>
<li>方法的参数类型</li>
<li>构造器的参数类型</li>
<li>属性</li>
<li>catch块</li>
</ul>
<p><strong>原理</strong>：在处理<code>var</code>时，编译器先是查看表达式右边部分，并根据右边变量值的类型进行推断，作为左边变量的类型，然后将该类型写入字节码当中。正确使用<code>var</code>生成的字节码文件和不使用<code>var</code>时生成的字节码文件内容是相同的。</p>
<p><strong>注意</strong>：</p>
<ul>
<li><code>var</code>不是一个关键字。因此可以作为方法名或变量名，但是不能用它作为类名。除了不能用作类名以外，别的都可以。</li>
<li><code>var</code>并不会改变Java是一门静态类型语言的事实。这一特征只发生在编译阶段，对运行时性能不会产生任何影响。编译器在编译阶段自动推断出类型，然后写入字节码文件。反编译出的字节码文件仍是传统带类型的代码。</li>
</ul>
<h2 id="2、集合新增创建不可变集合的方法"><a href="#2、集合新增创建不可变集合的方法" class="headerlink" title="2、集合新增创建不可变集合的方法"></a>2、集合新增创建不可变集合的方法</h2><p>Java 9 为集合（<code>List</code>,<code>Set</code>,<code>Map</code>）添加了<code>of()</code>方法用于创建不可变集合，Java 10 则添加了<code>copyOf()</code>方法，同样用于创建不可变集合，二者的区别如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test5</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//示例1：</span><br>        <span class="hljs-keyword">var</span> list1 = List.of(<span class="hljs-string">"Java"</span>, <span class="hljs-string">"Python"</span>, <span class="hljs-string">"C"</span>);<br>        <span class="hljs-keyword">var</span> copy1 = List.copyOf(list1);  <span class="hljs-comment">//list1是不可变集合，直接返回list1</span><br>        System.out.println(list1 == copy1); <span class="hljs-comment">// true</span><br>        <span class="hljs-comment">//示例2：</span><br>        <span class="hljs-keyword">var</span> list2 = <span class="hljs-keyword">new</span> ArrayList&lt;String&gt;();<br>        list2.add(<span class="hljs-string">"aaa"</span>);<br>        <span class="hljs-comment">//list2是可变集合，底层会调用of方法新建一个只读集合并返回</span><br>        <span class="hljs-keyword">var</span> copy2 = List.copyOf(list2); <br>        System.out.println(list2 == copy2); <span class="hljs-comment">// false</span><br>        <span class="hljs-comment">//结果不同。</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上面两种结果不同，是因为<code>copyOf()</code>会先判断参数集合是不是<code>AbstractImmutableList</code>（不可变）类型的，如果是，则直接返回，否则会调用<code>of</code>方法创建一个只读集合并返回。</p>
<h1 id="三、Java-11新特性"><a href="#三、Java-11新特性" class="headerlink" title="三、Java 11新特性"></a>三、Java 11新特性</h1><h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p>Java 11是一个长期支持版本，包括ZGC、Http Client等重要更新，以及17个值得关注的JEP。</p>
<h2 id="2、新增字符串处理方法"><a href="#2、新增字符串处理方法" class="headerlink" title="2、新增字符串处理方法"></a>2、新增字符串处理方法</h2><p>Java 11新增了一系列字符串处理的方法：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>boolean isBlank()</code></td>
<td>判断字符串是否为空白</td>
</tr>
<tr>
<td><code>String strip()</code></td>
<td>去除首尾空白</td>
</tr>
<tr>
<td><code>String stripTrailing()</code></td>
<td>去除尾部空格</td>
</tr>
<tr>
<td><code>String stripLeading()</code></td>
<td>去除首部空格</td>
</tr>
<tr>
<td><code>String repeat(int n)</code></td>
<td>复制字符串n次</td>
</tr>
<tr>
<td><code>Stream&lt;String&gt; lines()</code></td>
<td>统计行数</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p><code>strip</code>和<code>trim</code>的区别是：<code>trim</code>无法消除Unicode空白字符<code>\u2000</code>，而<code>strip</code>可以。</p>
</blockquote>
<h2 id="3、Optional加强"><a href="#3、Optional加强" class="headerlink" title="3、Optional加强"></a>3、Optional加强</h2><p>Optional增加了几个方法，Java 9-11新增的方法：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">新增方法</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">新增的版本</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>booleanisEmpty()</code></td>
<td style="text-align:left">判断<code>value</code>是否为空</td>
<td style="text-align:left">JDK 11</td>
</tr>
<tr>
<td style="text-align:left"><code>ifPresentOrElse(Consumer&lt;superT&gt; action, Runnable emptyAction)</code></td>
<td style="text-align:left"><code>value</code>非空，执行参数1功能；如果<code>value</code>为空，执行参数2功能</td>
<td style="text-align:left">JDK 9</td>
</tr>
<tr>
<td style="text-align:left"><code>Optional&lt;T&gt; or (Supplier&lt;?extends Optional&lt;?extendsT&gt;&gt;supplier)</code></td>
<td style="text-align:left"><code>value</code>非空，返回对应的<code>Optional</code>；<code>value</code>为空，返回形参封装的<code>Optional</code></td>
<td style="text-align:left">JDK 9</td>
</tr>
<tr>
<td style="text-align:left"><code>Stream&lt;T&gt;stream()</code></td>
<td style="text-align:left"><code>value</code>非空，返回仅包含此<code>value</code>的<code>Stream</code>；否则，返回一个空的<code>Stream</code></td>
<td style="text-align:left">JDK 9</td>
</tr>
<tr>
<td style="text-align:left"><code>TorElseThrow()</code></td>
<td style="text-align:left"><code>value</code>非空，返回<code>value</code>；否则抛异常<code>NoSuchElementException</code></td>
<td style="text-align:left">JDK 10</td>
</tr>
</tbody>
</table>
</div>
<h2 id="4、局部变量类型推断升级"><a href="#4、局部变量类型推断升级" class="headerlink" title="4、局部变量类型推断升级"></a>4、局部变量类型推断升级</h2><p>新增了在<code>var</code>上添加注解的语法格式：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Consumer&lt;String&gt; con = (<span class="hljs-meta">@Deprecated</span> <span class="hljs-keyword">var</span> t) -&gt; <br>    System.out.println(t.toUpperCase());<br></code></pre></td></tr></tbody></table></figure>
<h2 id="5、全新的HTTP客户端API"><a href="#5、全新的HTTP客户端API" class="headerlink" title="5、全新的HTTP客户端API"></a>5、全新的HTTP客户端API</h2><p>Java9开始引入的处理HTTP请求的HTTPClient API，该API支持同步和异步，在Java11中已经为正式可用状态，可以在<code>java.net</code>包中找到这个API。</p>
<p>它将替代仅适用于blocking模式的<code>HttpURLConnection</code>（<code>HttpURLConnection</code>是在HTTP1.0的时代创建的，并使用了协议无关的方法），并提供对WebSocket和HTTP/2的支持。</p>
<p>代码实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>{<br>    <span class="hljs-comment">//HttpClient替换原有的HttpURLConnection。</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">try</span> {<br>            HttpClient client = HttpClient.newHttpClient();<br>            HttpRequest request = HttpRequest.newBuilder(<br>                URI.create(<span class="hljs-string">"http://127.0.0.1:8080/test/"</span>)).build();<br>            HttpResponse.BodyHandler&lt;String&gt; responseBodyHandler = <br>                HttpResponse.BodyHandlers.ofString();<br>            HttpResponse&lt;String&gt; response = client.send(<br>                request, responseBodyHandler);<br>            String body = response.body();<br>            System.out.println(body);<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>            e.printStackTrace();<br>        }<br>    }<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test5</span><span class="hljs-params">()</span></span>{<br>        HttpClient client = HttpClient.newHttpClient();<br>        HttpRequest request = HttpRequest.newBuilder(<br>            URI.create(<span class="hljs-string">"http://127.0.0.1:8080/test/"</span>)).build();<br>        HttpResponse.BodyHandler&lt;String&gt; responseBodyHandler = <br>            HttpResponse.BodyHandlers.ofString();<br>        CompletableFuture&lt;HttpResponse&lt;String&gt;&gt; sendAsync = <br>            client.sendAsync(request, responseBodyHandler);<br>        sendAsync.thenApply(t -&gt; t.body()).<br>            thenAccept(System.out::println);<br>        <span class="hljs-comment">//HttpResponse&lt;String&gt; response = sendAsync.get();</span><br>        <span class="hljs-comment">//String body = response.body();</span><br>        <span class="hljs-comment">//System.out.println(body);</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="6、更简化的编译运行程序"><a href="#6、更简化的编译运行程序" class="headerlink" title="6、更简化的编译运行程序"></a>6、更简化的编译运行程序</h2><p>传统的编译运行过程：</p>
<p>①编译：<code>javac hello.java</code>，生成字节码文件<code>hello.class</code></p>
<p>②运行：<code>java hello</code>，运行字节码文件</p>
<p>Java 11中简化了编译运行过程，以上两步可以使用<code>java hello.java</code>一步代替。</p>
<p>使用简化命令的要求：</p>
<ul>
<li>执行源文件的第一个类，第一个类必须包含主方法。</li>
<li>不可以使用其他源文件中的自定义类，可以使用本文件中的自定义类。</li>
</ul>
<h2 id="7、废弃Nashorn引擎"><a href="#7、废弃Nashorn引擎" class="headerlink" title="7、废弃Nashorn引擎"></a>7、废弃Nashorn引擎</h2><p>Java 11废弃了Nashorn引擎，可以考虑使用GraalVM</p>
<h2 id="8、ZGC"><a href="#8、ZGC" class="headerlink" title="8、ZGC"></a>8、ZGC</h2><p><strong>GC是Java的主要优势之一</strong>。GC停顿太长，会影响应用的响应时间，消除或者减少GC停顿时长，java将对更广泛的应用场景是一个更有吸引力的平台。随着现代系统可用内存不断增长，用户希望JVM能够以高效的方式利用这些内存，并且无需长时间的GC暂停时间。</p>
<p><strong>ZGC（A ScalableLow-Latency Garbage Collector(Experimental)  ）</strong>，是JDK11最为瞩目的特性。</p>
<p>ZGC是一个并发，基于region，压缩型的垃圾收集器，只有root扫描阶段会STW(stop the world)，因此GC停顿时间不会随着堆的增长和存活对象的增长而变长。</p>
<p><strong>ZGC优势</strong>：</p>
<ul>
<li>GC暂停时间不会超过10ms。</li>
<li>既能处理几百兆的小堆,也能处理几个T的大堆(OMG)。</li>
<li>和G1相比,应用吞吐能力不会下降超过15%。</li>
<li>为未来的GC功能和利用colord指针以及Load barriers优化奠定基础。</li>
<li>初始只支持64位系统。</li>
</ul>
<p>ZGC的<strong>设计目标</strong>是：支持TB级内存容量，暂停时间低（&lt;10ms），对整个程序吞吐量的影响小于15%。将来还可以扩展实现机制，以支持不少令人兴奋的功能，例如多层堆（即热对象置于DRAM和冷对象置于NVMe闪存），或压缩堆。</p>
<h2 id="9、其他新特性"><a href="#9、其他新特性" class="headerlink" title="9、其他新特性"></a>9、其他新特性</h2><p>Java 11的其他新特征：</p>
<ul>
<li>Unicode10</li>
<li>Deprecate the Pack200 Tools and API</li>
<li>新的Epsilon垃圾收集器</li>
<li>完全支持Linux容器（包括Docker）</li>
<li>支持G1上的并行完全垃圾收集</li>
<li>最新的HTTPS安全协议TLS1.3</li>
<li>Java Flight Recorder</li>
</ul>
<h1 id="四、总结展望"><a href="#四、总结展望" class="headerlink" title="四、总结展望"></a>四、总结展望</h1><h2 id="1、标准化和轻量级的JSON-API"><a href="#1、标准化和轻量级的JSON-API" class="headerlink" title="1、标准化和轻量级的JSON API"></a>1、标准化和轻量级的JSON API</h2><p>一个标准化和轻量级的JSON API被许多Java开发人员所青睐。但是由于资金问题无法在Java当前版本中见到，但并不会削减掉。Java平台首席架构师Mark Reinhold在JDK9邮件列中说：“这个JEP将是平台上的一个有用的补充，但是在计划中，它并不像Oracle资助的其他功能那么重要，可能会重新考虑JDK10或更高版本中实现。”</p>
<h2 id="2、新的货币API"><a href="#2、新的货币API" class="headerlink" title="2、新的货币API"></a>2、新的货币API</h2><p>对许多应用而言货币价值都是一个关键的特性，但JDK对此却几乎没有任何支持。严格来讲，现有的<code>java.util.Currency</code>类只是代表了当前ISO4217货币的一个数据结构，但并没有关联的值或者自定义货币。</p>
<p>JDK对货币的运算及转换也没有内建的支持，更别说有一个能够代表货币值的标准类型了。</p>
<p>如果用Maven的话，可以做如下的添加，即可使用相关的API处理货币：</p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs java">&lt;dependency&gt;<br>    &lt;groupId&gt;org.javamoney&lt;/groupId&gt;<br>    &lt;artifactId&gt;moneta&lt;/artifactId&gt;<br>    &lt;version&gt;0.9&lt;/version&gt;<br>&lt;/dependency&gt;<br></code></pre></td></tr></tbody></table></figure>
<h1 id="3、展望"><a href="#3、展望" class="headerlink" title="3、展望"></a>3、展望</h1><ul>
<li>随着云计算和AI等技术浪潮，当前的计算模式和场景正在发生翻天覆地的变化，不仅对Java的发展速度提出了更高要求，也深刻影响着Java技术的发展方向。传统的大型企业或互联网应用，正在被云端、容器化应用、模块化的微服务甚至是函数(FaaS，Function-as-a-Service)所替代。</li>
<li>Java虽然标榜面向对象编程，却毫不顾忌的加入面向接口编程思想，又扯出匿名对象之概念，每增加一个新的东西，对Java的根本所在的面向对象思想的一次冲击。反观Python，抓住面向对象的本质，又能在函数编程思想方面游刃有余。<strong>Java对标C/C++，以抛掉内存管理为卖点，却又陷入了JVM优化的噩梦</strong>。选择比努力更重要，选择Java的人更需要对它有更清晰的认识。</li>
<li><strong>Java需要在新的计算场景下，改进开发效率</strong>。这话说的有点笼统，我谈一些自己的体会，Java代码虽然进行了一些类型推断等改进，更易用的集合API等，但仍然给开发者留下了过于刻板、形式主义的印象，这是一个长期的改进方向。</li>
</ul>
<h1 id="五、Reference"><a href="#五、Reference" class="headerlink" title="五、Reference"></a>五、Reference</h1><p>Java笔记系列，参考自<a href="https://www.gulixueyuan.com/">尚硅谷Java核心教程</a>，衷心感谢。</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>10种常用排序算法总结</title>
    <url>/2020/12/27/rank-algorithm/</url>
    <content><![CDATA[<h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>本文整理了常见的十种排序算法，介绍了其原理。开头先介绍几个相关的概念，然后是几种算法的复杂度以及稳定性的比较。</p>
<h2 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h2><ul>
<li><strong>稳定排序</strong>：如果排序前a在b前面,且a和b相等，排序后a也在b的前面，称为稳定排序。</li>
<li><strong>不稳定排序</strong>：和稳定排序相反，如果排序后a在b的后面，则为不稳定排序。</li>
<li><strong>原地排序</strong>：排序过程中不申请多余的存储空间，只利用原来存储待排数据的存储空间进行比较和交换的数据排序。</li>
<li><strong>非原地排序</strong>：需要利用额外的数组来辅助排序。</li>
<li><strong>比较类排序</strong>：通过比较来决定元素间的相对次序，时间复杂度不能突破<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg>，因此也被称为非线性时间比较类排序。</li>
<li><strong>非比较排序</strong>：不通过比较来决定元素间的相对次序，可以突破基于比较排序的时间下界，以线性时间运行，因此也称为线性时间非比较排序。</li>
</ul>
<blockquote>
<p>本文中的<strong>计数排序</strong>、<strong>桶排序</strong>、<strong>基数排序</strong>属于非比较排序，其余的七种排序方法都是比较类排序。</p>
</blockquote>
<h2 id="算法概述"><a href="#算法概述" class="headerlink" title="算法概述"></a>算法概述</h2><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">排序算法</th>
<th style="text-align:center">平均时间复杂度</th>
<th style="text-align:center">最好情况</th>
<th style="text-align:center">最坏情况</th>
<th style="text-align:center">空间复杂度</th>
<th style="text-align:center">排序方式</th>
<th style="text-align:center">稳定性</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">冒泡排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.977ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2143 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1753" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">In-place</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">选择排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">In-place</td>
<td style="text-align:center">不稳定</td>
</tr>
<tr>
<td style="text-align:center">插入排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.977ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2143 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1753" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">In-place</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">希尔排序*</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.311ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 3147.7 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^{1.3})</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMAIN-33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
<g transform="translate(600,412)">
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-2E" x="500" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-33" x="779" y="0"></use>
</g>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2758" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.977ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2143 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1753" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">In-place</td>
<td style="text-align:center">不稳定</td>
</tr>
<tr>
<td style="text-align:center">归并排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.977ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2143 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1753" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">Out-place</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">快速排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.336ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3589.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="2599" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3199" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">In-place</td>
<td style="text-align:center">不稳定</td>
</tr>
<tr>
<td style="text-align:center">堆排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">In-place</td>
<td style="text-align:center">不稳定</td>
</tr>
<tr>
<td style="text-align:center">计数排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.794ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2064 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1674" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">Out-place</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">桶排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.977ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2143 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1753" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">Out-place</td>
<td style="text-align:center">稳定</td>
</tr>
<tr>
<td style="text-align:center">基数排序</td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\times k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-D7" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\times k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-D7" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\times k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-D7" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></td>
<td style="text-align:center">Out-place</td>
<td style="text-align:center">稳定</td>
</tr>
</tbody>
</table>
</div>
<blockquote>
<p>希尔排序算法的时间复杂度需要根据所选的增量决定。</p>
</blockquote>
<p>下面从小到大排序为例，介绍各种排序算法的原理及其代码实现，如无特殊说明，算法演示图片来自文末的参考文章。</p>
<h1 id="选择排序-Select-Sort"><a href="#选择排序-Select-Sort" class="headerlink" title="选择排序(Select Sort)"></a>选择排序(Select Sort)</h1><p><strong>算法原理：</strong></p>
<ul>
<li>从整个序列中找到最小的元素，和第一个元素交换位置。</li>
<li>从剩下的未排序的元素中找到最小元素，未排序的第一个元素交换位置。</li>
<li>重复第二步，不断地将未排序的最小值放到前面，直到所有元素均排列完毕。</li>
</ul>
<p><strong>动画演示：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank1.gif"><span class="image-caption">选择排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SelectSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] selectSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++){<br>            <span class="hljs-keyword">int</span> min = i; <span class="hljs-comment">//记录最小值的位置</span><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=i+<span class="hljs-number">1</span>;j&lt;len;j++){  <span class="hljs-comment">//从i之后的范围遍历查找</span><br>                <span class="hljs-keyword">if</span> (nums[j]&lt;nums[min]) min=j;  <span class="hljs-comment">//如果找到更小的值，记录索引</span><br>            }<br>            <span class="hljs-keyword">int</span> temp = nums[i];  <span class="hljs-comment">//交换两元素的位置</span><br>            nums[i] = nums[min];<br>            nums[min] = temp;<br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分析：</strong></p>
<ul>
<li><p>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></p>
</li>
<li><p>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></p>
</li>
<li><p>不稳定排序</p>
</li>
<li><p>原地排序</p>
</li>
</ul>
<h1 id="插入排序-Insert-Sort"><a href="#插入排序-Insert-Sort" class="headerlink" title="插入排序(Insert Sort)"></a>插入排序(Insert Sort)</h1><p><strong>算法原理：</strong></p>
<ul>
<li>将待排序列第一个元素看作有序序列，从第2个元素开始依次抽取元素。</li>
<li>将抽取的元素与其左边第一个元素比较，如果左边第一个元素比它大，则继续与左边第二个元素比较，直到找到比它小的元素(或者已经到达序列头部)，插入这个元素的右边。</li>
<li>继续选取第3,4，…n个元素，重复步骤二，并将其插入适当的位置。</li>
</ul>
<p><strong>动画演示：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank2.gif"><span class="image-caption">插入排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InsertSort</span></span>{<br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] insertSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">if</span>(nums==<span class="hljs-keyword">null</span>||nums.length&lt;<span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> nums;<span class="hljs-comment">//如果数组为空或只有一个元素，直接返回</span><br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;len;i++){  <span class="hljs-comment">//从下标为1的元素开始遍历，第0个元素默认是有序的</span><br>            <span class="hljs-keyword">int</span> cur = nums[i];  <span class="hljs-comment">//记录当前值</span><br>            <span class="hljs-keyword">int</span> index = i-<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">while</span>(index&gt;=<span class="hljs-number">0</span> &amp;&amp; cur&lt;nums[index]){<span class="hljs-comment">//往左遍历，直到找到一个比cur小的元素</span><br>                index -= <span class="hljs-number">1</span>;<br>            }<span class="hljs-comment">//要插入的位置是index+1</span><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=i;j&gt;index+<span class="hljs-number">1</span>;j--){ <span class="hljs-comment">//将index+1和i之间的元素后移一位</span><br>                nums[j] = nums[j-<span class="hljs-number">1</span>];<br>            }<br>            nums[index+<span class="hljs-number">1</span>] = cur;  <span class="hljs-comment">//将cur插入到index+1的位置</span><br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分析：</strong></p>
<ul>
<li><p>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></p>
</li>
<li><p>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></p>
</li>
<li><p>稳定排序</p>
</li>
<li><p>原地排序</p>
</li>
</ul>
<h1 id="冒泡排序-Bubble-Sort"><a href="#冒泡排序-Bubble-Sort" class="headerlink" title="冒泡排序(Bubble Sort)"></a>冒泡排序(Bubble Sort)</h1><p><strong>算法原理：</strong></p>
<ul>
<li>比较相邻的两个元素，如果第一个比第二个大，就交换他们两个。</li>
<li>对每一对相邻元素作同样的工作，从开始的一对到最后一对，执行完一遍后，末尾的元素是最大的值。</li>
<li>对于最后一个元素外的其他元素，同样执行步骤二的操作。</li>
<li>重复以上步骤，直到排序完成。</li>
</ul>
<p><strong>动画演示：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank3.gif"><span class="image-caption">冒泡排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BubbleSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] bubbleSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-comment">//每次外层循环一次之后，最后的元素是最大的</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++){<span class="hljs-comment">//i控制已经排序的个数，长度为len的序列需要循环len次</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>;j&lt;len-i-<span class="hljs-number">1</span>;j++){ <span class="hljs-comment">//对未排序的序列进行比较</span><br>                <span class="hljs-keyword">if</span>(nums[j]&gt;nums[j+<span class="hljs-number">1</span>]){<br>                    <span class="hljs-keyword">int</span> temp = nums[j];<br>                    nums[j] = nums[j+<span class="hljs-number">1</span>];<br>                    nums[j+<span class="hljs-number">1</span>] = temp;<br>                }<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上面代码的缺陷是无论序列有没有序，循环次数总是固定的，如果一个序列本来就是从小到大排好序的，按照上述代码两层循环的次数不变。因此可以做进一步的优化，在内层循环中，如果从第一对元素到最后一对元素，都没有发生交换操作，说明序列是有序的，无需对剩余的元素重复比较下去了。</p>
<p>代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BubbleSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] bubbleSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-comment">//每次外层循环一次之后，最后的元素是最大的</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++){<span class="hljs-comment">//i控制已经排序的个数，长度为len的序列需要循环len次</span><br>            <span class="hljs-keyword">boolean</span> flag = <span class="hljs-keyword">true</span>;  <span class="hljs-comment">//使用flag记录是否发生交换</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>;j&lt;len-i-<span class="hljs-number">1</span>;j++){ <span class="hljs-comment">//对未排序的序列进行比较</span><br>                <span class="hljs-keyword">if</span>(nums[j]&gt;nums[j+<span class="hljs-number">1</span>]){<br>                    flag = <span class="hljs-keyword">false</span>;  <span class="hljs-comment">//如果发生交换，则flag变为false</span><br>                    <span class="hljs-keyword">int</span> temp = nums[j];<br>                    nums[j] = nums[j+<span class="hljs-number">1</span>];<br>                    nums[j+<span class="hljs-number">1</span>] = temp;<br>                }<br>            }<br>            <span class="hljs-comment">//如果一轮循环下来，没有发生元素交换，说明元素有序，之间跳出循环</span><br>            <span class="hljs-keyword">if</span>(flag) <span class="hljs-keyword">break</span>;<br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分析：</strong></p>
<ul>
<li>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg></li>
<li>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></li>
<li>稳定排序</li>
<li>原地排序</li>
</ul>
<h1 id="希尔排序-Shell-Sort"><a href="#希尔排序-Shell-Sort" class="headerlink" title="希尔排序(Shell Sort)"></a>希尔排序(Shell Sort)</h1><p><strong>希尔排序(Shell Sort)</strong>是简单插入排序的改进版，先比较距离较远的元素，进行宏观调控。希尔排序又叫<strong>缩小增量排序</strong></p>
<p><strong>算法原理：</strong></p>
<ul>
<li>首先将序列分为间隔为gap的几组元素，每组使用插入排序的方法排序。</li>
<li>缩小h的值，比如第一次可以是gap=n/2，第二次gap=n/4，…，直到gap=1，重复步骤一的操作。</li>
<li>gap=1的时候，排序完以后说明序列中任意间隔为1的元素有序，此时的序列就是有序的了。</li>
</ul>
<p><strong>动画演示：</strong>（图源水印）</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank4.gif"><span class="image-caption">希尔排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShellSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] shellSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> gap=len/<span class="hljs-number">2</span>; gap&gt;<span class="hljs-number">0</span>; gap=gap/<span class="hljs-number">2</span>){<span class="hljs-comment">//这里的间隔值每次取上一次的二分之一</span><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=gap; i&lt;len; i++){ <span class="hljs-comment">//这里交替对每个分组执行插入排序</span><br>                <span class="hljs-keyword">int</span> cur = nums[i]; <span class="hljs-comment">//记录当前值</span><br>                <span class="hljs-keyword">int</span> j = i;<br>                <span class="hljs-comment">//对于当前分组的当前值cur，找到其在当前分组中合适的位置，进行插入排序</span><br>                <span class="hljs-keyword">while</span>(j&gt;=gap &amp;&amp; nums[j-gap]&gt;cur){<br>                    nums[j] = nums[j-gap]; <span class="hljs-comment">//将大于cur的值后移</span><br>                    j=j-gap;<br>                }<br>                nums[j] = cur; <span class="hljs-comment">//最后将cur插入到合适的位置</span><br>            }<br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>代码中，是轮流对每个分组进行排序，而不是单独对一个分组插入排序完再排序另一个。</p>
</blockquote>
<p><strong>分析：</strong></p>
<ul>
<li>时间复杂度：一般为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg>，具体根据gap设置的大小决定。</li>
<li>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></li>
<li>不稳定排序</li>
<li>原地排序</li>
</ul>
<h1 id="归并排序-Merge-Sort"><a href="#归并排序-Merge-Sort" class="headerlink" title="归并排序(Merge Sort)"></a>归并排序(Merge Sort)</h1><p><strong>算法原理：</strong></p>
<ul>
<li>利用分治的思想。如果数组只有一个元素，直接返回。</li>
<li>将数组均分为两部分(分)。</li>
<li>对于两部分分别进行归并排序(治)。</li>
<li>将两部分排好序的数组合并在一起，类似于两个有序链表合并。</li>
</ul>
<p><strong>动画演示：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank5.gif"><span class="image-caption">归并算法图解</span></p>
<p><strong>代码实现：</strong></p>
<p>递归版本：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MergeSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] mergeSort(<span class="hljs-keyword">int</span>[] nums,<span class="hljs-keyword">int</span> left,<span class="hljs-keyword">int</span> right){<br>        <span class="hljs-keyword">if</span>(left==right) <span class="hljs-keyword">return</span> nums; <span class="hljs-comment">//如果数组只有一个值，直接返回</span><br>        <span class="hljs-keyword">int</span> mid = left+(right-left)/<span class="hljs-number">2</span>;<span class="hljs-comment">//这里取中值的方法没有直接求和然后除以2，防止数据溢出</span><br>        mergeSort(nums,left,mid);  <span class="hljs-comment">//递归调用，对左半部分进行排序</span><br>        mergeSort(nums,mid+<span class="hljs-number">1</span>,right); <span class="hljs-comment">//递归调用，对右半部分进行排序</span><br>        merge(nums,left,mid,right);<span class="hljs-comment">//对两部分进行合并</span><br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>    <span class="hljs-comment">//merge函数，将两个有序数组合并，类似于合并两个有序链表</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums,<span class="hljs-keyword">int</span> left,<span class="hljs-keyword">int</span> mid,<span class="hljs-keyword">int</span> right)</span></span>{<br>        <span class="hljs-comment">//合并两个有序数组，即nums[left,mid]和nums[mid+1,right]</span><br>        <span class="hljs-keyword">int</span>[] temp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[right-left+<span class="hljs-number">1</span>];<span class="hljs-comment">//临时存放合并后的数组</span><br>        <span class="hljs-keyword">int</span> m = left; <span class="hljs-comment">//第一个数组的指针</span><br>        <span class="hljs-keyword">int</span> n = mid+<span class="hljs-number">1</span>; <span class="hljs-comment">//第二个数组的指针</span><br>        <span class="hljs-keyword">int</span> index = <span class="hljs-number">0</span>;  <span class="hljs-comment">//指向临时数组temp</span><br>        <span class="hljs-keyword">while</span>(m&lt;=mid &amp;&amp; n&lt;=right){<br>            <span class="hljs-keyword">if</span>(nums[m]&lt;nums[n]) temp[index++] = nums[m++]; <span class="hljs-comment">//将较小的值加到temp数组中</span><br>            <span class="hljs-keyword">else</span> temp[index++] = nums[n++];<br>        }<br>        <span class="hljs-comment">//将没遍历完的数组直接添加到temp数组中</span><br>        <span class="hljs-keyword">while</span>(m&lt;=mid) temp[index++] = nums[m++]; <br>        <span class="hljs-keyword">while</span> (n&lt;=right) temp[index++] = nums[n++];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i:temp) nums[left++] = i; <span class="hljs-comment">//将临时数组的值复制到nums数组中，表示合并结束</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>非递归版本：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MergeSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] mergeSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;len;i=i+i){<span class="hljs-comment">//子数组的大小分别为1,2,4,8,...</span><br>            <span class="hljs-keyword">int</span> left = <span class="hljs-number">0</span>;<span class="hljs-comment">//对数组进行划分</span><br>            <span class="hljs-keyword">int</span> mid = left+i-<span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">int</span> right = mid+i;<br>            <span class="hljs-keyword">while</span> (right&lt;len){<span class="hljs-comment">//对大小为i的数组两两合并</span><br>                merge(nums,left,mid,right); <span class="hljs-comment">//合并函数和之前一样</span><br>                left = right+<span class="hljs-number">1</span>;<br>                mid = left+i-<span class="hljs-number">1</span>;<br>                right = mid+i;<br>            }<br>            <span class="hljs-keyword">if</span>(left&lt;len &amp;&amp; mid&lt;len){<span class="hljs-comment">//有一些大小不足i的范围，也要合并起来</span><br>                merge(nums,left,mid,len-<span class="hljs-number">1</span>);<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>    <span class="hljs-comment">//merge函数，将两个有序数组合并，类似于合并两个有序链表</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">merge</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums,<span class="hljs-keyword">int</span> left,<span class="hljs-keyword">int</span> mid,<span class="hljs-keyword">int</span> right)</span></span>{<br>        <span class="hljs-comment">//合并两个有序数组，即nums[left,mid]和nums[mid+1,right]</span><br>        <span class="hljs-keyword">int</span>[] temp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[right-left+<span class="hljs-number">1</span>];<span class="hljs-comment">//临时存放合并后的数组</span><br>        <span class="hljs-keyword">int</span> m = left; <span class="hljs-comment">//第一个数组的指针</span><br>        <span class="hljs-keyword">int</span> n = mid+<span class="hljs-number">1</span>; <span class="hljs-comment">//第二个数组的指针</span><br>        <span class="hljs-keyword">int</span> index = <span class="hljs-number">0</span>;  <span class="hljs-comment">//指向临时数组temp</span><br>        <span class="hljs-keyword">while</span>(m&lt;=mid &amp;&amp; n&lt;=right){<br>            <span class="hljs-keyword">if</span>(nums[m]&lt;nums[n]) temp[index++] = nums[m++]; <span class="hljs-comment">//将较小的值加到temp数组中</span><br>            <span class="hljs-keyword">else</span> temp[index++] = nums[n++];<br>        }<br>        <span class="hljs-comment">//将没遍历完的数组直接添加到temp数组中</span><br>        <span class="hljs-keyword">while</span>(m&lt;=mid) temp[index++] = nums[m++]; <br>        <span class="hljs-keyword">while</span> (n&lt;=right) temp[index++] = nums[n++];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i:temp) nums[left++] = i; <span class="hljs-comment">//将临时数组的值复制到nums数组中，表示合并结束</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分析：</strong></p>
<ul>
<li>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></li>
<li>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.977ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2143 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1753" y="0"></use>
</g>
</svg></li>
<li>稳定排序</li>
<li>非原地排序</li>
</ul>
<h1 id="快速排序-Quick-Sort"><a href="#快速排序-Quick-Sort" class="headerlink" title="快速排序(Quick Sort)"></a>快速排序(Quick Sort)</h1><p>快排也是一个分治的算法，每次选择一个元素作为<strong>基准(pivot)</strong>，然后将序列根据pivot分为两部分，pivot此时是有序的，不需要再次移动。然后递归对两部分序列操作。</p>
<p>与归并排序不同的是，快排<strong>不需要额外的辅助空间</strong>和将排序好的<strong>临时序列的值复制到原序列</strong>的时间，因此一般比归并排序要快。</p>
<p><strong>算法原理：</strong></p>
<ul>
<li>从序列中挑出一个元素，作为基准(pivot)。选择基准值的方法有多种，可以一直挑选第一个或最后一个元素，也可以随机选择或者取中间值等。</li>
<li>重新排列序列，将所有大于pivot的元素放到其后面，所有小于pivot的元素放到其前面。然后pivot就位于中间位置，其已经是有序的，不需要再移动。这个称为<strong>分区(partition</strong>)操作。</li>
<li>通过递归，将pivot左右两边的序列同样根据步骤二排列。直到序列的大小为1，递归终止。</li>
</ul>
<blockquote>
<p>实际操作的时候可以使用两个指针从两边开始遍历，只有两个指针指向的值同时需要移动的时候，交换两个值，这样可以减少交换次数，节省时间。</p>
</blockquote>
<p><strong>动画演示：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank6.gif"><span class="image-caption">快速排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QuickSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] quickSort(<span class="hljs-keyword">int</span>[] nums,<span class="hljs-keyword">int</span> left,<span class="hljs-keyword">int</span> right){<br>        <span class="hljs-keyword">if</span> (left&gt;=right) <span class="hljs-keyword">return</span> nums; <span class="hljs-comment">//当前范围非法或者只有一个元素的时候直接返回</span><br>        <span class="hljs-keyword">int</span> mid = partition(nums,left,right); <span class="hljs-comment">//获取pivot的所在位置</span><br>        quickSort(nums,left,mid-<span class="hljs-number">1</span>); <span class="hljs-comment">//以pivot为中心，对左右两边递归</span><br>        quickSort(nums,mid+<span class="hljs-number">1</span>,right);<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>    <span class="hljs-comment">//根据pivot元素将序列分为左右两部分</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">partition</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums, <span class="hljs-keyword">int</span> left, <span class="hljs-keyword">int</span> right)</span></span>{<br>        <span class="hljs-keyword">int</span> pivot = nums[right]; <span class="hljs-comment">//这里一直选用最右边的元素作为基准元素</span><br>        <span class="hljs-keyword">int</span> i = left; <span class="hljs-comment">//定义i，j两个指针，分别从左右两边往中间遍历</span><br>        <span class="hljs-keyword">int</span> j = right-<span class="hljs-number">1</span>; <span class="hljs-comment">//因为最右边的元素已经是基准元素了，所以需要往左一位</span><br>        <span class="hljs-keyword">while</span>(<span class="hljs-keyword">true</span>){<br>            <span class="hljs-comment">//这里判断条件包括等号，不然会出现两个相同的值重复交换陷入死循环的情况。</span><br>            <span class="hljs-keyword">while</span>(i&lt;=j &amp;&amp; nums[i]&lt;=pivot) i += <span class="hljs-number">1</span>;<span class="hljs-comment">//左指针向右遍历，直到找到一个大于pivot的值</span><br>            <span class="hljs-keyword">while</span>(i&lt;=j &amp;&amp; nums[j]&gt;=pivot) j -= <span class="hljs-number">1</span>;<span class="hljs-comment">//右指针向左遍历，直到找到一个小于pivot的值</span><br>            <span class="hljs-keyword">if</span>(i&gt;=j) <span class="hljs-keyword">break</span>;<br>            swap(nums,i,j);<span class="hljs-comment">//交换两个指针指向的元素的位置</span><br>        }<br>        <span class="hljs-comment">//将序列根据pivot划分为两部分后，将pivot的值放到分界点的位置</span><br>        nums[right] = nums[i];<span class="hljs-comment">//如果一直选用最右边元素，则和i交换，如果是选最左边，则和j交换</span><br>        nums[i] = pivot;<br>        <span class="hljs-keyword">return</span> i;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums, <span class="hljs-keyword">int</span> i, <span class="hljs-keyword">int</span> j)</span> </span>{ <span class="hljs-comment">//用于交换两个值</span><br>        <span class="hljs-keyword">int</span> temp = nums[i];<br>        nums[i] = nums[j];<br>        nums[j] = temp;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上述的快排函数是从两端开始遍历，也可以使用两个指针从一端开始遍历：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//使用两个指针，从一端开始遍历</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">partition</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums, <span class="hljs-keyword">int</span> left, <span class="hljs-keyword">int</span> right)</span> </span>{<br>        <span class="hljs-keyword">int</span> pivot = nums[right]; <span class="hljs-comment">//选用最右边的元素作为基准值</span><br>        <span class="hljs-keyword">int</span> i = left - <span class="hljs-number">1</span>; <span class="hljs-comment">//每交换一次，i都+1，表示小于基准值的元素+1</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = left; j &lt;= right - <span class="hljs-number">1</span>; ++j) {<br>            <span class="hljs-keyword">if</span> (nums[j] &lt;= pivot) { <span class="hljs-comment">//从最左边开始遍历，不断地把小于基准值的元素放到左边</span><br>                i = i + <span class="hljs-number">1</span>;<br>                swap(nums, i, j);<br>            }<br>        }<br>        <span class="hljs-comment">//最后，下标为i和小于i的元素都是小于基准值的元素，将基准值和i+1交换位置</span><br>        swap(nums, i + <span class="hljs-number">1</span>, right);<br>        <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span>;<span class="hljs-comment">//交换位置后，i+1表示排序后基准值的位置</span><br>    }<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>如果序列近乎有序，每次选取第一个数或者最后一个数作为基准的方法时间复杂度会接近<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.032ex" height="3.176ex" style="vertical-align: -0.838ex;" viewBox="0 -1006.6 2596.9 1367.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n^2)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMATHI-6E" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="849" y="583"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="2207" y="0"></use>
</g>
</svg>，因此需要随机选取基准点。</p>
<p>如果是随机选取基准点，需要在<code>int pivot = nums[right];</code>语句前，将随机选取的值放到最右边或最左边，其余代码不变：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">int</span> random_index = <span class="hljs-keyword">new</span> Random().nextInt(right-left+<span class="hljs-number">1</span>)+left; <span class="hljs-comment">//随机选取下标</span><br>swap(nums,right,random_index); <span class="hljs-comment">//然后将选取的基准值放到最右边</span><br><span class="hljs-keyword">int</span> pivot = nums[right]; <span class="hljs-comment">//将此时最右边的元素作为基准值，也就是随机选取的基准值</span><br></code></pre></td></tr></tbody></table></figure>
</blockquote>
<p><strong>分析：</strong></p>
<ul>
<li>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></li>
<li>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="8.336ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3589.2 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
<g transform="translate(1153,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="2599" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3199" y="0"></use>
</g>
</svg></li>
<li>非稳定排序</li>
<li>原地排序</li>
</ul>
<h1 id="堆排序-Heap-Sort"><a href="#堆排序-Heap-Sort" class="headerlink" title="堆排序(Heap Sort)"></a>堆排序(Heap Sort)</h1><p><strong>堆排序(Heapsort)</strong>是利用<strong>二叉堆</strong>的一种排序方法。二叉堆除了具有完全二叉树的特征外，所有父节点的值都大于或小于它的孩子节点。其中所有父节点的值都大于其孩子节点的堆叫做<strong>最大堆(大顶堆)</strong>，反之称为<strong>最小堆(小顶堆)</strong>。所以说，最大堆的堆顶元素即整个堆的最大值，最小堆的堆顶元素是堆的最小值，堆排序正是利用了二叉堆的这一特征。</p>
<blockquote>
<p>二叉堆实现是采用<strong>数组</strong>的形式来存储的，假设一个节点的下标为n，则其左孩子和右孩子节点的下标分别为2n+1、2n+2。</p>
<p>二叉堆每次添加元素都是添加到最后一个位置，即数组最后，然后使用<strong>上浮</strong> 的方法再调整。</p>
<p>二叉堆删除元素是删除堆顶元素，然后把最后一个位置的元素放到堆顶，采用<strong>下沉</strong> 的方法调整。</p>
<p>关于二叉堆的<strong>上浮</strong>和<strong>下沉</strong>操作，可以参考<a href="https://mp.weixin.qq.com/s?__biz=Mzg2NzA4MTkxNQ==&amp;mid=2247485231&amp;idx=1&amp;sn=8dfdc04bd209fba3077269faabe7c36f&amp;source=41#wechat_redirect">二叉堆</a></p>
</blockquote>
<p><strong>算法原理：</strong></p>
<ul>
<li>创建一个最大堆，包含n个节点。</li>
<li>把堆顶(最大值)和堆最后一个位置元素互换(相当于删除堆顶元素)，这样最大值位于最后面。</li>
<li>将堆的大小减1，调整堆，使剩下的n-1个节点保持最大堆的性质。</li>
<li>重复步骤2、3，直到堆的大小为1，此时数组中的元素从小到大排列。</li>
</ul>
<p><strong>动画演示：</strong></p>
<p>图片来自 <a href="https://commons.wikimedia.org/wiki/File:Heap_sort_example.gif">here</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank7.GIF"><span class="image-caption">堆排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HeapSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] headSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-comment">//构建最大堆</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = (len-<span class="hljs-number">2</span>)/<span class="hljs-number">2</span>;i&gt;=<span class="hljs-number">0</span>;i--){<span class="hljs-comment">//i初始化为最后一个元素的父节点</span><br>            heapify(nums,i,len);<span class="hljs-comment">//从最后一个元素的父节点开始调整堆结构，构建最大堆</span><br>        }<br>        <span class="hljs-comment">//进行堆排序，每次交换堆顶和堆尾两个节点，交换完一次就调整一次结构。</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = len-<span class="hljs-number">1</span>;i&gt;=<span class="hljs-number">1</span>;i--){<br>            swap(nums,<span class="hljs-number">0</span>,i);<br>            heapify(nums,<span class="hljs-number">0</span>,i);<span class="hljs-comment">//这里每次传入i，用来表示堆的个数减一</span><br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums,<span class="hljs-keyword">int</span> parent,<span class="hljs-keyword">int</span> len)</span></span>{<span class="hljs-comment">//调整堆结构</span><br>        <span class="hljs-keyword">int</span> largest = parent;<br>        <span class="hljs-keyword">int</span> left = <span class="hljs-number">2</span>*parent+<span class="hljs-number">1</span>;<span class="hljs-comment">//左孩子下标</span><br>        <span class="hljs-keyword">int</span> right = <span class="hljs-number">2</span>*parent+<span class="hljs-number">2</span>;<span class="hljs-comment">//右孩子下标</span><br>        <span class="hljs-keyword">if</span>(left&lt;len &amp;&amp; nums[left]&gt;nums[largest]) largest=left;<span class="hljs-comment">//找到较大的那个值</span><br>        <span class="hljs-keyword">if</span>(right&lt;len &amp;&amp; nums[right]&gt;nums[largest]) largest=right;<br>        <span class="hljs-keyword">if</span>(largest != parent){<span class="hljs-comment">//然后交换最大值和父节点，实现父节点的下沉</span><br>            swap(nums,parent,largest);<br>            heapify(nums,largest,len); <span class="hljs-comment">//一直往下调整，直到父节点是最大值</span><br>        }<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">swap</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums, <span class="hljs-keyword">int</span> i, <span class="hljs-keyword">int</span> j)</span></span>{<span class="hljs-comment">//swap函数用于交换数组的两个值</span><br>        <span class="hljs-keyword">int</span> temp = nums[i];<br>        nums[i] = nums[j];<br>        nums[j] = temp;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上述用于调整堆结构的heapify函数使用了递归的方法，如果不使用递归，可以写成以下形式：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//非递归形式实现调整堆结构</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">heapify</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums,<span class="hljs-keyword">int</span> parent,<span class="hljs-keyword">int</span> len)</span></span>{<br>        <span class="hljs-keyword">int</span> temp = nums[parent];<span class="hljs-comment">//临时保存父节点元素</span><br>        <span class="hljs-keyword">int</span> child = <span class="hljs-number">2</span>*parent+<span class="hljs-number">1</span>;<span class="hljs-comment">//用于指向孩子下标</span><br>        <span class="hljs-keyword">while</span>(child&lt;len){<br>            <span class="hljs-keyword">if</span>(child+<span class="hljs-number">1</span>&lt;len &amp;&amp; nums[child+<span class="hljs-number">1</span>]&gt;nums[child]){<span class="hljs-comment">//寻找左右孩子中较大的值</span><br>                child += <span class="hljs-number">1</span>;<br>            }<br>            <span class="hljs-keyword">if</span>(nums[child]&gt;temp){<span class="hljs-comment">//如果孩子节点比父节点要大，则父节点下沉</span><br>                swap(nums,parent,child);<span class="hljs-comment">//父节点下沉，即交换两个节点的值</span><br>                parent = child; <span class="hljs-comment">//然后把孩子节点作为父节点，继续向下调整</span><br>                child = <span class="hljs-number">2</span>*parent+<span class="hljs-number">1</span>;<br>            }<span class="hljs-keyword">else</span> <span class="hljs-keyword">break</span>; <span class="hljs-comment">//如果父节点已经是最大的了，不必下沉，跳出循环。</span><br>        }<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分析：</strong></p>
<ul>
<li>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg></li>
<li>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.745ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2043 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(1)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMAIN-31" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1653" y="0"></use>
</g>
</svg></li>
<li>非稳定排序</li>
<li>原地排序</li>
</ul>
<h1 id="计数排序-Counting-Sort"><a href="#计数排序-Counting-Sort" class="headerlink" title="计数排序(Counting Sort)"></a>计数排序(Counting Sort)</h1><p><strong>计数排序(counting sort)</strong>是一种适合最大值和最小值的<strong>差值k</strong>不是很大的排序，其核心在于<strong>将输入的数据值转化为键存储在额外开辟的数组空间</strong>中。计数排序要求输入的数据必须是有确定范围的整数。</p>
<p><strong>算法原理：</strong></p>
<ul>
<li>扫描待排序列，找出最大值max和最小值min。</li>
<li>开辟新的数组Res，长度为max-min+1。</li>
<li>以序列中的值为下标，对应数组B中的值为其在整个序列中出现的次数。</li>
<li>遍历数组B，得到每个值的出现次数，并输出。</li>
</ul>
<p><strong>动画演示：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank8.gif"><span class="image-caption">计数排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CountSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] countSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">if</span>(nums==<span class="hljs-keyword">null</span> || nums.length&lt;<span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> nums;<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-keyword">int</span> max = nums[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">int</span> min = nums[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i:nums){<span class="hljs-comment">//遍历数组，得到最大值和最小值</span><br>            <span class="hljs-keyword">if</span>(i&lt;min) min=i;<br>            <span class="hljs-keyword">if</span>(i&gt;max) max=i;<br>        }<br>        <span class="hljs-keyword">int</span> n = max-min+<span class="hljs-number">1</span>; <span class="hljs-comment">//辅助数组的长度</span><br>        <span class="hljs-keyword">int</span>[] temp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[n];<span class="hljs-comment">//建立辅助数组</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i:nums){<span class="hljs-comment">//遍历原数组，获取每个值的出现次数,在辅助数组中记录</span><br>            <span class="hljs-comment">//下标=真实值-最小值</span><br>            temp[i-min] = temp[i-min]+<span class="hljs-number">1</span>; <span class="hljs-comment">//当前值对应于辅助数组中的值+1，表示出现次数+1</span><br>        }<br>        <span class="hljs-comment">//将辅助数组中的值，根据出现次数恢复到原数组中，完成排序</span><br>        <span class="hljs-keyword">int</span> index = <span class="hljs-number">0</span>;<span class="hljs-comment">//用于指向原数组</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;n;i++){ <span class="hljs-comment">//遍历辅助数组</span><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>;j&lt;temp[i];j++){<span class="hljs-comment">//辅助数组中的值作为出现次数，将对应的值恢复到原数组</span><br>                nums[index++] = i+min;<span class="hljs-comment">//下标+最小值=真实值</span><br>            }<br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分析：</strong></p>
<ul>
<li>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></li>
<li>空间复杂度：如果是在原数组的基础上修改，只需要<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.794ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2064 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1674" y="0"></use>
</g>
</svg>的额外空间</li>
<li>稳定排序</li>
<li>非原地排序</li>
</ul>
<h1 id="桶排序-Bucket-Sort"><a href="#桶排序-Bucket-Sort" class="headerlink" title="桶排序(Bucket Sort)"></a>桶排序(Bucket Sort)</h1><p><strong>桶排序</strong>是<strong>计数排序</strong>的升级版，它利用一定的函数映射关系，划分出多个桶，将序列中的值放入对应的桶中，然后各个桶内元素再排序(递归或其他排序方法)。桶排序要求数据分布均匀。</p>
<blockquote>
<p>需要根据待排序列的数据特征，选择合适的分桶方法。</p>
</blockquote>
<p><strong>算法原理：</strong></p>
<ul>
<li>根据一定方法，划分出n个桶。</li>
<li>将数据放入对应的桶中。</li>
<li>对每个桶中的数据进行排序，可以递归使用桶排序，或者其他排序方法。</li>
<li>将各个桶中的数据拼接，得出结果。</li>
</ul>
<p><strong>动画演示：</strong></p>
<p>图片来自<a href="https://blog.csdn.net/donghuabianc/article/details/105252373">here</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank9.gif"><span class="image-caption">桶排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<blockquote>
<p>这里的分桶方法根据序列中数值的范围确定，划分为(max-min)/5 + 1个桶，第i个桶中的元素存放的数值范围是5*i~5*i+5-1，即每个桶中存放5个数。</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BucketSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] bucketSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">if</span>(nums==<span class="hljs-keyword">null</span> || nums.length&lt;<span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> nums;<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-keyword">int</span> max = nums[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">int</span> min = nums[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i:nums){<span class="hljs-comment">//遍历数组，得到最大值和最小值</span><br>            <span class="hljs-keyword">if</span>(i&lt;min) min=i;<br>            <span class="hljs-keyword">if</span>(i&gt;max) max=i;<br>        }<br>        <span class="hljs-keyword">int</span> d = max-min;<br>        <span class="hljs-comment">//创建d/5+1个桶，第 i 桶存放5*i ~ 5*i+5-1范围的数</span><br>        <span class="hljs-keyword">int</span> bucketNum = d/<span class="hljs-number">5</span> + <span class="hljs-number">1</span>; <span class="hljs-comment">//桶的数量</span><br>        <span class="hljs-comment">//建立一个链表集合，每个桶都是一个LinkedList类型的链表</span><br>        ArrayList&lt;LinkedList&lt;Integer&gt;&gt; bucketList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;(bucketNum);<br>        <span class="hljs-comment">//初始化bucketNum个桶</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;bucketNum;i++) bucketList.add(<span class="hljs-keyword">new</span> LinkedList&lt;Integer&gt;());<br>        <span class="hljs-comment">//遍历数组，将每个值放入对应的桶中</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i:nums) bucketList.get((i-min)/d).add(i);<br>        <span class="hljs-comment">//对每个桶内的元素排序，这里使用系统排序函数，对链表进行排序</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;bucketNum;i++) Collections.sort(bucketList.get(i));<br>        <span class="hljs-comment">//将各个桶的数据合并，放回原数组</span><br>        <span class="hljs-keyword">int</span> index = <span class="hljs-number">0</span>; <span class="hljs-comment">//用于指向原数组</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;bucketNum;i++){<span class="hljs-comment">//将每个桶中的值依次放回原数组</span><br>            <span class="hljs-keyword">for</span>(Integer t: bucketList.get(i)) nums[index++] = t;<br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分析：</strong></p>
<ul>
<li>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></li>
<li>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></li>
<li>稳定排序</li>
<li>非原地排序</li>
</ul>
<blockquote>
<p>k表示桶的个数。桶排序的时间复杂度取决于各个桶内数据排序的时间复杂度，其他部分时间复杂度都是<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="4.977ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 2143 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="1753" y="0"></use>
</g>
</svg>。桶划分的个数越多，桶内的个数越少，单个桶排序用的时间也越少，但空间复杂度也随之增加。</p>
</blockquote>
<h1 id="基数排序-Radix-Sort"><a href="#基数排序-Radix-Sort" class="headerlink" title="基数排序(Radix Sort)"></a>基数排序(Radix Sort)</h1><p><strong>基数排序(Radix Sort)</strong>是按照低位先排序，然后收集；再按照高位排序，然后再收集；以此类推，直到最高位。如果有的属性有优先级顺序，则先按低优先级排序，再按高优先级排序。最后的结果是高优先级高的在前，如果高优先级相同，则低优先级高的在前。</p>
<p>下面以数字为例：</p>
<p><strong>算法原理：</strong></p>
<ul>
<li>取序列中最大的数，并取得位数，将序列中所有数填充至和最大值位数相等，前面填充0。</li>
<li>从最低位开始，使用计数排序依次进行一次排序。</li>
<li>从最低位排序，一直到最高位排序完成后，序列变为有序序列。</li>
</ul>
<p><strong>动画演示：</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rank10.gif"><span class="image-caption">基数排序算法图解</span></p>
<p><strong>代码实现：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RaxixSort</span></span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span>[] radixSort(<span class="hljs-keyword">int</span>[] nums){<br>        <span class="hljs-keyword">if</span>(nums==<span class="hljs-keyword">null</span> || nums.length&lt;<span class="hljs-number">2</span>) <span class="hljs-keyword">return</span> nums;<br>        <span class="hljs-keyword">int</span> max = nums[<span class="hljs-number">0</span>];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i:nums) <span class="hljs-keyword">if</span>(i&gt;max) max=i; <span class="hljs-comment">//求出序列最大值</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> exp=<span class="hljs-number">1</span>; max/exp&gt;<span class="hljs-number">0</span>; exp = exp*<span class="hljs-number">10</span>){<span class="hljs-comment">//从最低位到最高位依次进行计数排序</span><br>            countSort(nums,exp);<br>        }<br>        <span class="hljs-keyword">return</span> nums;<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">countSort</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums,<span class="hljs-keyword">int</span> exp)</span></span>{<br>        <span class="hljs-keyword">int</span> len = nums.length;<br>        <span class="hljs-keyword">int</span>[] output = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[len]; <span class="hljs-comment">//临时存放根据当前位排序的序列</span><br>        <span class="hljs-keyword">int</span>[] temp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">10</span>]; <span class="hljs-comment">//定义辅助数组，用来存放每个基数下的值</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i:nums) temp[(i/exp)%<span class="hljs-number">10</span>] += <span class="hljs-number">1</span>;<span class="hljs-comment">//将每个值在对应数组中的出现次数+1</span><br>        <span class="hljs-comment">//和计数排序不同的是，这里的键是数值的某位的值，所以需要根据下标还原到原来的值</span><br>        <span class="hljs-comment">//将temp中的数值改为累和，表示小于等于当前下标的数值的总数</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;<span class="hljs-number">10</span>;i++) temp[i] += temp[i-<span class="hljs-number">1</span>];<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=len-<span class="hljs-number">1</span>;i&gt;=<span class="hljs-number">0</span>;i--){ <span class="hljs-comment">//一定要从后往前添加，保证temp数组计数正确</span><br>            output[temp[(nums[i]/exp)%<span class="hljs-number">10</span>]-<span class="hljs-number">1</span>] = nums[i];<br>            temp[(nums[i]/exp)%<span class="hljs-number">10</span>]--; <span class="hljs-comment">//每添加完一个数值，temp对应的下标的次数-1</span><br>        }<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;len;i++) nums[i] = output[i]; <span class="hljs-comment">//将每次排序好的序列返回原数组</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分析：</strong></p>
<ul>
<li>时间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\times k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-D7" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></li>
<li>空间复杂度：<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="9.029ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 3887.4 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n+k)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2B" x="1975" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="2976" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3497" y="0"></use>
</g>
</svg></li>
<li>稳定排序</li>
<li>非原地排序</li>
</ul>
<blockquote>
<p>这里的k指的是基的个数，比如0-9一共10个基，k就等于10。</p>
</blockquote>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>实际应用中，需要根据序列的特点选择合适的排序算法，假设一个待排序列总元素个数为n。</p>
<ol>
<li>当n较大时，应采用时间复杂度为<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.118ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 4356.3 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">O(n\log n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-4F" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"></path>
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"></path>
<path stroke-width="1" id="E1-MJMAIN-6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z"></path>
<path stroke-width="1" id="E1-MJMAIN-67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-4F" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-28" x="763" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="1153" y="0"></use>
<g transform="translate(1920,0)">
 <use xlink:href="#E1-MJMAIN-6C"></use>
 <use xlink:href="#E1-MJMAIN-6F" x="278" y="0"></use>
 <use xlink:href="#E1-MJMAIN-67" x="779" y="0"></use>
</g>
 <use xlink:href="#E1-MJMATHI-6E" x="3366" y="0"></use>
 <use xlink:href="#E1-MJMAIN-29" x="3966" y="0"></use>
</g>
</svg>的排序方法：<strong>快速排序、堆排序、归并排序</strong>。</li>
</ol>
<blockquote>
<p>快速排序时目前基于比较的内部排序中被认为最好的方法，当待排序的关键字时随机分布时，快排的平均时间最短。</p>
<p>堆排序适用于内存空间允许且要求稳定性。</p>
<p>归并排序有一定数量的数据移动。</p>
</blockquote>
<ol>
<li>当n较大，内存空间允许，且要求稳定性，使用<strong>归并排序</strong>。</li>
<li>当n较小，可采用<strong>直接插入排序</strong>或<strong>直接选择排序</strong>。</li>
</ol>
<blockquote>
<p>当元素分布有序，直接插入排序将大大减少比较次数和移动纪录的次数。</p>
<p>当元素分布有序，如果不要求稳定性，使用直接选择排序。</p>
</blockquote>
<ol>
<li><p>一般不使用或者不直接使用<strong>冒泡排序</strong>。</p>
</li>
<li><p><strong>基数排序</strong>是一种稳定的排序算法，但有一定的局限性：</p>
<p>a.要求关键字必须可分解。</p>
<p>b.记录的关键字位数较少，如果密集更好。</p>
<p>c.如果是数字时，最好是无符号数字，否则将增加相应的映射复杂度，可将正负数分开排序。</p>
</li>
</ol>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li><a href="https://mp.weixin.qq.com/s/mq2NSG3xMqIs28nU354TjQ">必学十大经典排序算法</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/73714165">十大经典排序算法(动图演示)</a></li>
<li><a href="https://www.zhihu.com/question/51337272/answer/572455307">五分钟学算法</a></li>
<li><a href="https://blog.csdn.net/FISHBALL1/article/details/52425521">排序算法的比较和选择依据</a></li>
</ol>
]]></content>
      <categories>
        <category>算法笔记</category>
      </categories>
      <tags>
        <tag>数据结构</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot数据访问-SQL</title>
    <url>/2021/07/12/springboot-sql/</url>
    <content><![CDATA[<h1 id="一、DataSource"><a href="#一、DataSource" class="headerlink" title="一、DataSource"></a>一、DataSource</h1><h2 id="1-1-HikariDataSource数据源"><a href="#1-1-HikariDataSource数据源" class="headerlink" title="1.1 HikariDataSource数据源"></a>1.1 HikariDataSource数据源</h2><p>如果未指定数据源，SpringBoot中默认使用HikariDataSource数据源。</p>
<p>使用其进行数据库的CRUD操作步骤：</p>
<p><strong>1、确保项目引入了JDBC场景</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>官方的JDBC启动器没有引入数据库驱动，我们需要根据需求，引入指定的数据库驱动，以MySQL为例：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.49<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>我们要确保数据库版本和数据库驱动版本一致。SpringBoot2.5.2中的MySQL驱动版本是8，则需要数据库版本也是8以上。</p>
<p>如果想要修改驱动版本，有两种方式：</p>
<ul>
<li>直接依赖引入具体版本（maven的就近依赖原则），比如上面的做法。</li>
<li>重新声明版本（maven的属性的就近优先原则），比如下面的做法：</li>
</ul>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 通过属性修改版本 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>1.8<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mysql.version</span>&gt;</span>5.1.49<span class="hljs-tag">&lt;/<span class="hljs-name">mysql.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、分析自动配置</strong></p>
<p>分析SpringBoot为我们自动配置好的配置，通过分析源码可知，底层配置好了HikariDataSource连接池，以及事务管理器，分布式事务等。</p>
<p>底层还有一个<code>JdbcTemplate</code>组件。</p>
<p>连接池的配置可以使用<code>spring.datasource</code>配置。</p>
<p><strong>3、修改配置项</strong></p>
<p>在配置文件中，配置以下内容：</p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/springboot?useSSL=false&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br><br><span class="hljs-comment"># 可以根据需求设置其他参数</span><br>  <span class="hljs-attr">jdbc:</span><br>    <span class="hljs-attr">template:</span><br>      <span class="hljs-attr">query-timeout:</span> <span class="hljs-number">3</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、测试</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Boot05WebAdminApplicationTests</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span> </span>{<br>        Long aLong = jdbcTemplate.queryForObject(<br>            <span class="hljs-string">"select count(*) from books"</span>, Long.class);<br>       System.out.println(aLong);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="1-2-Druid数据源"><a href="#1-2-Druid数据源" class="headerlink" title="1.2 Druid数据源"></a>1.2 Druid数据源</h2><p>Druid项目地址：<a href="https://github.com/alibaba/druid">https://github.com/alibaba/druid</a></p>
<p>整合第三方技术有两种方式：</p>
<ul>
<li>自定义方式</li>
<li>使用其提供的starter</li>
</ul>
<h3 id="1-2-1-自定义方式"><a href="#1-2-1-自定义方式" class="headerlink" title="1.2.1 自定义方式"></a>1.2.1 自定义方式</h3><p><strong>1、引入依赖</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.22<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、并创建数据源</strong></p>
<p>创建数据源，可以根据需求定义一些配置。可以使用传统XML的方式注册bean</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.alibaba.druid.pool.DruidDataSource"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">"close"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.url}"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.username}"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.password}"</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>也可以定义一个配置类，在配置类中使用<code>@Bean</code>注册组件：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">手动配置数据源。在配置类中配置</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyDataSourceConfig</span> </span>{<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-comment">//绑定配置文件。数据源的属性会跟配置文件的spring.datasource数据一一绑定</span><br>    <span class="hljs-meta">@ConfigurationProperties("spring.datasource")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DataSource <span class="hljs-title">dataSource</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>{<br>        DruidDataSource druidDataSource = <span class="hljs-keyword">new</span> DruidDataSource();<br>        <span class="hljs-comment">//可以在这里配置，也可以直接读取配置文件中的配置，建议后者。</span><br>        <span class="hljs-comment">//druidDataSource.setUrl();</span><br>        <span class="hljs-comment">//druidDataSource.setUsername();</span><br>        <span class="hljs-comment">//druidDataSource.setPassword();</span><br><br>        <span class="hljs-comment">//可以加入或开启其他功能</span><br>        <span class="hljs-keyword">return</span> druidDataSource;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>将账号密码等信息配置在配置文件中：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/ssmbuild?useSSL=false&amp;characterEncoding=UTF-8&amp;serverTimezone=UTC</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、测试</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataSourceController</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    JdbcTemplate jdbcTemplate;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@GetMapping("/sql")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">druidTest</span><span class="hljs-params">()</span></span>{<br>        Long aLong = jdbcTemplate.queryForObject(<span class="hljs-string">"select count(*) from books"</span>, Long.class);<br>        <span class="hljs-keyword">return</span> aLong.toString();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="1-2-2-使用官方starter"><a href="#1-2-2-使用官方starter" class="headerlink" title="1.2.2 使用官方starter"></a>1.2.2 使用官方starter</h3><p><strong>1、引入starter</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>启动器为我们自动引入了数据源</p>
<p><strong>2、分析自动配置</strong></p>
<p>根据源码，分析官方已经配置好的配置，已经配置参数的使用。</p>
<p>可以使用<code>spring.datasource.druid</code>在配置文件中对druid进行各项的配置。</p>
<p><strong>3、配置示例</strong></p>
<p>可以参考：<a href="https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter">https://github.com/alibaba/druid/tree/master/druid-spring-boot-starter</a></p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">datasource:</span><br>    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/db_account</span><br>    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span><br>    <span class="hljs-attr">password:</span> <span class="hljs-number">123456</span><br>    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.jdbc.Driver</span><br><br>    <span class="hljs-attr">druid:</span><br>      <span class="hljs-attr">aop-patterns:</span> <span class="hljs-string">com.atguigu.admin.*</span>  <span class="hljs-comment">#监控SpringBean</span><br>      <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall</span>     <span class="hljs-comment"># 底层开启功能，stat（sql监控），wall（防火墙）</span><br><br>      <span class="hljs-attr">stat-view-servlet:</span>   <span class="hljs-comment"># 配置监控页功能</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">login-username:</span> <span class="hljs-string">admin</span><br>        <span class="hljs-attr">login-password:</span> <span class="hljs-string">admin</span><br>        <span class="hljs-attr">resetEnable:</span> <span class="hljs-literal">false</span><br><br>      <span class="hljs-attr">web-stat-filter:</span>  <span class="hljs-comment"># 监控web</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">urlPattern:</span> <span class="hljs-string">/*</span><br>        <span class="hljs-attr">exclusions:</span> <span class="hljs-string">'*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*'</span><br><br>      <span class="hljs-attr">filter:</span><br>        <span class="hljs-attr">stat:</span>    <span class="hljs-comment"># 对上面filters里面的stat的详细配置</span><br>          <span class="hljs-attr">slow-sql-millis:</span> <span class="hljs-number">1000</span><br>          <span class="hljs-attr">logSlowSql:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>        <span class="hljs-attr">wall:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">config:</span><br>            <span class="hljs-attr">drop-table-allow:</span> <span class="hljs-literal">false</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="二、整合MyBatis"><a href="#二、整合MyBatis" class="headerlink" title="二、整合MyBatis"></a>二、整合MyBatis</h1><p>SpringBoot整合MyBatis的主要步骤如下：</p>
<ul>
<li>导入MyBatis的官方starter</li>
<li>编写mapper接口，并使用@Mapper接口注册。</li>
<li>编写Service类</li>
<li>编写映射文件，绑定mapper接口</li>
<li>在总配置文件<code>application.yaml</code>中指定映射文件的位置，以及MyBatis配置文件的位置（建议直接将MyBatis的配置写在总配置文件中）。</li>
</ul>
<h2 id="2-1-配置模式"><a href="#2-1-配置模式" class="headerlink" title="2.1 配置模式"></a>2.1 配置模式</h2><p><strong>1、引入stater</strong></p>
<p>首先引入官方starter，其为我们配置好了SqlSession</p>
<p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 引入MyBatis的starter --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、编写mapper和service</strong></p>
<p>编写mapper接口和service层，所有的Mapper接口都需要使用<code>@Mapper</code>注解标注，表示注册当前接口为Mapper。</p>
<p><code>BookMapper.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BookMapper</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Book <span class="hljs-title">getBookById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>也可以在SpringBoot启动类上，使用<code>@MapperScan("com.kang.admin.mapper")</code> 注解，表示将指定包下的所有类统一注册为Mapper，这样其中的接口就可以不用单独使用@Mapper注解。</p>
<blockquote>
<p>@Mapper的功能类似于@Repository，都是用在DAO层，表示注册当前类。</p>
<p>@Mapper不需要配置扫描地址，而@Repository需要配置扫描地址。</p>
<p>SpringBoot中一般使用@Mapper注解。</p>
<p>源码对@Mapper的解释：Marker interface for MyBatis mappers</p>
</blockquote>
<p><code>BookService.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookService</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    BookMapper bookMapper;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Book <span class="hljs-title">getBookById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>{<br>        <span class="hljs-keyword">return</span> bookMapper.getBookById(id);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、编写sql映射器文件并绑定mapper接口</strong></p>
<p><code>BookMapper.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.kang.admin.mapper.BookMapper"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getBookById"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.kang.admin.bean.Book"</span>&gt;</span><br>        select * from ssmbuild.books where bookID=#{id}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>在<code>application.yml</code>中指定MyBatis的<strong>映射器文件</strong>和MyBatis<strong>总配置文件</strong>的位置。</p>
<p><code>application.yml</code></p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 配置数据源</span><br><span class="hljs-string">...</span><br><br><span class="hljs-comment"># 配置MyBatis</span><br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-attr">config-location:</span> <span class="hljs-string">classpath:mybatis/mybatis-config.xml</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mybatis/mapper/*.xml</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>mybatis-config.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">mybatis配置文件<br></code></pre></td></tr></tbody></table></figure>
<p>这里的路径，应该是编译后的配置文件路径，resources下的文件都会被直接编译到target目录下。</p>
<p>我们也可以在<code>application.yml</code>中的<code>mybatis.configuration</code>，对MyBatis进行配置，比如驼峰命名映射等，取代<code>mybatis-config.xml</code>配置文件。推荐这一种方式，尽量不写多余的配置文件。</p>
<p>比如：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 配置MyBatis</span><br><span class="hljs-attr">mybatis:</span><br>  <span class="hljs-comment"># 将MyBatis配置写在这里，就不需要config-location这个配置了</span><br>  <span class="hljs-attr">mapper-locations:</span> <span class="hljs-string">classpath:mybatis/mapper/*.xml</span><br>  <span class="hljs-attr">configuration:</span><br>    <span class="hljs-attr">map-underscore-to-camel-case:</span> <span class="hljs-literal">true</span>  <span class="hljs-comment"># 驼峰命名映射开启</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-2-注解模式"><a href="#2-2-注解模式" class="headerlink" title="2.2 注解模式"></a>2.2 注解模式</h2><p>参考官方：<a href="https://github.com/mybatis/spring-boot-starter/wiki/Quick-Start">https://github.com/mybatis/spring-boot-starter/wiki/Quick-Start</a></p>
<p>使用注解模式编写SQL语句，避免了为每个Mapper编写映射文件。</p>
<p>常用的注解：@Select、@Insert、@Update、@ Delete</p>
<p>具体使用方式可以参考：<a href="https://kangshitao.github.io/2021/06/21/mybatis-basis/#%E5%9B%9B%E3%80%81%E6%B3%A8%E8%A7%A3">MyBatis注解模式</a></p>
<p>案例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CityMapper</span> </span>{<br>    <span class="hljs-meta">@Select("select * from city where id=#{id}")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> City <span class="hljs-title">getById</span><span class="hljs-params">(Long id)</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-3-混合模式"><a href="#2-3-混合模式" class="headerlink" title="2.3 混合模式"></a>2.3 混合模式</h2><p>混合使用注解和配置文件两种方式。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"indert"</span> <span class="hljs-attr">useGenerateKeys</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">"id"</span>&gt;</span><br>	insert into city(`name`,`state`,`country`) values(#{name},#{state},#{country})<br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>insert</code>语句中的<code>useGenerateKeys</code>属性，能够确保类似id这种自增主键插入数据库后，也能够返回到参数city中。</p>
<p>以上代码使用注解方式为：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Insert("insert into city(`name`,`state`,`country`) values(#{name},#{state},#{country})")</span><br><span class="hljs-meta">@Options(useGeneratedKeys = true,keyProperty = "id")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(City city)</span></span>;<br></code></pre></td></tr></tbody></table></figure>
<p>最佳实践：</p>
<ul>
<li>引入mybatis-starter</li>
<li><p>配置application.yaml中，指定mapper-location位置（将MyBatis配置文件单独配置）</p>
</li>
<li><p>编写Mapper接口并标注<code>@Mapper</code>注解</p>
</li>
<li>简单方法直接注解方式；复杂方法编写mapper.xml进行绑定映射。</li>
</ul>
<h1 id="三、整合MyBatis-Plus"><a href="#三、整合MyBatis-Plus" class="headerlink" title="三、整合MyBatis-Plus"></a>三、整合MyBatis-Plus</h1><h2 id="3-1-什么是MyBatis-Plus"><a href="#3-1-什么是MyBatis-Plus" class="headerlink" title="3.1 什么是MyBatis-Plus"></a>3.1 什么是MyBatis-Plus</h2><p><a href="https://mybatis.plus/guide/">MyBatis-Plus</a>是MyBatis的一个增强工具，在MyBatis的基础上只做增强不做改变，简化开发。</p>
<h2 id="3-2-整合MyBatis-Plus"><a href="#3-2-整合MyBatis-Plus" class="headerlink" title="3.2 整合MyBatis-Plus"></a>3.2 整合MyBatis-Plus</h2><p><strong>1、引入starter</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 引入MyBatis-Plus的starter --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>MyBatis-Plus的starter自动帮我们引入了JDBC、MyBatis、MyBatis-Spring等依赖包，因此如果使用MyBatis-Plus则不必单独这些依赖。</p>
<p><strong>2、分析starter，查看配置信息</strong></p>
<p>分析其自动配置类可知，可以通过<code>mybatis-plus</code>对其进行配置。</p>
<ul>
<li>为我们配置好了SqlSessionFactory，数据源是容器中默认的数据源。</li>
<li>自动配置了<code>mapperLocations</code>，默认值为<code>classpath*:/mapper/**/*.xml</code>，即任意包的类路径（编译之后的路径）下的所有mapper文件夹中任意路径的xml文件，都作为映射文件。因此建议以后的映射文件放在<code>mapper</code>目录下面。</li>
<li><code>@Mapper</code>标注的接口，也会被自动扫描，不需要再配置。建议还是使用<code>@MapperScan</code>注解批量扫描。</li>
</ul>
<p><strong>3、使用MyBatis-Plus</strong></p>
<p>MyBatis-Plus为我们提供了<code>BaseMapper</code>接口，其定义了大部分的增删查改操作。我们只需要在接口上继承<code>BaseMapper</code>即可，<strong>不需要写任何方法，无需写映射文件</strong>，使用的时候直接调用<code>BaseMapper</code>中的方法。</p>
<p><code>UserMapper.java</code>接口</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseMapper</span>&lt;<span class="hljs-title">User</span>&gt; </span>{}<br></code></pre></td></tr></tbody></table></figure>
<p>如果我们要编写service层，是否要实现<code>BaseMapper</code>中的所有方法？MyBatis-Plus也为我们提供了一个service层的接口<code>IService</code>，这是顶级service，其定义了常用的service层方法。</p>
<p>并且，MyBatis-Plus还为我们提供了<code>IService</code>的实现类<code>ServiceImpl</code>，我们的实现类只需要继承它即可，同样也不需要重写方法。</p>
<p><code>UserService.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">IService</span>&lt;<span class="hljs-title">User</span>&gt; </span>{}<br></code></pre></td></tr></tbody></table></figure>
<p><code>UserServiceImpl.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceImpl</span>&lt;<span class="hljs-title">UserMapper</span>, <span class="hljs-title">User</span>&gt; </span><br><span class="hljs-class">    <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>一般@Service\@Repository之类的注解使用在类上。@Autowired可以用在接口上</p>
</blockquote>
<p>这样，我们就可以直接调用方法进行使用了。</p>
<p>使用MyBatis-Plus，为我们省去了配置映射文件，手动实现CRUD操作的步骤。</p>
<p><strong>其他说明</strong></p>
<p><code>@TableName</code>注解和<code>@TableField</code>注解：</p>
<ul>
<li><code>@TableName</code> ：可以用来指定要查找的表。因为MyBatis-Plus默认对<strong>和Mapper接口名相同的表</strong>进行操作。</li>
<li><code>TableField</code>：MyBatis-Plus默认要求实体类的属性必须都在表中存在，如果某个属性不在表中，可以使用这个注解进行标注。</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//指定要查找的表</span><br><span class="hljs-meta">@TableName("user")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>    <span class="hljs-meta">@TableField(exist = false)</span><br>    <span class="hljs-keyword">private</span> String userName;  <span class="hljs-comment">//假设这个属性在表中不存在</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3-3-分页功能"><a href="#3-3-分页功能" class="headerlink" title="3.3 分页功能"></a>3.3 分页功能</h2><p>MyBatis-Plus为我们提供了<a href="https://mybatis.plus/guide/page.html">分页插件</a>，我们可以使用它完成分页功能。</p>
<p>首先需要将<code>MybatisPlusInterceptor</code>这个组件设置参数，并注入容器。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MybatisPlusConfig</span> </span>{<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> MybatisPlusInterceptor <span class="hljs-title">mybatisPlusInterceptor</span><span class="hljs-params">()</span> </span>{<br>        MybatisPlusInterceptor interceptor = <span class="hljs-keyword">new</span> MybatisPlusInterceptor();<br>        <span class="hljs-comment">// 设置请求的页面大于最大页后操作， true调回到首页，false 继续请求  默认false</span><br>        <span class="hljs-comment">// paginationInterceptor.setOverflow(false);</span><br>        <span class="hljs-comment">// 设置最大单页限制数量，默认 500 条，-1 不受限制</span><br>        <span class="hljs-comment">// paginationInterceptor.setLimit(500);</span><br>        <span class="hljs-comment">// 开启 count 的 join 优化,只针对部分 left join</span><br>        PaginationInnerInterceptor paginationInnerInterceptor = <br>            <span class="hljs-keyword">new</span> PaginationInnerInterceptor();<br>        paginationInnerInterceptor.setOverflow(<span class="hljs-keyword">true</span>);<br>        paginationInnerInterceptor.setMaxLimit(<span class="hljs-number">100L</span>);<br>        interceptor.addInnerInterceptor(paginationInnerInterceptor);<br>        <span class="hljs-keyword">return</span> interceptor;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>然后在controller中获取<code>Page</code>类对象，实现分页功能。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TableController</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    UserService userService;  <span class="hljs-comment">//controller层调用service层</span><br><br>    <span class="hljs-comment">//使用MyBatis-Plus中的Page对象，实现分页查询。</span><br>    <span class="hljs-meta">@GetMapping("/dynamic_table")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">dynamic_table</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "pn",defaultValue = "1")</span></span></span><br><span class="hljs-function"><span class="hljs-params">                                Integer pn, Model model)</span> </span>{<br><br>        Page&lt;User&gt; userPage = <span class="hljs-keyword">new</span> Page&lt;&gt;(pn, <span class="hljs-number">2</span>); <span class="hljs-comment">//指定当前页码和每页数量</span><br>        Page&lt;User&gt; page = userService.page(userPage, <span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//可以获取page对象的各种参数，比如总页数，当前页之类的</span><br>        <span class="hljs-comment">//long current = page.getCurrent();</span><br>        <span class="hljs-comment">//long pages = page.getPages();</span><br>        <span class="hljs-comment">//long total = page.getTotal();</span><br>        <span class="hljs-comment">//List&lt;User&gt; records = page.getRecords();</span><br>        model.addAttribute(<span class="hljs-string">"page"</span>,page);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"table/dynamic_table"</span>;<br>    }<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">        * 删除指定id的数据，然后重定向到当前页。</span><br><span class="hljs-comment">        * <span class="hljs-doctag">@param</span> id 使用RESTFul风格传递，因此使用<span class="hljs-doctag">@PathVariable</span>注解</span><br><span class="hljs-comment">        * <span class="hljs-doctag">@param</span> pn 页码使用参数传递，因此使用<span class="hljs-doctag">@RequestParam</span>绑定</span><br><span class="hljs-comment">        * <span class="hljs-doctag">@param</span> ra RedirectAttributes类型用于给重定向时添加参数</span><br><span class="hljs-comment">        * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">        */</span><br>    <span class="hljs-meta">@GetMapping("/user/delete/{id}")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable("id")</span> Long id,</span></span><br><span class="hljs-function"><span class="hljs-params">                             <span class="hljs-meta">@RequestParam(value="pn",defaultValue="1")</span> Integer pn,</span></span><br><span class="hljs-function"><span class="hljs-params">                             RedirectAttributes ra)</span></span>{<br><br>        <span class="hljs-comment">//RedirectAttributes用于给重定向添加参数</span><br>        userService.removeById(id);<br>        ra.addAttribute(<span class="hljs-string">"pn"</span>,pn);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/dynamic_table"</span>;<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure>
<p>前端页面从<code>Page</code>对象中取数据，并分页显示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-sql_1.png" alt=""></p>
]]></content>
      <categories>
        <category>SpringBoot2</category>
      </categories>
      <tags>
        <tag>SpringBoot2</tag>
        <tag>Spring</tag>
        <tag>MyBatis</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot2配置与使用</title>
    <url>/2021/07/10/springboot2-basis/</url>
    <content><![CDATA[<h1 id="一、SpringBoot介绍"><a href="#一、SpringBoot介绍" class="headerlink" title="一、SpringBoot介绍"></a>一、SpringBoot介绍</h1><h2 id="1-1-SpringBoot"><a href="#1-1-SpringBoot" class="headerlink" title="1.1 SpringBoot"></a>1.1 SpringBoot</h2><h3 id="1-1-1-什么是SpringBoot"><a href="#1-1-1-什么是SpringBoot" class="headerlink" title="1.1.1 什么是SpringBoot"></a>1.1.1 什么是SpringBoot</h3><p>官方文档：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/index.html">Spring Boot Reference Documentation</a></p>
<p><a href="https://snailclimb.gitee.io/springboot-guide/#/./docs/start/springboot-introduction">SpringBoot介绍</a></p>
<p>Spring框架旨在简化J2EE企业应用程序的开发，而SpringBoot旨在简化Spring开发，使用SpringBoot能够快速创建出生产级别的Spring应用。</p>
<p>使用Spring框架虽然代码是轻量级的，但是其仍然需要大量的XML配置。SpringBoot解决了Spring项目配置文件繁多的问题。</p>
<p>SpringBoot是整合Spring技术栈的一站式框架。</p>
<p>SpringBoot是简化Spring技术栈的快速开发脚手架。</p>
<h3 id="1-1-2-SpringBoot的优缺点"><a href="#1-1-2-SpringBoot的优缺点" class="headerlink" title="1.1.2 SpringBoot的优缺点"></a>1.1.2 SpringBoot的优缺点</h3><p><strong>优点</strong>：</p>
<ul>
<li><p>创建独立Spring应用</p>
</li>
<li><p>Spring Boot 应用程序提供嵌入式 HTTP 服务器，如 Tomcat 和 Jetty，可以轻松地开发和测试 web 应用程序。</p>
</li>
<li><p>自动starter依赖，简化构建配置</p>
</li>
<li><p>自动配置Spring以及第三方功能</p>
</li>
<li><p>提供生产级别的监控、健康检查及外部化配置</p>
</li>
<li><p>Spring Boot 不需要编写大量样板代码、XML 配置和注释。</p>
</li>
</ul>
<p><strong>缺点</strong>：</p>
<ul>
<li>迭代快，需要时刻关注变化</li>
</ul>
<ul>
<li>封装太深，内部原理复杂，不容易精通</li>
</ul>
<h2 id="1-2-SpringBoot2"><a href="#1-2-SpringBoot2" class="headerlink" title="1.2 SpringBoot2"></a>1.2 SpringBoot2</h2><p>基于Java8的新特性，比如接口中允许定义默认方法（default方法不强制实现），Spring5的源码架构也重新设计，因此SpringBoot2相比于1版本也有很多升级，比如响应式编程。</p>
<p>SpringBoot2的系统要求，以2.5.2版本为例</p>
<ul>
<li>Maven 3.5+</li>
<li>Tomcat 9.0，servlet3.1+</li>
<li>JDK8+</li>
</ul>
<h1 id="二、SpringBoot2-快速入门"><a href="#二、SpringBoot2-快速入门" class="headerlink" title="二、SpringBoot2 快速入门"></a>二、SpringBoot2 快速入门</h1><h2 id="2-1-创建工程"><a href="#2-1-创建工程" class="headerlink" title="2.1 创建工程"></a>2.1 创建工程</h2><p>可以在官网的<a href="https://start.spring.io/快速生成一个SpringBoot项目，生成以后下载到本地即可。">https://start.spring.io/快速生成一个SpringBoot项目，生成以后下载到本地即可。</a></p>
<p>也可以使用IDEA自带的<code>Spring Initializr</code>创建，<strong><code>File-&gt;New-&gt;Project-&gt;Spring Initializr</code></strong>，配置好项目名之后，可以根据需求选择依赖，比如我们选择Spring Web依赖，这样创建的项目会自动在配置文件中导入选中的依赖。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot2-basis_1.png"><span class="image-caption">选择项目依赖</span></p>
<h2 id="2-2-编写业务代码"><a href="#2-2-编写业务代码" class="headerlink" title="2.2 编写业务代码"></a>2.2 编写业务代码</h2><p>创建完成后，<code>Spring Initializr</code>会自动为我们导入启动器依赖并生成目录结构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot2-basis_2.png"><span class="image-caption">初始项目目录结构</span></p>
<p>其中templates文件存放JSP页面、thymeleaf模版等；static文件夹存放图片、css文件、js文件、欢迎页、网站图标等静态资源。</p>
<p>直接运行启动类<code>DemoApplication</code>就能运行项目：</p>
<p><code>DemoApplicationTests</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//注明这是一个SpringBoot应用</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DemoApplicationTests</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        SpringApplication.run(DemoApplicationTests.class, args);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>我们可以新建一个controller进行测试，比如：</p>
<p><code>com.example.demo.controller.HelloController.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/hello")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">handle01</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, Spring Boot 2!"</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，在浏览器中输入hello请求，就会收到指定的返回值。一个web项目的demo就算搭建成功。</p>
<p>需要特别注意的是，<strong>SpringBoot默认会自动扫描主程序所在的包及其下面所有的子包中的组件</strong>，因此，我们需要将程序代码写在主程序所在的包及其子包内。</p>
<blockquote>
<p>也可以改变扫描路径，比如@SpringBootApplication(scanBasePackages=”com.kang”)表示将扫描的包路径更改为com.kang</p>
</blockquote>
<h2 id="2-3-简化配置和部署"><a href="#2-3-简化配置和部署" class="headerlink" title="2.3 简化配置和部署"></a>2.3 简化配置和部署</h2><p><strong>简化配置</strong></p>
<p>SpringBoot默认的主配置文件是<code>application</code>可以是<code>properties</code>类型，也可以是<code>yaml</code>类型，可以同时使用多个配置文件，生效顺序根据情况判断。</p>
<p>对于SpringBoot简化配置的优势，主要体现在其所有的配置都可以只写在一个配置文件中，即主配置文件<code>application.properties</code>中，配置tomcat的端口号：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">server.port</span>=<span class="hljs-string">8888</span><br></code></pre></td></tr></tbody></table></figure>
<p>SpringBoot中，用到的所有配置都可以只在这一个配置文件中修改,包括tomcat参数、mybatis、springmvc配置等。 SpringBoot为我们配置了一些默认值，可以根据需求修改。</p>
<p><strong>简化部署</strong></p>
<p>SpringBoot的简化部署主要体现在它为我们提供了maven插件，这个插件能够在maven打包时递归地将所有jar包和项目文件都打包进去。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、SpringBoot配置"><a href="#三、SpringBoot配置" class="headerlink" title="三、SpringBoot配置"></a>三、SpringBoot配置</h1><h2 id="3-1-SpringBoot特点"><a href="#3-1-SpringBoot特点" class="headerlink" title="3.1 SpringBoot特点"></a>3.1 SpringBoot特点</h2><h3 id="3-1-1-依赖管理"><a href="#3-1-1-依赖管理" class="headerlink" title="3.1.1 依赖管理"></a>3.1.1 依赖管理</h3><p><strong>依赖管理</strong></p>
<p>SpringBoot中是父项目进行依赖管理，所有的SpringBoot项目都会引入这个父项目，这个项目主要是用于资源过滤和插件管理：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- spring-boot-starter-parent是每个SpringBoot项目都要引入的父项目 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.5.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这个父项目的又有一个父项目：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这个`spring-boot-dependencies项目是真正管理SpringBoot应用里面所有依赖版本的地方，即SpringBoot的版本控制中心。其中<strong>自动配置了常用的jar包的版本号（自动版本仲裁机制）</strong>，因此<strong>我们如果显式导入某个依赖，不需要手动写版本号</strong>，除非SpringBoot依赖配置中没有这个包。</p>
<p>如果我们对于自动仲裁的版本号不满意，也可以手动指定版本号。首先需要查看<code>spring-boot-dependencies</code>里面规定依赖的版本用的 key，然后在当前项目里面重写配置。</p>
<p>比如要修改MySQL依赖的版本号，我们从底层依赖中查到定义其版本号的key为<code>mysql.version</code>，我们就可以在pom文件中手动修改其版本号：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mysql.version</span>&gt;</span>5.1.43<span class="hljs-tag">&lt;/<span class="hljs-name">mysql.version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>启动器（starter）</strong></p>
<p>SpringBoot将所有的功能场景都抽取出来，做成一个个的<strong>starter （启动器）</strong>，就是在Maven的<code>pom.xml</code>配置文件中，类似<code>xxx-starter</code>的依赖，比如：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- web场景启动器 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这种<code>starter</code>就称为xx的场景启动器：</p>
<ul>
<li><p><code>spring-boot-starter-xxx</code> ： 官方提供的xxx场景启动器 。</p>
</li>
<li><p><code>xxx-spring-boot-starter</code>： 第三方提供的简化开发的场景启动器。</p>
</li>
<li><p><strong>只要引入starter，这个场景需要的所有常规依赖都自动引入 </strong></p>
</li>
<li><p>所有场景启动器最底层的依赖都是<code>spring-boot-starter</code>：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>SpringBoot官方提供的所有场景，参考<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-starter">Starters</a> </p>
<p>我们只需要在项目中引入这些starter即可，所有相关的依赖都会导入进来 ， 我们要用什么功能就导入什么样的场景启动器即可 ，也可以根据需求自定义自己的 starter。</p>
<h3 id="3-1-2-自动配置"><a href="#3-1-2-自动配置" class="headerlink" title="3.1.2 自动配置"></a>3.1.2 自动配置</h3><p><strong>自动配置依赖</strong></p>
<p>当我们引入某一个场景启动器的时候，SpringBoot会自动帮我们引入其需要的依赖，这是底层启动器自动引入的。</p>
<p>比如，我们引入web启动器，底层会自动帮我们引入Tomcat依赖、SpringMVC常用组件（比如视图解析器）、字符编码问题等。</p>
<p><strong>默认的包结构</strong></p>
<p>SpringBoot项目中，<strong>主程序所在包及其下面的所有子包里面的组件都会被默认扫描进来</strong>，无需以前的包扫描配置。</p>
<p>如果想要改变扫描路径，使用<code>SpringBootApplication</code>的<code>scanBasePackages</code>属性，比如将扫描包的范围扩大为<code>com.example</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootApplication(scanBasePackages="com.eaxmple")</span><br></code></pre></td></tr></tbody></table></figure>
<p>或者单独使用<code>@ComponentScan</code>指定扫描路径。</p>
<h2 id="3-2-主启动类"><a href="#3-2-主启动类" class="headerlink" title="3.2 主启动类"></a>3.2 主启动类</h2><p>SpringBoot项目有一个主启动类，使用<code>@SpringBootApplication</code>标注：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//表明这是一个Spring Boot应用</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringbootApplication</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        SpringApplication.run(SpringbootApplication.class, args);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>@SpringBootApplication</code>是SpringBoot的基石，其标注在主程序类上，根据源码可知，其等价于下面三个注解：</p>
<ul>
<li><code>@SpringBootConfiguration</code>：等价于<code>@Configuration</code>，表明这是一个SpringBoot项目的配置类。</li>
<li><code>@EnableAutoConfiguration</code>：开启自动配置功能。</li>
<li><code>@ComponentScan</code>：自动扫描并加载<strong>给定的路径中</strong>符合条件的组件，注入到IOC容器中。</li>
</ul>
<h2 id="3-3-容器功能"><a href="#3-3-容器功能" class="headerlink" title="3.3 容器功能"></a>3.3 容器功能</h2><p>SpringBoot同样可以使用Spring的容器功能，下面介绍配置文件涉及到的常用注解。</p>
<h3 id="3-3-1-组件添加"><a href="#3-3-1-组件添加" class="headerlink" title="3.3.1 组件添加"></a>3.3.1 组件添加</h3><p><strong>1、<code>@Configuration</code></strong></p>
<p>这个注解表示将当前类注册为配置类，可以代替Spring的配置文件进行配置，比如注册组件。</p>
<p>在配置类中，使用<code>@Bean</code>在方法上使用用于注册组件。</p>
<blockquote>
<p>一种常用的做法是，在配置类的方法中使用@Bean，注册第三方bean。因为第三方组件只能通过这种方式注入。</p>
</blockquote>
<p><code>@Configuration</code>有两种模式：</p>
<ul>
<li><strong>Full模式</strong>：<code>proxyBeanMethods = true</code>，保证每个@Bean方法被调用多少次返回的组件都是单实例的。默认情况就是Full模式。</li>
<li><strong>Lite模式</strong>：<code>proxyBeanMethods = false</code>，每次调用@Bean标注的方法方法，返回的组件都是新创建的，即每次获取的组件都是不同的。</li>
</ul>
<blockquote>
<p>组件依赖必须使用Full模式。</p>
<p>Full模式每次都要检查容器中是否存在当前组件，因此效率较低。如果非必要情况下，建议使用Lite模式以提高效率。</p>
</blockquote>
<p><strong>2、<code>@Bean</code>、<code>@Component</code>、<code>@Controller</code>、<code>@Service</code>、<code>@Repository</code></strong></p>
<p>这几个注解的作用类似，都是注册组件：</p>
<ul>
<li><code>@Bean</code>：<strong>用在配置类的方法上</strong>，方法的返回类型就是要注册组件。<strong>如果注册第三方库中的类到IOC容器中，只能使用配置类+@Bean注解的方式</strong>。</li>
<li><code>@Component</code>：用在类上，表示将当前类注册为组件。</li>
<li><code>@Controller</code>：@Component的衍生注解，功能类似，用在controller层</li>
<li><code>@Service</code>：@Component的衍生注解，功能类似，用在service层</li>
<li><code>@Repository</code>：@Component的衍生注解，功能类似，用在dao层</li>
</ul>
<p><strong>3、<code>@ComponenScan</code>、<code>@Import</code></strong></p>
<p>这两个注解也是用在配置类中。</p>
<p><code>@ComponentScan</code>：自动扫描并加载<strong>给定的路径中</strong>符合条件的组件，注入到IOC容器中。</p>
<p><code>@Import</code>：可以导入一个或多个组件，比如Bean或者配置类。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//给容器中自动创建出这两个类型的组件，默认组件的名字就是全类名</span><br><span class="hljs-meta">@Import({User.class, DBHelper.class})</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以参考：<a href="https://kangshitao.github.io/2021/06/27/spring-basis/#%E5%85%AB%E3%80%81%E5%9F%BA%E4%BA%8EJava%E7%9A%84%E5%AE%B9%E5%99%A8%E9%85%8D%E7%BD%AE">配置类注解</a></p>
<p><strong>4、<code>@Conditional</code></strong><br><code>@Conditional</code>表示条件装配，只有满足一定条件，才会被注册。可以用在配置类上，也可以用在配置类的方法上。</p>
<p>as such, it is strongly recommended to use this condition on auto-configuration classes only. If a candidate bean may be created by another auto-configuration, make sure that the one using this condition runs after.</p>
<p>其衍生注解如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot2-basis_3.png"><span class="image-caption">@Conditional及其衍生注解</span></p>
<p>比如在配置类上使用<code>@ConditionalOnMissingBean(name = "tom")</code>表示当容器中没有name为<code>tom</code>的组件时，配置类中的组件才会生效。</p>
<p><strong>关于Conditonal注解有时候不起作用的问题的讨论</strong></p>
<ul>
<li><p>条件注解的条件是<strong>根据当前已经加载的内容来判断</strong>是否符合。</p>
</li>
<li><p>Condition相关的处理是在<strong>包扫描</strong>的时候执行的，所以条件中的<strong>判断前后顺序只跟包扫描的顺序有关</strong>，而包扫描的顺序是根据包名和类名的字符排序，所以<strong>配置类的解析无法保证bean注册的先后顺序</strong>，如果在同一个配置类不同的@Bean注解的方法上使用条件注解可能会出现失效的情况。</p>
<blockquote>
<p>通过component-scan扫描的方式加载bean，在扫描范围内按照class的命名顺序加载。</p>
<p>在spring的xml文件中，bean的加载顺序按照书写顺序加载，如果不同组件之间有依赖关系，则先创建被依赖的组件。</p>
</blockquote>
</li>
<li><p>对于<code>@ConfitionalOnBean</code>和<code>@ConditionalOnMissingBean</code>，官方推荐只在自动配置类中使用，因为自动配置类会在用户定义的bean被添加到容器之后才加载。</p>
</li>
</ul>
<h3 id="3-3-2-原生配置文件引入"><a href="#3-3-2-原生配置文件引入" class="headerlink" title="3.3.2 原生配置文件引入"></a>3.3.2 原生配置文件引入</h3><p>使用<code>@ImportResource</code>注解，可以在配置类中引入一个或多个<code>.xml</code>配置文件，允许以配置文件的方式对组件进行注册。主要是为了将第三方的配置文件中的组件注入容器。</p>
<blockquote>
<p>@ImportResource引入的是资源文件；@Import引入的是组件。</p>
</blockquote>
<p><code>beans.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/context </span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"haha"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.atguigu.boot.bean.User"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"zhangsan"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"18"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hehe"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.atguigu.boot.bean.Pet"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"tomcat"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>MyConfig.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ImportResource("classpath:beans.xml")</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyConfig</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<p>可以在主程序中的IOC容器中，测试是否注入成功：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Springboot01HelloworldApplication</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//可以根据返回的配置应用上下文对象，获取容器配置</span><br>        <span class="hljs-comment">//返回IOC容器</span><br>        ConfigurableApplicationContext run = SpringApplication.run(Springboot01HelloworldApplication.class, args);<br>        <span class="hljs-keyword">boolean</span> haha = run.containsBean(<span class="hljs-string">"haha"</span>);<br>        <span class="hljs-keyword">boolean</span> hehe = run.containsBean(<span class="hljs-string">"hehe"</span>);<br>        System.out.println(<span class="hljs-string">"haha："</span>+haha);<span class="hljs-comment">//true</span><br>        System.out.println(<span class="hljs-string">"hehe："</span>+hehe);<span class="hljs-comment">//true</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="3-3-3-配置绑定"><a href="#3-3-3-配置绑定" class="headerlink" title="3.3.3 配置绑定"></a>3.3.3 配置绑定</h3><p>配置绑定，指的是将配置文件中的内容，封装到JavaBean中，以供随时使用。</p>
<p>使用原生的Java代码，解析配置文件比较麻烦，在SpringBoot中，我们可以使用注解自动将配置文件中的值绑定到组件中的属性上。</p>
<p><strong>1、@Value</strong></p>
<p>对于简单的属性注入，可以使用<code>@Value</code>注解。可以绑定配置文件中指定的属性到当前的属性。</p>
<p><code>@Value</code>有三种赋值方式：</p>
<ul>
<li>直接赋值，比如：<code>@Value("name")</code></li>
<li>绑定配置文件中的属性，比如：<code>@Value("${person.name}")</code>，绑定配置文件中的<code>person.name</code>到当前属性。还可以指定默认值。</li>
<li>使用SpEL表达式赋值，比如：<code>@Value("#{'姓名'}")</code>，参考：<a href="https://blog.csdn.net/swordcenter/article/details/75239878">SpEL</a></li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{<br>    <span class="hljs-comment">//使用@Value注解绑定主配置文件中的属性person.name</span><br>    <span class="hljs-comment">//如果值为空，则指定一个默认值</span><br>    <span class="hljs-meta">@Value("${person.name:default name}")</span><br>    <span class="hljs-keyword">private</span> String name;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、@Component + @ConfigurationProperties</strong></p>
<p>如果一个类想要绑定配置文件，需要使用<code>@ConfigurationProperties</code>注解，用于指定和核心配置文件中什么属性绑定。</p>
<p>绑定配置文件的前提当前类必须是容器中的组件，因此可以结合使用<code>@Component</code>注解：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//只有在容器中的组件，才会拥有SpringBoot提供的强大功能</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = "mycar")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Car</span> </span>{<br>    <span class="hljs-keyword">private</span> String brand;<br>    <span class="hljs-keyword">private</span> Integer price;<br>    ...<span class="hljs-comment">//get、set方法等</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p>在<code>@ConfigurationProperties</code>注解中使用<code>prefix</code>属性，指定要绑定的配置文件中的前缀，比如配置文件中的<code>mycar.price=10000</code>，当前组件中的<code>price</code>属性值就会被注入10000.</p>
<p><strong>3、@EnableConfigurationProperties 和 @ConfigurationProperties</strong></p>
<p>组件绑定配置文件的第二种方式是使用<code>@EnableConfigurationProperties</code> 和<code>@ConfigurationProperties</code>两个注解，其中<code>@EnableConfigurationProperties</code> 注解用在配置类中，有两个功能：开启指定类的配置绑定功能；将这个类注入到IOC容器。</p>
<p>比如：</p>
<p><code>Car.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//这里只需要指定要绑定的配置类中的属性</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = "mycar")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Car</span> </span>{<br>    <span class="hljs-keyword">private</span> String brand;<br>    <span class="hljs-keyword">private</span> Integer price;<br>    ...<span class="hljs-comment">//get、set方法等</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>MyConfig.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//配置类</span><br><span class="hljs-meta">@Configuration</span>  <br><span class="hljs-comment">//开启Car类的属性配置功能，并把Car注册到容器中</span><br><span class="hljs-meta">@EnableConfigurationProperties(Car.class)</span>  <br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyConfig</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<p>因为<code>@Component</code>不能用在第三方包中，所以如果<code>@ConfigurationProperties</code>在第三方包中，我们想对其进行配置，就必须使用<code>@EnableConfigurationProperties</code>这种方式。</p>
<p><strong>源码中的用法</strong></p>
<p>SpringBoot的底层源码中，常见的一种做法是在自动配置类中使用<code>@EnableConfigurationProperties</code>，并指定一个<code>xxxProperties</code>用于和配置文件中的值进行绑定。</p>
<p>比如：在<code>CacheAutoConfiguration.java</code>中</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@EnableConfigurationProperties(CacheProperties.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheAutoConfiguration</span> </span>{...}<br></code></pre></td></tr></tbody></table></figure>
<p><code>CacheProperties.java</code>绑定了配置文件:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ConfigurationProperties(prefix = "spring.cache")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheProperties</span> </span>{...}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，我们就能够在配置文件中使用<code>spring.cache</code>对cache相关属性进行配置。</p>
<h2 id="3-4-自动配置"><a href="#3-4-自动配置" class="headerlink" title="3.4 自动配置"></a>3.4 自动配置</h2><p>SpringBoot默认会在底层配置好所有的组件，自动装配所有能生效的类。我们可以在总配置文件<code>application.properties</code>中对需要修改的属性进行配置。</p>
<p>用户自己配置的参数，会以用户的优先。</p>
<p>自动配置的大概流程总结：</p>
<ul>
<li>SpringBoot先读取所有的自动配置类：<code>xxxxxAutoConfiguration</code></li>
<li>每个自动配置类按照条件生效，默认都会绑定<code>xxxxProperties</code>类，这个类里面设置了默认的值。</li>
<li><p><code>xxxProperties</code>类和配置文件进行了绑定，可以通过配置文件对默认值进行设置。</p>
</li>
<li><p>生效的配置类就会给容器中装配很多组件。只要容器中有这些组件，相当于这些功能就有了</p>
</li>
<li><p>用户可以使用<code>@Bean</code>替换底层的组件。</p>
</li>
</ul>
<p>可以通过底层源码，查看这个组件是获取的配置文件什么值。也可以通过官方文档查看如何进行配置。</p>
<p><strong>xxxxxAutoConfiguration —-&gt; 组件  —-&gt;从 xxxxProperties里面取值  —-&gt;绑定 application.properties</strong></p>
<h2 id="3-5-最佳实践"><a href="#3-5-最佳实践" class="headerlink" title="3.5 最佳实践"></a>3.5 最佳实践</h2><p>1、引入场景依赖，可以查看官方文档有哪些官方的场景启动器：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.build-systems.starters">Starters</a></p>
<p>2、如果有需求，可以查看自动配置了哪些功能，有两种方式：</p>
<ul>
<li>通过源码分析</li>
<li>在配置文件中使用<code>debug=true</code>开启自动配置报告，Negative表示不生效，Positive表示生效。</li>
</ul>
<p>3、判断配置参数是否需要修改：</p>
<ul>
<li>参照官方文档，查看如何配置：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/application-properties.html#application-properties">Common Application Properties</a></li>
<li>或者分析源码，查看如何配置。</li>
</ul>
<p>4、根据需求自定义或者替换组件。使用<code>@Component</code>或者<code>@Bean</code>注解。</p>
<p>5、也可以使用自定义器：xxxCustomizer</p>
]]></content>
      <categories>
        <category>SpringBoot2</category>
      </categories>
      <tags>
        <tag>SpringBoot2</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>深入理解String的intern()方法</title>
    <url>/2021/05/10/understanding-string-intern/</url>
    <content><![CDATA[<h1 id="一、String基本特征"><a href="#一、String基本特征" class="headerlink" title="一、String基本特征"></a>一、String基本特征</h1><ol>
<li><p>Java中的字符串String，使用<code>""</code>引起来表示。两种实例化方式：</p>
<ul>
<li><code>String s1 = “hello”;</code></li>
<li><code>String s2 = new String("hello");</code></li>
</ul>
</li>
<li><p>String声明为final的，不可被继承</p>
</li>
<li><p>String类实现了Serializable接口、Comparable接口。</p>
</li>
<li><p>String类重写了<code>equals()</code>方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//JDK 15</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">equals</span><span class="hljs-params">(Object anObject)</span> </span>{<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span> == anObject) {<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    }<br>    <span class="hljs-keyword">if</span> (anObject <span class="hljs-keyword">instanceof</span> String) {<br>        String aString = (String)anObject;<br>        <span class="hljs-keyword">if</span> (!COMPACT_STRINGS || <span class="hljs-keyword">this</span>.coder == aString.coder) {<br>            <span class="hljs-keyword">return</span> StringLatin1.equals(value, aString.value);<br>        }<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p><strong>JDK8之前，String使用char型数组存放数据，JDK9改为byte型数组</strong>。修改原因，官方描述如下，<a href="http://openjdk.java.net/jeps/254">参考</a>：</p>
<hr>
<p>We propose to change the internal representation of the String class from a UTF-16 char array to a byte array plus an encoding-flag field. The new String class will store characters encoded either as ISO-8859-1/Latin-1 (one byte per character), or as UTF-16 (two bytes per character), based upon the contents of the string. The encoding flag will indicate which encoding is used.</p>
<p>String-related classes such as AbstractStringBuilder, StringBuilder, and StringBuffer will be updated to use the same representation, as will the HotSpot VM’s intrinsic string operations.</p>
<p>This is purely an implementation change, with no changes to existing public interfaces. There are no plans to add any new public APIs or other interfaces.</p>
<p>The prototyping work done to date confirms the expected reduction in memory footprint, substantial reductions of GC activity, and minor performance regressions in some corner cases. </p>
<hr>
</li>
<li><p>String代表不可变的字符序列，详细使用可以参考<a href="https://kangshitao.github.io/2021/04/03/java-note-0901/">Java学习笔记09(1)-常用类之String</a>。</p>
</li>
<li><p>通过字面量定义的字符串存储在<strong>字符串常量池(String Pool)</strong>（JDK7将字符串常量池移到了堆中）中，目的是共享；通过<code>new</code>创建对象的方式构建的字符串存储在<strong>堆</strong>（堆中字符串常量池以外的空间）中。</p>
</li>
<li><p><strong>字符串常量池中是不会存储相同内容的字符串</strong>：</p>
<ul>
<li>String Pool 是一个固定大小的<code>Hashtable</code>（底层采用数组和链表实现，<strong>Hashtable无法扩容</strong>，这一点不同于HashMap）。如果放进String Pool的String非常多， 就会造成严重的哈希冲突，从而导致链表会很长，而链表长了后直接会造成的影响就是当调用<code>String.intern()</code>时性能会大幅下降。</li>
<li>使用<code>- XX:StringTableSize</code>可设置StringTable的长度</li>
<li>在JDK 6中<code>StringTable</code>的值默认大小为<code>1009</code>，所以如果常量池中的字符串过多就会导致效率下降很快。对于<code>StringTableSize</code>的设置没有要求。</li>
<li>在JDK 7中，<code>StringTable</code>的长度默认值是<code>60013</code>。<code>StringTableSize</code>的设置没有要求。</li>
<li>从JDK 8开始，<code>StringTable</code>长度可设置的<strong>最小值</strong>要求为<code>1009</code>。</li>
</ul>
</li>
</ol>
<h1 id="二、String的内存分配"><a href="#二、String的内存分配" class="headerlink" title="二、String的内存分配"></a>二、String的内存分配</h1><p>Java中，8中基本数据类型的常量池都是系统协调的，<strong>String类型的常量池比较特殊</strong>，它的主要使用方法有两种：</p>
<ul>
<li>直接使用<code>""</code>号，即<strong>字面量的方式，声明出来的字符串对象会直接存储在常量池</strong>中。<ul>
<li>比如：<code>String s = "hello";</code></li>
</ul>
</li>
<li>如果<strong>不是使用<code>""</code>的方式（使用new方式，或者和变量拼接等方式）声明的String对象是放在堆中的</strong>。可以使用String类提供的<code>intern()</code>方法，<code>intern()</code>方法会从字符串常量池中查询当前字符串是否存在，如果存在，直接返回字符串，若不存在就会将当前字符串放入常量池中并返回。</li>
</ul>
<p>JDK 6及以前，字符串常量池存放在永久代。</p>
<p><strong>JDK 7中，字符串常量池被移到了堆中</strong>（原因：permSize默认空间比较小；永久代垃圾回收频率低）：</p>
<ul>
<li>所有的字符串都保存在Heap中，和其他普通对象一样，调优时仅需调整堆大小即可。</li>
<li>这次改动让我们重新考虑在JDK 7中使用<code>String.intern();</code>。因为调整以后，<strong>常量池中不需要必须存储一份对象了，可以直接存储堆中的引用</strong>。也就是说，调用此方法时，<strong>如果堆中已经存在相等的String对象，会直接保存对象的引用，而不会重新创建对象</strong>。这一点的体现可以参考下文的例题。</li>
</ul>
<p>JDK 8中，字符串常量池依然是在堆中。</p>
<h1 id="三、String的基本操作"><a href="#三、String的基本操作" class="headerlink" title="三、String的基本操作"></a>三、String的基本操作</h1><ol>
<li><p>情况一：Java语言规范（<a href="https://docs.oracle.com/javase/specs/jls/se15/html/jls-3.html#jls-3.10.5">链接</a>）里要求，完全相同的字符串字面量，应该包含同样的unicode字符序列，并且必须是指向同一个String类实例。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringTest4</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        System.out.println();<span class="hljs-comment">//3142个已加载字符串常量</span><br>        System.out.println(<span class="hljs-string">"1"</span>);<span class="hljs-comment">//3143</span><br>        System.out.println(<span class="hljs-string">"2"</span>);<span class="hljs-comment">//3144</span><br>        System.out.println(<span class="hljs-string">"3"</span>);;<span class="hljs-comment">//3145</span><br>        <span class="hljs-comment">//如下的字符串"1" 到 "3"不会再次加载</span><br>        System.out.println(<span class="hljs-string">"1"</span>);<span class="hljs-comment">//3145</span><br>        System.out.println(<span class="hljs-string">"2"</span>);<span class="hljs-comment">//3145</span><br>        System.out.println(<span class="hljs-string">"3"</span>);<span class="hljs-comment">//3145</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>情况二：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Memory</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<span class="hljs-comment">//line 1</span><br>        <span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>;<span class="hljs-comment">//line 2</span><br>        Object obj = <span class="hljs-keyword">new</span> Object();<span class="hljs-comment">//line 3</span><br>        Memory mem = <span class="hljs-keyword">new</span> Memory();<span class="hljs-comment">//line 4</span><br>        mem.foo(obj);<span class="hljs-comment">//line 5</span><br>    }<span class="hljs-comment">//line 9</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">foo</span><span class="hljs-params">(Object param)</span> </span>{<span class="hljs-comment">//line 6</span><br>        String str = param.toString();<span class="hljs-comment">//line 7</span><br>        System.out.println(str);<br>    }<span class="hljs-comment">//line 8</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上述程序的内存结构如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/understandint-string-intern_1.png"></p>
</li>
</ol>
<h1 id="四、字符串拼接操作"><a href="#四、字符串拼接操作" class="headerlink" title="四、字符串拼接操作"></a>四、字符串拼接操作</h1><h2 id="1、字符串拼接的特征"><a href="#1、字符串拼接的特征" class="headerlink" title="1、字符串拼接的特征"></a>1、字符串拼接的特征</h2><p>字符串拼接有以下特征：</p>
<ol>
<li><p>常量与常量的拼接，结果在常量池，原理是<strong>编译期优化</strong>，生成字节码文件的时候，已经生成了常量的拼接结果。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        String s1 = <span class="hljs-string">"a"</span> + <span class="hljs-string">"b"</span> + <span class="hljs-string">"c"</span>;<span class="hljs-comment">//编译期优化：等同于"abc"</span><br>        String s2 = <span class="hljs-string">"abc"</span>; <span class="hljs-comment">//"abc"一定是放在字符串常量池中，将此地址赋给s2</span><br>        System.out.println(s1 == s2); <span class="hljs-comment">//true</span><br>        System.out.println(s1.equals(s2)); <span class="hljs-comment">//true</span><br>    }<br>}<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">在前端编译生成的字节码文件中，已经将s1优化为“abc”</span><br><span class="hljs-comment">如下为部分字节码文件内容：</span><br><span class="hljs-comment"> 0 ldc #7 &lt;abc&gt;    可见，s1的值已经优化为"abc"</span><br><span class="hljs-comment"> 2 astore_1</span><br><span class="hljs-comment"> 3 ldc #7 &lt;abc&gt;</span><br><span class="hljs-comment"> 5 astore_2</span><br><span class="hljs-comment"> 6 getstatic #9 &lt;java/lang/System.out&gt;</span><br><span class="hljs-comment"> 9 aload_1</span><br><span class="hljs-comment">10 aload_2</span><br><span class="hljs-comment">...</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ol>
<ol>
<li><p>常量池中不会存在相同内容的常量。</p>
</li>
<li><p>如果<strong>拼接的字符串里有变量，结果在堆中</strong>（堆中字符串常量池以外的堆空间），相当于<code>new</code>了新对象。拼接的原理是StringBuilder。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringTest</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>        String s1 = <span class="hljs-string">"a"</span>;<br>        String s2 = <span class="hljs-string">"b"</span>;<br>        String s3 = <span class="hljs-string">"ab"</span>;<br>        String s4 = s1 + s2;<br>        System.out.println(s3 == s4);<span class="hljs-comment">//false</span><br>    }<br>}<br><span class="hljs-comment">/*</span><br><span class="hljs-comment">上述的s1 + s2 的具体执行细节：(变量s是为了容易理解定义的，实际上是匿名的）</span><br><span class="hljs-comment">① StringBuilder s = new StringBuilder();</span><br><span class="hljs-comment">② s.append("a");</span><br><span class="hljs-comment">③ s.append("b");</span><br><span class="hljs-comment">④ s.toString();  --&gt; 约等于 new String("ab")</span><br><span class="hljs-comment">补充：在jdk5.0之后使用的是StringBuilder,在jdk5.0之前使用的是StringBuffer</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">s3在堆中的字符串常量池中，而s4在堆中字符串常量池以外的位置，因此二者地址不相等</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>上述程序的字节码文件如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">0 ldc #47 &lt;a&gt;<br><span class="hljs-number">2</span> astore_1<br>3 ldc #49 &lt;b&gt;<br><span class="hljs-number">5</span> astore_2<br>6 ldc #51 &lt;ab&gt;<br><span class="hljs-number">8</span> astore_3<br>9 new #33 &lt;java/lang/StringBuilder&gt;  <br><span class="hljs-number">12</span> dup<br>13 invokespecial #35 &lt;java/lang/StringBuilder.&lt;init&gt;&gt;<br><span class="hljs-number">16</span> aload_1<br>17 invokevirtual #36 &lt;java/lang/StringBuilder.append&gt; <br><span class="hljs-number">20</span> aload_2<br>21 invokevirtual #36 &lt;java/lang/StringBuilder.append&gt; <br>24 invokevirtual #40 &lt;java/lang/StringBuilder.toString&gt; <br><span class="hljs-number">27</span> astore <span class="hljs-number">4</span><br>29 getstatic #9 &lt;java/lang/System.out&gt;<br><span class="hljs-number">32</span> aload_3<br><span class="hljs-number">33</span> aload <span class="hljs-number">4</span><br><span class="hljs-number">35</span> if_acmpne <span class="hljs-number">42</span> (+<span class="hljs-number">7</span>)<br><span class="hljs-number">38</span> iconst_1<br><span class="hljs-number">39</span> goto <span class="hljs-number">43</span> (+<span class="hljs-number">4</span>)<br><span class="hljs-number">42</span> iconst_0<br>43 invokevirtual #15 &lt;java/io/PrintStream.println&gt;<br><span class="hljs-number">46</span> <span class="hljs-keyword">return</span><br></code></pre></td></tr></tbody></table></figure>
<p>通过变量拼接字符串的过程，可以总结如下，当遇到有变量的字符串拼接时：</p>
<ul>
<li>首先使用<code>new</code>方式创建<code>StringBuilder</code>对象（JDK 5.0之前是StringBuffer）</li>
<li>然后调用<code>append()</code>方法，将要拼接的字符串内容添加到<code>StringBuilder</code>对象中</li>
<li>最后调用<code>StringBuilder</code>对象的<code>toString()</code>方法，将其转换为<code>String</code>类型，赋给指定的变量。</li>
</ul>
</li>
</ol>
<p>   此外，还需要注意的是，如果字符串拼接是变量，但是是用<code>final</code>修饰的，此时这种变量就是常量，同样在编译期优化，结果存放到字符串常量池中：</p>
   <figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringTest</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">final</span> String s1 = <span class="hljs-string">"a"</span>; <span class="hljs-comment">//常量</span><br>        <span class="hljs-keyword">final</span> String s2 = <span class="hljs-string">"b"</span>;<br>        String s3 = <span class="hljs-string">"ab"</span>;<br>        String s4 = s1 + s2; <span class="hljs-comment">//此时的s4等价于"a"+"b"</span><br>        System.out.println(s3 == s4);<span class="hljs-comment">//true</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>   建议：针对于<code>final</code>修饰类、方法、基本数据类型、引用数据类型的量的结构时，能用<code>final</code>时尽量使用。这样前端编译期就能赋值，提高运行效率。</p>
<ol>
<li>如果拼接的结果调用<code>intern()</code>方法，则主动将常量池中没有的字符串对象放入池中，并返回此对象的地址（引用，reference），具体参加下一节内容。</li>
</ol>
<h2 id="2、‘-’号和append方法对比"><a href="#2、‘-’号和append方法对比" class="headerlink" title="2、‘+’号和append方法对比"></a>2、‘+’号和append方法对比</h2><p>对于字符串拼接，可以使用<code>+</code>号直接拼接字符串，也可以在<code>StringBuffer</code>/<code>StringBuilder</code>对象中使用<code>append()</code>方法，二者的效率对比如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringTest</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test6</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>        method1(<span class="hljs-number">100000</span>);<span class="hljs-comment">//3989ms</span><br>        <span class="hljs-comment">//method2(100000);//7ms</span><br>        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>        System.out.println(<span class="hljs-string">"花费的时间为："</span> + (end - start));<br>    }<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method1</span><span class="hljs-params">(<span class="hljs-keyword">int</span> highLevel)</span></span>{<br>        String src = <span class="hljs-string">""</span>;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;i &lt; highLevel;i++){<br>            src = src + <span class="hljs-string">"a"</span>;<span class="hljs-comment">//每次循环都会创建一个StringBuilder、String</span><br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method2</span><span class="hljs-params">(<span class="hljs-keyword">int</span> highLevel)</span></span>{<br>        <span class="hljs-comment">//只需要创建一个StringBuilder</span><br>        StringBuilder src = <span class="hljs-keyword">new</span> StringBuilder();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; highLevel; i++) {<br>            src.append(<span class="hljs-string">"a"</span>);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>以上结果表明，使用<code>StringBuffer</code>/<code>StringBuilder</code>对象中的<code>append()</code>方法进行字符串拼接，效率要远高于<code>+</code>号拼接String的方式。</p>
<ul>
<li>使用<code>+</code>号拼接时，<strong>每次</strong>都需要创建一个<code>StringBuffer</code>/<code>StringBuilder</code>对象，然后调用<code>append()</code>方法添加内容，最后调用<code>toString()</code>方法生成<code>String</code>对象并重新赋值。</li>
<li>使用<code>append()</code>方式，只创建了一个<code>StringBuffer</code>/<code>StringBuilder</code>对象，因此效率要高很多。</li>
<li>此外，用String的字符串拼接方式，内存中由于创建了较多的<code>StringBuilder</code>和<code>String</code>的对象，内存占用更大，如果进行GC，需要花费额外的时间。</li>
</ul>
<p>因此，实际开发中，如果需要大量的字符串操作，尽量使用<code>StringBulider</code>。</p>
<p>如果确定字符串长度不高于某个值的情况下，建议使用带参的构造器实例化<code>StringBuilder</code>，底层会一次性申请指定长度的数组，这样可以避免频繁扩容带来的效率降低。</p>
<h1 id="五、intern-的使用"><a href="#五、intern-的使用" class="headerlink" title="五、intern()的使用"></a>五、intern()的使用</h1><h2 id="1、intern（）方法"><a href="#1、intern（）方法" class="headerlink" title="1、intern（）方法"></a>1、intern（）方法</h2><p>JDK源码中<code>intern()</code>方法的定义和描述：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">Returns a canonical representation for the string object.</span><br><span class="hljs-comment">A pool of strings, initially empty, is maintained privately by the class String.</span><br><span class="hljs-comment">When the intern method is invoked, if the pool already contains a string equal to</span><br><span class="hljs-comment">this String object as determined by the equals(Object) method, then the string from</span><br><span class="hljs-comment">the pool is returned. Otherwise, this String object is added to the pool and a</span><br><span class="hljs-comment">reference to this String object is returned.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">It follows that for any two strings s and t, s.intern() == t.intern() is true if and</span><br><span class="hljs-comment">only if s.equals(t) is true.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">All literal strings and string-valued constant expressions are interned. String</span><br><span class="hljs-comment">literals are defined in section 3.10.5 of the The Java Language Specification.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Returns:</span><br><span class="hljs-comment">a string that has the same contents as this string, but is guaranteed to be from a</span><br><span class="hljs-comment">pool of unique strings.</span><br><span class="hljs-comment">*/</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> String <span class="hljs-title">intern</span><span class="hljs-params">()</span></span>;<br></code></pre></td></tr></tbody></table></figure>
<p>根据描述可知，当<code>str</code>调用<code>str.intern()</code>时，如果字符串常量池中已经有和<code>str</code>相等的字符串（使用<code>equals()</code>方法判断），则返回当前字符串（或者说字符串对象的引用）；如果没有<code>str</code>字符串的话，会在常量池中生成，然后再返回此字符串。</p>
<p><code>s.intern() == t.intern()</code>等价于<code>s.equals(t) 为 true</code></p>
<p>如果不是用<code>""</code>声明的String对象，可以使用String提供的<code>intern()</code>方法，<code>intern()</code>方法会从<strong>字符串常量池</strong>中查询当前字符串是否存在，若不存在就会将当前字符串放入常量池中，比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//返回的结果是字符串常量池中的引用，即myInfo指向了字符串常量池中的“hello"</span><br>String myInfo = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"hello"</span>).intern();<br></code></pre></td></tr></tbody></table></figure>
<p>也就是说，如果在任意字符串上调用<code>intern()</code>方法，那么其返回结果所指向的那个类实例，必须和直接以常量形式出现的字符串实例完全相同。因此，下列表达式的值必定是true：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">(<span class="hljs-string">"a"</span> + <span class="hljs-string">"b"</span> + <span class="hljs-string">"c"</span>).intern() == <span class="hljs-string">"abc"</span>;  <span class="hljs-comment">//结果为true</span><br></code></pre></td></tr></tbody></table></figure>
<p>通俗点讲，<code>Interned String</code>确保字符串在字符串常量池里只有一份拷贝，这样可以节约内存空间，加快字符串操作任务的执行速度。</p>
<p>进一步来说，例如，想要保证变量<code>s</code>指向的是字符串常量池中的数据，比如”hello”这个字符串，有两种方式：</p>
<ul>
<li>直接使用字面量定义的方式，<code>String s = "hello";</code></li>
<li>调用String类的<code>intern()</code>方法，比如<code>String s = new String("hello").intern();</code></li>
</ul>
<blockquote>
<p>无论字符串是怎样方式定义或生成的，只要调用<code>intern()</code>方法，返回的一定是此字符串在字符串常量池中的引用</p>
</blockquote>
<h2 id="2、关于new-String"><a href="#2、关于new-String" class="headerlink" title="2、关于new String()"></a>2、关于new String()</h2><p>问题引申一：如果使用<code>new String("ab")</code>方式创建字符串对象，会创建几个对象呢？答案是两个</p>
<p>通过字节码可以看出：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringNewTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        String str = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"ab"</span>);<br>    }<br>}<br><span class="hljs-comment">//以上代码的字节码文件如下：</span><br> 0 new #7 &lt;java/lang/String&gt;  //1.创建String对象<br> <span class="hljs-number">3</span> dup<br> 4 ldc #9 &lt;ab&gt;   //2.字符串常量池中的对象（数组）<br> 6 invokespecial #11 &lt;java/lang/String.&lt;init&gt;&gt;<br> <span class="hljs-number">9</span> astore_1<br><span class="hljs-number">10</span> <span class="hljs-keyword">return</span><br><span class="hljs-comment">//根据字节码文件可知，底层创建了String对象和字符串常量池中的对象"ab"</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>字符串常量池中创建了”ab”字符串对象</strong>。</p>
<p>问题引申二：如果使用<code>new String("a")+new String("b")</code>方式创建字符串对象，会创建几个对象呢？答案是6个</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringNewTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        String str = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"a"</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">"b"</span>);<br>    }<br>}<br><span class="hljs-comment">//以上程序字节码文件为：</span><br> 0 new #7 &lt;java/lang/StringBuilder&gt;  //对象1<br> <span class="hljs-number">3</span> dup<br> 4 invokespecial #9 &lt;java/lang/StringBuilder.&lt;init&gt;&gt;<br> 7 new #10 &lt;java/lang/String&gt; //对象2<br><span class="hljs-number">10</span> dup<br>11 ldc #12 &lt;a&gt;  //对象3<br>13 invokespecial #14 &lt;java/lang/String.&lt;init&gt;&gt;<br>16 invokevirtual #17 &lt;java/lang/StringBuilder.append&gt;<br>19 new #10 &lt;java/lang/String&gt;  //对象4<br><span class="hljs-number">22</span> dup<br>23 ldc #21 &lt;b&gt;  //对象5<br>25 invokespecial #14 &lt;java/lang/String.&lt;init&gt;&gt;<br>28 invokevirtual #17 &lt;java/lang/StringBuilder.append&gt;<br>31 invokevirtual #23 &lt;java/lang/StringBuilder.toString&gt; //对象6<br><span class="hljs-number">34</span> astore_1<br><span class="hljs-number">35</span> <span class="hljs-keyword">return</span><br></code></pre></td></tr></tbody></table></figure>
<p>通过字节码文件可知，一共创建了6个对象，分别为：</p>
<ul>
<li><code>new StringBuilder()</code>，字节码第0行</li>
<li><code>new String("a")</code>，字节码第7行</li>
<li>常量池的”a”，字节码第11行</li>
<li><code>new String("b")</code>，字节码第19行</li>
<li>常量池的“b“，字节码第23行</li>
<li><code>toString()</code>方法创建的<code>String</code>对象，字节码第31行</li>
</ul>
<p>这里的<code>StringBuilder</code>的<code>toString()</code>方法创建了一个<code>String</code>对象：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//StringBuilder中toString()方法的源码。JDK15</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{<br>    <span class="hljs-comment">// Create a copy, don't share the array</span><br>    <span class="hljs-keyword">return</span> isLatin1() ? StringLatin1.newString(value, <span class="hljs-number">0</span>, count)<br>        : StringUTF16.newString(value, <span class="hljs-number">0</span>, count);<br>}<br><span class="hljs-comment">//参数中的value是一个数组</span><br></code></pre></td></tr></tbody></table></figure>
<p>值得注意的是，这里<code>toString()</code>方法只创建了一个<code>String</code>对象，没有在字符串常量池中创建”ab”字符串对象，因为其直接使用数组创建字符串，而不是使用字面量的方式，所以<strong>字符串常量池中没有”ab”这个字符串</strong>。</p>
<h2 id="3、通过实例进一步理解"><a href="#3、通过实例进一步理解" class="headerlink" title="3、通过实例进一步理解"></a>3、通过实例进一步理解</h2><p>例一，参考<a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html">深入解析String#intern</a>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>    String s = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"1"</span>);<br>    s.intern();<br>    String s2 = <span class="hljs-string">"1"</span>;<br>    System.out.println(s == s2);  <span class="hljs-comment">//JDK6 false; JDK7 false</span><br><br>    String s3 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"1"</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">"1"</span>);<br>    s3.intern();<br>    String s4 = <span class="hljs-string">"11"</span>;<br>    System.out.println(s3 == s4); <span class="hljs-comment">//JDK6 false; JDK7 true</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，在JDK6中结果都是<code>false</code>，而在JDK7及以后的版本中结果为<code>false</code>和<code>true</code>。这是为什么呢？</p>
<ul>
<li><p>在JDK6及以前的版本中，常量池放在永久区（Perm区），永久区和Heap区是完全分开的。前面说过，使用<code>""</code>号声明的字符串直接在字符串常量池中生成，而new出来的String对象放在堆中。因此<code>s</code>和<code>s3</code>都是指向堆中对象的一个引用地址，<code>s2</code>和<code>s4</code>是方法区字符串常量池中对象地址，无论如何都不相等。</p>
</li>
<li><p>对于JDK7及以后的版本：</p>
<ul>
<li>先看 s 和 s2 对象。 <code>String s = new String("1");</code> 第一句代码，生成了2个对象，即常量池中的“1” 和堆中的String对象。其中s是指向堆中的String对象的引用。<code>s.intern();</code> 这一句是 s 对象去字符串常量池中寻找后发现 “1” 已经在常量池里了。因此<code>String s2 = "1";</code> 这句代码生成一个 s2的引用指向字符串常量池中的“1”对象。 结果就是 s 和 s2 的引用地址明显不同。</li>
<li>对于 s3和s4。<code>String s3 = new String("1") + new String("1");</code>这句代码生成了字符串常量池中的“1” ，此时s3引用对象内容是”11”，存放在堆中。<strong>但此时常量池中是没有 “11”对象的</strong>。接下来<code>s3.intern();</code>将 s3中的“11”字符串放入 String 常量池中，因为此时常量池中不存在“11”字符串，常规做法是跟 jdk6 那样，在常量池中生成一个 “11” 的对象，关键点是<strong>jdk7 常量池中可以直接存储堆中的引用</strong>。因此常量池中存放的是引用，这份引用指向 s3 引用的对象。 也就是说引用地址是相同的。最后<code>String s4 = "11";</code> 这句代码中”11”是显式声明的，因此会直接去常量池中创建，创建的时候发现已经有这个对象了，此时也就是指向 s3 引用对象的一个引用，所以 s4 引用就指向和 s3 一样了，最后比较 <code>s3 == s4</code> 是 true。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/understanding-string-intern_2.png"></p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/understanding-string-intern_3.png"></p>
<p>例二，将例一中的<code>intern()</code>语句下调一行：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>    String s = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"1"</span>);<br>    String s2 = <span class="hljs-string">"1"</span>;<br>    s.intern();<br>    System.out.println(s == s2); <span class="hljs-comment">//JDK6 false; JDK7 false</span><br><br>    String s3 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"1"</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">"1"</span>);<br>    String s4 = <span class="hljs-string">"11"</span>;  <span class="hljs-comment">//在字符串常量池中生成了“11”</span><br>    s3.intern();<br>    System.out.println(s3 == s4); <span class="hljs-comment">//JDK6 false; JDK7 false</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p>此时不同版本的结果都是<code>false</code>：</p>
<ul>
<li>对于s 和 s2 ，<code>s.intern();</code>，这一句往后放不会有什么影响，因为对象池中在执行第一句代码<code>String s = new String("1");</code>的时候已经生成“1”对象了。下边的s2声明都是直接从常量池中取地址引用的。 s 和 s2 的引用地址是不会相等的。</li>
<li>对于s3和s4，首先执行<code>String s4 = "11";</code>声明 s4 的时候常量池中是不存在“11”对象的，执行完毕后，“11“对象是 s4 声明产生的新对象，方法返回字符串常量池中“11”的引用赋给s4。然后再执行<code>s3.intern();</code>时，常量池中“11”对象已经存在了，因此 s3 和 s4 的引用是不同的。s3是指向堆中对象的引用，而s4是字符串常量池中的引用，所以结果是<code>false</code></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/understanding-string-intern_4.png"></p>
<h2 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h2><p>String中<code>intern()</code>的作用：</p>
<ul>
<li>在JDK 6中，<code>intern()</code>尝试将字符串对象放入字符串常量池。<ul>
<li>如果常量池中有，则不会放入，返回已有的对象地址</li>
<li>如果没有，会把此<strong>对象复制一份</strong>，放入常量池，并返回常量池中对象地址。</li>
</ul>
</li>
<li>在JDK7及以后，<code>intern()</code>尝试将字符串对象放入字符串常量池。<ul>
<li>如果常量池中有，则不会放入，返回已有的对象地址</li>
<li>如果没有，会把此<strong>对象的引用地址复制一份</strong>，放入常量池，并返回常量池中对象引用地址。</li>
</ul>
</li>
</ul>
<h2 id="5、练习"><a href="#5、练习" class="headerlink" title="5、练习"></a>5、练习</h2><p>练习1：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringExer1</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        String s = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"a"</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">"b"</span>);<span class="hljs-comment">//new String("ab")</span><br>        <span class="hljs-comment">//在上一行代码执行完以后，字符串常量池中并没有"ab"</span><br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        jdk6中：在串池中创建一个字符串"ab"</span><br><span class="hljs-comment">        jdk7中：串池中没有创建字符串"ab",</span><br><span class="hljs-comment">        而是创建一个引用，指向new String("ab")，将此引用返回</span><br><span class="hljs-comment">        */</span><br>        String s2 = s.intern();<br>        System.out.println(s2 == <span class="hljs-string">"ab"</span>);<span class="hljs-comment">//jdk6:true  jdk7:true</span><br>        System.out.println(s == <span class="hljs-string">"ab"</span>);<span class="hljs-comment">//jdk6:false  jdk7:true</span><br>        <span class="hljs-comment">//"ab"与String s3 = "ab"写法结果相同</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>练习2：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringExer2</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//执行完以后，不会在字符串常量池中会生成"ab"</span><br>        String s1 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"a"</span>) + <span class="hljs-keyword">new</span> String(<span class="hljs-string">"b"</span>);<br>        s1.intern();<br>        String s2 = <span class="hljs-string">"ab"</span>;<br>        System.out.println(s1 == s2); <span class="hljs-comment">//jdk6 false; jdk7 true</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>练习3：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringExer3</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//执行完以后，会在字符串常量池中会生成"ab"</span><br>        String s1 = <span class="hljs-keyword">new</span> String(<span class="hljs-string">"ab"</span>);<br>        s1.intern();<br>        String s2 = <span class="hljs-string">"ab"</span>;<br>        System.out.println(s1 == s2); <span class="hljs-comment">//jdk6 false; jdk7 false</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="6、intern（）的使用"><a href="#6、intern（）的使用" class="headerlink" title="6、intern（）的使用"></a>6、intern（）的使用</h2><p>实际开发中，如果程序中存在大量重复字符串，使用<code>intern()</code>会节省大量空间，与JDK版本无关。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">StringIntern2</span> </span>{<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> MAX_COUNT = <span class="hljs-number">1000</span> * <span class="hljs-number">10000</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] arr = <span class="hljs-keyword">new</span> String[MAX_COUNT];<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Integer[] data = <span class="hljs-keyword">new</span> Integer[]{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>};<br>        <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; MAX_COUNT; i++) {<br>            <span class="hljs-comment">//两种创建字符串的方式，分别为不使用intern和使用intern</span><br>            <span class="hljs-comment">//arr[i] = new String(String.valueOf(data[i % data.length]));</span><br>            arr[i] = <span class="hljs-keyword">new</span> String(String.valueOf(data[i % data.length])).intern();<br>        }<br>        <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>        System.out.println(<span class="hljs-string">"花费的时间为："</span> + (end - start));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>通过运行程序可知，使用intern()方法时，占用的空间大小相较于不使用intern()时要小很多，主要原因是因为：</p>
<ul>
<li><p>不使用<code>intern()</code>创建字符串对象，会在堆中生成大量的String对象，且不能回收，导致空间占用很大。</p>
</li>
<li><p>使用<code>intern()</code>方法创建对象，如果字符串常量池中已经存在要创建的对象，则数组元素直接指向字符串常量池中的字符串对象，无需在堆中维护过多的String对象（或者说创建之后可以被回收销毁），因此空间占用小。</p>
<blockquote>
<p>注意，两种方式在字符串常量池中创建的字符串个数是相等的，区别只是堆中字符串对象的数量不同</p>
</blockquote>
</li>
</ul>
<p>实际应用：在大的网站平台，需要内存中存储大量字符串，这时候如果字符串都调用<code>intern()</code>方法，会明显降低内存大小。</p>
<p>关于intern()方法错误的使用，也可以参考<a href="https://tech.meituan.com/2014/03/06/in-depth-understanding-string-intern.html">深入解析String#intern</a></p>
<h1 id="六、G1中的String去重操作"><a href="#六、G1中的String去重操作" class="headerlink" title="六、G1中的String去重操作"></a>六、G1中的String去重操作</h1><p>Garbage First收集器对String的去重操作，参考官方说明<a href="http://openjdk.java.net/jeps/192">JEP 192: String Deduplication in G1</a></p>
<p><strong>背景</strong>：</p>
<p>对许多Java应用（有大的也有小的）做的测试得出以下结果:</p>
<ul>
<li>堆存活数据集合里面string对象占了25%</li>
<li>堆存活数据集合里面重复的string对象有13.5%</li>
<li>string对象的平均长度是45</li>
</ul>
<p>许多大规模的Java应用的瓶颈在于内存，测试表明，在这些类型的应用里面，Java堆中存活的数据集合差不多25%是string对象。更进一步，这里面差不多一半string对象是重复的，即<code>string1.equals(string2 )=true</code>。堆上存在重复的string对象必然是一种内存的浪费。在G1垃圾收集器中实现自动持续对重复的strfing对象进行去重，这样就能避免浪费内存。</p>
<p><strong>实现</strong>：</p>
<ul>
<li>当垃圾收集器工作的时候，会访问堆上存活的对象。对每一个访问的对象都会检查是否是候选的要去重的string对象。</li>
<li>如果是，把这个对象的一个引用插入到队列中等待后续的处理。一个去重的线程在后台运行，处理这个队列。处理队列的一个元素意味着从队列删除这个元素，然后尝试去引用和它一样的string对象。</li>
<li>使用一个hashtable来记录所有的被string对象使用的不重复的char数组。当去重的时候，会查这个hashtable，来看堆上是否已经存在一个一模一样的char数组。</li>
<li>如果存在，string对象会被调整为引用那个数组，释放对原来的数组的引用，最终会被垃圾收集器回收掉。</li>
<li>如果查找失败，char数组会被插入到hashtable，这样以后的时候就可以共享这个数组。</li>
</ul>
<p><strong>命令行选项</strong>：</p>
<ul>
<li><code>UseStringDeduplication</code> (<code>bool</code>) ：开启String 去重，默认是不开启的</li>
<li><code>PrintStringDeduplicationStatistics</code> (<code>bool</code>) ：打印详细的去重统计信息</li>
<li><code>StringDeduplicationAgeThreshold</code> (<code>uintx</code>) ：达到这个年龄的String对象被认为是去重的候选对象。</li>
</ul>
]]></content>
      <categories>
        <category>JVM</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>SSM框架整合</title>
    <url>/2021/07/04/SSM-project/</url>
    <content><![CDATA[<h1 id="一、环境配置"><a href="#一、环境配置" class="headerlink" title="一、环境配置"></a>一、环境配置</h1><p>整合SSM框架，实现对书籍的增删查改功能。</p>
<p>运行环境准备，数据库建表，Maven依赖包导入，基本结构搭建。</p>
<h2 id="1、运行环境"><a href="#1、运行环境" class="headerlink" title="1、运行环境"></a>1、运行环境</h2><ul>
<li>IDEA 2020.3</li>
<li>MySQL  5.1.47</li>
<li>TomCat 9.0.46</li>
<li>Maven 3.8.1</li>
</ul>
<h2 id="2、数据库建表"><a href="#2、数据库建表" class="headerlink" title="2、数据库建表"></a>2、数据库建表</h2><p>创建数据库<code>ssmbuild</code>和表<code>books</code>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">CREATE DATABASE `ssmbuild`;<br>USE `ssmbuild`;<br><br>DROP TABLE IF EXISTS `books`;<br><br>CREATE TABLE `books` (<br>    `bookID` INT(10) NOT NULL AUTO_INCREMENT COMMENT '书id',<br>    `bookName` VARCHAR(100) NOT NULL COMMENT '书名',<br>    `bookCounts` INT(11) NOT NULL COMMENT '数量',<br>    `detail` VARCHAR(200) NOT NULL COMMENT '描述',<br>    KEY `bookID` (`bookID`)<br>) ENGINE=INNODB DEFAULT CHARSET=utf8<br><br>INSERT  INTO `books`(`bookID`,`bookName`,`bookCounts`,`detail`)VALUES<br>(1,'Java',1,'Java language'),<br>(2,'MySQL',10,'MySQL database'),<br>(3,'Linux',3,'Linux opereation system');<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、项目基本环境"><a href="#3、项目基本环境" class="headerlink" title="3、项目基本环境"></a>3、项目基本环境</h2><p>1、在IDEA中新建Maven项目，并添加web支持（也可以使用web模版创建项目）。</p>
<blockquote>
<p>如果先创建Maven项目，后添加的web支持，需要在在Project-Structure-&gt;Artifacts中给web项目在WEB-INF目录下新建lib目录，将所有jar包添加到lib目录。</p>
</blockquote>
<p>2、导入相关的pom依赖。</p>
<p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.kang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>SSMbuild<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- SSM整合需要的依赖</span><br><span class="hljs-comment">    junit，数据库驱动，连接池，servlet，jsp，mybatis，mybatis-spring，spring</span><br><span class="hljs-comment">    --&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--Junit--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--数据库驱动--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.47<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 数据库连接池,使用druid --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.1.22<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><br>        <span class="hljs-comment">&lt;!--Servlet - JSP --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>servlet-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet.jsp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jsp-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.servlet<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jstl<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!--Mybatis--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- mybatis-spring，用于整合Spring和MyBatis --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!--Spring-mvc和jdbc--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-webmvc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.9.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.9.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 配置log4j日志 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br><br><br>    <span class="hljs-comment">&lt;!-- 3、Maven资源过滤设置 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.properties<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.properties<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>3、Maven资源过滤设置，确保所有的配置文件都能够编译到out文件夹。</p>
<p>4、创建项目基本结构和配置文件。文件结构如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/SSM-project_1.png"><span class="image-caption">SSM项目基本文件结构</span></p>
<p>为了配置结构清晰，我们尽量将不同功能的配置文件单独写，使用引入的方式整合多个配置文件。</p>
<p>最后在Spring的总配置文件<code>applicationContext.xml</code>中引入其他三个Spring配置文件。</p>
<h1 id="二、MyBatis相关"><a href="#二、MyBatis相关" class="headerlink" title="二、MyBatis相关"></a>二、MyBatis相关</h1><p>MyBatis相关的配置，主要是配置数据库连接的配置文件，以及Mapper映射配置文件。</p>
<p><strong>1、数据库配置文件</strong></p>
<p><code>database.properties</code></p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 这里的名字必须加'jdbc.'前缀</span><br><span class="hljs-meta">jdbc.driver</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-meta">jdbc.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/ssmbuild?useSSL=false&amp;useUnicode=true&amp;characterEncoding=utf8</span><br><span class="hljs-meta">jdbc.username</span>=<span class="hljs-string">root</span><br><span class="hljs-meta">jdbc.password</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、编写MyBatis核心配置文件</strong></p>
<p><code>mybatis.config.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--日志工厂实现--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"logImpl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"LOG4J"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 为pojo包配置别名 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.kang.pojo"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 配置数据源的语句交给spring,在spring-dao配置文件中 --&gt;</span><br><br>    <span class="hljs-comment">&lt;!--Mapper映射，其实也可以交给spring配置--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"com/kang/dao/BookMapper.xml"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、编写数据库对应的实体类</strong></p>
<p><code>com.kang.pojo.Books.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.pojo;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Books</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> bookID;<br>    <span class="hljs-keyword">private</span> String bookName;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> bookCounts;<br>    <span class="hljs-keyword">private</span> String detail;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Books</span><span class="hljs-params">()</span> </span>{<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Books</span><span class="hljs-params">(<span class="hljs-keyword">int</span> bookID, String bookName, <span class="hljs-keyword">int</span> bookCounts, String detail)</span> </span>{<br>        <span class="hljs-keyword">this</span>.bookID = bookID;<br>        <span class="hljs-keyword">this</span>.bookName = bookName;<br>        <span class="hljs-keyword">this</span>.bookCounts = bookCounts;<br>        <span class="hljs-keyword">this</span>.detail = detail;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getBookID</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> bookID;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBookID</span><span class="hljs-params">(<span class="hljs-keyword">int</span> bookID)</span> </span>{<br>        <span class="hljs-keyword">this</span>.bookID = bookID;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getBookName</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> bookName;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBookName</span><span class="hljs-params">(String bookName)</span> </span>{<br>        <span class="hljs-keyword">this</span>.bookName = bookName;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getBookCounts</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> bookCounts;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBookCounts</span><span class="hljs-params">(<span class="hljs-keyword">int</span> bookCounts)</span> </span>{<br>        <span class="hljs-keyword">this</span>.bookCounts = bookCounts;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getDetail</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> detail;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setDetail</span><span class="hljs-params">(String detail)</span> </span>{<br>        <span class="hljs-keyword">this</span>.detail = detail;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"Books{"</span> +<br>            <span class="hljs-string">"bookID="</span> + bookID +<br>            <span class="hljs-string">", bookName='"</span> + bookName + <span class="hljs-string">'\''</span> +<br>            <span class="hljs-string">", bookCounts="</span> + bookCounts +<br>            <span class="hljs-string">", detail='"</span> + detail + <span class="hljs-string">'\''</span> +<br>            <span class="hljs-string">'}'</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、编写DAO层的Mapper接口</strong></p>
<p>DAO层定义基本的CRUD功能，供service层实现功能使用。</p>
<p><code>com.kang.dao.BookMapper</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.dao;<br><span class="hljs-keyword">import</span> com.kang.pojo.Books;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BookMapper</span> </span>{<br>    <span class="hljs-comment">//添加一本书</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addBook</span><span class="hljs-params">(Books books)</span></span>;<br><br>    <span class="hljs-comment">//根据id删除一本书</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteBookById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;  <br><br>    <span class="hljs-comment">//修改一本书的信息</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateBook</span><span class="hljs-params">(Books books)</span></span>; <br><br>    <span class="hljs-comment">//根据id查询</span><br>    <span class="hljs-function">Books <span class="hljs-title">queryBookById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;  <br> <br>    <span class="hljs-comment">//查询全部</span><br>    <span class="hljs-function">List&lt;Books&gt; <span class="hljs-title">queryAllBooks</span><span class="hljs-params">()</span></span>;  <br><br>    <span class="hljs-comment">//根据书名模糊查询</span><br>    <span class="hljs-function">List&lt;Books&gt; <span class="hljs-title">queryBookByName</span><span class="hljs-params">(String bookName)</span></span>; <br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>5、编写Mapper对应的配置文件</strong></p>
<p><code>BookMapper.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="hljs-comment">&lt;!--namespace</span><br><span class="hljs-comment">命名空间，用于绑定一个对应的DAO/Mapper接口,这里和UserMapper绑定。</span><br><span class="hljs-comment">这样相当于写了一个实现类来实现此接口。</span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.kang.dao.BookMapper"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"addBook"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"Books"</span>&gt;</span><br>        insert into books(bookName, bookCounts, detail)<br>        values (#{bookName},#{bookCounts},#{detail})<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteBookById"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"int"</span>&gt;</span><br>        delete from books where bookID=#{bookID}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateBook"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"Books"</span>&gt;</span><br>        update books set bookName=#{bookName},<br>        bookCounts=#{bookCounts},detail=#{detail}<br>        where bookID=#{bookID}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"queryBookById"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"int"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Books"</span>&gt;</span><br>        select bookID,bookName,bookCounts,detail from books <br>        where bookID = #{bookID}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"queryAllBooks"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Books"</span>&gt;</span><br>        select bookID,bookName,bookCounts,detail from books;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 根据书名模糊查询。使用concat拼接 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"queryBookByName"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"String"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Books"</span>&gt;</span><br>        select bookID,bookName,bookCounts,detail from books <br>        where bookName like concat('%',#{bookName},'%')<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>    <br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>6、编写Service层的接口和实现类</strong></p>
<p>service根据用户的实际需求，调用DAO层方法实现功能。简单起见，功能和DAO层相同，只是简单的CRUD功能。</p>
<p><code>com.kang.service.BookService</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.service;<br><span class="hljs-keyword">import</span> com.kang.pojo.Books;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">BookService</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addBook</span><span class="hljs-params">(Books books)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteBookById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateBook</span><span class="hljs-params">(Books books)</span></span>;<br><br>    <span class="hljs-function">Books <span class="hljs-title">queryBookById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br><br>    <span class="hljs-function">List&lt;Books&gt; <span class="hljs-title">queryAllBooks</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-function">List&lt;Books&gt; <span class="hljs-title">queryBookByName</span><span class="hljs-params">(String bookName)</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>service接口的实现类<code>com.kang.service.BookServiceImpl</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.service;<br><span class="hljs-keyword">import</span> com.kang.dao.BookMapper;<br><span class="hljs-keyword">import</span> com.kang.pojo.Books;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-comment">//业务层调用DAO层完成功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BookService</span></span>{<br>    <span class="hljs-keyword">private</span> BookMapper bookMapper;<br><br>    <span class="hljs-comment">//提供一个set方法，用于依赖注入</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBookMapper</span><span class="hljs-params">(BookMapper bookMapper)</span> </span>{<br>        <span class="hljs-keyword">this</span>.bookMapper = bookMapper;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addBook</span><span class="hljs-params">(Books books)</span> </span>{<br>        <span class="hljs-keyword">return</span> bookMapper.addBook(books);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">deleteBookById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>{<br>        <span class="hljs-keyword">return</span> bookMapper.deleteBookById(id);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateBook</span><span class="hljs-params">(Books books)</span> </span>{<br>        <span class="hljs-keyword">return</span> bookMapper.updateBook(books);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Books <span class="hljs-title">queryBookById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>{<br>        <span class="hljs-keyword">return</span> bookMapper.queryBookById(id);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Books&gt; <span class="hljs-title">queryAllBooks</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> bookMapper.queryAllBooks();<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Books&gt; <span class="hljs-title">queryBookByName</span><span class="hljs-params">(String bookName)</span> </span>{<br>        <span class="hljs-keyword">return</span> bookMapper.queryBookByName(bookName);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、Spring相关"><a href="#三、Spring相关" class="headerlink" title="三、Spring相关"></a>三、Spring相关</h1><p>接下来，需要在Spring中注册bean，并整合MyBatis。这里的数据源使用druid连接池。</p>
<p><strong>1、编写Spring整合MyBatis的相关配置文件</strong></p>
<p><code>spring-dao.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/context </span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span><br><br>	<span class="hljs-comment">&lt;!-- 此文件用于整合spring和mybatis，在spring中配置数据源。</span><br><span class="hljs-comment"> 	这里选用第三方数据库连接池，而不是使用Spring原生的DriverManagerDataSource</span><br><span class="hljs-comment">	--&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 1.关联数据库配置文件 --&gt;</span><br><br>	<span class="hljs-comment">&lt;!-- property-placeholder表示用一个properties文件里的内容来替换spring配置文件</span><br><span class="hljs-comment">	里使用${}的变量定义，比如我们把对数据库的配置信息配置在别的properties文件里，</span><br><span class="hljs-comment">	然后这个文件中引入即可。</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">"classpath:database.properties"</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 2.配置数据源（连接池）</span><br><span class="hljs-comment">    常用数据库连接池：dbcp\c3p0\druid\hikari</span><br><span class="hljs-comment">    这里的数据源使用druid数据库连接池</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span> = <span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.alibaba.druid.pool.DruidDataSource"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driverClassName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.driver}"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.url}"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.username}"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"${jdbc.password}"</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!-- 根据不同的数据库连接池，还可以设置其他的属性，比如关闭自动提交功能 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"defaultAutoCommit"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"false"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 3.获取SqlSessionFactory --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sqlSessionFactory"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"configLocation"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"classpath:mybatis-config.xml"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 4.获取SqlSession --&gt;</span><br>    <span class="hljs-comment">&lt;!--使用MapperScannerConfigurer自动扫描包的方式获取SqlSession--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 设置要扫描的包 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"basePackage"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.kang.dao"</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!-- 注入sqlSessionFactory --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sqlSessionFactoryBeanName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"sqlSessionFactory"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>关于Spring和MyBatis整合详情可以参考<a href="https://kangshitao.github.io/2021/06/27/spring-basis/#%E5%8D%81%E4%B8%80%E3%80%81%E6%95%B4%E5%90%88MyBatis">Spring整合MyBatis</a></p>
<p><strong>2、Spring整合service层</strong></p>
<p>为了配置结构清晰，我们将service层的相关配置单独列为一个配置文件。</p>
<p><code>spring-service.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:comtext</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/context </span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 此文件主要用于配置声明式事务相关的内容 --&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 扫描service下的包，使其注解生效 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">comtext:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">"com.kang.service"</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 2.将所有的业务类，注入到Spring，可以通过配置，或者注解实现 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookServiceImpl"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.service.BookServiceImpl"</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- bookMapper是MapperScannerConfigurer帮我们自动创建的接口代理实现类 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"bookMapper"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"bookMapper"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 3.声明式事务配置 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span> </span><br><span class="hljs-tag">          <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 注入数据源 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 4.根据需求配置是否注入AOP事务 --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、SpringMVC相关"><a href="#四、SpringMVC相关" class="headerlink" title="四、SpringMVC相关"></a>四、SpringMVC相关</h1><p>配置完Spring和MyBatis层，已经可以实现和数据库的连接了。最后是配置SpringMVC的相关配置。</p>
<h2 id="4-1-配置SpringMVC"><a href="#4-1-配置SpringMVC" class="headerlink" title="4.1 配置SpringMVC"></a>4.1 配置SpringMVC</h2><p><strong>1、配置web.xml</strong></p>
<p><code>web.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">"4.0"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 配置DispatcherServlet --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>springmvc<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 这里引用的配置文件应该是总的applicationContext.xml文件 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>classpath:applicationContext.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 启动级别 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>springmvc<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 配置过滤器，用于处理乱码 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>encodingFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>encoding<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>utf-8<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>encodingFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 为了安全起见，可以配置会话的有效期 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">session-config</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 比如设置会话有效期为15分钟 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">session-timeout</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">session-timeout</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">session-config</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>web.xml配置文件主要是配置web相关的内容，比如请求分发器和过滤器。要注意的是，这里请求分发器关联的文件应该是总的Spring配置文件，在这里是<code>applicationContext.xml</code>配置文件。</p>
<p><strong>2、配置SpringMVC的配置文件</strong></p>
<p><code>spring-mvc.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:mvc</span>=<span class="hljs-string">"http://www.springframework.org/schema/mvc"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/context</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/context/spring-context.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/mvc</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/mvc/spring-mvc.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 1.注解驱动 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:annotation-driven</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!-- 2.静态资源过滤 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:default-servlet-handler</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!-- 3.扫描包，使注解生效 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">"com.kang.controller"</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 4.配置视图解析器 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"internalResourceViewResolver"</span> </span><br><span class="hljs-tag">          <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 指定视图解析器要匹配的前缀和后缀 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"prefix"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/WEB-INF/jsp/"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"suffix"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">".jsp"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>最后，别忘了将spring配置文件整合到总的配置文件中</strong>：</p>
<p><code>applicationContext.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 引入其他的三个spring配置文件 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"classpath:spring-service.xml"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"classpath:spring-dao.xml"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"classpath:spring-mvc.xml"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>至此，配置文件已经配置结束，可以编写测试类测试是否连接上数据库，以及各个方法是否正确。</p>
<h2 id="4-2-阶段性测试"><a href="#4-2-阶段性测试" class="headerlink" title="4.2 阶段性测试"></a>4.2 阶段性测试</h2><p>编写测试类，测试整体是否配置成功：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.kang.pojo.Books;<br><span class="hljs-keyword">import</span> com.kang.service.BookService;<br><span class="hljs-keyword">import</span> org.junit.Test;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">queryBookByIdTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>        ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext<br>            (<span class="hljs-string">"applicationContext.xml"</span>);<br>        BookService bookService = context.getBean(<span class="hljs-string">"bookServiceImpl"</span>, <br>                                                  BookService.class);<br>        Books books = bookService.queryBookById(<span class="hljs-number">3</span>);<br>        System.out.println(books.toString());<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>如果正确查询到结果，说明配置成功：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Books{bookID=<span class="hljs-number">3</span>, bookName=<span class="hljs-string">'Linux'</span>, bookCounts=<span class="hljs-number">3</span>, detail=<span class="hljs-string">'Linux operation system'</span>}<br></code></pre></td></tr></tbody></table></figure>
<p>可以继续对其他方法进行测试。这里不再列举。</p>
<h1 id="五、编写Controller和前端页面"><a href="#五、编写Controller和前端页面" class="headerlink" title="五、编写Controller和前端页面"></a>五、编写Controller和前端页面</h1><p>经过上述一系列配置，已经可以在后端完成指定的功能。接下来就要和前端进行交互，即实现SpringMVC框架中的控制器。</p>
<p>控制层和前端页面交互，因此需要结合前端页面，实现功能。以下是简单的增删查改功能的实现。</p>
<h2 id="5-1-编写Controller控制器"><a href="#5-1-编写Controller控制器" class="headerlink" title="5.1 编写Controller控制器"></a>5.1 编写Controller控制器</h2><p>SpringMVC中的控制器用于处理请求 。controller层调用service层，处理请求。</p>
<p><code>com.kang.controller.BookController</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.controller;<br><br><span class="hljs-keyword">import</span> com.kang.pojo.Books;<br><span class="hljs-keyword">import</span> com.kang.service.BookService;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.stereotype.Controller;<br><span class="hljs-keyword">import</span> org.springframework.ui.Model;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.PathVariable;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;<br><br><span class="hljs-keyword">import</span> java.awt.print.Book;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping("/book")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BookController</span> </span>{<br>    <span class="hljs-comment">//controller调用service层。设置自动装配</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-meta">@Qualifier("bookServiceImpl")</span><br>    <span class="hljs-keyword">private</span> BookService bookService;<br><br>    <span class="hljs-comment">//查询全部书籍，并返回书籍展示页面视图</span><br>    <span class="hljs-meta">@RequestMapping("/allBook")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">bookList</span><span class="hljs-params">(Model model)</span></span>{<br>        List&lt;Books&gt; books = bookService.queryAllBooks();<br>        model.addAttribute(<span class="hljs-string">"bookList"</span>,books);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"allBook"</span>;<br>    }<br><br>    <span class="hljs-comment">//跳转到查询页面</span><br>    <span class="hljs-meta">@RequestMapping("/toAddBook")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toAddBook</span><span class="hljs-params">(Model model)</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"addBook"</span>;<br>    }<br><br>    <span class="hljs-comment">//addBook</span><br>    <span class="hljs-meta">@RequestMapping("/addBook")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">addBook</span><span class="hljs-params">(Books books)</span></span>{<br>        bookService.addBook(books);<br>        <span class="hljs-comment">//添加完后，重定向到书籍展示页面</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/book/allBook"</span>; <br>    }<br><br>    <span class="hljs-comment">//跳转到修改页面</span><br>    <span class="hljs-meta">@RequestMapping("/toUpdateBook")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toUpdateBook</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id,Model model)</span></span>{<br>        <span class="hljs-comment">//通过前端传递过来的id查询出来对应的book信息，反馈到前端</span><br>        Books books = bookService.queryBookById(id);<br>        model.addAttribute(<span class="hljs-string">"bookToUpdate"</span>,books);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"updateBook"</span>;<br>    }<br><br>    <span class="hljs-comment">//updateBook</span><br>    <span class="hljs-meta">@RequestMapping("/updateBook")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">updateBook</span><span class="hljs-params">(Books books)</span></span>{<br>        <span class="hljs-comment">//前端表单的内容提交到这里，会根据name对应Books的属性</span><br>        bookService.updateBook(books);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/book/allBook"</span>;<br>    }<br><br>    <span class="hljs-comment">//deleteBook</span><br>    <span class="hljs-meta">@RequestMapping("/deleteBook/{bookId}")</span><br>    <span class="hljs-comment">//使用RESTfull风格传递数据</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">deleteBook</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable("bookId")</span> <span class="hljs-keyword">int</span> id)</span></span>{<br>        bookService.deleteBookById(id);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/book/allBook"</span>;<br>    }<br>    <span class="hljs-comment">//搜索书籍</span><br>    <span class="hljs-meta">@RequestMapping("/searchBookByName")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">searchBookByName</span><span class="hljs-params">(String queryBookName,Model model)</span></span>{<br>        List&lt;Books&gt; books = bookService.queryBookByName(queryBookName);<br>        <span class="hljs-comment">//将查询到的结果重新写入到页面</span><br>        model.addAttribute(<span class="hljs-string">"bookList"</span>,books);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"allBook"</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>控制层的代码是根据客户端的功能一步步编写的，这里一次性列出了全部代码。</p>
<p>这里对基本的功能做简单的实现，仅供参考。</p>
<h2 id="5-2-编写页面"><a href="#5-2-编写页面" class="headerlink" title="5.2 编写页面"></a>5.2 编写页面</h2><h3 id="5-2-1-首页"><a href="#5-2-1-首页" class="headerlink" title="5.2.1 首页"></a>5.2.1 首页</h3><p>首页内容：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/SSM-project_2.png"><span class="image-caption">首页</span></p>
<p><code>index.jsp</code></p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;title&gt;首页&lt;/title&gt;<br>        &lt;style&gt;<br>            h3{<br>                width: <span class="hljs-number">180</span>px;<br>                height: <span class="hljs-number">38</span>px;<br>                margin:<span class="hljs-number">100</span>px auto;<br>                text-align: center;<br>                line-height: <span class="hljs-number">38</span>px;<br>                background: deepskyblue;<br>                border-radius: <span class="hljs-number">10</span>px;<br>            }<br>            a{<br>                text-decoration: none;<br>                color: black;<br>                font-size: <span class="hljs-number">18</span>px;<br>            }<br>        &lt;/style&gt;<br>    &lt;/head&gt;<br>    &lt;body&gt;<br>        &lt;h3&gt;<br>            &lt;a href=<span class="hljs-string">"${pageContext.request.contextPath}/book/allBook"</span>&gt;<br>                进入书籍展示页面<br>            &lt;/a&gt;<br>        &lt;/h3&gt;<br>    &lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>需要在<code>BookController</code>中编写<code>book/allBook</code>请求的代码。</p>
<h3 id="5-2-2-书籍展示"><a href="#5-2-2-书籍展示" class="headerlink" title="5.2.2 书籍展示"></a>5.2.2 书籍展示</h3><p>展示页面内容：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/SSM-project_3.png"><span class="image-caption">书籍展示页面</span></p>
<p><code>WEB-INF/jsp/allBook.jsp</code></p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ taglib prefix=<span class="hljs-string">"c"</span> uri=<span class="hljs-string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;title&gt;书籍展示页面&lt;/title&gt;<br>        &lt;%--使用BootStrap美化界面，使用CDN加速--%&gt;<br>        &lt;link href=<span class="hljs-string">"https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css"</span> rel=<span class="hljs-string">"stylesheet"</span>&gt;<br><br>    &lt;/head&gt;<br>    &lt;body&gt;<br>        &lt;!-- 使用BootStrap框架美化页面 --&gt;<br>        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"container"</span>&gt;<br>            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"row clearfix"</span>&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"col-md-12 column"</span>&gt;<br>                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"page-header"</span>&gt;<br>                        &lt;h1&gt;<br>                            &lt;small&gt;书籍列表----显示所有书籍&lt;/small&gt;<br>                        &lt;/h1&gt;<br>                    &lt;/div&gt;<br>                &lt;/div&gt;<br>            &lt;/div&gt;<br><br>            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"row"</span>&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"col-md-4 column"</span>&gt;<br>                    &lt;%-- 跳转到toAddBook --%&gt;<br>                    &lt;a class="btn btn-primary" href="${pageContext.request.contextPath}/book/toAddBook"&gt;新增书籍&lt;/a&gt;<br>                &lt;/div&gt;<br>                &lt;div class="col-md-4 column"&gt;&lt;/div&gt;<br>                &lt;%-- 查询书籍 --%&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-inline"</span>&gt;<br>                    &lt;form action=<span class="hljs-string">"${pageContext.request.contextPath}/book/searchBookByName"</span> method=<span class="hljs-string">"post"</span> style=<span class="hljs-string">"float: right"</span>&gt;<br>                        &lt;input type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"queryBookName"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> placeholder=<span class="hljs-string">"请输入要查询的书籍名称"</span>&gt;<br>                        &lt;input type=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"查询"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"btn btn-primary"</span>&gt;<br>                    &lt;/form&gt;<br>                &lt;/div&gt;<br>            &lt;/div&gt;<br><br>            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"row clearfix"</span>&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"col-md-12 column"</span>&gt;<br>                    &lt;table <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"table table-hover table-striped"</span>&gt;<br>                        &lt;thead&gt;<br>                            &lt;tr&gt;<br>                                &lt;th&gt;书籍编号&lt;/th&gt;<br>                                &lt;th&gt;书籍名称&lt;/th&gt;<br>                                &lt;th&gt;书籍数量&lt;/th&gt;<br>                                &lt;th&gt;书籍详情&lt;/th&gt;<br>                                &lt;th&gt;操作&lt;/th&gt;<br>                            &lt;/tr&gt;<br>                        &lt;/thead&gt;<br>                        &lt;%-- 书籍需要从前端遍历出来 --%&gt;<br>                        &lt;tbody&gt;<br>                            &lt;c:forEach <span class="hljs-keyword">var</span>=<span class="hljs-string">"book"</span> items=<span class="hljs-string">"${bookList}"</span>&gt;<br>                                &lt;tr&gt;<br>                                    &lt;td&gt;${book.bookID}&lt;/td&gt;<br>                                    &lt;td&gt;${book.bookName}&lt;/td&gt;<br>                                    &lt;td&gt;${book.bookCounts}&lt;/td&gt;<br>                                    &lt;td&gt;${book.detail}&lt;/td&gt;<br>                                    &lt;td&gt;<br>                                        &lt;%-- 跳转到修改页面的时候，传递bookID参数 --%&gt;<br>                                        &lt;a href="<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="62.334ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.089ex;" viewBox="-38.5 -863.1 26838.1 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">{pageContext.request.contextPath}/book/toUpdateBook?id=</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-67" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-43" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6F" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-71" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-75" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMATHI-50" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path>
<path stroke-width="1" id="E1-MJMATHI-62" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMATHI-55" d="M107 637Q73 637 71 641Q70 643 70 649Q70 673 81 682Q83 683 98 683Q139 681 234 681Q268 681 297 681T342 682T362 682Q378 682 378 672Q378 670 376 658Q371 641 366 638H364Q362 638 359 638T352 638T343 637T334 637Q295 636 284 634T266 623Q265 621 238 518T184 302T154 169Q152 155 152 140Q152 86 183 55T269 24Q336 24 403 69T501 205L552 406Q599 598 599 606Q599 633 535 637Q511 637 511 648Q511 650 513 660Q517 676 519 679T529 683Q532 683 561 682T645 680Q696 680 723 681T752 682Q767 682 767 672Q767 650 759 642Q756 637 737 637Q666 633 648 597Q646 592 598 404Q557 235 548 205Q515 105 433 42T263 -22Q171 -22 116 34T60 167V183Q60 201 115 421Q164 622 164 628Q164 635 107 637Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-42" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3F" d="M226 668Q190 668 162 656T124 632L114 621Q116 621 119 620T130 616T145 607T157 591T162 567Q162 544 147 529T109 514T71 528T55 566Q55 625 100 661T199 704Q201 704 210 704T224 705H228Q281 705 320 692T378 656T407 612T416 567Q416 503 361 462Q267 395 247 303Q242 279 242 241V224Q242 205 239 202T222 198T205 201T202 218V249Q204 320 220 371T255 445T292 491T315 537Q317 546 317 574V587Q317 604 315 615T304 640T277 661T226 668ZM162 61Q162 89 180 105T224 121Q247 119 264 104T281 61Q281 31 264 16T222 1Q197 1 180 16T162 61Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-70" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="503" y="0"></use>
 <use xlink:href="#E1-MJMATHI-67" x="1033" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="1513" y="0"></use>
 <use xlink:href="#E1-MJMATHI-43" x="1980" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="2740" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="3226" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="3826" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="4188" y="0"></use>
 <use xlink:href="#E1-MJMATHI-78" x="4654" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="5227" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="5588" y="0"></use>
 <use xlink:href="#E1-MJMATHI-72" x="6033" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="6485" y="0"></use>
 <use xlink:href="#E1-MJMATHI-71" x="6951" y="0"></use>
 <use xlink:href="#E1-MJMATHI-75" x="7412" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="7984" y="0"></use>
 <use xlink:href="#E1-MJMATHI-73" x="8451" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="8920" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="9282" y="0"></use>
 <use xlink:href="#E1-MJMATHI-63" x="9727" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="10160" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="10646" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="11246" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="11608" y="0"></use>
 <use xlink:href="#E1-MJMATHI-78" x="12074" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="12647" y="0"></use>
 <use xlink:href="#E1-MJMATHI-50" x="13008" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="13760" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="14289" y="0"></use>
 <use xlink:href="#E1-MJMATHI-68" x="14651" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2F" x="15227" y="0"></use>
 <use xlink:href="#E1-MJMATHI-62" x="15728" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="16157" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="16643" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="17128" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2F" x="17650" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="18150" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="18512" y="0"></use>
 <use xlink:href="#E1-MJMATHI-55" x="18997" y="0"></use>
 <use xlink:href="#E1-MJMATHI-70" x="19765" y="0"></use>
 <use xlink:href="#E1-MJMATHI-64" x="20268" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="20792" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="21321" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="21683" y="0"></use>
 <use xlink:href="#E1-MJMATHI-42" x="22149" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="22909" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="23394" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="23880" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3F" x="24401" y="0"></use>
 <use xlink:href="#E1-MJMATHI-69" x="24874" y="0"></use>
 <use xlink:href="#E1-MJMATHI-64" x="25219" y="0"></use>
 <use xlink:href="#E1-MJMAIN-3D" x="26021" y="0"></use>
</g>
</svg>{book.bookID}"&gt;修改&lt;/a&gt;<br>                                        &amp;nbsp;| &amp;nbsp;<br>                                        &lt;%-- 使用RESTFull风格跳转 --%&gt;<br>                                        &lt;a href="<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="54.639ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.089ex;" viewBox="-38.5 -863.1 23524.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">{pageContext.request.contextPath}/book/deleteBook/</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-67" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-43" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6F" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-71" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-75" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMATHI-50" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path>
<path stroke-width="1" id="E1-MJMATHI-62" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
<path stroke-width="1" id="E1-MJMATHI-42" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-70" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="503" y="0"></use>
 <use xlink:href="#E1-MJMATHI-67" x="1033" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="1513" y="0"></use>
 <use xlink:href="#E1-MJMATHI-43" x="1980" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="2740" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="3226" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="3826" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="4188" y="0"></use>
 <use xlink:href="#E1-MJMATHI-78" x="4654" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="5227" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="5588" y="0"></use>
 <use xlink:href="#E1-MJMATHI-72" x="6033" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="6485" y="0"></use>
 <use xlink:href="#E1-MJMATHI-71" x="6951" y="0"></use>
 <use xlink:href="#E1-MJMATHI-75" x="7412" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="7984" y="0"></use>
 <use xlink:href="#E1-MJMATHI-73" x="8451" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="8920" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="9282" y="0"></use>
 <use xlink:href="#E1-MJMATHI-63" x="9727" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="10160" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="10646" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="11246" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="11608" y="0"></use>
 <use xlink:href="#E1-MJMATHI-78" x="12074" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="12647" y="0"></use>
 <use xlink:href="#E1-MJMATHI-50" x="13008" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="13760" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="14289" y="0"></use>
 <use xlink:href="#E1-MJMATHI-68" x="14651" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2F" x="15227" y="0"></use>
 <use xlink:href="#E1-MJMATHI-62" x="15728" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="16157" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="16643" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="17128" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2F" x="17650" y="0"></use>
 <use xlink:href="#E1-MJMATHI-64" x="18150" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="18674" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6C" x="19140" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="19439" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="19905" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="20267" y="0"></use>
 <use xlink:href="#E1-MJMATHI-42" x="20733" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="21493" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="21978" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="22464" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2F" x="22985" y="0"></use>
</g>
</svg>{book.bookID}"&gt;删除&lt;/a&gt;<br>                                    &lt;/td&gt;<br>                                &lt;/tr&gt;<br>                            &lt;/c:forEach&gt;<br>                        &lt;/tbody&gt;<br>                    &lt;/table&gt;<br>                &lt;/div&gt;<br>            &lt;/div&gt;<br>        &lt;/div&gt;<br>    &lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>需要在<code>BookController</code>中编写处理<code>book/toAddBook</code>、<code>book/toUpdateBook</code>、<code>book/deleteBook</code>、<code>book/searchBookByName</code>请求的代码。</p>
<h3 id="5-2-3-添加书籍"><a href="#5-2-3-添加书籍" class="headerlink" title="5.2.3 添加书籍"></a>5.2.3 添加书籍</h3><p>添加书籍页面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/SSM-project_4.png"><span class="image-caption">添加书籍页面</span></p>
<p><code>WEB-INF/jsp/addBook.jsp</code></p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ taglib prefix=<span class="hljs-string">"c"</span> uri=<span class="hljs-string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;title&gt;添加书籍页面&lt;/title&gt;<br>        &lt;%--使用BootStrap美化界面，使用CDN加速--%&gt;<br>        &lt;link href=<span class="hljs-string">"https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css"</span> rel=<span class="hljs-string">"stylesheet"</span>&gt;<br><br>    &lt;/head&gt;<br>    &lt;body&gt;<br>        &lt;!-- 使用BootStrap框架美化页面 --&gt;<br>        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"container"</span>&gt;<br>            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"row clearfix"</span>&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"col-md-12 column"</span>&gt;<br>                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"page-header"</span>&gt;<br>                        &lt;h1&gt;<br>                            &lt;small&gt;书籍列表----新增书籍&lt;/small&gt;<br>                        &lt;/h1&gt;<br>                    &lt;/div&gt;<br>                &lt;/div&gt;<br>            &lt;/div&gt;<br><br>            &lt;form action=<span class="hljs-string">"${pageContext.request.contextPath}/book/addBook"</span> method=<span class="hljs-string">"post"</span> &gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-group"</span>&gt;<br>                    &lt;label for="bookname"&gt;书籍名称&lt;/label&gt;<br>                    &lt;input type=<span class="hljs-string">"text"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> id=<span class="hljs-string">"bookname"</span> name=<span class="hljs-string">"bookName"</span> required&gt;<br>                &lt;/div&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-group"</span>&gt;<br>                    &lt;label for="bookcount"&gt;书籍数量&lt;/label&gt;<br>                    &lt;input type=<span class="hljs-string">"text"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> id=<span class="hljs-string">"bookcount"</span> name=<span class="hljs-string">"bookCounts"</span> required&gt;<br>                &lt;/div&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-group"</span>&gt;<br>                    &lt;label for="bookdetail"&gt;书籍描述&lt;/label&gt;<br>                    &lt;input type=<span class="hljs-string">"text"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> id=<span class="hljs-string">"bookdetail"</span> name=<span class="hljs-string">"detail"</span> required&gt;<br>                &lt;/div&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-group"</span>&gt;<br>                    &lt;input type=<span class="hljs-string">"submit"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> value=<span class="hljs-string">"确认添加"</span>&gt;<br>                &lt;/div&gt;<br>            &lt;/form&gt;<br>        &lt;/div&gt;<br>    &lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>需要在<code>BookController</code>中编写处理<code>book/addBook</code>请求的代码。</p>
<h3 id="5-2-4-修改书籍"><a href="#5-2-4-修改书籍" class="headerlink" title="5.2.4 修改书籍"></a>5.2.4 修改书籍</h3><p>修改书籍页面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/SSM-project_5.png"><span class="image-caption">修改书籍页面</span></p>
<p><code>WEB-INF/jsp/updateBook.jsp</code></p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ taglib prefix=<span class="hljs-string">"c"</span> uri=<span class="hljs-string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;<br>&lt;%@ taglib prefix=<span class="hljs-string">"form"</span> uri=<span class="hljs-string">"http://www.springframework.org/tags/form"</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;title&gt;修改数据页面&lt;/title&gt;<br>        &lt;%--使用BootStrap美化界面，使用CDN加速--%&gt;<br>        &lt;link href=<span class="hljs-string">"https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css"</span> rel=<span class="hljs-string">"stylesheet"</span>&gt;<br><br>    &lt;/head&gt;<br>    &lt;body&gt;<br>        &lt;!-- 使用BootStrap框架美化页面 --&gt;<br>        &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"container"</span>&gt;<br>            &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"row clearfix"</span>&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"col-md-12 column"</span>&gt;<br>                    &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"page-header"</span>&gt;<br>                        &lt;h1&gt;<br>                            &lt;small&gt;修改书籍&lt;/small&gt;<br>                        &lt;/h1&gt;<br>                    &lt;/div&gt;<br>                &lt;/div&gt;<br>            &lt;/div&gt;<br><br>            &lt;form action=<span class="hljs-string">"${pageContext.request.contextPath}/book/updateBook"</span> method=<span class="hljs-string">"post"</span> &gt;<br>                &lt;%-- 设置一个隐藏域来传递id,用于更新内容 --%&gt;<br>                &lt;input type=<span class="hljs-string">"hidden"</span> name=<span class="hljs-string">"bookID"</span> value=<span class="hljs-string">"${bookToUpdate.bookID}"</span>&gt;<br><br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-group"</span>&gt;<br>                    &lt;label for="bookname"&gt;书籍名称&lt;/label&gt;<br>                    &lt;input type=<span class="hljs-string">"text"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> id=<span class="hljs-string">"bookname"</span> name=<span class="hljs-string">"bookName"</span> value=<span class="hljs-string">"${bookToUpdate.bookName}"</span> required&gt;<br>                &lt;/div&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-group"</span>&gt;<br>                    &lt;label for="bookcount"&gt;书籍数量&lt;/label&gt;<br>                    &lt;input type=<span class="hljs-string">"text"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> id=<span class="hljs-string">"bookcount"</span> name=<span class="hljs-string">"bookCounts"</span> value=<span class="hljs-string">"${bookToUpdate.bookCounts}"</span> required&gt;<br>                &lt;/div&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-group"</span>&gt;<br>                    &lt;label for="bookdetail"&gt;书籍描述&lt;/label&gt;<br>                    &lt;input type=<span class="hljs-string">"text"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> id=<span class="hljs-string">"bookdetail"</span> name=<span class="hljs-string">"detail"</span> value=<span class="hljs-string">"${bookToUpdate.detail}"</span> required&gt;<br>                &lt;/div&gt;<br>                &lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-group"</span>&gt;<br>                    &lt;input type=<span class="hljs-string">"submit"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> value=<span class="hljs-string">"确认修改"</span>&gt;<br>                &lt;/div&gt;<br>            &lt;/form&gt;<br>        &lt;/div&gt;<br>    &lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>需要在<code>BookController</code>中编写处理<code>book/updateBook</code>请求的代码。</p>
<h3 id="5-2-5-删除书籍"><a href="#5-2-5-删除书籍" class="headerlink" title="5.2.5 删除书籍"></a>5.2.5 删除书籍</h3><p>在书籍展示页面已经添加了删除选项：</p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;a href="<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="54.639ex" height="2.843ex" style="vertical-align: -0.838ex; margin-left: -0.089ex;" viewBox="-38.5 -863.1 23524.8 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">{pageContext.request.contextPath}/book/deleteBook/</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-70" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"></path>
<path stroke-width="1" id="E1-MJMATHI-61" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-67" d="M311 43Q296 30 267 15T206 0Q143 0 105 45T66 160Q66 265 143 353T314 442Q361 442 401 394L404 398Q406 401 409 404T418 412T431 419T447 422Q461 422 470 413T480 394Q480 379 423 152T363 -80Q345 -134 286 -169T151 -205Q10 -205 10 -137Q10 -111 28 -91T74 -71Q89 -71 102 -80T116 -111Q116 -121 114 -130T107 -144T99 -154T92 -162L90 -164H91Q101 -167 151 -167Q189 -167 211 -155Q234 -144 254 -122T282 -75Q288 -56 298 -13Q311 35 311 43ZM384 328L380 339Q377 350 375 354T369 368T359 382T346 393T328 402T306 405Q262 405 221 352Q191 313 171 233T151 117Q151 38 213 38Q269 38 323 108L331 118L384 328Z"></path>
<path stroke-width="1" id="E1-MJMATHI-65" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path>
<path stroke-width="1" id="E1-MJMATHI-43" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6F" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-74" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path>
<path stroke-width="1" id="E1-MJMATHI-78" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-72" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-71" d="M33 157Q33 258 109 349T280 441Q340 441 372 389Q373 390 377 395T388 406T404 418Q438 442 450 442Q454 442 457 439T460 434Q460 425 391 149Q320 -135 320 -139Q320 -147 365 -148H390Q396 -156 396 -157T393 -175Q389 -188 383 -194H370Q339 -192 262 -192Q234 -192 211 -192T174 -192T157 -193Q143 -193 143 -185Q143 -182 145 -170Q149 -154 152 -151T172 -148Q220 -148 230 -141Q238 -136 258 -53T279 32Q279 33 272 29Q224 -10 172 -10Q117 -10 75 30T33 157ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-75" d="M21 287Q21 295 30 318T55 370T99 420T158 442Q204 442 227 417T250 358Q250 340 216 246T182 105Q182 62 196 45T238 27T291 44T328 78L339 95Q341 99 377 247Q407 367 413 387T427 416Q444 431 463 431Q480 431 488 421T496 402L420 84Q419 79 419 68Q419 43 426 35T447 26Q469 29 482 57T512 145Q514 153 532 153Q551 153 551 144Q550 139 549 130T540 98T523 55T498 17T462 -8Q454 -10 438 -10Q372 -10 347 46Q345 45 336 36T318 21T296 6T267 -6T233 -11Q189 -11 155 7Q103 38 103 113Q103 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMATHI-73" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path>
<path stroke-width="1" id="E1-MJMATHI-63" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path>
<path stroke-width="1" id="E1-MJMATHI-50" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path>
<path stroke-width="1" id="E1-MJMATHI-68" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path>
<path stroke-width="1" id="E1-MJMATHI-62" d="M73 647Q73 657 77 670T89 683Q90 683 161 688T234 694Q246 694 246 685T212 542Q204 508 195 472T180 418L176 399Q176 396 182 402Q231 442 283 442Q345 442 383 396T422 280Q422 169 343 79T173 -11Q123 -11 82 27T40 150V159Q40 180 48 217T97 414Q147 611 147 623T109 637Q104 637 101 637H96Q86 637 83 637T76 640T73 647ZM336 325V331Q336 405 275 405Q258 405 240 397T207 376T181 352T163 330L157 322L136 236Q114 150 114 114Q114 66 138 42Q154 26 178 26Q211 26 245 58Q270 81 285 114T318 219Q336 291 336 325Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6B" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path>
<path stroke-width="1" id="E1-MJMATHI-64" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6C" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path>
<path stroke-width="1" id="E1-MJMATHI-42" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-70" x="0" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="503" y="0"></use>
 <use xlink:href="#E1-MJMATHI-67" x="1033" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="1513" y="0"></use>
 <use xlink:href="#E1-MJMATHI-43" x="1980" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="2740" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="3226" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="3826" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="4188" y="0"></use>
 <use xlink:href="#E1-MJMATHI-78" x="4654" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="5227" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="5588" y="0"></use>
 <use xlink:href="#E1-MJMATHI-72" x="6033" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="6485" y="0"></use>
 <use xlink:href="#E1-MJMATHI-71" x="6951" y="0"></use>
 <use xlink:href="#E1-MJMATHI-75" x="7412" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="7984" y="0"></use>
 <use xlink:href="#E1-MJMATHI-73" x="8451" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="8920" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="9282" y="0"></use>
 <use xlink:href="#E1-MJMATHI-63" x="9727" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="10160" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6E" x="10646" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="11246" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="11608" y="0"></use>
 <use xlink:href="#E1-MJMATHI-78" x="12074" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="12647" y="0"></use>
 <use xlink:href="#E1-MJMATHI-50" x="13008" y="0"></use>
 <use xlink:href="#E1-MJMATHI-61" x="13760" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="14289" y="0"></use>
 <use xlink:href="#E1-MJMATHI-68" x="14651" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2F" x="15227" y="0"></use>
 <use xlink:href="#E1-MJMATHI-62" x="15728" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="16157" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="16643" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="17128" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2F" x="17650" y="0"></use>
 <use xlink:href="#E1-MJMATHI-64" x="18150" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="18674" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6C" x="19140" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="19439" y="0"></use>
 <use xlink:href="#E1-MJMATHI-74" x="19905" y="0"></use>
 <use xlink:href="#E1-MJMATHI-65" x="20267" y="0"></use>
 <use xlink:href="#E1-MJMATHI-42" x="20733" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="21493" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6F" x="21978" y="0"></use>
 <use xlink:href="#E1-MJMATHI-6B" x="22464" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2F" x="22985" y="0"></use>
</g>
</svg>{book.bookID}"&gt;删除&lt;/a&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>点击删除的时候，会向服务器发起请求，传递<code>bookID</code>给控制层，控制层接受请求并执行删除功能。</p>
<p>也就是下面的代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping("/deleteBook/{bookId}")</span><br><span class="hljs-comment">//使用RESTfull风格传递数据</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">deleteBook</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable("bookId")</span> <span class="hljs-keyword">int</span> id)</span></span>{<br>    bookService.deleteBookById(id);<br>    <span class="hljs-comment">//删除完后会重定向到书籍展示页面</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/book/allBook"</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="5-2-6-搜索功能"><a href="#5-2-6-搜索功能" class="headerlink" title="5.2.6 搜索功能"></a>5.2.6 搜索功能</h3><p>实现一个简单的根据书名模糊搜索的功能，书籍展示页面中，查询书籍的代码为：</p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;div <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-inline"</span>&gt;<br>    &lt;form action=<span class="hljs-string">"${pageContext.request.contextPath}/book/searchBookByName"</span> method=<span class="hljs-string">"post"</span> style=<span class="hljs-string">"float: right"</span>&gt;<br>        &lt;input type=<span class="hljs-string">"text"</span> name=<span class="hljs-string">"queryBookName"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"form-control"</span> <br>               placeholder=<span class="hljs-string">"请输入要查询的书籍名称"</span>&gt;<br>        &lt;input type=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"查询"</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">"btn btn-primary"</span>&gt;<br>    &lt;/form&gt;<br>&lt;/div&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>对应地，我们应该在控制层写一个处理<code>book/searchBookByName</code>请求的代码，也就是下面的代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//搜索书籍</span><br><span class="hljs-meta">@RequestMapping("/searchBookByName")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">searchBookByName</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">    <span class="hljs-meta">@RequestParam("queryBookName")</span>String queryBookName, Model model)</span></span>{<br>    List&lt;Books&gt; books = bookService.queryBookByName(queryBookName);<br>    <span class="hljs-comment">//将查询到的结果重新写入到页面</span><br>    model.addAttribute(<span class="hljs-string">"bookList"</span>,books);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"allBook"</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><p>上述只是SSM框架整合的一个最简单的应用，只是基本的配置流程。代码参考：</p>
<p>实际开发中，可以根据需求添加相应的配置。比如：</p>
<ul>
<li>service层的事务管理功能</li>
<li>配置过滤器，解决前端向后端传递数据时的乱码问题。</li>
<li>配置消息转换器，处理控制器返回JSON数据时的乱码问题。</li>
</ul>
<p>根据项目的实际需求，添加具体的功能。</p>
<p>其中的一些配置方式也有多种，并不是固定的。比如依赖注入的方式，MyBatis中获取<code>SqlSession</code>的方式等，也需要根据实际情况选取实现方式。</p>
<hr>
<p>参考内容：<a href="http://mp.weixin.qq.com/mp/homepage?__biz=Mzg2NTAzMTExNg==&amp;hid=3&amp;sn=456dc4d66f0726730757e319ffdaa23e&amp;scene=18#wechat_redirect">狂神说SSM框架系列连载</a></p>
]]></content>
      <categories>
        <category>SSM框架</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>MyBatis</tag>
        <tag>SSM</tag>
        <tag>SpringMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统复习</title>
    <url>/2021/05/21/computer-os-review/</url>
    <content><![CDATA[<h1 id="计算机操作系统"><a href="#计算机操作系统" class="headerlink" title="计算机操作系统"></a>计算机操作系统</h1><p>本文参考<a href="https://snailclimb.gitee.io/javaguide/#/docs/operating-system/basis">JavaGuide</a></p>
<h1 id="一、操作系统基础"><a href="#一、操作系统基础" class="headerlink" title="一、操作系统基础"></a>一、操作系统基础</h1><h2 id="1-1-什么是操作系统？"><a href="#1-1-什么是操作系统？" class="headerlink" title="1.1 什么是操作系统？"></a>1.1 什么是操作系统？</h2><ul>
<li><strong>操作系统（Operating System，简称 OS）是管理计算机硬件与软件资源的程序，是计算机的基石。</strong></li>
<li><strong>操作系统本质上是一个运行在计算机上的软件程序 ，用于管理计算机硬件和软件资源。</strong> 举例：运行在你电脑上的所有应用程序都通过操作系统来调用系统内存以及磁盘等等硬件。</li>
<li><strong>操作系统存在屏蔽了硬件层的复杂性。</strong> 操作系统就像是硬件使用的负责人，统筹着各种相关事项。</li>
<li><strong>操作系统的内核（Kernel）是操作系统的核心部分，它负责系统的内存管理，硬件设备的管理，文件系统的管理以及应用程序的管理</strong>。 内核是连接应用程序和硬件的桥梁，决定着系统的性能和稳定性。</li>
</ul>
<h2 id="1-2-系统调用"><a href="#1-2-系统调用" class="headerlink" title="1.2 系统调用"></a>1.2 系统调用</h2><p>根据进程访问资源的特点，我们可以把进程在系统上的运行分为两个级别：</p>
<ul>
<li><strong>用户态(user mode) </strong>: 用户态运行的进程可以直接读取用户程序的数据。</li>
<li><strong>内核态(kernel mode)</strong>：系统态，管态。可以简单的理解内核态运行的进程或程序几乎可以访问计算机的任何资源，不受限制。特权指令比如<strong>I/O指令、清内存、设置时钟指令等</strong>只能在内核态由操作系统内核执行。用户态可以通过系统调用、异常、外围设备中断3种方式切换到内核态。</li>
</ul>
<p>用户程序中，凡是与系统态级别的资源有关的操作（如文件管理、进程控制、内存管理等)，都必须通过系统调用方式向操作系统提出服务请求，并由操作系统代为完成。也就是说，用户程序如果需要调用操作系统提供的内核态级别的子功能，就需要系统调用。</p>
<p>系统调用按功能大致可分为如下几类：</p>
<ul>
<li>设备管理。完成设备的请求或释放，以及设备启动等功能。</li>
<li>文件管理。完成文件的读、写、创建及删除等功能。</li>
<li>进程控制。完成进程的创建、撤销、阻塞及唤醒等功能。</li>
<li>进程通信。完成进程之间的消息传递或信号传递等功能。</li>
<li>内存管理。完成内存的分配、回收以及获取作业占用内存区大小及地址等功能。</li>
</ul>
<h1 id="二、进程与线程"><a href="#二、进程与线程" class="headerlink" title="二、进程与线程"></a>二、进程与线程</h1><h2 id="2-1-进程和线程的区别"><a href="#2-1-进程和线程的区别" class="headerlink" title="2.1 进程和线程的区别"></a>2.1 进程和线程的区别</h2><p><strong>进程</strong></p>
<p>进程是一段程序的执行过程，<strong>是计算机资源分配的基本单位</strong>，进程是程序的<strong>基本执行实体</strong>。同时进程拥有自己的进程控制块，系统可以利用这个进程的控制块(PCB)来控制对应的进程。</p>
<p><strong>线程</strong></p>
<p>线程是<strong>操作系统进行调度的最小单位</strong>。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。</p>
<p><strong>线程和进程的比较</strong></p>
<ul>
<li><strong>调度</strong>：线程是独立调度的基本单位，进程是资源分配的基本单位。</li>
<li><strong>拥有资源</strong>：进程是拥有资源的基本单位，而线程则不拥有系统的资源，但是线程可以访问其所属进程的资源。</li>
<li><strong>系统开销</strong>：系统创建和回收进程是需要对进程进行资源回收的。因此创建和回收进程的损耗要大于创建和回收线程的损耗。</li>
<li><strong>地址空间和其他资源</strong>：进程间各自的地址空间是独立的，线程间的地址空间是共享的。</li>
<li><strong>通信方面</strong>：进程间通信主要通过<strong>进程同步和互斥</strong>手段，而线程间可以直接读写进程数据段（如全局变量）进行通信。</li>
</ul>
<blockquote>
<p>程序：程序是一组指令的集合，是静态的代码。</p>
<p>JVM中，多个线程共享进程的堆和方法区，每个线程有自己的程序计数器、虚拟机栈、本地方法栈。参考<a href="https://kangshitao.github.io/2021/04/03/java-note-0801/#%E4%B8%80%E3%80%81%E7%A8%8B%E5%BA%8F%E3%80%81%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B">Java中程序、进程、线程的区别</a></p>
</blockquote>
<h2 id="2-2-协程和管程"><a href="#2-2-协程和管程" class="headerlink" title="2.2 协程和管程"></a>2.2 协程和管程</h2><p><strong>协程</strong></p>
<p><strong>协程（Coroutine）是用户级别的轻量级线程</strong>。一个线程可以包含多个协程，可以对比一个进程包含多个线程。<strong>协程运行在线程之上</strong>，当一个协程执行完成后，可以选择主动让出，让另一个协程运行在当前线程之上。<strong>协程并没有增加线程数量，只是在线程的基础之上通过分时复用的方式运行多个协程</strong>。协程相对独立，有自己的上下文，协程的切换由程序员控制，在<strong>用户态</strong>执行，切换的代价比线程从用户态到内核态的代价小很多。</p>
<blockquote>
<p>纤程(Fiber)<strong>与协程类似，是Windows操作系统实现的一种轻量化线程上的一个执行结构，是Windows上的协程</strong>，通常多个fiber共享一个固定的线程, 然后他们通过互相主动切换到其他fiber来交出线程的执行权， 各个子任务之间的关系非常强。</p>
</blockquote>
<p><strong>管程</strong></p>
<p><strong>管程（Monitor）</strong>在功能上和信号量及PV操作类似，属于一种<strong>进程同步互斥工具</strong>，但是具有与信号量及PV操作不同的属性。</p>
<p>一个管程是一个由过程、变量及数据结构等组成的一个集合，它们组成一个特殊的模块或软件包。进程可在任何需要的时候调用管程中的过程，但它们不能在管程之外声明的过程中直接访问管程内的数据结构。</p>
<blockquote>
<p>管程很像一个类，将共享资源封装起来，并且，如果想要访问资源的话，只能通过类里面的方法来进行访问。同时，每次只允许一个进程进入管程，从而实现互斥，</p>
</blockquote>
<p>管程的提出是为了更好的解决同步和互斥的问题。进程对共享资源的申请，释放等操作，都通过管程定义的过程来实现。这个过程还可以根据资源的情况，或接受或者阻塞进程访问，确保每次仅有一个进程使用共享资源，这样就可以统一管理对共享资源的所有访问，从而实现进程互斥。</p>
<h2 id="2-3-进程的生命周期"><a href="#2-3-进程的生命周期" class="headerlink" title="2.3 进程的生命周期"></a>2.3 进程的生命周期</h2><p>进程大致分为 5 种状态，和线程类似：</p>
<ul>
<li><strong>创建状态(new)</strong> ：进程正在被创建，尚未到就绪状态。</li>
<li><strong>就绪状态(ready)</strong> ：进程已处于准备运行状态，即进程获得了除了处理器之外的一切所需资源，一旦得到处理器资源(处理器分配的时间片)即可运行。</li>
<li><strong>运行状态(running)</strong> ：进程正在处理器上上运行(单核 CPU 下任意时刻只有一个进程处于运行状态)。</li>
<li><strong>阻塞状态(waiting)</strong> ：又称为等待状态，进程正在等待某一事件而暂停运行如等待某资源为可用或等待 IO 操作完成。即使处理器空闲，该进程也不能运行。</li>
<li><strong>结束状态(terminated)</strong> ：进程正在从系统中消失。可能是进程正常结束或其他原因中断退出运行。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-os-review_1.png"><span class="image-caption">进程的3种基本状态</span></p>
<h2 id="2-4-进程通信-同步方式："><a href="#2-4-进程通信-同步方式：" class="headerlink" title="2.4 进程通信/同步方式："></a>2.4 进程通信/同步方式：</h2><p>每个进程都有各自的用户地址空间，进程之间交换数据必须通过内核中的缓冲区，这种机制称为<strong>进程间通信IPC（InterProcess Communication）</strong>，IPC有以下几种方式，参考<a href="https://www.jianshu.com/p/c1015f5ffa74">进程间通信</a>：</p>
<ul>
<li><p><strong>共享内存(Shared memory)</strong> ：使得多个进程共享一块内存，不同进程可以及时看到对方进程中对共享内存中数据的更新。这种方式需要依靠某种同步操作，如互斥锁和信号量等。可以说这是最有用的进程间通信方式。是速度最快的IPC方式。</p>
</li>
<li><p><strong>管道/匿名管道(Pipes)</strong> ：先进先出，只能具有亲缘关系的父子进程间或者兄弟进程之间的通信。</p>
<blockquote>
<p>管道只存在于内存中的文件，实质是一个内核缓冲区，进程以先进先出的方式从缓冲区存取数据。管道只支持单向数据流，只能用于具有亲缘关系的进程之间，没有名字，且缓冲区是有限的，传送的是无格式字节流，必须事先约定数据格式。</p>
</blockquote>
</li>
<li><p><strong>命名管道(Names Pipes)</strong> : 匿名管道由于没有名字，只能用于亲缘关系的进程间通信。为了克服这个缺点，提出了命名管道。命名管道严格遵循<strong>先进先出(first in first out)</strong>。命名管道名字存放在文件系统中，内容存放在内存中，<strong>可以实现本机任意两个进程通信</strong>。</p>
<blockquote>
<p>命名管道提供了一个路径名与之关联，<strong>以命名管道的文件形式存在于文件系统中</strong>，这样，<strong>即使与命名管道的创建进程不存在亲缘关系的进程，只要可以访问该路径，就能够彼此通过命名管道相互通信</strong>，因此，不相关的进程通过命名管道也能交换数据。</p>
</blockquote>
</li>
<li><p><strong>消息队列(Message Queuing)</strong> ：<strong>消息队列是消息的链表</strong>，具有特定的格式，存放在内存中并由消息队列标识符标识。管道和消息队列的通信数据都是<strong>先进先出</strong>的原则。与管道不同的是<strong>消息队列存放在内核中</strong>，只有在内核重启(即操作系统重启)或者显示地删除一个消息队列时，该消息队列才会被真正的删除。消息队列可以实现消息的随机查询，消息不一定要以先进先出的次序读取,也可以按消息的类型读取，比 FIFO 更有优势。<strong>消息队列克服了信号承载信息量少，管道只能承载无格式字节流以及缓冲区大小受限等缺陷。</strong></p>
</li>
<li><p><strong>套接字(Sockets)</strong> : 此方法主要用于在客户端和服务器之间通过网络进行通信。套接字是支持 TCP/IP 的网络通信的基本操作单元，可以看做是不同主机之间的进程进行双向通信的端点，简单的说就是通信的两方的一种约定，用套接字中的相关函数来完成通信过程。</p>
</li>
<li><p><strong>信号量(Semaphores)</strong> ：信号量是一个计数器，用于多进程对共享数据的访问，取值为非负整数，信号量的意图在于<strong>进程间同步</strong>。这种通信方式主要用于解决与同步相关的问题并避免竞争条件。</p>
<blockquote>
<p>信号量用于同步，互斥量用于互斥。多数情况下，同步已经实现了互斥。</p>
<p>进程为了获取共享资源，需要执行三个操作，都是原子操作，在内核中实现：</p>
<p>①创建信号量</p>
<p>②等待信号量，即P操作</p>
<p>③释放信号量，即V操作</p>
</blockquote>
</li>
<li><p><strong>信号(Signal)</strong> ：信号用于通知接收进程某个事件已经发生，是Linux系统用于进程间通信或者操作的一种机制，信号可以在任何时候发给某一进程，而无需知道该进程的状态。比如程序终止信号SIGING、程序退出信号SIGQUIT等。</p>
</li>
</ul>
<h2 id="2-5-线程通信-同步方式："><a href="#2-5-线程通信-同步方式：" class="headerlink" title="2.5 线程通信/同步方式："></a>2.5 线程通信/同步方式：</h2><p>操作系统中，有三种线程同步的方式：</p>
<ul>
<li>互斥量（Mutex）：采用互斥对象机制，只有拥有互斥对象的线程才有访问公共资源的权限。因为互斥对象只有一个，所以可以保证公共资源不会被多个线程同时访问。比如 Java 中的 synchronized 关键词和各种 Lock 都是这种机制。</li>
<li>信号量（Semphares）：它允许同一时刻多个线程访问同一资源，但是需要控制同一时刻访问此资源的最大线程数量</li>
<li>事件（Event）：使用通知操作的方式来保持多线程同步，比如Java中的wait()、notify()、notifyAll()方法。</li>
</ul>
<blockquote>
<p>互斥量的加锁和解锁必须由同一个线程分别对应使用，信号量可以由一个线程释放，另一个线程得到。</p>
</blockquote>
<h2 id="2-6-进程的调度算法"><a href="#2-6-进程的调度算法" class="headerlink" title="2.6 进程的调度算法"></a>2.6 进程的调度算法</h2><p>进程调度算法是为了确定首先执行哪个进程以及最后执行哪个进程来实现最大CPU利用率，包括以下几种：</p>
<ul>
<li><p><strong>先到先服务(FCFS)调度算法</strong> : 从就绪队列中选择一个最先进入该队列的进程为之分配资源，使它立即执行并一直执行到完成或发生某事件而被阻塞放弃占用 CPU 时再重新调度。</p>
</li>
<li><p><strong>短作业优先(SJF)的调度算法</strong> : 从就绪队列中选出一个估计运行时间最短的进程为之分配资源，使它立即执行并一直执行到完成或发生某事件而被阻塞放弃占用 CPU 时再重新调度。</p>
</li>
<li><p><strong>时间片轮转调度算法</strong> : 时间片轮转调度是一种最古老，最简单，最公平且使用最广的算法，又称 RR(Round robin)调度。每个进程被分配一个时间段，称作它的时间片，即该进程允许运行的时间。</p>
</li>
<li><p><strong>多级反馈队列调度算法</strong> ：前面介绍的几种进程调度的算法都有一定的局限性。如<strong>短进程优先的调度算法，仅照顾了短进程而忽略了长进程</strong> 。多级反馈队列调度算法既能使高优先级的作业得到响应又能使短作业（进程）迅速完成。，因而它是目前<strong>被公认的一种较好的进程调度算法</strong>，UNIX 操作系统采取的便是这种调度算法。</p>
</li>
<li><p><strong>优先级调度</strong> ： 为每个流程分配优先级，首先执行具有最高优先级的进程，依此类推。具有相同优先级的进程以 FCFS 方式执行。可以根据内存要求，时间要求或任何其他资源要求来确定优先级。</p>
</li>
<li><p><strong>基于公平原则的调度算法</strong></p>
</li>
</ul>
<h2 id="2-7-死锁"><a href="#2-7-死锁" class="headerlink" title="2.7 死锁"></a>2.7 死锁</h2><p>死锁是指两个或两个以上的进程在执行过程中，由于竞争资源或者由于彼此通信而造成的一种阻塞的现象。</p>
<p>如果一组进程中的每一个进程都在等待仅由该组进程中的其它进程才能引发的事件，那么该组进程是死锁的(Deadlock)。</p>
<p>产生死锁的<strong>四大必要条件</strong>：</p>
<ul>
<li>互斥访问：资源必须处于非共享模式，即一次只有一个进程可以使用。如果另一进程申请该资源，那么必须等待直到该资源被释放为止。</li>
<li>不可抢占：资源不能被抢占。只能在持有资源的进程完成任务后，该资源才会被释放。</li>
<li>请求和保持：进程已经保持了至少一个资源，但又提出了新的资源请求，而该资源已被其他进程占有，此时请求进程被阻塞，但对自己已获得的资源保持不放。</li>
<li>循环等待：有一组等待进程 <code>{P0, P1,..., Pn}</code>， <code>P0</code> 等待的资源被 <code>P1</code> 占有，<code>P1</code> 等待的资源被 <code>P2</code> 占有，……，<code>Pn-1</code> 等待的资源被 <code>Pn</code> 占有，<code>Pn</code> 等待的资源被 <code>P0</code> 占有。</li>
</ul>
<p>以上条件必须同时满足才会造成死锁。</p>
<blockquote>
<p>进程死锁和线程死锁满足的条件是一致的，只是死锁的资源分别是进程和线程。</p>
</blockquote>
<h2 id="2-8-死锁处理"><a href="#2-8-死锁处理" class="headerlink" title="2.8 死锁处理"></a>2.8 死锁处理</h2><p>死锁的处理包括<strong>死锁预防、死锁避免、死锁检测、死锁解除</strong>四种方法。</p>
<p><strong>死锁预防</strong>：</p>
<p>只有四个条件同时满足才会产生死锁，预防死锁的方法对应就是破坏四大必要条件，由于互斥条件是非共享设备所必须的，不仅不能改变，还应该加以保持，因此主要是破坏另外三个条件：</p>
<ul>
<li><p>破坏“不可抢占性”条件：当某进程获得了部分资源，但得不到其它资源，则释放已占有的资源</p>
</li>
<li><p>破坏“请求和保持”条件：一次性分配进程在整个运行过程中所需的全部资源，破坏了“请求”的条件。分配资源时，只要有一个资源得不到分配，就不给这个进程分配其他的资源，让其等待，破坏了“保持”的条件。</p>
</li>
<li><p>破坏“循环等待”条件：给每类资源赋予一个编号，并规定每一个进程必须按编号递增的顺序请求资源，释放则相反。</p>
<blockquote>
<p>这种方式与前两种相比，资源利用率和系统吞吐量都有较明显的改善。但也存在下述问题:</p>
<p>首先，为系统中各类资源所规定的序号必须相对稳定，这就限制了新类型设备的增加。</p>
<p>其次，尽管在为资源的类型分配序号时，已经考虑到大多数作业在实际使用这些资源时的顺序，但也经常会发生这种情况：作业使用各类资源的顺序与系统规定的顺序不同，造成对资源的浪费。</p>
<p>第三，为方便用户，系统对用户在编程时所施加的限制条件应尽量少，然而这种按规定次序申请资源的方法必然会限制用户简单、自主地编程。</p>
</blockquote>
</li>
</ul>
<p><strong>死锁避免</strong>：</p>
<p>死锁避免方法中，把系统状态分为安全状态和不安全状态。系统处于安全状态时可避免发生死锁，反之，系统处于不安全状态时，可能进入死锁状态。</p>
<p>安全状态指系统能按某种进程推进顺序<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="15.817ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 6809.9 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">(P_1,P_2,...,P_n)</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path>
<path stroke-width="1" id="E1-MJMATHI-50" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path>
<path stroke-width="1" id="E1-MJMAIN-31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path>
<path stroke-width="1" id="E1-MJMAIN-32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path>
<path stroke-width="1" id="E1-MJMAIN-2E" d="M78 60Q78 84 95 102T138 120Q162 120 180 104T199 61Q199 36 182 18T139 0T96 17T78 60Z"></path>
<path stroke-width="1" id="E1-MJMATHI-6E" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path>
<path stroke-width="1" id="E1-MJMAIN-29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-28" x="0" y="0"></use>
<g transform="translate(389,0)">
 <use xlink:href="#E1-MJMATHI-50" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-31" x="908" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="1485" y="0"></use>
<g transform="translate(1931,0)">
 <use xlink:href="#E1-MJMATHI-50" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMAIN-32" x="908" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-2C" x="3027" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="3472" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="3917" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2E" x="4362" y="0"></use>
 <use xlink:href="#E1-MJMAIN-2C" x="4808" y="0"></use>
<g transform="translate(5253,0)">
 <use xlink:href="#E1-MJMATHI-50" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-6E" x="908" y="-213"></use>
</g>
 <use xlink:href="#E1-MJMAIN-29" x="6420" y="0"></use>
</g>
</svg>为每个进程<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="2.292ex" height="2.509ex" style="vertical-align: -0.671ex;" viewBox="0 -791.3 986.8 1080.4" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">P_i</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMATHI-50" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"></path>
<path stroke-width="1" id="E1-MJMATHI-69" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMATHI-50" x="0" y="0"></use>
 <use transform="scale(0.707)" xlink:href="#E1-MJMATHI-69" x="908" y="-213"></use>
</g>
</svg>分配其所需资源，直至满足每个进程对资源的最大需求，是每个进程都可以顺利完成。如果系统无法找到这样的安全序列，则处于不安全状态，<strong>有可能</strong>发生死锁。</p>
<p>避免死锁应该在资源分配时，使系统不进入不安全状态。</p>
<p>具体方法有：</p>
<ul>
<li>银行家算法。每个新进程进入系统时，必须申明在运行过程中，可能需要每种资源类型的最大单元数目，其数目不应超过系统所拥有的资源总量。当进程请求一组资源时，系统必须首先确定是否有足够的资源分配给该进程。若有，再进一步计算将这些资源分配给进程后，是否会使系统处于不安全状态。如果不会，才将资源分配给它，否则让进程等待。</li>
</ul>
<p><strong>死锁检测</strong>：Java中可以使用JConsole、JStack工具检测死锁</p>
<p><strong>死锁解除</strong>：常采用解除死锁的两种方法为抢占资源和终止进程法。</p>
<ul>
<li>抢占资源：从一个或多个进程中抢占足够数量的资源，分配个死锁进程，以解除死锁状态。</li>
<li>终止(或撤销)进程法：终止（或撤销）系统中的一个或多个死锁进程，直至打破循环环路，使系统从死锁状态解脱出来。</li>
</ul>
<h1 id="三、内存管理"><a href="#三、内存管理" class="headerlink" title="三、内存管理"></a>三、内存管理</h1><p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-os-review_2.jpg"><span class="image-caption">计算机存储系统</span></p>
<h2 id="3-1-内存管理介绍"><a href="#3-1-内存管理介绍" class="headerlink" title="3.1 内存管理介绍"></a>3.1 内存管理介绍</h2><p>内存管理的工作主要是<strong>内存的空间分配和回收（malloc和free）、地址转换（将逻辑地址转换成相应的物理地址）、内存空间的扩充、存储保护</strong>。    </p>
<h2 id="3-2-内存管理机制"><a href="#3-2-内存管理机制" class="headerlink" title="3.2 内存管理机制"></a>3.2 内存管理机制</h2><p>内存管理主要有<strong>连续分配管理方式</strong>和<strong>非连续分配管理方式</strong>两种</p>
<ul>
<li><p><strong>连续分配</strong>主要指为一个用户程序分配一个连续的内存空间，连续分配的方式包括<strong>单一连续分配、固定分区分配、动态分区分配</strong>。</p>
<ul>
<li><strong>单一连续分配</strong>，只用于单用户单进程的操作系统，</li>
<li><strong>固定分区分配</strong>，其将内存划分为多个固定大小的分区，当有空闲分区的时候，再从后续的作业队列中选择合适大小的作业装入。</li>
<li><strong>动态分区分配</strong>，OS根据程序需要，分给每个程序所需要的内存大小，但会出现<strong>内存碎片</strong>的问题。通常需要采用<strong>紧凑技术</strong>进行解决。可变分区的分配策略有以下几种：<ul>
<li><strong>首次适应算法</strong>，空闲分区以地址递增次序连接，找到大小能满足要求的第一个分区。</li>
<li><strong>循环首次适应算法</strong>，与首次适应类似，只不过每次都从上一次的位置开始查找。</li>
<li><strong>最佳适应算法</strong>，空闲分区按容量递增次序连接，找到第一个能满足要求的空闲分区。</li>
<li><strong>最坏适应算法</strong>，空闲分区以容量递减次序连接，挑选第一个最大的分区。</li>
</ul>
</li>
</ul>
<blockquote>
<p>连续分配方式会形成许多“碎片”，虽然可通过“紧凑”方法将许多碎片拼接成可用的大块空间，但须为之付出很大开销 ，因此产生了非连续分配方式。</p>
</blockquote>
</li>
<li><p><strong>非连续分配</strong>允许一个程序使用的内存分布在离散或者说不相邻的内存中，主要包括<strong>分页式存储管理、分段式存储管理、段页式存储管理</strong>三种方式：</p>
<ul>
<li><strong>分页式存储管理</strong>：主要将内存划分成大小固定的页面，在程序申请内存的时候，分配适合大小的页面。这种方式可以有效减少内存的碎片，同时不需要数据连续存放。同时内存中会维护一张<strong>页表</strong>，用于对内存地址进行转换。作业的逻辑地址：<strong>页号+页内偏移</strong>。 </li>
<li><strong>分段式存储管理</strong>：页式管理其中的页实际并无任何实际意义，而将内存分段中的每一段是有实际意义的。段式管理主要是从用户的角度出发，按照程序的自然段划分为逻辑空间。同样内存中会维护一张<strong>段表</strong>，每个段表项对应内存中的一段。内存地址借助于<strong>段表寄存器</strong>进行转换，作业的逻辑地址为：<strong>段号+段内偏移</strong></li>
<li><strong>段页式存储管理</strong>：结合了上述两种方法的优点，首先会对作业进行分段，分段之后再保存到对应的每个页中。内存管理仍然和分页式存储一致。作业的逻辑地址分为三部分：<strong>段号+页号+逻辑地址</strong>。</li>
</ul>
</li>
</ul>
<h2 id="3-3-快表和多级页表"><a href="#3-3-快表和多级页表" class="headerlink" title="3.3 快表和多级页表"></a>3.3 快表和多级页表</h2><p>在<strong>分页内存管理</strong>中，有两个问题需要解决：</p>
<ul>
<li>保证虚拟地址到物理地址的转换速度要快。</li>
<li>解决虚拟地址空间大，页表也会很大的问题。</li>
</ul>
<p>为了提高内存的空间性能，提出了多级页表的概念；但是提高空间性能是以浪费时间性能为基础的，因此为了补充损失的时间性能，提出了快表（即 TLB）的概念。 不论是快表还是多级页表实际上都利用到了程序的局部性原理。</p>
<h3 id="快表"><a href="#快表" class="headerlink" title="快表"></a>快表</h3><p>快表为了提高虚拟地址到物理地址转换速度。操作系统在页表方案基础之上，引入了快表加速虚拟地址到物理地址的转换。</p>
<p>可以把快表理解为一种特殊的高速缓存，其中的内容是页表的一部分或者全部内容。作为页表的Cache，它的作用与页表相似，但是提高了访问速率。由于使用页表做地址转换，读写内存数据时CPU要访问两次主存（第一次访问存放在主存（属于内存）的页表，第二次访问主存中指定的地址）。有了快表，有时只需要访问一次缓存，一次主存，这样可以加速查找并提高指令执行速度。</p>
<p>使用快表的地址转换流程：</p>
<ol>
<li>根据虚拟地址中的页号查快表；</li>
<li>如果该页在快表中，直接从快表中读取相应的物理地址；</li>
<li>如果该页不在快表中，就访问内存中的页表，从页表中得到物理地址，同时将页表中的该映射表项添加到快表中；</li>
<li>当快表填满后，又要登记新页时，按照一定的淘汰策略淘汰掉快表中的一个页。</li>
</ol>
<h3 id="多级页表"><a href="#多级页表" class="headerlink" title="多级页表"></a>多级页表</h3><p>引入多级页表的目的是为了避免把全部表页一直放在内存中占用过多空间，特别是那些根本不需要的页表，不需要保留在内存中。多级页表属于时间换空间的典型场景。参考<a href="https://www.polarxiong.com/archives/%E5%A4%9A%E7%BA%A7%E9%A1%B5%E8%A1%A8%E5%A6%82%E4%BD%95%E8%8A%82%E7%BA%A6%E5%86%85%E5%AD%98.html">多级页表如何节约内存</a></p>
<h2 id="3-4-分页机制和分段机制对比"><a href="#3-4-分页机制和分段机制对比" class="headerlink" title="3.4 分页机制和分段机制对比"></a>3.4 分页机制和分段机制对比</h2><p><strong>共同点：</strong></p>
<ul>
<li>分页机制和分段机制都是为了提高内存利用率，减少内存碎片。</li>
<li>页和段都是离散存储的，所以两者都是离散分配内存的方式，但是每个页和段中的内存是连续的。</li>
</ul>
<p><strong>区别：</strong></p>
<ul>
<li>页的大小是固定的，由操作系统决定；段的大小不固定，取决于当前运行的程序。</li>
<li>页是信息的物理单位，分页仅仅是为了满足操作系统内存管理的需求；段是逻辑信息的单位，在程序中可以体现为代码段、数据段，能够更好地满足用户的需要。</li>
</ul>
<h2 id="3-5-逻辑-虚拟-地址和物理地址"><a href="#3-5-逻辑-虚拟-地址和物理地址" class="headerlink" title="3.5 逻辑(虚拟)地址和物理地址"></a>3.5 逻辑(虚拟)地址和物理地址</h2><p><strong>逻辑地址</strong>由操作系统决定，是访问指令给出的地址，比如C语言里的指针，可以理解为内存里的一个地址。逻辑地址需要经过寻址方式的计算或变换才得到物理地址。</p>
<p><strong>物理地址</strong>指的是真实物理内存中的地址，即内存地址寄存器中的地址，物理地址是内存单元真正的地址。</p>
<h2 id="3-6-CPU寻址？为什么需要虚拟地址空间？"><a href="#3-6-CPU寻址？为什么需要虚拟地址空间？" class="headerlink" title="3.6 CPU寻址？为什么需要虚拟地址空间？"></a>3.6 CPU寻址？为什么需要虚拟地址空间？</h2><p><strong>CPU寻址</strong></p>
<p>现代处理器使用的是一种称为<strong>虚拟寻址(Virtual Addressing)</strong>的寻址方式。使用虚拟寻址，CPU需要将虚拟地址转换为物理地址，这样才能访问到真实物理内存。CPU中称为<strong>内存管理单元(Memory Management Unit,MMU)</strong>的硬件用于将虚拟地址转换物理地址。如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-os-review_3.png" alt=""></p>
<p><strong>为什么要有虚拟地址空间？</strong></p>
<p>如果没有虚拟地址空间，直接访问和操作物理内存，这样直接把物理地址暴露出来会带来严重问题，可能对操作系统造成伤害以及给同时运行多个程序造成困难：</p>
<ul>
<li>用户程序可以访问任意内存，寻址内存的每个字节，容易破坏操作系统，造成操作系统崩溃。</li>
<li>如果同时运行多个程序，两个程序都可以对同一个地址上的数据进行修改，造成应用程序崩溃。</li>
</ul>
<p>使用虚拟地址访问内存的优势：</p>
<ul>
<li>程序可以使用相邻的虚拟地址访问物理内存中不相邻的大内存缓冲区。</li>
<li>程序可以使用虚拟地址访问大于可用物理内存的内存缓冲区（使用硬盘空间扩展内存），实际物理内存不变，让程序认为其独占内存。当物理内存供应量变小时，内存管理器将物理内存页保存到磁盘。程序运行时，数据和代码页会根据情况在物理内存和磁盘移动（比如从磁盘读取到内存中，长时间不用又会被保存到磁盘），<strong>按需缓存</strong>，只在主存中缓存活动区域。</li>
<li>不同进程使用的虚拟地址彼此隔离。一个进程中的代码无法更改正在由另一进程或操作系统使用的物理内存。</li>
</ul>
<h1 id="四、虚拟内存"><a href="#四、虚拟内存" class="headerlink" title="四、虚拟内存"></a>四、虚拟内存</h1><h2 id="4-1-什么是虚拟内存-Virtual-Memory-？"><a href="#4-1-什么是虚拟内存-Virtual-Memory-？" class="headerlink" title="4.1 什么是虚拟内存(Virtual Memory)？"></a>4.1 什么是虚拟内存(Virtual Memory)？</h2><p><strong>虚拟内存</strong>使得应用程序认为它拥有连续的可用内存(一个连续完整的地址空间)，而实际上，它通常是被分隔成多个物理内存碎片，还有部分暂时存储在<strong>外部磁盘存储器</strong>上，在需要时进行数据交换。使用虚拟内存技术的系统使得大型程序的编写变得更容易，对真正的物理内存的使用也更有效率。</p>
<p>虚拟内存不仅仅是“使用硬盘空间扩展内存”这么简单，其重要意义在于<strong>虚拟内存定义了一个连续的虚拟地址空间</strong>，使程序的编写难度降。并且，<strong>把内存扩展到硬盘空间只是使用虚拟内存的必然结果，虚拟内存空间会存在硬盘中，并且会根据需要被内存缓存</strong>，有的操作系统还会在内存不够的情况下，将某一进程的内存全部放入硬盘空间中，并在切换到该进程时再从硬盘读取（这也是为什么Windows会经常假死的原因）。</p>
<p><strong>虚拟内存的意义</strong>：</p>
<ul>
<li>它把主存看作为一个存储在硬盘上的虚拟地址空间的高速缓存，并且只在主存中缓存活动区域（按需缓存）。</li>
<li>它为每个进程提供了一个一致的地址空间，从而降低了程序员对内存管理的复杂性</li>
<li>它还保护了每个进程的地址空间不会被其他进程破坏。</li>
</ul>
<h2 id="4-2-局部性原理"><a href="#4-2-局部性原理" class="headerlink" title="4.2 局部性原理"></a>4.2 局部性原理</h2><p><strong>局部性原理</strong>是虚拟内存技术的基础，正是因为程序运行具有局部性原理，才可以只装入部分程序到内存就开始运行。</p>
<p>局部性原理体现在两个方面：</p>
<ul>
<li><strong>时间局部性</strong>：如果程序中的某条指令一旦执行，不久后该指令可能再次执行；如果某数据被访问过，不久后该数据可能再次被访问。产生时间局部性的原因，是因为程序中存在大量的循环操作。</li>
<li><strong>空间局部性</strong>：一旦程序访问了某个存储单元，不久后其附近的存储单元也将被访问，即程序在一段时间内访问的地址，可能集中在一定的范围之内，这是因为指令通常是顺序存放、顺序执行的，数据也一般是以向量、数组、表的形式存储的。</li>
</ul>
<p>时间局部性通过将近来使用的指令和数据保存到高速缓存存储器中，并使用高速缓存的层次结构实现。</p>
<p>空间局部性通常是使用较大的高速缓存，并将预取机制集成到高速缓存控制逻辑中实现。</p>
<p>虚拟内存技术实际上就是建立了“内存-外存”的两级存储器的结构，利用局部性原理实现高速缓存。</p>
<blockquote>
<p>基于局部性原理，在程序装入时，可以将程序的一部分装入内存，而将其他部分留在外存，就可以启动程序执行。由于外存往往比内存大很多，所以我们运行的软件的内存大小实际上可以比系统实际内存大小大的。</p>
<p>程序执行过程中，当所访问的信息不在内存中时，由操作系统将所需要的部分调入内存，然后继续执行程序。另一方面，操作系统将内存中暂时不使用的内容换到外存上，从而腾出空间存放将要调入内存的信息。这样计算机好像为用户提供了一个比实际内存大得多的存储器，即虚拟存储器（虚拟内存）</p>
</blockquote>
<h2 id="4-3-虚拟内存的技术实现"><a href="#4-3-虚拟内存的技术实现" class="headerlink" title="4.3 虚拟内存的技术实现"></a>4.3 虚拟内存的技术实现</h2><p>虚拟内存的实现需要建立在离散分配的内存管理方式的基础上。实现方式有三种：</p>
<ul>
<li><strong>请求分页存储管理</strong>。建立在分页管理之上，为了支持虚拟存储器功能而增加了<strong>请求调页</strong>和<strong>页面置换</strong>功能。请求分页是目前最常用的一种实现虚拟存储器的方法。请求分页存储管理系统中，在作业开始运行之前，仅装入当前要执行的部分段即可运行。假如在作业运行的过程中发现要访问的页面不在内存，则由处理器通知操作系统按照对应的页面置换算法将相应的页面调入到主存，同时操作系统也可以将暂时不用的页面置换到外存中。</li>
<li><strong>请求分段存储管理</strong>。建立在分段存储管理之上，增加了<strong>请求调段</strong>、<strong>分段置换</strong>功能。请求分段储存管理方式就如同请求分页储存管理方式一样，在作业开始运行之前，仅装入当前要执行的部分段即可运行；在执行过程中，可使用请求调入中断动态装入要访问但又不在内存的程序段；当内存空间已满，而又需要装入新的段时，根据置换功能适当调出某个段，以便腾出空间而装入新的段。</li>
<li><strong>请求段页式存储管理</strong></li>
</ul>
<blockquote>
<p>请求分页存储管理和分页存储管理的不同：请求分页是建立在分页管理之上的，根本区别是<strong>是否将作业的全部地址空间同时装入主存</strong>，请求分页存储管理不要求将作业全部地址空间同时装入主存，因此请求分页存储管理可以提供虚拟内存，而分页存储管理则不能。</p>
<p>请求分页和分页的实现都需要具备以下条件：</p>
<p>①一定容量的内存和外存，载入程序时，只需要将程序的一部分装入内存，将其他部分留在外存，然后程序就可以执行了。</p>
<p>②<strong>缺页中断</strong>：如果需执行的指令或访问的数据尚未在内存（称为缺页或缺段），则由处理器通知操作系统将相应的页面或段调入到内存，然后继续执行程序。</p>
<p>③<strong>虚拟地址空间</strong>：逻辑地址到物理地址的变换。</p>
</blockquote>
<h2 id="4-4-页面置换算法"><a href="#4-4-页面置换算法" class="headerlink" title="4.4 页面置换算法"></a>4.4 页面置换算法</h2><p>当发生缺页中断时，如果当前内存中并没有空闲的页面，操作系统必须在内存中选择一个页面将其移出内存，以便为即将调入的页面让出空间。<strong>页面置换算法</strong>就是用来选择淘汰哪一页，主要有以下几种算法：</p>
<ul>
<li><p><strong>OPT算法（最佳页面置换算法，Optimal,OPT)</strong>：选择被淘汰的页面将是以后永不使用的，或者是在最长时间内不再被访问的页面，可以保证获得最低的缺页率。但是由于人们无法预知一个页面多长时间不再被访问，因此该算法无法实现，一般作为衡量其他置换算法的方法。</p>
</li>
<li><p><strong>FIFO算法（先进先出页面置换算法，First In First Out）</strong>：淘汰最先进入的页面，即选择内存中驻留时间最久的页面淘汰。该算法实现简单，但会将那些经常被访问的页面也被换出，从而使缺页率升高。</p>
<blockquote>
<p>FIFO算法还会产生<strong>当分配的物理块数增大而缺页率不减反增的异常现象</strong>，称为<strong>Belady异常</strong>。只有FIFO算法可能出现Belady异常，而LRU和OPT算法永远不会。</p>
</blockquote>
</li>
<li><p><strong>LRU算法（最近最久未使用页面置换算法，Least Currently Used）</strong>：LRU 淘汰最近最久未使用的页面，其思想是过去一段时间内未使用的页面，在最近的将来也不会被访问。有两种实现方式：</p>
<ul>
<li>方式一：在内存中维护一个所有页面的链表。当一个页面被访问时，将这个页面移到链表表头。这样就能保证链表表尾的页面是最近最久未访问的。</li>
<li>方式二：为每个页面设置一个访问字段，记录页面自上次被访问以来所经历的时间T，淘汰页面时将现有页面中T值最大的页面淘汰。</li>
</ul>
<blockquote>
<p>LRU性能较好，但需要寄存器和栈的硬件支持，LRU是堆栈类的算法，理论上可以证明，堆栈类算法不可能出现Belady异常，FIFO算法基于队列实现，不是堆栈类算法。</p>
<p><a href="https://leetcode-cn.com/problems/lru-cache/">LRU算法题</a></p>
</blockquote>
</li>
<li><p><strong>LFU（最少使用页面置换算法，Least Frequently Used）</strong>：选择最近时期使用最少的页面进行淘汰。</p>
<p><a href="https://leetcode-cn.com/problems/lfu-cache/">LFU算法题</a></p>
</li>
<li><p><strong>Clock算法（时钟置换算法，或最近未用算法NRU）</strong>：LRU的一种近似算法。简单Clock 算法，只需为每页设置一位访问位，再将内存中的所有页面都通过链接指针链接成一个循环队列。当某页被访问时，其访问位被置1。置换算法在选择一页淘汰时，只需检查页的访问位。如果是0，就选择该页换出;若为1，则重新将它置0，暂不换出，给予该页第二次驻留内存的机会，再按照FIFO算法检查下一个页面。当检查到队列中的最后一个页面时，若其访问位仍为 1，则再返回到队首去检查第一个页面。进阶的Clock算法需要考虑置换代价。</p>
<blockquote>
<p>由于该算法是循环地检查各页面的使用情况，故称为Clock算法。但因该算法只有一位访问位，只能用它表示该页是否已经使用过，而置换时是将未使用过的页面换出去，故又把该算法称为<strong>最近未用算法或NRU(Not Recently Used)算法</strong>。</p>
</blockquote>
</li>
</ul>
]]></content>
      <categories>
        <category>CS基础</category>
      </categories>
      <tags>
        <tag>操作系统</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习笔记13-IO流</title>
    <url>/2021/04/16/java-note-1301/</url>
    <content><![CDATA[<h1 id="一、File类"><a href="#一、File类" class="headerlink" title="一、File类"></a>一、File类</h1><h2 id="1、File类的使用"><a href="#1、File类的使用" class="headerlink" title="1、File类的使用"></a>1、File类的使用</h2><p><code>java.io.File</code>类的一个对象，表示一个<strong>文件</strong>或一个<strong>文件目录</strong>，与平台无关。</p>
<p><code>File</code>能新建、删除、重命名文件和目录，但不能访问文件内容本身，访问文件内容需要使用输入输出流。</p>
<p>Java中表示一个真实存在的文件或目录，必须有一个<code>File</code>对象，但Java程序的一个<code>File</code>对象可能没有一个真实存在的文件或目录。</p>
<p><code>File</code>对象可以作为参数传递给流的构造器。</p>
<h2 id="2、构造File类对象"><a href="#2、构造File类对象" class="headerlink" title="2、构造File类对象"></a>2、构造File类对象</h2><p><code>File</code>类的构造器有四种：</p>
<ul>
<li><code>public File(String pathname)</code>：以pathname为路径创建File对象，可以是绝对路径和相对路径。</li>
<li><code>public File(String parent,String child)</code>：以parent为父路径，child为子路径创建File对象。</li>
<li><code>public File(File parentFile,String childPath)</code>：根据父File对象和子文件路径创建File对象。</li>
<li><code>public File(URI uri)</code>：根据给定的url创建File对象。</li>
</ul>
<blockquote>
<ol>
<li>IDEA中，main方法中默认的相对路径是当前project下，Test方法则是默认当前module。</li>
<li>路径中每级目录之间用路径分隔符隔开，Windows和Dos系统默认采用<code>\</code>表示，UNIX和URL使用<code>/</code>表示分隔符。</li>
<li>为了支持跨平台，File类提供了常量<code>public static final String separator</code>，它能根据不同系统动态提供分隔符。</li>
</ol>
</blockquote>
<p>代码示例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileTest</span> </span>{<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//构造器1</span><br>        File file1 = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"hello.txt"</span>);  <br>        File file2 =  <span class="hljs-keyword">new</span> File(<span class="hljs-string">"D:Java\\JavaSenior\\day08\\hello.txt"</span>);<br><br>        System.out.println(file1);  <span class="hljs-comment">// hello.txt</span><br>        System.out.println(file2);  <span class="hljs-comment">// D:Java\JavaSenior\day08\hello.txt</span><br>        <span class="hljs-comment">//构造器2：</span><br>        File file3 = <span class="hljs-keyword">new</span> File(<span class="hljs-string">"D:Java"</span>,<span class="hljs-string">"JavaSenior"</span>);<br>        System.out.println(file3); <span class="hljs-comment">// D:Java\JavaSenior</span><br><br>        <span class="hljs-comment">//构造器3：</span><br>        File file4 = <span class="hljs-keyword">new</span> File(file3,<span class="hljs-string">"hi.txt"</span>);<br>        System.out.println(file4); <span class="hljs-comment">// D:Java\JavaSenior\hi.txt</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、File类中的方法"><a href="#3、File类中的方法" class="headerlink" title="3、File类中的方法"></a>3、File类中的方法</h2><p><code>File</code>类中的常用方法：</p>
<p>File类的<strong>获取</strong>功能：</p>
<ul>
<li><code>public String getAbsolutePath()</code>：获取绝对路径</li>
<li><code>public String getPath()</code>：获取路径</li>
<li><code>public String getName()</code>：获取名称</li>
<li><code>public String getParent()</code>：获取上层文件目录路径。若无，返回null</li>
<li><code>public long length()</code>：获取文件长度（即：字节数）。不能获取目录的长度。</li>
<li><code>public long lastModified()</code>：获取最后一次的修改时间，毫秒值</li>
<li><code>public String[] list()</code>：获取<strong>指定目录</strong>下的所有文件或者文件目录的名称数组</li>
<li><code>public File[] listFiles()</code>：获取<strong>指定目录</strong>下的所有文件或者文件目录的File数组</li>
</ul>
<p>FIle类的<strong>重命名</strong>功能：</p>
<ul>
<li><code>public boolean renameTo(File dest)</code>：把当前文件重命名为指定的文件路径，要求当前文件必须存在的且目标dest不存在。</li>
</ul>
<p>File类的<strong>判断</strong>功能：</p>
<ul>
<li><code>public boolean isDirectory()</code>：判断是否是文件目录</li>
<li><code>public boolean isFile()</code>：判断是否是文件</li>
<li><code>public boolean exists()</code>：判断是否存在</li>
<li><code>public boolean canRead()</code>：判断是否可读</li>
<li><code>public boolean canWrite()</code>：判断是否可写</li>
<li><code>public boolean isHidden()</code>：判断是否隐藏</li>
</ul>
<p>File类的<strong>创建</strong>功能：</p>
<ul>
<li><code>public boolean createNewFile()</code>：创建文件。若文件存在，则不创建，返回false</li>
<li><code>public boolean mkdir()</code>：创建文件目录。如果此文件目录存在，就不创建。如果此文件目录的上层目录不存在，也不创建。</li>
<li><code>public boolean mkdirs()</code>：创建文件目录。如果此文件目录存在，就不创建。如果上层文件目录不存在，一并创建。</li>
</ul>
<p>File类的<strong>删除</strong>功能：</p>
<ul>
<li><p><code>public boolean delete()</code>：删除文件或者文件目录</p>
<blockquote>
<p>Java中的删除不经过回收站。</p>
<p>如果要删除的文件目录不为空，则删除失败。</p>
</blockquote>
</li>
</ul>
<h1 id="二、IO流的原理及分类"><a href="#二、IO流的原理及分类" class="headerlink" title="二、IO流的原理及分类"></a>二、IO流的原理及分类</h1><h2 id="1、IO流概述"><a href="#1、IO流概述" class="headerlink" title="1、IO流概述"></a>1、IO流概述</h2><p>Java中，对于数据的输入/输出操作以<code>流(stream)</code>的方式进行。</p>
<p><strong>流的分类</strong>：</p>
<ul>
<li><p>根据操作的<strong>数据单位</strong>不同，分为：<code>字节流（8 bit）</code>，<code>字符流（16 bit）</code></p>
</li>
<li><p>根据流的<strong>流向</strong>不同，分为：<code>输入流</code>、<code>输出流</code></p>
</li>
<li>根据流的<strong>角色</strong>不同，分为：<code>节点流</code>、<code>处理流</code></li>
</ul>
<p>IO流的四个基类，其他类都是继承自这四个抽象类：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>（抽象基类）</th>
<th>字节流</th>
<th>字符流</th>
</tr>
</thead>
<tbody>
<tr>
<td>输入流</td>
<td><code>InputStream</code></td>
<td><code>Reader</code></td>
</tr>
<tr>
<td>输出流</td>
<td><code>OutputStream</code></td>
<td><code>Writer</code></td>
</tr>
</tbody>
</table>
</div>
<p>IO流的类层次图：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1301_1.svg">
</div>

<p><strong>节点流</strong>：直接从数据源或目的地读写数据。</p>
<p>上图中的<code>FileInputStream</code>/<code>FileOutputStream</code>/<code>FileReader</code>/<code>FileWrider</code>都是节点流。</p>
<p><strong>处理流</strong>：不直接连接到数据源或目的地，而是“连接”在已存在的流（节点流或处理流）之上，通过对数据的处理为程序提供更强大的读写功能。比如缓冲流、打印流等。</p>
<h2 id="2、IO流基类"><a href="#2、IO流基类" class="headerlink" title="2、IO流基类"></a>2、IO流基类</h2><p><code>InputStream</code>和<code>Reader</code>是所有输入流的基类，分别用于字节流和字符流。二者的典型实现类分别为<code>FileInputStream</code>和<code>FileReader</code>，使用<code>FileInputStream</code>和<code>FileReader</code>从文件系统中的某个文件中获得输入字节/字符。</p>
<p><strong>InputStream</strong>中的方法：</p>
<ul>
<li><code>int read()</code>：从输入流中读取数据的下一个字节。返回0-255内的int字节值，如果到达流末尾，返回-1</li>
<li><code>int read(byte[] b)</code>：从输入流中最多将b.length个字节的数据读入byte数组中。如果到达流末尾，返回-1，否则以整数形式返回实际读取的字节数。</li>
<li><code>int read(byte[] b, int off, int len)</code>：读取最多len个字节数据，存放到数组b中off以后的位置。如果到达流末尾，返回-1</li>
<li><code>public void close() throws IOException</code>：关闭此输入流，并释放与该流关联的所有系统资源。</li>
</ul>
<p><strong>Reader</strong>中的方法：</p>
<ul>
<li><code>int read()</code>：读取单个字符，作为整数读取的字符，范围在0-65535之间（0x00-0xff，2个字节的Unicode码），如果到达流末尾，返回-1</li>
<li><code>int read(char[] c)</code></li>
<li><code>int read(char[] c, int off, int len)</code></li>
<li><code>public void close() throws IOException</code></li>
</ul>
<p><code>OutputStream</code>和<code>Writer</code>是所有输出流的基类，其典型实现类分别是<code>FileOutputStream</code>和<code>Writer</code>，用于写出数据。</p>
<p><strong>OutputStream</strong>中的方法：</p>
<ul>
<li><code>void write(int b)</code>：将单个字节b写入指定的输出文件</li>
<li><code>void write(byte[] b)</code>：将字节数组b中的数据写出到文件</li>
<li><code>void write(byte[] b,int off, int len)</code>：将数组中从off开始的长度为len的所有字节写出到文件</li>
<li><code>void flush()</code>：刷新</li>
<li><code>void close()</code>：关闭</li>
</ul>
<p><strong>Writer</strong>中的方法：</p>
<ul>
<li><code>void write(int c)</code>：将单个字符c写入指定的输出文件</li>
<li><code>void write(char[] c)</code>：将字符数组c中的数据写出到文件</li>
<li><code>void write(char[] c,int off, int len)</code>：将数组中从off开始的长度为len的所有字符写出到文件</li>
<li><code>void flush()</code>：刷新</li>
<li><code>void close()</code>：关闭</li>
</ul>
<blockquote>
<p>IO流部署于内存里的资源，GC无法回收该资源，操作结束后，必须要<strong>显式关闭文件IO资源</strong>。</p>
</blockquote>
<h1 id="三、节点流（文件流）"><a href="#三、节点流（文件流）" class="headerlink" title="三、节点流（文件流）"></a>三、节点流（文件流）</h1><p><code>FileInputStream</code>/<code>FileOutputStream</code>/<code>FileReader</code>/<code>FileWrider</code>都是节点流，用于读入/读出数据。</p>
<p>节点流的构造器，以<code>FileInputStream</code>为例，其余都相似：</p>
<ul>
<li><code>public FileInputStream(File file)</code>：根据File对象file创建输入节点流</li>
<li><code>public FileInputStream(String name)</code>：根据name创建输入节点流，其实底层还是根据字符串创建了File对象，再使用第一个构造器。</li>
</ul>
<p>读入/读出数据的大体步骤：</p>
<ul>
<li>创建File类对象，指明要操作的文件</li>
<li>提供具体的节点流</li>
<li>调用<code>read</code>/<code>write</code>方法<code>读入</code>/<code>写出</code>数据</li>
<li>关闭流</li>
</ul>
<p>应用实例，将文件1的内容读取到控制台，然后复制到文件2：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileInputOutputStreamTest</span></span>{<br>    FileInputStream fis = <span class="hljs-keyword">null</span>;<br>    FileOutputStream fos = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span>{<br>        <span class="hljs-comment">//1&amp;2. 创建File对象，创建文件流</span><br>        fis = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"hello1.txt"</span>));<br>        fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"hello2.txt"</span>));<br>        <span class="hljs-comment">//3.进行读写操作</span><br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">int</span> len;<br>        <span class="hljs-keyword">while</span>((len = fis.read(buffer)) != -<span class="hljs-number">1</span>){<br>            fos.write(buffer,<span class="hljs-number">0</span>,len); <span class="hljs-comment">//这里必须是长度为len，读多少写多少</span><br>        }<br>    }<span class="hljs-keyword">catch</span>(IOException e){<br>        e.printStackTrace();<br>    }<span class="hljs-keyword">finally</span>{ <span class="hljs-comment">//4.关闭操作。为保证关闭操作一定会执行，写在finally中</span><br>        <span class="hljs-keyword">if</span>(fos != <span class="hljs-keyword">null</span>){<br>            <span class="hljs-keyword">try</span>{<br>                fos.close();<br>            }<span class="hljs-keyword">catch</span> (IOException e){<br>                e.printStackTrace();<br>            }<br>        }<br>        <span class="hljs-keyword">if</span>(fis != <span class="hljs-keyword">null</span>){<br>            <span class="hljs-keyword">try</span>{<br>                fis.close();<br>            }<span class="hljs-keyword">catch</span> (IOException e){<br>                e.printStackTrace();<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<ol>
<li><p>字符流只能处理字符，操作普通文本文件(<code>.txt</code>,<code>.java</code>,<code>.c</code>,<code>.cpp</code>等)，<code>.doc</code>不是文本文件。</p>
</li>
<li><p>字节流可以操作普通文本文件，也可以操作<code>.mp3</code>,<code>.avi</code>,<code>.rmvb</code>,<code>.mp4</code>,<code>.jpg</code>,<code>.doc</code>,<code>.ppt</code>等。</p>
</li>
<li>使用<code>read()</code>读取文件时，必须保证文件存在。</li>
<li><code>FileWriter</code>/<code>FileOutputStream</code>有两个构造器，一个参数的构造器，默认对原有文件进行覆盖。两个参数的构造器，第二个参数是<code>append</code>，用于判断是进行追加还是覆盖。如果文件不存在，则自动创建。</li>
<li>字符流底层也是用字节流实现的。</li>
</ol>
</blockquote>
<h1 id="四、缓冲流"><a href="#四、缓冲流" class="headerlink" title="四、缓冲流"></a>四、缓冲流</h1><p>缓冲流是为了提高读写速度，在使用时创建内部缓冲区（默认缓冲区大小为8192字节，8KB）的一种处理流。缓冲流要“套接”在节点流之上才能使用。</p>
<p>根据数据操作单位不同，有两种输入输出缓冲流：</p>
<ul>
<li><code>BufferedInputStream</code>/<code>BufferedOutputStream</code></li>
<li><code>BufferedReader</code>/<code>BufferedWriter</code></li>
</ul>
<p>下面以 <code>BufferedInputStream</code>/<code>BufferedOutputStream</code>为例，说明缓冲流的原理及使用方法。</p>
<p><code>BufferedInputStream</code>读取数据时，先一次性读取8KB数据存入缓冲区，然后读操作从缓冲区中获取数据。</p>
<p><code>BufferedOutputStream</code>写入数据时，先写到缓冲区中，将缓冲区写满，然后write操作从缓冲区中写到文件中。使用<code>flush()</code>可以强制将缓冲区的内容全部写入输出流。</p>
<p>关闭流时，只需要关闭最外层即可，最外层关闭时会自动将节点流关闭。</p>
<p>缓冲流关闭时会自动执行<code>flush</code>操作。</p>
<p>使用缓冲流读入/读出数据的大体步骤：</p>
<ul>
<li>创建File类对象，指明要操作的文件</li>
<li>提供具体的节点流</li>
<li>创建缓冲流</li>
<li>调用<code>read</code>/<code>write</code>方法<code>读入</code>/<code>写出</code>数据</li>
<li>关闭缓冲流</li>
</ul>
<p>代码实例，使用缓冲流复制视频：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileInputOutputStreamTest</span></span>{<br>    BufferedInputStream bis = <span class="hljs-keyword">null</span>;<br>    BufferedOutputStream bos = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span>{<br>        <span class="hljs-comment">//1&amp;2. 创建File对象，创建文件流</span><br>        FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"视频1.mp4"</span>));<br>        FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"视频2.mp4"</span>));<br>        <span class="hljs-comment">//3.创建缓冲流</span><br>        <span class="hljs-comment">//默认缓冲区大小是8192Byte，可以指定大小</span><br>        bis = <span class="hljs-keyword">new</span> BufferedInputStream(fis); <br>        bos = <span class="hljs-keyword">new</span> BufferedOutputStream(fos);<br>        <span class="hljs-comment">//4.进行读写操作</span><br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">int</span> len;<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        读取的时候，先一次性将缓冲区存满，然后每次read操作从缓冲区读取1024字节到数组buffer中。</span><br><span class="hljs-comment">        写入的时候，先将缓冲区写满，然后再根据字节数组，每次将1024字节写入文件。</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">while</span>((len = bis.read(buffer)) != -<span class="hljs-number">1</span>){<br>            bos.write(buffer,<span class="hljs-number">0</span>,len);<br>        }<br>    }<span class="hljs-keyword">catch</span>(IOException e){<br>        e.printStackTrace();<br>    }<span class="hljs-keyword">finally</span>{ <span class="hljs-comment">//5.关闭操作。只需要关闭最外层即可，且会自动调用flush方法。</span><br>        <span class="hljs-keyword">if</span>(bos != <span class="hljs-keyword">null</span>){<br>            <span class="hljs-keyword">try</span>{<br>                bos.close();<br>            }<span class="hljs-keyword">catch</span> (IOException e){<br>                e.printStackTrace();<br>            }<br>        }<br>        <span class="hljs-keyword">if</span>(bis != <span class="hljs-keyword">null</span>){<br>            <span class="hljs-keyword">try</span>{<br>                bis.close();<br>            }<span class="hljs-keyword">catch</span> (IOException e){<br>                e.printStackTrace();<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、转换流"><a href="#五、转换流" class="headerlink" title="五、转换流"></a>五、转换流</h1><h2 id="1、转换流概述"><a href="#1、转换流概述" class="headerlink" title="1、转换流概述"></a>1、转换流概述</h2><p><strong>转换流</strong>用于字节流和字符流之间的转换，Java中有两个转换流：</p>
<ul>
<li><code>InputStreamReader</code>：将InputStream转换为Reader，字节、字节数组→字符数组、字符串，相当于解码。有以下常用构造器：<ul>
<li><code>public InputStreamReader(InputStream in)</code>：使用默认字符集对<code>in</code>进行解码</li>
<li><code>public InputStreamReader(InputStream in, String charsetName)</code>：使用指定字符集解码</li>
</ul>
</li>
<li><code>OutputStreamWriter</code>：将Writer转换为OutputStream，字符数组、字符串→字节、字节数组，相当于编码。有构造器：<ul>
<li><code>public OutputStreamWriter(OutputStream out)</code>：使用默认字符集（字符编码）对<code>out</code>进行编码</li>
<li><code>public OutputStreamWriter(OutputStream out, String charsetName)</code>：使用指定字符集（字符编码）编码</li>
</ul>
</li>
</ul>
<blockquote>
<ol>
<li>字符流底层操作是基于字节流，使用转换流进行转换。过程为：文本1—&gt;字节流—&gt;InputStreamReader—&gt;字符流—&gt;程序—&gt;字符流—&gt;OutputStreamWriter—&gt;字节流—&gt;文本2</li>
<li>对于字符数据，使用字符流操作更高效。</li>
<li>转换流通常用于处理文件乱码问题，实现编码和解码操作。</li>
<li>未解决疑问：JDK源码中将UTF-8描述为字符集(charset)，好像没有区分字符集和字符编码的概念？Java中字符编码器是什么东西？</li>
</ol>
</blockquote>
<p>具体用法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//输入</span><br>FileInputStream fis = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"dbcp1.txt"</span>);<br>InputStreamReader isr = <span class="hljs-keyword">new</span> InputStreamReader(fis,<span class="hljs-string">"UTF-8"</span>);<br><span class="hljs-comment">//输出</span><br>FileOutputStream fos = <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">"dbcp2.txt"</span>);<br>OutputStreamWriter osw = <span class="hljs-keyword">new</span> OutputStreamWriter(fos,<span class="hljs-string">"gbk"</span>);<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、字符编码"><a href="#2、字符编码" class="headerlink" title="2、字符编码"></a>2、字符编码</h2><ul>
<li><p><strong>字符集（Charset）</strong>：字符集指的是一个系统支持的所有抽象字符的集合。字符集中的每个字符的位置叫做<strong>码位（Code Point）</strong>，码位上的值为<strong>码位值（Code point value）</strong>。<strong>字符集就是把抽象字符映射为码位值</strong>。常见的字符集有GB2312、GBK、GB18030、Big5、Unicode、ASCII等字符集。</p>
</li>
<li><p><strong>字符编码（Character Encoding）</strong>：字符编码是一种映射规则，根据这个映射规则可以将某个字符映射成其他形式的数据（比如比特模式、自然数序列、8位组、电脉冲等），以便在计算机中存储和传输。简而言之就是字符编码是字符集和实际存储数值之间的转换关系。</p>
</li>
</ul>
<blockquote>
<ol>
<li>总结：字符集建立起数字和字符之间的索引关系。某个字符在计算机中怎么表示，具体占用几个字符等，这就需要编码规则来解决，即字符编码，它规定了字符如何编码成二进制，存储在计算机中。</li>
<li>直接使用字符集中的码位值存储，会造成空间浪费，比如本来ASCII字符只需要一个字节，如果直接使用字符集编码，需要三个字节，因此出现了UTF-8等变长编码，其对于ASCII字符仍然使用一个字节存储。</li>
<li>Unicode出现之前，几乎所有的字符集和其编码方式都是绑定的，可以说字符集就是编码方式。</li>
<li>Unicode字符集有多种编码方式，即UTF-8、UTF-16、UTF-32等。</li>
</ol>
</blockquote>
<p><strong>问题一，关于ASCII码、ANSI和ISO8859-XXX：</strong></p>
<p><strong>ASCII</strong>码是最早出现的字符集，包括128个字符，字符集表如下：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1301_2.png">
</div>



<p><strong>ANSI</strong>是一种字符代码，表示<strong>扩展的ASCII编码</strong>。对于<code>0x00~0x7F</code>的128个字符，与ASCII码一致，超过此范围的使用<code>0x80~0xFFFF</code>来编码。这种<strong>使用多个字节来代表一个字符的各种汉字延伸编码的方式，称为ANSI编码</strong>，比如GB2312、GBK、GB18030、Big5、Shift_JIS等。</p>
<ul>
<li>在英文的Windows操作系统中，ANSI编码表示ISO-8859-1编码(Latin-1，西欧常用字符，包括德法两国的字母)。</li>
<li>在简体中文的Windows操作系统中，ANSI编码表示GBK编码。</li>
<li>在繁体中文的Windows操作系统中，ANSI编码表示Big5编码。</li>
<li>在日文的Windows操作系统中，ANSI编码表示Shift_JIS编码</li>
</ul>
<p>欧洲国家对ASCII码进行扩充，只扩充128-255这一段，0-127与ASCII码相同，形成了在欧洲国家的一些子标准，比如<strong>ISO8859-1字符集</strong>、<strong>ISO8859-2字符集</strong>等，具体可以参考<a href="https://baike.baidu.com/item/ISO8859">链接</a>。</p>
<p><strong>问题二，关于GBxxxx编码：</strong></p>
<p><strong>GB2312</strong>（或GB2312-80）是最早出现的汉字编码，收录6763个汉字，由于其不能处理一些罕见字，出现了<strong>GBK</strong>编码，兼容GB2312，并且包括了<strong>BIG5</strong>的所有汉字。</p>
<p>2000年发布了<strong>GB18030</strong>字符集，采用单字节、双字节、四字节三种编码方式，完全兼容ASCII码和GBK码。2005年又进行了修订与扩展，推出了<strong>GB18030-2005</strong>，共收录70244个汉字。</p>
<p><strong>问题三，Unicode和UTF-8的关系：</strong></p>
<p>结论：<strong>UTF-8是Unicode的实现方式之一</strong>。</p>
<p><strong>Unicode是字符集</strong>，为每个字符规定了唯一的编号。实现它的方式有多种，比如UTF-8、UTF-16、UTF-32等字符编码都是Unicode的实现方式，Unicode字符集具体存储成什么样的字节流，取决于字符编码方案。</p>
<p><strong>UTF-8是一种变长的编码方式</strong>，每次8个位传输数据，使用1-4个字节表示一个符号，根据不同的符号而变化字节长度 。UTF-16是每次16个位传输数据，具体可参考<a href="https://www.cnblogs.com/skynet/archive/2011/05/03/2035105.html">链接1</a>和<a href="https://zhuanlan.zhihu.com/p/260192496">链接2</a>。</p>
<p>UTF-8的编码方式，参考<a href="http://www.ruanyifeng.com/blog/2007/10/ascii_unicode_and_utf-8.html">链接</a>：</p>
<div align="center">
    <img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/java-note-1301_3.png">
</div>



<h1 id="六、标准输入输出流"><a href="#六、标准输入输出流" class="headerlink" title="六、标准输入输出流"></a>六、标准输入输出流</h1><p>标准输入输入流，分别代表系统标准的输入和输出设备，默认输入设备是键盘，默认输出设备是显示器：</p>
<ul>
<li><p><code>System.in</code>：标准的输入流，默认从键盘输入，类型是InputStream，其源码为：<code>public static final InputStream in</code>.</p>
</li>
<li><p><code>System.out</code>：标准的输出流，默认从控制台输出，类型是PrintStream，其源码为：<code>public static final PrintStream out</code>.</p>
</li>
</ul>
<p><code>System</code>类的<code>set</code>方法可以重新指定输入和输出的流：</p>
<ul>
<li><code>public static void setIn(InputStream in)</code></li>
<li><code>public static void setOut(PrintStream out)</code></li>
</ul>
<p>例题，使用标准输入输出流，从键盘输入字符，将读取到的整行字符串转出大写输出，并继续输出，直到输入“exit”时退出程序：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SystemStreamTest</span> </span>{<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    方法一：使用Scanner实现，调用next()返回一个字符串</span><br><span class="hljs-comment">    方法二：使用System.in实现。</span><br><span class="hljs-comment">    		System.in  ---&gt;  转换流 ---&gt; BufferedReader的readLine()</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        BufferedReader br = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">//System.in是InputStream类型</span><br>            InputStreamReader isr = <span class="hljs-keyword">new</span> InputStreamReader(System.in);<br>            br = <span class="hljs-keyword">new</span> BufferedReader(isr);<br>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {<br>                System.out.println(<span class="hljs-string">"请输入字符串："</span>);<br>                String data = br.readLine();<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">"exit"</span>.equalsIgnoreCase(data)) {<br>                    System.out.println(<span class="hljs-string">"程序结束"</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                }<br>                String upperCase = data.toUpperCase();<br>                System.out.println(upperCase);<br>            }<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-keyword">if</span> (br != <span class="hljs-keyword">null</span>) {<br>                <span class="hljs-keyword">try</span> { br.close();} <br>                <span class="hljs-keyword">catch</span> (IOException e) {e.printStackTrace();}<br>            }<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="七、打印流"><a href="#七、打印流" class="headerlink" title="七、打印流"></a>七、打印流</h1><p>打印流<code>PrintStream</code>和<code>PrintWriter</code>提供了一系列重载的<code>print()</code>和<code>println()</code>方法，用于多种数据类型的输出。</p>
<p><code>PrintStream</code>和<code>PrintWriter</code>的输出不会抛出异常。</p>
<p><code>PrintStream</code>和<code>PrintWriter</code>有自动flush功能。</p>
<p><code>PrintStream</code>打印的所有字符使用平台默认的字符编码转换为字节，在需要写入字符的情况下，应该使用<code>PrintWriter</code>类。</p>
<p><code>System.out</code>返回的是<code>PrintStream</code>的实例。</p>
<p>代码实例，输出ASCII字符：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PrintStreamTest</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span> </span>{<br>        PrintStream ps = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            FileOutputStream fos =<br>                <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"D:\\IO\\text.txt"</span>));<br>            <span class="hljs-comment">// 创建打印输出流,设置为自动刷新模式(写入换行符或字节 '\n' 时都会刷新输出缓冲区)</span><br>            ps = <span class="hljs-keyword">new</span> PrintStream(fos, <span class="hljs-keyword">true</span>);<br>            <span class="hljs-keyword">if</span> (ps != <span class="hljs-keyword">null</span>) {<span class="hljs-comment">// 把标准输出流(控制台输出)改成文件</span><br>                System.setOut(ps);<br>            }<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">255</span>; i++) { <span class="hljs-comment">// 输出ASCII字符</span><br>                System.out.print((<span class="hljs-keyword">char</span>) i);<br>                <span class="hljs-comment">// 每50个数据一行</span><br>                <span class="hljs-keyword">if</span> (i % <span class="hljs-number">50</span> == <span class="hljs-number">0</span>)  System.out.println();<br>            }<br>        }<br>        <span class="hljs-keyword">catch</span> (FileNotFoundException e) {e.printStackTrace();} <br>        <span class="hljs-keyword">finally</span> {<span class="hljs-keyword">if</span> (ps != <span class="hljs-keyword">null</span>) {ps.close();}}<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="八、数据流"><a href="#八、数据流" class="headerlink" title="八、数据流"></a>八、数据流</h1><p>数据流用于方便地操作Java语言的基本数据类型和String类型。</p>
<p>数据流有两个类：</p>
<ul>
<li><code>DataInputStream</code>：套接在InputStream子类的流上。其包含的方法如下<ul>
<li><code>boolean readBoolean()</code></li>
<li><code>char readChar()</code></li>
<li><code>double readDouble()</code></li>
<li><code>long readLong()</code></li>
<li><code>String readUTF()</code></li>
<li><code>byte readByte()</code></li>
<li><code>float readFloat()</code></li>
<li><code>short readShort()</code></li>
<li><code>int readInt()</code></li>
<li><code>void readFully(byte[] b)</code></li>
</ul>
</li>
<li><code>DataOutputStream</code>：套接在OutputStream子类的流上。其中的方法与DataInputStream中一致，只需要将read改为write即可。</li>
</ul>
<p>应用实例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OtherStreamTest</span> </span>{<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    将内存中的字符串、基本数据类型的变量写出到文件中</span><br><span class="hljs-comment">    这里处理异常应该使用try-catch-finally.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        <span class="hljs-comment">//1.</span><br>        DataOutputStream dos = <br>            <span class="hljs-keyword">new</span> DataOutputStream(<span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">"data.txt"</span>));<br>        <span class="hljs-comment">//2.</span><br>        dos.writeUTF(<span class="hljs-string">"数据结构"</span>);<br>        dos.flush(); <span class="hljs-comment">//刷新操作，将内存中的数据写入文件，每次写完都要刷新</span><br>        dos.writeInt(<span class="hljs-number">23</span>);<br>        dos.flush();<br>        dos.writeBoolean(<span class="hljs-keyword">true</span>);<br>        dos.flush();<br>        <span class="hljs-comment">//3.</span><br>        dos.close();<br><br>    }<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    将文件中存储的基本数据类型变量和字符串读取到内存中，保存在变量中。</span><br><span class="hljs-comment">    注意点：读取不同类型的数据的顺序要与当初写入文件时，保存的数据的顺序一致！</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        <span class="hljs-comment">//1.</span><br>        DataInputStream dis = <br>            <span class="hljs-keyword">new</span> DataInputStream(<span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"data.txt"</span>));<br>        <span class="hljs-comment">//2.</span><br>        String name = dis.readUTF();<br>        <span class="hljs-keyword">int</span> age = dis.readInt();<br>        <span class="hljs-keyword">boolean</span> isMale = dis.readBoolean();<br>        System.out.println(<span class="hljs-string">"name = "</span> + name);<br>        System.out.println(<span class="hljs-string">"age = "</span> + age);<br>        System.out.println(<span class="hljs-string">"isMale = "</span> + isMale);<br>        <span class="hljs-comment">//3.</span><br>        dis.close();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="九、对象流"><a href="#九、对象流" class="headerlink" title="九、对象流"></a>九、对象流</h1><h2 id="1、对象流概述"><a href="#1、对象流概述" class="headerlink" title="1、对象流概述"></a>1、对象流概述</h2><p>对象流<code>ObjectInputStream</code>和<code>ObjectOutputStream</code>，用于存储和读取基本类型数据或对象的处理流。可以把Java中的对象写入到数据中（序列化），或者把对象从数据源中还原回来（反序列化）。</p>
<ul>
<li><strong>序列化</strong>：用<code>ObjectOutputStream</code>类保存基本数据类型或对象的机制。</li>
<li><strong>反序列化</strong>：用<code>ObjectInputStream</code>类读取基本数据类型或对象的机制。</li>
</ul>
<h2 id="2、序列化和反序列化"><a href="#2、序列化和反序列化" class="headerlink" title="2、序列化和反序列化"></a>2、序列化和反序列化</h2><p><strong>transient关键字</strong></p>
<p>transient意为短暂的、临时的。用transient关键字修饰的变量无法被序列化。</p>
<p>同样，用static关键字修饰的变量也无法被序列化。</p>
<p><strong>对象序列化机制</strong></p>
<p>对象序列化机制允许把内存中的Java对象转换成平台无关的二进制流，从而允许把这种二进制流持久地保存在磁盘上，或通过网络将这种二进制流传输到另一个网络节点。当其它程序获取了这种二进制流，就可以恢复成原来的Java对象。</p>
<p><strong>序列化</strong>就是将内存中的java对象保存到磁盘中或通过网络传输出去。而<strong>反序列化</strong>就是将磁盘中的对象还原成内存中的一个java对象。</p>
<p>序列化的好处在于<strong>可将任何实现了Serializable接口的对象转化为字节数据，使其在保存和传输时可被还原</strong>。</p>
<p>序列化是RMI（Remote Method Invoke–远程方法调用）过程的参数和返回值都必须实现的机制，RMI是JavaEE的基础，因此序列化机制是JavaEE平台的基础。</p>
<p>如果需要让某个对象支持序列化机制，则必须让<strong>对象所属的类及其属性</strong>是可序列化的，为了让某个类是可序列化的，该类必须实现如下两个接口之一。否则，会抛出<code>NotSerializableException</code>异常</p>
<ul>
<li>Serializable</li>
<li>Externalizable</li>
</ul>
<blockquote>
<p>实现Serializable接口的类，都有一个表示序列化版本标识符的静态变量：</p>
<p><code>private static final long serialVersionUID</code></p>
<p>其用来表明类的不同版本之间的兼容性。目的是以序列化对象进行版本控制，有关各版本反序列化时是否兼容。</p>
<p>如果实现类没有显式定义此变量，它的值是Java运行时环境根据类的内部细节自动生成的。若类的实例变量做了修改，<code>serialVersionUID</code>可能发生变化，导致无法反序列化。建议显式声明此常量。</p>
<p>反序列化时，JVM会把传来的字节流的<code>serialVersionUID</code>与本地相应实体类的<code>serialVersionUID</code>进行比较，如果相同就认为是一致的，可以进行反序列化，否则会出现异常<code>InvalidCastException</code></p>
</blockquote>
<h2 id="3、使用对象流序列化对象"><a href="#3、使用对象流序列化对象" class="headerlink" title="3、使用对象流序列化对象"></a>3、使用对象流序列化对象</h2><p>序列化步骤：</p>
<ul>
<li>创建<code>ObjectOutputStream</code>对象，记为oos</li>
<li>调用oos的<code>writeObject(对象)</code>方法，输出可序列化对象</li>
<li>每写出一次，就需要<code>flush</code>一次。</li>
</ul>
<p>反序列化步骤：</p>
<ul>
<li>创建<code>ObjectInputStream</code>对象，记为ois</li>
<li>调用ois的<code>readObject()</code>方法，读取流中的对象</li>
</ul>
<blockquote>
<p>可序列化的类中的属性，如果是引用类型，其必须也是可序列化的。String类型是可序列化的。</p>
</blockquote>
<p>实现代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//序列化，将对象变为二进制流</span><br>ObjectOutputStream oos = <span class="hljs-keyword">new</span> ObjectOutputStream(<br>    <span class="hljs-keyword">new</span> FileOutputStream(<span class="hljs-string">"data.txt"</span>));<br>Personp = newPerson(<span class="hljs-string">"韩梅梅"</span>, <span class="hljs-number">18</span>, <span class="hljs-string">"中华大街"</span>, newPet());<br>oos.writeObject(p);<br>oos.flush();<br>oos.close();<br><br><span class="hljs-comment">//反序列化，将磁盘中数据读出并还原为对象</span><br>ObjectInputStream ois = <span class="hljs-keyword">new</span> ObjectInputStream(<br>    <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"data.txt"</span>));<br>Personp1 = (Person)ois.readObject();<br>System.out.println(p1.toString());<br>ois.close();                                                              <br></code></pre></td></tr></tbody></table></figure>
<p><strong>关于java.io.Serializable接口的理解</strong></p>
<ul>
<li><code>Serializable</code>接口是空方法接口，这样的接口称为标志接口。实现了Serializable接口的对象，可将它们转换成一系列字节，并可在以后完全恢复回原来的样子。<strong>这一过程亦可通过网络进行。这意味着序列化机制能自动补偿操作系统间的差异</strong>。换句话说，可以先在Windows机器上创建一个对象，对其序列化，然后通过网络发给一台Unix机器，然后在那里准确无误地重新“装配”。不必关心数据在不同机器上如何表示，也不必关心字节的顺序或者其他任何细节。</li>
<li>由于大部分作为参数的类如<code>String</code>、<code>Integer</code>等都实现了<code>java.io.Serializable</code>的接口，也可以利用多态的性质，作为参数使接口更灵活。</li>
</ul>
<h1 id="十、随机存取文件流"><a href="#十、随机存取文件流" class="headerlink" title="十、随机存取文件流"></a>十、随机存取文件流</h1><p><code>RandomAccessFile</code>实现了<code>DataInput</code>和<code>DataOutput</code>这两个接口，意味着这个类既可以读也可以写。</p>
<p><code>RandomAccessFile</code>包含一个记录指针，用来标识当前读写所处的位置，也就是说，类支持“随机访问”的方式，可以从文件的任意地方读、写文件。这个指针可以自由移动：</p>
<ul>
<li><code>long getFilePointer()</code>：获取文件记录指针的当前位置</li>
<li><code>void seek(long pos)</code>：将文件记录指针定位到pos位置</li>
</ul>
<p><code>RandomAccessFile</code>的构造器：</p>
<ul>
<li><code>public RandomAccessFile(File file,String mode)</code>：mode参数用于指定访问模式</li>
<li><code>public RandomAccessFile(String name, String mode)</code></li>
</ul>
<p>mode有四种值：</p>
<ul>
<li><code>r</code>：以只读方式打开。如果文件不存在，则报异常。</li>
<li><code>rw</code>：以读写方式打开，可读可写。如果文件不存在，会自动创建文件。</li>
<li><code>rwd</code>：可读可写，并且同步文件内容的更新</li>
<li><code>rws</code>：可读可写，同步文件内容和元数据的更新</li>
</ul>
<p><code>RandomAccessFile</code>对象写数据，是以对目标文件覆盖的形式写入，默认指针从头开始，将内容逐个覆盖。可以通过指针实现文件内容插入的操作。</p>
<p>实现内容插入效果：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RandomAccessFileTest</span> </span>{<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    使用RandomAccessFile实现数据的插入效果,从第3个位置插入数据</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        RandomAccessFile raf1 = <span class="hljs-keyword">new</span> RandomAccessFile(<span class="hljs-string">"hello.txt"</span>,<span class="hljs-string">"rw"</span>);<br>        raf1.seek(<span class="hljs-number">3</span>);<span class="hljs-comment">//将指针调到角标为3的位置</span><br>        <span class="hljs-comment">//保存指针3后面的所有数据到StringBuilder中</span><br>        <span class="hljs-comment">//也可以将StringBuilder替换为ByteArrayOutputStream</span><br>        StringBuilder builder = <span class="hljs-keyword">new</span> StringBuilder(<br>            (<span class="hljs-keyword">int</span>) <span class="hljs-keyword">new</span> File(<span class="hljs-string">"hello.txt"</span>).length());<br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">20</span>];<br>        <span class="hljs-keyword">int</span> len;<br>        <span class="hljs-keyword">while</span>((len = raf1.read(buffer)) != -<span class="hljs-number">1</span>){<br>            builder.append(<span class="hljs-keyword">new</span> String(buffer,<span class="hljs-number">0</span>,len)) ;<br>        }<br>        <span class="hljs-comment">//调回指针，写入“xyz”</span><br>        raf1.seek(<span class="hljs-number">3</span>);<br>        raf1.write(<span class="hljs-string">"xyz"</span>.getBytes());<br>        <span class="hljs-comment">//将StringBuilder中的数据写入到文件中</span><br>        raf1.write(builder.toString().getBytes());<br>        raf1.close();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="十一、NIO-2中Path-Paths-Files类的使用"><a href="#十一、NIO-2中Path-Paths-Files类的使用" class="headerlink" title="十一、NIO.2中Path/Paths/Files类的使用"></a>十一、NIO.2中Path/Paths/Files类的使用</h1><p>JDK1.4版本提出NIO（New IO，Non-Blocking IO），以更高效的方式进行文件的读写操作。</p>
<p>JDK1.7对NIO进行了扩展，称之为NIO.2。早期的File类功能有限，大部分方法出错时仅返回失败，不会提供异常信息。NIO.2引入了Path接口，并提供了Files、Paths工具类，都声明在<code>java.nio.file</code>包下。</p>
<p>Path接口可以看成File类的升级版本，表示一个文件或目录，文件或目录可以不存在。</p>
<p>使用Path接口创建对象：<code>Path path = Paths.get("hello.txt");</code></p>
<p>Paths工具类，提供静态的get()方法用来获取Path对象：</p>
<ul>
<li><code>static Pathget(String first, String … more)</code>：用于将多个字符串串连成路径</li>
<li><code>static Path get(URI uri)</code>：返回指定uri对应的Path路径</li>
</ul>
<p><strong>Path接口常用方法</strong></p>
<ul>
<li><code>String toString()</code>：返回调用Path对象的字符串表示形式</li>
<li><code>boolean startsWith(String path)</code>:判断是否以path路径开始</li>
<li><code>boolean endsWith(String path)</code>:判断是否以path路径结束</li>
<li><code>boolean isAbsolute()</code>:判断是否是绝对路径</li>
<li><code>Path getParent()</code>：返回Path对象包含整个路径，不包含Path对象指定的文件路径</li>
<li><code>Path getRoot()</code>：返回调用Path对象的根路径</li>
<li><code>Path getFileName()</code>:返回与调用Path对象关联的文件名</li>
<li><code>int getNameCount()</code> :返回Path根目录后面元素的数量</li>
<li><code>Path getName(int idx)</code>:返回指定索引位置idx的路径名称</li>
<li><code>Path toAbsolutePath()</code>:作为绝对路径返回调用Path对象</li>
<li><code>Path resolve(Path p)</code>:合并两个路径，返回合并后的路径对应的Path对象</li>
<li><code>File toFile()</code>:将Path转化为File类的对象</li>
</ul>
<p><strong>Files工具类常用方法</strong></p>
<ul>
<li><code>Path copy(Path src, Path dest, CopyOption … how)</code>:文件的复制</li>
<li><code>Path createDirectory(Path path, FileAttribute&lt;?&gt; … attr)</code> :创建一个目录</li>
<li><code>Path createFile(Path path, FileAttribute&lt;?&gt; … arr)</code>:创建一个文件</li>
<li><code>void delete(Path path)</code> :删除一个文件/目录，如果不存在，执行报错</li>
<li><code>void deleteIfExists(Path path)</code>: Path对应的文件/目录如果存在，执行删除</li>
<li><code>Path move(Path src, Path dest, CopyOption…how)</code>:将src移动到dest位置</li>
<li><code>long size(Path path)</code> :返回path指定文件的大小</li>
</ul>
<p>用于判断：</p>
<ul>
<li><code>boolean exists(Path path, LinkOption … opts)</code> :判断文件是否存在</li>
<li><code>boolean isDirectory(Path path, LinkOption … opts)</code>:判断是否是目录</li>
<li><code>boolean isRegularFile(Path path, LinkOption … opts)</code> :判断是否是文件</li>
<li><code>boolean isHidden(Path path)</code>:判断是否是隐藏文件</li>
<li><code>boolean isReadable(Path path)</code>:判断文件是否可读</li>
<li><code>boolean isWritable(Path path)</code> :判断文件是否可写</li>
<li><code>boolean notExists(Path path, LinkOption … opts)</code>:判断文件是否不存在</li>
</ul>
<p>用于操作内容：</p>
<ul>
<li><code>SeekableByteChannel newByteChannel(Path path, OpenOption…how)</code>:获取与指定文件的连接，how指定打开方式。</li>
<li><code>DirectoryStream&lt;Path&gt;  newDirectoryStream(Path path)</code> :打开path指定的目录</li>
<li><code>InputStream newInputStream(Path path, OpenOption…how)</code>:获取InputStream对象</li>
<li><code>OutputStream newOutputStream(Path path, OpenOption…how)</code>:获取OutputStream对象</li>
</ul>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>JDBC与Druid数据库连接池</title>
    <url>/2021/04/30/jdbc-datasource/</url>
    <content><![CDATA[<h1 id="一、传统数据库连接"><a href="#一、传统数据库连接" class="headerlink" title="一、传统数据库连接"></a>一、传统数据库连接</h1><h2 id="1、JDBC简介"><a href="#1、JDBC简介" class="headerlink" title="1、JDBC简介"></a>1、JDBC简介</h2><p><strong>JDBC</strong>(Java Database Connectivity)是<strong>独立于特定数据库管理系统、通用的SQL数据库存取和操作的公共接口</strong>（一组API），定义了用来访问数据库的标准Java类库（<strong>java.sql,javax.sql</strong>），使用这些类库可以以一种<strong>标准</strong>的方法、方便地访问数据库资源。</p>
<p>开发人员只需要<strong>面向JDBC的接口编程</strong>即可，不同数据库厂商各自需要实现JDBC接口，即为不同的数据库驱动。</p>
<p>使用JDBC连接并操作数据库的步骤：</p>
<ul>
<li>导入<code>java.sql</code>和所使用的数据库的驱动，即<code>.jar</code>包</li>
<li>加载并注册驱动程序</li>
<li>创建<code>Connection</code>对象，建立连接</li>
<li>创建<code>Statement</code>或<code>PreparedStatement</code>对象</li>
<li>执行SQL语句，实现CRUD操作，如果是查询操作，会返回结果集<code>ResultSet</code>并需要处理。</li>
<li>关闭<code>Statement</code>/<code>PreparedStatement</code>对象和<code>Connection</code>连接，如果有<code>ResultSet</code>，也需要关闭。</li>
</ul>
<h2 id="2、数据库连接"><a href="#2、数据库连接" class="headerlink" title="2、数据库连接"></a>2、数据库连接</h2><p><code>java.sql.Driver</code>接口是所有JDBC驱动程序需要实现的接口，数据库厂商需要实现此接口。程序中使用驱动程序管理器类(<code>java.sql.DriverManager</code>)调用这些<code>Driver</code>实现（即注册驱动）。</p>
<p>创建连接的步骤：</p>
<ul>
<li><p><strong>加载并读取配置相关信息</strong>，如数据库用户名，密码，驱动的类名，驱动URL</p>
</li>
<li><p><strong>加载驱动</strong>，即实例化Driver，一般不主动实例化，而是使用反射的方式，根据加载的JDBC驱动的类名，加载驱动。如<code>Class.forName(“com.mysql.jdbc.Driver”);</code></p>
</li>
<li><p><strong>注册驱动</strong>:</p>
<ul>
<li><p>方式一，使用<code>DriverManager.registerDriver(com.mysql.jdbc.Driver)</code>注册驱动.</p>
</li>
<li><p>方式二，通常不手动注册，因为 <code>Driver</code>接口的驱动程序类<strong>都</strong>包含了静态代码块，在这个静态代码块中，会调用 <code>DriverManager.registerDriver()</code>方法来注册自身的一个实例。比如MySQL的<code>Driver</code>实现类的源码如下</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> {<br>    <span class="hljs-keyword">try</span> {<br>        java.sql.DriverManager.registerDriver(<span class="hljs-keyword">new</span> Driver());<br>    } <span class="hljs-keyword">catch</span> (SQLException E) {<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">"Can't register driver!"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><strong>获取连接</strong>。调用<code>DriverManager</code> 类的静态 <code>getConnection()</code> 方法建立到数据库的连接。</li>
</ul>
<blockquote>
<p>url用于标识一个被注册的驱动程序，驱动程序管理器通过这个 URL 选择正确的驱动程序，从而建立到数据库的连接。JDBC URL由三部分组成，即<code>jdbc:子协议:子名称</code>，子名称用于定位具体的数据库，包含主机名、端口号、数据库名。比如对于MySQL来说，其URL编写格式为：jdbc:mysql://[主机名称:mysql的服务端口号]/数据库名称[?参数=值&amp;参数=值]，例如test数据库，可以写为：<code>jdbc:mysql://localhost:3306/test?characterEncoding=utf-8</code>，如果有编码问题，可以设置连接时的参数。</p>
</blockquote>
<p>使用<code>DriverManager</code> 获取数据库连接举例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title">testConnection</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>    <span class="hljs-comment">//1.加载配置文件</span><br>    InputStream is = ConnectionTest.class.getClassLoader().<br>        getResourceAsStream(<span class="hljs-string">"jdbc.properties"</span>);<br>    roperties pros = <span class="hljs-keyword">new</span> Properties();<br>    pros.load(is);<br>    <br>    <span class="hljs-comment">//2.读取配置信息</span><br>    String user = pros.getProperty(<span class="hljs-string">"user"</span>);<br>    String password = pros.getProperty(<span class="hljs-string">"password"</span>);<br>    String url = pros.getProperty(<span class="hljs-string">"url"</span>);<br>    String driverClass = pros.getProperty(<span class="hljs-string">"driverClass"</span>);<br><br>    <span class="hljs-comment">//3.加载驱动(包含了实例化Driver和注册驱动两步)</span><br>    Class.forName(driverClass);<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    上述步骤通过反射获取Driver实现类的Class实例，目的是在此过程中调用</span><br><span class="hljs-comment">    对应实现类的静态代码块，代码块中实例化Driver，并注册了驱动</span><br><span class="hljs-comment">    */</span><br><br>    <span class="hljs-comment">//4.获取连接</span><br>    Connection conn = DriverManager.getConnection(url,user,password);<br>    System.out.println(conn);<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>jdbc.properties</code>配置文件需要在src目录下，内容如下：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">user</span>=<span class="hljs-string">root </span><br><span class="hljs-attr">password</span>=<span class="hljs-string">abc123</span><br><span class="hljs-attr">url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/test?characterEncoding=utf-8</span><br><span class="hljs-attr">driverClass</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里操作符两边不能用空格。</p>
<h1 id="二、使用PreparedStatement实现CRUD操作"><a href="#二、使用PreparedStatement实现CRUD操作" class="headerlink" title="二、使用PreparedStatement实现CRUD操作"></a>二、使用PreparedStatement实现CRUD操作</h1><p>在<code>java.sql</code> 包中有 3 个接口分别定义了对数据库的调用的不同方式：</p>
<ul>
<li><code>Statement</code>：用于执行静态 SQL 语句并返回它所生成结果的对象。 </li>
<li><code>PrepatedStatement</code>：SQL 语句被预编译并存储在此对象中，可以使用此对象多次高效地执行该语句。</li>
<li><code>CallableStatement</code>：用于执行 SQL 存储过程</li>
</ul>
<h2 id="1、PreparedStatement介绍"><a href="#1、PreparedStatement介绍" class="headerlink" title="1、PreparedStatement介绍"></a>1、PreparedStatement介绍</h2><ul>
<li><p>可以通过调用 Connection 对象的 <strong>preparedStatement(String sql)</strong> 方法获取 PreparedStatement 对象</p>
</li>
<li><p><strong>PreparedStatement 接口是 Statement 的子接口，它表示一条预编译过的 SQL 语句</strong></p>
</li>
<li><p>PreparedStatement 对象所代表的 SQL 语句中的参数用<code>?</code>来表示，调用 PreparedStatement 对象的 <code>setXxx()</code> 方法来设置这些参数，<code>setXxx()</code> 方法有两个参数，第一个参数是要设置的 SQL 语句中的参数的索引(从<code>1</code>开始)，第二个是设置的 SQL 语句中的参数的值。</p>
</li>
</ul>
<h2 id="2、PreparedStatement的使用"><a href="#2、PreparedStatement的使用" class="headerlink" title="2、PreparedStatement的使用"></a>2、PreparedStatement的使用</h2><p><strong>PreparedStatement 和 Statement对比</strong>：</p>
<ul>
<li>PreparedStatement是Statement的子类，二者都能实现对数据库的CRUD操作</li>
<li>Statement使用字符串拼接操作，繁琐。而使用PreparedStatement的代码可读性和可维护性强。</li>
<li><strong>PreparedStatement 对SQL语句预编译</strong>，能最大可能提高性能：<ul>
<li>DBServer会对<strong>预编译</strong>语句提供性能优化。因为<strong>预编译语句有可能被重复调用</strong>，所以语句在被DBServer的编译器编译后的执行代码被缓存下来，那么下次调用时只要是相同的预编译语句就不需要编译，只要将参数直接传入编译过的语句执行代码中就会得到执行。</li>
<li>statement语句中，即使是相同操作，但因为数据内容不一样导致整个语句本身不能匹配，没有缓存语句的意义。事实是没有数据库会对普通语句编译后的执行代码缓存。这样每执行一次都要对传入的语句编译一次，效率降低。</li>
</ul>
</li>
<li>Statement存在SQL注入问题，PreparedStatement 使用预编译和<code>?</code>占位符传值，可以防止此问题 。</li>
<li>此外，PreparedStatement还能够实现对<code>Blob</code>数据的操作，并且对于批量插入比较高效。</li>
</ul>
<p>举例1：使用PreparedStatement实现增、删、改操作</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">我们将上述提到的数据库连接操作，以及资源关闭操作，封装到JDBCUtils工具类中，</span><br><span class="hljs-comment">即以下的几个静态方法：</span><br><span class="hljs-comment">public static Connection getConnection()：返回一个Connection实例</span><br><span class="hljs-comment">public static void closeResource(Connection c,Statement ps)：关闭资源</span><br><span class="hljs-comment">public static void closeResource(Connection c,Statement ps,ResultSet rs)：关闭资源</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PreparedStatementTest</span></span>{<br>    <span class="hljs-comment">//适用于不同的表的增、删、改操作</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(String sql,Object ... args)</span></span>{<br>        Connection conn = <span class="hljs-keyword">null</span>;<br>        PreparedStatement ps = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">//1.获取数据库的连接</span><br>            conn = JDBCUtils.getConnection();<br>            <br>            <span class="hljs-comment">//2.获取PreparedStatement的实例 (或：预编译sql语句)</span><br>            ps = conn.prepareStatement(sql);<br>            <span class="hljs-comment">//3.填充占位符</span><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;i &lt; args.length;i++){<br>                ps.setObject(i + <span class="hljs-number">1</span>, args[i]);<br>            }<br>            <span class="hljs-comment">//4.执行sql语句</span><br>            ps.execute();<br>        } <span class="hljs-keyword">catch</span> (Exception e) {<br>            e.printStackTrace();<br>        }<span class="hljs-keyword">finally</span>{<br>            <span class="hljs-comment">//5.关闭资源</span><br>            JDBCUtils.closeResource(conn, ps);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>举例2：使用PreparedStatement实现查询操作：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">prepareStatementTest</span></span>{<br>    <span class="hljs-comment">// 通用的针对于不同表的查询:返回一个对象</span><br>    <span class="hljs-keyword">public</span> &lt;T&gt; <span class="hljs-function">T <span class="hljs-title">getInstance</span><span class="hljs-params">(Class&lt;T&gt; clazz, String sql, Object... args)</span> </span>{<br>        Connection conn = <span class="hljs-keyword">null</span>;<br>        PreparedStatement ps = <span class="hljs-keyword">null</span>;<br>        ResultSet rs = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">// 1.获取数据库连接</span><br>            conn = JDBCUtils.getConnection();<br>            <span class="hljs-comment">// 2.预编译sql语句，得到PreparedStatement对象</span><br>            ps = conn.prepareStatement(sql);<br>            <span class="hljs-comment">// 3.填充占位符</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {<br>                ps.setObject(i + <span class="hljs-number">1</span>, args[i]);<br>            }<br>            <span class="hljs-comment">// 4.执行executeQuery(),得到结果集：ResultSet</span><br>            rs = ps.executeQuery();<br>            <span class="hljs-comment">// 5.得到结果集的元数据：ResultSetMetaData</span><br>            ResultSetMetaData rsmd = rs.getMetaData();<br>            <span class="hljs-comment">// 6.1通过ResultSetMetaData得到columnCount,columnLabel；通过ResultSet得到列值</span><br>            <span class="hljs-keyword">int</span> columnCount = rsmd.getColumnCount();<br>            <span class="hljs-keyword">if</span> (rs.next()) {<br>                T t = clazz.newInstance();<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; columnCount; i++) {<span class="hljs-comment">// 遍历每一个列</span><br>                    <span class="hljs-comment">// 获取列值</span><br>                    Object columnVal = rs.getObject(i + <span class="hljs-number">1</span>);<br>                    <span class="hljs-comment">// 获取列的别名:列的别名必须和类的属性相同</span><br>                    String columnLabel = rsmd.getColumnLabel(i + <span class="hljs-number">1</span>);<br>                    <span class="hljs-comment">// 6.2使用反射，给对象的相应属性赋值</span><br>                    Field field = clazz.getDeclaredField(columnLabel);<br>                    field.setAccessible(<span class="hljs-keyword">true</span>);<br>                    field.set(t, columnVal);<br>                }<br>                <span class="hljs-keyword">return</span> t;<br>            }<br>        } <span class="hljs-keyword">catch</span> (Exception e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<span class="hljs-comment">// 7.关闭资源</span><br>            JDBCUtils.closeResource(conn, ps, rs);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>如果考虑事务操作，则不应该在方法中获取和关闭连接，需要在调用之前传入<code>Connection</code>对象，对于事务的操作可以简化为以下步骤：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testJDBCTransaction</span><span class="hljs-params">()</span> </span>{<br>    Connection conn = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 1.获取数据库连接</span><br>        conn = JDBCUtils.getConnection();<br>        <span class="hljs-comment">// 2.开启事务,关闭自动提交</span><br>        conn.setAutoCommit(<span class="hljs-keyword">false</span>);<br>        <span class="hljs-comment">// 3.进行数据库操作，这里的两个SQL操作组成一个事务</span><br>        String sql1 = <span class="hljs-string">"update user_table set balance = balance - 100 where user = ?"</span>;<br>        update(conn, sql1, <span class="hljs-string">"AA"</span>);  <span class="hljs-comment">//执行事务</span><br>        <span class="hljs-comment">// 模拟网络异常。如果有异常，事务会回滚</span><br>        <span class="hljs-comment">//System.out.println(10 / 0);</span><br><br>        String sql2 = <span class="hljs-string">"update user_table set balance = balance + 100 where user = ?"</span>;<br>        update(conn, sql2, <span class="hljs-string">"BB"</span>);<br>        <span class="hljs-comment">// 4.若没有异常，则提交事务</span><br>        conn.commit();<br>    } <span class="hljs-keyword">catch</span> (Exception e) {<br>        e.printStackTrace();<br>        <span class="hljs-comment">// 5.若有异常，则回滚事务</span><br>        <span class="hljs-keyword">try</span> {<br>            conn.rollback();<br>        } <span class="hljs-keyword">catch</span> (SQLException e1) {<br>            e1.printStackTrace();<br>        }<br>    } <span class="hljs-keyword">finally</span> {<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">//6.恢复自动提交</span><br>            conn.setAutoCommit(<span class="hljs-keyword">true</span>);<br>        } <span class="hljs-keyword">catch</span> (SQLException e) {<br>            e.printStackTrace();<br>        }<br>        <span class="hljs-comment">//7.关闭连接</span><br>        JDBCUtils.closeResource(conn, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>); <br>    }  <br>}<br><br><span class="hljs-comment">//使用事务以后的方法需要改写，将连接对象作为参数传入，其余内容不变</span><br><span class="hljs-comment">//对于查询操作的方法同样如此。</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Connection conn,String sql, Object... args)</span> </span>{<br>    PreparedStatement ps = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> {<br>        ps = conn.prepareStatement(sql);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {<br>            ps.setObject(i + <span class="hljs-number">1</span>, args[i]);<br>        }<br>        ps.execute();<br>    } <span class="hljs-keyword">catch</span> (Exception e) {<br>        e.printStackTrace();<br>    } <span class="hljs-keyword">finally</span> {<br>        JDBCUtils.closeResource(<span class="hljs-keyword">null</span>, ps);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>Connection</code>的对象也可以调用<code>setTransactionIsolation()</code>方法设置事务的隔离级别</p>
<h2 id="3、资源释放"><a href="#3、资源释放" class="headerlink" title="3、资源释放"></a>3、资源释放</h2><p>执行完操作后，必须要释放资源：</p>
<ul>
<li>释放<code>ResultSet</code>， <code>Statement</code>，<code>Connection</code>。</li>
<li>数据库连接（Connection）是非常稀有的资源，用完后必须马上释放，如果Connection不能及时正确的关闭将导致系统宕机。Connection的使用原则是<strong>尽量晚创建，早释放</strong>。</li>
<li>可以在finally中关闭，保证及时其他代码出现异常，资源也一定能被关闭。  </li>
</ul>
<h2 id="4、总结"><a href="#4、总结" class="headerlink" title="4、总结"></a>4、总结</h2><p>JDBC涉及到的两种思想和两种技术：</p>
<ul>
<li><p>两种思想</p>
<ul>
<li>面向接口编程的思想</li>
<li>ORM思想(object relational mapping)<ul>
<li>一个数据表对应一个java类</li>
<li>表中的一条记录对应java类的一个对象</li>
<li>表中的一个字段对应java类的一个属性</li>
</ul>
</li>
</ul>
<blockquote>
<p>SQL查询的结果集中列的别名，必须要和类的属性名相同。</p>
</blockquote>
</li>
<li><p>两种技术</p>
<ul>
<li>JDBC结果集的元数据：<code>ResultSetMetaData</code>，作用为<ul>
<li>获取结果集列数：<code>getColumnCount()</code></li>
<li>获取列的别名：<code>getColumnLabed()</code></li>
</ul>
</li>
<li>通过反射，创建指定类的对象，获取指定的属性并赋值。</li>
</ul>
</li>
</ul>
<h1 id="三、DAO的使用"><a href="#三、DAO的使用" class="headerlink" title="三、DAO的使用"></a>三、DAO的使用</h1><p><strong>DAO（Data Access Object）</strong>：访问数据信息的类和接口，只包括了对数据的CRUD（Create、Retrival、Update、Delete）操作，而不包含任何业务相关的信息。有时也称作：BaseDAO</p>
<p>作用：为了实现功能的模块化，更有利于代码的维护和升级。</p>
<p>使用DAO主要包括三部分：</p>
<ul>
<li>将DAO定义为一个抽象类，包含了CRUD基本操作，适用于所有表。</li>
<li>对每个表，定义一个接口，接口规范了当前表的不同功能。</li>
<li>每个表对应一个实现类，此类继承DAO抽象类，并实现了此表对应的接口。</li>
</ul>
<p>最后，我们只需要调用实现类的方法，满足不同的需求。</p>
<p>比如，对于<code>Customer</code>类，数据库中对应customers表，使用DAO及其相关实现类如下</p>
<p> <code>DAO.java</code>文件类，定义抽象类：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * DAO: data(base) access object</span><br><span class="hljs-comment"> * 封装了针对于数据表的通用的操作</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseDAO</span>&lt;<span class="hljs-title">T</span>&gt; </span>{<br>    <span class="hljs-keyword">private</span> Class&lt;T&gt; clazz = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-comment">//需要获取BaseDAO子类的带泛型父类的泛型，根据此泛型得知要操作的类。</span><br>    <span class="hljs-comment">//可以在代码块或者构造器中获取。</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">BaseDAO</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//带泛型的父类，即BaseDAO&lt;Customer&gt;</span><br>        Type genericSuperclass = <span class="hljs-keyword">this</span>.getClass().getGenericSuperclass();<br>        ParameterizedType paramType = (ParameterizedType) genericSuperclass;<br>        <span class="hljs-comment">//获取父类的泛型，即Customer</span><br>        Type[] actualTypeArguments = paramType.getActualTypeArguments();<br>        clazz = (Class&lt;T&gt;) actualTypeArguments[<span class="hljs-number">0</span>];<span class="hljs-comment">//数组的第一个值就是Customer</span><br>    }<br>    <br>    <span class="hljs-comment">// 通用的增删改操作</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">update</span><span class="hljs-params">(Connection conn, String sql, Object... args)</span> </span>{<br>        PreparedStatement ps = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">// 1.预编译sql语句，返回PreparedStatement的实例</span><br>            ps = conn.prepareStatement(sql);<br>            <span class="hljs-comment">// 2.填充占位符</span><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {<br>                ps.setObject(i + <span class="hljs-number">1</span>, args[i]);<span class="hljs-comment">// 小心参数声明错误！！</span><br>            }<br>            <span class="hljs-comment">// 3.执行</span><br>            <span class="hljs-keyword">return</span> ps.executeUpdate();<br>        } <span class="hljs-keyword">catch</span> (Exception e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<span class="hljs-comment">// 4.资源的关闭</span><br>            JDBCUtils.closeResource(<span class="hljs-keyword">null</span>, ps);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    }<br>    <br>    <span class="hljs-comment">// 通用的查询操作，用于返回数据表中的一条记录</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">getInstance</span><span class="hljs-params">(Connection conn, String sql, Object... args)</span> </span>{<br>        PreparedStatement ps = <span class="hljs-keyword">null</span>;<br>        ResultSet rs = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            ps = conn.prepareStatement(sql);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {<br>                ps.setObject(i + <span class="hljs-number">1</span>, args[i]);<br>            }<br>            rs = ps.executeQuery();<br>            <span class="hljs-comment">// 获取结果集的元数据 :ResultSetMetaData</span><br>            ResultSetMetaData rsmd = rs.getMetaData();<br>            <span class="hljs-comment">// 通过ResultSetMetaData获取结果集中的列数</span><br>            <span class="hljs-keyword">int</span> columnCount = rsmd.getColumnCount();<br>            <span class="hljs-keyword">if</span> (rs.next()) {<br>                T t = clazz.getConstructor().newInstance();<br>                <span class="hljs-comment">// 处理结果集一行数据中的每一个列</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; columnCount; i++) {<br>                    <span class="hljs-comment">// 获取列值</span><br>                    Object columValue = rs.getObject(i + <span class="hljs-number">1</span>);<br>                    <span class="hljs-comment">// 获取每个列的列名</span><br>                    String columnLabel = rsmd.getColumnLabel(i + <span class="hljs-number">1</span>);<br>                    <span class="hljs-comment">// 给t对象指定的columnName属性，赋值为columValue：通过反射</span><br>                    Field field = clazz.getDeclaredField(columnLabel);<br>                    field.setAccessible(<span class="hljs-keyword">true</span>);<br>                    field.set(t, columValue);<br>                }<br>                <span class="hljs-keyword">return</span> t;<br>            }<br>        } <span class="hljs-keyword">catch</span> (Exception e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            JDBCUtils.closeResource(<span class="hljs-keyword">null</span>, ps, rs);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    }<br>    <span class="hljs-comment">// 通用的查询操作，用于返回数据表中的多条记录构成的集合</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;T&gt; <span class="hljs-title">getForList</span><span class="hljs-params">(Connection conn, String sql, Object... args)</span> </span>{<br>        PreparedStatement ps = <span class="hljs-keyword">null</span>;<br>        ResultSet rs = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            ps = conn.prepareStatement(sql);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; args.length; i++) {<br>                ps.setObject(i + <span class="hljs-number">1</span>, args[i]);<br>            }<br>            rs = ps.executeQuery();<br>            <span class="hljs-comment">// 获取结果集的元数据 :ResultSetMetaData</span><br>            ResultSetMetaData rsmd = rs.getMetaData();<br>            <span class="hljs-comment">// 通过ResultSetMetaData获取结果集中的列数</span><br>            <span class="hljs-keyword">int</span> columnCount = rsmd.getColumnCount();<br>            <span class="hljs-comment">// 创建集合对象</span><br>            ArrayList&lt;T&gt; list = <span class="hljs-keyword">new</span> ArrayList&lt;T&gt;();<br>            <span class="hljs-keyword">while</span> (rs.next()) {<br>                T t = clazz.newInstance();<br>                <span class="hljs-comment">// 处理结果集一行数据中的每一个列:给t对象指定的属性赋值</span><br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; columnCount; i++) {<br>                    <span class="hljs-comment">// 获取列值</span><br>                    Object columValue = rs.getObject(i + <span class="hljs-number">1</span>);<br>                    <span class="hljs-comment">// 获取每个列的列名</span><br>                    String columnLabel = rsmd.getColumnLabel(i + <span class="hljs-number">1</span>);<br>                    <span class="hljs-comment">// 给t对象指定的columnName属性，赋值为columValue：通过反射</span><br>                    Field field = clazz.getDeclaredField(columnLabel);<br>                    field.setAccessible(<span class="hljs-keyword">true</span>);<br>                    field.set(t, columValue);<br>                }<br>                list.add(t);<br>            }<br>            <span class="hljs-keyword">return</span> list;<br>        }<br>        <span class="hljs-keyword">catch</span> (Exception e) {e.printStackTrace();}<br>        <span class="hljs-keyword">finally</span> {JDBCUtils.closeResource(<span class="hljs-keyword">null</span>, ps, rs);}<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    }<br>    <br>    <span class="hljs-comment">//用于查询特殊值的通用的方法</span><br>    <span class="hljs-comment">//由于不同列的类型不同，使用泛型方法</span><br>    <span class="hljs-keyword">public</span> &lt;E&gt; <span class="hljs-function">E <span class="hljs-title">getValue</span><span class="hljs-params">(Connection conn,String sql,Object...args)</span></span>{<br>        PreparedStatement ps = <span class="hljs-keyword">null</span>;<br>        ResultSet rs = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            ps = conn.prepareStatement(sql);<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>;i &lt; args.length;i++){<br>                ps.setObject(i + <span class="hljs-number">1</span>, args[i]);<br>            }<br>            rs = ps.executeQuery();<br>            <span class="hljs-keyword">if</span>(rs.next()){<br>                <span class="hljs-keyword">return</span> (E) rs.getObject(<span class="hljs-number">1</span>);<br>            }<br>        } <span class="hljs-keyword">catch</span> (SQLException e) {<br>            e.printStackTrace();<br>        }<span class="hljs-keyword">finally</span>{<br>            JDBCUtils.closeResource(<span class="hljs-keyword">null</span>, ps, rs);<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>CustomerDAO.java</code>文件，定义接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * 此接口用于规范针对于customers表的常用操作</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">CustomerDAO</span> </span>{<br>    <span class="hljs-comment">//将cust对象添加到数据库中</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(Connection conn,Customer cust)</span></span>;<br>    <br>    <span class="hljs-comment">//针对指定的id，删除表中的一条记录</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deleteById</span><span class="hljs-params">(Connection conn,<span class="hljs-keyword">int</span> id)</span></span>;<br>    <br>    <span class="hljs-comment">//去修改数据表中指定的记录</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Connection conn,Customer cust)</span></span>;<br>    <br>    <span class="hljs-comment">//针对指定的id查询得到对应的Customer对象</span><br>    <span class="hljs-function">Customer <span class="hljs-title">getCustomerById</span><span class="hljs-params">(Connection conn,<span class="hljs-keyword">int</span> id)</span></span>;<br>    <br>    <span class="hljs-comment">//查询表中的所有记录构成的集合</span><br>    <span class="hljs-function">List&lt;Customer&gt; <span class="hljs-title">getAll</span><span class="hljs-params">(Connection conn)</span></span>;<br>    <br>    <span class="hljs-comment">//返回数据表中的数据的条目数</span><br>    <span class="hljs-function">Long <span class="hljs-title">getCount</span><span class="hljs-params">(Connection conn)</span></span>;<br>    <br>    <span class="hljs-comment">//返回数据表中最大的生日</span><br>    <span class="hljs-function">Date <span class="hljs-title">getMaxBirth</span><span class="hljs-params">(Connection conn)</span></span>;<br>}<br><span class="hljs-comment">//可以根据需求，定义不同功能的方法</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>CustmoerDAOImpl.java</code>文件，实现接口，继承抽象类：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">对于customer表，定义一个实现类，实现接口中的所有方法。</span><br><span class="hljs-comment">实现接口方法时，调用的是DAO抽象类中的方法。</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerDAOImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BaseDAO</span>&lt;<span class="hljs-title">Customer</span>&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title">CustomerDAO</span></span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">insert</span><span class="hljs-params">(Connection conn, Customer cust)</span> </span>{<br>        String sql = <span class="hljs-string">"insert into customers(name,email,birth)values(?,?,?)"</span>;<br>        update(conn, sql,cust.getName(),cust.getEmail(),cust.getBirth());<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">deleteById</span><span class="hljs-params">(Connection conn, <span class="hljs-keyword">int</span> id)</span> </span>{<br>        String sql = <span class="hljs-string">"delete from customers where id = ?"</span>;<br>        update(conn, sql, id);<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">update</span><span class="hljs-params">(Connection conn, Customer cust)</span> </span>{<br>        String sql = <span class="hljs-string">"update customers set name=?,email=?,birth=? where id=?"</span>;<br>        update(conn,sql,cust.getName(),cust.getEmail(),cust.getBirth(),cust.getId());<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Customer <span class="hljs-title">getCustomerById</span><span class="hljs-params">(Connection conn, <span class="hljs-keyword">int</span> id)</span> </span>{<br>        String sql = <span class="hljs-string">"select id,name,email,birth from customers where id = ?"</span>;<br>        Customer customer = getInstance(conn,sql,id);<br>        <span class="hljs-keyword">return</span> customer;<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;Customer&gt; <span class="hljs-title">getAll</span><span class="hljs-params">(Connection conn)</span> </span>{<br>        String sql = <span class="hljs-string">"select id,name,email,birth from customers"</span>;<br>        List&lt;Customer&gt; list = getForList(conn,sql);<br>        <span class="hljs-keyword">return</span> list;<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Long <span class="hljs-title">getCount</span><span class="hljs-params">(Connection conn)</span> </span>{<br>        String sql = <span class="hljs-string">"select count(*) from customers"</span>;<br>        <span class="hljs-keyword">return</span> getValue(conn, sql);<br>    }<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Date <span class="hljs-title">getMaxBirth</span><span class="hljs-params">(Connection conn)</span> </span>{<br>        String sql = <span class="hljs-string">"select max(birth) from customers"</span>;<br>        <span class="hljs-keyword">return</span> getValue(conn, sql);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、数据库连接池"><a href="#四、数据库连接池" class="headerlink" title="四、数据库连接池"></a>四、数据库连接池</h1><h2 id="1、连接池简介"><a href="#1、连接池简介" class="headerlink" title="1、连接池简介"></a>1、连接池简介</h2><p>传统的数据库连接存在的问题：</p>
<ul>
<li>普通的JDBC数据库连接使用 DriverManager 来获取，每次向数据库建立连接的时候都要将 Connection 加载到内存中，再验证用户名和密码。需要数据库连接的时候，就向数据库要求一个，执行完成后再断开连接。这样的方式将会消耗大量的资源和时间。<strong>数据库的连接资源并没有得到很好的重复利用。</strong>若同时有几百人甚至几千人在线，频繁的进行数据库连接操作将占用很多的系统资源，严重的甚至会造成服务器的崩溃。</li>
<li><strong>对于每一次数据库连接，使用完后都得断开。</strong>否则，如果程序出现异常而未能关闭，将会导致数据库系统中的内存泄漏，最终将导致重启数据库。</li>
<li><strong>这种开发不能控制被创建的连接对象数</strong>，系统资源会被毫无顾及的分配出去，如连接过多，也可能导致内存泄漏，服务器崩溃。</li>
</ul>
<p>为了解决以上的问题，可以采用数据库连接池技术：</p>
<ul>
<li><p><strong>数据库连接池的基本思想</strong>：就是为数据库连接建立一个“缓冲池”。预先在缓冲池中放入一定数量的连接，当需要建立数据库连接时，只需从“缓冲池”中取出一个，使用完毕之后再放回去。</p>
</li>
<li><p><strong>数据库连接池</strong>负责分配、管理和释放数据库连接，它<strong>允许应用程序重复使用一个现有的数据库连接，而不是重新建立一个</strong>。</p>
</li>
<li>数据库连接池在<strong>初始化</strong>时将创建一定数量的数据库连接放到连接池中，这些数据库连接的数量是由<strong>最小数据库连接数来设定</strong>的。无论这些数据库连接是否被使用，连接池都将一直保证至少拥有这么多的连接数量。连接池的<strong>最大数据库连接数量</strong>限定了这个连接池能占有的最大连接数，当应用程序向连接池请求的连接数超过最大连接数量时，这些请求将被加入到等待队列中。</li>
</ul>
<p>数据库连接池的优点：</p>
<ul>
<li><strong>资源重用</strong>。由于数据库连接得以重用，避免了频繁创建和释放连接引起的大量性能开销。在减少系统消耗的基础上，另一方面也增加了系统运行环境的平稳性。</li>
<li><strong>更快的系统反应速度</strong>。数据库连接池在初始化过程中，往往已经创建了若干数据库连接置于连接池中备用。此时连接的初始化工作均已完成。对于业务请求处理而言，直接利用现有可用连接，避免了数据库连接初始化和释放过程的时间开销，从而减少了系统的响应时间</li>
<li><strong>新的资源分配手段，控制每个应用的最大连接数</strong>。对于多应用共享同一数据库的系统而言，可在应用层通过数据库连接池的配置，实现某一应用最大可用数据库连接数的限制，避免某一应用独占所有的数据库资源</li>
<li><strong>统一的连接管理，避免数据库连接泄漏</strong>。在较为完善的数据库连接池实现中，可根据预先的占用超时设定，强制回收被占用连接，从而避免了常规数据库连接操作中可能出现的资源泄露</li>
</ul>
<p>JDBC 的数据库连接池使用<code>javax.sql.DataSource</code> 来表示，<code>DataSource</code> 只是一个接口，该接口通常由服务器(Weblogic, WebSphere, Tomcat)提供实现，也有一些开源组织提供实现：</p>
<ul>
<li><strong>DBCP</strong> 是Apache提供的数据库连接池。tomcat 服务器自带dbcp数据库连接池。<strong>速度相对c3p0较快</strong>，但因自身存在BUG，Hibernate3已不再提供支持。</li>
<li><strong>C3P0</strong> 是一个开源组织提供的一个数据库连接池，<strong>速度相对较慢，稳定性还可以。</strong>hibernate官方推荐使用</li>
<li><strong>Proxool</strong> 是sourceforge下的一个开源项目数据库连接池，有监控连接池状态的功能，<strong>稳定性较c3p0差一点</strong></li>
<li><strong>BoneCP</strong> 是一个开源组织提供的数据库连接池，速度快</li>
<li><strong>Druid</strong> 是阿里提供的数据库连接池，据说是集DBCP 、C3P0 、Proxool 优点于一身的数据库连接池，但是速度不确定是否有BoneCP快</li>
</ul>
<p><code>DataSource</code> 通常被称为数据源，它包含<strong>连接池</strong>和<strong>连接池管理</strong>两个部分，习惯上也经常把<code>DataSource</code> 称为<strong>连接池</strong>。</p>
<ul>
<li><strong>DataSource用来取代DriverManager来获取Connection，获取速度快，同时可以大幅度提高数据库访问速度。</strong></li>
<li><strong>整个应用只需要创建一个数据源（连接池）即可。</strong></li>
<li>当数据库访问结束后，程序还是像以前一样关闭数据库连接：<code>conn.close();</code>但<code>conn.close()</code>操作并没有关闭数据库的物理连接，它仅仅把数据库连接释放，归还给了数据库连接池（由busy状态变为free状态）。</li>
</ul>
<h2 id="2、Druid数据库连接池"><a href="#2、Druid数据库连接池" class="headerlink" title="2、Druid数据库连接池"></a>2、Druid数据库连接池</h2><p>Druid是阿里巴巴开源平台上一个数据库连接池实现，它结合了C3P0、DBCP、Proxool等DB池的优点，同时加入了日志监控，可以很好的监控DB池连接和SQL的执行情况，可以说是针对监控而生的DB连接池，<strong>是目前最好的连接池之一。</strong></p>
<p>连接池的一些配置参数：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left"><strong>配置</strong></th>
<th><strong>缺省</strong></th>
<th style="text-align:left"><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">name</td>
<td></td>
<td style="text-align:left">如果存在多个数据源，监控的时候可以通过名字来区分开来。如果没有配置，将会生成一个名字，格式是：”DataSource-” + System.identityHashCode(this)</td>
</tr>
<tr>
<td style="text-align:left">url</td>
<td></td>
<td style="text-align:left">连接数据库的url，不同数据库不一样。例如：mysql : jdbc:mysql://10.20.153.104:3306/druid2</td>
</tr>
<tr>
<td style="text-align:left">username</td>
<td></td>
<td style="text-align:left">连接数据库的用户名</td>
</tr>
<tr>
<td style="text-align:left">password</td>
<td></td>
<td style="text-align:left">连接数据库的密码。</td>
</tr>
<tr>
<td style="text-align:left">driverClassName</td>
<td></td>
<td style="text-align:left">根据url自动识别   这一项可配可不配，如果不配置druid会根据url自动识别dbType，然后选择相应的driverClassName(建议配置)</td>
</tr>
<tr>
<td style="text-align:left">initialSize</td>
<td>0</td>
<td style="text-align:left">初始化时建立物理连接的个数。初始化发生在显示调用init方法，或者第一次getConnection时</td>
</tr>
<tr>
<td style="text-align:left">maxActive</td>
<td>8</td>
<td style="text-align:left">同时维持的最大连接数</td>
</tr>
<tr>
<td style="text-align:left">maxIdle</td>
<td>8</td>
<td style="text-align:left">最大的空闲连接数。已废弃。类似于JVM中的Xmx</td>
</tr>
<tr>
<td style="text-align:left">minIdle</td>
<td>0</td>
<td style="text-align:left">最小的空闲连接数。类似于JVM中的Xmn</td>
</tr>
<tr>
<td style="text-align:left">minEvictableIdleTimeMillis</td>
<td>1800000L</td>
<td style="text-align:left">池中的空闲连接在一段时间内一直空闲，被逐出连接池的时间</td>
</tr>
<tr>
<td style="text-align:left">maxWait</td>
<td>-1</td>
<td style="text-align:left">获取连接时最大等待时间，单位毫秒。-1表示无限等待。配置了maxWait之后，缺省启用公平锁，并发效率会有所下降，如果需要可以通过配置useUnfairLock属性为true使用非公平锁。</td>
</tr>
<tr>
<td style="text-align:left">poolPreparedStatements</td>
<td>false</td>
<td style="text-align:left">是否缓存preparedStatement，也就是PSCache。PSCache对支持游标的数据库性能提升巨大，比如说oracle。在mysql下建议关闭。</td>
</tr>
<tr>
<td style="text-align:left">maxOpenPreparedStatements</td>
<td>-1</td>
<td style="text-align:left">开启池的prepared后的同时最大连接数。要启用PSCache，必须配置大于0，当大于0时，poolPreparedStatements自动触发修改为true。在Druid中，不会存在Oracle下PSCache占用内存过多的问题，可以把这个数值配置大一些，比如说100</td>
</tr>
<tr>
<td style="text-align:left">testOnBorrow</td>
<td>true</td>
<td style="text-align:left">申请连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能。</td>
</tr>
<tr>
<td style="text-align:left">testOnReturn</td>
<td>false</td>
<td style="text-align:left">归还连接时执行validationQuery检测连接是否有效，做了这个配置会降低性能</td>
</tr>
<tr>
<td style="text-align:left">testWhileIdle</td>
<td>false</td>
<td style="text-align:left">建议配置为true，不影响性能，并且保证安全性。申请连接的时候检测，如果空闲时间大于timeBetweenEvictionRunsMillis，执行validationQuery检测连接是否有效。</td>
</tr>
<tr>
<td style="text-align:left">timeBetweenEvictionRunsMillis</td>
<td></td>
<td style="text-align:left">有两个含义： 1)Destroy线程会检测连接的间隔时间2)testWhileIdle的判断依据，详</td>
</tr>
<tr>
<td style="text-align:left">connectionInitSqls</td>
<td></td>
<td style="text-align:left">物理连接初始化的时候执行的sql</td>
</tr>
</tbody>
</table>
</div>
<p>Druid数据库连接池使用案例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//只需要创建一个连接池，因此写在静态代码块中</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> DataSource source;<br><span class="hljs-keyword">static</span>{<br>    <span class="hljs-keyword">try</span> {<br>        Properties pros = <span class="hljs-keyword">new</span> Properties();<br>        FileInputStream is = <span class="hljs-keyword">new</span> FileInputStream(<span class="hljs-string">"src/druid.properties"</span>);<br>        pros.load(is);<br>        <span class="hljs-comment">//创建一个druid连接池</span><br>        source = DruidDataSourceFactory.createDataSource(pros);<br>    } <span class="hljs-keyword">catch</span> (Exception e) {<br>        e.printStackTrace();<br>    }<br>}<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title">getConnection3</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> SQLException </span>{<br>    Connection conn = source.getConnection();<br>    <span class="hljs-keyword">return</span> conn;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>druid.properties</code>配置文件内容如下：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">url</span>=<span class="hljs-string">jdbc:mysql:///test?characterEncoding=utf8</span><br><span class="hljs-attr">username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">password</span>=<span class="hljs-string">abc123</span><br><span class="hljs-attr">driverClassName</span>=<span class="hljs-string">com.mysql.jdbc.Driver</span><br><span class="hljs-attr">initialSize</span>=<span class="hljs-string">10</span><br><span class="hljs-attr">maxActive</span>=<span class="hljs-string">10</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、Apache-DBUtils工具类"><a href="#五、Apache-DBUtils工具类" class="headerlink" title="五、Apache-DBUtils工具类"></a>五、Apache-DBUtils工具类</h1><p><code>commons-dbutils</code>是 Apache 组织提供的一个开源 JDBC工具类库，它是对JDBC的简单封装，学习成本极低，并且使用<code>dbutils</code>能极大简化jdbc编码的工作量，同时也不会影响程序的性能。</p>
<p>API介绍：</p>
<ul>
<li><code>org.apache.commons.dbutils.QueryRunner</code>该类简单化了SQL查询，与<code>ResultSetHandler</code>搭配使用，可以完成大部分数据库操作。<code>QueryRunner</code>的主要方法有：<ul>
<li>update：执行插入、更新、删除操作</li>
<li>insert：只支持insert语句</li>
<li>query：查询操作</li>
</ul>
</li>
<li><code>org.apache.commons.dbutils.ResultSetHandler</code>该接口用于处理<code>ResultSet</code>，将数据按要求转换为另一种形式。并且提供了一个单独的方法：<code>Object handle (java.sql.ResultSet.rs)</code>。该接口的主要实现类有：<ul>
<li>ArrayHandler：把结果集中的第一行数据转成对象数组。</li>
<li>ArrayListHandler：把结果集中的每一行数据都转成一个数组，再存放到List中。</li>
<li><strong>BeanHandler：</strong>将结果集中的第一行数据封装到一个对应的JavaBean实例中。</li>
<li><strong>BeanListHandler：</strong>将结果集中的每一行数据都封装到一个对应的JavaBean实例中，存放到List里。</li>
<li>ColumnListHandler：将结果集中某一列的数据存放到List中。</li>
<li>KeyedHandler(name)：将结果集中的每一行数据都封装到一个Map里，再把这些map再存到一个map里，其key为指定的key。</li>
<li><strong>MapHandler：</strong>将结果集中的第一行数据封装到一个Map里，key是列名，value就是对应的值。</li>
<li><strong>MapListHandler：</strong>将结果集中的每一行数据都封装到一个Map里，然后再存放到List</li>
<li><strong>ScalarHandler：</strong>查询单个值对象</li>
</ul>
</li>
<li>工具类<code>org.apache.commons.dbutils.DbUtils</code>用于关闭连接、装载JDBC驱动程序等操作。里面的所有方法都是静态的。比如以下方法：<ul>
<li><code>public static void close(xxx) throws java.sql.SQLException</code>，关闭指定的资源。</li>
<li><code>public static void closeQuietly(xxx)</code>: 这一类方法不仅能在Connection、Statement和ResultSet为NULL情况下避免关闭，还能隐藏一些在程序中抛出的SQLEeception。</li>
<li><code>public static void commitAndClose(Connection conn)throws SQLException</code>： 用来提交连接的事务，然后关闭连接</li>
<li><code>public static void commitAndCloseQuietly(Connection conn)</code>： 用来提交连接，然后关闭连接，并且在关闭连接时不抛出SQL异常。 </li>
<li><code>public static void rollback(Connection conn)throws SQLException</code>：允许conn为null，因为方法内部做了判断</li>
<li><code>public static void rollbackAndClose(Connection conn)throws SQLException</code></li>
<li><code>rollbackAndCloseQuietly(Connection)</code></li>
<li><code>public static boolean loadDriver(java.lang.String driverClassName</code>)：这一方装载并注册JDBC驱动程序，如果成功就返回true。使用该方法，不需要捕捉这个异常ClassNotFoundException</li>
</ul>
</li>
</ul>
<p><code>DBUtils</code>的使用案例</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">dbutilsTest</span></span>{<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    BeanHandler：是ResultSetHandler接口的实现类，用于封装表中的一条记录</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testQuery1</span><span class="hljs-params">()</span></span>{<br>        Connection conn = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>{<br>            conn = JDBCUtils.getConnection();<br>            QueryRunner runner = <span class="hljs-keyword">new</span> QueryRunner();<br>            String sql = <span class="hljs-string">"select id,name,email,birth from customers where id=?"</span>;<br>            BeanHandler&lt;Customer&gt; handler = <span class="hljs-keyword">new</span> BeanHandler&lt;&gt;(Customer.class);<br>            Customer query = runner.query(conn, sql, handler, <span class="hljs-number">22</span>);<br>            System.out.println(query);<br>        }<span class="hljs-keyword">catch</span> (SQLException e){<br>            e.printStackTrace();<br>        }<span class="hljs-keyword">finally</span> {<br>            JDBCUtils.closeResource(conn,<span class="hljs-keyword">null</span>);<br>        }<br>    }<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    MapHandler：是ResultSetHandler接口的实现类，对应表中的一条记录</span><br><span class="hljs-comment">    将字段及字段的值作为map中的key和value</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testQuery3</span><span class="hljs-params">()</span></span>{<br>        Connection conn = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>{<br>            conn = JDBCUtils.getConnection();<br>            QueryRunner runner = <span class="hljs-keyword">new</span> QueryRunner();<br>            String sql = <span class="hljs-string">"select id,name,email,birth from customers where id=?"</span>;<br>            MapHandler handler = <span class="hljs-keyword">new</span> MapHandler();<br>            Map&lt;String, Object&gt; query = runner.query(conn, sql, handler, <span class="hljs-number">22</span>);<br>            System.out.println(query);<br>        }<span class="hljs-keyword">catch</span> (SQLException e){<br>            e.printStackTrace();<br>        }<span class="hljs-keyword">finally</span> {<br>            JDBCUtils.closeResource(conn,<span class="hljs-keyword">null</span>);<br>        }<br>    }<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    ScalarHandler用于查询特殊值</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testQuery5</span><span class="hljs-params">()</span></span>{<br>        Connection conn = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>{<br>            conn = JDBCUtils.getConnection();<br>            QueryRunner runner = <span class="hljs-keyword">new</span> QueryRunner();<br>            String sql = <span class="hljs-string">"select Max(birth) from customers"</span>;<br>            ScalarHandler scalarHandler = <span class="hljs-keyword">new</span> ScalarHandler();<br>            <span class="hljs-comment">//返回sql.date类型，转为util.date型</span><br>            Date date = (Date)runner.query(conn, sql, scalarHandler); <br>            System.out.println(date);<br>        }<span class="hljs-keyword">catch</span> (SQLException e){<br>            e.printStackTrace();<br>        }<span class="hljs-keyword">finally</span> {<br>            JDBCUtils.closeResource(conn,<span class="hljs-keyword">null</span>);<br>        }<br>    }<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    自定义ResultSetHandler实现类</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testQuery7</span><span class="hljs-params">()</span></span>{<br>        Connection conn = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span>{<br>            conn = JDBCUtils.getConnection3();<br>            QueryRunner runner = <span class="hljs-keyword">new</span> QueryRunner();<br>            String sql = <span class="hljs-string">"select id,name,email,birth from customers where id=?"</span>;<br>            ResultSetHandler&lt;Customer&gt; handler = <span class="hljs-keyword">new</span> ResultSetHandler&lt;Customer&gt;() {<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">public</span> Customer <span class="hljs-title">handle</span><span class="hljs-params">(ResultSet rs)</span> <span class="hljs-keyword">throws</span> SQLException </span>{<br>                    <span class="hljs-keyword">return</span> <span class="hljs-string">"自定义结果"</span>;<br>                }<br>            };<br>            Customer query = runner.query(conn, sql, handler, <span class="hljs-number">23</span>);<span class="hljs-comment">//返回sql.date类型，转为util.date型</span><br>            System.out.println(query);<br>        }<span class="hljs-keyword">catch</span> (SQLException e){<br>            e.printStackTrace();<br>        }<span class="hljs-keyword">finally</span> {<br>            JDBCUtils.closeResource(conn,<span class="hljs-keyword">null</span>);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h1><h1 id="1、JDBC总结"><a href="#1、JDBC总结" class="headerlink" title="1、JDBC总结"></a>1、JDBC总结</h1><p>至此，回顾使用JDBC编程的几个主要步骤，主要总结为三步：创建连接、CRUD操作、关闭资源。</p>
<p>可以发现，我们使用数据库连接池代替了传统的连接方式，使用DBUtils工具类代替了手动创建Statement对象实现CRUD的操作，和关闭资源的操作。</p>
<p>JDBC的流程可以总结为下（考虑事务）：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testUpdateWithTx</span><span class="hljs-params">()</span> </span>{<br>    Connection conn = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">/*1.获取连接的操作</span><br><span class="hljs-comment">        方式一：手写的连接：JDBCUtils.getConnection();</span><br><span class="hljs-comment">        方式二：使用数据库连接池：C3P0;DBCP;Druid</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-comment">/*2.对数据表进行CRUD操作</span><br><span class="hljs-comment">        方式一：使用PreparedStatement对象</span><br><span class="hljs-comment">        public void update(Connection conn,String sql,Object ... args){}</span><br><span class="hljs-comment">        public T getInstance(Connection conn,String sql,Object ... args){}</span><br><span class="hljs-comment">        方式二：使用dbutils提供的jar包中提供的QueryRunner类</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-comment">//提交数据</span><br>        conn.commit();<br>    } <span class="hljs-keyword">catch</span> (Exception e) {<br>        e.printStackTrace();<br>        <span class="hljs-keyword">try</span> {<span class="hljs-comment">//回滚数据</span><br>            conn.rollback();<br>        } <span class="hljs-keyword">catch</span> (SQLException e1) {e1.printStackTrace();}<br>    }<span class="hljs-keyword">finally</span>{<br>        <span class="hljs-comment">/*3.关闭连接等操作</span><br><span class="hljs-comment">        方式一：JDBCUtils.closeResource();</span><br><span class="hljs-comment">        方式二：使用dbutils中的DbUtils工具类提供的关闭资源的方法</span><br><span class="hljs-comment">        */</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="2、常见问题总结"><a href="#2、常见问题总结" class="headerlink" title="2、常见问题总结"></a>2、常见问题总结</h1><p>问题1：<strong>数据库连接池工作原理和实现方案?</strong></p>
<ul>
<li>工作原理：JAVA EE服务器启动时会建立一定数量的池连接，并一直维持不少于此数目的池连接(minIdle)。客户端程序需要连接时，池驱动程序会返回一个未使用的池连接，并将其标记为busy状态。如果当前没有空闲连接，池驱动程序就新建一定数量的连接，新建连接的数量有配置参数决定。当使用的池连接调用完成后，池驱动程序将此连接标记为free，其他调用就可以使用这个连接。</li>
<li>实现方案：<strong>连接池使用集合来进行装载，返回的Connection是原始Connection的代理，代理Connection的close方法，当调用close方法时，不是真正关闭物理连接，而是把它代理的Connection对象放回到连接池中，等待下一次重复利用。</strong></li>
</ul>
<hr>
<p>问题2：<strong>JDBC是如何实现Java程序和JDBC驱动的松耦合的？</strong></p>
<p>通过制定接口，数据库厂商来实现。我们只要通过接口调用即可，<strong>所有的操作都是通过JDBC接口完成的</strong>，而驱动只有在通过Class.forName反射机制来加载的时候才会出现。——面向接口编程</p>
<hr>
<p>问题3：<strong>PreparedStatement有什么缺点，如何解决</strong></p>
<p>缺点：不能直接用它来执行in条件语句。</p>
<p>解决方案：</p>
<ul>
<li>分别进行单条查询——性能很差，不推荐。</li>
<li>使用存储过程——这取决于数据库的实现，不是所有数据库都支持。</li>
<li>动态生成PreparedStatement——不能享受PreparedStatement的缓存带来的好处。</li>
<li>在PreparedStatement查询中使用NULL值——如果知道输入变量的最大个数的话，这是个不错的办法，扩展一下还可以支持无限参数。</li>
</ul>
<hr>
<p>问题4：<strong>JDBC的ResultSet是什么 </strong></p>
<ul>
<li>在查询数据库后会返回一个ResultSet，它像是查询结果集的一张数据表。</li>
<li>ResultSet对象维护了一个游标，指向当前的数据行。开始的时候这个游标指向的是第一行。如果调用了ResultSet的next()方法游标会下移一行，如果没有更多的数据了，next()方法会返回false。可以在for循环中用它来遍历数据集。</li>
<li>默认的ResultSet是不能更新的，游标也只能往下移。也就是说只能从第一行到最后一行遍历一遍。不过也可以创建可以回滚或者可更新的ResultSet。</li>
<li>当生成ResultSet的Statement对象要关闭或者重新执行或是获取下一个ResultSet的时候，ResultSet对象也会自动关闭。</li>
<li>可以通过ResultSet的<code>get</code>方法，传入列名或者从1开始的序号来获取列数据。</li>
</ul>
<hr>
<p>问题5：<strong>JDBC的DataSource是什么，有什么好处</strong></p>
<p>DataSource即数据源，它是定义在<code>javax.sql</code>中的一个接口，跟DriverManager相比，它的功能要更强大。DataSource也被称为数据库连接池。除了提供连接外，它还能够管理连接对象，提供如下功能：</p>
<ul>
<li><strong>缓存PreparedStatement以便更快的执行</strong></li>
<li><strong>可以设置连接超时时间</strong></li>
<li><strong>提供日志记录的功能</strong></li>
<li><strong>ResultSet大小的最大阈值设置</strong></li>
<li><strong>通过JNDI的支持，可以为servlet容器提供连接池的功能</strong></li>
</ul>
<hr>
<p>问题6：<strong>JDBC中存在哪些不同类型的锁</strong></p>
<p>从广义上讲，有两种锁机制来防止多个用户同时操作引起的数据损坏。</p>
<ul>
<li><strong>乐观锁</strong>：只有当更新数据的时候才会锁定记录。</li>
<li><strong>悲观锁</strong>：从查询到更新和提交整个过程都会对数据记录进行加锁。</li>
</ul>
<p>更多问题总结参考：<a href="https://mp.weixin.qq.com/s?__biz=MzI4Njg5MDA5NA==&amp;mid=2247483745&amp;idx=1&amp;sn=c5e8d9ad63878aa5bc3dcdbb903d8899&amp;chksm=ebd74060dca0c976345e93c1304b1d1d609e804665a3c2c338cbaa6903eee01477ca47c9645b#rd">JDBC面试题都在这里</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>数据库</tag>
        <tag>MySQL</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Java并发编程-JUC基础</title>
    <url>/2021/07/25/juc-basis/</url>
    <content><![CDATA[<h1 id="一、JUC基础"><a href="#一、JUC基础" class="headerlink" title="一、JUC基础"></a>一、JUC基础</h1><h2 id="1-1-JUC简介"><a href="#1-1-JUC简介" class="headerlink" title="1.1 JUC简介"></a>1.1 JUC简介</h2><p><code>java.util.concurrent</code>简称JUC，是一个处理线程的工具包，JDK 1.5出现。</p>
<h2 id="1-2-进程与线程"><a href="#1-2-进程与线程" class="headerlink" title="1.2 进程与线程"></a>1.2 进程与线程</h2><p>参考<a href="https://kangshitao.github.io/2021/05/21/computer-os-review/#%E4%BA%8C%E3%80%81%E8%BF%9B%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B">进程与线程</a></p>
<p><code>Thread</code>类中定义的进程几种状态：</p>
<ul>
<li><code>NEW</code>：线程还未开始时的状态</li>
<li><code>RUNNABLE</code>：线程可运行的状态（就绪状态）</li>
<li><code>BLOCKED</code>：线程为了进入同步方法或同步代码块，而等待监视器锁(monitor lock)的状态。</li>
<li><code>WAITING</code>：由于调用<code>wait</code>`join<code>\</code>LockSupport.park`方法进入的等待状态，直到被唤醒为止。</li>
<li><code>TIMED_WAITING</code>：由于调用<code>wait</code>`join<code>\</code>LockSupport.parkNanos<code>\</code>LockSupport.Until`方法进入的超时等待状态，等待具体的时间后就会<strong>自动停止等待。</strong></li>
<li><code>TERMINATED</code>：终止状态，线程执行完成。</li>
</ul>
<h2 id="1-3-多线程锁"><a href="#1-3-多线程锁" class="headerlink" title="1.3 多线程锁"></a>1.3 多线程锁</h2><p><strong>1、平锁和非公平锁</strong></p>
<ul>
<li><p><strong>非公平锁</strong>：可能造成一个线程独占资源，其他线程被饿死的情况；但效率高</p>
</li>
<li><p><strong>公平锁</strong>：只有当前线程在等待队列的第一个位置时，才会执行；各个线程都能获取到锁；效率较低.</p>
</li>
</ul>
<p><strong>2、可重入锁</strong></p>
<p><strong>“可重入锁”</strong>（递归锁） 指的是自己可以再次获取自己的内部锁。进入最外层的锁，内层也可以直接获取当前的锁，不需要等外层释放锁。</p>
<p><code>synchronized</code>和<code>Lock</code>都是可重入锁.</p>
<p><code>synchronized</code>是隐式的；<code>Lock</code>是显式的。Lock的上锁和解锁必须成对出现，如果没有解锁，可能会影响别的线程。</p>
<p><strong>3、死锁</strong></p>
<p>两个或两个以上的进程在执行过程中，因为争夺资源而造成互相等待的现象；如果没有外力干涉，他们无法继续进行下去。</p>
<p>产生死锁的原因：系统资源不足；进程运行推进顺序不合适；资源分配不当。死锁的产生条件和解决方法：<a href="https://kangshitao.github.io/2021/05/21/computer-os-review/#2-7-%E6%AD%BB%E9%94%81">操作系统-死锁</a></p>
<p>验证是否是死锁：</p>
<ul>
<li>jps命令找到要验证的进程。</li>
<li>jstack对指定id的进行进行分析，这是jvm自带的堆栈跟踪工具。</li>
</ul>
<h2 id="1-4-wait-sleep"><a href="#1-4-wait-sleep" class="headerlink" title="1.4 wait/sleep"></a>1.4 wait/sleep</h2><p><code>wait</code>和<code>sleep</code>的区别：</p>
<ul>
<li><code>sleep</code>是Thread类的静态方法，而<code>wait</code>是Object类的方法，任何对象实例都能调用。</li>
<li><code>sleep</code>不会释放锁，调用它不要求必须占用锁，因此可以在任何地方使用。<code>wait</code>会释放锁，但调用它的前提是当前线程已经占有锁(即代码要在<code>synchronized</code>中，<code>Lock</code>锁需要使用<code>Condition</code>的<code>await</code>方法)。</li>
<li>他们都可以被<code>interrupted</code>方法中断。</li>
<li>他们都是在哪里执行，就在哪里醒来。即原地唤醒。</li>
</ul>
<blockquote>
<p>为什么sleep方法定义在Thread类中，而wait方法定义在Object类中？</p>
<p>调用对象的wait方法，会导致<strong>当前线程</strong>进入等待状态，并且释放这个锁，前提是要求当前线程必须持有这个对象锁。二者的施加者是不同的；二者本质区别是一个是线程的运行状态控制，一个是线程之间的通讯问题。</p>
</blockquote>
<h2 id="1-5-并发和并行"><a href="#1-5-并发和并行" class="headerlink" title="1.5 并发和并行"></a>1.5 并发和并行</h2><p><strong>并发（concurrent）</strong>指的是多个程序或进程同时运行，对于单核心CPU来说，同一时刻只能允许一个线程，其并发就表示多个线程采用时间片方式执行多个线程。<strong>同一时刻多个线程访问同一个资源，多个线程对一个点</strong>，比如抢票、电商秒杀。</p>
<p><strong>并行</strong>是指多项工作一起执行，之后再汇总。</p>
<h2 id="1-6-多线程编程"><a href="#1-6-多线程编程" class="headerlink" title="1.6 多线程编程"></a>1.6 多线程编程</h2><p>Java创建线程的几种方式：<a href="https://kangshitao.github.io/2021/04/03/java-note-0801/#%E4%BA%8C%E3%80%81%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%88%9B%E5%BB%BA%E5%92%8C%E4%BD%BF%E7%94%A8">线程的创建和使用</a>，主要有以下四种：</p>
<ul>
<li>继承Thread类</li>
<li>实现Runnable接口</li>
<li>实现Callable接口</li>
<li>使用线程池</li>
</ul>
<p>Java多线程编程的一般步骤：</p>
<p>1、创建资源类，定义属性和操作方法</p>
<p>2、在资源类中操作方法：判断、操作、通知</p>
<p>3、创建多个线程，调用资源类的操作方法</p>
<p>4、防止虚假唤醒问题，将<code>wait</code>使用在<code>while</code>中，这样每次唤醒后都做判断。</p>
<blockquote>
<p>如果在if中使用wait，这样只会判断一次，之后唤醒就不会再判断了</p>
</blockquote>
<h1 id="二、synchronized与Lock接口"><a href="#二、synchronized与Lock接口" class="headerlink" title="二、synchronized与Lock接口"></a>二、synchronized与Lock接口</h1><h2 id="2-1-synchronized"><a href="#2-1-synchronized" class="headerlink" title="2.1 synchronized"></a>2.1 synchronized</h2><p>synchronized是Java中的关键字，是一种同步锁。使用方法参考：<a href="https://kangshitao.github.io/2021/04/03/java-note-0801/#%E5%9B%9B%E3%80%81%E7%BA%BF%E7%A8%8B%E7%9A%84%E5%90%8C%E6%AD%A5">线程的同步</a></p>
<p>补充：synchronized并不属于方法定义的一部分，因此synchronized关键字不能被继承。如果在父类中的某个方法使用了synchronized关键字，而在子类中覆盖了这个方法，在子类中的这个方法默认情况下并不是同步的，而必须显式地在子类的这个方法中加上synchronized关键字才可以。</p>
<p>当然，还可以在子类方法中调用父类中相应的方法，这样虽然子类中的方法不是同步的，但子类调用了父类的同步方法，因此，子类的方法也就相当于同步了。</p>
<p><strong>关于synchronized锁</strong></p>
<ul>
<li>如果一个类中有多个<code>synchronized</code>方法，对于类的对象，某一时刻内，只能有一个线程调用其中的一个同步方法，其他线程都必须等待。因为锁的是当前对象<code>this</code>，当前对象被锁定后，其他对象无法获取这个锁，也就无法使用其中的方法。</li>
<li>如果是一个类的两个不同的对象作为锁，则二者互不影响。<code>synchronized</code>实现同步的基础是<strong>每个对象都可以作为锁</strong>。</li>
<li>对于<strong>普通同步方法</strong>，锁的是当前实例对象。</li>
<li>对于<strong>静态同步方法</strong>，锁的是当前类的<code>Class</code>对象</li>
<li>对于<strong>同步方法块</strong>，锁的是括号内指定的对象。</li>
<li>对于<code>synchronized</code>的锁问题，需要判断其锁对象是否相同来分析，如果多个线程要用同一把锁，必然有竞态条件，如果用的不是同一把锁，则不会有关系。比如一个类的普通同步方法和一个静态同步方法，如果两个线程一个要访问普通同步方法，另一个线程访问静态同步方法，二者不会竞争，因为用的不是同一把锁。</li>
</ul>
<h2 id="2-2-Lock接口"><a href="#2-2-Lock接口" class="headerlink" title="2.2 Lock接口"></a>2.2 Lock接口</h2><h3 id="2-2-1-Lock"><a href="#2-2-1-Lock" class="headerlink" title="2.2.1 Lock"></a>2.2.1 Lock</h3><p>Lock接口是使用最多的方式，作用是用来<strong>手动获取和释放锁</strong>。</p>
<p>一般来说Lock的加锁语句放在try结构外面，这样如果加锁失败，就不会执行finally中的释放锁的操作。并且，需要在加锁和try之间不建议有别的操作，如果有异常会导致不能释放锁。参考<a href="https://blog.csdn.net/E_N_T_J/article/details/105943325">Lock.lock()为什么在try之前执行</a></p>
<p>释放锁语句放在finally里面，保证锁一定会被释放，防止死锁的发生。</p>
<h3 id="2-2-2-Condition"><a href="#2-2-2-Condition" class="headerlink" title="2.2.2 Condition"></a>2.2.2 Condition</h3><p>如果使用Lock锁，想要实现类似于notify方法的功能，就要使用Condition接口类对象。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();   <span class="hljs-comment">//创建Lock对象</span><br>Condition condition = lock.newCondition();  <span class="hljs-comment">//获取Condition对象</span><br></code></pre></td></tr></tbody></table></figure>
<p>Condition中的两个常用方法：</p>
<ul>
<li><p><code>await()</code>：相当于<code>wait()</code>，会使当前线程等待，同时会释放锁，其他线程调用当前Condition对象的<code>signal()</code>方法时才会继续执行。</p>
</li>
<li><p><code>signal()</code>相当于<code>notify()</code>。</p>
</li>
</ul>
<p>调用这两个方法前，需要线程持有相关的Lock锁，调用<code>await()</code>后，线程会释放这个锁，而调用某个Condition对象的<code>signal()</code>方法时，会从当前Condition对象的等待队列中，唤醒一个线程，当某个线程获取锁成功就会继续执行。</p>
<h2 id="2-3-ReentryantLock"><a href="#2-3-ReentryantLock" class="headerlink" title="2.3 ReentryantLock"></a>2.3 ReentryantLock</h2><p><code>ReentryantLock</code>表示可重入锁，是Lock的一个实现类，我们可以用它声明一个Lock对象。</p>
<p>使用<code>ReentryantLock</code>可以指定公平锁和非公平锁。</p>
<h2 id="2-4-synchronized和Lock的区别"><a href="#2-4-synchronized和Lock的区别" class="headerlink" title="2.4 synchronized和Lock的区别"></a>2.4 synchronized和Lock的区别</h2><ul>
<li><p>synchronized是Java语言的关键字，是Java语言内置的。而Lock是一个接口，通过这个类可以实现同步访问；</p>
</li>
<li><p><strong>synchronized不需要手动释放锁</strong>，同步方法或同步代码块执行完之后，系统会自动让线程释放对锁的占用；<strong>Lock必须手动释放锁</strong>，如果没有主动释放锁，就有可能导致出现死锁现象。</p>
</li>
<li>Lock可以让等待锁的线程响应中断，synchronized不能，会导致线程一直等待下去。</li>
<li>Lock可以知道有没有成功获取锁，synchronized不能。</li>
<li><p>竞争资源激烈时，Lock的性能优于synchronized</p>
</li>
<li><p>二者都是独占锁。</p>
</li>
</ul>
<h2 id="2-5-案例：多个售票员售票"><a href="#2-5-案例：多个售票员售票" class="headerlink" title="2.5 案例：多个售票员售票"></a>2.5 案例：多个售票员售票</h2><p>模拟3个售票员售30张票，售完为止：</p>
<p><code>synchronized</code>方式</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//创建资源类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Ticket</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">30</span>;<span class="hljs-comment">//定义属性：票数</span><br>    <span class="hljs-comment">//操作方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sale</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//判断：是否还有票</span><br>        <span class="hljs-keyword">if</span>(number&gt;<span class="hljs-number">0</span>){<br>            System.out.print(<span class="hljs-string">"当前"</span>+number+<span class="hljs-string">"张--"</span>);<br>            number--;<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">": 卖出1，剩余"</span>+number+<span class="hljs-string">"张"</span>);<br>        }<br>    }<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SaleTicket</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Ticket ticket = <span class="hljs-keyword">new</span> Ticket();<br>        <span class="hljs-comment">//创建资源类对象</span><br>        <span class="hljs-comment">//创建3个线程，代表3个售票员</span><br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">30</span>;i++){<br>                    ticket.sale();<br>                }<br>            }<br>        },<span class="hljs-string">"售票员A"</span>).start();<br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">30</span>;i++){<br>                    ticket.sale();<br>                }<br>            }<br>        },<span class="hljs-string">"售票员B"</span>).start();<br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">30</span>;i++){<br>                    ticket.sale();<br>                }<br>            }<br>        },<span class="hljs-string">"售票员C"</span>).start();<br>    }<br><br></code></pre></td></tr></tbody></table></figure>
<p><code>Lock</code>锁的方式：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LTicket</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number=<span class="hljs-number">30</span>;<br>    <span class="hljs-comment">//创建可重入锁对象</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ReentrantLock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>    <span class="hljs-comment">//编写方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sale</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//上锁</span><br>        lock.lock();  <span class="hljs-comment">//一般将上锁操作写在try外面,且和try直接不能有其他操作</span><br>        <span class="hljs-keyword">try</span>{<br>            <span class="hljs-comment">//做操作</span><br>            <span class="hljs-keyword">if</span>(number&gt;<span class="hljs-number">0</span>){<br>                System.out.print(<span class="hljs-string">"当前"</span>+number+<span class="hljs-string">"张--"</span>);<br>                number--;<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">": 卖出1，剩余"</span>+number+<span class="hljs-string">"张"</span>);<br>            }<br>        }<span class="hljs-keyword">finally</span> {  <span class="hljs-comment">//将解锁操作放到finally中，保证一定能够解锁</span><br>            <span class="hljs-comment">//解锁</span><br>            lock.unlock();<br>        }<br>    }<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SaleTicket_L</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        LTicket lTicket = <span class="hljs-keyword">new</span> LTicket();<br>        <span class="hljs-comment">//调用start方法不一定是马上创建线程，需要底层操作系统情况。</span><br>        <span class="hljs-keyword">new</span> Thread(()-&gt;{<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">30</span>;i++) lTicket.sale();},<span class="hljs-string">"售票员A"</span>).start();<br>        <span class="hljs-keyword">new</span> Thread(()-&gt;{<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">30</span>;i++) lTicket.sale();},<span class="hljs-string">"售票员B"</span>).start();<br>        <span class="hljs-keyword">new</span> Thread(()-&gt;{<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">30</span>;i++) lTicket.sale();},<span class="hljs-string">"售票员C"</span>).start();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、线程通信"><a href="#三、线程通信" class="headerlink" title="三、线程通信"></a>三、线程通信</h1><p>线程通信主要是通过<code>wait()、notify()、notifyall()</code>方法，或者是<code>Condition</code>的<code>await()、siginal()、signalAll()</code>这些方法。前者适用于<code>sychronized</code>方式，而后者是<code>Lock</code>锁的方式。</p>
<h2 id="3-1-案例：线程通信"><a href="#3-1-案例：线程通信" class="headerlink" title="3.1 案例：线程通信"></a>3.1 案例：线程通信</h2><p>创建两个线程A和B，一个线程对当前数值+1，另一个线程对当前数字-1，利用线程间的通信，使这两个线程交替操作。</p>
<p>方式一：使用<code>synchronized</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//一、创建资源类，定义属性和操作方法</span><br><span class="hljs-comment">//操作方法中判断、操作、通知</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Share</span></span>{<br>    <span class="hljs-comment">//初始值</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//+1的方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">increat</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        if只会判断一次，wait在哪里睡就在哪里醒，因此如果使用if，则会导致虚假唤醒问题。</span><br><span class="hljs-comment">        解决虚假唤醒问题，需要使用while代替if，因为while每次都会判断</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">while</span>(number !=<span class="hljs-number">0</span>){<br>            wait(); <span class="hljs-comment">//如果值不是0，就释放锁,进入阻塞状态，等待被唤醒</span><br>        }<br>        number++;<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"::"</span>+number);<br>        notifyAll();<br>    }<br>    <span class="hljs-comment">//-1的方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decreat</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{<br>        <span class="hljs-keyword">while</span>(number !=<span class="hljs-number">1</span>){<br>            wait();<br>        }<br>        number--;<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"::"</span>+number);<br>        notifyAll();<br>    }<br><br>}<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDemo1</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Share share = <span class="hljs-keyword">new</span> Share();<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; {<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">10</span>;i++){<br>                <span class="hljs-keyword">try</span> {<br>                    share.increat();<br>                } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                    e.printStackTrace();<br>                }<br>            }<br>        },<span class="hljs-string">"Thread A"</span>).start();<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; {<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">10</span>;i++){<br>                <span class="hljs-keyword">try</span> {<br>                    share.decreat();<br>                } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                    e.printStackTrace();<br>                }<br>            }<br>        },<span class="hljs-string">"Thread B"</span>).start();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>方式二：使用<code>Lock</code>锁：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//第一步：创建资源类，定义属性和操作方法</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Share</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> number = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//创建Lock对象</span><br>    <span class="hljs-keyword">private</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock();<br>    <span class="hljs-keyword">private</span> Condition condition = lock.newCondition();<br>    <span class="hljs-comment">//定义方法</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">incr</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{<br>        lock.lock();<span class="hljs-comment">//上锁</span><br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-keyword">while</span>(number!= <span class="hljs-number">0</span>){condition.await();}<span class="hljs-comment">//判断</span><br>            number++;<span class="hljs-comment">//操作</span><br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"::"</span>+number);<br>            condition.signalAll();<span class="hljs-comment">//通知</span><br>        } <span class="hljs-keyword">finally</span> {<br>            lock.unlock();<span class="hljs-comment">//解锁</span><br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">decr</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{<br>        lock.lock();<br>        <span class="hljs-keyword">try</span>{<br>            <span class="hljs-keyword">while</span>(number!=<span class="hljs-number">1</span>){condition.await();}<br>            number--;<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"::"</span>+number);<br>            condition.signalAll();<br>        }<span class="hljs-keyword">finally</span> {<br>            lock.unlock();<br>        }<br>    }<br>}<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDemo1_L</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        Share share = <span class="hljs-keyword">new</span> Share();<br>        <span class="hljs-comment">//创建A、B两个线程</span><br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++){<br>                    <span class="hljs-keyword">try</span> {<br>                        share.incr();<br>                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                        e.printStackTrace();<br>                    }<br>                }<br>            }<br>        },<span class="hljs-string">"Thread A"</span>).start();<br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++){<br>                    <span class="hljs-keyword">try</span> {<br>                        share.decr();<br>                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                        e.printStackTrace();<br>                    }<br>                }<br>            }<br>        },<span class="hljs-string">"Thread B"</span>).start();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3-2-案例：线程间定制化通信"><a href="#3-2-案例：线程间定制化通信" class="headerlink" title="3.2 案例：线程间定制化通信"></a>3.2 案例：线程间定制化通信</h2><p>一般的线程通信我们不能控制他们的执行次数和顺序，如果想要实现多个线程按照指定的顺序执行，就需要使用定制化通信。比如下面的例子。</p>
<p>案例：A线程打印5次，B线程打印10次，C线程打印15次，重复以上步骤n次</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*线程通信案例2：</span><br><span class="hljs-comment">实现线程间的定制化通信：A线程打印5次，B线程打印10次，C线程打印15次，重复以上步骤n次</span><br><span class="hljs-comment">实现方法为设置标志位flag，1表示A执行，2表示B执行，3表示C执行</span><br><span class="hljs-comment"> */</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShareResource</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> flag = <span class="hljs-number">1</span>;  <span class="hljs-comment">// 1-A,2-B,3-C</span><br>    <span class="hljs-keyword">private</span> Lock lock = <span class="hljs-keyword">new</span> ReentrantLock(); <span class="hljs-comment">//声明锁</span><br>    <span class="hljs-comment">//为了实现定制化通信，需要创建3个condition；保证唤醒的是指定的线程</span><br>    <span class="hljs-keyword">private</span> Condition c1 =  lock.newCondition();  <span class="hljs-comment">//相当于钥匙，用于通信</span><br>    <span class="hljs-keyword">private</span> Condition c2 =  lock.newCondition();<br>    <span class="hljs-keyword">private</span> Condition c3 =  lock.newCondition();<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print5</span><span class="hljs-params">(<span class="hljs-keyword">int</span> loop)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{<br>        lock.lock();<br>        <span class="hljs-keyword">try</span>{<br>            <span class="hljs-keyword">while</span>(flag!=<span class="hljs-number">1</span>){<br>                c1.await();<br>            }<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">5</span>;i++){<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"::"</span>+i+<span class="hljs-string">",当前轮数:"</span>+loop);<br>            }<br>            flag = <span class="hljs-number">2</span>; <span class="hljs-comment">//修改标志位是2</span><br>            c2.signal();  <span class="hljs-comment">//通知B线程；signal表示唤醒当前Condition对象中的等待队列中的一个线程。</span><br>        }<span class="hljs-keyword">finally</span> {<br>            lock.unlock();<br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print10</span><span class="hljs-params">(<span class="hljs-keyword">int</span> loop)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{<br>        lock.lock();<br>        <span class="hljs-keyword">try</span>{<br>            <span class="hljs-keyword">while</span>(flag!=<span class="hljs-number">2</span>){<br>                c2.await();<br>            }<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++){<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"::"</span>+i+<span class="hljs-string">",当前轮数:"</span>+loop);<br>            }<br>            flag = <span class="hljs-number">3</span>; <span class="hljs-comment">//修改标志位是2</span><br>            c3.signal();  <span class="hljs-comment">//通知C线程；signal表示唤醒当前Condition对象中的等待队列中的一个线程。</span><br>        }<span class="hljs-keyword">finally</span> {<br>            lock.unlock();<br>        }<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">print15</span><span class="hljs-params">(<span class="hljs-keyword">int</span> loop)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{<br>        lock.lock();<br>        <span class="hljs-keyword">try</span>{<br>            <span class="hljs-keyword">while</span>(flag!=<span class="hljs-number">3</span>){<br>                c3.await();<br>            }<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">15</span>;i++){<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"::"</span>+i+<span class="hljs-string">",当前轮数:"</span>+loop);<br>            }<br>            flag = <span class="hljs-number">1</span>; <span class="hljs-comment">//修改标志位是2</span><br>            c1.signal();  <span class="hljs-comment">//通知A线程；signal表示唤醒当前Condition对象中的等待队列中的一个线程。</span><br>        }<span class="hljs-keyword">finally</span> {<br>            lock.unlock();<br>        }<br>    }<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDemo2_L</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        ShareResource shareResource = <span class="hljs-keyword">new</span> ShareResource();<br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++){<br>                    <span class="hljs-keyword">try</span> {<br>                        shareResource.print5(i);<br>                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                        e.printStackTrace();<br>                    }<br>                }<br>            }<br>        },<span class="hljs-string">"A"</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++){<br>                    <span class="hljs-keyword">try</span> {<br>                        shareResource.print10(i);<br>                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                        e.printStackTrace();<br>                    }<br>                }<br>            }<br>        },<span class="hljs-string">"B"</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++){<br>                    <span class="hljs-keyword">try</span> {<br>                        shareResource.print15(i);<br>                    } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                        e.printStackTrace();<br>                    }<br>                }<br>            }<br>        },<span class="hljs-string">"C"</span>).start();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="四、集合的线程安全"><a href="#四、集合的线程安全" class="headerlink" title="四、集合的线程安全"></a>四、集合的线程安全</h1><h2 id="4-1-集合线程安全问题"><a href="#4-1-集合线程安全问题" class="headerlink" title="4.1 集合线程安全问题"></a>4.1 集合线程安全问题</h2><p>对于非线程安全的集合类，如果多个线程对其进行并发读写，就会出现并发异常：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadDemo4_L</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        ThreadDemo4_L demo4L = <span class="hljs-keyword">new</span> ThreadDemo4_L();<br>        demo4L.testHashMap();<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testHashMap</span><span class="hljs-params">()</span></span>{<br>        Map&lt;String,String&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">100</span>;i++){<br>            <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() {<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{<br>                    <span class="hljs-comment">//向hashmap中写入随机数</span><br>                    map.put(UUID.randomUUID().toString().substring(<span class="hljs-number">0</span>,<span class="hljs-number">8</span>),<span class="hljs-string">"t"</span>);<br>                    System.out.println(map);<br>                }<br>            },String.valueOf(i)).start();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>以上程序，并发情况下，对HashMap进行读写，会出现<code>ConcurrentModificationException</code>异常，表示出现了读写冲突。</p>
<p>对于不同的集合类，一般有对应的线程安全类，或者是其他的解决方法。</p>
<h2 id="4-2-ArrayList"><a href="#4-2-ArrayList" class="headerlink" title="4.2 ArrayList"></a>4.2 ArrayList</h2><p>ArrayList是线程不安全的，如果多个线程同时添加数据，读取的时候就会出现<code>ConcurrentModificationException</code>异常。</p>
<p>解决方法：</p>
<ul>
<li>使用<code>Vector</code>代替<code>ArrayList</code></li>
<li>使用<code>Collections</code>中的<code>synchronizedList</code>代替<code>ArrayList</code></li>
<li>使用<code>CopyOnWriteArrayList</code>代替<code>ArrayList</code></li>
</ul>
<p><code>CopyOnWriteArrayList</code>是JUC包下的一个<code>ArrayList</code>线程安全类，其功能和<code>ArrayList</code>一样，但是其使用<strong>写时复制</strong>的思想，保证了其是<strong>线程安全</strong>的，有以下特点：</p>
<ul>
<li>适合于<strong>读操作多于写操作</strong>、<strong>List较小</strong>的情况。</li>
<li>写时复制，在进行写操作的时候，会复制一份，在复制出来的容器中添加元素，添加完以后，将原容器的引用指向新的容器。</li>
<li><code>CopyOnWriteArrayList</code>底层使用<code>volatile</code>修饰数组，保证当前线程读的时候总能看到线程对数组最后的写入。避免了脏数据读取。</li>
<li><code>CopyOnWriteArrayList</code>使用互斥锁来保护数据，在“添加、修改、删除”数据时，会先获取互斥锁，修改完毕后，先将数据更新到volatile数组中，然后释放锁，以此保护数据。</li>
</ul>
<h2 id="4-3-HashSet"><a href="#4-3-HashSet" class="headerlink" title="4.3 HashSet"></a>4.3 HashSet</h2><p>JUC中对应的HashSet的线程安全类为：</p>
<p><code>java.util.concurrent.CopyOnWriteArraySet</code></p>
<h2 id="4-4-HashMap"><a href="#4-4-HashMap" class="headerlink" title="4.4 HashMap"></a>4.4 HashMap</h2><p>JUC中对应的HashMap的线程安全类为：</p>
<p><code>java.util.concurrent.ConcurrentHashMap</code>       </p>
<h1 id="五、Callable-amp-Future"><a href="#五、Callable-amp-Future" class="headerlink" title="五、Callable&amp;Future"></a>五、Callable&amp;Future</h1><p>实现<code>Callable</code>接口来创建线程最大的特点可以返回结果。</p>
<p><code>Runnable</code>接口和<code>Callable</code>接口对比：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>对比项</th>
<th>Runnable.run()</th>
<th>Callable.call()</th>
</tr>
</thead>
<tbody>
<tr>
<td>是否有返回值</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>是否抛出异常</td>
<td>否</td>
<td>是</td>
</tr>
</tbody>
</table>
</div>
<p><code>Callable</code>不能直接替换<code>Runnable</code>，因为<code>new Thread()</code>这个构造器只接受<code>Runnable</code>类型的参数，如果是<code>Callable</code>的实现类怎么办呢？</p>
<p>我们可以使用<code>Futrure</code>接口的实现类对象，<code>Future</code>接口中定义了5个方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Future</span>&lt;<span class="hljs-title">V</span>&gt; </span>{<br>    <span class="hljs-comment">//用于停止任务</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">cancel</span><span class="hljs-params">(<span class="hljs-keyword">boolean</span> mayInterruptIfRunning)</span></span>;<br>    <br>    <span class="hljs-comment">//如果任务在完成前被取消，则返回true</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isCancelled</span><span class="hljs-params">()</span></span>;<br>    <br>    <span class="hljs-comment">//如果任务完成，返回true，否则返回false</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isDone</span><span class="hljs-params">()</span></span>;<br>    <br>    <span class="hljs-comment">//用户获取任务的结果</span><br>    <span class="hljs-function">V <span class="hljs-title">get</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException, ExecutionException</span>;<br>    <br>    <span class="hljs-comment">//在指定的等待时间内，获取结果，如果超时还没有获取到结果，则抛出超时异常</span><br>    <span class="hljs-function">V <span class="hljs-title">get</span><span class="hljs-params">(<span class="hljs-keyword">long</span> timeout, TimeUnit unit)</span> <span class="hljs-keyword">throws</span> InterruptedException,</span><br><span class="hljs-function">    ExecutionException, TimeoutException</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>FutureTask</code>类实现了<code>Future</code>和<code>Runnable</code>接口，同时具备了这两个类的功能，并且其构造函数的参数是<code>Callable</code>类型，因此我们可以借助这个类来使用<code>Callable</code>接口创建线程：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//实现Callable接口</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyThread2</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Callable</span> </span>{<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">call</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"--come in callable"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span>;<br>    }<br>}<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Demo1</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ExecutionException, InterruptedException </span>{<br>        <br>        <span class="hljs-comment">//创建FutureTask对象并传入Callable实现类对象</span><br>        FutureTask&lt;Integer&gt; futureTask1 = <span class="hljs-keyword">new</span> FutureTask&lt;&gt;(<span class="hljs-keyword">new</span> MyThread2());<br>        <span class="hljs-keyword">new</span> Thread(futureTask1,<span class="hljs-string">"futureTask1"</span>).start();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>FutureTask中的<code>get()</code>方法如果被调用时计算未完成，会进入阻塞状态，直到计算完成，才会返回结果或者抛出异常。因此，<code>FutureTask</code>多用于耗时的计算任务，主线程可以再完成其他任务之后，再使用<code>get()</code>获取结果。</p>
<p><code>get()</code>方法只计算一次，再次调用时会直接返回计算好的结果，因此<code>get()</code>方法通常放到最后。</p>
<h1 id="六、JUC三大辅助类"><a href="#六、JUC三大辅助类" class="headerlink" title="六、JUC三大辅助类"></a>六、JUC三大辅助类</h1><p>JUC中提供了三种常用的辅助类，通过这些辅助类可以很好的解决线程数量过多时，手动操作<code>Lock</code>锁的频繁操作：</p>
<ul>
<li><code>CountDownLatch</code>：减少计数</li>
<li><code>CyclicBarrier</code>：循环栅栏</li>
<li><code>Semaphore</code>：信号量</li>
</ul>
<h2 id="6-1-CountDownLatch"><a href="#6-1-CountDownLatch" class="headerlink" title="6.1 CountDownLatch"></a>6.1 CountDownLatch</h2><p>CountDownLatch类可以设置一个计数器，然后通过<code>countDown</code>方法进行<strong>减1</strong>操作，使用<code>await()</code>方法等待计数器小于或等于0时，调用<code>await()</code>方法之后的语句。</p>
<ul>
<li><code>countDown()</code>方法会将计数器减1</li>
<li><code>await()</code>方法会将当前线程阻塞，直到计数器的值小于等于0</li>
</ul>
<p>案例：当所有学生都离开教室以后关灯。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">场景：当教室的n个人都离开后，才可以锁门</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">countDownLatchDemo</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>{<br>        <span class="hljs-comment">//1.创建CountDownLatch对象并设置初始计数值，假设有6个学生</span><br>        CountDownLatch countDownLatch = <span class="hljs-keyword">new</span> CountDownLatch(<span class="hljs-number">6</span>);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">6</span>;i++){<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;{<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">":离开"</span>);<br>                countDownLatch.countDown();  <span class="hljs-comment">//每次一个线程离开后，计数器减一</span><br>            },String.valueOf(i)).start();<br>        }<br>        <span class="hljs-comment">//只要计数器大于0，当前线程就一直等待；直到计数器等于0，当前线程才被唤醒</span><br>        countDownLatch.await(); <br>        System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"可以关灯了"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="6-2-CyclicBarrier"><a href="#6-2-CyclicBarrier" class="headerlink" title="6.2 CyclicBarrier"></a>6.2 CyclicBarrier</h2><p><code>CyclicBarrier</code>的构造方法第一个参数是目标障碍数，每次执行其中的<code>await()</code>方法，都会使障碍数<strong>加1</strong>，当障碍数达到目标障碍数，就会执行<code>await()</code>方法之后的语句。</p>
<blockquote>
<p>线程调用<code>await()</code>表示自己已经到达栅栏。当CyclicBarrier达到了指定的栅栏数，才会执行后面的语句。</p>
</blockquote>
<p>案例：集齐七颗龙珠召唤神龙</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//场景：集齐七颗龙珠召唤神龙</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CyclicBarrierDemo</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> NUMBER = <span class="hljs-number">7</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//新建循环栅栏对象，设置一个固定值，并指定达到这个固定值以后，需要做的事</span><br>        CyclicBarrier cyclicBarrier = <span class="hljs-keyword">new</span> CyclicBarrier(NUMBER, () -&gt; {<br>            System.out.println(<span class="hljs-string">"召唤神龙!"</span>);<br>        });<br><br>        <span class="hljs-comment">//集齐七颗龙珠的过程</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">7</span>;i++){<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;{<br>                System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"星龙珠已收集到"</span>);<br>                <span class="hljs-keyword">try</span> {<br>                    <span class="hljs-comment">//await表示已经到达栅栏，每执行一次，计数加一</span><br>                    cyclicBarrier.await();   <br>                    <span class="hljs-comment">//如果没有到达指定的7颗，cyclicBarrier会一直处于等待状态</span><br>                } <span class="hljs-keyword">catch</span> (InterruptedException | BrokenBarrierException e) {<br>                    e.printStackTrace();<br>                }<br>            },String.valueOf(i)).start();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="6-3-Semaphore"><a href="#6-3-Semaphore" class="headerlink" title="6.3 Semaphore"></a>6.3 Semaphore</h2><p><code>Semaphore</code>的构造方法中传入的第一个参数是最大信号量，类似于线程池中最大的线程数量，每个信号量初始化为一个最多只能分发一个许可证，线程通过<code>acquire()</code>方法获得许可证，<code>release()</code>方法释放许可证。</p>
<p>案例：6辆车抢3个车位</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//场景：6辆汽车，停到3个车位</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SemaphoreDemo</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//创建semaphore，模拟3个车位，即设置3个许可量，即同时只能有3个线程获取到许可量</span><br>        Semaphore semaphore = <span class="hljs-keyword">new</span> Semaphore(<span class="hljs-number">3</span>);<br>        <span class="hljs-comment">//模拟6辆汽车</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">6</span>;i++){<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;{<br>                <span class="hljs-keyword">try</span> {<br>                    <span class="hljs-comment">//获取许可量，即占用车位</span><br>                    semaphore.acquire();<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"抢占到了车位"</span>);<br>                    <span class="hljs-comment">//模拟停车时间</span><br>                    TimeUnit.SECONDS.sleep(<span class="hljs-keyword">new</span> Random().nextInt(<span class="hljs-number">5</span>));<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"离开了车位"</span>);<br>                } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>                    e.printStackTrace();<br>                } <span class="hljs-keyword">finally</span> {<br>                    <span class="hljs-comment">//释放许可量</span><br>                    semaphore.release();<br>                }<br>            },i+<span class="hljs-string">"号车"</span>).start();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="七、读写锁"><a href="#七、读写锁" class="headerlink" title="七、读写锁"></a>七、读写锁</h1><h2 id="7-1-读写锁概念"><a href="#7-1-读写锁概念" class="headerlink" title="7.1 读写锁概念"></a>7.1 读写锁概念</h2><p>悲观锁：每次操作都上锁，不支持并发</p>
<p>乐观锁：支持并发。通过版本号进行控制，每次提交事务都会比较当前版本号和自己的版本号，如果一致，则提交成功，如果版本号高于自己的版本号，说明别人已经优先一步做了修改，自己提交失败。</p>
<p>表锁：不会发生死锁</p>
<p>行锁：会发生死锁</p>
<p>读锁：共享锁。会发生死锁</p>
<p>写锁：独占锁。会发生死锁</p>
<p><strong>进入读锁的前提条件</strong></p>
<ul>
<li>没有其他线程的写锁</li>
<li>没有写请求，或者写请求和当前持有锁的线程是同一个，即可重入锁。</li>
</ul>
<p><strong>进入写锁的前提条件</strong></p>
<ul>
<li>没有其他线程的读锁</li>
<li>没有其他线程的写锁</li>
</ul>
<p><strong>读写锁</strong>：一个资源可以被多个读线程访问，或者可以被一个写线程访问；但是不能同时存在读和写线程。即读写互斥，读读共享。</p>
<p>读写锁缺点：</p>
<ul>
<li>容易造成锁饥饿现象。比如一直读，不能写</li>
<li>读的时候不能写，只能读完再写。而写的时候可以读。</li>
</ul>
<p>JUC提供了<code>ReentrantReadWriteLock</code>，这个类可以提供<strong>读写锁</strong>。读写锁有以下特征：</p>
<ul>
<li>公平选择性：支持公平和非公平锁（默认）两种方式，非公平锁的吞吐量优于公平锁。</li>
<li>重进入：读锁和写锁都支持线程重进入。</li>
<li><strong>锁降级</strong>：遵循获取写锁、获取读锁再释放写锁的顺序，<strong>写锁能够降级为读锁</strong>。写操作的时候可以进行读操作；但是读锁不能升级为写锁，因此读操作的时候不能进行写。</li>
</ul>
<h2 id="7-2-ReadWriteLock"><a href="#7-2-ReadWriteLock" class="headerlink" title="7.2 ReadWriteLock"></a>7.2 ReadWriteLock</h2><p><code>ReadWriteLock</code>表示读写锁接口，<code>ReentrantReadWriteLock</code>是它的一个实现类，其中提供了<code>readLock()</code>和<code>writeLock()</code>两个方法用来获取<strong>读锁</strong>和<strong>写锁</strong>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ReadWriteLock</span> </span>{<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the lock used for reading.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the lock used for reading</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">Lock <span class="hljs-title">readLock</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Returns the lock used for writing.</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span> the lock used for writing</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function">Lock <span class="hljs-title">writeLock</span><span class="hljs-params">()</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>读写锁将文件的读写操作分开，分成2个锁来分配给线程，使多个线程可以同时进行读操作。</p>
<p><code>ReentrantReadWriteLock</code>实现了<code>ReadWriteLock</code>接口，并提供了更多丰富的方法。</p>
<p>案例：使用<code>ReentrantReadWriteLock</code>对哈希表进行读写操作</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//场景：模拟缓存机制</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReadWriteLockDemo</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        MyCache myCache = <span class="hljs-keyword">new</span> MyCache();<br>        <span class="hljs-comment">//创建线程放数据</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">5</span>;i++){<br>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> num = i;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;{<br>                myCache.put(num+<span class="hljs-string">""</span>,num+<span class="hljs-string">""</span>);<br>            },<span class="hljs-string">"线程"</span>+i).start();<br>        }<br>        <span class="hljs-comment">//创建线程取数据</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">5</span>;i++){<br>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> num = i;<br>            <span class="hljs-keyword">new</span> Thread(()-&gt;{<br>                myCache.get(num+<span class="hljs-string">""</span>);<br>            },<span class="hljs-string">"线程"</span>+i).start();<br>        }<br>    }<br>}<br><br><span class="hljs-comment">//使用读写锁，每次读和写之前都上锁，保证了不会出现还没写完就读的情况</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCache</span></span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> Map&lt;String,Object&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br><br>    <span class="hljs-comment">//创建读写锁对象</span><br>    <span class="hljs-keyword">private</span> ReadWriteLock rwl = <span class="hljs-keyword">new</span> ReentrantReadWriteLock();<br><br>    <span class="hljs-comment">//放数据</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span><span class="hljs-params">(String key, Object value)</span> </span>{<br>        rwl.writeLock().lock(); <span class="hljs-comment">//加上一个写锁</span><br>        <span class="hljs-keyword">try</span> {<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"正在写"</span>+key);<br>            TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">300</span>);<br>            map.put(key,value);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"写完了"</span>+key);<br>        } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-comment">//释放写锁</span><br>            rwl.writeLock().unlock();<br>        }<br>    }<br>    <br>    <span class="hljs-comment">//取数据</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(String key)</span>  </span>{<br>        <span class="hljs-comment">//添加读锁</span><br>        rwl.readLock().lock();<br>        Object o = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"正在读"</span>+key);<br>            TimeUnit.MILLISECONDS.sleep(<span class="hljs-number">300</span>);<br>            o = map.get(key);<br>            System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"读完了"</span>+key);<br>        } <span class="hljs-keyword">catch</span> (InterruptedException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">finally</span> {<br>            <span class="hljs-comment">//释放读锁</span><br>            rwl.readLock().unlock();<br>        }<br>        <span class="hljs-keyword">return</span> o;<br>    }<br>}<br><span class="hljs-comment">/*运行结果</span><br><span class="hljs-comment">线程1正在写1</span><br><span class="hljs-comment">线程1写完了1</span><br><span class="hljs-comment">线程3正在写3</span><br><span class="hljs-comment">线程3写完了3</span><br><span class="hljs-comment">线程4正在写4</span><br><span class="hljs-comment">线程4写完了4</span><br><span class="hljs-comment">线程5正在写5</span><br><span class="hljs-comment">线程5写完了5</span><br><span class="hljs-comment">线程2正在写2</span><br><span class="hljs-comment">线程2写完了2</span><br><span class="hljs-comment">线程1正在读1</span><br><span class="hljs-comment">线程4正在读4</span><br><span class="hljs-comment">线程3正在读3</span><br><span class="hljs-comment">线程2正在读2</span><br><span class="hljs-comment">线程5正在读5</span><br><span class="hljs-comment">线程2读完了2</span><br><span class="hljs-comment">线程5读完了5</span><br><span class="hljs-comment">线程4读完了4</span><br><span class="hljs-comment">线程3读完了3</span><br><span class="hljs-comment">线程1读完了1</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，读锁可以被多个线程共享，因此出现了多个线程同时进行读操作的情况。而写锁是互斥锁，同时只能一个线程持有，因此只能等当前线程写操作执行完释放锁以后，其他线程才可以获取到写锁。</p>
<h1 id="八、阻塞队列"><a href="#八、阻塞队列" class="headerlink" title="八、阻塞队列"></a>八、阻塞队列</h1><h2 id="8-1-BlockingQueue"><a href="#8-1-BlockingQueue" class="headerlink" title="8.1 BlockingQueue"></a>8.1 BlockingQueue</h2><p>JUC提供了<code>BlockingQueue</code>接口表示<strong>阻塞队列</strong>。</p>
<p>阻塞队列，首先是一个队列，其通过一个共享的队列，使数据从队列的一端输入，从另外一端输出。</p>
<p><strong>当队列是空的，从队列中获取元素的操作将会被阻塞，直到其他线程往空队列中添加了新元素。</strong></p>
<p><strong>当队列是满的，向队列中添加元素的操作将会被阻塞，直到其他其他线程从队列中移除一个或多个元素</strong>。</p>
<p>使用阻塞队列，我们不需要关心什么时候需要阻塞线程，什么时候需要唤醒线程，因为阻塞队列自动判断。以常见的生产者-消费者模型为例，当生产者将队列填满产品时，就会进入阻塞状态，直到队列中有元素被“消费”；而当队列没有数据时，消费者线程就会被自动阻塞，直到有产品入队。</p>
<p><code>BlockingQueue</code>接口中的核心方法主要包括添加、移除、检查元素三种，每种方法有多个具体的方法，其差别如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>方法类型</th>
<th>抛出异常</th>
<th>返回特殊值</th>
<th>阻塞</th>
<th>超时</th>
</tr>
</thead>
<tbody>
<tr>
<td>插入数据</td>
<td><code>add(e)</code></td>
<td><code>offer(e)</code></td>
<td><code>put(e)</code></td>
<td><code>offer(e,time,unit)</code></td>
</tr>
<tr>
<td>移除数据</td>
<td><code>remove()</code></td>
<td><code>poll()</code></td>
<td><code>take()</code></td>
<td><code>poll(time,unit)</code></td>
</tr>
<tr>
<td>检查数据</td>
<td><code>element()</code></td>
<td><code>peek()</code></td>
<td>不可用</td>
<td>不可用</td>
</tr>
</tbody>
</table>
</div>
<p>抛出异常：方法执行失败就会抛出异常，比如队列满时添加数据，或者队列空时移除数据。</p>
<p>返回特殊值：对于<code>offer()</code>方法，添加成功返回<code>true</code>，失败则返回<code>false</code>；<code>poll()</code>方法，移除成功则返回移除的元素，否则返回<code>null</code></p>
<p>阻塞：队列满时，添加数据就会进入阻塞状态；队列空时，移除数据会进入阻塞状态。</p>
<p>超时：带有阻塞时间的方法，在阻塞到指定的时长后，退出线程。</p>
<h2 id="8-2-常见的阻塞队列"><a href="#8-2-常见的阻塞队列" class="headerlink" title="8.2 常见的阻塞队列"></a>8.2 常见的阻塞队列</h2><h3 id="8-2-1-ArrayBlockingQueue"><a href="#8-2-1-ArrayBlockingQueue" class="headerlink" title="8.2.1 ArrayBlockingQueue"></a>8.2.1 ArrayBlockingQueue</h3><p><code>ArrayBlockingQueue</code>是<strong>由数组结构组成的有界阻塞队列</strong>.</p>
<p>底层使用数组实现，长度固定，声明时必须指定大小，先进先出。</p>
<p>创建时，可以指定公平锁或者非公平锁。</p>
<h3 id="8-2-2-LinkedBlockingQueue"><a href="#8-2-2-LinkedBlockingQueue" class="headerlink" title="8.2.2 LinkedBlockingQueue"></a>8.2.2 LinkedBlockingQueue</h3><p><code>LinkedBlockingQueue</code>是<strong>由链表结构组成的有界阻塞队列</strong>。</p>
<p>底层使用链表结构(Node节点)，可以手动指定固定的大小，默认为<code>Integer.MAX_VALUE</code>。</p>
<p>以生产者消费者模型为例，<code>ArrayBlockingQueue</code>在生产者和消费者操作的时候，共用同一个锁对象，因此它们不是完全并行的；<code>LinkedBlockingQueue</code>对于生产者和消费者使用独立的锁来控制数据同步，在高并发情况下提高整个队列的并发性能。</p>
<h3 id="8-2-3-DelayQueue"><a href="#8-2-3-DelayQueue" class="headerlink" title="8.2.3 DelayQueue"></a>8.2.3 DelayQueue</h3><p><code>DelayQueue</code>是<strong>使用优先级队列实现的延迟无界阻塞队列</strong></p>
<p><code>DelayQueue</code>中的元素只有当其指定的延迟时间到了，才能够从队列中获取到该元素。</p>
<p><code>DelayQueue</code>长度无限制，意味着添加数据的进程用于不会被阻塞，只有获取数据的线程才可能会被阻塞。</p>
<h3 id="8-2-4-PriorityBlockingQueue"><a href="#8-2-4-PriorityBlockingQueue" class="headerlink" title="8.2.4 PriorityBlockingQueue"></a>8.2.4 PriorityBlockingQueue</h3><p><code>PriorityBlockingQueue</code>是<strong>支持优先级排序的无界阻塞队列</strong></p>
<p>基于优先级队列实现，长度无限制，不会阻塞添加数据的进程。</p>
<p>内部控制同步的锁是公平锁。</p>
<p>使用<code>PriorityBlockingQueue</code>要注意的是，如果生产者的速度快于消费者，会导致可用堆内存空间耗尽。</p>
<h3 id="8-2-5-SynchronousQueue"><a href="#8-2-5-SynchronousQueue" class="headerlink" title="8.2.5 SynchronousQueue"></a>8.2.5 SynchronousQueue</h3><p><code>SynchronousQueue</code>是<strong>不存储元素的阻塞队列</strong></p>
<p><code>SynchronousQueue</code>不存储元素，或者说只有单个元素。是一个无缓冲区的阻塞队列，类似于消费者生产出一个产品以后，亲自交到消费者手中以后才生产下一个，而没有类似其他阻塞队列的“缓冲区”可以存放生产好的产品。</p>
<p>一个线程的插入操作，必须等待其他线程的移除操作执行完后才能执行，相当于队列只能同时有一个元素。</p>
<p><code>SynchronousQueue</code>有公平锁和非公平锁模式。</p>
<h3 id="8-2-6-LinkedTransferQueue"><a href="#8-2-6-LinkedTransferQueue" class="headerlink" title="8.2.6  LinkedTransferQueue"></a>8.2.6  LinkedTransferQueue</h3><p><code>LinkedTransferQueue</code>是<strong>由链表组成的无界阻塞队列</strong></p>
<p>由链表结构组成，相较于其他阻塞队列，多了<code>tryTransfer</code>和<code>transfer</code>方法。</p>
<p><code>LinkedTransferQueue</code>采用一种<strong>预占模式</strong>，消费者取数据时，如果队列为空，会生成一个节点（节点元素为<code>null</code>），这个消费者线程会等待在这个节点上，当生产者线程入队时，发现这个节点后，就直接将数据填充到该节点，并唤醒在此等待的消费者线程，消费者线程取走元素。</p>
<h3 id="8-2-7-LinkedBlockingDeque"><a href="#8-2-7-LinkedBlockingDeque" class="headerlink" title="8.2.7 LinkedBlockingDeque"></a>8.2.7 LinkedBlockingDeque</h3><p><code>LinkedBlockingDeque</code>是由<strong>链表组成的双向有界阻塞队列</strong></p>
<p>和<code>LinkedBlockingQueue</code>相比，<code>LinkedBlockingDeque</code>是由链表组成的双向队列，同样是有界的，最大容量为最大整型数值。</p>
<p>数据可以从队列两端入队出队。</p>
<h1 id="九、线程池"><a href="#九、线程池" class="headerlink" title="九、线程池"></a>九、线程池</h1><h2 id="9-1-使用线程池"><a href="#9-1-使用线程池" class="headerlink" title="9.1 使用线程池"></a>9.1 使用线程池</h2><p>Java中的线程池主要是<code>Executor</code>这个接口及其子类。继承体系如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/juc-basis_1.png"><span class="image-caption">线程池接口体系</span></p>
<p><code>Executor</code>接口中只有一个<code>execute()</code>方法，用于执行<code>Runnable</code>实现类的线程。</p>
<p><code>ExecutorService</code>是真正意义上的线程池接口，定义了<code>submit()</code>、<code>shutdown()</code>等线程池相关的方法。</p>
<p><code>ThreadPoolExecutor</code>是<code>ExecutorService</code>的一个实现类，其定义了对线程池操作的各种方法，比如设置核心池大小，最大线程数等方法。创建线程池就是创建这个类的对象。</p>
<p><code>Executors</code>类是线程池的一个工具类，提供了多种方法可以创建多种线程池：</p>
<ul>
<li><code>newCachedThreadPool()</code>：创建一个<strong>可缓存线程池</strong>，如果线程池长度超过了处理需要的长度，可灵活回收空闲线程，如果没有可回收的线程，则新建线程。<ul>
<li>线程池数量不固定，不限制数量，但最大值为<code>Integer.MAX_VALUE</code></li>
<li>线程池中的线程可进行缓存重复利用和回收。</li>
<li>线程池中没有可用线程时，才会创建新线程。</li>
</ul>
</li>
<li><code>newFixedThreadPool()</code>：创建一个<strong>可重用固定线程数的线程池</strong>，以无界队列方式运行这些线程。<ul>
<li>线程池中的线程处于一定的量，可以很好的控制线程的并发量</li>
<li>线程可以重复被使用，在显式关闭之前，都将一直存在</li>
<li>超出一定量的线程被提交时需要在队列中等待。</li>
</ul>
</li>
<li><code>newSingleThreadExecutor()</code>：创建一个<strong>只有一个活动线程的线程池</strong>，以无界队列方式运行该线程，保证同时只有一个线程在工作。<ul>
<li>线程池中同时最多只执行一个线程，之后提交的线程都会排到队列中。</li>
</ul>
</li>
<li><code>newScheduleThreadPool()</code>：创建一个<strong>带有延时执行命令的线程池</strong>。线程池支持定时以及周期性执行任务。</li>
<li><code>newWorkStealingPool()</code>：创建一个<strong>拥有多个任务队列的线程池</strong>，创建当前可用cpu核数的线程来并行执行任务。JDK 8.0出现，适用于耗时、可并行执行的场景。</li>
</ul>
<p>案例：银行窗口办理业务，假设有5个窗口，10个客户</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 以银行窗口办理业务为例</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadPoolDemo1</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//一池5线程，表示5个窗口</span><br>        ExecutorService threadPool1 = Executors.newFixedThreadPool(<span class="hljs-number">5</span>);  <br>        <span class="hljs-keyword">try</span>{<br>            <span class="hljs-comment">//假设有10个顾客</span><br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">10</span>;i++){<br>                threadPool1.execute(()-&gt;{<br>                    System.out.println(Thread.currentThread().getName()+<span class="hljs-string">"正在办理业务"</span>);<br>                });<br>            }<br>        }<span class="hljs-keyword">finally</span> {<br>            <span class="hljs-comment">//关闭线程池</span><br>            threadPool1.shutdown();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="9-2-线程池原理及参数"><a href="#9-2-线程池原理及参数" class="headerlink" title="9.2 线程池原理及参数"></a>9.2 线程池原理及参数</h2><font color="red">线程池参数</font>



<p><code>Executors</code>工具类中创建线程池，都是调用的<code>ThreadPoolExecutor</code>类的构造参数来创建的，只是根据不同的需求，传入的参数不同。</p>
<p><code>ThreadPoolExecutor</code>构造器：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThreadPoolExecutor</span><span class="hljs-params">(<span class="hljs-keyword">int</span> corePoolSize,</span></span><br><span class="hljs-function"><span class="hljs-params">                          <span class="hljs-keyword">int</span> maximumPoolSize,</span></span><br><span class="hljs-function"><span class="hljs-params">                          <span class="hljs-keyword">long</span> keepAliveTime,</span></span><br><span class="hljs-function"><span class="hljs-params">                          TimeUnit unit,</span></span><br><span class="hljs-function"><span class="hljs-params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="hljs-function"><span class="hljs-params">                          ThreadFactory threadFactory,</span></span><br><span class="hljs-function"><span class="hljs-params">                          RejectedExecutionHandler handler)</span> </span>{<br>    <span class="hljs-keyword">if</span> (corePoolSize &lt; <span class="hljs-number">0</span> ||<br>        maximumPoolSize &lt;= <span class="hljs-number">0</span> ||<br>        maximumPoolSize &lt; corePoolSize ||<br>        keepAliveTime &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException();<br>    <span class="hljs-keyword">if</span> (workQueue == <span class="hljs-keyword">null</span> || threadFactory == <span class="hljs-keyword">null</span> || handler == <span class="hljs-keyword">null</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException();<br>    <span class="hljs-keyword">this</span>.corePoolSize = corePoolSize;<br>    <span class="hljs-keyword">this</span>.maximumPoolSize = maximumPoolSize;<br>    <span class="hljs-keyword">this</span>.workQueue = workQueue;<br>    <span class="hljs-keyword">this</span>.keepAliveTime = unit.toNanos(keepAliveTime);<br>    <span class="hljs-keyword">this</span>.threadFactory = threadFactory;<br>    <span class="hljs-keyword">this</span>.handler = handler;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>其中的7个参数：</p>
<ul>
<li><code>int corePoolSize</code>：核心线程数量、常驻线程数量</li>
<li><code>int maximumPoolSize</code>：最大支持线程数量</li>
<li><code>long keepAliveTime</code>：线程没有任务时的存活时间（只针对除了核心线程以外的线程）</li>
<li><code>TimeUnit unit</code>：<code>keepAliveTime</code>的时间单位，比如秒、毫秒等</li>
<li><code>BlockingQueue&lt;Runnable&gt; workQueue</code>：阻塞队列。如果常驻线程数量用完，其他请求就会放到阻塞队列中。当阻塞队列再满的时候，如果有其他请求进入，才创建新的线程，直到达到最大支持的数量。</li>
<li><code>ThreadFactory threadFactory</code>：线程工厂，用于创建线程</li>
<li><code>RejectedExecutionHandler handler</code>：拒绝策略，表示什么时候拒绝线程。</li>
</ul>
<p>当提交的任务数，大于线程池最大支持的线程数量时，就会触发线程池的拒绝策略。</p>
<p><strong>拒绝策略</strong>有以下四种：</p>
<ul>
<li>AbortPolicy。默认策略。直接抛出<code>RejectedExecutionException</code>异常阻止系统正常运行。</li>
<li>CallerRunsPolicy：既不会抛弃任务，也不会抛出异常，而是将这些任务回退到调用者，从而降低新任务的流量。</li>
<li>DiscardOldestPolity：抛弃队列中等待最久的任务，然后把当前任务加入队列中并尝试再次提交当前任务。</li>
<li>DiscardPolicy： 默默地丢弃无法处理的任务，不予任何处理也不抛出异常。</li>
</ul>
<font color="red">线程池工作原理</font>

<p>假设当前线程池的常驻线程数为2，最大线程数为5，阻塞队列固定大小为3，下面分析运行流程。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/juc-basis_2.png"><span class="image-caption">线程池运行原理</span></p>
<p>1、提交两个任务，此时常驻线程被占用。</p>
<p>2、当常驻线程都被占用时，再次提交任务3,4,5会进入阻塞队列。</p>
<p>3、当阻塞队列满的时候，再提交任务6,7,8的时候，才会创建新线程。</p>
<p>4、当创建了3个线程后，达到了最大支持线程数量，此时提交任务9，就会触发拒绝策略。</p>
<p>当非核心线程超过存活时间后，会被销毁。</p>
<h2 id="9-3-自定义线程池"><a href="#9-3-自定义线程池" class="headerlink" title="9.3 自定义线程池"></a>9.3 自定义线程池</h2><p>虽然<code>Executor</code>工具类提供了各种创建线程池的方法，但是一般我们不会使用，根据《阿里巴巴Java开发手册》，开发中创建线程池必须手动创建，手动指定线程池的参数。</p>
<p>这是因为<code>Executors</code>返回的线程池对象有以下弊端：</p>
<ul>
<li><code>FixedThreadPool</code>和<code>SingleThreadPool</code>：<br>允许的请求队列长度为<code>Integer.MAX_VALUE</code>，可能会堆积大量的请求，从而导致OOM。</li>
<li><code>CachedThreadPool</code>和<code>ScheduledThreadPool</code>：<br>允许的创建线程数量为<code>Integer.MAX_VALUE</code>，可能会创建大量的线程，从而导致OOM。</li>
</ul>
<p>即使用工具类创建的线程池可能会因为堆积大量请求而导致OOM。</p>
<p>手动创建线程池，需要指定7个参数。</p>
<p>案例：使用自定义线程池实现银行窗口办理业务场景模拟。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//自定义线程池</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThreadPoolDemo2</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//自定义线程池,</span><br>        <span class="hljs-comment">//常驻线程数量为2，最大为5，超时时间为0秒，阻塞队列为3，拒绝策略为AbortPolicy</span><br>        ThreadPoolExecutor threadPoolExecutor = <span class="hljs-keyword">new</span> ThreadPoolExecutor(<span class="hljs-number">2</span>, <span class="hljs-number">5</span>, <span class="hljs-number">0L</span>,<br>                TimeUnit.SECONDS,<br>                <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">3</span>),<br>                Executors.defaultThreadFactory(),<br>                <span class="hljs-keyword">new</span> ThreadPoolExecutor.AbortPolicy());<br><br>        <span class="hljs-comment">//使用线程池。模拟10个客户</span><br>        <span class="hljs-keyword">try</span>{<br>            <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">10</span>;i++){<br>                threadPoolExecutor.execute(() -&gt; System.out.println(<br>                    Thread.currentThread().getName()+<span class="hljs-string">"正在办理业务"</span>));<br>            }<br>        }<span class="hljs-keyword">finally</span> {<br>            threadPoolExecutor.shutdown();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>上述代码中，当最大线程数为5，阻塞队列容量为3时，面对10个任务请求，会触发拒绝策略， 如果将最大线程数或者队列容量提高，保证二者之和大于等于最大任务请求，就不会触发拒绝策略。实际大小需要根据实际情况而定。</p>
]]></content>
      <categories>
        <category>并发编程</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>JUC</tag>
      </tags>
  </entry>
  <entry>
    <title>MyBatis配置与使用</title>
    <url>/2021/06/21/mybatis-basis/</url>
    <content><![CDATA[<h1 id="一、MyBatis介绍"><a href="#一、MyBatis介绍" class="headerlink" title="一、MyBatis介绍"></a>一、MyBatis介绍</h1><p>MyBatis是一款优秀的持久层框架，它支持自定义 SQL、存储过程以及高级映射。MyBatis 免除了几乎所有的 JDBC 代码以及设置参数和获取结果集的工作。MyBatis 可以通过简单的<strong>XML</strong> 或<strong>注解</strong>来配置和映射原始类型、接口和 Java POJO（Plain Old Java Objects，普通老式 Java 对象）为数据库中的记录。</p>
<p>总结：MyBatis使用<strong>XML</strong> 或<strong>注解</strong>替代了传统的DAO实现，开发人员只需要关注SQL语句的编写，不需要花费大量代码去获取数据库连接和处理结果集。</p>
<p>官方文档：<a href="https://mybatis.org/mybatis-3/zh/index.html">https://mybatis.org/mybatis-3/zh/index.html</a></p>
<blockquote>
<p>表现层、业务层、持久层三层框架。</p>
</blockquote>
<h1 id="二、MyBatis实现CRUD"><a href="#二、MyBatis实现CRUD" class="headerlink" title="二、MyBatis实现CRUD"></a>二、MyBatis实现CRUD</h1><p><strong>使用环境</strong>：</p>
<p>IDEA Ultimate 2020.3</p>
<p>MyBatis 3.4.6</p>
<p>MySQL 5.1.47</p>
<p>Maven 3.8.1</p>
<p>练习代码参考：<a href="https://github.com/kangshitao/MyBatis_study">Mybatis_study</a></p>
<h2 id="2-1-基本步骤"><a href="#2-1-基本步骤" class="headerlink" title="2.1 基本步骤"></a>2.1 基本步骤</h2><p>Maven项目中使用MyBatis的大致步骤，和常用的文件目录结构如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mybatis-basis_1.png"><span class="image-caption">Maven项目中配置MyBatis</span></p>
<h2 id="2-2-步骤详情"><a href="#2-2-步骤详情" class="headerlink" title="2.2 步骤详情"></a>2.2 步骤详情</h2><h3 id="2-2-1-pom文件配置"><a href="#2-2-1-pom文件配置" class="headerlink" title="2.2.1 pom文件配置"></a>2.2.1 pom文件配置</h3><p>要使用MyBatis，首先需要导入其jar包，在<a href="https://mvnrepository.com/">mvnrepository</a>网站找到MyBatis依赖，将其放入Maven配置文件中的依赖中即可。同时还需要导入MySQL依赖，其余的根据需求导入。</p>
<p><code>pom.xml</code>文件是Maven项目的配置文件，其配置了项目的组id，部署id，版本号，依赖包等内容。</p>
<p>这里将<code>Mybatis_study</code>作为父工程，其中包括了多个子模块，只需要在父工程的配置文件中添加依赖，子模块的<code>pom.xml</code>就不再需要额外引入依赖了。</p>
<p>父工程的<code>pom.xml</code>文件</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--作为父工程--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.kang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>Mybatis_study<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--子模块--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">modules</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>mybatis-01<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>mybatis-02<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">module</span>&gt;</span>mybatis-03<span class="hljs-tag">&lt;/<span class="hljs-name">module</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">modules</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--源代码使用的JDK版本--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.source</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.source</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--编译源代码使用的JDK版本--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">maven.compiler.target</span>&gt;</span>15<span class="hljs-tag">&lt;/<span class="hljs-name">maven.compiler.target</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--在dependencies中添加需要的依赖--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--mybatis依赖--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--mysql依赖--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.47<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--junit依赖--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>junit<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- log4j依赖 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>log4j<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.17<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-comment">&lt;!--资源插件，使maven在编译时将src/main/java下的指定的文件拷贝到target/classes中--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-comment">&lt;!--directory，指定要拷贝的目录--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br><span class="hljs-comment">&lt;!--指定目录下的文件，将所有properties后缀和xml后缀的文件都拷贝到target/classes中--&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.properties<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br><span class="hljs-comment">&lt;!-- false表示不启用过滤器，因为上面*.properties已经起到过滤作用了--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.properties<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>因为Maven在编译时，默认只会将<code>resource</code>目录下的配置文件添加到<code>target/classes</code>文件夹下，如果使用了Mapper配置文件，则需要在Maven配置文件中使用<code>&lt;resources&gt;</code>标签，使Maven编译时将指定目录下的配置文件也拷贝到<code>target/classes</code>文件夹下。</p>
<p>另一种做法是，在<code>resource</code>目录下，创建和DAO接口相同的目录，将配置文件添加到这个目录下。</p>
<blockquote>
<p>项目中这些路径，都是编译后的文件所在的位置，所以原则是保证编译后，能够根据代码中写的路径找到相应的文件。</p>
<p>Maven会将<code>resource</code>目录下的配置文件编译到<code>target/classes</code>目录下，将<code>java</code>目录下的文件也编译到<code>target/classes</code>目录。</p>
<p>如果resource目录下存在一个和java目录相同的子目录，编译后，这两个目录中的内容都会存放在<code>target/classes</code>的同一个目录中，这个路径就是原来的相同的子目录（就是说两个相同的子目录编译后只会存在一个）</p>
</blockquote>
<h3 id="2-2-2-MyBatis配置文件"><a href="#2-2-2-MyBatis配置文件" class="headerlink" title="2.2.2 MyBatis配置文件"></a>2.2.2 MyBatis配置文件</h3><p><code>mybatis-config.xml</code>配置文件位于<code>resource</code>文件目录下，其包含了对MyBatis系统的核心设置，包括获取数据库连接实例的数据源（DataSource）以及决定事务作用域和控制方式的事务管理器（TransactionManager）等。</p>
<p><code>mybatis-config.xml</code>的简单示例：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--环境配置，可以配置多个环境，并指定一个默认的环境--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">environments</span> <span class="hljs-attr">default</span>=<span class="hljs-string">"development"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">environment</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"development"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">transactionManager</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"JDBC"</span>/&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dataSource</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"POOLED"</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driver"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.jdbc.Driver"</span>/&gt;</span><br>                <span class="hljs-comment">&lt;!--这里需要使用转义字符代替&amp;符号--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://localhost:3306/mybatis?characterEncoding=UTF-8<span class="hljs-symbol">&amp;amp;</span>serverTimezone=UTC"</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"root"</span>/&gt;</span><span class="hljs-comment">&lt;!--数据库用户--&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>/&gt;</span><span class="hljs-comment">&lt;!--密码--&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dataSource</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">environment</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">environments</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--Mapper映射--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"com/kang/dao/UserMapper.xml"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>MyBatis的XML配置文件的按照严格的结构配置，配置文件中的标签书写顺序要严格按照下面的顺序。参考MyBatis官方文档：</p>
<ul>
<li><strong>configuration（配置）</strong><ul>
<li><strong><a href="https://mybatis.org/mybatis-3/zh/configuration.html#properties">properties（属性）</a>：</strong>属性可以在外部进行配置，将配置信息写在另外的配置文件然后引入即可。或者可以定义全局变量，在<code>dataSource</code>中的<code>property</code>根据<code>name</code>使用<code>${}</code>获取即可。</li>
<li><strong><a href="https://mybatis.org/mybatis-3/zh/configuration.html#settings">settings（设置）</a>：</strong>可以设置缓存开启、执行器类型、驼峰命名映射、日志实现等功能。</li>
<li><strong><a href="https://mybatis.org/mybatis-3/zh/configuration.html#typeAliases">typeAliases（类型别名）</a>：</strong>为Java类型设置别名，仅用于XML文件，使用简短的类名代替全限类名，降低冗余书写。起别名的方式也有多种，可以为一个单独类起别名，可以给一个包起别名，也可以使用注解的方式给类起别名。</li>
<li><strong><a href="https://mybatis.org/mybatis-3/zh/configuration.html#typeHandlers">typeHandlers（类型处理器）</a></strong></li>
<li><strong><a href="https://mybatis.org/mybatis-3/zh/configuration.html#objectFactory">objectFactory（对象工厂）</a></strong></li>
<li><strong><a href="https://mybatis.org/mybatis-3/zh/configuration.html#plugins">plugins（插件）</a></strong></li>
<li><strong>environments（环境配置）：</strong>MyBatis可以配置多种环境，每个SqlSessionFactory实例只能选择一种环境。<ul>
<li>environment（环境变量）<ul>
<li>transactionManager（事务管理器）</li>
<li>dataSource（数据源）</li>
</ul>
</li>
</ul>
</li>
<li><strong><a href="https://mybatis.org/mybatis-3/zh/configuration.html#databaseIdProvider">databaseIdProvider（数据库厂商标识）</a></strong></li>
<li><strong><a href="https://mybatis.org/mybatis-3/zh/configuration.html#mappers">mappers（映射器）</a>：</strong>映射器的作用是告诉MyBatis去哪里找SQL语句执行，填写Mapper配置文件的地址。项目中每个Mapper配置文件都要在这里注册。有四种方式指定资源路径，其中<code>class</code>和<code>package</code>的方式要求配置文件和mapper接口要同名，package还要求配置文件和接口在同一个包下。</li>
</ul>
</li>
</ul>
<h3 id="2-2-3-获取SqlSession对象"><a href="#2-2-3-获取SqlSession对象" class="headerlink" title="2.2.3 获取SqlSession对象"></a>2.2.3 获取SqlSession对象</h3><p>使用MyBatis实现CRUD操作，主要是通过<code>SqlSession</code>对象进行的，其类似于传统JDBC中的数据库Connection对象。MyBatis中使用<strong>Mapper</strong>的概念替换了DAO的概念。</p>
<p>获取<code>SqlSession</code>对象的主要过程如下：</p>
<ul>
<li>通过<code>SqlSessionFactoryBuilder</code>对象获取<code>SqlSessionFactory</code>对象。（建造者模式）</li>
<li>通过<code>SqlSessionFactory</code>对象获取<code>SqlSession</code>对象。（工厂模式）</li>
<li>通过<code>SqlSession</code>对象生成相应的<code>Mapper</code>实现类对象。</li>
<li>通过<code>Mapper</code>实现类对象调用<code>Mapper</code>中的方法实现CRUD操作。</li>
</ul>
<p>在<code>java/com/kang/utils</code>路径下，创建<code>MybatisUtils</code>工具类，用户获取<code>SqlSession</code>对象：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.utils;<br><span class="hljs-keyword">import</span> org.apache.ibatis.io.Resources;<br><span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSession;<br><span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;<br><span class="hljs-keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.InputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MybatisUtils</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SqlSessionFactory sqlSessionFactory;<br>    <span class="hljs-keyword">static</span> {<br>        <span class="hljs-comment">//编译后的文件路径，即target/classes下的路径</span><br>        String resource = <span class="hljs-string">"mybatis-config.xml"</span>;<br>        InputStream inputStream = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            inputStream = Resources.getResourceAsStream(resource);<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        }<br>        <span class="hljs-comment">//获取sqlSessionFactory对象</span><br>        sqlSessionFactory = <span class="hljs-keyword">new</span> SqlSessionFactoryBuilder().build(inputStream);<br>    }<br>    <span class="hljs-comment">//根据sqlSessionFactory获取SqlSession对象</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> SqlSession <span class="hljs-title">getSqlSession</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-comment">//带参的openSession方法可以显式开启和关闭自动提交功能。</span><br>        <span class="hljs-comment">//MyBatis默认是关闭自动提交功能的，因此DML语句需要手动提交。</span><br>        <span class="hljs-keyword">return</span> sqlSessionFactory.openSession();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>关于SqlSessionFactoryBuilder、SqlSessionFactory、SqlSession对象的生命周期</strong></p>
<ul>
<li><code>SqlSessionFactoryBuilder</code>：一旦创建了 SqlSessionFactory，就不再需要SqlSessionFactoryBuilder了。 因此它的最佳作用域是<strong>方法作用域（也就是局部方法变量）</strong>。 可以重用 SqlSessionFactoryBuilder 来创建多个 SqlSessionFactory 实例，但最好还是不要一直保留着它，以保证所有的 XML 解析资源可以被释放给更重要的事情。</li>
<li><code>SqlSessionFactory</code>：SqlSessionFactory 一旦被创建就应该在<strong>应用的运行期间一直存在</strong>，没有任何理由丢弃它或重新创建另一个实例。 使用 SqlSessionFactory 的最佳实践是在应用运行期间不要重复创建多次，因此 SqlSessionFactory 的最佳作用域是<strong>应用作用域</strong>。 有很多方法可以做到，最简单的就是使用<strong>单例模式</strong>或者<strong>静态单例模式</strong>。</li>
<li><code>SqlSession</code>：每个线程都应该有自己的 SqlSession 实例。SqlSession 的实例不是线程安全的，因此是不能被共享的，所以它的<strong>最佳的作用域是请求或方法作用域</strong>。 绝对不能将 SqlSession 实例的引用放在一个类的静态域，甚至一个类的实例变量也不行。 也绝不能将 SqlSession 实例的引用放在任何类型的托管作用域中，比如 Servlet 框架中的 HttpSession。 如果现在正在使用一种 Web 框架，考虑将 SqlSession 放在一个和 HTTP 请求相似的作用域中。 换句话说，<strong>每次收到 HTTP 请求，就可以打开一个 SqlSession，返回一个响应后，就关闭它</strong>。 这个关闭操作很重要，为了确保每次都能执行关闭操作，应该把这个关闭操作放到 finally 块中。</li>
</ul>
<h3 id="2-2-4-编写Bean类和Mapper接口"><a href="#2-2-4-编写Bean类和Mapper接口" class="headerlink" title="2.2.4 编写Bean类和Mapper接口"></a>2.2.4 编写Bean类和Mapper接口</h3><p>创建<code>pojo</code>或<code>bean</code>目录，然后在其中创建JavaBean类，比如<code>User</code>类：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.pojo;<br><br><span class="hljs-comment">//定义id，name，pwd三个属性</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String pwd;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">()</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id, String name, String pwd)</span> </span>{<br>        <span class="hljs-keyword">this</span>.id = id;<br>        <span class="hljs-keyword">this</span>.name = name;<br>        <span class="hljs-keyword">this</span>.pwd = pwd;<br>    }<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getId</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> id;}<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setId</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>{<span class="hljs-keyword">this</span>.id = id;}<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> name;}<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>{<span class="hljs-keyword">this</span>.name = name;}<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPwd</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> pwd;}<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPwd</span><span class="hljs-params">(String pwd)</span> </span>{<span class="hljs-keyword">this</span>.pwd = pwd;}<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"User{"</span> +<br>            <span class="hljs-string">"id="</span> + id +<br>            <span class="hljs-string">", name='"</span> + name + <span class="hljs-string">'\''</span> +<br>            <span class="hljs-string">", pwd='"</span> + pwd + <span class="hljs-string">'\''</span> +<br>            <span class="hljs-string">'}'</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>创建<code>dao</code>目录，在其中编写<code>User</code>类对应的Mapper接口，定义一些操作。比如<code>UserMapper</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.dao;<br><span class="hljs-keyword">import</span> com.kang.pojo.User;<br><br><span class="hljs-keyword">import</span> java.util.List;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>{<br><br>    <span class="hljs-comment">// 查询全部用户</span><br>    <span class="hljs-function">List&lt;User&gt; <span class="hljs-title">getUserList</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">// 根据id查询用户</span><br>    <span class="hljs-function">User <span class="hljs-title">getUserById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br><br>    <span class="hljs-comment">//添加一个用户</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">addUser</span><span class="hljs-params">(User user)</span></span>;<br><br>    <span class="hljs-comment">// 更新用户信息</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(User user)</span></span>;<br><br>    <span class="hljs-comment">// 删除用户</span><br>    <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">deleteUser</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br>}<br><br></code></pre></td></tr></tbody></table></figure>
<h3 id="2-2-5-Mapper配置文件"><a href="#2-2-5-Mapper配置文件" class="headerlink" title="2.2.5 Mapper配置文件"></a>2.2.5 Mapper配置文件</h3><p>传统JDBC需要对每个DAO接口创建一个实现类，以供service层使用。在MyBatis中，对每个Mapper接口创建一个配置文件即可，甚至可以不需要Mapper映射文件，直接在Mapper接口中使用注解功能，执行相应的SQL语句。</p>
<p>这里先讨论Mapper映射文件的配置。</p>
<p>创建<code>UserMapper.xml</code>映射文件，内容如下：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="hljs-comment">&lt;!--namespace</span><br><span class="hljs-comment">命名空间，用于绑定一个对应的DAO/Mapper接口,这里和UserMapper绑定。</span><br><span class="hljs-comment">这样相当于写了一个实现类来实现此接口。</span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.kang.dao.UserMapper"</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserList"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>        select * from user<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- #{id}会被预编译成？号，只有一个参数时参数名称可以随便写 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserById"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>        select * from user where id=#{id}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>	<br>    <span class="hljs-comment">&lt;!--参数是类或者map时，参数名称必须和类中的属性名/map中的key相同--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"addUser"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>        insert into user(id,name,pwd) values(#{id},#{name},#{pwd})<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateUser"</span>  <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>        update user set name=#{name},pwd=#{pwd} where id=#{id}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">delete</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"deleteUser"</span>&gt;</span><br>        delete from user where id=#{id}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">delete</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>上述映射文件，实现了Mapper接口中每个方法的功能。每个映射文件，都需要写到MyBatis配置文件（即<code>mybatis-config.xml</code>）的<code>&lt;mapper&gt;</code>标签中进行绑定。</p>
<h3 id="2-2-6-执行CRUD语句"><a href="#2-2-6-执行CRUD语句" class="headerlink" title="2.2.6 执行CRUD语句"></a>2.2.6 执行CRUD语句</h3><p>在以上几步都完成以后，就可以编写代码实施具体的操作，主要步骤为：</p>
<ul>
<li>从工具类中获取<code>SqlSession</code>对象。</li>
<li>调用<code>SqlSession</code>类的getMapper()方法获取Mapper接口的一个实现类对象。</li>
<li>根据获取的Mapper实现类对象，调用具体的方法完成操作。</li>
<li>关闭SqlSession。</li>
</ul>
<p>以查询和添加用户为例</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 查询所有用户</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getUserList</span><span class="hljs-params">()</span> </span>{<br>    SqlSession sqlSession = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">// 1.获取SqlSession对象</span><br>        sqlSession = MybatisUtils.getSqlSession();<br>        <span class="hljs-comment">// 2.获取UserMapper接口实现类对象。</span><br>        UserMapper mapper = sqlSession.getMapper(UserMapper.class);<br>        <span class="hljs-comment">// 3.通过mapper调用方法完成功能</span><br>        List&lt;User&gt; userList = mapper.getUserList();<br>        <span class="hljs-keyword">for</span> (User user : userList) {<br>            System.out.println(user);<br>        }<br>    } <span class="hljs-keyword">catch</span> (Exception e) {<br>        e.printStackTrace();<br>    } <span class="hljs-keyword">finally</span> {<br>        <span class="hljs-comment">//关闭SqlSession</span><br>        <span class="hljs-keyword">if</span>(sqlSession != <span class="hljs-keyword">null</span>){<br>            sqlSession.close();<br>        }<br>    }<br>}<br><br><span class="hljs-comment">//添加一名用户</span><br><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addUser</span><span class="hljs-params">()</span> </span>{<br>    SqlSession sqlSession = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">try</span> {<br>        sqlSession = MybatisUtils.getSqlSession();<br>        UserMapper mapper = sqlSession.getMapper(UserMapper.class);<br>        mapper.addUser(<span class="hljs-keyword">new</span> User(<span class="hljs-number">1</span>, <span class="hljs-string">"test"</span>, <span class="hljs-string">"test"</span>));<br>        sqlSession.commit(); <span class="hljs-comment">//提交事务</span><br>    } <span class="hljs-keyword">catch</span> (Exception e) {<br>        e.printStackTrace();<br>    } <span class="hljs-keyword">finally</span> {<br>        <span class="hljs-keyword">if</span>(sqlSession != <span class="hljs-keyword">null</span>){<br>            sqlSession.close();<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，使用MyBatis进行CRUD的基本流程就大致完成了，下面讨论其中的详细配置和要注意的问题。</p>
<h1 id="三、XML映射文件"><a href="#三、XML映射文件" class="headerlink" title="三、XML映射文件"></a>三、XML映射文件</h1><p>Mapper映射文件中，一共有9个顶级元素，每个顶级元素有自己的参数配置，可以参考<a href="https://mybatis.org/mybatis-3/zh/sqlmap-xml.html#">官方文档-XML映射器</a></p>
<ul>
<li><code>cache</code> – 该命名空间的缓存配置。</li>
<li><code>cache-ref</code> – 引用其它命名空间的缓存配置。</li>
<li><code>resultMap</code> – 结果映射，描述如何从数据库结果集中加载对象，是最复杂也是最强大的元素。</li>
<li><code>parameterMap</code> – 参数映射。已被废弃，将来可能被移除，建议使用行内参数映射。</li>
<li><code>sql</code> – 可被其它语句引用的可重用语句块。类似于JSP中的common元素，在别的语句中通过include标签引入，提高代码可重用性。</li>
<li><code>insert</code> – 映射插入语句。</li>
<li><code>update</code> – 映射更新语句。</li>
<li><code>delete</code> – 映射删除语句。</li>
<li><code>select</code> – 映射查询语句。</li>
</ul>
<h2 id="3-1-一些参数说明"><a href="#3-1-一些参数说明" class="headerlink" title="3.1 一些参数说明"></a>3.1 一些参数说明</h2><p><code>select</code>元素的参数和<code>insert</code>/<code>update</code>/<code>delete</code>参数有区别。下面重点说明几个重要的参数。</p>
<ul>
<li><code>id</code>：命名空间中唯一的标识符，可以被用来引用这条语句，值为Mapper接口的方法名</li>
<li><code>resultType</code>：select元素特有。 期望从这条语句中返回结果的类全限定名或别名。 如果返回的是集合，那应该设置为集合包含的类型，而不是集合本身的类型。 resultType 和 resultMap 之间只能同时使用一个。</li>
<li><code>resultMap</code>：select元素特有。 对外部 resultMap 的命名引用。结果映射是 MyBatis 最强大的特性。</li>
<li><code>parameterType</code>：将会传入这条语句的参数的类全限定名或别名。这个属性是可选的，因为MyBatis 可以通过类型处理器（TypeHandler）推断出具体传入语句的参数，默认值为未设置（unset）。</li>
</ul>
<p><strong>关于parameterType的@Param</strong></p>
<p>参考自：<a href="http://www.mybatis.cn/archives/920.html">http://www.mybatis.cn/archives/920.html</a></p>
<p>1、简单类型不需要设置<code>parameterType</code>。</p>
<p>2、复杂的参数类型需要设置<code>parameterType</code>，比如传入一个对象时，需要使用，比如：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"insertUser"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"User"</span>&gt;</span><br>    insert into users (id, username, password)<br>    values (#{id}, #{username}, #{password})<br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>此时，User 类型的参数对象传递到了语句中，会查找 id、username 和 password 属性，然后将它们的值传入预处理语句的参数中。</p>
<p>此外，<code>parameterType</code>的值还可以使用<code>map</code>(这里是别名)传递，表示参数类型是<code>Map</code>，参数的名称为<code>Map</code>中的<code>key</code>：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectUsers"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"User"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"map"</span>&gt;</span><br>  select id, username, password<br>  from users<br>  where id = #{id} and age = #{age}<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>3、复杂类型也可以使用<code>@Param</code>的方式，此时不需要设置<code>parameterType</code>。</p>
<p>Mapper接口中：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">public List<span class="hljs-tag">&lt;<span class="hljs-name">Users</span>&gt;</span> getUsers(@Param("name") String name, @Param("age") int age);<br></code></pre></td></tr></tbody></table></figure>
<p>映射文件中的语句：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectUsers"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"User"</span>&gt;</span><br>    select id, username, password<br>    from users<br>    where id = #{id} and age = #{age}<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>使用<code>@Param</code>注解的方式，不需要设置参数类型，参数名称为注解定义的名称，这种方式只适用于参数较少的情况。</p>
<h2 id="3-2-结果映射"><a href="#3-2-结果映射" class="headerlink" title="3.2 结果映射"></a>3.2 结果映射</h2><p><code>resultMap</code>用于对结果集进行映射。其和<code>resultType</code>只能同时一个。简单情况下，可以直接使用<code>resultType="map"</code>实现简单的映射，比如：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserById"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"map"</span>&gt;</span><br>    select id, username, pwd<br>    from user<br>    where id = #{id}<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这种情况下，语句简单地将所有的列映射到 <code>HashMap</code> 的键上，这由 <code>resultType</code> 属性指定。虽然在大部分情况下都够用，但是 <code>HashMap</code> 并不是一个很好的领域模型。实际情况下更可能会使用 <code>JavaBean</code> 或<code>POJO</code>（Plain Old Java Objects）作为<code>resultType</code>，比如：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserById"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>    select id, username, pwd<br>    from user <br>    where id = #{id}<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>对于一些复杂情况，比如联表查询，或者属性名和表字段名不一致时，必须使用<code>resultMap</code>进行映射。</p>
<h3 id="3-2-1-使用resultMap解决列名和属性名不一致问题"><a href="#3-2-1-使用resultMap解决列名和属性名不一致问题" class="headerlink" title="3.2.1 使用resultMap解决列名和属性名不一致问题"></a>3.2.1 使用resultMap解决列名和属性名不一致问题</h3><p>对于<code>User</code>表，数据库中属性是<code>id</code>，<code>name</code>，<code>pwd</code>，而Javabean中属性为<code>id</code>，<code>name</code>，<code>password</code>。二者的密码属性名称不一致，会导致查出来结果为null。</p>
<p>其中一种解决方法是在SQL语句中给列名起别名，使其和属性名保持一致：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserById"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>    select id, username, pwd as password<br>    from user <br>    where id = #{id}<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>第二个方法是使用<code>resultMap</code>进行结果集映射：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getUserById"</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">"int"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"UserMap"</span>&gt;</span><br>    select id,name,pwd <br>    from user <br>    where id=#{id};<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"UserMap"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"pwd"</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"password"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>resultMap</code>中有两个重要的参数，主要用于多表查询：</p>
<ul>
<li><code>association</code>：一个复杂类型的<strong>关联</strong>；许多结果将包装成这种类型。用于<strong>一对一或多对一</strong>查询，查询结果是对于一个对象时使用。比如多个学生和同一个老师关联。</li>
<li><code>collection</code>：一个复杂类型的<strong>集合</strong>。用于<strong>一对多或多对多</strong>查询，查询结果是多个对象时使用。比如一个老师和多个不同的学生的关系，查询一个老师教的多个不同的学生，应该使用collection。</li>
</ul>
<p>其他标签和属性，比如：</p>
<ul>
<li><code>id</code>标签： 将一个列的值映射到一个简单数据类型的属性或字段。id元素对应的属性会被标记为对象的标识符，在比较对象实例时使用。 这样可以提高整体的性能，尤其是进行嵌套结果映射的时候。</li>
<li><code>result</code>标签：也是将一个列的值映射到一个简单数据类型的属性或字段。</li>
<li><code>column</code>属性：数据库中的列名，或者是列的别名。类似于<code>resultSet.getString(columnName)</code> 方法的参数。</li>
<li><code>property</code>属性：映射到列结果的Java类中的字段或属性。如果用来匹配的 JavaBean 存在给定名字的属性，那么它将会被使用。否则 MyBatis 将会寻找给定名称的字段。</li>
</ul>
<h3 id="3-2-2-N对1查询"><a href="#3-2-2-N对1查询" class="headerlink" title="3.2.2 N对1查询"></a>3.2.2 N对1查询</h3><p>如果多个表，例如两个表进行一对一或者多对一查询，就需要使用<code>resultMap</code>，具体来说是使用<code>resultMap</code>的<code>association</code> 。</p>
<p>比如，多个学生对应一个老师，类定义如下：</p>
<p><code>Student.java</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Teacher teacher;<br>    ...<span class="hljs-comment">//get，set方法等</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>StudentMapper</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">StudentMapper</span> </span>{<br>    <span class="hljs-comment">//查询所有的学生信息，以及对应的老师的信息</span><br>    <span class="hljs-comment">//这个表的所有学生对应一个老师，此时是多对一的关系</span><br>    <span class="hljs-function">List&lt;Student&gt; <span class="hljs-title">getStudent</span><span class="hljs-params">()</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>teacher.java</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Teacher</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    ...<span class="hljs-comment">//get，set方法等</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p>假设当前数据库中，所有的学生的老师都是同一位，即多对一的情况，有两种查询方式，第一种类似于子查询，第二种是结果嵌套（常用）。</p>
<p>查询语句如下：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--	多对一</span><br><span class="hljs-comment">    思路一：子查询</span><br><span class="hljs-comment">    1.查询所有的学生信息</span><br><span class="hljs-comment">    2.根据结果中的tid，查询老师信息</span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getStudent"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"StudentTeacher"</span>&gt;</span><br>    select * from student;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"StudentTeacher"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.kang.pojo.Student"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span>/&gt;</span><br><span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">association 关联</span><br><span class="hljs-comment">column表示调用该查询语句时传入的参数是什么</span><br><span class="hljs-comment">--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">association</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"teacher"</span> </span><br><span class="hljs-tag">                 <span class="hljs-attr">column</span>=<span class="hljs-string">"tid"</span> </span><br><span class="hljs-tag">                 <span class="hljs-attr">javaType</span>=<span class="hljs-string">"com.kang.pojo.Teacher"</span> </span><br><span class="hljs-tag">                 <span class="hljs-attr">select</span>=<span class="hljs-string">"getTeacherName"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getTeacherName"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.kang.pojo.Teacher"</span>&gt;</span><br>    select * from teacher where id=#{id};<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-comment">&lt;!--==========================================--&gt;</span><br><span class="hljs-comment">&lt;!-- 思路二：按照结果嵌套查询 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getStudent2"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"StudentTeacher2"</span>&gt;</span><br>    select s.id as sid,<br>    s.name as sname,<br>    t.id as tid,<br>    t.name as tname<br>    from student s,teacher t<br>    where s.tid=t.id;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"StudentTeacher2"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.kang.pojo.Student"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"sid"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"sname"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">association</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"teacher"</span> <span class="hljs-attr">javaType</span>=<span class="hljs-string">"com.kang.pojo.Teacher"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"tid"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"tname"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">association</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="3-2-3-N对多查询"><a href="#3-2-3-N对多查询" class="headerlink" title="3.2.3 N对多查询"></a>3.2.3 N对多查询</h3><p>一个老师对应多个学生，查询老师和其学生，就是一对多/多对多的问题。</p>
<p><code>Teacher.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Teacher</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> List&lt;Student&gt; students; <span class="hljs-comment">//一个老师教多名学生</span><br>    ...<span class="hljs-comment">//get，set方法等</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>TeacherMapper</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TeacherMapper</span> </span>{<br>    <span class="hljs-comment">//获取指定老师的信息及其教的所有学生信息</span><br>    <span class="hljs-function">Teacher <span class="hljs-title">getTeacherById</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>Student.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> tid;<br>    ...<span class="hljs-comment">//get，set方法等</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p>多对多和一对多的查询是相似地，都是使用collection，同样有两种方式：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getTeacherById"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"getTeacherStudent"</span>&gt;</span><br>    select t.id as tid,<br>    t.name as tname,<br>    s.id as sid,<br>    s.name as sname,<br>    s.tid as stid<br>    from student s, teacher t<br>    where t.id=#{id} and s.tid=t.id;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getTeacherStudent"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.kang.pojo.Teacher"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"tid"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"tname"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"students"</span> <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.kang.pojo.Student"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"sid"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"sname"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"tid"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"stid"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">collection</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 方式二：嵌套子查询</span><br><span class="hljs-comment">    1.先查询指定id的老师</span><br><span class="hljs-comment">    2.根据指定老师id查询所有符合条件的学生</span><br><span class="hljs-comment">    --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getTeacherById2"</span> <span class="hljs-attr">resultMap</span>=<span class="hljs-string">"getTeacherStudent2"</span>&gt;</span><br>    select * from teacher where id=#{id};<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">resultMap</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getTeacherStudent2"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"com.kang.pojo.Teacher"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">id</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">result</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">column</span>=<span class="hljs-string">"name"</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!--结果是一个List对象，集合中的元素是Student类--&gt;</span><br>    <span class="hljs-comment">&lt;!-- 这里的javaType可以省略 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">collection</span> <span class="hljs-attr">property</span>=<span class="hljs-string">"students"</span> </span><br><span class="hljs-tag">                <span class="hljs-attr">column</span>=<span class="hljs-string">"id"</span></span><br><span class="hljs-tag">                <span class="hljs-attr">javaType</span>=<span class="hljs-string">"List"</span> </span><br><span class="hljs-tag">                <span class="hljs-attr">ofType</span>=<span class="hljs-string">"com.kang.pojo.Student"</span></span><br><span class="hljs-tag">                <span class="hljs-attr">select</span>=<span class="hljs-string">"getStudentsByTid"</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">resultMap</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"getStudentsByTid"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.kang.pojo.Student"</span>&gt;</span><br>    select * from student where tid=#{tid};<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>注意到，在<code>association</code>和<code>collection</code>标签中，出现了<code>ofType</code>和<code>javaType</code>两种类型，二者都是用来指定对象类型的，区别如下：</p>
<ul>
<li><code>javaType</code>用来指定pojo类中属性的类型，如果<code>property</code>标签的值不是集合，就使用<code>javaType</code>。一般用于<code>association</code>标签中。<ul>
<li>比如N对一查询中，<code>Student</code>类中的<code>teacher</code>属性，只是一个对象，不是集合，类型是<code>Teacher</code>类，因此使用<code>javaType</code>，值为<code>com.kang.pojo.Teacher</code>。</li>
<li>在N对多的查询中，<code>Teacher</code>类中的<code>students</code>属性，是一个<code>List</code>类型，因此其值为<code>List</code>。</li>
</ul>
</li>
<li><code>ofType</code>用来指定集合中存储元素的类型。当<code>property</code>标签的值是集合的时候使用<code>ofType</code>，值为集合中元素的类型。<ul>
<li>比如在N对多查询中，<code>Teacher</code>类中的<code>students</code>属性，是一个<code>List</code>类型，<code>List</code>中的元素类型是<code>Student</code>类型，因此<code>ofType="com.kang.pojo.Student"</code>。</li>
</ul>
</li>
</ul>
<h1 id="四、注解"><a href="#四、注解" class="headerlink" title="四、注解"></a>四、注解</h1><h2 id="4-1-使用方法"><a href="#4-1-使用方法" class="headerlink" title="4.1 使用方法"></a>4.1 使用方法</h2><p>前面说过，MyBatis有两种方式实现SQL语句，可以通过XML映射文件实现SQL语句，也可以使用注解的方式，直接在Mapper接口的方法上用注解：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Select("select * from user where ${column} = #{value}")</span><br><span class="hljs-function">User <span class="hljs-title">findByColumn</span><span class="hljs-params">(<span class="hljs-meta">@Param("column")</span> String column, <span class="hljs-meta">@Param("value")</span> String value)</span></span>;<br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>@Param</code>为参数注解，指定参数的值应该对应到SQL语句中的哪个参数。</p>
<p>上述使用注解的方法不需要XML映射文件，使用时直接传入参数即可：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">User userOfId1 = userMapper.findByColumn(<span class="hljs-string">"id"</span>, <span class="hljs-number">1L</span>);<br>User userOfNameKid = userMapper.findByColumn(<span class="hljs-string">"name"</span>, <span class="hljs-string">"kid"</span>);<br>User userOfEmail = userMapper.findByColumn(<span class="hljs-string">"email"</span>, <span class="hljs-string">"noone@nowhere.com"</span>);<br></code></pre></td></tr></tbody></table></figure>
<p>其中 <code>${column}</code> 会被直接替换，而 <code>#{value}</code> 会使用 <code>?</code> 预处理，从而实现根据不同列查询。</p>
<p>但是使用<code>${}</code>存在SQL注入的问题。</p>
<p><strong>关于@Param注解</strong>：</p>
<p>其和<code>parameterType</code>的对比可以参考3.1节的内容。</p>
<p><code>@Param</code>注解的作用是给参数命名，命名后的参数可以根据名字将其值传入到SQL语句中，一般使用<code>#{}</code>的方式。</p>
<ul>
<li>如果方法有多个参数，如果使用参数注解，则每个参数都必须使用<code>@Param</code>注解。只有一个参数时可以不用写<code>@Param</code>注解，但建议加上。</li>
<li>SQL语句中参数<code>#{name}</code>取的就是<code>@Param{"name"}</code>中的<code>name</code>。</li>
</ul>
<p>在不使用<code>@Param</code>注解的时候，函数的参数只能为一个，并且在查询语句取值时只能用<code>#{}</code>。如果想传递多个参数，<code>parameterType</code>参数类型为<code>map</code>（此处为别名，对应类型为Map）或者为<code>JavaBean</code>类。</p>
<p>而使用<code>@Param</code>注解则可以使用多个参数，无需再设置<code>parameterType</code>，并且在查询语句中使用时可以使用<code>#{}</code>或者<code>${}</code>。</p>
<h2 id="4-2-和-的区别"><a href="#4-2-和-的区别" class="headerlink" title="4.2  ${} 和 #{}的区别"></a>4.2  <code>${}</code> 和 <code>#{}</code>的区别</h2><p><code>${}</code>和<code>#{}</code>是两种取变量的方式，二者的区别如下：</p>
<ul>
<li><code>${}</code>是 Properties 文件中的变量占位符，它可以用于标签属性值和 sql 内部，属于静态文本替换。<ul>
<li>比如<code>${driver}</code>会被静态替换为com.mysql.jdbc.Driver。</li>
<li>使用<code>${}</code>存在SQL注入的问题。</li>
</ul>
</li>
<li><code>#{}</code>是 sql 的参数占位符，MyBatis 会将 sql 中的<code>#{}</code>预编译为<code>?</code>号，在 sql 执行前会使用<code>PreparedStatement</code>的参数设置方法，按序给SQL语句的<code>?</code>号占位符设置参数值。<code>#{}</code>没有SQL注入的问题。</li>
</ul>
<h1 id="五、动态SQL"><a href="#五、动态SQL" class="headerlink" title="五、动态SQL"></a>五、动态SQL</h1><p>动态SQL能够根据不同的条件自动拼接SQL语句，MyBatis中借用OGNL（对象图导航语言）的表达式实现动态SQL。主要有以下四种元素：</p>
<ul>
<li><strong>if</strong></li>
<li><strong>choose ( when, otherwise )</strong></li>
<li><strong>trim ( where, set )</strong></li>
<li><strong>foreach</strong></li>
</ul>
<h2 id="5-1-if"><a href="#5-1-if" class="headerlink" title="5.1 if"></a>5.1 if</h2><p>使用<code>if</code>可以根据条件判断是否要添加条件：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"queryBlogIf"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"com.kang.pojo.Blog"</span>&gt;</span><br>    select * from blog where state = ‘ACTIVE’<br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"title != null"</span>&gt;</span><br>        and title like concat('%',#{title},'%')<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"author != null"</span>&gt;</span><br>        and author = #{author}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>根据传入的参数，判断是否满足对应的条件，如果满足条件，会将语句加上。</p>
<blockquote>
<p>这里的模糊查询，使用了concat函数，能够防止SQL注入。同时参数只需要传入value值即可，否则参数中还需要传入%。</p>
</blockquote>
<h2 id="5-2-choose、when、otherwise"><a href="#5-2-choose、when、otherwise" class="headerlink" title="5.2 choose、when、otherwise"></a>5.2 choose、when、otherwise</h2><p><code>if</code>条件只要满足，就会使用，如果只想使用一个条件，可以使用<code>choose</code>结构：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findActiveBlogLike"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Blog"</span>&gt;</span><br>    SELECT * FROM BLOG WHERE state = ‘ACTIVE’<br>    <span class="hljs-tag">&lt;<span class="hljs-name">choose</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"title != null"</span>&gt;</span><br>            AND title like #{title}<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">when</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">when</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"author != null"</span>&gt;</span><br>            AND author_name like #{author.name}<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">when</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">otherwise</span>&gt;</span><br>            AND featured = 1<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">otherwise</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">choose</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>choose</code>最多只会匹配一个条件，即使有多个条件满足，也只会从上到下匹配到最先满足条件的语句。</p>
<p><code>otherwise</code>表示如果所有的<code>when</code>条件没有一个满足的，则使用<code>otherwise</code>中的语句。</p>
<h2 id="5-3-trim、where、set"><a href="#5-3-trim、where、set" class="headerlink" title="5.3 trim、where、set"></a>5.3 trim、where、set</h2><p>以上条件的<code>where</code>是固定的，如果将<code>where</code>改为动态的，就需要考虑一个问题，即条件中的<code>and</code>什么时候添加，或者<code>where</code>改写在哪个条件中。</p>
<p>使用<code>where</code>可以完美解决这个问题：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"findActiveBlogLike"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">resultType</span>=<span class="hljs-string">"Blog"</span>&gt;</span><br>    SELECT * FROM BLOG<br>    <span class="hljs-tag">&lt;<span class="hljs-name">where</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"state != null"</span>&gt;</span><br>            state = #{state}<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"title != null"</span>&gt;</span><br>            AND title like #{title}<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"author != null and author.name != null"</span>&gt;</span><br>            AND author_name like #{author.name}<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">where</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>where</code> 元素只会在子元素返回任何内容的情况下才插入 “WHERE” 子句。而且，若子句的开头为 “AND” 或 “OR”，<code>where</code> 元素也会将它们去除。</p>
<p>同样地，<code>set</code>元素可以用于”INSERT”中动态插入：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"updateAuthorIfNecessary"</span>&gt;</span><br>    update Author<br>    <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"username != null"</span>&gt;</span>username=#{username},<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"password != null"</span>&gt;</span>password=#{password},<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"email != null"</span>&gt;</span>email=#{email},<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">"bio != null"</span>&gt;</span>bio=#{bio}<span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>    where id=#{id}<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>set</code>元素会动态地在行首插入”SET”关键字，并会删掉额外的逗号。</p>
<p><code>where</code>和<code>set</code>都可以看作是<code>trim</code>的特例。</p>
<p>其中上述的<code>where</code>用<code>trim</code>元素写为：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- AND和OR后面的空格要加上，保证SQL语句拼接正确 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"WHERE"</span> <span class="hljs-attr">prefixOverrides</span>=<span class="hljs-string">"AND |OR "</span>&gt;</span><br>    ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>prefixOverrides</code>属性会忽略通过管道符分隔的文本序列（空格是必要的）。上述例子会移除所有 <code>prefixOverrides</code>属性中指定的内容，并且插入 <code>prefix</code>属性中指定的内容。</p>
<p>上述的<code>set</code>用<code>trim</code>元素写为：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">trim</span> <span class="hljs-attr">prefix</span>=<span class="hljs-string">"SET"</span> <span class="hljs-attr">suffixOverrides</span>=<span class="hljs-string">","</span>&gt;</span><br>    ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">trim</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="5-4-foreach"><a href="#5-4-foreach" class="headerlink" title="5.4 foreach"></a>5.4 foreach</h2><p><code>foreach</code>用于对集合进行遍历，比如<code>IN</code>条件语句：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectPostIn"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"domain.blog.Post"</span>&gt;</span><br>    SELECT *<br>    FROM POST P<br>    WHERE ID in<br>    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">item</span>=<span class="hljs-string">"item"</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"index"</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">"list"</span></span><br><span class="hljs-tag">             <span class="hljs-attr">open</span>=<span class="hljs-string">"("</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">","</span> <span class="hljs-attr">close</span>=<span class="hljs-string">")"</span>&gt;</span><br>        #{item}<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>item</code>表示本次迭代的项，<code>index</code>表示索引，<code>collection</code>表示集合对象，这里为<code>list</code>，可以传入List、Map、SET等任何可迭代对象。</p>
<p>上述语句对应的SQL语句为：<code>SELECT * FROM POST P WHERE ID in (?,?,...,?)</code>，其中参数的个数为集合中项的个数。</p>
<h2 id="5-5-script"><a href="#5-5-script" class="headerlink" title="5.5 script"></a>5.5 script</h2><p>在带注解的映射器接口类中使用动态SQL，可以使用<code>script</code>元素，比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Update({"&lt;script&gt;",</span><br><span class="hljs-meta">         "update Author",</span><br><span class="hljs-meta">         "  &lt;set&gt;",</span><br><span class="hljs-meta">         "    &lt;if test='username != null'&gt;username=#{username},&lt;/if&gt;",</span><br><span class="hljs-meta">         "    &lt;if test='password != null'&gt;password=#{password},&lt;/if&gt;",</span><br><span class="hljs-meta">         "    &lt;if test='email != null'&gt;email=#{email},&lt;/if&gt;",</span><br><span class="hljs-meta">         "    &lt;if test='bio != null'&gt;bio=#{bio}&lt;/if&gt;",</span><br><span class="hljs-meta">         "  &lt;/set&gt;",</span><br><span class="hljs-meta">         "where id=#{id}",</span><br><span class="hljs-meta">         "&lt;/script&gt;"})</span><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateAuthorValues</span><span class="hljs-params">(Author author)</span></span>;<br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、MyBatis缓存"><a href="#六、MyBatis缓存" class="headerlink" title="六、MyBatis缓存"></a>六、MyBatis缓存</h1><p>MyBatis的缓存分为<strong>一级缓存(本地缓存)</strong>和<strong>二级缓存</strong>：</p>
<ul>
<li><strong>一级缓存</strong>：作用域为一个SqlSession域，即一次请求。默认开启。<strong>SqlSession关闭后，一级缓存的内容会存放到二级缓存</strong>。<ul>
<li>比如，同一个SqlSession中，对象中有一个HashMap存放缓存数据。第一次查询操作执行完毕后，会将查询到的数据写到缓存，第二次尝试从缓存中获取数据，如果能够命中，则没必要去查询数据库，可以提高效率。</li>
</ul>
</li>
<li><strong>二级缓存</strong>：作用域是整个<code>namespace</code>，即同一个命名空间的所有SqlSession共享二级缓存。默认关闭。<ul>
<li>如果两个SqlSession执行相同的查询操作，第二次会直接从二级缓存中获取数据，避免了从数据库中查询。</li>
</ul>
</li>
</ul>
<p><strong>查询缓存过程</strong>：第一次查询时，回去缓存中查找数据，如果没有，则查询数据库，然后将查询的数据放入一级缓存。之后的同一个SqlSession域（类似于同一个请求）中的相同查询能够命中缓存，从缓存中获取数据。当SqlSession关闭时，将一级缓存的内容放入二级缓存。</p>
<p>开启二级缓存，需要在MyBatis核心配置文件的<code>&lt;settings&gt;</code>元素中，设置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- </span><br><span class="hljs-comment">	全局性地开启或关闭所有映射器配置文件中已配置的任何缓存 </span><br><span class="hljs-comment">--&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cacheEnabled"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"true"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>然后在XML映射文件中加入：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- </span><br><span class="hljs-comment">	为当前Mapper开启二级缓存 </span><br><span class="hljs-comment">	参数都可以省略，使用默认值	</span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">eviction</span>=<span class="hljs-string">"FIFO"</span> <span class="hljs-attr">flushInterval</span>=<span class="hljs-string">"6000"</span> <span class="hljs-attr">size</span>=<span class="hljs-string">"512"</span> <span class="hljs-attr">readOnly</span>=<span class="hljs-string">"true"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>也可以单独为某个方法开启是否使用缓存。</p>
<p>开启二级缓存后，还需要将要缓存的pojo实现Serializable接口，为了将缓存数据取出执行反序列化操作，因为二级缓存数据存储介质多种多样，不一定只存在内存中，有可能存在硬盘中。</p>
<p>二级缓存可用的清除策略有：</p>
<ul>
<li><code>LRU</code> – 最近最少使用：移除最长时间不被使用的对象。（默认策略）</li>
<li><code>FIFO</code> – 先进先出：按对象进入缓存的顺序来移除它们。</li>
<li><code>SOFT</code> – 软引用：基于垃圾回收器状态和软引用规则移除对象。</li>
<li><code>WEAK</code> – 弱引用：更积极地基于垃圾收集器状态和弱引用规则移除对象。</li>
</ul>
<p> <code>insert/delete/update</code> 语句的<code>flushCache</code>参数默认为<code>true</code>，意味着这几种语句会自动刷新缓存。</p>
<blockquote>
<p>二级缓存是事务性的。这意味着，当 SqlSession 完成并提交时，或是完成并回滚，但没有执行DML语句时，缓存也会获得更新。</p>
</blockquote>
<h1 id="七、日志"><a href="#七、日志" class="headerlink" title="七、日志"></a>七、日志</h1><p>Mybatis 通过使用内置的日志工厂提供日志功能。内置日志工厂将会把日志工作委托给下面的实现之一：</p>
<ul>
<li>SLF4J</li>
<li>Apache Commons Logging</li>
<li>Log4j 2</li>
<li>Log4j</li>
<li>JDK logging</li>
</ul>
<p>MyBatis 内置日志工厂会基于运行时检测信息选择日志委托实现。它会（按上面罗列的顺序）使用第一个查找到的实现。当没有找到这些实现时，将会禁用日志功能。</p>
<p>可以在MyBatis核心配置文件的<code>&lt;settings&gt;</code>元素中，开启日志工厂，比如log4j：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--日志工厂实现--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"logImpl"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"LOG4J"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>使用log4j的前提是需要导入其jar包，在Maven配置文件中导入log4j的依赖。</p>
<p>使用log4j需要使用配置文件，在<code>resources</code>文件夹中创建<code>log4j.preperties</code>配置文件，配置log4j的具体信息。可以参考log4j官方文档：<a href="https://logging.apache.org/log4j/2.x/javadoc.html">https://logging.apache.org/log4j/2.x/javadoc.html</a></p>
<p>一个可供参考的log4j配置文件：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># Loggers :日志记录器，控制日志的输出级别和日志是否输出</span><br><span class="hljs-comment"># Appenders：输出端，指定日志的输出方式（比如到控制台、文件、远程服务器、数据库等）</span><br><span class="hljs-comment"># Layout：控制日志信息的输出格式</span><br><span class="hljs-comment">#   日志级别：</span><br><span class="hljs-comment">#   OFF	    最高日志级别，关闭所有日志</span><br><span class="hljs-comment">#   FATAL	将会导致应用程序退出的错误</span><br><span class="hljs-comment">#   ERROR	发生错误事件，但仍不影响系统的继续运行</span><br><span class="hljs-comment">#   WARN	警告，即潜在的错误情形</span><br><span class="hljs-comment">#   INFO	一般用于粗粒度级别上，强调应用程序的运行全程</span><br><span class="hljs-comment">#   DEBUG	一般用于细粒度级别上，对调试应用程序非常有帮助</span><br><span class="hljs-comment">#   ALL	    最低等级，打开所有日志记录</span><br><span class="hljs-comment"># 常用Error、Warn、INFO、Debug四种</span><br><br><span class="hljs-comment">### 根设置###</span><br><span class="hljs-comment"># 用于设置制定级别以上的日志输出到指定输出端,名字和个数可以任意，但是需要和后面的设置对应。</span><br><span class="hljs-comment"># 输出DEBUG级别以上的日志到控制台和文件</span><br><span class="hljs-meta">log4j.rootLogger</span>=<span class="hljs-string">DEBUG,console,file</span><br><br><span class="hljs-comment">### 输出到控制台的相关设置 ###</span><br><span class="hljs-comment"># 调用ConcoleAppender类，输出到控制台</span><br><span class="hljs-meta">log4j.appender.console</span>=<span class="hljs-string">org.apache.log4j.ConsoleAppender</span><br><span class="hljs-comment"># 默认值是System.out</span><br><span class="hljs-meta">log4j.appender.console.Target</span>=<span class="hljs-string">System.out</span><br><span class="hljs-comment"># 指定日志的最低输出级别，默认是DEBUG</span><br><span class="hljs-meta">log4j.appender.console.Threshold</span>=<span class="hljs-string">DEBUG</span><br><span class="hljs-meta">log4j.appender.console.layout</span>=<span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-meta">log4j.appender.console.layout.ConversionPattern</span>=<span class="hljs-string">[%c]-%m%n</span><br><br><span class="hljs-comment">### 输出到文件的相关设置 ###</span><br><span class="hljs-comment"># 调用RollingFileAppender，文件大小到达指定尺寸的时候产生一个新文件</span><br><span class="hljs-meta">log4j.appender.file</span>=<span class="hljs-string">org.apache.log4j.RollingFileAppender</span><br><span class="hljs-comment"># 输出到指定文件</span><br><span class="hljs-meta">log4j.appender.file.File</span>=<span class="hljs-string">./log/kang.log</span><br><span class="hljs-comment"># 默认为true，表示添加到末尾，如果是false则表示覆盖</span><br><span class="hljs-meta">log4j.appender.file.Append</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"># 设置单个日志文件大小。KB、MB、GB</span><br><span class="hljs-meta">log4j.appender.file.MaxFileSize</span>=<span class="hljs-string">10MB</span><br><span class="hljs-meta">log4j.appender.file.Threshold</span>=<span class="hljs-string">DEBUG</span><br><span class="hljs-comment"># PatternLayout，灵活指定布局模式</span><br><span class="hljs-meta">log4j.appender.file.layout</span>=<span class="hljs-string">org.apache.log4j.PatternLayout</span><br><span class="hljs-meta">log4j.appender.file.layout.ConversionPattern</span>=<span class="hljs-string">[%p][%d{yy-MM-dd}][%c]%m%n</span><br><br><span class="hljs-comment">### 日志输出级别 ###</span><br><span class="hljs-meta">log4j.logger.org.mybatis</span>=<span class="hljs-string">DEBUG</span><br><span class="hljs-meta">log4j.logger.java.sql</span>=<span class="hljs-string">DEBUG</span><br><span class="hljs-meta">log4j.logger.java.sql.Statement</span>=<span class="hljs-string">DEBUG</span><br><span class="hljs-meta">log4j.logger.java.sql.ResultSet</span>=<span class="hljs-string">DEBUG</span><br><span class="hljs-meta">log4j.logger.java.sql.PreparedStatement</span>=<span class="hljs-string">DEBUG</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="八、其他问题"><a href="#八、其他问题" class="headerlink" title="八、其他问题"></a>八、其他问题</h1><p>参考<a href="https://snailclimb.gitee.io/javaguide/#/docs/system-design/framework/mybatis/mybatis-interview">JavaGuide</a></p>
]]></content>
      <categories>
        <category>SSM框架</category>
      </categories>
      <tags>
        <tag>MyBatis</tag>
        <tag>SSM</tag>
        <tag>数据库</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMVC总结</title>
    <url>/2021/07/03/spring-mvc/</url>
    <content><![CDATA[<h1 id="一、SpringMVC介绍"><a href="#一、SpringMVC介绍" class="headerlink" title="一、SpringMVC介绍"></a>一、SpringMVC介绍</h1><h2 id="1-1-MVC"><a href="#1-1-MVC" class="headerlink" title="1.1 MVC"></a>1.1 MVC</h2><p>传统的三层架构：</p>
<ul>
<li><p>View：视图层，用于接收用户提交请求代码。</p>
</li>
<li><p>Service：服务层，主要是系统的业务逻辑代码。</p>
</li>
<li><p>Dao：持久层，直接操作数据库的代码。</p>
</li>
</ul>
<p>MVC，即</p>
<ul>
<li>View：视图，主要负责显示数据和提交数据。比如JSP，HTML页面</li>
<li>Model：模型，承载数据，并对用户提交请求进行计算的模块。包括数据承载（<strong>bean</strong>）和业务处理（<strong>service</strong>、<strong>dao</strong>）两部分。</li>
<li>Controller：控制器，用于将用户请求转发给相应的Model进行处理，并处理Model的计算结果向用户提供响应。 </li>
</ul>
<blockquote>
<p>MVC也演化出了其他的模式，比如MVP、MVVM等。</p>
</blockquote>
<p>MVC架构的工作流程大致如下：</p>
<ul>
<li>用户通过View页面向服务端发起请求。</li>
<li>服务端Controller控制器接受请求并进行解析，找到相应的Model对用户请求进行处理。</li>
<li>Model处理后，将处理结果交给Controller。</li>
<li>Controller接到结果以后发给View，将渲染后的页面响应给用户。</li>
</ul>
<p>没有SpringMVC之前的web应用主要经历了两个阶段：</p>
<ul>
<li><strong>Model1时代</strong>：主要有视图层和模型层，JSP将控制逻辑和表现逻辑混杂在一起，职责过重，不便于维护。</li>
<li><strong>Model2时代</strong>：项目分为模型（bean，dao)、视图（JSP）、控制（Servlet）三部分，但这种模式的抽象和封装程度远远不够，因此有了Struts、SpringMVC等MVC框架。</li>
</ul>
<h2 id="1-2-SpringMVC"><a href="#1-2-SpringMVC" class="headerlink" title="1.2 SpringMVC"></a>1.2 SpringMVC</h2><p><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/web.html#mvc">Spring MVC</a>是Spring Framework的一部分，是基于Java实现MVC的轻量级Web框架。</p>
<p>SpringMVC功能强大，支持RESTful、数据验证、本地化、国际化、拦截器等功能。</p>
<p>SpringMVC中的<code>DispatcherServlet</code>用于控制所有请求，将请求分发到不同的处理器，而传统的项目中每个servlet只能处理一个请求。</p>
<h1 id="二、SpringMVC的工作原理"><a href="#二、SpringMVC的工作原理" class="headerlink" title="二、SpringMVC的工作原理"></a>二、SpringMVC的工作原理</h1><p>SpringMVC主要是以<code>DispatcherServlet</code>（前端控制器、请求分发器）为核心。这个类继承于<code>HttpServlet</code>类，本质上是一个<code>servlet</code>。</p>
<p>SpringMVC的主要工作流程如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/sprint-mvc_1.png"><span class="image-caption">SpringMVC工作原理</span></p>
<p>1、用户发送请求，请求会被 <code>DispatcherServlet</code>接收。</p>
<p>2、<code>DispatcherServlet</code> 根据请求信息，调用 <code>HandlerMapping</code>来解析请求对应的 <code>Handler</code>。</p>
<p>3、解析到对应的 <code>Handler</code>（也叫做 <code>Controller</code> 控制器）后，交给由 <code>HandlerAdapter</code> 适配器处理。</p>
<p>4、<code>HandlerAdapter</code> 会根据 <code>Handler</code>来调用真正的处理器来处理请求，并处理相应的业务逻辑。</p>
<p>5、处理器处理完业务后，会返回一个 <code>ModelAndView</code> 对象，<code>Model</code> 是返回的数据对象，<code>View</code> 是个逻辑上的视图（字符串表示的视图逻辑名，比如JSP页面名）。</p>
<blockquote>
<p><code>ModelAndView</code>对象包括了<code>ModelMap</code>和<code>view</code>两个属性，<code>ModelMap</code>用于保存数据，比如请求查询得到的结果对象，<code>view</code>用于保存逻辑视图名。</p>
</blockquote>
<p>6、<code>DispatcherServlet</code> 将逻辑<code>View</code>传递给<code>ViewResolver</code> 视图解析器，它会根据 逻辑<code>View</code> 查找实际的 <code>View</code>(即根据名称找到真正的页面)并创建视图，返回给<code>DispatcherServlet</code> 。</p>
<blockquote>
<p>视图解析器根据设置好的前缀路径和后缀名，进行拼接，确定视图的位置，然后创建<code>View</code>接口的实现类对象，也就是视图对象，将其返回给请求分发器。</p>
</blockquote>
<p>7、<code>DispaterServlet</code> 把视图解析器返回的 <code>View</code> 进行视图渲染，并将模型数据填充到<code>request</code>域。</p>
<blockquote>
<p>视图就是html、jsp等页面。在底层源码中视图渲染会将<code>Model</code>里面的键值对数据全部写到<code>requestScope</code>中（前端可以通过EL表达式从域对象中获取数据），然后进行<strong>请求转发</strong>到指定的页面，最后将这个页面相应给用户。</p>
<p><strong>也就是说，<code>ModelAndView</code>中的数据对象会被放在请求域中。</strong></p>
</blockquote>
<p>8、最后，<code>DispaterServlet</code> 向用户响应结果。</p>
<blockquote>
<p>将响应数据放到<code>Response</code>中返回给用户。</p>
</blockquote>
<h1 id="三、SpringMVC的使用"><a href="#三、SpringMVC的使用" class="headerlink" title="三、SpringMVC的使用"></a>三、SpringMVC的使用</h1><p>使用SpringMVC创建web项目，需要一个<code>springmvc-servlet.xml</code>配置文件用来配置处理器映射器、处理器适配器和视图解析器。然后在<code>web.xml</code>文件中配置请求分发器。</p>
<p>使用Maven框架，可以使用IDEA的Web模版创建web项目；</p>
<p>也可以先创建普通Maven模块，然后右键<code>Add Framework Support</code>，添加Web框架支持。这种方式创建web项目，需要在<code>Project Structure</code>-&gt;<code>Artifacts</code>中，在<code>WEB-INF</code>目录中创建<code>lib</code>文件夹，然后将用到的所有jar包添加进去。如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/spring-mvc_3.png"><span class="image-caption">在项目发布目录手动添加jar包</span></p>
<p>创建完项目以后，基本的目录结构如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/sprint-mvc_2.png"><span class="image-caption">SpringMVC项目的基础目录</span></p>
<p><code>DispatcherServlet</code>是SpringMVC的核心，其实现方式有两种，分别是<strong>实现Controller接口</strong>和<strong>使用<code>@Controller</code>注解</strong>。</p>
<p>无论是哪种方式，<code>web.xml</code>配置文件都是一样的，在其中需要配置请求分发器（前端控制器）。</p>
<p><code>web.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">"4.0"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 配置dispatcherServlet --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>springmvc<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-class</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 通过初始化参数，指定关联的Spring的xml文件位置 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>contextConfigLocation<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>classpath:springmvc-servlet.xml<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 设置启动级别 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">load-on-startup</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">load-on-startup</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 设置匹配的请求 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">servlet-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">servlet-name</span>&gt;</span>springmvc<span class="hljs-tag">&lt;/<span class="hljs-name">servlet-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">servlet-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中的配置说明：</p>
<ul>
<li><code>contextConfigLocation</code>表示装入配置文件，这个路径应该是Spring的总配置文件。如果不指定，默认加载<code>/WEB-INF/applicationContext.xml</code>，如果想自定义名称，则需要指定路径。</li>
<li><p><code>load-on-startup</code>：用于标记容器是否应该在web应用程序启动的时候就加载这个servlet（实例化并调用init()方法）。值必须是整数，表示servlet被加载的顺序。如果值为负数或者没有设置，则当这个servlet被请求时再加载。如果值为0或正整数，表示容器启动时就加载这个servlet，数值越小优先级越高，数值相同时按照声明顺序加载。</p>
</li>
<li><p><code>/</code>：匹配所有的请求，但不会匹配JSP、HTML等静态资源。</p>
</li>
<li><p><code>/*</code>:匹配所有的请求，包括静态资源。这里不能使用<code>/*</code>，因为如果把JSP页面当作请求的话，如果视图解析器的后缀也是JSP，会陷入无限请求中导致请求失败。</p>
</li>
</ul>
<h2 id="3-1-方式一：实现Controller接口"><a href="#3-1-方式一：实现Controller接口" class="headerlink" title="3.1 方式一：实现Controller接口"></a>3.1 方式一：实现Controller接口</h2><p>其中实现接口的方式需要在Spring配置文件中注册bean，为了能够使映射器根据名字找到对应的<code>Handler</code>。</p>
<p><strong>1、配置<code>springmvc-servlet.xml</code>文件</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 映射器和适配器都是默认的，不注册也可以正常使用，这里为了流程清晰将其显式写出来 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- 配置处理器映射器 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.web.servlet.handler.BeanNameUrlHandlerMapping"</span>/&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 配置处理器适配器 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter"</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 配置视图解析器（必须），根据接收的视图名找到视图的真实位置并返回视图 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span></span><br><span class="hljs-tag">          <span class="hljs-attr">id</span>=<span class="hljs-string">"internalResourceViewResolver"</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 前缀 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"prefix"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/WEB-INF/jsp/"</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!-- 后缀 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"suffix"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">".jsp"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- BeanNameUrlHandlerMapping映射器会根据bean名字，找到对应的handler --&gt;</span><br>    <span class="hljs-comment">&lt;!-- 注册 Handler，当请求为test的时候，就会执行HelloController --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"/test"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.controller.HelloController"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>说明</strong>：</p>
<ul>
<li><code>Controller</code>的<code>id</code>必须加<code>/</code></li>
<li>视图解析器根据视图名，加上前缀和后缀定位视图。</li>
<li>这里的映射器和适配器都是默认的，不注册也可以正常使用，这里为了便于理解，将其显式写出来。</li>
</ul>
<p><strong>2、创建控制器类，实现<code>Controller</code>接口</strong>，在<code>java/com/kang/controller</code>目录下创建控制器类。</p>
<p><code>HelloController</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.controller;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Controller</span> </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">handleRequest</span><span class="hljs-params">(HttpServletRequest httpServletRequest,</span></span><br><span class="hljs-function"><span class="hljs-params">                                      HttpServletResponse httpServletResponse)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> Exception </span>{<br>        ModelAndView mv = <span class="hljs-keyword">new</span> ModelAndView();<br>        <span class="hljs-comment">//Controller，需要返回一个ModelAndView对象</span><br>        <span class="hljs-comment">//1、编写业务代码</span><br>        String result = <span class="hljs-string">"HelloSpringMVC"</span>;<br>        mv.addObject(<span class="hljs-string">"msg"</span>,result); <span class="hljs-comment">//将结果写到msg属性中</span><br>        <span class="hljs-comment">//2、视图跳转，指定要跳转的jsp页面名字</span><br>        mv.setViewName(<span class="hljs-string">"test"</span>); <br>        <span class="hljs-keyword">return</span> mv;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>mv.addObject("msg",result);</code>表示添加数据到<code>ModelAndView</code>对象，这个数据最终会被请求转发器添加到<code>requestScope</code>中。在前端页面就可以使用EL表达式从<code>requstScope</code>中取到数据：<code>${requestScope.msg}</code></p>
<p><code>mv.setViewName("test");</code>用于指定要请求转发的视图名字。</p>
<p>这个<code>ModelAndView</code>对象返回给请求分发器，然后经过视图解析器解析、视图渲染等步骤，最终将带有数据的视图写入<code>response</code>中响应给用户。</p>
<h2 id="3-2-方式二：使用-Controller注解"><a href="#3-2-方式二：使用-Controller注解" class="headerlink" title="3.2 方式二：使用@Controller注解"></a>3.2 方式二：使用@Controller注解</h2><p>使用注解不需要显式注册bean，而是在类中使用<code>@Controller</code>注解，自动将当前类注册为控制器类。</p>
<blockquote>
<p><code>@Controller</code>效果和<code>@Component</code>注解类似，都表示将当前类交给Spring托管。</p>
<p>与之类似的还有<code>@Service</code>用于service层，<code>@Repository</code>用于dao层。</p>
</blockquote>
<p>被<code>@Controller</code>注解的类中的所有方法（公有私有都包括），如果返回值是<code>String</code>，并且有具体的页面与之对应，就会被视图解析器解析。</p>
<blockquote>
<p>如果想要方法的返回值不被视图解析器解析，可以使用在方法上使用<code>@ResponseBody</code>注解，表示当前方法的返回值直接写入到HTTP响应（response）体中，一般返回的是JSON或XML形式的数据，是前后端分离情况下常用的情况。详情参见下文JSON章节</p>
</blockquote>
<p>使用注解时，配置文件和控制类的内容和方式一不同。</p>
<p><strong>1、配置<code>spring-mvc.xml</code>文件</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:mvc</span>=<span class="hljs-string">"http://www.springframework.org/schema/mvc"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/context</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/context/spring</span></span><br><span class="hljs-tag"><span class="hljs-string">                           context.xsd http://www.springframework.org/schema/mvc</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/mvc/spring-mvc.xsd"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">"com.kuang.controller"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:default-servlet-handler</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:annotation-driven</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!--视图解析器--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span></span><br><span class="hljs-tag">          <span class="hljs-attr">id</span>=<span class="hljs-string">"internalResourceViewResolver"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"prefix"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"/WEB-INF/jsp/"</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"suffix"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">".jsp"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>参数说明</strong>：</p>
<p><code>&lt;context:component-scan&gt;</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs plain">表示自动扫描包，让指定包下的注解生效，由IOC容器统一管理 <br></code></pre></td></tr></tbody></table></figure>
<p><code>&lt;mvc:default-servlet-handler/&gt;</code></p>
<figure class="highlight css"><table><tbody><tr><td class="code"><pre><code class="hljs css">用于过滤静态资源，让<span class="hljs-selector-tag">SpringMVC</span>不处理静态资源，比如<span class="hljs-selector-class">.txt</span>、<span class="hljs-selector-class">.mp3</span>、<span class="hljs-selector-class">.jpg</span>等。<br>配置这个处理器后，会在<span class="hljs-selector-tag">Spring</span> <span class="hljs-selector-tag">MVC</span>上下文中定义一个<span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.servlet</span><span class="hljs-selector-class">.resource</span><span class="hljs-selector-class">.DefaultServletHttpRequestHandler</span>，<br>它像一个检查员，对进入<span class="hljs-selector-tag">DispatcherServlet</span>的<span class="hljs-selector-tag">URL</span>进行筛查，<br>如果发现是静态资源的请求，就将该请求转由<span class="hljs-selector-tag">Web</span>应用服务器默认的<span class="hljs-selector-tag">Servlet</span>处理；<br>如果不是静态资源的请求，才由<span class="hljs-selector-tag">DispatcherServlet</span>继续处理。<br></code></pre></td></tr></tbody></table></figure>
<p><code>&lt;mvc:annotation-driven/&gt;</code></p>
<figure class="highlight crystal"><table><tbody><tr><td class="code"><pre><code class="hljs crystal">用于配置注解驱动。<br>一方面：<br>在spring中一般采用@RequestMapping注解来完成映射关系<br>要想使@RequestMapping注解生效，<br>必须向上下文中注册DefaultAnnotationHandlerMapping<br>和一个AnnotationMethodHandlerAdapter实例，<br>这两个实例分别在类级别和方法级别处理。<br><span class="hljs-keyword">annotation</span>-<span class="hljs-title">driven</span>配置帮助我们自动完成上述两个实例的注入。<br><br>另一方面：<br>基础bean只能提供最基础的服务，其它的扩展功能，比如JSON、XML、Valid等等，<br>根据classpath有没有相关的依赖来决定要不要添加对应的bean或者属性，<br><span class="hljs-keyword">annotation</span>-<span class="hljs-title">driven</span>的作用就是提供扩展功能。<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、创建Controller类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/hello1")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">myController</span><span class="hljs-params">(Model model)</span></span>{<br>        model.addAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"hello,MVC-Annocation"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>; <br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>我们自定义方法的返回值是视图名，相当于在Spring的XML文件中配置了<code>id</code>为<code>hello</code>的bean，用于映射器查找到对应的控制器。在方法中可以使用<code>Model</code>对象、<code>ModelMap</code>对象、<code>ModelAndView</code>对象三种方式向<strong>请求域</strong>中传递数据，也就是向前端页面传递数据，具体使用方法见下文。</p>
<p><strong>注解说明：</strong></p>
<p><code>@Controller</code>：将当前类注册为Controller，类似于实现Controller接口。</p>
<p><code>@RequestMapping</code>：表示映射<code>hello</code>请求到这个方法，也就是说当请求为<code>hello</code>时，会执行这个被其注解的方法。也可以用在类中，表示当前类中的每个方法的共同请求前缀，比如下面的案例，只有当请求为<code>/test/hello</code>时才会执行<code>myController</code>方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//表示类中每个方法的请求前都要加路径/test</span><br><span class="hljs-meta">@RequestMapping("/test")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/hello")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">myController</span><span class="hljs-params">()</span></span>{}<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>@RequestMapping</code>默认为任何请求方式，也可以在参数中指定请求方式，比如设置为<code>POST</code>请求方式：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = "/hello",method = RequestMethod.POST)</span><br></code></pre></td></tr></tbody></table></figure>
<p>HTTP的几种请求方式参考<a href="https://kangshitao.github.io/2021/05/19/computer-network-review/#HTTP%E6%96%B9%E6%B3%95">HTTP请求方法</a></p>
<p>对于具体的请求方式，还可以使用其对于的注解，比如<code>@GetMapping</code>、<code>@PostMapping</code></p>
<p><code>@PutMapping</code>、<code>@DeleteMapping</code>等，其作用和<code>@RequestMapping</code>相同，不过是固定了具体的请求方式。</p>
<h1 id="四、SpringMVC的结果跳转"><a href="#四、SpringMVC的结果跳转" class="headerlink" title="四、SpringMVC的结果跳转"></a>四、SpringMVC的结果跳转</h1><p>使用<code>@Controller</code>方式的控制器，页面跳转可以使用视图解析器，也可以不使用视图解析器。</p>
<p><strong>1.使用视图解析器</strong></p>
<p>使用视图解析器的时候，只需要返回视图名字即可，或者返回带有视图名字属性的<code>ModelAndView</code>对象。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//方式一：直接返回视图名给视图解析器</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Controller</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/hello")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">myController</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//1.做一些数据处理</span><br>        <span class="hljs-comment">//2.返回视图名</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"test"</span>;<br>    }<br>}<br><span class="hljs-comment">//方式二：使用ModelAndView设置视图名</span><br><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Controller</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/hello")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">myController</span><span class="hljs-params">()</span></span>{<br>        ModelAndView mv = <span class="hljs-keyword">new</span> ModelAndView();<br>        <span class="hljs-comment">//1.做一些数据处理</span><br>        <span class="hljs-comment">//2.设置要跳转的视图名，并返回此对象</span><br>        mv.setViewName(<span class="hljs-string">"test"</span>);<br>        <span class="hljs-keyword">return</span> mv;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>以上两种方式都是使用视图解析器时的写法，都是将视图名传递给视图解析器。前提是SpringMVC的配置文件中注册了视图解析器。</p>
<p><strong>2.直接返回</strong></p>
<p>如果不使用视图解析器，也可以直接将视图返回。由于没有视图解析器的路径拼接，所以方法的返回值应该是真实不需要拼接的视图地址。</p>
<p>如果不指定前缀，默认表示请求转发。</p>
<blockquote>
<p>不指定forward或redirect，则必须保证视图解析器关闭或注释掉，否则视图解析器仍会拼接结果。</p>
</blockquote>
<p>如果指定了前缀，则会按照指定的方式转发或重定向，并且不会经过视图解析器（即使开启了视图解析器）。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelTest</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/test2")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String  <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//return "/WEB-INF/jsp/hello.jsp";  //请求转发</span><br>        <span class="hljs-comment">//return "forward:/WEB-INF/jsp/hello.jsp"; //请求转发</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/index.jsp"</span>; <span class="hljs-comment">//重定向,重定向的页面需要确保能够通过url访问</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这里要注意的是，如果是重定向，因为重定向是客户端重新发起请求，因此必须保证此页面可以通过URL直接访问。</p>
<p><strong>3.使用ServletAPI</strong></p>
<p>使用<code>HttpServletRequest</code>进行请求转发或者<code>HttpServletResponse</code>进行重定向。不需要视图解析器.</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelTest1</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/test3")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">(HttpServletRequest request, </span></span><br><span class="hljs-function"><span class="hljs-params">                     HttpServletResponse response)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> ServletException, IOException </span>{<br>        request.setAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"ModelTest1"</span>);<br>        request.getRequestDispatcher(<span class="hljs-string">"/WEB-INF/jsp/hello.jsp"</span>).<br>            forward(request,response);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>可以使用<code>ServletAPI</code>进行手动请求转发或者重定向，同样不需要视图解析器。</p>
<h1 id="五、SpringMVC中的数据处理"><a href="#五、SpringMVC中的数据处理" class="headerlink" title="五、SpringMVC中的数据处理"></a>五、SpringMVC中的数据处理</h1><p>SpringMVC中的数据处理主要是两方面，一个是后端如何接收前端传来的数据，第二个是后端如何向前端传递数据。</p>
<blockquote>
<p>在前端页面中，我们可以使用EL表达式从域对象中取出数据；通过表单等方式提交数据。</p>
</blockquote>
<h2 id="5-1-控制器接收数据"><a href="#5-1-控制器接收数据" class="headerlink" title="5.1 控制器接收数据"></a>5.1 控制器接收数据</h2><p>控制器对于前端传来的数据可以直接通过参数进行接收。可以分为以下三种情况。</p>
<p>以下案例以GET请求方式为例</p>
<p><strong>1、传递的参数名和方法的参数名一致</strong></p>
<p>url：<code>http://localhost:8080/SpringMVC_04/user/t1?name=spring</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping("/user")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{<br>    <span class="hljs-meta">@PostMapping("/t1")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">acceptData</span><span class="hljs-params">(String name, Model model)</span></span>{<br>        <span class="hljs-comment">//1.接收前端参数</span><br>        System.out.println(name);<br>        <span class="hljs-comment">//2.做一些处理</span><br>        model.addAttribute(<span class="hljs-string">"msg"</span>,name);<br>        <span class="hljs-comment">//3.视图跳转</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，请求的参数名称和方法的参数名称能够对应起来，因此方法中的<code>name</code>参数可以接收来自请求的数据，然后方法就可以对数据做一些操作。</p>
<p><strong>2、传递的参数名和方法的参数名不一致</strong></p>
<p>当传递的参数名和方法的参数名不一致的时候，需要使用<code>@RequestParam</code>注解指定对应关系。</p>
<p>url：<code>http://localhost:8080/SpringMVC_04/user/t1?username=spring</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping("/user")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{<br>    <span class="hljs-meta">@GetMapping("/t1")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">acceptData</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("username")</span>String name, Model model)</span></span>{<br>        <span class="hljs-comment">//1.接收前端参数</span><br>        System.out.println(name);<br>        <span class="hljs-comment">//2.将返回的结果传递给前端</span><br>        model.addAttribute(<span class="hljs-string">"msg"</span>,name);<br>        <span class="hljs-comment">//3.视图跳转</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>@RequestParam</code>是一个参数注解，用到参数前，表示将请求的参数名和方法参数名对应起来，注解中的值为请求的参数名。</p>
<p>比如上述代码的请求参数名是<code>username</code>，则注解中的值也为<code>username</code>，表示<code>name</code>这个参数将接收来自客户端请求中的<code>username</code>参数值。</p>
<p><strong>3、传递的是一个对象</strong></p>
<p>如果提交的表单是一个复杂的对象，则方法参数使用对象类型即可。</p>
<p>比如现在有一个<code>User</code>类定义如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>url：<code>http://localhost:8080/SpringMVC_04/user/t1?name=kang&amp;id=1&amp;age=20</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping("/user")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{<br>    <span class="hljs-meta">@GetMapping("/t2")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test2</span><span class="hljs-params">(User user, Model model)</span></span>{<br>        <span class="hljs-comment">//1.接收前端参数</span><br>        System.out.println(user);<br>        <span class="hljs-comment">//2.处理数据</span><br>        model.addAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"accept user"</span>);<br>        <span class="hljs-comment">//3.视图跳转</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>;<br>    }<br></code></pre></td></tr></tbody></table></figure>
<p>这种方法需要保证请求参数的名称和对象属性名一致，如果名称不一致，则属性值为null。</p>
<h2 id="5-2-控制器传递数据"><a href="#5-2-控制器传递数据" class="headerlink" title="5.2 控制器传递数据"></a>5.2 控制器传递数据</h2><p>前面提到过，控制器有三种方式向<strong>请求域</strong>中传递数据，即向前端页面传递数据。</p>
<p>这一过程对应于SpringMVC工作原理图中的第6、7步，即控制器返回<code>ModelAndView</code>。</p>
<h3 id="1、使用Model"><a href="#1、使用Model" class="headerlink" title="1、使用Model"></a>1、使用Model</h3><p><code>Model</code>是一个接口。能够满足大部分传递数据的需求。比较简单，只适合用于存储数据。</p>
<p>使用<code>Model</code>传递数据：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/hello")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">(Model model)</span></span>{<br>        <span class="hljs-comment">//调用addAttribute方法写入数据</span><br>        model.addAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"hello,SpringMVC"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>; <br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>需要注意的是，这种方法需要将<code>Model</code>写在参数中，使用时可以调用<code>addAttribute()</code>方法写入数据。</p>
<h3 id="2、使用ModelMap"><a href="#2、使用ModelMap" class="headerlink" title="2、使用ModelMap"></a>2、使用ModelMap</h3><p><code>ModelMap</code>是一个类，继承了<code>LinkedHashMap</code>，其除了拥有和<code>Model</code>相同的功能以外，还具有<code>LinkedHashMap</code>的所有功能。</p>
<p>使用<code>ModelMap</code>传递数据的用法和<code>Model</code>相同：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/hello")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">(ModelMap modelMap)</span></span>{<br>        modelMap.addAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"hello,SpringMVC"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"hello"</span>; <br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>注意：<code>ModelMap</code>和<code>Model</code>不是实现和被实现的关系，<code>ModelMap</code>可以看作一个增强版的<code>Model</code>。</p>
<p><code>ModelMap</code>类的源码声明如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">LinkedHashMap</span>&lt;<span class="hljs-title">String</span>, <span class="hljs-title">Object</span>&gt; </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ModelMap</span><span class="hljs-params">()</span> </span>{}<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="3、使用ModelAndView"><a href="#3、使用ModelAndView" class="headerlink" title="3、使用ModelAndView"></a>3、使用ModelAndView</h3><p><code>ModerAndView</code>是一个类，其属性中包括了一个<code>Object</code>类型的<code>view</code>属性，也包括了一个<code>ModelMap</code>对象<code>model</code>。<code>model</code>是数据对象，<code>view</code>是视图，可以是视图名，也可以是视图对象。</p>
<p>除了在实现<code>Controller</code>接口重写方法时使用<code>ModelAndView</code>，还可以在自定义方法中使用。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping("/hello")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">myController</span><span class="hljs-params">()</span></span>{<br>        ModelAndView mv = <span class="hljs-keyword">new</span> ModelAndView();<br>        mv.addObject(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"hello,SpringMVC"</span>); <span class="hljs-comment">//添加数据</span><br>        mv.setViewName(<span class="hljs-string">"hello"</span>); <span class="hljs-comment">//指定视图名</span><br>        <span class="hljs-keyword">return</span> mv;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>使用<code>ModelAndView</code>时，方法的返回值必须是<code>ModelAndView</code>类型，就是将<code>ModelAndView</code>对象传递给请求分发器。</p>
<p><code>ModelAndView</code>源码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ModelAndView</span> </span>{<br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> Object view;  <span class="hljs-comment">//视图名</span><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> ModelMap model;  <span class="hljs-comment">//保存数据</span><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-keyword">private</span> HttpStatus status;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> cleared = <span class="hljs-keyword">false</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ModelAndView</span><span class="hljs-params">()</span> </span>{}<br>    <span class="hljs-comment">//设置要跳转的视图名</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setViewName</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> String viewName)</span> </span>{<br>        <span class="hljs-keyword">this</span>.view = viewName;<br>    }<br>    <span class="hljs-comment">//添加数据</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">addObject</span><span class="hljs-params">(String attributeName, </span></span><br><span class="hljs-function"><span class="hljs-params">                                  <span class="hljs-meta">@Nullable</span> Object attributeValue)</span> </span>{<br>        <span class="hljs-keyword">this</span>.getModelMap().addAttribute(attributeName, attributeValue);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>    }<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>通过源码可以看出，<code>setViewName()</code>方法是设置视图名给<code>view</code>，<code>addObject()</code>方法是调用<code>ModelMap</code>类的方法添加数据。</p>
<p><strong>总结</strong></p>
<ul>
<li><p>在使用<code>Model</code>和<code>ModelMap</code>的两种方式中，视图名是使用返回值或者手动重定向/转发来确定的，数据是通过<code>addAttribute()</code>方法添加的。</p>
</li>
<li><p>使用<code>ModelAndView</code>的方法中的视图名是通过<code>setViewName()</code>方法传递的，数据是通过<code>addObject()</code>方法添加的。</p>
</li>
<li>我们可以根据实际情况选用三种方式。</li>
</ul>
<h3 id="5-3-前端向后端传递数据时的乱码问题"><a href="#5-3-前端向后端传递数据时的乱码问题" class="headerlink" title="5.3 前端向后端传递数据时的乱码问题"></a>5.3 前端向后端传递数据时的乱码问题</h3><p>前端向后端传递数据时，由于客户端浏览器编码方式的问题，传到后端时为乱码，此时可以使用SpringMVC提供的过滤器<code>CharacterEncodingFilter</code>，在<code>web.xml</code>文件中配置过滤器：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span></span><br><span class="hljs-tag">         <span class="hljs-attr">version</span>=<span class="hljs-string">"4.0"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 配置请求分发器 --&gt;</span><br>    ...<br>    <span class="hljs-comment">&lt;!-- 配置SpringMVC提供的编码过滤器 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>encoding<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 设置编码方式为utf-8 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>encoding<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>utf-8<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>encoding<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- /*也会过滤jsp页面 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>/*</code>过滤所有页面，包括静态资源。</p>
<h1 id="六、JSON"><a href="#六、JSON" class="headerlink" title="六、JSON"></a>六、JSON</h1><h2 id="6-1-JSON介绍"><a href="#6-1-JSON介绍" class="headerlink" title="6.1 JSON介绍"></a>6.1 JSON介绍</h2><p><strong>JSON（JavaScript Object Notation, JS 对象标记）</strong>是一种轻量级的数据交换格式。JSON采用一种完全独立于编程语言的文本格式来存储和表示数据。语法格式为：</p>
<ul>
<li>对象保存为<strong>键值对</strong>，数据由逗号分隔；</li>
<li><code>{}</code>用来保存对象；</li>
<li><code>[]</code>用来保存数组。</li>
</ul>
<p>比如，一个包括三个User对象的JSON：</p>
<figure class="highlight json"><table><tbody><tr><td class="code"><pre><code class="hljs json">[{<span class="hljs-attr">"name"</span>:<span class="hljs-string">"Tom"</span>,<span class="hljs-attr">"age"</span>:<span class="hljs-number">3</span>,<span class="hljs-attr">"sex"</span>:<span class="hljs-string">"man"</span>},{<span class="hljs-attr">"name"</span>:<span class="hljs-string">"Jerry"</span>,<span class="hljs-attr">"age"</span>:<span class="hljs-number">4</span>,<span class="hljs-attr">"sex"</span>:<span class="hljs-string">"man"</span>},<br>{<span class="hljs-attr">"name"</span>:<span class="hljs-string">"Rick"</span>,<span class="hljs-attr">"age"</span>:<span class="hljs-number">20</span>,<span class="hljs-attr">"sex"</span>:<span class="hljs-string">"man"</span>}]<br></code></pre></td></tr></tbody></table></figure>
<h2 id="6-2-使用JSON传递数据"><a href="#6-2-使用JSON传递数据" class="headerlink" title="6.2 使用JSON传递数据"></a>6.2 使用JSON传递数据</h2><p>对于前后端分离的环境，前后端交互一般是传递的JSON数据。</p>
<p>常用的几个JSON处理工具包：</p>
<ul>
<li><a href="https://github.com/google/gson">Gson</a>：来自谷歌，使用广泛。</li>
<li><a href="https://github.com/alibaba/fastjson">FastJson</a>：来自阿里巴巴，速度快。</li>
<li><a href="https://github.com/FasterXML/jackson">Jackson</a>：适合数据量较大时使用。</li>
<li><a href="http://json-lib.sourceforge.net/index.html">Json-lib</a>：已经不适合现在的需求。</li>
</ul>
<p>参考<a href="https://blog.csdn.net/jiyueqianxue/article/details/83377181">各种json工具包的比较</a></p>
<h3 id="6-2-1-JS中使用JSON"><a href="#6-2-1-JS中使用JSON" class="headerlink" title="6.2.1 JS中使用JSON"></a>6.2.1 JS中使用JSON</h3><p>从JSON字符串转换为JavaScript对象：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> obj = <span class="hljs-built_in">JSON</span>.parse(<span class="hljs-string">'{"a": "Hello", "b": "World"}'</span>);<br><span class="hljs-comment">//结果是 {a: 'Hello', b: 'World'}</span><br></code></pre></td></tr></tbody></table></figure>
<p>从JavaScript 对象转换为JSON字符串：</p>
<figure class="highlight javascript"><table><tbody><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> json = <span class="hljs-built_in">JSON</span>.stringify({<span class="hljs-attr">a</span>: <span class="hljs-string">'Hello'</span>, <span class="hljs-attr">b</span>: <span class="hljs-string">'World'</span>});<br><span class="hljs-comment">//结果是 '{"a": "Hello", "b": "World"}'</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="6-2-2-SpringMVC中返回JSON数据"><a href="#6-2-2-SpringMVC中返回JSON数据" class="headerlink" title="6.2.2 SpringMVC中返回JSON数据"></a>6.2.2 SpringMVC中返回JSON数据</h3><p>以Gson为例，使用时需要先创建Gson对象，然后调用方法，如下：</p>
<p>1、将User对象转化为JSON字符串，使用<code>toJson()</code>方法</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">String str = <span class="hljs-keyword">new</span> Gson().toJson(<span class="hljs-keyword">new</span> User(<span class="hljs-number">1</span>,<span class="hljs-string">"张三"</span>,<span class="hljs-number">24</span>));<br></code></pre></td></tr></tbody></table></figure>
<p>2、将JSON字符串转化为User对象，使用<code>fromJson()</code>方法</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">User user = <span class="hljs-keyword">new</span> Gson().fromJson(str,User.class);<br></code></pre></td></tr></tbody></table></figure>
<p>在SpringMVC中使用Gson，需要先导入依赖。</p>
<p><code>pom.xml</code>：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.code.gson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>gson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>定义<code>User</code>类：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> age;<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>我们需要控制器的方法直接返回数据，而不是返回视图，这时候就需要使用<code>@ResponseBody</code>注解了。或者直接将当前类注册为<code>RestController</code>。</p>
<ul>
<li><p><code>@ResponseBody</code>：可以用在<strong>方法</strong>上，也可以用在<strong>类</strong>上。用在方法上表示当前方法<strong>返回值不会被视图解析器解析</strong>，返回值会被直接写入到响应体（response body）中，通常为JSON或XML类型的数据。用在类上则对当前类所有方法生效。</p>
</li>
<li><p><code>@RestController</code>：只能用在<strong>类</strong>上，效果相当于同时使用 <code>@Controller</code> 和<code>@ResponseBody</code>，表示将当前类注册为控制器，且类中所有方法的返回值都返回的是数据对象，不会被视图解析器解析。</p>
<blockquote>
<p><code>@RestController</code>底层仍然是使用了 <code>@Controller</code> 和<code>@ResponseBody</code>。</p>
<p>更多对比，参考<a href="https://snailclimb.gitee.io/javaguide/#/docs/system-design/framework/spring/Spring%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93?id=_3-restcontroller-vs-controller">@Controller和@RestController</a></p>
</blockquote>
</li>
</ul>
<p>以下为组合使用 <code>@Controller</code> 和 <code>@ResponseBody</code>，单独使用<code>@ResponseBody</code>两种方式，二者效果相同。</p>
<p>1、使用 <code>@Controller</code> 和 <code>@ResponseBody</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{}<br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(value = "/json")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>        User user = <span class="hljs-keyword">new</span> User(<span class="hljs-number">1</span>,<span class="hljs-string">"John"</span>,<span class="hljs-number">24</span>);<br>        String str = <span class="hljs-keyword">new</span> Gson().toJson(user);<br>        <span class="hljs-keyword">return</span> str;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>2、使用<code>@RestController</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping(value = "/json")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>        User user = <span class="hljs-keyword">new</span> User(<span class="hljs-number">1</span>,<span class="hljs-string">"John"</span>,<span class="hljs-number">24</span>);<br>        String str = <span class="hljs-keyword">new</span> Gson().toJson(user);<br>        <span class="hljs-keyword">return</span> str;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样客户端可以从响应数据中接收数据。</p>
<h2 id="6-3-使用HttpMessageConverter处理乱码"><a href="#6-3-使用HttpMessageConverter处理乱码" class="headerlink" title="6.3 使用HttpMessageConverter处理乱码"></a>6.3 使用HttpMessageConverter处理乱码</h2><p>控制器返回JSON数据时，可能会由于编码不同而出现乱码问题，可以通过配置SpringMVC的<code>StringHttpMessageConverter</code>消息转换器来解决。</p>
<p>在spring的配置文件<code>springmvc-servlet.xml</code>文件的注解驱动中配置消息转换器：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- annotation-driven的作用就是提供扩展功能 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mvc:annotation-driven</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- StringHttpMessageConverter转换配置，解决乱码问题 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:message-converters</span> <span class="hljs-attr">register-defaults</span>=<span class="hljs-string">"true"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.http.converter.</span></span><br><span class="hljs-tag"><span class="hljs-string">                     StringHttpMessageConverter"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"UTF-8"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.http.converter.json.</span></span><br><span class="hljs-tag"><span class="hljs-string">                     MappingJackson2HttpMessageConverter"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"objectMapper"</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.http.converter.json.</span></span><br><span class="hljs-tag"><span class="hljs-string">                             Jackson2ObjectMapperFactoryBean"</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"failOnEmptyBeans"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"false"</span>/&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mvc:message-converters</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mvc:annotation-driven</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="七、RESTful"><a href="#七、RESTful" class="headerlink" title="七、RESTful"></a>七、RESTful</h1><p>参考<a href="https://www.ruanyifeng.com/blog/2011/09/restful.html">理解RESTful架构</a></p>
<p>REST（Representational State Transfer），表现层状态转化：</p>
<ul>
<li>每个URI代表一种资源</li>
<li>客户端和服务器之间传递这种资源的表现层</li>
<li>客户端通过四个HTTP请求方式，对服务器资源进行操作，实现“表现层状态转化”。<ul>
<li>GET请求用来获取资源，对应查询操作</li>
<li>POST请求用来新建（或更新）资源，对应添加操作</li>
<li>PUT用来更新资源，对于修改操作</li>
<li>DELETE用来删除资源，对于删除操作</li>
</ul>
</li>
</ul>
<p>可以简单将RESTful理解为资源定位及资源操作的风格。基于这个风格设计的软件可以更简洁，更有层次，更易于实现缓存等机制。</p>
<p>RESTful风格下，请求和参数值都使用<code>/</code>分隔开，同样的请求地址可以根据不同的请求方式，实现不同的功能：</p>
<figure class="highlight awk"><table><tbody><tr><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-regexp">/item/</span><span class="hljs-number">1</span> 	查询,GET<br>http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-regexp">/item/</span><span class="hljs-number">1</span> 	新增,POST<br>http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-regexp">/item/</span><span class="hljs-number">1</span> 	更新,PUT<br>http:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span><span class="hljs-regexp">/item/</span><span class="hljs-number">1</span> 	删除,DELETE<br></code></pre></td></tr></tbody></table></figure>
<p>比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RestFulController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping(value = "/add/{a}/{b}",method = RequestMethod.POST)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test1</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> <span class="hljs-keyword">int</span> a, <span class="hljs-meta">@PathVariable</span> <span class="hljs-keyword">int</span> b, Model model)</span></span>{<br>        <span class="hljs-keyword">int</span> res = a+b;<br>        model.addAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"Result 1:"</span>+res);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"restful"</span>;<br>    }<br>    <span class="hljs-comment">//URL相同时，可以根据不同的请求调用不同的方法</span><br>    <span class="hljs-meta">@GetMapping("/add/{a}/{b}")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">test2</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> <span class="hljs-keyword">int</span> a, <span class="hljs-meta">@PathVariable</span> <span class="hljs-keyword">int</span> b, Model model)</span></span>{<br>        <span class="hljs-keyword">int</span> res = a*b;<br>        model.addAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"Result 2:"</span>+res);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"restful"</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>@PathVariable</code>用于将URI的变量和方法参数对应起来，名称要相同。</p>
<p>对于以上代码，URL为<code>http://localhost:8080/SpringMVC_04/add/3/4</code>时，如果是<code>get</code>请求，会调用第二个方法，结果为12；如果是<code>post</code>请求，调用第一个方法，结果为7。</p>
<p>RESTful风格的优势：</p>
<ul>
<li>使路径变得更简洁。</li>
<li>获取参数更方便，框架会自动类型转换</li>
<li>通过路径变量的类型约束访问参数，如果类型不对应，会访问不到方法。</li>
</ul>
<h1 id="八、拦截器"><a href="#八、拦截器" class="headerlink" title="八、拦截器"></a>八、拦截器</h1><p>SpringMVC中的<strong>拦截器（Interceptor）</strong>类似于servlet中的过滤器（Filter），不同的是：</p>
<ul>
<li>过滤器在任何web工程都可以使用。拦截器属于SpringMVC框架，只能在SpringMVC框架工程中使用。</li>
<li>过滤器通过<code>/*</code>可以拦截所有要访问的资源。拦截器只会拦截访问的控制器方法。</li>
</ul>
<p>拦截器和过滤器的区别：<a href="https://www.zhihu.com/question/30212464/answer/1786967139">https://www.zhihu.com/question/30212464/answer/1786967139</a></p>
<p>自定义拦截器需要实现<code>HandlerInterceptor</code>接口，接口中的三个默认方法，可以根据需求进行重写。</p>
<p>在项目中使用自定义拦截器步骤如下：</p>
<p><strong>1、定义一个类实现<code>HandlerInterceptor</code>接口</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, </span></span><br><span class="hljs-function"><span class="hljs-params">                             HttpServletResponse response, Object handler)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> Exception </span>{<br>        System.out.println(<span class="hljs-string">"=========处理前要执行的操作========="</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>; <span class="hljs-comment">//true表示放行，执行下一个拦截器</span><br>    }<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    postHandle和afterCompletion一般用于日志处理之类的后续工作</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postHandle</span><span class="hljs-params">(HttpServletRequest request, </span></span><br><span class="hljs-function"><span class="hljs-params">                           HttpServletResponse response, Object handler, </span></span><br><span class="hljs-function"><span class="hljs-params">                           ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        System.out.println(<span class="hljs-string">"=========处理后要执行的操作========="</span>);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(HttpServletRequest request,</span></span><br><span class="hljs-function"><span class="hljs-params">                                HttpServletResponse response, </span></span><br><span class="hljs-function"><span class="hljs-params">                                Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        System.out.println(<span class="hljs-string">"=========清理========="</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>HandlerInterceptor</code>接口有三个方法：</p>
<ul>
<li><code>preHandle()</code>：请求处理前执行，返回值为<code>true</code>表示放行，如果有的话执行下一个拦截器。返回值为<code>false</code>表示不放行。常用于身份验证等需求中。</li>
<li><code>postHandle()</code>：请求完成后执行，一般用于日志处理等后续操作。如果有多个拦截器，这个方法会按照声明顺序倒着执行。</li>
<li><code>afterCompletion()</code>：在请求分发器视图渲染之后执行，多用于资源清理。前提是<code>preHandle</code>返回<code>true</code></li>
</ul>
<p><strong>2、在SpringMVC配置文件中配置拦截器</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 配置拦截器 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mvc:interceptors</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 配置拦截所有请求的拦截器 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:interceptor</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- /**表示这个请求下的所有请求，包括子请求 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mvc:mapping</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/**"</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!-- 指定拦截器实现类 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.config.MyInterceptor"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mvc:interceptor</span>&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 配置一个只拦截user下所有请求的拦截器 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mvc:interceptor</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- /**表示这个请求下的所有请求，包括子请求 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">mvc:mapping</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/user/**"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.config.LoginInterceptor"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mvc:interceptor</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mvc:interceptors</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以配置多个拦截器，满足不同的需求。</p>
<p><code>/**</code>：当前所有文件，递归包括所有子文件夹，即包括多级目录。即所有请求，包括子请求。</p>
<p><code>/*</code>：当前所有文件，不包括子文件夹中的内容，即只包括一级目录。即只有当前请求下的请求，不包括子请求下的请求。</p>
<p><strong>使用情景举例</strong>：使用拦截器确保用户登录才能进入某个页面。当用户访问某个页面的时候，在拦截器中验证是否登陆，如果登陆，则放行；如果未登录，则请求转发或重定向到登录界面。</p>
<h1 id="九、Ajax"><a href="#九、Ajax" class="headerlink" title="九、Ajax"></a>九、Ajax</h1><p><strong>AJAX（Asynchronous JavaScript and XML）</strong>：异步的 JavaScript 和 XML，是一种在无需重新加载整个网页的情况下，能够更新部分网页的技术。</p>
<p>AJAX是一种<strong>用于创建更好更快以及交互性更强的Web应用程序的技术。</strong>比如搜索栏动态显示搜索建议；网页登陆时不用刷新网页就提示用户名和密码正确性。</p>
<p><strong>Demo：</strong>在SpringMVC项目中，使用Ajax实现以下功能：</p>
<p>输入用户名后，动态检测用户名是否存在并提示；输入密码后，动态检测密码是否正确并提示。</p>
<p><strong>1、先定义一个控制器类<code>verifyUsernameAndPwd.java</code>：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">简单起见，用户名为“admin”，密码为“123456”，模拟从数据库中查询到的结果。</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AjaxController</span> </span>{<br>    <span class="hljs-comment">//登陆验证处理</span><br>    <span class="hljs-meta">@RequestMapping("/login")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">login</span><span class="hljs-params">(String name,String pwd)</span></span>{<br>        String msg = <span class="hljs-string">""</span>;<br>        <span class="hljs-keyword">if</span>(name !=<span class="hljs-keyword">null</span>){<br>            <span class="hljs-keyword">if</span>(<span class="hljs-string">"admin"</span>.equals(name)){<br>                msg=<span class="hljs-string">"ok"</span>;<br>            }<span class="hljs-keyword">else</span>{<br>                msg = <span class="hljs-string">"用户名不存在"</span>;<br>            }<br>        }<br>        <span class="hljs-keyword">if</span>(pwd!=<span class="hljs-keyword">null</span>){<br>            <span class="hljs-keyword">if</span>(<span class="hljs-string">"123456"</span>.equals(pwd)){<br>                msg=<span class="hljs-string">"ok"</span>;<br>            }<span class="hljs-keyword">else</span>{<br>                msg = <span class="hljs-string">"密码错误"</span>;<br>            }<br>        }<br>        <span class="hljs-keyword">return</span> msg;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、前端页面</strong></p>
<p>我们使用jquery提供的Ajax方法实现Ajax请求。使用前需要导入Jquery的jar包，或者使用CDN。</p>
<p><code>login.jsp</code>：</p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;%@ page contentType=<span class="hljs-string">"text/html;charset=UTF-8"</span> language=<span class="hljs-string">"java"</span> %&gt;<br>&lt;html&gt;<br>    &lt;head&gt;<br>        &lt;title&gt;ajax&lt;/title&gt;<br>        &lt;!-- 需要将jquery包导入 --&gt;<br>        &lt;script src="${pageContext.request.contextPath}/statics/js/jquery-3.1.1.min.js"&gt;&lt;/script&gt;<br>        &lt;script&gt;<br>            <span class="hljs-comment">//用户名框失焦事件</span><br>            <span class="hljs-function">function <span class="hljs-title">verifyName</span><span class="hljs-params">()</span></span>{<br>                <span class="hljs-comment">//通过jquery中的post方法调用ajax方法</span><br>                $.post({<br>                    url:<span class="hljs-string">"${pageContext.request.contextPath}/login"</span>,<br>                    data:{<span class="hljs-string">'name'</span>:$(<span class="hljs-string">"#name"</span>).val()},<br>                    success:function (data) {<br>                        <span class="hljs-comment">//如果返回结果为ok,提示信息为绿色,否则为红色</span><br>                        <span class="hljs-keyword">if</span> (data.toString()==<span class="hljs-string">'OK'</span>){<br>                            $(<span class="hljs-string">"#userInfo"</span>).css(<span class="hljs-string">"color"</span>,<span class="hljs-string">"green"</span>);<br>                        }<span class="hljs-keyword">else</span> {<br>                            $(<span class="hljs-string">"#userInfo"</span>).css(<span class="hljs-string">"color"</span>,<span class="hljs-string">"red"</span>);<br>                        }<br>                        $(<span class="hljs-string">"#userInfo"</span>).html(data);<br>                    }<br>                });<br>            }<br>            <span class="hljs-comment">//密码框失焦事件</span><br>            <span class="hljs-function">function <span class="hljs-title">verifyPwd</span><span class="hljs-params">()</span></span>{<br>                $.post({<br>                    url:<span class="hljs-string">"${pageContext.request.contextPath}/login"</span>,<br>                    data:{<span class="hljs-string">'pwd'</span>:$(<span class="hljs-string">"#pwd"</span>).val()},<br>                    success:function (data) {<br>                        <span class="hljs-keyword">if</span> (data.toString()==<span class="hljs-string">'OK'</span>){<br>                            $(<span class="hljs-string">"#pwdInfo"</span>).css(<span class="hljs-string">"color"</span>,<span class="hljs-string">"green"</span>);<br>                        }<span class="hljs-keyword">else</span> {<br>                            $(<span class="hljs-string">"#pwdInfo"</span>).css(<span class="hljs-string">"color"</span>,<span class="hljs-string">"red"</span>);<br>                        }<br>                        $(<span class="hljs-string">"#pwdInfo"</span>).html(data);<br>                    }<br>                });<br>            }<br><br>        &lt;/script&gt;<br>    &lt;/head&gt;<br>    &lt;body&gt;<br>        &lt;p&gt;<br>            用户名:&lt;input type=<span class="hljs-string">"text"</span> id=<span class="hljs-string">"name"</span> onblur=<span class="hljs-string">"verifyName()"</span>/&gt;<br>            &lt;span id="userInfo"&gt;&lt;/span&gt;<br>        &lt;/p&gt;<br>        &lt;p&gt;<br>            密码:&lt;input type=<span class="hljs-string">"text"</span> id=<span class="hljs-string">"pwd"</span> onblur=<span class="hljs-string">"verifyPwd()"</span>/&gt;<br>            &lt;span id="pwdInfo"&gt;&lt;/span&gt;<br>        &lt;/p&gt;<br>    &lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>上述JS代码中我们使用的<code>$.post</code>调用的是jquery中的<code>post</code>方法，<code>post</code>方法内部调用了<code>ajax</code>方法，我们也可以直接调用<code>ajax</code>方法，都可以完成Ajax请求。</p>
<p>Ajax方法需要关注的几个参数：</p>
<ul>
<li><code>url</code>：请求地址。</li>
<li><code>type</code>：请求方式，比如get、post（1.9.0之后用method）。</li>
<li><code>data</code>：要发送的数据。</li>
<li><code>ontentType</code>：发送信息至服务器的内容编码类型。</li>
<li><code>success</code>：成功之后的回调函数。</li>
</ul>
<p>在上述的Demo中，url就是<code>login</code>请求地址，<code>data</code>就是当前输入框里的内容，<code>success</code>回调函数的功能定义为显示提示信息，比如用户名是否存在、密码是否正确。</p>
<h1 id="十、文件上传与下载"><a href="#十、文件上传与下载" class="headerlink" title="十、文件上传与下载"></a>十、文件上传与下载</h1><p>Spring MVC为文件上传提供了直接的支持，这种支持是通过即插即用的MultipartResolver实现的。</p>
<p>Spring MVC使用<code>Apache Commons FileUpload</code>实现了一个MultipartResolver的实现类<code>CommonsMultipartResolver</code>。因此，SpringMVC的文件上传还需要依赖Apache Commons FileUpload的组件。</p>
<p>导入文件上传需要的依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--文件上传--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-fileupload<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-fileupload<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="10-1-文件上传"><a href="#10-1-文件上传" class="headerlink" title="10.1 文件上传"></a>10.1 文件上传</h2><p>文件上传需要确保导入了<code>commons-fileupload</code>依赖。</p>
<p><strong>1、配置bean</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 配置CommonsMultipartResolver --&gt;</span><br><span class="hljs-comment">&lt;!--这个bean的id必须为：multipartResolver--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"multipartResolver"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"defaultEncoding"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"utf-8"</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!-- 根据需求确定是否配置上传文件大小限制，单位为字节(10485760=10M)--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"maxUploadSize"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"10485760"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"maxInMemorySize"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"40960"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>defaultEncoding</code>表示请求的编码格式，必须和JSP的<code>pageEncoding</code>属性一致，以便正确读取表单的内容，默认为<code>ISO-8859-1</code>.</p>
<p><code>CommonsMultipartFile</code>类中的常用方法：</p>
<ul>
<li><code>String getOriginalFilename()</code>：获取上传文件的原名</li>
<li><code>InputStream getInputStream()</code>：获取文件流</li>
<li><code>void transferTo(File dest)</code>：将上传文件保存到一个目录文件中</li>
</ul>
<p><strong>2、前端页面</strong></p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;!-- 上传文件的编码必须是multipart/form-data --&gt;<br>&lt;form action=<span class="hljs-string">"/upload"</span> enctype=<span class="hljs-string">"multipart/form-data"</span> method=<span class="hljs-string">"post"</span>&gt;<br>    &lt;input type=<span class="hljs-string">"file"</span> name=<span class="hljs-string">"file"</span>/&gt;<br>    &lt;input type=<span class="hljs-string">"submit"</span> value=<span class="hljs-string">"upload"</span>&gt;<br>&lt;/form&gt;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、控制器实现功能</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileController</span> </span>{<br>    <span class="hljs-comment">//@RequestParam("file") 将name=file控件得到的文件封装成CommonsMultipartFile对象</span><br>    <span class="hljs-comment">//批量上传CommonsMultipartFile则为数组即可</span><br>    <span class="hljs-meta">@RequestMapping("/upload")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">fileUpload</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("file")</span> CommonsMultipartFile file, </span></span><br><span class="hljs-function"><span class="hljs-params">                             HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br><br>        <span class="hljs-comment">//获取文件名 : file.getOriginalFilename();</span><br>        String uploadFileName = file.getOriginalFilename();<br><br>        <span class="hljs-comment">//如果文件名为空，直接回到首页</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">""</span>.equals(uploadFileName)) {<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/index.jsp"</span>;<br>        }<br>        System.out.println(<span class="hljs-string">"上传文件名 : "</span> + uploadFileName);<br><br>        <span class="hljs-comment">//上传路径保存设置</span><br>        String path = request.getServletContext().getRealPath(<span class="hljs-string">"/upload"</span>);<br>        <span class="hljs-comment">//如果路径不存在，创建一个</span><br>        File realPath = <span class="hljs-keyword">new</span> File(path);<br>        <span class="hljs-keyword">if</span> (!realPath.exists()) {<br>            realPath.mkdir();<br>        }<br>        System.out.println(<span class="hljs-string">"上传文件保存地址："</span> + realPath);<br>        InputStream is = file.getInputStream(); <span class="hljs-comment">//文件输入流</span><br>        OutputStream os = <span class="hljs-keyword">new</span> FileOutputStream(<br>            <span class="hljs-keyword">new</span> File(realPath, uploadFileName)); <span class="hljs-comment">//文件输出流</span><br><br>        <span class="hljs-comment">//读取写出</span><br>        <span class="hljs-keyword">int</span> len = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">while</span> ((len = is.read(buffer)) != -<span class="hljs-number">1</span>) {<br>            os.write(buffer, <span class="hljs-number">0</span>, len);<br>            os.flush();<br>        }<br>        os.close();<br>        is.close();<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/index.jsp"</span>;<br>    }<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 方式二：采用file.Transto 来保存上传的文件</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@RequestMapping("/upload2")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String  <span class="hljs-title">fileUpload2</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("file")</span> CommonsMultipartFile file,</span></span><br><span class="hljs-function"><span class="hljs-params">                               HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br><br>        <span class="hljs-comment">//上传路径保存设置</span><br>        String path = request.getServletContext().getRealPath(<span class="hljs-string">"/upload"</span>);<br>        File realPath = <span class="hljs-keyword">new</span> File(path);<br>        <span class="hljs-keyword">if</span> (!realPath.exists()){<br>            realPath.mkdir();<br>        }<br>        <span class="hljs-comment">//上传文件地址</span><br>        System.out.println(<span class="hljs-string">"上传文件保存地址："</span>+realPath);<br><br>        <span class="hljs-comment">//通过CommonsMultipartFile的方法直接写文件</span><br>        file.transferTo(<span class="hljs-keyword">new</span> File(realPath +<span class="hljs-string">"/"</span>+ file.getOriginalFilename()));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"redirect:/index.jsp"</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="10-2-文件下载"><a href="#10-2-文件下载" class="headerlink" title="10.2 文件下载"></a>10.2 文件下载</h2><p>文件下载步骤：</p>
<ul>
<li><p>设 response响应头</p>
</li>
<li><p>读取文件 — InputStream</p>
</li>
<li><p>写出文件 — OutputStream</p>
</li>
<li><p>执行操作</p>
</li>
<li>关闭流 （先开的后关）</li>
</ul>
<p><strong>1、编写控制器类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileController</span> </span>{<br>    <span class="hljs-meta">@RequestMapping(value="/download")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">downloads</span><span class="hljs-params">(HttpServletResponse response, </span></span><br><span class="hljs-function"><span class="hljs-params">                            HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception</span>{<br>        <span class="hljs-comment">//要下载的文件地址</span><br>        String  path = request.getServletContext().getRealPath(<span class="hljs-string">"/upload"</span>);<br>        String  fileName = <span class="hljs-string">"test.txt"</span>;<br><br>        <span class="hljs-comment">//1、设置response 响应头</span><br>        response.reset(); <span class="hljs-comment">//设置页面不缓存,清空buffer</span><br>        response.setCharacterEncoding(<span class="hljs-string">"UTF-8"</span>); <span class="hljs-comment">//字符编码</span><br>        response.setContentType(<span class="hljs-string">"multipart/form-data"</span>); <span class="hljs-comment">//二进制传输数据</span><br>        <span class="hljs-comment">//设置响应头</span><br>        response.setHeader(<span class="hljs-string">"Content-Disposition"</span>,<br>                <span class="hljs-string">"attachment;fileName="</span>+ URLEncoder.encode(fileName, <span class="hljs-string">"UTF-8"</span>));<br><br>        File file = <span class="hljs-keyword">new</span> File(path,fileName);<br>        <span class="hljs-comment">//2、 读取文件--输入流</span><br>        InputStream input=<span class="hljs-keyword">new</span> FileInputStream(file);<br>        <span class="hljs-comment">//3、 写出文件--输出流</span><br>        OutputStream out = response.getOutputStream();<br><br>        <span class="hljs-keyword">byte</span>[] buff =<span class="hljs-keyword">new</span> <span class="hljs-keyword">byte</span>[<span class="hljs-number">1024</span>];<br>        <span class="hljs-keyword">int</span> index=<span class="hljs-number">0</span>;<br>        <span class="hljs-comment">//4、执行 写出操作</span><br>        <span class="hljs-keyword">while</span>((index= input.read(buff))!= -<span class="hljs-number">1</span>){<br>            out.write(buff, <span class="hljs-number">0</span>, index);<br>            out.flush();<br>        }<br>        out.close();<br>        input.close();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、前端页面</strong></p>
<figure class="highlight"><table><tbody><tr><td class="code"><pre><code class="hljs jsp">&lt;a href="/download"&gt;点击下载&lt;/a&gt;<br></code></pre></td></tr></tbody></table></figure>
<hr>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p>1、<a href="https://www.bilibili.com/video/BV1aE41167Tu">b站-SpringMVC</a></p>
<p>2、<a href="https://snailclimb.gitee.io/javaguide/#/docs/system-design/framework/spring/Spring%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93">Spring常见问题</a></p>
]]></content>
      <categories>
        <category>SSM框架</category>
      </categories>
      <tags>
        <tag>SSM</tag>
        <tag>SprinMVC</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot2-配置与原理深入解析</title>
    <url>/2021/07/12/springboot-advance/</url>
    <content><![CDATA[<h1 id="一、SpringBoot自动配置原理"><a href="#一、SpringBoot自动配置原理" class="headerlink" title="一、SpringBoot自动配置原理"></a>一、SpringBoot自动配置原理</h1><p>SpringBoot中的自动配置原理，需要从<code>@SpringBootApplication</code>这个注解出发。</p>
<p>这个注解相当于以下三个注解：</p>
<ul>
<li><code>@SpringBootConfiguration</code>：等价于<code>@Configuration</code>，表明这是一个SpringBoot项目的配置类。</li>
<li><code>@EnableAutoConfiguration</code>：开启自动配置功能。</li>
<li><code>@ComponentScan</code>：自动扫描并加载<strong>给定的路径中</strong>符合条件的组件，注入到IOC容器中。</li>
</ul>
<p>其中自动配置的原理，就和<code>@EnableAutoConfiguration</code>有关。</p>
<p>下面着重对其进行分析。</p>
<p><code>@EnableAutoConfiguration</code>的源码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AutoConfigurationPackage</span><br><span class="hljs-meta">@Import(AutoConfigurationImportSelector.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableAutoConfiguration {}<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，<code>@EnableAutoConfiguration</code>是由<code>@AutoConfigurationPackage</code>和<code>@Import</code>两个注解组成的。</p>
<p>其中<code>@AutoConfigurationPackage</code>会自动导入主程序所在包及其子包的一系列组件。即<strong>自动导入包机制。</strong></p>
<p><code>@Import</code>主要是按需加载自动配置类，将生效的自动配置类加载到容器。</p>
<p>下面对这两个注解详细分析。</p>
<h2 id="1-1-AutoConfigurationPackage自动导包"><a href="#1-1-AutoConfigurationPackage自动导包" class="headerlink" title="1.1 @AutoConfigurationPackage自动导包"></a>1.1 @AutoConfigurationPackage自动导包</h2><p><code>@AutoConfigurationPackage</code>注解是用来自动导入包的，下面深入解析其是如何导入的。</p>
<p>进入其源码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Import(AutoConfigurationPackages.Registrar.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> AutoConfigurationPackage {}<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，<code>AutoConfigurationPackage</code>为我们自动引入了一个注册器。继续进入<code>AutoConfigurationPackages.Registrar</code>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_1.png"><span class="image-caption">内部类Registrar的声明</span></p>
<p><code>Registrar</code>是<code>AutoConfigurationPackages</code>的一个内部类，其中有两个方法，主要关注第一个方法。</p>
<p>对<code>registerBeanDefinitions()</code>这个方法进行分析</p>
<ul>
<li><code>metadata</code>参数：注解的元信息。这里指的是<code>@AutoConfigurationPackage</code>这个注解，而这个注解相当于直接配置在了启动类上，因此从元信息中获取包名，就是启动类所在的目录名。比如当前启动类在<code>com/kang/root</code>目录下，则<code>new PackageImports(metadata).getPackageNames()</code>的值为<code>com.kang.root</code>。</li>
<li><code>register()</code>：将指定目录下的包的所有组件注册进来。</li>
</ul>
<p>由此，我们可以得知，<strong><code>@AutoConfigurationPackage</code>注解，利用<code>Registrar</code>给容器中导入一系列组件，将指定的一个包下的所有组件导入进来，这个包就是主程序所在的包。</strong></p>
<p>因此我们可以解释，为什么SpringBoot扫描包的路径就是主程序所在包及其子包。</p>
<h2 id="1-2-Import-按需加载配置类"><a href="#1-2-Import-按需加载配置类" class="headerlink" title="1.2 @Import 按需加载配置类"></a>1.2 @Import 按需加载配置类</h2><p><code>@EnableAutoConfiguration</code>第二个重要的注解是<code>@Import</code>，其引入了<code>AutoConfigurationImportSelector</code>，这个类的继承体系如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_2.png"><span class="image-caption">AutoConfigurationImportSelector的继承体系</span></p>
<p>可以看到其实现了<code>ImportSelector</code>接口，并且实现了这个接口的<code>selectImports</code>方法，这个方法主要用于<strong>获取所有符合条件的全限定类名，这些类需要被加载到IOC容器中</strong>。</p>
<p><code>AutoConfigurationImportSelector</code>类：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) {<br>    <span class="hljs-comment">//判断自动装配开关是否打开</span><br>    <span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) {<br>        <span class="hljs-keyword">return</span> NO_IMPORTS;<br>    }<br>    <span class="hljs-comment">//获取所有需要装配的bean</span><br>    AutoConfigurationEntry autoConfigurationEntry =<br>        getAutoConfigurationEntry(annotationMetadata);<br>    <span class="hljs-keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>接下来进入<code>getAutoConfigurationEntry()</code>这个方法，查看是如何获取需要装配的bean的。</p>
<p>这个方法的源码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> AutoConfigurationEntry <span class="hljs-title">getAutoConfigurationEntry</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">    AnnotationMetadata annotationMetadata)</span> </span>{<br>    <span class="hljs-comment">//1.判断自动装配开关是否打开</span><br>    <span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) {<br>        <span class="hljs-keyword">return</span> EMPTY_ENTRY;<br>    }<br>    <span class="hljs-comment">//2.</span><br>    AnnotationAttributes attributes = getAttributes(annotationMetadata);<br>    <span class="hljs-comment">//3.扫描spring.factories下需要自动装配的所有类</span><br>    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata,<br>                                                             attributes);<br>    <span class="hljs-comment">//4.下面是过滤出真正需要加载的类。</span><br>    configurations = removeDuplicates(configurations);<br>    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);<br>    checkExcludedClasses(configurations, exclusions);<br>    configurations.removeAll(exclusions);<br>    configurations = getConfigurationClassFilter().filter(configurations);<br>    fireAutoConfigurationImportEvents(configurations, exclusions);<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AutoConfigurationEntry(configurations, exclusions);<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>代码解析如下：</p>
<p>1、判断自动装配开关是否打开，即<code>spring.boot.enableautoconfiguration</code>的值是否为true.</p>
<p>2、获取<code>@EnableAutoConfiguration</code>注解的所有属性，即<code>exclude</code>和<code>excludeName</code>。</p>
<p>3、<code>getCandidateConfigurations()</code>方法，从<code>META-INF/spring.factories</code>中获取所有需要自动装配的配置类。</p>
<ul>
<li><p>内部调用<code>SpringFactoriesLoader.loadFactoryNames()</code>，然后调用<code>loadSpringFactories()</code>方法。然后进入这个方法。</p>
<ul>
<li><p>可以看到，这个方法加载了<code>META-INF/spring.factories</code>这个配置文件，默认扫描当前系统里面所有的<code>META-INF/spring.factories</code>位置的文件。</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_3.png" alt=""></p>
</li>
<li><p>当前版本一共131个需要自动装配的类，没有第三方starter时，他们都是来自<code>spring-boot-autoconfigure-2.5.2</code>包里的<code>META-INF/spring.factories</code>文件。这个自动配置包里面规定了SpringBoot自动配置的一些属性，其中的<code>EnableAutoConfiguration</code>属性就是所有要自动装配的类，如图。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_4.png"><span class="image-caption">META-INF/spring.factories里配置的需要自动装配的类</span></p>
</li>
</ul>
</li>
</ul>
<p>因此，如果我们想要实现一个starter，就必须在<code>META-INF/spring.factories</code>文件中配置这样的配置项，指定要加载的自动配置包。</p>
<p>这一步中将自动配置类的所有需要加载的包都读取过来了，那么这些包必须全部加载吗？答案是否定的。</p>
<p>顺着源码继续往下。</p>
<p>4、<strong>按需开启自动配置项</strong>。虽然读取了所有需要自动加载的类，但是这些类生效都是有条件的，比如需要导入相关的包，这个类才能被加载。因此最终只加载生效的部分类。</p>
<blockquote>
<p>配置类中使用@Condition条件装配，判断当前类是否生效。</p>
</blockquote>
<h2 id="1-3-总结"><a href="#1-3-总结" class="headerlink" title="1.3 总结"></a>1.3 总结</h2><p>关于自动配置：</p>
<ul>
<li>SpringBoot先读取所有的自动配置类：<code>xxxxxAutoConfiguration</code></li>
<li>每个自动配置类按照条件生效，默认都会绑定<code>xxxxProperties</code>类，这个类里面设置了默认的值。</li>
<li><p><code>xxxProperties</code>类和配置文件进行了绑定，可以通过配置文件对默认值进行设置。</p>
</li>
<li><p>生效的配置类就会给容器中装配很多组件。只要容器中有这些组件，相当于这些功能就有了</p>
</li>
</ul>
<p>如果我们需要的包没有被starter，则需要手动导入。</p>
<p>我们可以在配置文件中对配置项的值进行修改。</p>
<h1 id="二、Profile功能"><a href="#二、Profile功能" class="headerlink" title="二、Profile功能"></a>二、Profile功能</h1><p>为了方便多环境适配，SpringBoot简化了profile功能。</p>
<p>我们可以配置多套环境，比如测试环境和生产环境，可以方便的在不同的环境中切换。</p>
<p>比如同时配置多个配置文件，表示多个配置环境，根据需求使用不同的配置：</p>
<figure class="highlight applescript"><table><tbody><tr><td class="code"><pre><code class="hljs applescript"><span class="hljs-built_in">application</span>.yaml     总配置文件<br><span class="hljs-built_in">application</span>-test.yaml  test环境<br><span class="hljs-built_in">application</span>-prod.yaml  prod环境<br>...<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-1-application-profile功能"><a href="#2-1-application-profile功能" class="headerlink" title="2.1 application-profile功能"></a>2.1 application-profile功能</h2><ul>
<li>默认配置文件 <code>application.yaml</code>任何时候都会加载</li>
<li><p>指定环境配置文件，格式： application-{env}.yaml，比如application-prod.yaml文件，代表<code>prod</code>环境。</p>
</li>
<li><p>激活指定环境：</p>
<ul>
<li><p>方式一：使用配置文件激活。比如在默认配置文件中使用<code>spring.profiles.active=test</code>激活test环境。</p>
</li>
<li><p>方式二：命令行激活。对于已经打包的程序，命令行也能够<strong>指定环境并修改配置文件的任意值</strong>。比如使用命令行激活prod环境，并指定参数值</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 这时，命令行的参数值会生效</span><br>java -jar xxx.jar --spring.profiles.active=prod  --person.name=haha<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
</li>
<li><p>默认配置与环境配置同时生效</p>
</li>
<li>对于同名配置项，指定的环境配置生效。</li>
</ul>
<h2 id="2-2-Profile条件装配功能"><a href="#2-2-Profile条件装配功能" class="headerlink" title="2.2 @Profile条件装配功能"></a>2.2 @Profile条件装配功能</h2><p>@Profile可以用在类上或者方法上，表示只有在指定的环境下才生效。</p>
<p>比如<code>@Profile("test")</code>标注，表示这个类/方法只有在test环境下才生效。</p>
<p>比如：</p>
<p><code>person.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@ConfigurationProperties("person")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Person</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<p><code>Boss.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//这个类只在prod环境下注册</span><br><span class="hljs-meta">@Profile("prod")</span>  <br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Boss</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> name;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>{<span class="hljs-keyword">this</span>.name = name;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> age;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(Integer age)</span> </span>{<span class="hljs-keyword">this</span>.age = age;}<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>Worker.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//这个类只在test环境下注册</span><br><span class="hljs-meta">@Profile("test")</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Person</span></span>{<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Integer age;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> name;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>{<span class="hljs-keyword">this</span>.name = name;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Integer <span class="hljs-title">getAge</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> age;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAge</span><span class="hljs-params">(Integer age)</span> </span>{<span class="hljs-keyword">this</span>.age = age;}<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>然后定义一个<code>controller</code>类，<code>HelloController.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    Person person;<br><br>    <span class="hljs-meta">@GetMapping("/")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String  <span class="hljs-title">hello</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> person.getClass().getName();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，如果在<code>test</code>环境下，访问主页就会返回<code>com.kang.boot.bean.Worker</code>，如果在<code>prob</code>环境下，返回值为<code>com.kang.boot.bean.Boss</code>。</p>
<h2 id="2-3-profile分组"><a href="#2-3-profile分组" class="headerlink" title="2.3 profile分组"></a>2.3 profile分组</h2><p>可以使用<code>spring.profiles.group</code>对配置文件进行分组，然后同时激活同一个组的多个配置文件。比如：</p>
<p><code>application.properties</code></p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 激活myprod组</span><br><span class="hljs-meta">spring.profiles.active</span>=<span class="hljs-string">myprod</span><br><br><span class="hljs-comment"># 定义两个配置组，myprod和mytest</span><br><span class="hljs-meta">spring.profiles.group.myprod[0]</span>=<span class="hljs-string">prod</span><br><span class="hljs-meta">spring.profiles.group.myprod[1]</span>=<span class="hljs-string">prod2</span><br><span class="hljs-meta">spring.profiles.group.mytest[0]</span>=<span class="hljs-string">test</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、配置加载优先级"><a href="#三、配置加载优先级" class="headerlink" title="三、配置加载优先级"></a>三、配置加载优先级</h1><p>参考官方文档<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#boot-features-external-config">Externalized Configuration</a></p>
<p>后加载的会覆盖前面加载的。</p>
<p>根据官方文档，SpringBoot的配置文件可以来自于以下方面，按照从上往下的顺序，其中后加载的会覆盖前面的：</p>
<ul>
<li>Default properties (specified by setting <code>SpringApplication.setDefaultProperties</code>).</li>
<li><code>@PropertySource</code> annotations on your <code>@Configuration</code> classes. Please note that such property sources are not added to the <code>Environment</code> until the application context is being refreshed. This is too late to configure certain properties such as <code>logging.*</code> and <code>spring.main.*</code> which are read before refresh begins.</li>
<li><strong>Config data (such as<code>application.properties</code> files)</strong></li>
<li>A <code>RandomValuePropertySource</code> that has properties only in <code>random.*</code>.</li>
<li>OS environment variables.</li>
<li>Java System properties (<code>System.getProperties()</code>).</li>
<li>JNDI attributes from <code>java:comp/env</code>.</li>
<li><code>ServletContext</code> init parameters.</li>
<li><code>ServletConfig</code> init parameters.</li>
<li>Properties from <code>SPRING_APPLICATION_JSON</code> (inline JSON embedded in an environment variable or system property).</li>
<li><strong>Command line arguments.</strong></li>
<li><code>properties</code> attribute on your tests. Available on <code>@SpringBootTest</code> and the <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-testing-spring-boot-applications-testing-autoconfigured-tests">test annotations for testing a particular slice of your application</a>.</li>
<li><code>@TestPropertySource</code> annotations on your tests.</li>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/using-spring-boot.html#using-boot-devtools-globalsettings">Devtools global settings properties</a> in the <code>$HOME/.config/spring-boot</code> directory when devtools is active.</li>
</ul>
<p>加粗是比较常用的两种。</p>
<h2 id="3-1-外部配置源"><a href="#3-1-外部配置源" class="headerlink" title="3.1 外部配置源"></a>3.1 外部配置源</h2><p>常用：Java属性文件、YAML文件、环境变量、命令行参数；</p>
<h2 id="3-2-配置文件查找位置"><a href="#3-2-配置文件查找位置" class="headerlink" title="3.2 配置文件查找位置"></a>3.2 配置文件查找位置</h2><p>配置文件的查找顺序：</p>
<p>(1) classpath 根路径（Java文件夹和resource文件夹都属于根路径，编译后都位于target根目录下）</p>
<p>(2) classpath 根路径下config目录</p>
<p>(3) jar包当前目录</p>
<p>(4) jar包当前目录的config目录</p>
<p>(5) /config子目录的直接子目录</p>
<h2 id="3-3-配置文件加载顺序："><a href="#3-3-配置文件加载顺序：" class="headerlink" title="3.3 配置文件加载顺序："></a>3.3 配置文件加载顺序：</h2><ol>
<li>　当前jar包内部的application.properties和application.yml</li>
<li><p>　当前jar包内部的application-{profile}.properties 和 application-{profile}.yml</p>
</li>
<li><p>　引用的外部jar包的application.properties和application.yml</p>
</li>
<li>　引用的外部jar包的application-{profile}.properties 和 application-{profile}.yml</li>
</ol>
<h2 id="3-4-总结"><a href="#3-4-总结" class="headerlink" title="3.4 总结"></a>3.4 总结</h2><p>指定环境优先，外部优先，后面的可以覆盖前面的同名配置项。</p>
<h1 id="四、自定义starter"><a href="#四、自定义starter" class="headerlink" title="四、自定义starter"></a>四、自定义starter</h1><h2 id="4-1-starter启动原理"><a href="#4-1-starter启动原理" class="headerlink" title="4.1 starter启动原理"></a>4.1 starter启动原理</h2><p>starter的启动流程：</p>
<p><strong>1、指定要加载的自动配置类</strong></p>
<p>在引入starter后，会加载指定的自动配置类。</p>
<p>SpringBoot的<code>autoconfigure</code>包中，<code>META-INF</code>下的<code>spring.factories</code>文件，使用了 <code>EnableAutoConfiguration</code> 的值指定了项目启动时要加载的自动配置类。如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_5.png"><span class="image-caption">SpringBoot的spring.factories</span></p>
<p><strong>2、自动配置类中指定要加载的类<code>xxxProperties</code></strong></p>
<p>一般来说，自动配置类用于自动注册组件，并使用指定的配置类，进行属性值的注入。</p>
<p>以<code>org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration</code>为例，加载这个自动配置类，这个配置类的声明如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnClass(CacheManager.class)</span><br><span class="hljs-meta">@ConditionalOnBean(CacheAspectSupport.class)</span><br><span class="hljs-meta">@ConditionalOnMissingBean(value = CacheManager.class, name = "cacheResolver")</span><br><span class="hljs-meta">@EnableConfigurationProperties(CacheProperties.class)</span><br><span class="hljs-meta">@AutoConfigureAfter({ CouchbaseDataAutoConfiguration.class, </span><br><span class="hljs-meta">                     HazelcastAutoConfiguration.class,</span><br><span class="hljs-meta">                     HibernateJpaAutoConfiguration.class,</span><br><span class="hljs-meta">                     RedisAutoConfiguration.class })</span><br><span class="hljs-meta">@Import({ CacheConfigurationImportSelector.class, CacheManagerEntityManagerFactoryDependsOnPostProcessor.class })</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheAutoConfiguration</span> </span>{...}<br></code></pre></td></tr></tbody></table></figure>
<p>这个自动配置类使用<code>@EnableConfigurationProperties</code>注解，指定了要加载的配置类<code>CacheProperties</code>。</p>
<p>其余的注解则规定了这个自动配置类的生效条件，比如<code>@ConditionalOnBean</code>、<code>@ConditionalOnMissingBean</code>等注解。例如：<code>@ConditionalOnBean(CacheAspectSupport.class)</code>表示当前容器中有<code>CacheAspectSupport</code>这个类的组件时，当前的自动配置类才生效。</p>
<p><strong>3、xxxProperties中绑定配置文件中的配置属性</strong></p>
<p>这个类中规定了默认值，自动配置组件的值就是从这里取。并且这个类和配置文件绑定，我们可以通过配置文件对默认值进行修改。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ConfigurationProperties(prefix = "spring.cache")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CacheProperties</span> </span>{...}<br></code></pre></td></tr></tbody></table></figure>
<p>比如<code>CacheProperties</code>这个配置类，使用<code>@ConfigurationProperties(prefix = "spring.cache")</code>注解，将配置文件中<code>spring.cache</code>开头的配置项的值，绑定到当前类中对应的属性。</p>
<p>这样，我们在总配置文件中使用<code>spring.cache.xxx=xxx</code>，就可以对cache相关的内容进行配置。</p>
<h2 id="4-2-自定义starter"><a href="#4-2-自定义starter" class="headerlink" title="4.2 自定义starter"></a>4.2 自定义starter</h2><p>仿照官方的starter启动流程，我们可以创建自定义的starter。</p>
<p><strong>1、创建starter和starter-autoconfigure项目</strong></p>
<p>自定义starter需要创建一个starter项目和一个对这个starter自动配置的项目。</p>
<p>如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_6.png" alt=""></p>
<p>自定义的启动器一般是xxx-spring-boot-starter的命名格式，对其自动配置的包一般是xxx-spring-boot-starter-autoconfigure格式。</p>
<p>在启动器中引入自动配置包的依赖，如图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_7.png"><span class="image-caption">启动器中引入自动配置包的依赖</span></p>
<p>这样，我们使用的时候，只需要引入starter就可以使用，它就会自动为我们导入自动配置的依赖包。</p>
<p>我们可以把需要的配置，都在自动配置包中引入依赖。</p>
<p><strong>2、在<code>spring.factories</code>中指定要加载的自动配置类</strong></p>
<p>为了保证我们的自动配置类能自动加载，需要在自动配置包的<code>META-INF/spring.factories</code>文件中，指定项目启动时要加载的自动配置类：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_8.png" alt=""></p>
<p><code>spring.factories</code>中的内容如下：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># Auto Configure</span><br><span class="hljs-meta">org.springframework.boot.autoconfigure.EnableAutoConfiguration</span>=<span class="hljs-string">\</span><br>  <span class="hljs-attr">com.kang.hello.auto.HelloServiceAutoConfiguration</span><br></code></pre></td></tr></tbody></table></figure>
<p>指定项目启动时，会加载<code>com.kang.hello.auto.HelloServiceAutoConfiguration</code>这个配置类。</p>
<p><strong>3、编写xxxAutoConfiguration和xxxProperties和功能类</strong></p>
<p>配置类<code>HelloProperties</code>，对属性值和配置文件中的值进行绑定</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//绑定配置文件中的前缀</span><br><span class="hljs-meta">@ConfigurationProperties(prefix = "kang.hello")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloProperties</span> </span>{<br>    <span class="hljs-keyword">private</span> String prefix;<br>    <span class="hljs-keyword">private</span> String suffix;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getPrefix</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> prefix;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setPrefix</span><span class="hljs-params">(String prefix)</span> </span>{<span class="hljs-keyword">this</span>.prefix = prefix;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSuffix</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> suffix;}<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSuffix</span><span class="hljs-params">(String suffix)</span> </span>{<span class="hljs-keyword">this</span>.suffix = suffix;}<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，项目中在配置文件中使用<code>kang.hello</code>就可以对<code>prefix</code>和<code>suffix</code>进行配置。</p>
<p>自动配置类<code>HelloServiceAutoConfiguration</code>，用于注册组件：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableConfigurationProperties(HelloProperties.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloServiceAutoConfiguration</span> </span>{<br>    <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean(HelloService.class)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> HelloService <span class="hljs-title">helloService</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HelloService();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>当容器中没有<code>HelloService</code>组件时，自动配置类才会注册<code>HelloService</code>组件，并根据<code>HelloProperties</code>中的绑定的值，对<code>HelloProperties</code>中的属性值进行注入。</p>
<p><code>HelloService</code>中定义了自定义启动器要封装的功能方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">默认不要放在容器中</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloService</span> </span>{<br>    <span class="hljs-meta">@Autowired</span>  <span class="hljs-comment">//自动装配配置类</span><br>    HelloProperties helloProperties;<br>    <br>    <span class="hljs-comment">//定义一个方法，在输入参数中添加前缀和后缀</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">sayHello</span><span class="hljs-params">(String userName)</span></span>{<br>        String prefix = helloProperties.getPrefix();<br>        String suffix = helloProperties.getSuffix();<br>        <span class="hljs-keyword">return</span> prefix+<span class="hljs-string">","</span>+userName+<span class="hljs-string">","</span>+suffix;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、将 starter和starter-autoconfigure项目进行打包安装</strong></p>
<p>将自动配置包使用Maven进行install，然后对starter进行install。</p>
<p>这样，我们的自定义启动器就算创建好了，别的项目直接引入自定义的starter依赖就可以使用其中提供的方法了。</p>
<p><strong>5、测试自定义starter</strong></p>
<p>新建一个项目，引入自定义的starter依赖：</p>
<p><code>pom.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.kang<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kang-hello-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>然后在配置类中，使用<code>kang.hello</code>对两个参数进行配置</p>
<p><code>application.properties</code></p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">kang.hello.prefix</span> = <span class="hljs-string">hello</span><br><span class="hljs-meta">kang.hello.suffix</span> = <span class="hljs-string">bye</span><br></code></pre></td></tr></tbody></table></figure>
<p>编写方法，调用starter中定义好的方法完成功能：</p>
<p><code>HelloController</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HelloController</span> </span>{<br>    <span class="hljs-comment">//引入了自定义的启动器，可以使用其提供的方法。</span><br>    <span class="hljs-meta">@Autowired</span><br>    HelloService helloService;<br><br>    <span class="hljs-meta">@GetMapping("/hello")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">sayHello</span><span class="hljs-params">()</span></span>{<br>        String str = helloService.sayHello(<span class="hljs-string">"KANG"</span>);<br>        <span class="hljs-keyword">return</span> str;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，在浏览器中发送<code>hello</code>请求，返回值为：</p>
<figure class="highlight autohotkey"><table><tbody><tr><td class="code"><pre><code class="hljs autohotkey"><span class="hljs-built_in">hello,</span>KANG,bye<br></code></pre></td></tr></tbody></table></figure>
<p>测试成功，说明自定义的启动器没有问题。</p>
<p>上面使用的是自动装配的<code>HelloService</code>，如果我们不希望使用提供的原方法，就可以自定义<code>HelloService</code>，这样，自动配置类不会自动注册<code>HelloService</code>，项目会使用我们自己的<code>HelloService</code>。实现了SpringBoot中的<strong>自定义优先</strong>的情况。</p>
<p>因此，如果我们在使用starter的过程中，如果现有的方法不能满足我们的需求，我们就可以根据源码找到其方法进行重写，这样项目就会使用我们重写之后的方法。</p>
<p>比如我们定义一个配置类，并自己新建一个<code>HelloService</code>对象，通过调用方法实现需求，这时底层使用的就是我们创建的这个对象：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyConfig</span> </span>{<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> HelloService <span class="hljs-title">helloService</span><span class="hljs-params">()</span></span>{<br>        HelloService helloService = <span class="hljs-keyword">new</span> HelloService();<br>        <span class="hljs-comment">//对helloService进行自定义的操作，比如setXxx()</span><br>        <span class="hljs-keyword">return</span> helloService;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、SpringBoot启动原理"><a href="#五、SpringBoot启动原理" class="headerlink" title="五、SpringBoot启动原理"></a>五、SpringBoot启动原理</h1><h2 id="5-1-SpringBoot启动过程"><a href="#5-1-SpringBoot启动过程" class="headerlink" title="5.1 SpringBoot启动过程"></a>5.1 SpringBoot启动过程</h2><p>进入<code>run</code>方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-advance_9.png"><span class="image-caption">run方法代码</span></p>
<p>可以看到主要有两步，创建<code>SpringApplication</code>和运行<code>SpringApplication</code>.</p>
<p><strong>1、创建<code>SpringApplication</code></strong></p>
<p>进入<code>new SpringApplication</code>方法，创建<code>SpringApplication</code>，应用创建的过程，简单来说就是先将一些组件读取到应用中。</p>
<p><code>SpringApplication.java</code>的构造器方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SpringApplication</span><span class="hljs-params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> </span>{<br>    <span class="hljs-comment">//加载一些信息</span><br>    <span class="hljs-keyword">this</span>.resourceLoader = resourceLoader;<br>    <span class="hljs-comment">//判断是否有主配置类信息</span><br>    Assert.notNull(primarySources, <span class="hljs-string">"PrimarySources must not be null"</span>);<br>    <span class="hljs-comment">//保存主配置类信息  class com.kang.boot.Springboot09HelloTestApplication</span><br>    <span class="hljs-keyword">this</span>.primarySources = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));<br>    <span class="hljs-comment">//判断应用类型   Servlet</span><br>    <span class="hljs-keyword">this</span>.webApplicationType = WebApplicationType.deduceFromClasspath();<br>    <span class="hljs-comment">//去spring.factories查找初始启动引导器  null</span><br>    <span class="hljs-keyword">this</span>.bootstrapRegistryInitializers = getBootstrapRegistryInitializersFromSpringFactories();<br>    <span class="hljs-comment">//去spring.factories查找ApplicationContextInitializer  找到n个</span><br>    setInitializers((Collection) getSpringFactoriesInstances(ApplicationContextInitializer.class));<br>    <span class="hljs-comment">//去spring.factories查找监听器  找到n个</span><br>    setListeners((Collection) getSpringFactoriesInstances(ApplicationListener.class));<br>    <span class="hljs-comment">//查找主程序  class com.kang.boot.Springboot09HelloTestApplication</span><br>    <span class="hljs-keyword">this</span>.mainApplicationClass = deduceMainApplicationClass();<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>主要步骤总结如下：</p>
<ul>
<li>用于保存一些信息。</li>
<li><p>判定当前应用的类型。内部使用了ClassUtils工具类。判断结果为Servlet类型</p>
</li>
<li><p><code>bootstrapRegistryInitializers</code>：初始启动引导器注册初始化，其内部通过<code>SpringFactoriesLoader</code>去<code>spring.factories</code>文件中找<strong><code>org.springframework.boot.Bootstrapper</code></strong>，即查看是否有初始的启动引导器。</p>
</li>
<li>去<code>spring.factories</code>文件找 <strong><code>ApplicationContextInitializer</code></strong>，即<code>ApplicationContext</code>初始化器<ul>
<li>结果保存到：List<applicationcontextinitializer<?>&gt; initializers</applicationcontextinitializer<?></li>
</ul>
</li>
<li>去<code>spring.factories</code>找<strong><code>ApplicationListener</code>，即应用监听器</strong><ul>
<li>将结果保存到：List<applicationlistener<?>&gt; listeners</applicationlistener<?></li>
</ul>
</li>
<li>查找主程序，找到第一个main方法就是主程序。</li>
</ul>
<p><strong>2、运行 <code>SpringApplication</code></strong></p>
<p>创建完<code>SpringApplication</code>之后，执行<code>run()</code>方法。</p>
<p><code>SpringApplication.java</code>的<code>run()</code>方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> ConfigurableApplicationContext <span class="hljs-title">run</span><span class="hljs-params">(String... args)</span> </span>{<br>    <span class="hljs-comment">//stopWatch用于监听整个应用程序的启动和停止</span><br>    StopWatch stopWatch = <span class="hljs-keyword">new</span> StopWatch();<br>    <span class="hljs-comment">//启动stopWatch，记录应用的启动时间</span><br>    stopWatch.start();<br>    <span class="hljs-comment">//创建引导上下文</span><br>    DefaultBootstrapContext bootstrapContext = createBootstrapContext();<br>    ConfigurableApplicationContext context = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-comment">//让当前应用进入Headless模式 java.awt.headless</span><br>    configureHeadlessProperty();<br>    <span class="hljs-comment">//获取所有的运行监听器</span><br>    SpringApplicationRunListeners listeners = getRunListeners(args);<br>    <span class="hljs-comment">//starting方法调用了所有监听器的starting方法</span><br>    listeners.starting(bootstrapContext, <span class="hljs-keyword">this</span>.mainApplicationClass);<br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">//保存命令行参数</span><br>        ApplicationArguments applicationArguments = <span class="hljs-keyword">new</span> DefaultApplicationArguments(args);<br>        <span class="hljs-comment">//准备环境</span><br>        ConfigurableEnvironment environment = prepareEnvironment(listeners, <br>                                                                 bootstrapContext, <br>                                                                 applicationArguments);<br>        configureIgnoreBeanInfo(environment);<br>        <span class="hljs-comment">//打印banner，即运行程序的SPRING的ASCII码图案</span><br>        Banner printedBanner = printBanner(environment);<br>        <span class="hljs-comment">//创建IOC容器</span><br>        context = createApplicationContext();<br>        <span class="hljs-comment">//容器保存当前项目的startup信息</span><br>        context.setApplicationStartup(<span class="hljs-keyword">this</span>.applicationStartup);<br>        <span class="hljs-comment">//准备IOC容器的基本信息</span><br>        prepareContext(bootstrapContext, context, environment, listeners, <br>                       applicationArguments, printedBanner);<br>        <span class="hljs-comment">//刷新IOC容器</span><br>        refreshContext(context);<br>        <span class="hljs-comment">//刷新之后的工作</span><br>        afterRefresh(context, applicationArguments);<br>        <span class="hljs-comment">//关闭stopWatch，计算出应用启动花费的时间</span><br>        stopWatch.stop();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.logStartupInfo) {<br>            <span class="hljs-keyword">new</span> StartupInfoLogger(<span class="hljs-keyword">this</span>.mainApplicationClass).logStarted(getApplicationLog(), <br>                                                                        stopWatch);<br>        }<br>        <span class="hljs-comment">//通知所有的监听器的started方法</span><br>        listeners.started(context);<br>        <span class="hljs-comment">//调用所有runners</span><br>        callRunners(context, applicationArguments);<br>    }<br>    <span class="hljs-keyword">catch</span> (Throwable ex) {<br>        <span class="hljs-comment">//如果有异常，会调用监听器的failed()方法</span><br>        handleRunFailure(context, ex, listeners);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(ex);<br>    }<br><br>    <span class="hljs-keyword">try</span> {<br>        <span class="hljs-comment">//调用监听器的running方法</span><br>        listeners.running(context);<br>    }<br>    <span class="hljs-keyword">catch</span> (Throwable ex) {<br>        handleRunFailure(context, ex, <span class="hljs-keyword">null</span>);<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(ex);<br>    }<br>    <span class="hljs-comment">//最后返回容器</span><br>    <span class="hljs-keyword">return</span> context;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>run()</code>方法的主要步骤如下：</p>
<ul>
<li><p>创建<code>StopWatch</code>对象并启动，其记录了应用的启动时间。</p>
</li>
<li><p>创建引导上下文（Context环境）—-<code>createBootstrapContext()</code></p>
<ul>
<li>获取到所有之前的 bootstrappers， 依次执行 intitialize() ，来完成对引导启动器上下文环境设置</li>
</ul>
</li>
<li><p>让当前应用进入<code>headless</code>模式，即<code>java.awt.headless</code>(自力更生模式)</p>
</li>
<li><p>获取所有<code>RunListener</code>（运行监听器），为了方便所有Listener进行事件感知。</p>
<ul>
<li>去<code>spring.factories</code>文件中找<strong><code>SpringApplicationRunListener</code>， </strong>比如<code>EventPublishRunListenr</code></li>
</ul>
</li>
<li><p>遍历所有的<code>SpringApplicationRunListener</code>调用其<code>starting()</code>方法；相当于通知所有感兴趣系统正在启动过程的监听器，项目正在 <code>starting</code>。</p>
</li>
<li><p>保存命令行参数—-<code>ApplicationArguments</code></p>
</li>
<li><p>准备环境—-<code>prepareEnvironment()</code>;</p>
<ul>
<li>返回或者创建基础环境信息对象—-<code>StandardServletEnvironment</code></li>
<li>配置环境信息对象。<ul>
<li>读取所有的配置源的配置属性值。</li>
</ul>
</li>
<li>绑定环境信息</li>
<li>监听器调用 <code>environmentPrepared()</code>，通知所有的监听器当前环境准备完成。</li>
</ul>
</li>
<li><p><strong>创建IOC容器</strong> —-<code>createApplicationContext()</code></p>
<ul>
<li><p>根据项目类型创建容器。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">try</span> {<br>    <span class="hljs-keyword">switch</span> (webApplicationType) {<br>        <span class="hljs-keyword">case</span> SERVLET:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnnotationConfigServletWebServerApplicationContext();<br>        <span class="hljs-keyword">case</span> REACTIVE:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnnotationConfigReactiveWebServerApplicationContext();<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>比如当前类型为servlet，则创建 <code>AnnotationConfigServletWebServerApplicationContext</code></p>
</li>
</ul>
</li>
<li><p><strong>准备 IOC容器的基本信息</strong>  —-<code>prepareContext()</code></p>
<ul>
<li>保存环境信息</li>
<li>IOC容器的后置处理流程。</li>
<li>应用初始化器—<code>applyInitializers</code>；<ul>
<li>遍历所有的 <code>ApplicationContextInitializer</code>。就是创建<code>SpringApplication</code>时找到的那些初始化器。然后调用它们的<code>initialize</code>方法，来对ioc容器进行初始化扩展功能。</li>
</ul>
</li>
<li>遍历所有的 listener，即第一步中查找到的监听器，内部调用每个监听器的 <code>contextPrepared()</code>，表示IOC容器准备完成。</li>
<li>这个方法最后，所有的监听器调用<code>contextLoaded()</code>，即通知所有的监听器IOC容器加载完毕。</li>
</ul>
</li>
<li><p><strong>刷新IOC容器。</strong>refreshContext</p>
<ul>
<li>创建容器中的所有组件（即Spring的运行原理）</li>
</ul>
</li>
<li><p>容器刷新完成后工作 —- <code>afterRefresh()</code></p>
</li>
<li><p>调用<code>started</code>方法，调用所有监听器的<code>started</code>方法，即通知所有监听器start结束。</p>
</li>
<li><p>调用所有runners —- <code>callRunners()</code></p>
<ul>
<li>获取容器中的<strong><code>ApplicationRunner</code></strong></li>
<li>获取容器中的<strong><code>CommandLineRunner</code></strong></li>
<li>合并所有runner并且按照@Order进行排序</li>
<li>遍历所有的runner，调用 run方法</li>
</ul>
</li>
<li><p>如果以上有异常，调用Listener 的<code>failed()</code>方法，表示启动失败了。</p>
</li>
<li><p>调用所有监听器的<code>running</code>方法 —-<code>listeners.running(context);</code>，通知所有的监听器，容器正在运行。</p>
<ul>
<li>如果<code>running</code>有问题，继续通知<code>failed()</code> 。调用所有 Listener 的<code>failed()</code>，通知所有的监听器。</li>
</ul>
</li>
</ul>
<h2 id="5-2-Application-Events-and-Listeners"><a href="#5-2-Application-Events-and-Listeners" class="headerlink" title="5.2 Application Events and Listeners"></a>5.2 Application Events and Listeners</h2><p>SpringApplication有独特的<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/spring-boot-features.html#boot-features-application-events-and-listeners">事件和监听器</a>，根据SpringBoot的启动过程，我们可以使用他们在启动过程中做一些额外的事情：</p>
<ul>
<li><strong>ApplicationContextInitializer</strong></li>
<li><strong>ApplicationListener</strong></li>
<li><strong>SpringApplicationRunListener</strong>：在IOC容器的各个阶段做一些事情，一共有七种状态，表示IOC容器的不同阶段，不同阶段的容器具备的功能也是不同的。根据这个特征可以定制化一些功能。</li>
</ul>
<p>实现代码举例：</p>
<p><code>MyApplicationContextInitializer</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApplicationContextInitializer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationContextInitializer</span> </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initialize</span><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span> </span>{<br>        <span class="hljs-comment">//do something</span><br>        System.out.println(<span class="hljs-string">"MyApplicationContextInitializer...initialize..."</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>MyApplicationListener</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApplicationListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationListener</span> </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onApplicationEvent</span><span class="hljs-params">(ApplicationEvent event)</span> </span>{<br>        <span class="hljs-comment">//do something</span><br>        System.out.println(<span class="hljs-string">"MyApplicationListener...onApplicationEvent..."</span>);<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure>
<p><code>MySpringApplicationRunListener</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MySpringApplicationRunListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SpringApplicationRunListener</span> </span>{<br><br>    <span class="hljs-keyword">private</span> SpringApplication application;<br>    <span class="hljs-comment">//注意：这里需要一个有参构造器</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">MySpringApplicationRunListener</span><span class="hljs-params">(SpringApplication application,</span></span><br><span class="hljs-function"><span class="hljs-params">                                          String [] args)</span></span>{<br>        <span class="hljs-keyword">this</span>.application = application;<br><br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">starting</span><span class="hljs-params">(ConfigurableBootstrapContext bootstrapContext)</span> </span>{<br>        System.out.println(<span class="hljs-string">"MySpringApplicationRunListener...starting..."</span>);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">environmentPrepared</span><span class="hljs-params">(ConfigurableBootstrapContext bootstrapContext,</span></span><br><span class="hljs-function"><span class="hljs-params">                                    ConfigurableEnvironment environment)</span> </span>{<br>        System.out.println(<span class="hljs-string">"MySpringApplicationRunListener...environmentPrepared..."</span>);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextPrepared</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> </span>{<br>        System.out.println(<span class="hljs-string">"MySpringApplicationRunListener...contextPrepared..."</span>);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextLoaded</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> </span>{<br>        System.out.println(<span class="hljs-string">"MySpringApplicationRunListener...contextLoaded..."</span>);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">started</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> </span>{<br>        System.out.println(<span class="hljs-string">"MySpringApplicationRunListener...started..."</span>);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">running</span><span class="hljs-params">(ConfigurableApplicationContext context)</span> </span>{<br>        System.out.println(<span class="hljs-string">"MySpringApplicationRunListener...running..."</span>);<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">failed</span><span class="hljs-params">(ConfigurableApplicationContext context, Throwable exception)</span> </span>{<br>        System.out.println(<span class="hljs-string">"MySpringApplicationRunListener...failed..."</span>);<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure>
<p>此外，由于<code>ApplicationContextInitializer</code>,<code>ApplicationListener</code>,<code>SpringApplicationRunListener</code>都需要在<code>spring.factories</code>文件中找，因此我们需要在这个文件中配置他们：</p>
<p><code>resources/META-INF/spring.factories</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"># Initializers<br>org.springframework.context.ApplicationContextInitializer=\<br>  com.kang.boot.listener.MyApplicationContextInitializer<br><br># Application Listeners<br>org.springframework.context.ApplicationListener=\<br>  com.kang.boot.listener.MyApplicationListener<br><br>org.springframework.boot.SpringApplicationRunListener=\<br>  com.kang.boot.listener.MySpringApplicationRunListener<br></code></pre></td></tr></tbody></table></figure>
<h2 id="5-3-ApplicationRunner和CommandLineRunner"><a href="#5-3-ApplicationRunner和CommandLineRunner" class="headerlink" title="5.3 ApplicationRunner和CommandLineRunner"></a>5.3 ApplicationRunner和CommandLineRunner</h2><p><code>ApplicationRunner</code>和<code>CommandLineRunner</code>都是在IOC容器中获取的，因此我们需要将它们注册为组件。</p>
<p><code>MyApplicationRunner</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyApplicationRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ApplicationRunner</span> </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(ApplicationArguments args)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        System.out.println(<span class="hljs-string">"MyApplicationRunner...run"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>MyCommandLineRunner</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">应用一启动，做一个一次性的事情</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCommandLineRunner</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">CommandLineRunner</span> </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">(String... args)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        System.out.println(<span class="hljs-string">"MyCommandLineRunner...run..."</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，启动主程序，可以看到运行结果，和我们分析的SpringBoot启动过程是一样的：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">MyApplicationListener...onApplicationEvent...<br>MySpringApplicationRunListener...starting...<br>MyApplicationListener...onApplicationEvent...<br>MySpringApplicationRunListener...environmentPrepared...<br><br>  .   ____          _            __ _ _<br> /\\ / ___<span class="hljs-string">'_ __ _ _(_)_ __  __ _ \ \ \ \</span><br><span class="hljs-string">( ( )\___ | '</span>_ | <span class="hljs-string">'_| | '</span>_ \/ _` | \ \ \ \<br> \\/  ___)| |_)| | | | | || (_| |  ) ) ) )<br>  <span class="hljs-string">'  |____| .__|_| |_|_| |_\__, | / / / /</span><br><span class="hljs-string"> =========|_|==============|___/=/_/_/_/</span><br><span class="hljs-string"> :: Spring Boot ::                (v2.5.2)</span><br><span class="hljs-string"></span><br><span class="hljs-string">MyApplicationContextInitializer...initialize...</span><br><span class="hljs-string">MyApplicationListener...onApplicationEvent...</span><br><span class="hljs-string">MySpringApplicationRunListener...contextPrepared...</span><br><span class="hljs-string">Starting Springboot09HelloTestApplication</span><br><span class="hljs-string">No active profile set, falling back to default profiles: default</span><br><span class="hljs-string">MyApplicationListener...onApplicationEvent...</span><br><span class="hljs-string">MySpringApplicationRunListener...contextLoaded...</span><br><span class="hljs-string">Tomcat initialized with port(s): 8080 (http)</span><br><span class="hljs-string">Starting service [Tomcat]</span><br><span class="hljs-string">Starting Servlet engine: [Apache Tomcat/9.0.48]</span><br><span class="hljs-string">Initializing Spring embedded WebApplicationContext</span><br><span class="hljs-string">Root WebApplicationContext: initialization completed in 2013 ms</span><br><span class="hljs-string">Tomcat started on port(s): 8080 (http) with context path '</span><span class="hljs-string">'</span><br><span class="hljs-string">MyApplicationListener...onApplicationEvent...</span><br><span class="hljs-string">MyApplicationListener...onApplicationEvent...</span><br><span class="hljs-string">Started Springboot09HelloTestApplication in 3.645 seconds (JVM running for 7.097)</span><br><span class="hljs-string">MyApplicationListener...onApplicationEvent...</span><br><span class="hljs-string">MyApplicationListener...onApplicationEvent...</span><br><span class="hljs-string">MySpringApplicationRunListener...started...</span><br><span class="hljs-string">MyApplicationRunner...run</span><br><span class="hljs-string">MyCommandLineRunner...run...</span><br><span class="hljs-string">MyApplicationListener...onApplicationEvent...</span><br><span class="hljs-string">MyApplicationListener...onApplicationEvent...</span><br><span class="hljs-string">MySpringApplicationRunListener...running...</span><br></code></pre></td></tr></tbody></table></figure>
]]></content>
      <categories>
        <category>SpringBoot2</category>
      </categories>
      <tags>
        <tag>SpringBoot2</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络汇总</title>
    <url>/2021/05/19/computer-network-review/</url>
    <content><![CDATA[<h1 id="一、网络分层模型"><a href="#一、网络分层模型" class="headerlink" title="一、网络分层模型"></a>一、网络分层模型</h1><h2 id="1、总体概述"><a href="#1、总体概述" class="headerlink" title="1、总体概述"></a>1、总体概述</h2><p>OSI的七层模型和TCP/IP的四层模型：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_1.png"><span class="image-caption">OSI的七层模型和TCP/IP的四层模型</span></p>
<h2 id="2、各层概述"><a href="#2、各层概述" class="headerlink" title="2、各层概述"></a>2、各层概述</h2><h3 id="物理层"><a href="#物理层" class="headerlink" title="物理层"></a>物理层</h3><p><strong>物理层主要解决用何种信号传输比特0和1的问题。</strong></p>
<p>物理层考虑的是怎样才能在连接各种计算机的传输媒体上传输数据比特流。物理层为数据链路层屏蔽了各种传输媒体的差异，使数据链路层只需要考虑如何完成本层的协议和服务，而不必考虑网络具体的传输媒体是什么。</p>
<p>物理层协议的主要任务：机械特性、电气特性、功能特性、过程特性。</p>
<p><strong>传输数据格式</strong>：比特流</p>
<p><strong>主要协议</strong>：RJ45、CLOCK</p>
<p><strong>涉及设备</strong>：中继器；集线器；网关</p>
<p><strong>涉及技术</strong>：编码与调制、信道复用</p>
<h3 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h3><p><strong>数据链路层主要解决分组在一个网络（或一段链路）上传输的问题。</strong></p>
<p>涉及<strong>MAC地址</strong>及<strong>网卡地址</strong>。当一台设备连接到路由器，路由器连接到光猫上，而光猫则连通电信网络。当你从这台设备发出信息时，首先数据到达路由器，在通过路由器数据到达光猫，然后到达电信公网。在数据从设备到达路由器这一过程中是通过识别MAC地址完成的。也就是从一个节点到达另一个节点。而IP则是直接标识源和目的地。(即你的设备地址，和你所发送的设备地址)。</p>
<p><strong>传输数据格式</strong>：帧（framing），在上层交付的数据单元添加帧头和帧尾，构成数据帧。</p>
<p><strong>主要协议</strong>：PPP、FR、HDLC、VLAN、MAC 、CSMA/CD（载波监听多址接入/碰撞检测）</p>
<p><strong>涉及设备</strong>：网桥；交换机</p>
<blockquote>
<p>集线器（HUB）和交换机（SWITCH）的区别：</p>
<p>1.集线器是早期的以太网互联设备，已被淘汰，现使用交换机替代。</p>
<p>2.集线器工作在物理层；交换机工作在数据链路层和物理层</p>
<p>3.集线器对收到的信号进行放大、转发；交换机根据MAC地址，对帧进行转发</p>
<p>4.使用集线器作为互连设备的以太网仍然属于共享总线式以太网。集线器互连起来的所有主机共享总线带宽，属于同一个碰撞域和广播域；使用交换机作为互连设备的以太网，称为交换式以太网。交换机可以根据MAC地址过滤帧，即隔离碰撞域。</p>
<p>5.交换机的每个接口是一个独立的碰撞域；交换机隔离碰撞域但不隔离广播域(VLAN除外)</p>
</blockquote>
<p><strong>涉及技术</strong>：封装成帧、差错控制、可靠传输；媒体接入控制；虚拟局域网VLAN（使用交换机划分VLAN）</p>
<ul>
<li>封装成帧：数据链路层给上层交付的协议数据单元添加帧头和帧尾使之成为帧。<strong>数据链路层对上层交付的传输数据没有任何限制</strong>，好像数据链路层不存在一样，这称为透明传输。</li>
<li>差错控制：奇偶校验、循环冗余校验（CRC）</li>
<li>可靠传输：使用<strong>停止-等待协议SW</strong>、<strong>回退N帧协议GBN</strong>、<strong>选择重传协议SR</strong>三种可靠协议实现可靠传输</li>
</ul>
<h3 id="网络层"><a href="#网络层" class="headerlink" title="网络层"></a>网络层</h3><p><strong>网络层主要解决在多个网络上传输（路由）的问题。</strong></p>
<p>网络层的主要任务是<strong>实现网络互连</strong>，进而<strong>实现数据包在各网络之间的传输</strong>，这一层开始实现<strong>设备到设备之间的通信</strong>。</p>
<blockquote>
<p>网络层提供的是无连接、不可靠的数据报服务，可靠通信应当由用户主机来保证。</p>
</blockquote>
<p><strong>传输数据格式</strong>：IP数据报</p>
<p><strong>主要协议</strong>：IP、ICMP、ARP（根据IP地址获取MAC地址）、RARP、路由选择协议（RIP、OSPF、BGP）</p>
<blockquote>
<p>路由器和交换机的区别：路由器可以隔离广播域和冲突域，交换机只能隔离冲突域。</p>
</blockquote>
<p><strong>涉及设备</strong>：路由器（ROUTER），路由器涉及到网络层及以下的各层。</p>
<p><strong>涉及技术</strong>：IP地址，路由选择，虚拟专用网VPN，网络地址转换NAT</p>
<h3 id="运输层"><a href="#运输层" class="headerlink" title="运输层"></a>运输层</h3><p><strong>运输层主要解决进程之间基于网络的通信问题</strong>。</p>
<p>（1）运输层为应用程序提供<strong>端口</strong>供应用层使用，运输层的协议又称为端到端协议。</p>
<p>（2）当传输较大的文件时会将文件分段，那么为了保证这些数据正常的顺序，还要对数据进行<strong>重组</strong>，包括流量控制、差错控制，这些都由传输层完成控制。</p>
<p><strong>传输数据格式</strong>：UDP用户数据报/TCP报文段</p>
<p><strong>主要协议</strong>：TCP、UDP、SPX</p>
<p><strong>涉及技术</strong>：端口号，TCP的流量控制、拥塞控制、连接的建立和释放（三次握手和四次挥手）</p>
<h3 id="会话层"><a href="#会话层" class="headerlink" title="会话层"></a>会话层</h3><p><strong>会话层解决进程之间进行会话问题</strong></p>
<p>会将不同的应用程序的<strong>数据隔离</strong>起来。比如QQ与微信的隔离，使两个应用程序之间的数据进行隔离，防止串流。当然，如果想要共享两个软件之间的数据，可以通过应用层对应的接口进行共享。</p>
<p><strong>主要协议</strong>：NFS、SQL、NETBIOS、RPC</p>
<h3 id="表示层"><a href="#表示层" class="headerlink" title="表示层"></a>表示层</h3><p><strong>表示层解决通信双方交互信息的表示问题</strong></p>
<p>对应用<strong>数据转换</strong>。比如在QQ聊天时，音频通过对应软件的接口，传递给声卡，声卡把这些数据进行一个编码，变成比特数据传送到另一个人的设备上，然后在这台设备进行解码转化成语音。</p>
<p><strong>主要协议：</strong>JPEG、MPEG、ASII</p>
<h3 id="应用层"><a href="#应用层" class="headerlink" title="应用层"></a>应用层</h3><p><strong>应用层解决通过应用进程之间的交互来实现特定网络应用的问题</strong></p>
<p>最接近用户的一层。<strong>提供接口</strong>，使应用程序能够使用一些网络协议。</p>
<p><strong>传输数据格式</strong>：数据包/HTTP请求报文</p>
<p><strong>主要协议：</strong>HTTP、FTP、DNS、DHCP、Telnet、SMTP、POP3、 WWW、NFS</p>
<p><strong>设计技术</strong>：域名、HTTP、文件传送协议FTP、电子邮件、万维网WWW</p>
<h1 id="二、知识点详解"><a href="#二、知识点详解" class="headerlink" title="二、知识点详解"></a>二、知识点详解</h1><h2 id="1、网络层"><a href="#1、网络层" class="headerlink" title="1、网络层"></a>1、网络层</h2><h3 id="ICMP协议"><a href="#ICMP协议" class="headerlink" title="ICMP协议"></a>ICMP协议</h3><p>ICMP（Internet Control Message Protocol），网际控制报文协议。为了更有效地转发IP数据报和提高交付成功的机会，在网际层使用ICMP协议。</p>
<p>主机或路由器使用ICMP来发送<strong>差错报告报文</strong>和<strong>询问报文</strong>。ICMP报文被封装在IP数据报中发送。</p>
<p>ICMP是IPv4协议族中的一个子协议，用于IP主机、路由器之间传递控制消息。</p>
<p><strong>ICMP差错报告报文</strong>有以下五种：</p>
<ul>
<li>终点不可达：当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。具体可再根据ICMP的代码字段细分为目的网络不可达、目的主机不可达、目的协议不可达、目的端口不可达、目的网络未知、目的主机为止等13种错误。</li>
<li>源点抑制：当路由器或主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。</li>
<li>时间超过：当路由器收到一个目的IP地址不是自己的IP数据报，会将其生存时间TTL字段的值减1，若结果不为0，则将该IP数据报转发出去；若结果为0，除丢弃该IP数据报外，还要向源点发送时间超过报文。另外，当终点在预先规定时间内不能收到一个数据报的全部数据报片时，就把已收到的数据报片都丢弃，也会向源点发送时间超过报文。</li>
<li>参数问题：当路由器或目的主机收到IP数据报后，根据其首部中的检验和字段发现首部在传输过程中出现了误码，就丢弃该数据报，并向源点发送参数问题报文。</li>
<li>改变路由（重定向）：路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器（可通过更好的路由）。</li>
</ul>
<p><strong>ICMP询问报文</strong>有两种：</p>
<ul>
<li>回送请求和回答：ICMP回送请求报文是由主机或路由器向一个特定的目的主机发出的询问。收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文。这种询问报文<strong>用来测试目的站是否可达</strong>及了解其有关状态。</li>
<li>时间戳请求和回答：ICMP时间戳请求报文是请某个主机或路由器回答当前的日期和时间。在ICMP时间戳回答报文中有一个32位的字段，其中写入的整数代表从1900年1月1日起到当前时刻一共有多少秒。这种询问报文用来<strong>进行时钟同步和测量时间</strong>。</li>
</ul>
<p><strong>ICMP报文信息</strong>：</p>
<p>ICMP报文包含在IP数据报中，IP报头在ICMP报文的最前面。一个ICMP报文包括IP报头（至少20字节）、ICMP报头（至少8字节）和ICMP报文（属于ICMP报文的数据部分）。当IP报头中的协议字段值为1时，就说明这是一个ICMP报文。ICMP报头如下图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_2.png"><span class="image-caption">ICMP报头格式</span></p>
<p><strong>各字段说明</strong></p>
<ul>
<li><strong>类型</strong>：占一字节，标识ICMP报文的类型，目前已定义了14种，从类型值来看ICMP报文可以分为两大类。第一类是取值为1~127的<strong>差错报文</strong>，第2类是取值128以上的<strong>信息报文</strong>。</li>
<li><strong>代码</strong>：占一字节，标识对应ICMP报文的代码。它与类型字段一起共同标识了ICMP报文的详细类型。</li>
<li><strong>校验和</strong>：这是对包括ICMP报文数据部分在内的整个ICMP数据报的校验和，以检验报文在传输过程中是否出现了差错。其计算方法与在我们介绍IP报头中的校验和计算方法是一样的。</li>
<li><strong>标识</strong>：占两字节，用于标识本ICMP进程，但仅适用于回显请求和应答ICMP报文，对于目标不可达ICMP报文和超时ICMP报文等，该字段的值为0。</li>
</ul>
<h2 id="2、传输层"><a href="#2、传输层" class="headerlink" title="2、传输层"></a>2、传输层</h2><p>TCP和UDP对应的应用层协议和端口号如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_3.png"><span class="image-caption">TCP/IP体系的应用层常用协议所使用的运输层熟知端口号</span></p>
<h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p><strong>TCP（控制传输协议）</strong>，是一种面向连接的、可靠的、基于字节流的传输层通信协议。是为了在不可靠的互联网络上提供可靠的端到端字节流而专门设计的一个传输协议。</p>
<h4 id="TCP报头信息"><a href="#TCP报头信息" class="headerlink" title="TCP报头信息"></a>TCP报头信息</h4><p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_4.png"><span class="image-caption">TCP报头信息</span></p>
<p><strong>TCP报文是TCP层传输的数据单元，也叫报文段。</strong>TCP在发送数据时，从发送缓存中取出一部分或全部字节并给其添加一个首部使之成为TCP报文段后进行发送：</p>
<ul>
<li>TCP报文段由首部和数据载荷两部分构成。</li>
<li>TCP的全部功能都体现在它首部中各字段的作用。</li>
</ul>
<p><strong>TCP报文段的首部内容</strong>：</p>
<ul>
<li><p><strong>端口号</strong>：用来标识同一台计算机的不同的应用进程。</p>
<ul>
<li><strong>源端口</strong>：占16比特，源端口用来标识发送该TCP报文段的应用进程，即报文的返回地址。</li>
<li><strong>目的端口</strong>：占16比特，目的端口指明接收方计算机上的应用程序接口。</li>
</ul>
<blockquote>
<p>TCP报头中的源端口号和目的端口号，与IP数据报中的源IP和目的IP唯一确定一条TCP连接。</p>
</blockquote>
</li>
<li><p><strong>序号和确认号</strong>：占32比特，是TCP可靠传输的关键部分。<strong>序号</strong>是本报文段发送的数据组的第一个字节的序号。在TCP传送的流中，每一个字节一个序号。比如一个报文段的序号为300，此报文段数据部分共有100字节，则下一个报文段的序号为400。所以序号确保了TCP传输的有序性。<strong>确认号</strong>占32bit，即ACK，指明期待收到的下一个字节序号的值，同时也是对之前收到的所有数据的确认。比如N表明序号N之前的所有数据已经正确无误的收到。确认号只有当ACK标志为1时才有效。比如建立连接时，SYN报文的ACK标志位为0。</p>
<blockquote>
<p>TCP规定，连接建立后，所有传送的TCP报文段都必须把ACK置为1</p>
</blockquote>
</li>
<li><p><strong>数据偏移／首部长度</strong>：占4比特，并以4字节为单位。用来指出数据载荷部分的起始处距离TCP报文段的起始处有多远。首部长度也叫数据偏移，是因为首部长度实际上指示了数据区在报文段中的起始偏移值（最小为0101，最大为1111）。由于首部可能含有可选项内容，因此TCP报头的长度是不确定的，报头不包含任何任选字段则长度为20字节，4位首部长度字段所能表示的最大值为1111，转化为10进制为15，15*4B= 60B，故报头最大长度为60字节。</p>
</li>
<li><p><strong>保留</strong>：占6比特，为将来定义新的用途保留，现在一般置0。</p>
</li>
<li><p><strong>控制位</strong>：URG  ACK  PSH  RST  SYN  FIN，共6个，每一个标志位表示一个控制功能。</p>
<ul>
<li><strong>URG</strong>：紧急指针标志，为1时表示紧急指针有效，为0则忽略紧急指针。</li>
<li><strong>ACK</strong>：确认序号标志，为1时表示确认号有效，为0表示报文中不含确认信息，忽略确认号字段。</li>
<li><strong>PSH</strong>：push标志位，为1表示是带有push标志的数据，指示接收方在接收到该报文段以后，应尽快将这个报文段交给应用程序，而不是在缓冲区排队。</li>
<li><strong>RST</strong>：重置连接标志，置为1时，用于重置由于主机崩溃或其他原因而出现错误的连接，或者用于拒绝非法的报文段和拒绝连接请求。</li>
<li><strong>SYN</strong>：同步序号，用于建立连接过程，在连接请求中，SYN=1和ACK=0表示该数据段没有使用捎带的确认域，而连接应答捎带一个确认，即SYN=1和ACK=1。</li>
<li><strong>FIN</strong>：finish标志，用于释放连接，为1时表示发送方已经没有数据发送了，即关闭本方数据流。</li>
</ul>
</li>
<li><p><strong>窗口</strong>：占16比特，滑动窗口大小，指发送端的接受窗口大小，窗口值作为接收方让发送方设置其发送窗口的依据，以此控制发送端发送数据的速率，从而达到流量控制。窗口最大为65535。</p>
</li>
<li><p><strong>校验和</strong>：占16比特，奇偶校验，此校验和是对整个的 <em>TCP</em> 报文段，包括 <em>TCP</em> 头部和 <em>TCP</em> 数据。由发送端计算和存储，并由接收端进行验证。</p>
</li>
<li><p><strong>紧急指针</strong>：占16比特，只有当 <em>URG</em> 标志置 <em>1</em> 时紧急指针才有效。紧急指针是一个正的偏移量，表明本报文字段数据载荷部分包含了多长的紧急数据。 <em>TCP</em> 的紧急方式是发送端向另一端发送紧急数据的一种方式。</p>
</li>
<li><p><strong>选项和填充</strong>：选项长度不一定是32位的整数倍，所以要加填充位，即在这个字段中加入额外的零，以保证TCP头是32的整数倍。常见的选项有：</p>
<ul>
<li>最长报文段长度，又称为MSS（Maximum Segment Size），每个连接方通常都在通信的第一个报文段（为建立连接而设置SYN标志为1的那个段）中指明这个选项，它表示本端所能接受的最大报文段的长度。</li>
<li>窗口扩大选项：为了扩大窗口，提高吞吐率</li>
<li>时间戳选项：用于计算往返时间RTT；用于处理序号超出范围的情况，又称为防止序号绕回PAWS</li>
<li>选择确认选项：用于实现选择确认功能。</li>
</ul>
</li>
<li><p><strong>数据部分</strong>： <em>TCP</em> 报文段中的数据部分是可选的。在一个连接建立和一个连接终止时，双方交换的报文段仅有 <em>TCP</em> 首部。如果一方没有数据要发送，也使用没有任何数据的首部来确认收到的数据。在处理超时的许多情况中，也会发送不带任何数据的报文段。</p>
</li>
</ul>
<h4 id="TCP元组"><a href="#TCP元组" class="headerlink" title="TCP元组"></a>TCP元组</h4><p>这些元组主要是用于<strong>端口复用</strong>的，对于一个连接来说，只要其中一个存在不同则可以区别这是一个不同的连接。</p>
<p><strong>四元组</strong>：</p>
<figure class="highlight armasm"><table><tbody><tr><td class="code"><pre><code class="hljs armasm">源<span class="hljs-built_in">IP</span>地址、目的<span class="hljs-built_in">IP</span>地址、源端口、目的端口<br></code></pre></td></tr></tbody></table></figure>
<p><strong>五元组</strong>:</p>
<figure class="highlight armasm"><table><tbody><tr><td class="code"><pre><code class="hljs armasm">源<span class="hljs-built_in">IP</span>地址、目的<span class="hljs-built_in">IP</span>地址、协议号、源端口、目的端口<br></code></pre></td></tr></tbody></table></figure>
<p><strong>七元组</strong>:</p>
<figure class="highlight armasm"><table><tbody><tr><td class="code"><pre><code class="hljs armasm">源<span class="hljs-built_in">IP</span>地址、目的<span class="hljs-built_in">IP</span>地址、协议号、源端口、目的端口，服务类型以及接口索引<br></code></pre></td></tr></tbody></table></figure>
<h4 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h4><p>主动发起连接建立的应用进程叫做TCP客户端。</p>
<p>被动等待连接建立的应用进程叫做TCP服务端。</p>
<p>（1）<strong>第一次握手：</strong>客户端给服务端发一个 SYN 报文，这是一个并指明客户端的初始化序列号 ISN。客户端进入 SYN_SENT 状态。发送内容：<strong>SYN=1，seq=x</strong>。</p>
<blockquote>
<p>SYN=1，表明这是一个TCP连接请求报文段。</p>
<p>TCP规定，SYN=1的报文段不能携带数据，但要消耗掉一个序号。</p>
</blockquote>
<p>（2）<strong>第二次握手：</strong>服务器收到客户端的 SYN 报文之后，会以自己的 SYN 报文作为应答，并且也是指定了自己的初始化序列号 ISN(s)。同时会把客户端的 ISN + 1 作为ACK 的值（即x+1），表示自己已经收到了客户端的 SYN，服务器进入 SYN_RCVD 的状态。确认报文段内容为：<strong>SYN=1，ACK=1，确认号ack=x+1，初始序号seq=y</strong>。</p>
<p>（3）<strong>第三次握手：</strong>客户端收到 SYN 报文之后，会发送一个普通的确认报文段。。同样把服务器的 ISN + 1 作为 ACK 的值（即y+1），表示已经收到了服务端的 SYN 报文，客户端进入ESTABLISHED 状态。服务器收到 ACK 报文之后，也进入ESTABLISHED 状态，此时，双方已建立起了连接。确认报文段内容：<strong>ACK=1，确认号ack=y+1，序号seq=x+1</strong>（初始为seq=x，第二个报文段所以要+1）。</p>
<blockquote>
<p><strong>普通的ACK报文段可以携带数据</strong>，不携带数据则不消耗序号。</p>
<p>发送第一个SYN的一端为主动打开（active open），接收这个SYN并发回下一个SYN的另一端为被动打开（passive open）。</p>
<p>在socket编程中，客户端执行connect()时，将触发三次握手。</p>
<p>第三次握手的情况下，ACK数据包如果丢失，有两种情况:</p>
<p>1、客户端接着发送数据包，服务器端收到数据包，这个时候数据包带有和ACK一样的信息，因此不需要进行重传。</p>
<p>2、如果客户端没有发送数据包，那么过了2ms，服务器端会认为自己的ACK数据包丢失了，进行重传，这个时候客户端才重传对应的数据包。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_5.png"><span class="image-caption">三次握手过程</span></p>
<p><strong>三次握手的目的</strong></p>
<p><strong>第一次握手：</strong>客户端发送网络包，服务端收到了。这样服务端就能得出结论：客户端的发送能力、服务端的接收能力是正常的。</p>
<p><strong>第二次握手：</strong>服务端发包，客户端收到了。这样客户端就能得出结论：服务端的接收、发送能力，客户端的接收、发送能力是正常的。不过此时服务器并不能确认客户端的接收能力是否正常。</p>
<p><strong>第三次握手</strong>：客户端发包，服务端收到了。这样服务端就能得出结论：客户端的接收、发送能力正常，服务器自己的发送、接收能力也正常。因此，需要三次握手才能确认双方的接收与发送能力是否正常。</p>
<blockquote>
<p>采用三次握手而不是两次握手的原因：<strong>为了防止已经失效的连接请求报文段突然又传到了TCP服务器，因而导致错误</strong>。</p>
<p>具体来说，客户端发出连接请求，但因连接请求报文丢失而未收到确认，于是客户端再重传一次连接请求。后来收到了确认，建立了连接。数据传输完毕后，就释放了连接，客户端共发出了两个连接请求报文段，其中第一个丢失，第二个到达了服务端，但是第一个丢失的报文段只是在某些网络结点长时间滞留了，延误到连接释放以后的某个时间才到达服务端，此时服务端误认为客户端又发出一次新的连接请求，于是就向客户端发出确认报文段，同意建立连接，如果只采用两次握手，只要服务端发出确认，就建立新的连接了，此时客户端忽略服务端发来的确认，也不发送数据，则服务端一直等待客户端发送数据，浪费资源。</p>
</blockquote>
<p><strong>初始序列号，ISN(Initial Sequence Number)：</strong></p>
<p>当一端为建立连接而发送它的SYN时，它为连接选择一个初始序号。ISN随时间而变化，因此每个连接都将具有不同的ISN。ISN可以看作是一个32比特的计数器，每4ms加1 。这样选择序号的目的在于防止在网络中被延迟的分组在以后又被传送，而导致某个连接的一方对它做错误的解释。三次握手的其中一个重要功能是客户端和服务端交换 ISN，以便让对方知道接下来接收数据的时候如何按序列号组装数据。<strong>如果 ISN 是固定的，攻击者很容易猜出后续的确认号，因此 ISN 是动态生成的。</strong></p>
<p><strong>泛洪攻击：</strong></p>
<p>​    SYN泛洪攻击属于Dos攻击的一种，该攻击是借助于TCP的三次握手实现的。攻击者发送<strong>TCP SYN</strong>，SYN是TCP三次握手中的第一个数据包，而当服务器返回ACK后，该攻击者就不对其进行再确认，那这个TCP连接就处于<strong>挂起状态</strong>，也就是所谓的半连接状态，服务器收不到再确认的话，还会重复发送ACK给攻击者。这样更加会浪费服务器的资源。攻击者就对服务器发送非常大量的这种TCP连接，由于每一个都没法完成三次握手，所以在服务器上，这些TCP连接会因为挂起状态而消耗CPU和内存，最后服务器可能死机，就无法为正常用户提供服务了。</p>
<p><strong>解决措施：</strong></p>
<p>​    对于SYN泛洪攻击的防范，优化主机系统设置是常用的手段。如<strong>降低SYN timeout时间</strong>，使得主机尽快释放半连接的占用；又比如<strong>采用SYN cookie设置</strong>，如果短时间内连续收到某个IP的重复SYN请求，则认为受到了该IP的攻击，丢弃来自该IP的后续请求报文。此外合理地采用防火墙等外部网络安全设施也可缓解SYN泛洪攻击。</p>
<h4 id="四次挥手"><a href="#四次挥手" class="headerlink" title="四次挥手"></a>四次挥手</h4><p>客户端和服务端都可以在数据传送结束后发出连接释放的通知，即主动关闭。</p>
<p>以客户端主动发起连接释放申请为例：</p>
<p>（1）<strong>第一次挥手</strong>：客户端想断开连接时，主动发送一个 FIN 报文（即连接释放报文段），并停止再发送数据，主动关闭TCP连接，进入FIN_WAIT1（终止等待1）状态，等待服务端的确认。连接释放报文段内容为：<strong>FIN=1，ACK=1，seq=u，ack=v</strong>，</p>
<blockquote>
<p>FIN=1，ACK=1，表明这是一个TCP连接释放报文段，同时也对之前收到的报文段进行确认。</p>
<p>TCP规定，终止位FIN等于1的报文段即使不携带数据，也要消耗掉一个序号。连接释放报文段可以携带数据也可以不携带数据。</p>
</blockquote>
<p>（2）<strong>第二次挥手</strong>：服务端收到 FIN 之后，会发送 ACK 报文，且把客户端的序列号值 +1 作为 ACK 报文的序列号值，表明已经收到客户端的报文。服务端发出确认报文段后进入CLOSE_WAIT（关闭等待）状态，此时从TCP客户端到服务端的连接就关闭了，TCP处于半关闭状态（服务端到客户端的连接没有关闭，服务端仍可以向客户端发送数据）。客户端收到服务端的确认后，进入FIN_WAIT2（终止等待2）状态，等待服务端发出的连接释放报文段。确认报文段内容<strong>ACK=1，seq=v，ack=u+1</strong></p>
<p>（3）<strong>第三次挥手</strong>：如果服务端没有数据发送，也想断开连接了，和客户端的第一次挥手一样，发给 FIN 报文，且指定一个序列号。服务端处进入LAST_ACK （最后确认）状态，等待客户端的确认。连接释放报文段内容为：<strong>FIN=1，ACK=1，seq=w，ack=u+1</strong>，u+1是对之前收到的TCP连接释放报文段的重复确认。</p>
<blockquote>
<p>第三次挥手是多出的一次挥手，主要原因在于可能双方连接断开的时候，服务端到客户端的数据传输还没有完成，因此需要多一次等待数据传输完成。一旦服务端没有数据发送了，就可以发送FIN报文。</p>
</blockquote>
<p>（4）<strong>第四次挥手</strong>：客户端收到 FIN 之后，一样发送一个 ACK 报文作为应答，且把服务端的序列号值 +1 作为自己 ACK 报文的序列号值，客户端进入 TIME_WAIT 状态。客户端需要等待2MSL时间，确保服务端收到自己的 ACK 报文之后才会进入 CLOSED 状态，而服务端收到 ACK 报文之后，就关闭连接，进入 CLOSED 状态。确认报文段内容为：<strong>ACK=1，seq=u+1，ack=w+1</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_6.png"><span class="image-caption">四次挥手过程</span></p>
<p><strong>TIME_WAIT状态</strong>：服务端发送最后一次释放连接请求后（即第三次挥手），可能由于网络比较阻塞，该数据帧在传送过程中丢失了。服务器可能会再次进行确认，但是此时如果客户端已经进入CLOSE状态，不会理会其他的请求。因此，<strong>采用TIME_WAIT来保障如果网络比较阻塞，可以保证最后一次的ACK报文段能够到达服务端，正常关闭TCP连接。TIME_WAIT是主动断开链接发起者的状态，在发送最后一次ACK后进入TIME_WAIT状态。</strong>经过2MSL时长，可以使本次连接持续时间内所产生的所有报文段都从网络中消失，可以使下一次新的TCP连接中，不会出现旧连接中的报文段。 </p>
<p><strong>CLOSE_WAIT状态：</strong>在被动关闭连接情况下，在已经接收到FIN，但是还没有发送自己的FIN的时刻，连接处于CLOSE_WAIT状态。在这个状态下，出于被动关闭的服务端可以继续将未发送完的数据发送给客户端。</p>
<p><strong>MSL（Maximum Segment Lifetime）</strong>：最长报文寿命，RFC793建议为2分钟。TCP允许不同的实现可以根据具体情况使用更小的MSL的值。</p>
<p><strong>保活计时器</strong>：为了保证TCP客户端出现故障时，服务端不再白白等待下去，TCP服务器使用保活计时器。TCP服务器进程每收到一次TCP客户进程的数据，就重新设置并启动保活计时器（2小时定时）。若保活计时器定时周期内未收到TCP客户进程发来的数据，则当保活计时器到时后，TCP服务器进程就向TCP客户进程发送一个探测报文段，以后则每隔75秒钟发送一次。若一连发送10个探测报文段后仍无TCP客户进程的响应，TCP服务器进程就认为TCP客户进程所在主机出了故障，接着就关闭这个连接。</p>
<h4 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h4><p>所谓流量控制(flow control)，就是让发送方的速率不要太快，要让接收方来得及接收。</p>
<p>TCP的流量控制通常采用<strong>滑动窗口</strong>实现。<strong>(滑动窗口的大小取决于接收方的窗口大小和信道大小)</strong>：</p>
<ul>
<li>TCP接收方利用自己的接收窗口的大小来限制发送方发送窗口的大小。</li>
<li>TCP发送方收到接收方的零窗口通知后，应启动持续计时器。持续计时器超时后，向接收方发送零窗口探测报文。</li>
</ul>
<p>滑动窗口有以下几种方法：</p>
<p>（1）<strong>停止等待协议</strong>，当发送窗口和接收窗口都等于1时，就是停止等待协议。<strong>发送端给接收端发送数据，等待接收端确认回复ACk，并停止发送新的数据包，开启计时器</strong>。数据包在计时器超时之前得到确认，那么计时器就会关闭，并发送下一个数据包。如果计时器超时，发送端就认为数据包丢失或被破坏，需要重新发送之前的数据包，说明数据包在得到确认之前，发送端需要存储数据包的副本。停止等待协议是发出一个帧后得到确认才发下一个，降低了信道的利用率。</p>
<p>（2）<strong>后退N帧协议</strong>，在发送完一个帧后，不用停下来等待确认，而是可以连续发送多个数据帧。收到确认帧时，任可发送数据，这样就减少了等待时间，整个通信的通吞吐量提高。<strong>如果前一个帧在超时时间内未得到确认，就认为丢失或被破坏，需要重发出错帧及其后面的所有数据帧。这样有可能有把正确的数据帧重传一遍，降低了传送效率</strong>。线路很差时，使用退后N帧的协议会浪费大量的带宽重传帧。</p>
<p>（3）<strong>选择重传协议</strong>，NAK：非确认帧，当在一定时间内没有收到某个数据帧的ACK时，回复一个NACK。在发送过程中，如果一个数据帧计时器超时，就认为该帧丢失或者被破坏，接收端只把出错的的帧丢弃，其后面的数据帧保存在缓存中，并向发送端回复NAK。发送端接收到NAK时，只发送出错的帧。如果落在窗口的帧从未接受过，那么存储起来，等比它序列号小的所有帧都按次序交给网络层，那么此帧才提交给网络层。接收端收到的数据包的顺序可能和发送的数据包顺序不一样。因此在数据包里必须含有顺序字符来帮助接受端来排序。选择重传协议可以避免重复传送那些正确到达接收端的数据帧。但是接收端要设置具有相当容量的缓存空间，这在许多情况下是不够经济的。</p>
<h4 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h4><p>拥塞，即对资源的需求超过了该资源所能提供的可用部分。若网络中许多资源同时供应不足，即出现拥塞，如果不进行控制，网络的性能就要明显变坏，整个网络的吞吐量随之负荷的增大而下降。</p>
<blockquote>
<p>计算机网络中的链路容量（即带宽）、交换结点中的缓存和处理机等，都是网络的资源。</p>
</blockquote>
<p>拥塞避免的方式主要包括<strong>慢开始，拥塞避免，快重传，快恢复。</strong></p>
<p><strong>前提</strong></p>
<p>发送方维护一个叫做<strong>拥塞窗口cwnd</strong>的状态变量，其值取决于网络的拥塞程度，并且动态变化。</p>
<ul>
<li>拥塞窗口cwnd的维护原则：只要网络没有出现拥塞，拥塞窗口就再增大一些；但只要网络出现拥塞，拥塞窗口就减少一些。</li>
<li>判断出现网络拥塞的依据：没有按时收到应当到达的确认报文（即发生超时重传)。</li>
</ul>
<p>发送方将拥塞窗口作为<strong>发送窗口swnd</strong>，即swnd = cwnd。</p>
<blockquote>
<p>发送方的窗口的上限值应当取为接收方窗口rwnd和拥塞窗口cwnd这两个变量中较小的一个.</p>
</blockquote>
<p>维护一个<strong>慢开始门限ssthresh</strong>状态变量：</p>
<ul>
<li>当cwnd &lt; ssthresh时，使用慢开始算法;</li>
<li>当cwnd &gt; ssthresh时，停止使用慢开始算法而改用拥塞避免算法;</li>
<li>当cwnd = ssthresh时，即可以使用慢开始算法，也可以使用拥塞避免算法。</li>
</ul>
<p>1、<strong>慢开始（slow-start）</strong>：</p>
<p>​        慢开始指的是一开始向网络中注入的报文段少。当主机开始发送数据时，如果立即把大量数据字节注入到网络，那么就有可能引起网络拥塞，因为现在并不清楚网络的负荷情况。因此，较好的方法是先探测一下，即<strong>由小到大逐渐增大发送窗口</strong>，也就是说，由小到大逐渐增大拥塞窗口数值。通常在刚刚开始发送报文段时，先把拥塞窗口 cwnd 设置为一个最大报文段MSS的数值。而在每收到一个对新的报文段的确认后，把拥塞窗口增加至多一个MSS的数值。用这样的方法逐步增大发送方的拥塞窗口 cwnd ，可以使分组注入到网络的速率更加合理。</p>
<p>2、<strong>拥塞避免（congestion avoidance）</strong>：</p>
<p>​        让拥塞窗口cwnd缓慢地增大，即每经过一个往返时间RTT就把发送方的<strong>拥塞窗口cwnd加1，而不是加倍</strong>。这样拥塞窗口cwnd<strong>按线性规律缓慢增长</strong>，比慢开始算法的拥塞窗口增长速率缓慢得多。无论在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现拥塞（其根据就是没有收到确认），就要<strong>把慢开始门限ssthresh设置为出现拥塞时的发送方窗口值的一半</strong>（但不能小于2）。然后把拥塞窗口cwnd重新设置为1，执行慢开始算法。这样做的目的就是要迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够时间把队列中积压的分组处理完毕。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_7.png"><span class="image-caption">TCP Tahoe版本</span></p>
<p>3、<strong>快重传(fast retransmit)</strong>：</p>
<p>如果传输时出现了超时，发送方会误以为发生了拥塞，从而将cwnd重新置为1，这样会降低效率，因此1990年增加了快重传和快恢复两个改进的算法。</p>
<p>所谓快重传，就是使发送方尽快进行重传，而不是等超时重传计时器超时再重传：</p>
<ul>
<li>要求接收方不要等待自己发送数据时才进行捎带确认，而是要<strong>立即发送确认（ACK）</strong>。</li>
<li>即使收到了失序的报文段，也要立即发出对已收到的报文段的<strong>重复确认</strong>。</li>
<li>发送方一旦收到<strong>3个连续的重复确认</strong>，就将相应的报文段<strong>立即重传</strong>，而不是等该报文段的超时重传计时器超时再重传。</li>
</ul>
<blockquote>
<p>对于个别丢失的报文段，发送方不会出现超时重传，也就不会误以为出现了拥塞（进而降低拥塞窗口cwnd为1）。使用快重传可以使整个网络的吞吐量提高约20%。</p>
</blockquote>
<p>收到3个重复确认后，知道是丢失了个别的报文段，于是不启动慢开始算法，而执行快恢复算法，具体做法为：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_8.png"><span class="image-caption">快重传</span></p>
<p>4、<strong>快恢复(fast recovery)</strong>：</p>
<p>使用快重传算法，收到3个重复确认时，会执行快恢复算法，具体做法为：</p>
<ul>
<li><p>把ssthresh设置为cwnd的一半；</p>
</li>
<li><p>把cwnd再设置为ssthresh的值；</p>
<blockquote>
<p>有些快恢复实现将cwnd重置为ssthresh+3，理由是3个重复确认说明有3个数据报文段离开了网络，这3个报文段不在消耗网络资源，而是停留在接收方的接收缓存中。网络中不是堆积了报文段，而是减少了3个报文段，因此可以适当把拥塞窗口再扩大些。</p>
</blockquote>
</li>
<li><p>重新进入拥塞避免阶段。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_9.png" alt=""></p>
<blockquote>
<p>慢开始和拥塞避免算法是1988年提出的TCP拥塞控制算法，称为TCP Tahoe版本。</p>
<p>1990年提出了快重传和快恢复算法，称为TCP Reno版本。</p>
</blockquote>
<h4 id="超时重传时间"><a href="#超时重传时间" class="headerlink" title="超时重传时间"></a>超时重传时间</h4><p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_10.png"><span class="image-caption">超时重传计算公式</span></p>
<p>例如：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_11.png"><span class="image-caption">超时重传时间计算例题</span></p>
<h4 id="可靠传输"><a href="#可靠传输" class="headerlink" title="可靠传输"></a>可靠传输</h4><p>通过以上TCP的内容，可以总结出TCP实现可靠传输，主要依靠以下机制：</p>
<ul>
<li>连接管理：三次握手和四次挥手机制。</li>
<li>数据分块传输。数据被分为TCP认为合适的数据块进行传输。</li>
<li>使用校验和校验：将发送的数据段都当作一个16位的整数，相加，进位不丢弃补在后面，最后取反得到校验和</li>
<li>确认应答和序列号：TCP传输时对每个字节的数据都进行了编号，每次接收方收到数据后，都会对传输方进行确认应答(ACK)，其中带有对应的确认序列号，告诉发送方已经接收到了哪些数据，下一次希望接收的数据的序列号。</li>
<li>流量控制：滑动窗口</li>
<li>拥塞控制：慢开始、拥塞避免、快重传、快恢复</li>
<li>超时重传机制。</li>
</ul>
<h4 id="粘包问题"><a href="#粘包问题" class="headerlink" title="粘包问题"></a>粘包问题</h4><p>粘包指的是由于连续的数据传送，导致多个数据包混合在一起，没有办法有效的区分开。TCP是基于字节流的，只维护发送出去多少，确认了多少，并没有维护消息与消息之间的边界，因而极有可能导致粘包问题：</p>
<ul>
<li><strong>发送端</strong>，TCP为提高传输效率，发送方要收集到足够多的数据后才发送一包数据。若连续几次发送的数据都很少，通常TCP会根据优化算法把这些数据合成一包后一次发送出去，这样接收方就收到了粘包数据。</li>
<li><strong>接收方</strong>引起的粘包是由于接收方用户进程不及时接收数据，或者当发送内容较大时，由于服务器端的recv(buffer_size)方法中的buffer_size较小，不能一次性完全接收全部内容，因此在下一次请求到达时，接收缓冲区还有上一次的内容，取出的数据包括了上一次没有完全接收完的内容，从而造成粘包现象</li>
</ul>
<blockquote>
<p>UDP方案不会出现粘包，因为其有对应的数据分割。</p>
</blockquote>
<p><strong>解决方法</strong>：</p>
<ul>
<li><p>对于<strong>发送方引起的粘包现象</strong>，用户可通过编程设置来避免，TCP提供了强制数据立即传送的操作指令push，TCP软件收到该操作指令后，就立即将本段数据发送出去，而不必等待发送缓冲区满。</p>
</li>
<li><p>对于<strong>接收方引起的粘包</strong>，则可通过优化程序设计、精简接收进程工作量、提高接收进程优先级等措施，使其及时接收数据，从而尽量避免出现粘包现象；发送端可以在发送数据之前向接收端告知发送内容的大小</p>
</li>
</ul>
<h3 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h3><p>Internet 协议集支持一个无连接的传输协议，该协议称为用户数据报协议（UDP，User Datagram Protocol）。UDP 为应用程序提供了一种无需建立连接就可以发送封装的 IP 数据包的方法。</p>
<p>UDP传输的可靠性由应用层负责。常用的UDP端口号有：53（DNS）、69（TFTP）、161（SNMP），使用UDP协议包括：TFTP、SNMP、DNS、DHCP、RIP（路由信息协议）</p>
<p>UDP报头由4个域组成，其中每个域各占用2个字节，具体包括<strong>源端口号、目标端口号、数据包长度、校验值</strong>。</p>
<h3 id="TCP与UDP的区别"><a href="#TCP与UDP的区别" class="headerlink" title="TCP与UDP的区别"></a>TCP与UDP的区别</h3><p><strong>1、连接方面区别</strong></p>
<p>TCP面向连接（如打电话要先拨号建立连接）。有三次握手建立连接，四次挥手释放连接。</p>
<p>UDP是无连接的，即发送数据之前不需要建立连接。</p>
<p><strong>2、安全方面的区别</strong></p>
<p>TCP提供可靠的服务，通过TCP连接传送的数据，无差错，不丢失，不重复，且按序到达。</p>
<p>UDP尽最大努力交付，即不保证可靠交付。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_12.png" alt=""></p>
<p><strong>3、传输效率的区别</strong></p>
<p>TCP传输效率相对较低。</p>
<p>UDP传输效率高，适用于对高速传输和实时性有较高的通信或广播通信。</p>
<p><strong>4、连接对象数量的区别</strong></p>
<p>TCP连接只能是点到点、一对一的，是全双工的。</p>
<p>UDP支持一对一，一对多，多对一和多对多的交互通信。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_13.png" alt=""></p>
<p><strong>5、运输过程的区别</strong></p>
<p>TCP面向字节流，这正是TCP实现可靠传输、流量控制、拥塞控制的基础。TCP将应用进程交付下来的数据块看作是无结构的字节流，更具发送策略，提取一定量的字节构建TCP报文并发送。</p>
<p>UDP面向报文，对应用进程交下来的报文即不合并也不拆分，而是保留这些报文的边界。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_14.png" alt=""></p>
<p><strong>6、结构方面的区别</strong></p>
<p>TCP首部最小20字节，最大60字节。因为其要提供可靠传输，因此首部字段包含固定部分20字节和可变部分最大40字节。</p>
<p>UDP首部开销小，仅8个字节。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_15.png" alt=""></p>
<p><strong>7、应用场景</strong></p>
<p>TCP的可靠性，决定了其适用于准确率要求高，效率要求低的场景，例如文件传输。</p>
<p>UDP的不可靠性，决定了其适用于效率要求高，准确率要求低的场景，例如IP电话、视频会议、直播等。</p>
<h2 id="3、HTTP与HTTPS"><a href="#3、HTTP与HTTPS" class="headerlink" title="3、HTTP与HTTPS"></a>3、HTTP与HTTPS</h2><h3 id="HTTP特点"><a href="#HTTP特点" class="headerlink" title="HTTP特点"></a>HTTP特点</h3><p>HTTP协议的五大特点：支持客户/服务器模式、简单快速、灵活、无连接、无状态。无连接指的是请求时建立连接，请求完释放连接。</p>
<p><strong>无状态</strong>是指：</p>
<ul>
<li><strong>协议对于事务处理没有记忆能力。</strong></li>
<li><p><strong>对同一个url请求没有上下文关系。</strong></p>
</li>
<li><p><strong>每次的请求都是独立的，</strong>它的执行情况和结果与前面的请求和之后的请求是无直接关系的，它不会受前面的请求应答情况直接影响，也不会直接影响后面的请求应答情况。</p>
</li>
<li><p><strong>服务器中没有保存客户端的状态</strong>，客户端必须每次带上自己的状态去请求服务器。</p>
</li>
</ul>
<h3 id="Cookies-Session"><a href="#Cookies-Session" class="headerlink" title="Cookies/Session"></a>Cookies/Session</h3><p>这两个主要用于解决HTTP无状态连接的问题，服务器会给每个会话创建对应的SessionID，会根据SessionID判断当前登陆的用户。</p>
<p><strong>Session</strong>是服务端用来记录用户状态的一种机制，或者说是存放在服务端用于跟踪用户状态的一个数据结构（对象）。服务端为每个特定的用户创建特定的Session，用于标识用户，记录用户的行为，这个Session有唯一的标识Session Id。Session Id一般存放在Cookie中，每次HTTP请求的时候，客户端会发送相应的Cookie信息到服务端，用于识别用户身份，然后从Session中查找用户状态。<strong>Cookie是Session的一种实现</strong>，Session实现会话管理机制时，利用了Cookie技术。Session默认存放在服务器的文件里，也可以存放在数据库、内存中。</p>
<p><strong>Cookie</strong>是一小段的文本信息，用于客户端保存用户信息，将无状态的HTTP进行状态化。当用户客户端通过 HTTP 协议访问一个服务器的时候，如果服务器需要记录该用户的状态，就为该用户生成一个唯一的Cookie识别码，并以此为索引在服务器后端数据库中创建一个项目，用来记录该用户访问该网站的各种信息，并将HTTP响应内容和 Key/Value 键值对返回给客户端浏览器。客户端浏览器会把Cookier保存起来。当浏览器再次请求该网站时，浏览器就会把请求地址和Cookie 一同给服务器。服务器检查该Cookie ，从而判断用户的状态。服务器还可以根据需要修改Cookie 的内容。Cookie一般会存放Session Id和用户名等其他用户信息。</p>
<blockquote>
<p>服务器将Cookie添加到response里一并返回给客户端，然后客户端会自动把response里的cookie接收下来，并且保存到本地，下次发出请求的时候，就会把cookie附加在request里，服务器在根据request里的cookie遍历搜索是否有与之符合的信息。</p>
<p>如果禁用Cookie，就无法获取Session Id，这时可以使用URL地址重写技术，将用户Session的id信息重写到URL地址中，这样即使客户端不支持Cookie，也可以使用Session来记录用户状态。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_16.png"><span class="image-caption">使用Cookie在服务器上记录用户信息</span></p>
<p><strong>Session和Cookie区别</strong>：</p>
<ul>
<li>存储位置：Cookie保存在客户端浏览器中的，而Session保存在服务器上。</li>
<li>安全性：与Session相比，Cookie由于保存在客户端，安全性较低。</li>
<li>存储容量：Session存储容量可以很大，Cookie存储容量很小。</li>
<li>如果说cookie机制是检查客户身上的“通行证”，那么session机制就是通过检查服务器上的“客户明细表”来确认客户身份。</li>
</ul>
<p><strong>利用cookie和session登录的流程</strong></p>
<p>客户输入账号密码进行首次登录，服务器端进行验证，验证成功则生成唯一的<strong>Session Id</strong>，并且在session对象中存储当前用户信息。服务器端将Session Id写入客户端Cookie中，当客户端下次访问服务器端时Cookie会被自动发送给服务器端，服务器端在Cookie中拿到Session Id然后在服务器端的Session对象中查找Session Id进行验证，验证成功说明用户是登陆状态，则可以为其响应只有在登陆状态才能响应的数据，还原用户上次的浏览状态或提供其他个性化服务。</p>
<h3 id="HTTP状态码"><a href="#HTTP状态码" class="headerlink" title="HTTP状态码"></a>HTTP状态码</h3><p>1、<strong>消息(1XX)：</strong></p>
<ul>
<li><strong>100 Continue</strong>，客户端应当继续发送请求。这个临时响应是用来通知客户端它的部分请求已经被服务器接收，且仍未被拒绝。客户端应当继续发送请求的剩余部分，或者如果请求已经完成，忽略这个响应。</li>
</ul>
<p>2、<strong>成功(2XX):</strong>    </p>
<ul>
<li><strong>200 OK</strong>，请求已成功</li>
<li><strong>201 Created</strong>，请求已经被实现，而且有一个新的资源已经依据请求的需要而建立，且其 URI 已经随Location 头信息返回。</li>
</ul>
<p>3、<strong>重定向(3XX)</strong>：</p>
<ul>
<li><strong>300 Multiple Choices</strong>，被请求的资源有一系列可供选择的回馈信息，每个都有自己特定的地址和浏览器驱动的商议信息。用户或浏览器能够自行选择一个首选的地址进行重定向。</li>
<li><strong>301: 永久重定向</strong>，表示本网页永久性转移到另一个地址。</li>
<li><strong>302：重定向</strong>，当响应码为302时，表示服务器要求浏览器重新再发一个请求，服务器会发送一个响应头Location，它指定了新请求的URL地址；</li>
<li><strong>304:</strong> 服务器端会获取If-Modified-Since值，与index.html 的当前最后修改时间比对，如果相同，服务器会发响应码304，表示index.html与浏览器上次缓存的相 同，无需再次发送，浏览器可以显示自己的缓存页面，如果比对不同，那么说明index.html已经做了修 改，服务器会响应200。</li>
</ul>
<p>4、<strong>请求错误（4XX）:</strong> </p>
<ul>
<li><strong>400 Bad Request</strong>：<ul>
<li>a.语义有误，当前请求无法被服务器理解。除非进行修改，否则客户端不应该重复提交这个请求。</li>
<li>b.请求参数有误。</li>
</ul>
</li>
<li><strong>403 Forbidden</strong>，服务器已经理解请求，但拒绝执行它。</li>
<li><strong>404 Not Found</strong>，请求失败，请求所希望得到的资源未被在服务器上发现。</li>
</ul>
<p>5、<strong>服务器错误（5XX）:</strong></p>
<ul>
<li><strong>500 Internal Server Error</strong>，服务器遇到了一个未曾预料的状况，导致了它无法完成对请求的处理。一般来说，这个问题都会在服务器端的源代码出现错误时出现。</li>
<li><strong>503 Service Unavailable</strong>，由于临时的服务器维护或者过载，服务器当前无法处理请求。</li>
<li><strong>504 Gateway Timeout</strong>，作为网关或者代理工作的服务器尝试执行请求时，未能及时从上游服务器（URI标识出的服务器，例如HTTP、FTP、LDAP）或者辅助服务器（例如DNS）收到响应。</li>
<li><strong>505 HTTP Version Not Supported</strong>，服务器不支持，或者拒绝支持在请求中使用的 HTTP 版本。这暗示着服务器不能或不愿使用与客户端相同的版本。响应中应当包含一个描述了为何版本不被支持以及服务器支持哪些协议的实体。</li>
</ul>
<h3 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h3><ul>
<li><p><strong>GET</strong>，GET 用于从指定资源请求数据。是幂等的，GET请求的参数数量是有限的，且参数暴露在URL中，安全性没有POST高</p>
</li>
<li><p><strong>POST</strong>，POST 用于将数据发送到服务器来创建/更新资源，是不幂等的。</p>
<blockquote>
<p> <strong>post请求几种常见content-type类型：</strong></p>
<ol>
<li>application/x-www-form-urlencoded：原生form表单</li>
<li>multipart/form-data：许多文件类型，比如文件</li>
<li>application/json：告诉服务端消息主体是JSON</li>
<li>text/xml：传输和存储数据</li>
<li>binary：二进制文件类型</li>
</ol>
</blockquote>
</li>
<li><p><strong>PUT</strong>，PUT 用于将数据发送到服务器来创建/更新资源。POST 和 PUT之间的区别在于 <strong>PUT 请求是幂等的（idempotent）。也就是说，多次调用相同的 PUT 请求将始终产生相同的结果。相反，重复调用POST请求具有多次创建相同资源的副作用</strong>。</p>
</li>
<li><strong>HEAD</strong>，HEAD 与 GET 几乎相同，但没有响应主体。换句话说，如果 GET /users 返回用户列表，那么 HEAD /users 将发出相同的请求，但不会返回用户列表。HEAD 请求对于在实际发出 GET 请求之前（例如在下载大文件或响应正文之前）检查 GET 请求将返回的内容很有用。</li>
<li><strong>DELETE</strong>，删除指定的资源。</li>
<li><strong>PATCH</strong>，对PUT方法的补充，用来对已知资源进行局部更新。</li>
<li><strong>OPTIONS</strong>，请求一些选项信息。</li>
</ul>
<h3 id="长连接与短连接"><a href="#长连接与短连接" class="headerlink" title="长连接与短连接"></a>长连接与短连接</h3><p>当浏览器访问一个包含多张图片的 HTML 页面时，除了请求访问的 HTML 页面资源，还会请求图片资源。如果每进行一次 HTTP 通信就要新建一个 TCP 连接，那么开销会很大。</p>
<p>长连接只需要建立一次 TCP 连接就能进行多次 HTTP 通信。</p>
<ul>
<li>从 HTTP/1.1 开始默认是长连接的，如果要断开连接，需要由客户端或者服务器端提出断开，使用 <code>Connection : close</code>；</li>
<li>在 HTTP/1.1 之前默认是短连接的，如果需要使用长连接，则使用 <code>Connection : Keep-Alive</code>。</li>
</ul>
<h3 id="HTTP1-0、1-1、2-0的区别"><a href="#HTTP1-0、1-1、2-0的区别" class="headerlink" title="HTTP1.0、1.1、2.0的区别"></a>HTTP1.0、1.1、2.0的区别</h3><p>HTTP1.X：线程阻塞，同一时间同一域名的请求有一定数量限制，超过限制数目的请求会被阻塞</p>
<p>HTTP1.0和HTTP1.1主要区别：HTTP1.0默认使用短连接，HTTP1.1默认使用长连接</p>
<p>HTTP2.0：</p>
<ul>
<li>采用二进制格式而非文本格式 </li>
<li>完全多路复用，而非有序并阻塞的、只需一个连接即可实现并行 </li>
<li>使用报头压缩，降低开销 </li>
<li>服务器推送</li>
</ul>
<p>​    </p>
<h3 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h3><p>HTTPS 并不是新协议，而是让 HTTP 先和 SSL（Secure Sockets Layer）通信，再由 SSL 和 TCP 通信，也就是说 HTTPS 使用了隧道进行通信。通过使用 SSL，HTTPS 具有了加密（防窃听）、认证（防伪装）和完整性保护（防篡改）。</p>
<blockquote>
<p>SSL/TLS加密过程：</p>
<p>（1） 客户端向服务器端索要并验证公钥。</p>
<p>（2） 双方协商生成”对话密钥”。</p>
<p>（3） 双方采用”对话密钥”进行加密通信。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_17.jpg"><span class="image-caption">HTTPS</span></p>
<p><strong>HTTPS的缺点</strong>：</p>
<ul>
<li>相同环境下HTTPS的响应时间和需要的资源相比HTTP都大幅上升</li>
<li>HTTPS的安全范围有限，在黑客攻击和服务器劫持等情况几乎起不到作用</li>
</ul>
<h3 id="HTTP-HTTPS的区别"><a href="#HTTP-HTTPS的区别" class="headerlink" title="HTTP/HTTPS的区别"></a>HTTP/HTTPS的区别</h3><ul>
<li>HTTP 信息是<strong>明文传输</strong>，内容可能会被窃听，不安全，HTTPS 的数据是<strong>加密传输</strong>的（HTTP+SSL/TLS），且可进行身份认证，安全性较好。</li>
<li>HTTP响应速度比HTTPS快，因为HTTPS多了一层加密层。</li>
<li>HTTP端口号为80，而HTTPS端口号为443，二者使用完全不同的连接方式。</li>
<li>HTTPS  协议需要到CA<strong>申请证书</strong>，一般免费证书较少，因而需要一定费用。</li>
</ul>
<h2 id="4、加密"><a href="#4、加密" class="headerlink" title="4、加密"></a>4、<a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/HTTP.md#%E5%8A%A0%E5%AF%86">加密</a></h2><h3 id="对称密钥加密"><a href="#对称密钥加密" class="headerlink" title="对称密钥加密"></a>对称密钥加密</h3><p>对称密钥加密（Symmetric-Key Encryption），加密和解密使用同一密钥。</p>
<ul>
<li>优点：运算速度快；</li>
<li>缺点：无法安全地将密钥传输给通信方。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_18.png"><span class="image-caption">对称密钥加密</span></p>
<h3 id="非对称密钥加密"><a href="#非对称密钥加密" class="headerlink" title="非对称密钥加密"></a>非对称密钥加密</h3><p>非对称密钥加密，又称公开密钥加密（Public-Key Encryption），加密和解密使用不同的密钥。</p>
<p>公开密钥所有人都可以获得，通信发送方获得接收方的公开密钥之后，就可以使用公开密钥进行加密，接收方收到通信内容后使用私有密钥解密。</p>
<p>非对称密钥除了用来加密，还可以用来进行签名。因为私有密钥无法被其他人获取，因此通信发送方使用其私有密钥进行签名，通信接收方使用发送方的公开密钥对签名进行解密，就能判断这个签名是否正确。</p>
<ul>
<li>优点：可以更安全地将公开密钥传输给通信发送方；</li>
<li>缺点：运算速度慢。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/computer-network-review_19.png"><span class="image-caption">非对称密钥加密</span></p>
<h3 id="HTTPS的加密方式"><a href="#HTTPS的加密方式" class="headerlink" title="HTTPS的加密方式"></a>HTTPS的加密方式</h3><p>上面提到对称密钥加密方式的传输效率更高，但是无法安全地将密钥 Secret Key 传输给通信方。而非对称密钥加密方式可以保证传输的安全性，因此我们可以利用非对称密钥加密方式将 Secret Key 传输给通信方。HTTPS 采用混合的加密机制，正是利用了上面提到的方案：</p>
<ul>
<li>先使用非对称密钥加密方式传输对称密钥加密方式所需要的 Secret Key，从而保证安全性;</li>
<li>获取到 Secret Key 后，再使用对称密钥加密方式进行通信，从而保证效率。</li>
</ul>
<h1 id="三、常见问题"><a href="#三、常见问题" class="headerlink" title="三、常见问题"></a>三、常见问题</h1><h2 id="1、输入URL后发生了什么？"><a href="#1、输入URL后发生了什么？" class="headerlink" title="1、输入URL后发生了什么？"></a>1、输入URL后发生了什么？</h2><p>1、<strong>应用层DNS解析域名</strong>。</p>
<p>​    浏览器会根据输入的URL去查找对应的IP，寻找的过程遵循就近原则，依次是：浏览器缓存 -&gt; 系统缓存 -&gt; 路由器缓存-&gt;本地（ISP）域名服务器缓存 -&gt; 根域名服务器。</p>
<p>2、<strong>TCP连接（三次握手）</strong>。</p>
<p>​    浏览器得到IP以后，向服务器发送TCP连接请求，三次握手建立TCP连接。</p>
<p>3、<strong>浏览器发送HTTP请求</strong>。</p>
<p>​    浏览器向web服务器发送一个HTTP请求。HTTP的请求方式为get，这个get请求包含了主机（Host）、用户代理(User-Agent)，用户代理就是自己的浏览器，它是你的”代理人”，Connection（连接属性）中的keep-alive表示浏览器告诉对方服务器在传输完现在请求的内容后不要断开连接，不断开的话下次继续连接速度就很快了。可能还会有Cookies，Cookies保存了用户的登陆信息，一般保存的是用户的SessionId，在每次向服务器发送请求的时候会重复发送给服务器，服务器就知道是哪个浏览器。</p>
<blockquote>
<p>如果有重定向，则会执行服务器的永久重定向—&gt;浏览器跟踪对应的重定向地址。</p>
</blockquote>
<p>4、<strong>服务器处理并发回请求</strong>。服务器返回响应头（包含状态码）和具体的要请求的页面内容。</p>
<p>5、<strong>浏览器解析对应的HTML响应内容</strong>：</p>
<p>6、<strong>关闭TCP连接（四次挥手）</strong>。</p>
]]></content>
      <categories>
        <category>CS基础</category>
      </categories>
      <tags>
        <tag>计算机网络</tag>
      </tags>
  </entry>
  <entry>
    <title>使用SpringBoot2进行Web开发</title>
    <url>/2021/07/11/springboot-web/</url>
    <content><![CDATA[<h1 id="一、对SpringMVC的自动配置"><a href="#一、对SpringMVC的自动配置" class="headerlink" title="一、对SpringMVC的自动配置"></a>一、对SpringMVC的自动配置</h1><h2 id="1-1-自动配置"><a href="#1-1-自动配置" class="headerlink" title="1.1 自动配置"></a>1.1 自动配置</h2><p>SpringBoot中自动配置了SpringMVC，大多场景我们都不需要自定义配置。</p>
<p>在Spring的基础上，SpringBoot添加了以下的特征：</p>
<ul>
<li><code>ContentNegotiatingViewResolver</code> （内容协商视图解析器）和<code>BeanNameViewResolver</code>（BeanName）视图解析器</li>
<li>支持静态资源，包括webjars</li>
<li>自动注册 <code>Converter，GenericConverter，Formatter</code></li>
<li>支持<code>HeepMessageConverters</code></li>
<li>自动注册<code>MessageCodesResolver</code>，用于国际化</li>
<li>静态index.html支持</li>
<li>自定义facicon</li>
<li>自动使用 <code>ConfigurableWebBindingInitializer</code> ，（DataBinder负责将请求数据绑定到JavaBean上）</li>
</ul>
<h2 id="1-2-自定义配置"><a href="#1-2-自定义配置" class="headerlink" title="1.2 自定义配置"></a>1.2 自定义配置</h2><p>SpringBoot为我们提供了<code>WebMvcConfigurer</code>接口，可以实现对SpringMVC的各项自定义功能：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">WebMvcConfigurer</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configurePathMatch</span><span class="hljs-params">(PathMatchConfigurer configurer)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureContentNegotiation</span><span class="hljs-params">(ContentNegotiationConfigurer configurer)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureAsyncSupport</span><span class="hljs-params">(AsyncSupportConfigurer configurer)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureDefaultServletHandling</span><span class="hljs-params">(DefaultServletHandlerConfigurer configurer)</span> </span>{}<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addFormatters</span><span class="hljs-params">(FormatterRegistry registry)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>{}<br>    <br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addResourceHandlers</span><span class="hljs-params">(ResourceHandlerRegistry registry)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addCorsMappings</span><span class="hljs-params">(CorsRegistry registry)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addViewControllers</span><span class="hljs-params">(ViewControllerRegistry registry)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureViewResolvers</span><span class="hljs-params">(ViewResolverRegistry registry)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addArgumentResolvers</span><span class="hljs-params">(List&lt;HandlerMethodArgumentResolver&gt; resolvers)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addReturnValueHandlers</span><span class="hljs-params">(List&lt;HandlerMethodReturnValueHandler&gt; handlers)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureMessageConverters</span><span class="hljs-params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">extendMessageConverters</span><span class="hljs-params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>{}<br><br>   <br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureHandlerExceptionResolvers</span><span class="hljs-params">(List&lt;HandlerExceptionResolver&gt; resolvers)</span> </span>{}<br><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> <span class="hljs-keyword">void</span> <span class="hljs-title">extendHandlerExceptionResolvers</span><span class="hljs-params">(List&lt;HandlerExceptionResolver&gt; resolvers)</span> </span>{}<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> Validator <span class="hljs-title">getValidator</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;}<br><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-function"><span class="hljs-keyword">default</span> MessageCodesResolver <span class="hljs-title">getMessageCodesResolver</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;}<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>我们有两种方式自定义这个接口，都需要先准备一个配置类：</p>
<ul>
<li>直接实现接口，然后按需实现其中的方法。</li>
<li>使用@Bean注解返回组件。</li>
</ul>
<p>两种方式的代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//方式一：实现WebMvcConfigurer接口</span><br><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span> </span>{<br>    <span class="hljs-comment">//重写需要自定义的方法即可</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configurePathMatch</span><span class="hljs-params">(PathMatchConfigurer configurer)</span> </span>{...}<br>}<br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//方式二：使用注解</span><br><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebConfig</span> </span>{ <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span>  WebMvcConfigurer <span class="hljs-title">webMvcConfigurer</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//将匿名实现类返回</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> WebMvcConfigurer() {<br>            <span class="hljs-comment">//重写需要自定义的方法</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configurePathMatch</span><span class="hljs-params">(PathMatchConfigurer configurer)</span> </span>{...}<br>        };<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure>
<p>关于SpringMVC的功能定制，都可以在这个配置类中进行自定义。</p>
<h1 id="二、简单功能分析"><a href="#二、简单功能分析" class="headerlink" title="二、简单功能分析"></a>二、简单功能分析</h1><h2 id="2-1-静态资源访问"><a href="#2-1-静态资源访问" class="headerlink" title="2.1 静态资源访问"></a>2.1 静态资源访问</h2><h3 id="2-1-1-静态资源目录"><a href="#2-1-1-静态资源目录" class="headerlink" title="2.1.1 静态资源目录"></a>2.1.1 静态资源目录</h3><p>SpringBoot默认将静态资源放在以下目录，查找顺序从上往下：</p>
<p><code>main/resources/META-INF/resources</code></p>
<p> <code>main/resources/resources</code> </p>
<p> <code>main/resources/static</code> </p>
<p><code>main/resources/public</code></p>
<p>以上文件夹的静态资源访问时，使用<code>当前项目根路径/静态资源名</code>即可访问。</p>
<p>SpringBoot底层使用<code>/**</code>拦截了所有请求。当收到一个请求时，会先判断controller能不能处理，如果不能处理就交给静态资源处理，都不能处理则返回404。</p>
<h3 id="2-1-2-静态资源访问前缀"><a href="#2-1-2-静态资源访问前缀" class="headerlink" title="2.1.2 静态资源访问前缀"></a>2.1.2 静态资源访问前缀</h3><p>默认静态资源访问无前缀，可以通过配置，改变默认的静态资源访问前缀和访问路径：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">mvc:</span><br>    <span class="hljs-attr">static-path-pattern:</span> <span class="hljs-string">/res/**</span>  <span class="hljs-comment"># 指定所有静态资源的访问前缀</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">static-locations:</span> [<span class="hljs-string">classpath:/mystatic/</span>]  <span class="hljs-comment"># 重新指定静态资源的存放路径</span><br></code></pre></td></tr></tbody></table></figure>
<p>如果添加了静态资源的访问前缀，这样访问所有静态资源都要使用指定的前缀。</p>
<p>如果修改了静态资源的目录，这样只能访问指定路径下的静态资源，默认的路径全失效。</p>
<h3 id="2-1-3-webjar"><a href="#2-1-3-webjar" class="headerlink" title="2.1.3 webjar"></a>2.1.3 webjar</h3><p>项目路径/webjars/**</p>
<p><a href="https://www.webjars.org/">webjar</a></p>
<p>需要引入依赖，比如引入webjars的jquery：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.webjars<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jquery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>此时访问地址为：<code>http://localhost:8080/webjars/jquery/3.5.1/jquery.js</code>，后面的地址需要按照依赖里面的包路径。</p>
<h2 id="2-2-欢迎页支持"><a href="#2-2-欢迎页支持" class="headerlink" title="2.2 欢迎页支持"></a>2.2 欢迎页支持</h2><p>SpringBoot支持欢迎页，默认静态资源路径下的index.html会被当作欢迎页。</p>
<p>可以配置静态资源路径。</p>
<p>但是<strong>如果配置了静态资源的访问前缀，欢迎页就会失效</strong>，因为源码中判断只能在默认静态资源路径中访问欢迎页：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">if</span> (welcomePage != <span class="hljs-keyword">null</span> &amp;&amp; <span class="hljs-string">"/**"</span>.equals(staticPathPattern)){}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2-3-自定义Favicon"><a href="#2-3-自定义Favicon" class="headerlink" title="2.3 自定义Favicon"></a>2.3 自定义Favicon</h2><p>将图标命名为<code>favicon.ico</code>，并放在静态资源目录下即可。同样地，静态资源访问前缀会导致其失效。</p>
<h2 id="2-4-静态资源配置原理"><a href="#2-4-静态资源配置原理" class="headerlink" title="2.4 静态资源配置原理"></a>2.4 静态资源配置原理</h2><h3 id="2-4-1-资源处理的默认规则"><a href="#2-4-1-资源处理的默认规则" class="headerlink" title="2.4.1 资源处理的默认规则"></a>2.4.1 资源处理的默认规则</h3><p>1、SpringBoot启动默认加载自动配置类。</p>
<p>2、添加了Web框架支持的项目会自动导入web常见启动器，然后SpringMVC的自动配置类 <code>WebMvcAutoConfiguration</code>就会生效：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span><br><span class="hljs-meta">@ConditionalOnClass({ Servlet.class, </span><br><span class="hljs-meta">                     DispatcherServlet.class, </span><br><span class="hljs-meta">                     WebMvcConfigurer.class })</span><br><span class="hljs-meta">@ConditionalOnMissingBean(WebMvcConfigurationSupport.class)</span><br><span class="hljs-meta">@AutoConfigureOrder(Ordered.HIGHEST_PRECEDENCE + 10)</span><br><span class="hljs-meta">@AutoConfigureAfter({ DispatcherServletAutoConfiguration.class, </span><br><span class="hljs-meta">                     TaskExecutionAutoConfiguration.class,</span><br><span class="hljs-meta">                     ValidationAutoConfiguration.class })</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebMvcAutoConfiguration</span> </span>{<br>    <span class="hljs-comment">//The default Spring MVC view prefix.</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_PREFIX = <span class="hljs-string">""</span>;<br><br>    <span class="hljs-comment">//The default Spring MVC view suffix.</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_SUFFIX = <span class="hljs-string">""</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String SERVLET_LOCATION = <span class="hljs-string">"/"</span>;<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>3、<code>WebMvcAutoConfiguration</code>中有一个静态内部类，<code>WebMvcAutoConfigurationAdapter</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SuppressWarnings("deprecation")</span><br>	<span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br>	<span class="hljs-meta">@Import(EnableWebMvcConfiguration.class)</span><br>	<span class="hljs-meta">@EnableConfigurationProperties({WebMvcProperties.class,</span><br><span class="hljs-meta">                                    ResourceProperties.class,</span><br><span class="hljs-meta">                                    WebProperties.class })</span><br>	<span class="hljs-meta">@Order(0)</span><br>	<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebMvcAutoConfigurationAdapter</span> </span><br><span class="hljs-class">        <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span>, <span class="hljs-title">ServletContextAware</span></span>{}<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，其绑定了三个xxxProperties类，这三个类中定义了SpringMVC应用的参数的默认值，并且绑定了配置文件中的<code>spring.mvc</code>、<code>spring.resources</code>、<code>spring.web</code>三个对应的配置前缀，我们只需要在配置文件中配置这些参数即可修改默认值。其中在<code>WebProperties</code>这个类中，就定义了静态资源的默认访问路径。</p>
<p>这个内部类，只有一个有参构造器，这个构造器中所有参数的值都会从容器中确定，构造器代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WebMvcAutoConfigurationAdapter</span><span class="hljs-params">(...一堆参数)</span> </span>{<br>    <span class="hljs-comment">//获取和spring.resources绑定的所有的值的对象</span><br>    <span class="hljs-keyword">this</span>.resourceProperties = resourceProperties.hasBeenCustomized() <br>        ? resourceProperties: webProperties.getResources();<br>    <span class="hljs-comment">//获取和spring.mvc绑定的所有的值的对象</span><br>    <span class="hljs-keyword">this</span>.mvcProperties = mvcProperties;<br>    <span class="hljs-comment">//Spring的beanFactory</span><br>    <span class="hljs-keyword">this</span>.beanFactory = beanFactory;<br>    <span class="hljs-comment">//找到所有的HttpMessageConverters</span><br>    <span class="hljs-keyword">this</span>.messageConvertersProvider = messageConvertersProvider;<br>    <span class="hljs-comment">//找到资源处理器的自定义器</span><br>    <span class="hljs-keyword">this</span>.resourceHandlerRegistrationCustomizer =<br>        resourceHandlerRegistrationCustomizerProvider.getIfAvailable();<br>    <span class="hljs-keyword">this</span>.dispatcherServletPath = dispatcherServletPath;<br>    <span class="hljs-comment">//给应用注册Servlet、Filter....</span><br>    <span class="hljs-keyword">this</span>.servletRegistrations = servletRegistrations;<br>    <span class="hljs-keyword">this</span>.mvcProperties.checkConfiguration();<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="2-4-2-欢迎页的处理规则"><a href="#2-4-2-欢迎页的处理规则" class="headerlink" title="2.4.2 欢迎页的处理规则"></a>2.4.2 欢迎页的处理规则</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WelcomePageHandlerMapping</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractUrlHandlerMapping</span> </span>{<br>    ...<br>	WelcomePageHandlerMapping(TemplateAvailabilityProviders templateAvailabilityProviders,<br>			ApplicationContext applicationContext, <br>                              Resource welcomePage, <br>                              String staticPathPattern) {<br>		<span class="hljs-comment">//可以看到，要使用欢迎页，必须是/**</span><br>        <span class="hljs-keyword">if</span> (welcomePage != <span class="hljs-keyword">null</span> &amp;&amp; <span class="hljs-string">"/**"</span>.equals(staticPathPattern)) {<br>			logger.info(<span class="hljs-string">"Adding welcome page: "</span> + welcomePage);<br>			setRootViewName(<span class="hljs-string">"forward:index.html"</span>);<br>		}<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (welcomeTemplateExists(templateAvailabilityProviders,<br>                                       applicationContext)) {<br>			logger.info(<span class="hljs-string">"Adding welcome page template: index"</span>);<br>			setRootViewName(<span class="hljs-string">"index"</span>);<br>		}<br>	}<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、请求映射和参数处理"><a href="#三、请求映射和参数处理" class="headerlink" title="三、请求映射和参数处理"></a>三、请求映射和参数处理</h1><h2 id="3-1-请求映射"><a href="#3-1-请求映射" class="headerlink" title="3.1 请求映射"></a>3.1 请求映射</h2><h3 id="3-1-1-REST的使用与原理"><a href="#3-1-1-REST的使用与原理" class="headerlink" title="3.1.1 REST的使用与原理"></a>3.1.1 REST的使用与原理</h3><p><strong>使用</strong></p>
<p>使用<code>xxxMapping</code>注解表示对收到的请求进行处理。</p>
<ul>
<li><code>RequestMapping</code>：适用于各种请求</li>
<li><code>@GetMapping</code>：只适用于get请求，RESTful风格中表示获取、查询信息</li>
<li><code>@PostMapping</code>：只适用于post请求，RESTful风格中表示添加信息</li>
<li><code>@PutMapping</code>：只适用于put请求中，RESTful风格中表示修改信息</li>
<li><code>@DeleteMapping</code>：只适用于delete请求，RESTful风格中表示删除信息。</li>
</ul>
<p><strong>form表单只支持get和post两种提交方式，如何确保请求方式为put和delete呢？</strong></p>
<p>方法：</p>
<ul>
<li><p>首先需要在配置文件中开启隐藏域方法支持，SpringBoot2.5.2已经默认开启了：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">mvc:</span><br>    <span class="hljs-attr">hiddenmethod:</span><br>      <span class="hljs-attr">filter:</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>form表单中有一个隐藏方法域，在其中定义请求方式，需要在<code>method=post</code>的前提下使用：</p>
<p><code>test.html</code></p>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/user"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"get"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"REST-GET提交"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/user"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"REST-POST提交"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 必须在post请求里面定义_method隐藏域才能生效 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">"/user"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_method"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"delete"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"REST-DELETE提交"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">action</span>=<span class="hljs-string">" /user"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"_method"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"hidden"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"PUT"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"REST-PUT提交"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这样，在controller收到请求后，如果是post请求，带有_method隐藏域的话，会获取其value值，确认请求方式。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@GetMapping("/user")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getUser</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"GET请求"</span>;<br>}<br><br><span class="hljs-meta">@PostMapping("/user")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">saveUser</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"POST请求"</span>;<br>}<br><br><span class="hljs-meta">@PutMapping("/user")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">putUser</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"PUT请求"</span>;<br>}<br><br><span class="hljs-meta">@DeleteMapping("/user")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">deleteUser</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"DELETE请求"</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>我们也可以自定义过滤器，将_method修改为自定义的字符串。根据源码分析可以，我们需要对<code>HiddenHttpMethodFilter</code>这个过滤器组件进行配置。</p>
<p>因此我们定义一个配置类，在其中使用<code>@Bean</code>注解，注入我们自定义的组件，这样底层就会使用我们手动注入的组件：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//定义一个配置类</span><br><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebConfig</span></span>{<br>    <span class="hljs-comment">//配置组件并注入</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> HiddenHttpMethodFilter <span class="hljs-title">hiddenHttpMethodFilter</span><span class="hljs-params">()</span></span>{<br>        HiddenHttpMethodFilter hiddenHttpMethodFilter = <span class="hljs-keyword">new</span> HiddenHttpMethodFilter();<br>        <span class="hljs-comment">//在这里将隐藏域方法名改为自定义名字,比如改为_m</span><br>        hiddenHttpMethodFilter.setMethodParam(<span class="hljs-string">"_m"</span>);  <br>        <span class="hljs-keyword">return</span> hiddenHttpMethodFilter;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>REST原理</strong></p>
<ul>
<li>表单提交的时候，会带上隐藏域_method</li>
<li>请求会被<code>HiddenHttpMethodFilter</code>拦截，判断请求是否正常，并且是POST方式，才做以下操作：<ul>
<li>获取到_method的值，将value的值统一转化为大写。</li>
<li>会兼容PUT、DELETE、PATCH三种请求</li>
<li>原生request的包装(装饰器)模式，<code>requestWrapper</code>重写了<code>getMethod()</code>方法，返回的是传入的值。</li>
<li>过滤器链放行的时候，使用的是wrapper，以后的方法调用的都是requestWrapper的<code>getMethod()</code>方法</li>
</ul>
</li>
</ul>
<h3 id="3-1-2-请求映射原理"><a href="#3-1-2-请求映射原理" class="headerlink" title="3.1.2 请求映射原理"></a>3.1.2 请求映射原理</h3><p>SpringMVC的功能分析都从<code>DispatcherServlet</code>的<code>doDispatch()</code>方法入手，其继承体系如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-web_1.png"><span class="image-caption">DispatcherServlet继承体系</span></p>
<p><code>doDispatch()</code>方法会遍历查找，找到当前请求会使用哪个Handler（即Controller方法）进行处理。</p>
<p>具体来说，所有的请求映射，都会保存在<code>HandlerMapping</code>中。</p>
<blockquote>
<p>共有以下几种HandleMapping</p>
<ul>
<li><code>RequestMappingHandlerMapping</code></li>
<li><code>WelcomePageHandlerHandlerMapping</code></li>
<li><code>BeanNameUrlHandlerMapping</code></li>
<li><code>RouterFunctionHandlerMapping</code></li>
<li><code>SimpleUrlHandlerMapping</code>：</li>
</ul>
</blockquote>
<ul>
<li>比如<code>WelcomePageHandlerMapping</code>，就能够访问<code>index.html</code>这个页面</li>
<li>SpringBoot自动配置了默认的<code>RequestMappingHandlerMapping</code></li>
<li>请求进来后，会依次遍历所有的<code>HandlerMapping</code>，查看是否有请求信息。<ul>
<li>如果有就找到这个请求对应的<code>handler</code></li>
<li>如果没有就继续查找下一个 <code>HandlerMapping</code></li>
</ul>
</li>
</ul>
<p>如果我们需要自定义的映射处理，我们可以定义自己的<code>HandlerMapping</code>。具体做法为在配置类中，使用<code>@Bean</code>注入定义的组件，在方法里面自定义我们自己的组件。</p>
<h2 id="3-2-参数处理"><a href="#3-2-参数处理" class="headerlink" title="3.2 参数处理"></a>3.2 参数处理</h2><p>这里的参数处理主要指的是控制器（controller）方法中的参数。</p>
<h3 id="3-2-1-基本注解"><a href="#3-2-1-基本注解" class="headerlink" title="3.2.1 基本注解"></a>3.2.1 基本注解</h3><p>在参数中，可以使用以下注解：</p>
<p><code>@PathVariable</code>：路径变量，比如RESTful风格的变量</p>
<p><code>@RequestHeader</code>：获取请求头</p>
<p><code>@RequestAttribute</code>：获取请求域属性</p>
<p><code>@RequestParam</code>：获取请求参数，比如url中<code>?</code>后面的变量</p>
<p><code>@RequestBody</code>：获取请求体</p>
<p><code>@MatrixVariable</code>：矩阵变量。如果矩阵变量同名，可以使用这个注解的<code>pathVar</code>进行区分。使用详情参考：<a href="https://www.yuque.com/atguigu/springboot/vgzmgh#SN5lp">矩阵变量</a></p>
<p><code>@CookieValue</code>：获取cookie值</p>
<h3 id="3-2-2-Servlet-API"><a href="#3-2-2-Servlet-API" class="headerlink" title="3.2.2 Servlet API"></a>3.2.2 Servlet API</h3><p>除了在参数位置使用简单的注解外，我们还可以传入Servlet API类型的参数。</p>
<p>比如在controller中进行结果跳转的时候，我们有一种使用Servlet API的方式进行跳转：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RequestAttributeController</span> </span>{<br>    <span class="hljs-meta">@GetMapping("/goto")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">goToPage</span><span class="hljs-params">(HttpServletRequest request)</span></span>{<br>        request.setAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"Success!"</span>);<br>        request.setAttribute(<span class="hljs-string">"code"</span>,<span class="hljs-string">"200"</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"forward:/success"</span>;  <span class="hljs-comment">//请求转发到/success请求</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>通过debug源码可知，对<code>HttpServletRequest</code>类型的参数解析，使用的是名为<code>ServletRequestMethodArgumentResolver</code>的参数解析器进行解析的，这个参数解析器能够解析的所有类型如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">supportsParameter</span><span class="hljs-params">(MethodParameter parameter)</span> </span>{<br>    Class&lt;?&gt; paramType = parameter.getParameterType();<br>    <span class="hljs-keyword">return</span> (WebRequest.class.isAssignableFrom(paramType) ||<br>            ServletRequest.class.isAssignableFrom(paramType) ||<br>            MultipartRequest.class.isAssignableFrom(paramType) ||<br>            HttpSession.class.isAssignableFrom(paramType) ||<br>            (pushBuilder != <span class="hljs-keyword">null</span> &amp;&amp; pushBuilder.isAssignableFrom(paramType)) ||<br>            Principal.class.isAssignableFrom(paramType) ||<br>            InputStream.class.isAssignableFrom(paramType) ||<br>            Reader.class.isAssignableFrom(paramType) ||<br>            HttpMethod.class == paramType ||<br>            Locale.class == paramType ||<br>            TimeZone.class == paramType ||<br>            ZoneId.class == paramType);<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="3-2-3-复杂参数"><a href="#3-2-3-复杂参数" class="headerlink" title="3.2.3 复杂参数"></a>3.2.3 复杂参数</h3><p>controller方法中的参数也可以是Map、Model、ModelMap、ModelAndView类型的对象。</p>
<p>这些类型的对象里面的数据，会<strong>被放到请求域中</strong>。</p>
<h3 id="3-2-4-自定义对象参数"><a href="#3-2-4-自定义对象参数" class="headerlink" title="3.2.4 自定义对象参数"></a>3.2.4 自定义对象参数</h3><p>controller方法中的参数也可以是自定义类型，会自动将参数名和变量名匹配。如果不匹配的则值为<code>null</code>。</p>
<p>比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**  前端页面请求</span><br><span class="hljs-comment"> *     姓名： &lt;input name="userName"/&gt; &lt;br/&gt;</span><br><span class="hljs-comment"> *     年龄： &lt;input name="age"/&gt; &lt;br/&gt;</span><br><span class="hljs-comment"> *     生日： &lt;input name="birth"/&gt; &lt;br/&gt;</span><br><span class="hljs-comment"> *     宠物姓名：&lt;input name="pet.name"/&gt;&lt;br/&gt;</span><br><span class="hljs-comment"> *     宠物年龄：&lt;input name="pet.age"/&gt;</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-comment">//Person类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{<br>    <span class="hljs-keyword">private</span> String userName;<br>    <span class="hljs-keyword">private</span> Integer age;<br>    <span class="hljs-keyword">private</span> Date birth;<br>    <span class="hljs-keyword">private</span> Pet pet;<br>    ...    <br>}<br><br><span class="hljs-comment">//Pet类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pet</span> </span>{<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String age;<br>    ...<br>}<br><span class="hljs-comment">//controller</span><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyController</span> </span>{<br>    <span class="hljs-meta">@GetMapping("/person")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">goToPage</span><span class="hljs-params">(Person person)</span></span>{<br>        <span class="hljs-comment">//person中的值会自动匹配参数的值</span><br>        <span class="hljs-keyword">return</span> person;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3-3-参数处理原理"><a href="#3-3-参数处理原理" class="headerlink" title="3.3 参数处理原理"></a>3.3 参数处理原理</h2><p><code>HandlerMapping</code>中找到能够处理请求的<code>Handler</code>，然后为当前<code>Handler</code>找一个适配器，即<code>HandlerAdapter</code>，比如说<code>RequestMappingHandlerAdapter</code>。</p>
<p>适配器执行目标方法并确定方法参数的每一个值。大致流程如下：</p>
<p>1、执行目标方法。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">mav = invokeHandlerMethod(request, response, handlerMethod); <span class="hljs-comment">//执行目标方法</span><br></code></pre></td></tr></tbody></table></figure>
<p>执行目标方法的细节进一步分析如下。</p>
<p>2、确定要执行的目标方法的每一个参数的值是什么。SpringMVC目标方法能写多少种参数类型，取决于参数解析器。</p>
<p>在<code>InvocableHandlerMethod</code>类的<code>getMethodArgumentValues</code>方法中确定目标方法每个参数的值。</p>
<p>底层会遍历参数解析器，如果当前<strong>参数解析器</strong>能解析当前参数，就调用这个解析器的相关方法进行解析。</p>
<p>3、返回值处理器。返回值处理由<strong>返回值处理器</strong>进行处理，比如<code>ModelMethodProcessor</code>、<code>ResponseBodyEmitterReturnValueHandler</code>等。</p>
<p>4、当目标方法完成后，所有的数据都会保存在<code>ModelAndViewContainer</code>中，其中包含了视图<code>View</code>，以及<code>Model</code>数据。</p>
<p>5、最后处理派发结果，调用<code>processDispatchResult()</code>方法。</p>
<p>在执行的过程中，底层会将<code>model</code>中的所有数据都放到请求域中：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exposeModelAsRequestAttributes</span><span class="hljs-params">(Map&lt;String, Object&gt; model,</span></span><br><span class="hljs-function"><span class="hljs-params">          HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>    <span class="hljs-comment">//model中的所有数据遍历挨个放在请求域中</span><br>    model.forEach((name, value) -&gt; {<br>        <span class="hljs-keyword">if</span> (value != <span class="hljs-keyword">null</span>) {<br>            request.setAttribute(name, value);<br>        }<br>        <span class="hljs-keyword">else</span> {<br>            request.removeAttribute(name);<br>        }<br>    });<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3-4-自定义类型参数封装POJO"><a href="#3-4-自定义类型参数封装POJO" class="headerlink" title="3.4 自定义类型参数封装POJO"></a>3.4 自定义类型参数封装POJO</h2><p>底层对参数封装为POJO对象的时候，定义了大量的<strong>类型转换器(converter)</strong>，比如<code>StringToNumber</code>是字符串转为数字类型的一个转换器。</p>
<p>其中在进行封装之前，会调用<code>isSimpleValueType</code>方法判断是否是简单类型。</p>
<p>如果我们想自定义一个类型转换器，参考源码中类型转换器的写法，我们可以在<code>WebDataBinder</code>里面放入自己定义的Converter.</p>
<p>在配置类中，自定义<code>WebMvcConfigurer</code>组件：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//1、WebMvcConfigurer定制化SpringMVC的功能</span><br><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> WebMvcConfigurer <span class="hljs-title">webMvcConfigurer</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> WebMvcConfigurer() {<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configurePathMatch</span><span class="hljs-params">(PathMatchConfigurer configurer)</span> </span>{<br>            UrlPathHelper urlPathHelper = <span class="hljs-keyword">new</span> UrlPathHelper();<br>            <span class="hljs-comment">// 不移除；后面的内容。矩阵变量功能就可以生效</span><br>            urlPathHelper.setRemoveSemicolonContent(<span class="hljs-keyword">false</span>);<br>            configurer.setUrlPathHelper(urlPathHelper);<br>        }<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addFormatters</span><span class="hljs-params">(FormatterRegistry registry)</span> </span>{<br>            registry.addConverter(<span class="hljs-keyword">new</span> Converter&lt;String, Pet&gt;() {<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">public</span> Pet <span class="hljs-title">convert</span><span class="hljs-params">(String source)</span> </span>{<br>                    <span class="hljs-comment">// dog,3</span><br>                    <span class="hljs-keyword">if</span>(!StringUtils.isEmpty(source)){<br>                        Pet pet = <span class="hljs-keyword">new</span> Pet();<br>                        String[] split = source.split(<span class="hljs-string">","</span>);<br>                        pet.setName(split[<span class="hljs-number">0</span>]);<br>                        pet.setAge(Integer.parseInt(split[<span class="hljs-number">1</span>]));<br>                        <span class="hljs-keyword">return</span> pet;<br>                    }<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                }<br>            });<br>        }<br>    };<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，当我们收到一个字符串<code>dog,3</code>的时候，也能够将其解析并封装到<code>Pet</code>中的<code>name</code>和<code>age</code>中。</p>
<h1 id="四、数据响应与内容协商"><a href="#四、数据响应与内容协商" class="headerlink" title="四、数据响应与内容协商"></a>四、数据响应与内容协商</h1><h2 id="4-1-响应JSON"><a href="#4-1-响应JSON" class="headerlink" title="4.1 响应JSON"></a>4.1 响应JSON</h2><p>SpringBoot的Web场景自动引入了JSON场景，可以返回JSON数据</p>
<h2 id="4-2-返回值解析器"><a href="#4-2-返回值解析器" class="headerlink" title="4.2 返回值解析器"></a>4.2 返回值解析器</h2><p>前面说过，controller的返回值是要经过<strong>返回值处理器（解析器）</strong>进行处理的：</p>
<ul>
<li>返回值解析器判断是否支持这种类型返回值—-<code>supportsReturnType</code></li>
<li>返回值解析器调用<code>handleReturnValue</code>处理</li>
<li><code>RequestResponseBodyMethodProcessor</code>可以处理标了<code>@ResponseBody</code>注解方法：<ul>
<li>利用<code>MessageConverters</code>进行处理，将数据写为JSON：<ul>
<li><strong>内容协商</strong>：浏览器默认会以请求头的方式告诉服务器能够接收什么类型的数据；服务器根据自己的能力，决定能生产出什么内容类型的数据。</li>
<li>其中，SpringMVC会依次遍历容器底层所有的<code>HttpMessageConverter</code>（<strong>消息转换器</strong>），看谁能对数据进行处理。比如，<code>MappingJackson2HttpMessageConverter</code>可以将对象转为JSON数据再写出去。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>SpringMVC支持的返回值类型</strong></p>
<figure class="highlight nginx"><table><tbody><tr><td class="code"><pre><code class="hljs nginx">ModelAndView<br>Model<br>View<br><span class="hljs-attribute">ResponseEntity</span> <br>ResponseBodyEmitter<br>StreamingResponseBody<br>HttpEntity<br>HttpHeaders<br>Callable<br>DeferredResult<br>ListenableFuture<br>CompletionStage<br>WebAsyncTask<br>有<span class="hljs-variable">@ModelAttribute</span>且为对象类型的<span class="hljs-variable">@ResponseBody</span> 注解,使用RequestResponseBodyMethodProcessor<br></code></pre></td></tr></tbody></table></figure>
<p><strong>关于HttpMessageConverter</strong></p>
<p><strong>消息转换器</strong>，<code>HttpMessageConverter</code>接口中有<code>canRead()</code>和<code>canWrite()</code>方法，用于判断当前消息转换器能够对数据进行读和写。</p>
<p>默认的消息转换器包括：</p>
<ul>
<li><code>ByteArrayHttpMessageConverter</code>：支持Byte类型</li>
<li><code>StringHttpMessageConverter</code>：支持String类型</li>
<li><code>ResourceHttpMessageConverter</code>：支持Resource类型</li>
<li><code>ResourceRegionHttpMessageConverter</code>：支持ResourceRegion类型</li>
<li><code>SourceHttpMessageConverter</code>：支持DOMSource、 SAXSource、 StAXSource、StreamSource、Source类型。</li>
<li><code>AllEncompassingFormHttpMessageConverter</code>：支持MultiValueMap类型</li>
<li><code>MappingJackson2HttpMessageConverter</code>：无论什么类都返回true，可以将任何类型的对象转换为浏览器所想要的数据类型；</li>
<li><code>Jaxb2RootElementHttpMessageConverter</code>：支持注解方式xml处理的</li>
</ul>
<h2 id="4-3-内容协商"><a href="#4-3-内容协商" class="headerlink" title="4.3 内容协商"></a>4.3 内容协商</h2><p>内容协商指的是，根据客户端接收能力不同，返回不同媒体类型的数据。</p>
<p>SpringBoot中的Web场景引入了JSON依赖，因此可以返回JSON数据，但没有引入XML依赖，如果想要返回XML类型的数据，需要手动引入以下依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- xml数据处理,会使返回数据类型为XML类型</span><br><span class="hljs-comment">添加这个依赖后，系统启动会自动生成MappingJackson2XmlHttpMessageConverter</span><br><span class="hljs-comment">--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.dataformat<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-dataformat-xml<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="4-3-1-开启内容协商功能"><a href="#4-3-1-开启内容协商功能" class="headerlink" title="4.3.1 开启内容协商功能"></a>4.3.1 开启内容协商功能</h3><p>SpringBoot的内容协商功能默认是关闭的，可以手动开启：</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">mvc:</span><br>    <span class="hljs-attr">contentnegotiation:</span><br>      <span class="hljs-attr">favor-parameter:</span> <span class="hljs-literal">true</span> <br></code></pre></td></tr></tbody></table></figure>
<p><strong>开启内容协商功能后，可以使用format参数指定要接收的参数类型，方便浏览器通过修改参数的方式完成内容协商。</strong></p>
<p>比如：</p>
<p><code>http://localhost:8080/test/person?format=json</code>请求会返回JSON类型的数据；</p>
<p><code>http://localhost:8080/test/person?format=xml</code>请求会返回XML类型的数据。</p>
<h3 id="4-3-2-内容协商原理"><a href="#4-3-2-内容协商原理" class="headerlink" title="4.3.2 内容协商原理"></a>4.3.2 内容协商原理</h3><p>1、首先判断当前响应头是否已经有确定的媒体类型（MediaType）</p>
<p>2、获取客户端支持接受的内容类型</p>
<p>3、遍历循环当前系统的<code>MessageConverter</code>，看谁支持操作这个对象</p>
<p>4、找到支持操作当前对象的消息转换器，把这个消息转换器支持的媒体类型统计出来。</p>
<p>5、进行内容协商，选出最佳匹配的媒体类型</p>
<p>6、用这个能够将对象转化为最佳匹配类型的转换器，进行转化</p>
<h3 id="4-3-3-自定义消息转换器"><a href="#4-3-3-自定义消息转换器" class="headerlink" title="4.3.3 自定义消息转换器"></a>4.3.3 自定义消息转换器</h3><p>参考官方文档：<a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.developing-web-applications.spring-mvc.content-negotiation">Path Matching and Content Negotiation</a></p>
<p>如果我们想定义自己的消息转换器，比如我们想要传入<code>format=gg</code>，解析为<code>application/x-guigu</code>类型。</p>
<p>首先需要定义转换器，实现<code>HttpMessageConverter</code>接口：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GuiguMessageConverter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HttpMessageConverter</span>&lt;<span class="hljs-title">Person</span>&gt; </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">canRead</span><span class="hljs-params">(Class&lt;?&gt; clazz, MediaType mediaType)</span> </span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    }<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">canWrite</span><span class="hljs-params">(Class&lt;?&gt; clazz, MediaType mediaType)</span> </span>{<br>        <span class="hljs-keyword">return</span> clazz.isAssignableFrom(Person.class);<br>    }<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    服务器要统计所有MessageConverter都能写出哪些内容类型。</span><br><span class="hljs-comment">    自定义类型application/x-guigu</span><br><span class="hljs-comment">    将自定义类型添加到能够解析的类型中</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;MediaType&gt; <span class="hljs-title">getSupportedMediaTypes</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> MediaType.parseMediaTypes(<span class="hljs-string">"application/x-guigu"</span>);<br>    }<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Person <span class="hljs-title">read</span><span class="hljs-params">(Class&lt;? extends Person&gt; clazz, </span></span><br><span class="hljs-function"><span class="hljs-params">                       HttpInputMessage inputMessage)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException, HttpMessageNotReadableException </span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">write</span><span class="hljs-params">(Person person, MediaType contentType, </span></span><br><span class="hljs-function"><span class="hljs-params">                      HttpOutputMessage outputMessage)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> IOException, HttpMessageNotWritableException </span>{<br>        <span class="hljs-comment">//自定义协议数据的写出</span><br>        String data = person.getUserName()+<span class="hljs-string">";"</span>+person.getAge()+<span class="hljs-string">";"</span>+person.getBirth();<br><br>        <span class="hljs-comment">//写出去</span><br>        OutputStream body = outputMessage.getBody();<br>        body.write(data.getBytes(StandardCharsets.UTF_8));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>然后，我们需要将我们自己的消息转换器添加到底层的消息转换器中，</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebConfig</span> </span>{<br><br>    <span class="hljs-comment">//我们需要自定义WebMvcConfigurer组件</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span>  WebMvcConfigurer <span class="hljs-title">webMvcConfigurer</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> WebMvcConfigurer() {<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">            扩展MessageConverter，以实现我们自定义的对象写成自定义格式的数据</span><br><span class="hljs-comment">            将我们自己实现的Converter添加进去即可</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">extendMessageConverters</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">                List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> </span>{<br>                converters.add(<span class="hljs-keyword">new</span> GuiguMessageConverter());<br>            }<br><br>            <span class="hljs-comment">//重写内容协商器，使客户端能够通过URL参数传递我们自定义的类型  </span><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureContentNegotiation</span><span class="hljs-params">(ContentNegotiationConfigurer configurer)</span> </span>{<br>                Map&lt;String, MediaType&gt; mediaTypeMap = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>                <span class="hljs-comment">//这里只添加三种，则参数只能传递这三种类型</span><br>                mediaTypeMap.put(<span class="hljs-string">"json"</span>,MediaType.APPLICATION_JSON);<br>                mediaTypeMap.put(<span class="hljs-string">"xml"</span>,MediaType.APPLICATION_XML);<br>                mediaTypeMap.put(<span class="hljs-string">"gg"</span>,MediaType.parseMediaType(<span class="hljs-string">"application/x-guigu"</span>));<br>                <span class="hljs-comment">//指定支持哪些参数对应的哪些媒体类型</span><br>                <span class="hljs-comment">//将基于参数的协商管理器放到里面</span><br>                ParameterContentNegotiationStrategy parameterStrategy = <span class="hljs-keyword">new</span> ParameterContentNegotiationStrategy(mediaTypeMap);<br><br>                <span class="hljs-comment">//将基于请求头的协商管理器放入</span><br>                HeaderContentNegotiationStrategy headerStrategy = <span class="hljs-keyword">new</span> HeaderContentNegotiationStrategy();<br>                configurer.strategies(Arrays.asList(parameterStrategy,headerStrategy));<br>            }<br>        };<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，我们就可以在format参数传入gg关键字，将会调用自定义的转换器转换为<code>x-guigu</code>类型。</p>
<p>注意到，我们如果重写内容协商器，可能会导致一些默认的功能失效，推荐的方式是在配置文件中使用配置，想要自定义什么就配置什么，SpringBoot已经帮我们把能够自定义的内容都绑定到了配置文件中，只需要按需配置即可。</p>
<figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">mvc:</span><br>    <span class="hljs-attr">contentnegotiation:</span><br>      <span class="hljs-attr">media-types:</span> {<span class="hljs-attr">gg:</span> <span class="hljs-string">application/x-guigu</span>}  <br></code></pre></td></tr></tbody></table></figure>
<p> 添加配置，当format参数为gg时，映射为application/x-guigu。</p>
<h1 id="五、视图解析与模版引擎"><a href="#五、视图解析与模版引擎" class="headerlink" title="五、视图解析与模版引擎"></a>五、视图解析与模版引擎</h1><p><strong>SpringBoot默认不支持JSP，需要引入第三方模版引擎技术实现页面渲染</strong></p>
<h2 id="5-1-视图解析"><a href="#5-1-视图解析" class="headerlink" title="5.1 视图解析"></a>5.1 视图解析</h2><p>视图解析流程：</p>
<p>1、目标方法处理的过程中，所有数据都会放在ModelAndViewContainer中，包括数据和视图地址</p>
<p>2、任何目标方法执行完成后，都会返回一个ModelAndView</p>
<p>3、<code>processDispatchResult</code>处理派发结果，即页面如何响应</p>
<ul>
<li>调用<code>render(mv,request,response)</code>方法进行页面渲染：<ul>
<li>根据方法的String返回值得到View对象<ul>
<li>所有的视图解析器尝试是否能根据当前返回值得到View对象，找到以后就进行渲染。</li>
<li>如果是<code>redirect</code>开头，表示重定向的返回值，则会调用<code>response.sendRedirect()</code>重定向；请求转发也是如此。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>总结：</p>
<ul>
<li>返回值以<code>forward:</code>开始，则调用 <code>new InternalResourceView(forwardUrl);</code> 进行请求转发。<ul>
<li>内部调用<code>request.getRequestDispatcher(path).forward(request, response);</code></li>
</ul>
</li>
<li><p>返回值以<code>redirect:</code>开始，则调用<code>new RedirectView()</code>进行重定向。</p>
</li>
<li><p>返回值是普通字符串：<code>new ThymeleafView()</code></p>
</li>
</ul>
<h2 id="5-2-模版引擎-Thymeleaf"><a href="#5-2-模版引擎-Thymeleaf" class="headerlink" title="5.2 模版引擎-Thymeleaf"></a>5.2 模版引擎-Thymeleaf</h2><p>Thymeleaf是现代化的服务端Java模版引擎，能够处理HTML、XML、JavaScript、CSS，甚至纯文本数据（Plain Text）。</p>
<p>SpringBoot默认不支持JSP，因此我们使用Thymeleaf模版引擎代替JSP功能。</p>
<p>Thymeleaf的使用方法参考官方<a href="https://www.thymeleaf.org/documentation.html">Thymeleaf</a>、<a href="https://www.yuque.com/atguigu/springboot/vgzmgh#GWgDb">Thymeleaf的使用</a></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>表达式名字</th>
<th>语法</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>变量取值</td>
<td>${…}</td>
<td>获取请求域、session域、对象等值</td>
</tr>
<tr>
<td>选择变量</td>
<td>*{…}</td>
<td>获取上下文对象值</td>
</tr>
<tr>
<td>消息</td>
<td>#{…}</td>
<td>获取国际化等值</td>
</tr>
<tr>
<td>链接</td>
<td>@{…}</td>
<td>生成链接</td>
</tr>
<tr>
<td>片段表达式</td>
<td>~{…}</td>
<td>jsp:include 作用，引入公共页面片段</td>
</tr>
</tbody>
</table>
</div>
<p>SpringBoot为我们自动配置好了Thymeleaf，我们只需要引入<code>Thymeleaf</code>依赖，然后开发页面即可。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_PREFIX = <span class="hljs-string">"classpath:/templates/"</span>;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEFAULT_SUFFIX = <span class="hljs-string">".html"</span>;  <span class="hljs-comment">//xxx.html</span><br></code></pre></td></tr></tbody></table></figure>
<p>此外，需要在<code>html</code>页面加入Thymeleaf命名空间：</p>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">"http://www.thymeleaf.org"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br>    ...<br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，我们的controller返回视图名的时候，底层会自动添加前缀和后缀，类似于SpringMVC的视图解析器。</p>
<p>默认情况下我们将页面放到<code>templates</code>文件夹，并且后缀名为<code>.html</code>。</p>
<h1 id="六、拦截器"><a href="#六、拦截器" class="headerlink" title="六、拦截器"></a>六、拦截器</h1><h2 id="6-1-配置拦截器"><a href="#6-1-配置拦截器" class="headerlink" title="6.1 配置拦截器"></a>6.1 配置拦截器</h2><p>自定义拦截器的步骤如下</p>
<p>1、编写一个拦截器类，实现<code>HandlerInterceptor</code>接口。</p>
<p>2、将拦截器注册到容器中，即实现<code>WebMvcConfigurer</code>的<code>addInterceptors</code>方法</p>
<p>3、指定拦截规则。如果拦截所有请求(<code>/**</code>)，静态资源也会被拦截。可以使用<strong>配置静态资源路径</strong>或<strong>手动排除静态资源请求</strong>两种方式解决。</p>
<p>代码如下：</p>
<p><strong>1、实现接口</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**使用拦截器实现登录检查的功能。验证用户登陆，保证只有用户登陆才能操作别的页面。</span><br><span class="hljs-comment"> * 1.配置好拦截器要拦截哪些请求</span><br><span class="hljs-comment"> * 2.把这些配置放在容器中</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LoginInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>{<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 目标方法执行之前，可以在这里写验证是否登陆的逻辑，然后判断是否放行</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest request, </span></span><br><span class="hljs-function"><span class="hljs-params">                             HttpServletResponse response, </span></span><br><span class="hljs-function"><span class="hljs-params">                             Object handler)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br>        <span class="hljs-comment">//登录检查逻辑</span><br>        HttpSession session = request.getSession();<br>        Object loginUser = session.getAttribute(<span class="hljs-string">"loginUser"</span>);<br>        <span class="hljs-comment">//假设只要session中有登陆用户就算登陆</span><br>        <span class="hljs-keyword">if</span>(loginUser!=<span class="hljs-keyword">null</span>){<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>; <span class="hljs-comment">//放行</span><br>        }<br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        如果被拦截，就跳转到登录页面，并将错误信息返回</span><br><span class="hljs-comment">        并根据实际情况，决定将反馈信息放在请求域还是session中</span><br><span class="hljs-comment">        */</span><br>       <br>        <span class="hljs-comment">//session.setAttribute("msg","请登录");</span><br>        <span class="hljs-comment">//response.sendRedirect("/"); //重定向</span><br>        request.setAttribute(<span class="hljs-string">"msg"</span>,<span class="hljs-string">"请登录"</span>); <br>        request.getRequestDispatcher(<span class="hljs-string">"/"</span>).forward(request,response); <br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>    }<br><br>    <span class="hljs-comment">//目标方式执行之后</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postHandle</span><span class="hljs-params">(HttpServletRequest request, </span></span><br><span class="hljs-function"><span class="hljs-params">                           HttpServletResponse response, </span></span><br><span class="hljs-function"><span class="hljs-params">                           Object handler, </span></span><br><span class="hljs-function"><span class="hljs-params">                           ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception </span>{<br><br>    }<br>    <br>    <span class="hljs-comment">//页面渲染之后</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, </span></span><br><span class="hljs-function"><span class="hljs-params">                                HttpServletResponse response, </span></span><br><span class="hljs-function"><span class="hljs-params">                                Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception </span>{}<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、放到容器中</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminWebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span> </span>{<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 配置自定义的拦截器，并设置要拦截的请求和不拦截的请求</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>{<br>        <span class="hljs-comment">//将定义好的拦截器添加到配置中，指定要拦截的请求，排除不需要拦截的请求。</span><br>        registry.addInterceptor(<span class="hljs-keyword">new</span> LoginInterceptor())<br>            .addPathPatterns(<span class="hljs-string">"/**"</span>)<br>            .excludePathPatterns(<span class="hljs-string">"/"</span>,<span class="hljs-string">"/login"</span>,<span class="hljs-string">"/css/**"</span>,<span class="hljs-string">"/js/**"</span>,<br>                                 <span class="hljs-string">"/fonts/**"</span>,<span class="hljs-string">"/images/**"</span>);  <br>        <span class="hljs-comment">//先拦截所有请求，然后排除登陆页面的请求和所有静态资源的请求</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>排除静态资源：</p>
<ul>
<li><p>方式一：排除静态资源请求，比如上述代码。</p>
</li>
<li><p>方式二：设置静态资源的访问路径，比如拦截所有以<code>/static</code>开头的静态资源请求，配置语句为：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">spring.mvc.static-path-pattern</span>=<span class="hljs-string">/static/**</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="6-2-拦截器原理"><a href="#6-2-拦截器原理" class="headerlink" title="6.2 拦截器原理"></a>6.2 拦截器原理</h2><p>1、根据当前请求，找到<code>HandlerExecutionChain</code>，即可以处理请求的<code>handler</code>以及<code>handler</code>的所有拦截器.</p>
<p>2、先<strong>顺序执行</strong>每个拦截器的<code>preHandle()</code>方法，根据这个方法的返回值决定下一步：</p>
<ul>
<li>如果当前拦截器的<code>preHandle()</code>方法返回<code>true</code>，则继续执行下一个拦截器的<code>preHandle()</code>方法</li>
<li>如果任何一个拦截器的<code>preHandle()</code>方法返回<code>false</code>，直接<strong>倒序执行</strong>所有<strong>已经执行了的拦截器</strong>的<code>afterCompletion</code>。不会执行目标方法。</li>
</ul>
<p>3、只有所有的拦截器都返回<code>true</code>的时候，才执行目标方法。</p>
<p>4、然后倒序执行所有拦截器的<code>postHandle()</code>方法。</p>
<p>5、前面的任何步骤出现异常，都会直接倒序执行afterCompletion()`方法。</p>
<p>6、页面渲染完成后，倒序执行<code>afterCompletion()</code>方法。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/springboot-web_2.png"><span class="image-caption">拦截器执行流程</span></p>
<h1 id="七、文件上传"><a href="#七、文件上传" class="headerlink" title="七、文件上传"></a>七、文件上传</h1><h2 id="7-1-实现上传和接收"><a href="#7-1-实现上传和接收" class="headerlink" title="7.1 实现上传和接收"></a>7.1 实现上传和接收</h2><p>页面表单:</p>
<figure class="highlight html"><table><tbody><tr><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- 文件上传的类型一定要是multipart/form-data --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">role</span>=<span class="hljs-string">"form"</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">"@{/upload}"</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"post"</span> <span class="hljs-attr">enctype</span>=<span class="hljs-string">"multipart/form-data"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"Enter email"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"name"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 单文件上传 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"headerImg"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 多文件上传 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"photos"</span> <span class="hljs-attr">multiple</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>服务端处理：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@PostMapping("/upload")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">upload</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("email")</span> String email,</span></span><br><span class="hljs-function"><span class="hljs-params">                     <span class="hljs-meta">@RequestParam("username")</span> String username,</span></span><br><span class="hljs-function"><span class="hljs-params">                     <span class="hljs-meta">@RequestPart("headerImg")</span> MultipartFile headerImg,</span></span><br><span class="hljs-function"><span class="hljs-params">                     <span class="hljs-meta">@RequestPart("photos")</span> MultipartFile[] photos)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br><br>    <span class="hljs-keyword">if</span>(!headerImg.isEmpty()){<br>        <span class="hljs-comment">//保存到文件服务器，OSS服务器等。这里以保存到本地为例</span><br>        String originalFilename = headerImg.getOriginalFilename();<br>        headerImg.transferTo(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"H:\\cache\\"</span>+originalFilename));<br>    }<br><br>    <span class="hljs-keyword">if</span>(photos.length &gt; <span class="hljs-number">0</span>){<br>        <span class="hljs-keyword">for</span> (MultipartFile photo : photos) {<br>            <span class="hljs-keyword">if</span>(!photo.isEmpty()){<br>                String originalFilename = photo.getOriginalFilename();<br>                photo.transferTo(<span class="hljs-keyword">new</span> File(<span class="hljs-string">"H:\\cache\\"</span>+originalFilename));<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">"main"</span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>服务端使用 <code>@RequestPart</code>注解和<code>MultipartFile</code>类型来处理文件类型的数据。</p>
<h2 id="7-2-文件上传原理"><a href="#7-2-文件上传原理" class="headerlink" title="7.2 文件上传原理"></a>7.2 文件上传原理</h2><p>1、文件上传配置类<code>MultipartAutoConfiguration</code>自动配置好了文件上传解析器<code>StandardServletMultipartResolver</code>，其组件id为<code>multipartResolver</code>。</p>
<p>2、对于接收到的请求，文件上传解析器判断(<code>isMultipart</code>)并封装（<code>resolveMultipart</code>），返回文件上传请求<code>MultipartHttpServletRequest</code></p>
<p>3、参数解析器解析请求中的文件内容，并封装成<code>MultipartFile</code></p>
<p>4、将request中的文件信息封装为Map，即<code>MultiValueMap&lt;String, MultipartFile&gt;</code>，实现文件流的拷贝。</p>
<h1 id="八、异常处理"><a href="#八、异常处理" class="headerlink" title="八、异常处理"></a>八、异常处理</h1><h2 id="8-1-默认规则"><a href="#8-1-默认规则" class="headerlink" title="8.1 默认规则"></a>8.1 默认规则</h2><p>默认情况下，Spring Boot提供<code>/error</code>处理所有错误的映射。</p>
<p>对于机器客户端，它将生成JSON响应，其中包含错误，HTTP状态和异常消息的详细信息。</p>
<p>对于浏览器客户端，响应一个“Whitelabel”错误视图，以HTML格式呈现相同的数据。</p>
<figure class="highlight 1c"><table><tbody><tr><td class="code"><pre><code class="hljs 1c"><span class="hljs-string">"timestamp"</span>:<span class="hljs-string">"2020-11-22T05:53: 28.416+00: 00"</span>,<br><span class="hljs-string">"status"</span>: <span class="hljs-number">404</span>,<br><span class="hljs-string">"error"</span>:<span class="hljs-string">"Not Found"</span>,<br><span class="hljs-string">"message"</span>:<span class="hljs-string">"No message available"</span>,<br><span class="hljs-string">"path"</span>:<span class="hljs-string">"/..."</span><br></code></pre></td></tr></tbody></table></figure>
<p>如果相对其自定义，可以手动添加一个error视图。</p>
<p>其中，/error目录下的4xx，5xx页面会被自动解析，按照状态码匹配，优先精准匹配，没有就模糊匹配。</p>
<h2 id="8-2-定制错误处理逻辑"><a href="#8-2-定制错误处理逻辑" class="headerlink" title="8.2 定制错误处理逻辑"></a>8.2 定制错误处理逻辑</h2><h3 id="8-2-1-自定义错误页"><a href="#8-2-1-自定义错误页" class="headerlink" title="8.2.1 自定义错误页"></a>8.2.1 自定义错误页</h3><p>自定义错误页：将4xx.html和5xx.html错误页放到<code>/templates</code>或<code>/static</code>目录下的<code>error</code>文件夹，即可自动匹配。优先精确匹配，然后模糊匹配。都没有，则返回<code>WhilteLabel</code></p>
<p>当发生异常时，底层会<strong>结束当前请求，并记录错误信息和状态码等信息；然后重新发送一个error请求</strong>，将HTTP的状态码作为视图页地址（viewName），找到error/4xx.html等错误页。</p>
<h3 id="8-2-2-自定义异常处理"><a href="#8-2-2-自定义异常处理" class="headerlink" title="8.2.2 自定义异常处理"></a>8.2.2 自定义异常处理</h3><p><strong>1、使用@ControllerAdvice+@ExceptionHandler处理全局异常</strong></p>
<p>比如处理空指针异常、除数为0时的异常等，可以使用这种方式。当发生指定的错误时，会执行这个方法。</p>
<p>底层是<code>ExceptionHandlerExceptionResolver</code>支持的。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 处理整个Web controller的异常,通常是全局指定类型的异常。</span><br><span class="hljs-meta">@ControllerAdvice</span>  <span class="hljs-comment">//是一种增强的Component注解</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GlobalExceptionHandler</span> </span>{<br>    <span class="hljs-comment">//指定这个方法能够处理的异常类型</span><br>    <span class="hljs-meta">@ExceptionHandler({ArithmeticException.class,NullPointerException.class})</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">handlerArithException</span><span class="hljs-params">(Exception e)</span></span>{<br>        ...<span class="hljs-comment">//进行一些处理</span><br>            <br>        <span class="hljs-comment">//即使出现异常，也应该返回一个ModelAndView</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"login"</span>;  <br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、使用@ResponseStatus+自定义异常类</strong></p>
<p>比如处理具体某个方法出现错误时，抛出自定义异常和异常信息。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//表示当发生这个类的异常时，返回给页面什么样的状态码；</span><br><span class="hljs-comment">//以403为例，返回状态码403和错误原因</span><br><span class="hljs-meta">@ResponseStatus(value = HttpStatus.FORBIDDEN,reason="用户数量太多")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserTooManyException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RuntimeException</span></span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserTooManyException</span><span class="hljs-params">()</span></span>{ }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">UserTooManyException</span><span class="hljs-params">(String message)</span></span>{<br>        <span class="hljs-keyword">super</span>(message);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>如果出现这个类的异常，会返回状态码403和错误信息。比如 <code>throw new UserTooManyException()</code>时，就会触发这个异常，然后返回信息。</p>
<p><strong>3、自定义异常解析器</strong></p>
<p>自定义的异常解析器，可以作为默认的全局异常处理规则。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//使我们自定义的异常解析器处于最高优先级</span><br><span class="hljs-meta">@Order(value = Ordered.HIGHEST_PRECEDENCE)</span>  <span class="hljs-comment">//数字越小，优先级越高</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerHandlerExceptionResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerExceptionResolver</span> </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ModelAndView <span class="hljs-title">resolveException</span><span class="hljs-params">(HttpServletRequest request,</span></span><br><span class="hljs-function"><span class="hljs-params">                                         HttpServletResponse response,</span></span><br><span class="hljs-function"><span class="hljs-params">                                         Object handler,</span></span><br><span class="hljs-function"><span class="hljs-params">                                         Exception ex)</span> </span>{<br><br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">//指定状态码的值和错误信息，第一个参数的值就做为状态码</span><br>            response.sendError (<span class="hljs-number">598</span>,<span class="hljs-string">"自定义异常解析器"</span>);<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        }<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ModelAndView();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>底层会优先遍历<code>DefaultErrorAttributes</code>和<code>HandlerExceptionResolverComposite</code>这两个，第二个里面又有三个解析器，会处理所有异常。因此想要使我们自定义的生效，必须将其优先级放到默认的两个前面。</p>
<p><code>sendError()</code>方法表示此次请求立即结束，底层tomcat服务器会抛出<code>error</code>，SpringMVC底层会专门处理这个<code>error</code>，即<code>BasicErrorController</code>处理。</p>
<p> 调用<code>response.sendError()</code>，请求会转给controller处理，如果没有解析器能够处理，则tomcat底层会执行这个方法，交给<code>basicErrorController</code>处理。</p>
<h2 id="8-3-异常处理原理"><a href="#8-3-异常处理原理" class="headerlink" title="8.3 异常处理原理"></a>8.3 异常处理原理</h2><p>1、执行目标方法，目标方法运行期间有任何异常都会被catch，而且标志当前请求结束；并且用 <code>dispatchException</code>保存catch到的异常。</p>
<p>2、进入视图解析流程：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">processDispatchResult(processedRequest, response, mappedHandler, <br>                      mv, dispatchException);<br></code></pre></td></tr></tbody></table></figure>
<p>有异常时，mv为<code>null</code>，异常信息被保存到<code>dispatchException</code>中</p>
<p>3、<code>mv = processHandlerException;</code>用于处理handler发生的异常，并处理完成返回ModelAndView，具体步骤如下：</p>
<ul>
<li>遍历所有的<code>handlerExceptionResolvers</code>，找到能处理这个异常的解析器。</li>
<li>系统默认有两个异常解析器，即<code>DefaultErrorAttributes</code>和<code>HandlerExceptionResolverComposite</code>。默认情况下，<code>DefaultErrorAttributes</code>先处理异常，把异常信息保存到请求域，并返回<code>null</code>。</li>
<li>默认情况下，没有解析器能处理异常，因此异常会被抛出：<ul>
<li>异常不能处理，则底层会发出<code>/error</code>请求，被底层的<code>BasicErrorController</code>处理</li>
<li>解析错误视图，遍历所有的错误视图解析器，看谁能处理。</li>
<li>默认的<code>DefaultErrorViewResolver</code>，作用是把响应状态码作为错误页的地址，比如<code>error/500.html</code></li>
<li>模版引擎最终会响应这个页面<code>error/500.html</code>。</li>
</ul>
</li>
</ul>
<p>错误页面的查找顺序：</p>
<figure class="highlight scheme"><table><tbody><tr><td class="code"><pre><code class="hljs scheme"><span class="hljs-symbol">'/templates/error/500.&lt;ext&gt;</span>'<br><span class="hljs-symbol">'/static/error/500.html</span>'<br><span class="hljs-symbol">'/templates/error/5xx.&lt;ext&gt;</span>'<br><span class="hljs-symbol">'/static/error/5xx.html</span>'<br></code></pre></td></tr></tbody></table></figure>
<h1 id="九、原生组件注入与嵌入式Servlet容器"><a href="#九、原生组件注入与嵌入式Servlet容器" class="headerlink" title="九、原生组件注入与嵌入式Servlet容器"></a>九、原生组件注入与嵌入式Servlet容器</h1><h2 id="9-1-原生组件注入"><a href="#9-1-原生组件注入" class="headerlink" title="9.1 原生组件注入"></a>9.1 原生组件注入</h2><p>Web原生组件，比如servlet、filter、listener注入，有两种方式。</p>
<p><strong>方式一：使用Servlet API注解</strong></p>
<p><code>@WebServlet(urlPatterns = "/my")</code></p>
<p><code>`@WebFilter(urlPatterns={"/css/*","/images/*"})</code></p>
<p><code>@WebListener</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@WebServlet(urlPatterns = "/my")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> </span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> </span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> ServletException, IOException </span>{<br>        resp.getWriter().write(<span class="hljs-string">"hello"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>用在自定义的servlet类中。这样，<code>http://localhost:8080/my</code>就可以返回”hello”</p>
<p><code>/my</code>请求会直接响应，<strong>没有被拦截器拦截</strong>。</p>
<p>如果使用以上注解，需要在主类中使用<code>@ServletComponentScan</code>进行扫描，用于指定原生Servlet、filter、listener组件的位置。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@ServletComponentScan(basePackages = "com.kang.admin")</span><br><span class="hljs-meta">@SpringBootApplication</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Application</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        SpringApplication.run(Application.class, args);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>为什么这里定义的<code>/my</code>没有被拦截器拦截呢？</strong></p>
<p>SpringMVC的请求优先经过<code>DispatcherServlet</code>，需要对其进行分析：</p>
<ul>
<li><p>容器中自动配置了<code>DispatcherServlet</code>，属性绑定到<code>WebMvcProperties</code>；对应的配置文件配置项是 <code>spring.mvc</code></p>
<blockquote>
<p>配置spring.mvc.servlet.path为dispatchSerlvet中拦截的路径</p>
<p>配置server.servlet.context-path为上下文路径，请求访问的前缀</p>
</blockquote>
</li>
<li><p>也是通过 <code>ServletRegistrationBean&lt;DispatcherServlet&gt;</code>把 DispatcherServlet 配置进来。</p>
</li>
<li><p>默认映射的是<code>/</code>路径</p>
</li>
</ul>
<p>Tomcat-Servlet，如果多个Servlet都能处理到同一层路径，<strong>精确优先</strong>原则。因此对于<code>/</code>和<code>/my</code>来说，<code>/my</code>请求精准匹配到自定义的servlet，因此不会经过<code>dispatcherServlet</code>处理，所以不会被拦截器拦截。</p>
<p><strong>方式二：使用RegistrationBean</strong></p>
<p>如果不使用注解，还可以手动实现一个配置类，将它们注入。</p>
<p>在配置类中：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyRegistConfig</span> </span>{<br>    <span class="hljs-comment">//注入servlet</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ServletRegistrationBean <span class="hljs-title">myServlet</span><span class="hljs-params">()</span></span>{<br>        MyServlet myServlet = <span class="hljs-keyword">new</span> MyServlet();<br>        <span class="hljs-comment">//指定要映射的请求，可以指定多个</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServletRegistrationBean(myServlet,<span class="hljs-string">"/my"</span>,<span class="hljs-string">"/my01"</span>);<br>    }<br><br>    <span class="hljs-comment">//注入filter</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title">myFilter</span><span class="hljs-params">()</span></span>{<br>        MyFilter myFilter = <span class="hljs-keyword">new</span> MyFilter();<br>        <span class="hljs-comment">//方式一：使用过滤现有的servlet请求路径</span><br>        <span class="hljs-comment">//return new FilterRegistrationBean(myFilter,myServlet());</span><br><br>        <span class="hljs-comment">//方式二：自定义过滤路径</span><br>        FilterRegistrationBean filterRegistrationBean = <span class="hljs-keyword">new</span> FilterRegistrationBean(myFilter);<br>        filterRegistrationBean.setUrlPatterns(Arrays.asList(<span class="hljs-string">"/filter"</span>,<span class="hljs-string">"/filter2"</span>));<br>        <span class="hljs-keyword">return</span> filterRegistrationBean;<br>    }<br>    <span class="hljs-comment">//注入listener</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> ServletListenerRegistrationBean <span class="hljs-title">myListener</span><span class="hljs-params">()</span></span>{<br>        MyServletContextListener myServletContextListener = <span class="hljs-keyword">new</span> MyServletContextListener();<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ServletListenerRegistrationBean(myServletContextListener);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="9-2-嵌入式Servlet容器"><a href="#9-2-嵌入式Servlet容器" class="headerlink" title="9.2 嵌入式Servlet容器"></a>9.2 嵌入式Servlet容器</h2><p>SpringBoot内嵌了web服务器，比如tomcat、Jetty、Undertow。默认使用的是tomcat</p>
<p>在<code>pom.xml</code>中排除tomcat依赖，再将要切换到的服务器的starter导入即可实现切换：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>我们还可以定制servlet容器，根据文档或者仿照源码。</p>
<h1 id="十、定制化总结"><a href="#十、定制化总结" class="headerlink" title="十、定制化总结"></a>十、定制化总结</h1><p>SpringBoot中的Web项目定制化的几种方式</p>
<ul>
<li>修改配置文件；</li>
<li><p>xxxxxCustomizer定制器；</p>
</li>
<li><p>编写自定义的配置类，然后用<code>@Bean</code>替换、增加容器中默认组件；</p>
</li>
<li>对于Web应用，还可以编写一个配置类实现<code>WebMvcConfigurer</code>接口， 即可定制化web功能；使用@Bean可以给容器中再扩展一些组件；比如：</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AdminWebConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span></span><br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><code>@EnableWebMvc</code> + <code>WebMvcConfigurer</code>可以全面接管SpringMVC，使用这种方式，所有自动配置的功能会全部失效，需要全部自己重新配置； 配合<code>@Bean</code>实现定制和扩展功能。</li>
</ul>
<blockquote>
<p>@EnableWebMvc会使SpringBoot关于WebMVC的自动配置全部失效，其功能都需要自己写。</p>
</blockquote>
<p>一般分析自动配置的流程：场景启动器—&gt;xxxAutoConfiguration—&gt;导入xxx组件，绑定xxxProperies—&gt;其绑定了配置文件中的配置项。</p>
]]></content>
      <categories>
        <category>SpringBoot2</category>
      </categories>
      <tags>
        <tag>SpringBoot2</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ学习笔记</title>
    <url>/2021/10/26/rabbitmq/</url>
    <content><![CDATA[<h1 id="一、消息队列"><a href="#一、消息队列" class="headerlink" title="一、消息队列"></a>一、消息队列</h1><h2 id="1-1-MQ相关概念"><a href="#1-1-MQ相关概念" class="headerlink" title="1.1 MQ相关概念"></a>1.1 MQ相关概念</h2><h3 id="1-1-1-什么是MQ"><a href="#1-1-1-什么是MQ" class="headerlink" title="1.1.1 什么是MQ"></a>1.1.1 什么是MQ</h3><p>消息队列（MQ，Message Queue）本质是一个队列，队列中存放的内容是message，是一种跨进程的通信机制，用于上下游传递消息。</p>
<p>使用MQ以后，消息发送上游只需要依赖MQ，不用依赖其他服务。</p>
<h3 id="1-1-2-MQ的作用"><a href="#1-1-2-MQ的作用" class="headerlink" title="1.1.2 MQ的作用"></a>1.1.2 MQ的作用</h3><ul>
<li><p>流量削峰</p>
</li>
<li><p>应用解耦</p>
</li>
<li><p>异步处理</p>
</li>
</ul>
<h3 id="1-1-3-MQ分类"><a href="#1-1-3-MQ分类" class="headerlink" title="1.1.3 MQ分类"></a>1.1.3 MQ分类</h3><p>常见的MQ有以下几种：</p>
<ul>
<li>ActiveMQ：高吞吐量场景较少使用。</li>
<li>Kafka：为大数据而生，百万级TPS，吞吐量高，在日志领域比较成熟。适合有日志采集需求的大型企业。</li>
<li>RocketMQ：出自阿里巴巴，单机吞吐量十万级，消息0丢失，支持10亿级别的消息堆积。适合金融互联网。</li>
<li>RabbitMQ：由Erlang语言开发，在AMQP（高级消息队列协议）基础上完成，当前最流行的MQ。吞吐量万级，支持多种语言。适合数据量不是特别大的中小型公司。</li>
</ul>
<h2 id="1-2-RabbitMQ"><a href="#1-2-RabbitMQ" class="headerlink" title="1.2 RabbitMQ"></a>1.2 RabbitMQ</h2><h3 id="1-2-1-核心概念"><a href="#1-2-1-核心概念" class="headerlink" title="1.2.1 核心概念"></a>1.2.1 核心概念</h3><p><strong>RabbitMQ</strong></p>
<p>RabbitMQ是一个消息中间件，它接受、存储、转发消息数据。</p>
<p><strong>生产者（Producer）</strong></p>
<p>产生数据、发送消息的程序是生产者。</p>
<p><strong>交换机（Exchange）</strong></p>
<p>交换机是RabbitMQ的一个重要组件。它一方面接收来自生产者的消息，另一方面将消息推送到队列中。交换机决定了将消息推送到特定队列还是推送到多个队列。</p>
<p><strong>队列（Queue）</strong></p>
<p>队列是RabbitMQ内部使用的一种数据结构。消息只能存储在队列中，队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。许多生产者可以将消息发送到一个队列，许多消费者也可以尝试从一个队列接收数据。</p>
<p><strong>消费者（Consumer）</strong></p>
<p>消费者指的是等待接受消息的程序。同一个应用程序既可以是生产者也可以是消费者。</p>
<h3 id="1-2-2-安装"><a href="#1-2-2-安装" class="headerlink" title="1.2.2 安装"></a>1.2.2 安装</h3><p>RabbitMQ官方文档：<a href="https://www.rabbitmq.com/documentation.html">Docs</a></p>
<p>RabbitMQ基于Erlang环境，因此需要先安装Erlang。</p>
<p>安装之前需要确保RabbitMQ和Erlang的版本要对应：<a href="https://www.rabbitmq.com/which-erlang.html">RabbitMQ Erlang Version Requirements</a></p>
<p>本机环境：</p>
<ul>
<li>CentOS-7.9</li>
<li>Erlang-23.2.3</li>
<li>RabbitMQ-3.8.15</li>
</ul>
<p>使用<code>rpm</code>方式，在packagecloud网站下载安装包。</p>
<p><strong>1、安装Erlang</strong></p>
<p>下载对应版本的安装包，<a href="https://packagecloud.io/rabbitmq/erlang?page=1">packagecloud</a>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">wget --content-disposition https://packagecloud.io/rabbitmq/erlang/packages/el/7/erlang-23.2.3-1.el7.x86_64.rpm/download.rpm<br></code></pre></td></tr></tbody></table></figure>
<p>安装：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rpm -ivh erlang-23.2.3-1.el7.x86_64.rpm<br></code></pre></td></tr></tbody></table></figure>
<p>安装完后，输入<code>erl</code>进入Erlang的命令行界面，安装成功。</p>
<p><strong>2、安装socat</strong></p>
<p>除了Erlang环境，还需要安装socat：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">yum install socat logrotate -y<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、安装RabbitMQ</strong></p>
<p>下载对应版本的安装包，<a href="https://packagecloud.io/rabbitmq/rabbitmq-server?page=1">packagecloud</a>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">wget --content-disposition https://packagecloud.io/rabbitmq/rabbitmq-server/packages/el/8/rabbitmq-server-3.8.15-1.el8.noarch.rpm/download.rpm<br></code></pre></td></tr></tbody></table></figure>
<p>安装：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rpm -ivh rabbitmq-server-3.8.15-1.el8.noarch.rpm<br></code></pre></td></tr></tbody></table></figure>
<p>安装完成后，启动rabbit服务：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">systemctl start rabbitmq-server.service<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、安装插件</strong></p>
<p>可以通过以下命令开启web管理插件，需要先停止rabbitmq服务：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_management<br></code></pre></td></tr></tbody></table></figure>
<p>插件开启成功后就可以在浏览器中访问，默认端口号为<code>15672</code>（记得关闭防火墙或者开放端口）。</p>
<p>管理界面需要账号密码登陆，默认的账号和密码都是<code>guest</code>。</p>
<p>查看当前所有用户：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rabbitmqctl list_users<br></code></pre></td></tr></tbody></table></figure>
<p>添加新用户<code>admin</code>，密码也为<code>admin</code>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rabbitmqctl add_user admin admin<br></code></pre></td></tr></tbody></table></figure>
<p>设置用户角色（标签），将<code>admin</code>设置为<code>administrator</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rabbitmqctl set_user_tags admin administrator<br></code></pre></td></tr></tbody></table></figure>
<p>设置用户权限：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rabbitmqctl set_permissions -p <span class="hljs-string">"/"</span> admin <span class="hljs-string">".*"</span> <span class="hljs-string">".*"</span> <span class="hljs-string">".*"</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="1-2-3-原理和工作模式"><a href="#1-2-3-原理和工作模式" class="headerlink" title="1.2.3 原理和工作模式"></a>1.2.3 原理和工作模式</h3><p><strong>工作原理</strong></p>
<p>RabbitMQ的工作原理如图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_1.png"><span class="image-caption">RabbitMQ工作原理</span></p>
<p>生产者将消息通过Channel发送到Exchange，Exchange决定将消息分发到哪个队列，然后由消费者从队列中接收消息。</p>
<p>其中的核心概念：</p>
<ul>
<li><strong>Broker</strong>：接收和分发消息的应用，RabbitMQ Server就是Message Broker</li>
<li><strong>Virtual host</strong>：虚拟的分组，当多个不同的用户使用同一个RabbitMQ server提供的服务时，可以划分出多个vhost，每个用户在自己的vhost创建exchange/queue等。</li>
<li><strong>Connection</strong>：publisher/consumer和broker之间的TCP连接。</li>
<li><strong>Channel</strong>：Channel是在connection内部建立的逻辑连接，多线程情况下通常每个线程创建单独的channel进行通讯。AMQP method包含了channel id帮助客户端和broker识别channel，<strong>channel是完全隔离的</strong>。<strong>Channel作为轻量级的Connection极大减少了操作系统建立TCP connection的开销。</strong></li>
<li><strong>Exchange</strong>：交换机。消息到达broker中会首先到达Exchange，Exchange根据分发规则，匹配查询表中的routing key，分发消息到queue中去。常用的类型有：direct（point-to-point）、topic（publish-subscribe）、fanout（multicast）。</li>
<li><strong>Queue</strong>：消息被送到Queue中，然后被消费者取走。</li>
<li><strong>Binding</strong>：<strong>exchange</strong>和<strong>queue</strong>之间的虚拟连接。binding中可以包含Routing key，binding信息被保存到exchange中的查询表中，用于message的分发依据。声明binding关系的时候，可以声明RoutingKey参数</li>
</ul>
<p><strong>工作模式</strong></p>
<p>RabbitMQ一共有7种工作模式，参考<a href="https://www.rabbitmq.com/getstarted.html">Get Started</a>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_2.png"><span class="image-caption">RabbitMQ工作模式</span></p>
<h1 id="二、Hello-World"><a href="#二、Hello-World" class="headerlink" title="二、Hello World"></a>二、Hello World</h1><h2 id="2-1-介绍"><a href="#2-1-介绍" class="headerlink" title="2.1 介绍"></a>2.1 介绍</h2><p><a href="https://www.rabbitmq.com/tutorials/tutorial-one-java.html">Hello World</a>模式是RabbitMQ最简单的一个模式。下图中的P表示生产者，C是消费者，中间框是一个队列，是RabbitMQ代表消费者保存的消息缓冲区。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_3.png"><span class="image-caption">Hello World模式</span></p>
<h2 id="2-2-实现"><a href="#2-2-实现" class="headerlink" title="2.2 实现"></a>2.2 实现</h2><p><strong>1、在IDEA中创建Maven项目，然后引入依赖：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.rabbitmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>amqp-client<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.8.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-io<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、编写生产者的代码</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span> </span>{<br>    <span class="hljs-comment">// 队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_NAME = <span class="hljs-string">"hello"</span>;<br><br>    <span class="hljs-comment">//发消息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>{<br>        <span class="hljs-comment">//创建一个连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//设置工厂的ip，连接队列</span><br>        factory.setHost(<span class="hljs-string">"192.168.198.198"</span>); <span class="hljs-comment">//RabbitMQ服务主机的ip</span><br>        <span class="hljs-comment">//设置用户名和密码</span><br>        factory.setUsername(<span class="hljs-string">"admin"</span>);<br>        factory.setPassword(<span class="hljs-string">"admin"</span>);<br><br>        <span class="hljs-comment">//创建连接，每个连接有多个channel，channel是用来发消息的。</span><br>        Connection connection = factory.newConnection();<br><br>        <span class="hljs-comment">//获取channel</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">//生成一个队列用于通信，简单起见，使用默认的交换机</span><br>        channel.queueDeclare(QUEUE_NAME, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">//发消息</span><br>        String message = <span class="hljs-string">"hello, world"</span>;<br>        channel.basicPublish(<span class="hljs-string">""</span>, QUEUE_NAME, <span class="hljs-keyword">null</span>, message.getBytes());<br>        System.out.println(<span class="hljs-string">"消息发送完毕！"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>其中关键方法的说明：</p>
<ul>
<li><code>queueDeclare()</code>，用于声明一个队列，其中的各个参数依次解释如下：<ul>
<li>队列名。</li>
<li>队列的消息是否持久化，默认情况下消息存储在内存中(不持久化）。</li>
<li>该队列是否进行消费共享，true表示允许多个消费者消费。</li>
<li>是否自动删除 最后一个消费者端开连接以后，该队列是否自动删除。</li>
<li>其他参数。</li>
</ul>
</li>
<li><code>basicPublish()</code>，用于发布消息：<ul>
<li>交换机名称，用于指定发送到哪个交换机。</li>
<li>routingKey，路由的key值。这里使用的是channel名字作为routingKey</li>
<li>其他参数信息。</li>
<li>发送消息的消息体。</li>
</ul>
</li>
</ul>
<p><strong>3、编写消费者的代码</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer</span> </span>{<br>    <span class="hljs-comment">// 队列名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_NAME = <span class="hljs-string">"hello"</span>;<br>    <br>    <span class="hljs-comment">//接收消息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException, TimeoutException </span>{<br>        <span class="hljs-comment">//创建连接工厂</span><br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        <span class="hljs-comment">//设置ip</span><br>        factory.setHost(<span class="hljs-string">"192.168.198.198"</span>);<br>        <span class="hljs-comment">//设置用户名和密码</span><br>        factory.setUsername(<span class="hljs-string">"admin"</span>);<br>        factory.setPassword(<span class="hljs-string">"admin"</span>);<br>        <span class="hljs-comment">//创建连接</span><br>        Connection connection = factory.newConnection();<br>        <span class="hljs-comment">//创建信道</span><br>        Channel channel = connection.createChannel();<br><br>        <span class="hljs-comment">//消费者接收消息（消费消息）</span><br>        <span class="hljs-comment">//接收消息的回调函数</span><br>        DeliverCallback deliverCallback = (consumerTag,message)-&gt;{<br>            System.out.println(<span class="hljs-keyword">new</span> String(message.getBody()));<br>        };<br>        CancelCallback cancelCallback = (consumerTag)-&gt;{<br>            System.out.println(<span class="hljs-string">"消息消费被中断"</span>);<br>        };<br>        channel.basicConsume(QUEUE_NAME,<span class="hljs-keyword">true</span>, deliverCallback,cancelCallback);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>basicConsume()</code>的参数说明：</p>
<ul>
<li>指定消费的队列名，即从哪个队列中取消息。</li>
<li>消费成功之后是否自动应答。</li>
<li>消费者接收的回调函数。</li>
<li>消费者取消消费的回调函数。</li>
</ul>
<blockquote>
<p>如果需要修改现有的exchange和queue，需要删除现有的队列，重新创建。</p>
</blockquote>
<p><strong>4、运行</strong></p>
<p>启动生产者程序，会创建Channel并发送消息，然后启动消费者程序，会收到来自生产者的消息。</p>
<h1 id="三、Work-Queues"><a href="#三、Work-Queues" class="headerlink" title="三、Work Queues"></a>三、Work Queues</h1><p><a href="https://www.rabbitmq.com/tutorials/tutorial-two-java.html">Work Queues</a>模式的主要思想是避免因立即执行资源密集型任务而不得不等待它完成。在这个模式中，我们将任务封装为消息，并将其发送到队列。当有多个工作线程时，这些工作线程将一起处理这些任务。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_4.png"><span class="image-caption">Work Queues</span></p>
<h2 id="3-1-轮询分发消息"><a href="#3-1-轮询分发消息" class="headerlink" title="3.1 轮询分发消息"></a>3.1 轮询分发消息</h2><p>Work Queues模式下使用的轮询分发的机制，对于多个消费者线程，会轮流分发任务。</p>
<p>下面我们以一个生产者，两个消费者线程来模拟。</p>
<p><strong>抽取工具类</strong></p>
<p>创建channel之前的代码是相同的，因此可以单独抽取出来，作为工具类：</p>
<p><code>RabbitMqUtils.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RabbitMqUtils</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Channel <span class="hljs-title">getChannel</span><span class="hljs-params">()</span></span>{<br>        ConnectionFactory factory = <span class="hljs-keyword">new</span> ConnectionFactory();<br>        factory.setHost(<span class="hljs-string">"192.168.198.198"</span>);<br>        factory.setUsername(<span class="hljs-string">"admin"</span>);<br>        factory.setPassword(<span class="hljs-string">"admin"</span>);<br>        Connection connection = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            connection = factory.newConnection();<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        } <span class="hljs-keyword">catch</span> (TimeoutException e) {<br>            e.printStackTrace();<br>        }<br>        Channel channel = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">try</span> {<br>            channel = connection.createChannel();<br>        } <span class="hljs-keyword">catch</span> (IOException e) {<br>            e.printStackTrace();<br>        }<br>        <span class="hljs-keyword">return</span> channel;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>生产者</strong></p>
<p>启动发送线程：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Task01</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_NAME = <span class="hljs-string">"hello"</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br>        channel.queueDeclare(QUEUE_NAME,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br><br>        <span class="hljs-comment">//从控制台接收信息发送到消费者</span><br>        Scanner scanner = <span class="hljs-keyword">new</span> Scanner(System.in);<br>        <span class="hljs-keyword">while</span>(scanner.hasNext()){<br>            String message = scanner.next();<br>            channel.basicPublish(<span class="hljs-string">""</span>,QUEUE_NAME,<span class="hljs-keyword">null</span>,message.getBytes());<br>            System.out.println(message+<span class="hljs-string">"发送完成！"</span>);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>启动两个工作线程</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker01</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_NAME = <span class="hljs-string">"hello"</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br>        <span class="hljs-comment">//消息的接收</span><br>        DeliverCallback deliverCallback = (consumerTag,message)-&gt;{<br>            System.out.println(<span class="hljs-string">"接收到的消息："</span>+<span class="hljs-keyword">new</span> String(message.getBody()));<br>        };<br>        CancelCallback cancelCallback = (consumerTag)-&gt;{<br>            System.out.println(consumerTag+<span class="hljs-string">"消息被取消接受"</span>);<br>        };<br>        System.out.println(<span class="hljs-string">"Consumer 1------"</span>);<br>        channel.basicConsume(QUEUE_NAME,<span class="hljs-keyword">true</span>,deliverCallback,cancelCallback);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>使用IDEA设置并行运行，<code>Edit Configurations</code>-&gt;<code>Allow multiple instances</code>，这样可以同时启动两个消费者线程。</p>
<p><strong>运行</strong></p>
<p>生产者发送消息，消费者1和消费者2会轮流处理消息。</p>
<p>比如生产者发送1、2、3、4、5、6，消费者1接收到1、3、5，消费者2接收到2、4、6。</p>
<h2 id="3-2-消息应答"><a href="#3-2-消息应答" class="headerlink" title="3.2 消息应答"></a>3.2 消息应答</h2><p><strong>概念</strong></p>
<p>消费者完成一个任务需要耗费一定的时间，RabbitMQ一旦向消费者发送消息后，会将此消息标记为删除，这种情况下，如果消费者处理任务的过程中出现故障，会导致任务丢失。<strong>为了保证消息不会丢失，RabbitMQ引入了消息应答机制</strong>。</p>
<p><strong>消息应答（Message acknowledgment）</strong>：消费者在接收到消息并且处理完该消息之后，告诉RabbitMQ此消息已经被处理，RabbitMQ可以将该消息删除。这样就保证当某一个消费者线程故障后，消息会被重新发送给其他消费者，确保消息不会丢失（前提是RabbitMQ无故障）。</p>
<p>消息应答包括<strong>自动应答</strong>和<strong>手动应答</strong>两种方式：</p>
<ul>
<li><strong>自动应答</strong>：消息发送后立即被认为已经传送成功。这种方式没有对传递的消息数量做限制，会导致消费者端消息积压，线程被系统杀死。这种模式仅适用于消费者可以高效并以某种速率能够处理这些消息的情况下使用。</li>
<li><strong>手动应答</strong>：默认是手动应答模式。如果一个消费者线程宕机，其消息可以被其他消费者线程消费，而不会出现消息丢失的情况。</li>
</ul>
<p>手动应答示例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 消息在手动应答时不丢失、放回队列中重新消费</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Worker03</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TASK_QUEUE_NAME = <span class="hljs-string">"ack_queue"</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel(); <span class="hljs-comment">//获取channel</span><br>        System.out.println(<span class="hljs-string">"消费者1等待接收消息，处理时间较短------"</span>);<br><br>        <span class="hljs-comment">//手动应答</span><br>        <span class="hljs-keyword">boolean</span> autoAck = <span class="hljs-keyword">false</span>;<br>        DeliverCallback deliverCallback = (consumerTag, message)-&gt;{<br>            <span class="hljs-comment">//沉睡1s，模拟处理信息场景。</span><br>            SleepUtils.sleep(<span class="hljs-number">1</span>); <span class="hljs-comment">//工具类SleepUtils用来睡眠线程。</span><br>            System.out.println(<span class="hljs-string">"接收到的消息："</span>+<span class="hljs-keyword">new</span> String(message.getBody(),<span class="hljs-string">"UTF-8"</span>));<br>            <span class="hljs-comment">//手动应答。参数1为消息的标记tag，参数2表示是否批量应答</span><br>            channel.basicAck(message.getEnvelope().getDeliveryTag(),<span class="hljs-keyword">false</span>);<br>        };<br>        CancelCallback cancelCallback = (consumerTag)-&gt;{<br>            System.out.println(consumerTag+<span class="hljs-string">"消息被取消接受"</span>);<br>        };<br>        <span class="hljs-comment">//设置为手动应答</span><br>        channel.basicConsume(TASK_QUEUE_NAME,autoAck,deliverCallback,cancelCallback);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>手动应答主要是在接收消息的回调方法中调用<code>basicAck()</code>方法，已经在<code>basicConsume()</code>方法中设置自动应答方式为false。</p>
<p>其中<code>basicAck()</code>方法的第二个参数表示是否批量化应答。如果是<strong>批量化应答(Multiple)</strong>，则每次会应答一个批次的消息。</p>
<p><strong>手动应答的好处就是可以批量应答并且减少网络拥堵</strong>。</p>
<p><strong>消息重新入队</strong>：如果某个消费者由于某些原因失去连接（或发生故障），导致消息未发送ACK确认，RabbitMQ将了解到消息未完全处理，并将其重新排队发送给其他消费者。这样，即使某个消费者偶尔死亡，也可以确保不丢失消息。</p>
<h2 id="3-3-RabbitMQ持久化"><a href="#3-3-RabbitMQ持久化" class="headerlink" title="3.3 RabbitMQ持久化"></a>3.3 RabbitMQ持久化</h2><p><strong>消息应答</strong>能够确保消费者线程故障后，消息不会丢失，如何保障当RabbitMQ服务停掉以后消息也不丢失？</p>
<p>这就<strong>需要将队列和消息都标记为持久化。</strong></p>
<p><strong>队列持久化</strong></p>
<p>在声明队列时将是否持久化的参数置为<code>true</code>即可：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">channel.queueDeclare(TASK_QUEUE_NAME,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br></code></pre></td></tr></tbody></table></figure>
<p>第二个参数就表示是否持久化队列。</p>
<p>如果已经存在的队列需要持久化，需要将队列删除，重新创建。</p>
<p><strong>消息持久化</strong></p>
<p>仅将队列持久化不能保证消息不丢失，因为如果消费者线程宕机断开连接，仍然有可能出现消息丢失的情况。</p>
<p>设置消息持久化，需要在<code>channel</code>发布消息时设置：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">channel.basicPublish(<span class="hljs-string">""</span>,TASK_QUEUE_NAME, MessageProperties.PERSISTENT_TEXT_PLAIN,message.getBytes(<span class="hljs-string">"UTF-8"</span>));<br></code></pre></td></tr></tbody></table></figure>
<p>这种方式只是尽量保证持久化，如果绝对保证持久化，需要使用发布确认机制。</p>
<p><strong>预取值</strong></p>
<p><code>basicQos()</code>方法可以设置消费者线程的预取值。</p>
<p>预取值表示一个消费者线程对应的信道最大可以堆积的消息个数，即<strong>通道上允许的未确认消息的最大数量</strong>。</p>
<blockquote>
<p>类似于缓冲池，预取值最大值就是缓存池的最大值。最多只能存放预取值个数的未确认消息。</p>
</blockquote>
<p>如果不设置预取值，可能会有大量已传递但尚未处理的消息的数量堆积，导致消费者RAM消耗。</p>
<p><strong>不公平分发</strong></p>
<p>轮询方式是不管每个消费者的处理速度，给每个消费者线程轮流分发任务。</p>
<p>不公平分发是指<strong>根据每个消费者线程的处理能力，为每个消费者线程分配不同个数的消息</strong>。——能者多劳。</p>
<p>在<strong>消费者</strong>的信道上，设置Qos的值为1，就可以表示按处理能力分发：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//将Qos设置为1，就是不公平分发；默认为0，表示轮询分发</span><br>channel.basicQos(<span class="hljs-number">1</span>); <br></code></pre></td></tr></tbody></table></figure>
<p>Qos的值为1时，表示根据消费者线程的处理能力分发，最多堆积一个任务。</p>
<h1 id="四、发布确认"><a href="#四、发布确认" class="headerlink" title="四、发布确认"></a>四、发布确认</h1><p>如果想要确保消息一定不会丢失，除了上面提到的<strong>队列持久化</strong>和<strong>消息持久化</strong>，还需要使用<strong>发布确认（Publisher confirm）</strong>。这三种设置保证了消息不会丢失。</p>
<p>官方文档：<a href="https://www.rabbitmq.com/tutorials/tutorial-seven-java.html">Publisher Confirms</a></p>
<h2 id="4-1-发布确认原理"><a href="#4-1-发布确认原理" class="headerlink" title="4.1 发布确认原理"></a>4.1 发布确认原理</h2><p>生产者将channel设置为confirm模式，一旦channel进入<strong>confirm模式</strong>，<strong>所有在该channel上面发布的消息都会被指派一个唯一的ID（从1开始）</strong>。一旦消息被投递到所有匹配的队列之后，broker会发送一个确认给生产者。</p>
<p>生产者得知消息已经正确到达目的队列后，如果消息和队列是可持久化的，确认消息会在消息写入磁盘后发出。</p>
<blockquote>
<p>broker回传给生产者的确认消息中delivery-tag域中包含了确认消息的序列号，此外broker也可以设置basic.ack的multiple域，表示到这个序列号之前的所有消息都已经得到了处理。</p>
<p><strong>发布确认（Publisher confirm）是broker给生产者发送的确认消息。</strong></p>
<p><strong>消息应答（Message acknowledgment）是消费者处理完消息发送给broker的ack确认。</strong></p>
</blockquote>
<p><strong>confirm模式</strong>的好处在于它是异步的，发布一条消息后，生产者可以边等确认消息边发送下一条消息。消息得到确认或者丢失，生产者都会通过相应的回调方法进行处理。</p>
<h2 id="4-2-发布确认策略"><a href="#4-2-发布确认策略" class="headerlink" title="4.2 发布确认策略"></a>4.2 发布确认策略</h2><h3 id="4-2-1-开启发布确认"><a href="#4-2-1-开启发布确认" class="headerlink" title="4.2.1 开启发布确认"></a>4.2.1 开启发布确认</h3><p>生产者创建信道后，调用<code>confirmSelect()</code>方法即可开启发布确认模式。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">channel.confirmSelect();<br></code></pre></td></tr></tbody></table></figure>
<p>发布确认可以有单个确认、批量确认、异步确认三种方式。</p>
<h3 id="4-2-2-单个确认发布"><a href="#4-2-2-单个确认发布" class="headerlink" title="4.2.2 单个确认发布"></a>4.2.2 单个确认发布</h3><p>单个确认发布，即对每一条消息进行同步确认，生产者发布一条消息后只有它被确认发布后，后续的消息才能继续发布。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publishMessageIndividually</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>{<br>    Channel channel = RabbitMqUtils.getChannel();<br>    <span class="hljs-comment">//信道名字使用随机的UUID</span><br>    String queueName = UUID.randomUUID().toString();<br>    channel.queueDeclare(queueName,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>    <span class="hljs-comment">//开启发布确认</span><br>    channel.confirmSelect();<br>    <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>    <span class="hljs-comment">//批量发消息</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++){<br>        String message = i+<span class="hljs-string">""</span>;<br>        channel.basicPublish(<span class="hljs-string">""</span>,queueName,<span class="hljs-keyword">null</span>,message.getBytes());<br>        <span class="hljs-comment">//单个消息马上确认</span><br>        <span class="hljs-keyword">boolean</span> flag = channel.waitForConfirms();<br>        <span class="hljs-keyword">if</span>(flag){<br>            System.out.println(<span class="hljs-string">"第"</span>+i+<span class="hljs-string">"条消息发送成功"</span>);<br>        }<br>    }<br>    <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">"发布1000个单独确认消息，耗时"</span>+(end-start)+<span class="hljs-string">"ms"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>单个确认发布的速度是最慢的，因为要每条消息都确认一次。</p>
<h3 id="4-2-3-批量确认发布"><a href="#4-2-3-批量确认发布" class="headerlink" title="4.2.3 批量确认发布"></a>4.2.3 批量确认发布</h3><p>批量确认发布是指根据批次大小确认发布，这种方式的缺点是当发生故障导致发布出现问题时，不知道哪个消息出问题。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//批量发布确认</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publishMessageBatch</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>{<br>    Channel channel = RabbitMqUtils.getChannel();<br>    <span class="hljs-comment">//信道名字使用随机的UUID</span><br>    String queueName = UUID.randomUUID().toString();<br>    channel.queueDeclare(queueName,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>    <span class="hljs-comment">//开启发布确认</span><br>    channel.confirmSelect();<br>    <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>    <span class="hljs-comment">//批量发消息，并批量确认消息</span><br>    <span class="hljs-keyword">int</span> batchSize = <span class="hljs-number">100</span>; <span class="hljs-comment">//每100条确认一次</span><br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++){<br>        String message = i+<span class="hljs-string">""</span>;<br>        channel.basicPublish(<span class="hljs-string">""</span>,queueName,<span class="hljs-keyword">null</span>,message.getBytes());<br>        <span class="hljs-keyword">if</span>((i+<span class="hljs-number">1</span>)%batchSize==<span class="hljs-number">0</span>){ <span class="hljs-comment">//每100条消息确认一次</span><br>            <span class="hljs-keyword">boolean</span> flag = channel.waitForConfirms();<br>            <span class="hljs-keyword">if</span>(flag){<br>                System.out.println(<span class="hljs-string">"确认前"</span>+i+<span class="hljs-string">"条数据"</span>);<br>            }<br>        }<br>    }<br>    <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">"发布1000个批量确认消息，耗时"</span>+(end-start)+<span class="hljs-string">"ms"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<h3 id="4-2-4-异步确认发布"><a href="#4-2-4-异步确认发布" class="headerlink" title="4.2.4 异步确认发布"></a>4.2.4 异步确认发布</h3><p>异步确认发布是效率和可靠性最高的。对于已确认消息和未确认消息，异步确认方式都能够处理。</p>
<p>异步确认发布主要是通过<code>addConfirmListener</code>方法监听确认和未确认的消息，使用哈希表记录所有发布的消息，对于成功确认的消息从哈希表中删除，剩下的是未确认的消息。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//异步批量确认</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publishMessageAsync</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception</span>{<br>    Channel channel = RabbitMqUtils.getChannel();<br>    <span class="hljs-comment">//信道名字使用随机的UUID</span><br>    String queueName = UUID.randomUUID().toString();<br>    channel.queueDeclare(queueName,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>    <span class="hljs-comment">//开启发布确认</span><br>    channel.confirmSelect();<br><br>    <span class="hljs-comment">//使用哈希表记录所有消息，便于多个线程进行消息的添加和删除</span><br>    <span class="hljs-comment">/*线程安全的哈希表，适用于高并发的情况。</span><br><span class="hljs-comment">    1.哈希表能够轻松的将序号和消息进行关联。</span><br><span class="hljs-comment">    2.可以轻松地批量删除条目，只需要知道序号</span><br><span class="hljs-comment">    3.支持高并发（多线程）</span><br><span class="hljs-comment">    */</span><br>    ConcurrentSkipListMap&lt;Long,String&gt; map = <span class="hljs-keyword">new</span> ConcurrentSkipListMap&lt;&gt;();<br>    <br>    <span class="hljs-keyword">long</span> start = System.currentTimeMillis();<br>    <span class="hljs-comment">//创建消息的监听器，监听哪些消息成功了，哪些消息失败了。</span><br>    <span class="hljs-comment">//消息确认成功 回调函数</span><br>    <span class="hljs-comment">/*参数：1. 消息的标记（序号）2.是否为批量确认*/</span><br>    ConfirmCallback ackCallback = (deliveryTag, multiple) -&gt;{<br>        <span class="hljs-comment">//2.删除掉已经确认的消息，剩下的就是未确认的消息</span><br>        <span class="hljs-keyword">if</span>(multiple){ <span class="hljs-comment">//默认multiple是true，即批量确认的</span><br>            <span class="hljs-comment">//如果是批量确认的，则找到所有小于当前序号的值，并清除。这样剩下的就是未确认的消息</span><br>            <span class="hljs-comment">//headMap方法就是返回所有小于指定序号的值的map，第二个参数表示是否找出等于序号的。</span><br>            ConcurrentNavigableMap&lt;Long, String&gt; navigableMap = map.headMap(deliveryTag, <span class="hljs-keyword">true</span>);<br>            navigableMap.clear();<br>        }<span class="hljs-keyword">else</span>{<span class="hljs-comment">//如果不是批量确认，则只删除当前已经确认的消息即可。</span><br>            map.remove(deliveryTag);<br>        }<br>        System.out.println(<span class="hljs-string">"确认的消息："</span>+deliveryTag);<br>    };<br>    <span class="hljs-comment">//监听确认失败的消息</span><br>    ConfirmCallback nackCallback = (deliveryTag, multiple) -&gt;{<br>        <span class="hljs-comment">//3.打印未确认的消息</span><br>        System.out.println(<span class="hljs-string">"未确认的消息："</span>+deliveryTag);<br>    };<br>    <span class="hljs-comment">/*参数：1.监听确认成功的消息 2. 监听确认失败的消息*/</span><br>    channel.addConfirmListener(ackCallback,nackCallback);<br>    <span class="hljs-comment">//批量发消息，异步确认消息</span><br>    <span class="hljs-keyword">int</span> batchSize = <span class="hljs-number">100</span>; <span class="hljs-comment">//每100条确认一次</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {<br>        String message = <span class="hljs-string">"消息"</span> + i;<br>        <span class="hljs-comment">//1.记录下所有要发送的消息</span><br>        map.put(channel.getNextPublishSeqNo(),message);<br>        <span class="hljs-comment">//发布消息</span><br>        channel.basicPublish(<span class="hljs-string">""</span>,queueName,<span class="hljs-keyword">null</span>,message.getBytes());<br>    }<br>    <span class="hljs-keyword">long</span> end = System.currentTimeMillis();<br>    System.out.println(<span class="hljs-string">"发布"</span>+MESSAGE_COUNT+<span class="hljs-string">"个异步确认消息，耗时"</span>+(end-start)+<span class="hljs-string">"ms"</span>);<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="五、交换机"><a href="#五、交换机" class="headerlink" title="五、交换机"></a>五、交换机</h1><h2 id="5-1-相关概念"><a href="#5-1-相关概念" class="headerlink" title="5.1 相关概念"></a>5.1 相关概念</h2><p>生产者生产的消息不会直接发送到队列，只能将消息发送到<strong>交换机（exchange）</strong>，然后由交换机发送到队列。</p>
<p><strong>交换机</strong>的功能：①接收来自生产者的消息。②将消息推入队列。</p>
<p>交换机主要的三个类型：</p>
<ul>
<li><strong>fanout</strong>：这种类型的交换机不分析Routing Key，将消息转发到所有和该交换机绑定的队列中。用于<a href="https://www.rabbitmq.com/tutorials/tutorial-three-java.html">Publish/Subscribe模式</a>。</li>
<li><strong>direct</strong>：这类交换机需要精准匹配Routing Key，只将消息转发到指定Routing Key的队列中。用于<a href="https://www.rabbitmq.com/tutorials/tutorial-four-java.html">Routing模式</a>。</li>
<li><strong>topic</strong>：这类交换机按照一定规则匹配Routing Key，将消息转发到匹配到的队列中，通常是一组相同主题的队列。用于<a href="https://www.rabbitmq.com/tutorials/tutorial-five-java.html">Topics模式</a></li>
</ul>
<p><strong>临时队列</strong></p>
<p>创建一个随机名称的临时队列：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">String queueName = channel.queueDeclare().getQueue();<br></code></pre></td></tr></tbody></table></figure>
<p><strong>绑定（bindings）</strong></p>
<p>binding是指exchange和queue之间的关系，将exchange和queue进行绑定。</p>
<p>其中一个交换机和一个队列之间可以有多个binding key</p>
<h2 id="5-2-Publish-Subscribe"><a href="#5-2-Publish-Subscribe" class="headerlink" title="5.2 Publish/Subscribe"></a>5.2 Publish/Subscribe</h2><p><a href="https://www.rabbitmq.com/tutorials/tutorial-three-java.html">发布订阅模式</a>是使用的扇出（fanout）类型的交换机。</p>
<p>交换机会<strong>将消息推送至所有和他绑定的队列，不会匹配Routing Key</strong>。无论绑定的Routing Key是什么值，都会发送到所有和其绑定的队列中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_5.png"><span class="image-caption">Publish/Subscribe</span></p>
<p><strong>实例</strong></p>
<p>如上图所示，一个交换机，两个队列。</p>
<p>生产者：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EmitLog</span> </span>{<br>    <span class="hljs-comment">//交换机名字为logs</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"logs"</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br>        <span class="hljs-comment">//声明为fanout类型，可以用枚举类型或者字符串。</span><br>        <span class="hljs-comment">//channel.exchangeDeclare(EXCHANGE_NAME,"fanout");</span><br>        channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.FANOUT);<br>        Scanner scanner = <span class="hljs-keyword">new</span> Scanner(System.in);<br>        <span class="hljs-keyword">while</span>(scanner.hasNext()){<br>            String message = scanner.next();<br>            <span class="hljs-comment">//绑定信息为空</span><br>            channel.basicPublish(EXCHANGE_NAME,<span class="hljs-string">""</span>,<span class="hljs-keyword">null</span>,message.getBytes(<span class="hljs-string">"UTF-8"</span>));<br>            System.out.println(<span class="hljs-string">"生产者发出消息："</span>+message);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>消费者1</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ReceiveLogs01</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br>        <span class="hljs-comment">/*声明临时队列</span><br><span class="hljs-comment">        临时队列的队列名称是随机的</span><br><span class="hljs-comment">        当消费者断开与队列的连接后，队列会被自动删除。</span><br><span class="hljs-comment">         */</span><br>        String queueName = channel.queueDeclare().getQueue();<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        将队列和交换机绑定 binding，routingKey为空</span><br><span class="hljs-comment">         */</span><br>        channel.queueBind(queueName,EXCHANGE_NAME,<span class="hljs-string">""</span>);<br><br>        DeliverCallback deliverCallback = (consumerTag, message)-&gt;{<br>            System.out.println(<span class="hljs-string">"消费者1控制台打印接收到的消息："</span>+<span class="hljs-keyword">new</span> String(message.getBody(),<span class="hljs-string">"UTF-8"</span>));<br>        };<br>        CancelCallback cancelCallback = consumerTag-&gt;{};<br>        channel.basicConsume(queueName,deliverCallback,cancelCallback);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>消费者2的代码和消费者1相同，会生成另一个随机名称的临时队列。</p>
<p>这样，当生产者每次发送一条消息，消费者1和消费者2都能接收到。</p>
<h2 id="5-3-Routing"><a href="#5-3-Routing" class="headerlink" title="5.3 Routing"></a>5.3 Routing</h2><p><a href="https://www.rabbitmq.com/tutorials/tutorial-four-java.html">Routing模式</a>使用的是direct类型交换机，这种模式下，交换机需要精准匹配Routing Key，只将消息转发到指定Routing Key的队列中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_6.png"><span class="image-caption">Routing</span></p>
<p>如图，交换机X绑定了Q1和Q2两个队列，其中和Q1之间的Binding Key为<code>orange</code>，和Q2的Binding Key包括<code>black</code>和<code>green</code>两个。</p>
<p>Routing Key为<code>orange</code>的消息会被推送到Q1队列。Routing Key为<code>black</code>和<code>green</code>的消息会被推送到Q2队列。</p>
<blockquote>
<p>多重绑定：允许不同队列和交换机之间的Binding Key是相同的，这种情况下效果和Publish/Subscribe模式相同。</p>
</blockquote>
<p><strong>实现</strong></p>
<p>生产者：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DirectProducer</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"X"</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br>        <span class="hljs-comment">//声明交换机,类型为direct</span><br>        channel.exchangeDeclare(EXCHANGE_NAME,<span class="hljs-string">"direct"</span>);<br>        <br>        Scanner scanner = <span class="hljs-keyword">new</span> Scanner(System.in);<br>        <span class="hljs-keyword">while</span>(scanner.hasNext()){<br>            String message = scanner.next();<br>            <span class="hljs-comment">//当Bingding Key取不同值时，会根据情况发送的相应的队列。</span><br>            channel.basicPublish(EXCHANGE_NAME,<span class="hljs-string">"orange"</span>,<span class="hljs-keyword">null</span>,message.getBytes(<span class="hljs-string">"UTF-8"</span>));<br><span class="hljs-comment">//            channel.basicPublish(EXCHANGE_NAME,"black",null,message.getBytes("UTF-8"));</span><br><span class="hljs-comment">//            channel.basicPublish(EXCHANGE_NAME,"green",null,message.getBytes("UTF-8"));</span><br>            System.out.println(<span class="hljs-string">"Direct类型，生产者发出消息："</span>+message);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>消费者1：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DirectConsumer01</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String EXCHANGE_NAME = <span class="hljs-string">"X"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_NAME = <span class="hljs-string">"Q1"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String BINGDING_NAME = <span class="hljs-string">"orange"</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br>        <span class="hljs-comment">//声明交换机,类型为direct</span><br>        channel.exchangeDeclare(EXCHANGE_NAME,<span class="hljs-string">"direct"</span>);<br>        <span class="hljs-comment">//声明名为Q1的队列</span><br>        channel.queueDeclare(QUEUE_NAME,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        <span class="hljs-comment">//将队列和交换机绑定</span><br>        channel.queueBind(QUEUE_NAME,EXCHANGE_NAME,BINGDING_NAME);<br><br>        DeliverCallback deliverCallback = (consumerTag, message)-&gt;{<br>            System.out.println(<span class="hljs-string">"C1接收到消息："</span>+<span class="hljs-keyword">new</span> String(message.getBody(),<span class="hljs-string">"UTF-8"</span>));<br>        };<br>        CancelCallback cancelCallback = consumerTag-&gt;{};<br>        channel.basicConsume(QUEUE_NAME,deliverCallback,cancelCallback);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>消费者2和消费者1类似，不同的是有两个Bingding：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//多重绑定，一个channel和交换机有两个绑定,两个不同的routing key</span><br>channel.queueBind(<span class="hljs-string">"Q2"</span>,<span class="hljs-string">"X"</span>,<span class="hljs-string">"black"</span>);<br>channel.queueBind(<span class="hljs-string">"Q2"</span>,<span class="hljs-string">"X"</span>,<span class="hljs-string">"green"</span>);<br></code></pre></td></tr></tbody></table></figure>
<p>这样，当发送消息的Routing Key为<code>orange</code>时，消息会被推送到Q1，Routing Key为<code>black</code>或<code>green</code>时，消息被推送到Q2。</p>
<h2 id="5-4-Topics"><a href="#5-4-Topics" class="headerlink" title="5.4 Topics"></a>5.4 Topics</h2><p><a href="https://www.rabbitmq.com/tutorials/tutorial-five-java.html">Topics</a>模式使用的是Topic类型的交换机，队列可以匹配一定规则的多个Routing Key。</p>
<p>Topic模式的Routing Key必须符合一定的要求：<strong>必须是一个单词列表，以<code>.</code>号分开</strong>，单词可以是任意的，比如<code>stock.usd.nyse</code>, <code>nyse.vmw</code>, <code>quick.orange.rabbit</code>等。单词列表最多为255个字节。</p>
<p><code>*</code>号可以代替一个单词。</p>
<p><code>#</code>号可以代替0个或多个单词。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_7.png"><span class="image-caption">Topics</span></p>
<p>如上图所示，交换机X和Q1的Binding Key为<code>*.orange.*</code>，X和Q2的Binding Key为<code>*.*.rabbit</code>和<code>lazy.#</code>。</p>
<p>一些案例：</p>
<p>①<code>quick.orange.rabbit</code>：Q1、Q2接收到消息。</p>
<p>②<code>quick.orange.rabbit</code> ： Q1、Q2接收到消息。</p>
<p>③<code>lazy.orange.elephant</code>：Q1、Q2 接收到消息。</p>
<p>④<code>quick.orange.fox</code>：Q1 接收到消息。</p>
<p>⑤<code>lazy.brown.fox</code>：Q2 接收到消息。</p>
<p>⑥<code>lazy.pink.rabbit</code> ：Q2 接收一次消息，虽然两种绑定都匹配，但只接收一次。</p>
<p>⑦<code>quick.brown.fox</code> ：不匹配任何绑定，被丢弃。</p>
<p>⑧<code>quick.orange.male.rabbit</code> ：是四个单词，不匹配任何绑定，被丢弃。</p>
<p>⑨<code>lazy.orange.male.rabbit</code> ：是四个单词，Q2接收到消息。</p>
<p><strong>实现</strong></p>
<p>声明交换机：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">channel.exchangeDeclare(<span class="hljs-string">"X"</span>,<span class="hljs-string">"topic"</span>);<br></code></pre></td></tr></tbody></table></figure>
<p>队列Q1绑定：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">channel.queueBind(<span class="hljs-string">"Q1"</span>,<span class="hljs-string">"X"</span>,<span class="hljs-string">"*.orange.*"</span>);<br></code></pre></td></tr></tbody></table></figure>
<p>队列Q2绑定：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">channel.queueBind(<span class="hljs-string">"Q1"</span>,<span class="hljs-string">"X"</span>,<span class="hljs-string">"*.*.rabbit"</span>);<br>channel.queueBind(<span class="hljs-string">"Q1"</span>,<span class="hljs-string">"X"</span>,<span class="hljs-string">"lazy.#"</span>);<br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、死信队列"><a href="#六、死信队列" class="headerlink" title="六、死信队列"></a>六、死信队列</h1><p>关于死信队列的官方文档：<a href="https://www.rabbitmq.com/dlx.html">死信队列</a></p>
<p>队列中的消息如果发生以下情况就会变成<strong>死信（Dead Letter）</strong>：</p>
<ul>
<li>消息被拒绝（<code>basic.reject</code>或<code>basic.nack</code>），并且<code>requeue</code>参数为<code>false</code></li>
<li>消息TTL超时，即消息过期。</li>
<li>队列长度超过最大限制。</li>
</ul>
<blockquote>
<p>队列过期不会导致消息变为死信。</p>
</blockquote>
<p>死信交换机（Dead Letter eXchanges，DLXs）是正常的交换机，它可以将Dead Letter转发给死信队列，进一步处理。</p>
<p>如图，正常情况下，消息通过<code>normal_exchange</code>推送到<code>normal_queue</code>，然后被<code>C1</code>消费；如果消息变为死信，<code>normal_queue</code>会将死信转发给死信交换机<code>DLX</code>，<code>DLX</code>将死信推送给死信队列<code>dead_letter_queue</code>，然后被<code>C2</code>消费。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_8.png"><span class="image-caption">死信队列</span></p>
<p><strong>实现</strong></p>
<p>生产者：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Producer</span>  </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NORMAL_EXCHANGE=<span class="hljs-string">"normal_exchange"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NORMAL_ROUTING_KEY=<span class="hljs-string">"normal_routing_key"</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br>        channel.exchangeDeclare(NORMAL_EXCHANGE,<span class="hljs-string">"direct"</span>);<br>        <span class="hljs-comment">//设置过期时间为10s</span><br>        <span class="hljs-comment">//AMQP.BasicProperties properties = new AMQP.BasicProperties().builder().expiration("10000").build();</span><br><br>        <span class="hljs-comment">//模拟发10条消息</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {<br>            String message = String.valueOf(i);<br>            <span class="hljs-comment">//超过ttl变为死信</span><br>            <span class="hljs-comment">//channel.basicPublish(NORMAL_EXCHANGE,NORMAL_BINDING,properties,message.getBytes("UTF-8"));</span><br>            <span class="hljs-comment">//超过最大长度变为死信</span><br>            <span class="hljs-comment">//channel.basicPublish(NORMAL_EXCHANGE,NORMAL_BINDING,null,message.getBytes("UTF-8")); </span><br>            channel.basicPublish(NORMAL_EXCHANGE,NORMAL_ROUTING_KEY,<span class="hljs-keyword">null</span>,message.getBytes(<span class="hljs-string">"UTF-8"</span>)); <span class="hljs-comment">//消息被拒绝变为死信</span><br>            System.out.println(<span class="hljs-string">"生产者发出消息："</span>+message);<br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>消费者C1：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer01</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NORMAL_EXCHANGE=<span class="hljs-string">"normal_exchange"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEAD_EXCHANGE=<span class="hljs-string">"dead_exchange"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NORMAL_QUEUE=<span class="hljs-string">"normal_queue"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEAD_QUEUE=<span class="hljs-string">"dead_queue"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String NORMAL_ROUTING_KEY=<span class="hljs-string">"normal_routing_key"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEAD_ROUTING_KEY=<span class="hljs-string">"dead_routing_key"</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br>        <span class="hljs-comment">//声明普通交换机和死信交换机，类型均为direct</span><br>        channel.exchangeDeclare(NORMAL_EXCHANGE,<span class="hljs-string">"direct"</span>);<br>        channel.exchangeDeclare(DEAD_EXCHANGE,<span class="hljs-string">"direct"</span>);<br><br>        <span class="hljs-comment">//声明正常队列。正常队列需要将死信消息转发到死信交换机，需要用到map参数</span><br>        Map&lt;String, Object&gt; arguments = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        <span class="hljs-comment">//过期时间,比如为10s；也可以在生产者发送消息的时候设置过期时间</span><br>        <span class="hljs-comment">//arguments.put("x-message-ttl",10000);</span><br>        <span class="hljs-comment">//指定队列的最大长度，一旦消息个数超出这个长度，就会成为死信</span><br>        <span class="hljs-comment">//arguments.put("x-max-length",6);</span><br>        <span class="hljs-comment">//设置死信交换机，即死信消息将要转发到的交换机</span><br>        arguments.put(<span class="hljs-string">"x-dead-letter-exchange"</span>,DEAD_EXCHANGE);<br>        <span class="hljs-comment">//设置死信routingkey,死信消息通过此路由键发送到死信队列。</span><br>        arguments.put(<span class="hljs-string">"x-dead-letter-routing-key"</span>,DEAD_ROUTING_KEY);<br><br>        channel.queueDeclare(NORMAL_QUEUE,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,arguments);<br>        channel.queueBind(NORMAL_QUEUE,NORMAL_EXCHANGE,NORMAL_ROUTING_KEY); <span class="hljs-comment">//绑定</span><br><br>        <span class="hljs-comment">//声明死信队列</span><br>        channel.queueDeclare(DEAD_QUEUE,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">null</span>);<br>        channel.queueBind(DEAD_QUEUE,DEAD_EXCHANGE,DEAD_ROUTING_KEY); <span class="hljs-comment">//绑定</span><br><br>        DeliverCallback deliverCallback = (consumerTag, message)-&gt;{<br>            <span class="hljs-comment">//模拟拒绝消息</span><br>            String msg = <span class="hljs-keyword">new</span> String(message.getBody(),<span class="hljs-string">"UTF-8"</span>);<br>            <span class="hljs-keyword">if</span>(Integer.parseInt(msg)%<span class="hljs-number">2</span>==<span class="hljs-number">0</span>){<br>                System.out.println(msg+<span class="hljs-string">"被拒绝"</span>);<br>                <span class="hljs-comment">//拒绝消息</span><br>                channel.basicReject(message.getEnvelope().getDeliveryTag(),<span class="hljs-keyword">false</span>);<br>            }<span class="hljs-keyword">else</span>{<br>                System.out.println(<span class="hljs-string">"C1打印接收到的消息："</span>+msg);<br>                <span class="hljs-comment">//手动应答消息</span><br>                channel.basicAck(message.getEnvelope().getDeliveryTag(),<span class="hljs-keyword">false</span>);<br>            }<br>        };<br>        CancelCallback cancelCallback = consumerTag-&gt;{};<br>        <span class="hljs-comment">//模拟拒绝消息时，要关闭自动应答。</span><br>        channel.basicConsume(NORMAL_QUEUE,<span class="hljs-keyword">false</span>,deliverCallback,cancelCallback);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>疑问：为什么要在正常队列中设置<code>x-dead-letter-routing-key</code>? 不设置会导致死信队列收不到消息，但是下文中也设置了死信队列和DLX和Routing Key，二者如果不一致也会导致死信队列收不到死信消息。</p>
</blockquote>
<p>消费者C2：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//C2只需要从死信队列中接收消息即可</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Consumer02</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEAD_QUEUE=<span class="hljs-string">"dead_queue"</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException </span>{<br>        Channel channel = RabbitMqUtils.getChannel();<br><br>        DeliverCallback deliverCallback = (consumerTag, message)-&gt;{<br>            System.out.println(<span class="hljs-string">"C2打印接收到的消息："</span>+<span class="hljs-keyword">new</span> String(message.getBody(),<span class="hljs-string">"UTF-8"</span>));<br>        };<br>        CancelCallback cancelCallback = consumerTag-&gt;{};<br>        channel.basicConsume(DEAD_QUEUE,<span class="hljs-keyword">true</span>,deliverCallback,cancelCallback);<br>    }<br><br>}<br><br></code></pre></td></tr></tbody></table></figure>
<h1 id="七、延迟队列"><a href="#七、延迟队列" class="headerlink" title="七、延迟队列"></a>七、延迟队列</h1><h2 id="7-1-概念理解"><a href="#7-1-概念理解" class="headerlink" title="7.1 概念理解"></a>7.1 概念理解</h2><p><strong>延迟队列</strong>是用来存放需要在指定时间被处理的元素的队列。如果我们希望一条消息在指定时间到了以后或之前处理，可以使用延迟队列。</p>
<p>延迟队列常见的使用场景：订单一段时间内未支付则自动取消、预定会议开始前十分钟通知与会人员参加会议。</p>
<p><strong>TTL</strong>是RabbitMQ中一个消息或者队列的属性，表明<strong>一条消息或者一个队列中所有消息的最大存活时间</strong>。单位是<code>ms</code></p>
<p>如果一条消息设置了TTL属性，或者一条消息进入了设置TTL属性的队列，则这条消息如果在TTL设置的时间内没有被消费，就会成为“死信”。</p>
<p><strong>如果同时配置了消息的TTL和队列的TTL，较小的值会被使用</strong>。</p>
<h2 id="7-2-设置TTL"><a href="#7-2-设置TTL" class="headerlink" title="7.2 设置TTL"></a>7.2 设置TTL</h2><p><strong>消息设置TTL</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//在发送消息时，针对当前这条消息单独设置ttl时间为ttlTime</span><br>rabbitTemplate.convertAndSend(<span class="hljs-string">"exchange"</span>,<span class="hljs-string">"routingKey"</span>,message,msg-&gt;{<br>            msg.getMessageProperties().setExpiration(ttlTime);<br>            <span class="hljs-keyword">return</span> msg;<br>        });<br></code></pre></td></tr></tbody></table></figure>
<p><strong>队列设置TTL</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">arguments.put(<span class="hljs-string">"x-message-ttl"</span>,<span class="hljs-number">10000</span>);<br>Queue q = QueueBuilder.durable(QUEUE_A).withArguments(arguments).build();<br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>argumengts</code>是<code>Map</code>，用于给队列设置参数。<code>x-message-ttl</code>表示队列的延迟时间。</p>
<p><code>durable()</code>意为设置队列为持久化队列。</p>
<p><strong>注意</strong></p>
<ul>
<li><p>如果设置了<strong>队列</strong>的TTL，那么消息一旦超过了这个时间就会被丢弃（如果有死信队列会被丢弃到死信队列）</p>
</li>
<li><p>如果设置的是<strong>消息</strong>的TTL，消息过期了不一定马上被抛弃。因为<strong>消息是否过期是在即将投递到消费者之前判定的</strong>，当队列出现消息积压的情况时，已过期的消息仍然能在队列中存活。</p>
<blockquote>
<p>不设置TTL，表示消息永远不会过期。</p>
<p>TTL设置为0，表示除非此时可以直接投递该消息到消费者，否则改消息将会被丢弃。</p>
</blockquote>
</li>
</ul>
<h2 id="7-3-DLX-TTL实现延迟队列"><a href="#7-3-DLX-TTL实现延迟队列" class="headerlink" title="7.3 DLX+TTL实现延迟队列"></a>7.3 DLX+TTL实现延迟队列</h2><p>我们可以使用消息和队列的TTL的属性和死信队列，实现延迟队列。思路是将过期队列转发到死信队列，消费者只要消费死信队列中的消息即可，就实现了延迟队列的功能。</p>
<p><strong>1、创建SpringBoot项目</strong></p>
<p>创建SpringBoot项目，然后引入以下依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br>	<span class="hljs-comment">&lt;!-- RabbitMQ依赖 --&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--fastjson--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>fastjson<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.62<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- RabbitMQ --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.amqp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-rabbit-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、修改配置文件</strong></p>
<p>在<code>application.properties</code>配置文件中，添加RabbitMQ的相关配置：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 配置RabbitMQ的相关配置</span><br><span class="hljs-meta">spring.rabbitmq.host</span>=<span class="hljs-string">192.168.198.198</span><br><span class="hljs-meta">spring.rabbitmq.port</span>=<span class="hljs-string">5672</span><br><span class="hljs-meta">spring.rabbitmq.username</span>=<span class="hljs-string">admin</span><br><span class="hljs-meta">spring.rabbitmq.password</span>=<span class="hljs-string">admin</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、创建配置类</strong></p>
<p>根据下面的架构图，<code>X</code>为正常的交换机，<code>Y</code>是死信交换机，<code>QA</code>和<code>QB</code>是具有TTL属性的延迟队列，<code>QC</code>是没有TTL属性的正常队列，<code>QD</code>是死信队列。各个队列和交换机之间的<code>binding</code>关系如图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_9.png"><span class="image-caption">架构图</span></p>
<p>首先创建一个配置类，将各个组件构建出来。其中包括两个交换机，四个队列，四个绑定关系：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> org.springframework.amqp.core.*;<br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;<br><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;<br><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TtlQueueConfig</span> </span>{<br>    <span class="hljs-comment">//普通交换机的名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String X_EXCHANGE = <span class="hljs-string">"X"</span>;<br>    <span class="hljs-comment">//死信交换机的名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String Y_DEAD_LETTER_EXCHANGE = <span class="hljs-string">"Y"</span>;<br>    <span class="hljs-comment">//普通队列的名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_A = <span class="hljs-string">"QA"</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_B = <span class="hljs-string">"QB"</span>;<br>    <span class="hljs-comment">//死信队列的名称</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DEAD_LETTER_QUEUE = <span class="hljs-string">"QD"</span>;<br>    <span class="hljs-comment">//普通队列，没有过期时间。可以适用于任意过期时间的消息。不需要每个过期时间都创建一个新队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String QUEUE_C = <span class="hljs-string">"QC"</span>;<br><br>    <span class="hljs-comment">//声明QC</span><br>    <span class="hljs-comment">//普通队列C，不设置过期时间</span><br>    <span class="hljs-meta">@Bean("queueC")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queueC</span><span class="hljs-params">()</span></span>{<br>        Map&lt;String, Object&gt; arguments = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        arguments.put(<span class="hljs-string">"x-dead-letter-exchange"</span>,Y_DEAD_LETTER_EXCHANGE);<br>        arguments.put(<span class="hljs-string">"x-dead-letter-routing-key"</span>,<span class="hljs-string">"YD"</span>);<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(QUEUE_C).withArguments(arguments).build();<br>    }<br>    <span class="hljs-comment">//绑定.队列QC和交换机X绑定，Routing Key为XC</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">queueCBindingX</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("queueC")</span> Queue queueC,</span></span><br><span class="hljs-function"><span class="hljs-params">                                  <span class="hljs-meta">@Qualifier("xExchange")</span> DirectExchange xExchange)</span></span>{<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queueC).to(xExchange).with(<span class="hljs-string">"XC"</span>);<br>    }<br><br>    <span class="hljs-comment">//声明普通交换机，别名为xExchange</span><br>    <span class="hljs-meta">@Bean("xExchange")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">xExchange</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(X_EXCHANGE);<br>    }<br><br>    <span class="hljs-comment">//声明死信交换机，别名为yExchange</span><br>    <span class="hljs-meta">@Bean("yExchange")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">yExchange</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(Y_DEAD_LETTER_EXCHANGE);<br>    }<br><br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-comment">//普通队列A，过期时间为10s</span><br>    <span class="hljs-meta">@Bean("queueA")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queueA</span><span class="hljs-params">()</span></span>{<br>        Map&lt;String, Object&gt; arguments = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        arguments.put(<span class="hljs-string">"x-dead-letter-exchange"</span>,Y_DEAD_LETTER_EXCHANGE);<br>        arguments.put(<span class="hljs-string">"x-dead-letter-routing-key"</span>,<span class="hljs-string">"YD"</span>);<br>        <span class="hljs-comment">//设置过期时间,单位是ms</span><br>        arguments.put(<span class="hljs-string">"x-message-ttl"</span>,<span class="hljs-number">10000</span>);<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(QUEUE_A).withArguments(arguments).build();<br>    }<br>    <span class="hljs-comment">//普通队列B，过期时间为40s</span><br>    <span class="hljs-meta">@Bean("queueB")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queueB</span><span class="hljs-params">()</span></span>{<br>        Map&lt;String, Object&gt; arguments = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        arguments.put(<span class="hljs-string">"x-dead-letter-exchange"</span>,Y_DEAD_LETTER_EXCHANGE);<br>        arguments.put(<span class="hljs-string">"x-dead-letter-routing-key"</span>,<span class="hljs-string">"YD"</span>);<br>        <span class="hljs-comment">//设置过期时间,单位是ms</span><br>        arguments.put(<span class="hljs-string">"x-message-ttl"</span>,<span class="hljs-number">40000</span>);<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(QUEUE_B).withArguments(arguments).build();<br>    }<br>    <span class="hljs-comment">//死信队列QD</span><br>    <span class="hljs-meta">@Bean("queueD")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">queueD</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> QueueBuilder.durable(DEAD_LETTER_QUEUE).build();<br>    }<br>    <span class="hljs-comment">//绑定.队列QA和交换机X绑定，Routing Key为XA</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">queueABindingX</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("queueA")</span> Queue queueA,</span></span><br><span class="hljs-function"><span class="hljs-params">                                  <span class="hljs-meta">@Qualifier("xExchange")</span> DirectExchange xExchange)</span></span>{<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queueA).to(xExchange).with(<span class="hljs-string">"XA"</span>);<br>    }<br>    <span class="hljs-comment">//绑定.队列QB和交换机X绑定，Routing Key为XB</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">queueBBindingX</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("queueB")</span> Queue queueB,</span></span><br><span class="hljs-function"><span class="hljs-params">                                  <span class="hljs-meta">@Qualifier("xExchange")</span> DirectExchange xExchange)</span></span>{<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queueB).to(xExchange).with(<span class="hljs-string">"XB"</span>);<br>    }<br>    <span class="hljs-comment">//绑定.队列QD和交换机Y绑定，Routing Key为YD</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">queueDBindingY</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("queueD")</span> Queue queueD,</span></span><br><span class="hljs-function"><span class="hljs-params">                                  <span class="hljs-meta">@Qualifier("yExchange")</span> DirectExchange yExchange)</span></span>{<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queueD).to(yExchange).with(<span class="hljs-string">"YD"</span>);<br>    }<br>}<br><br></code></pre></td></tr></tbody></table></figure>
<p>创建队列可以使用<code>new Queue()</code>方式，也可以使用<code>QueueBuilder</code>构建器的方式。</p>
<p>同样地，声明交换机和Binding都有<code>new</code>和构建器两种方法。</p>
<p><strong>4、创建生产者和消费者</strong></p>
<p>生产者：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping("/ttl")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SendMsgController</span> </span>{<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@GetMapping("/sendMsg/{message}")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String message)</span></span>{<br>        System.out.println(<span class="hljs-string">"发送消息："</span>+message);<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">"X"</span>,<span class="hljs-string">"XA"</span>,<span class="hljs-string">"消息来自ttl为10s的队列："</span>+message);<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">"X"</span>,<span class="hljs-string">"XB"</span>,<span class="hljs-string">"消息来自ttl为40s的队列："</span>+message);<br>    }<br><br>    <span class="hljs-comment">//发送带有ttl的消息，消息的过期时间由消息本身确定，不需要单独创建队列</span><br>    <span class="hljs-meta">@GetMapping("/sendExpirationMsg/{message}/{ttlTime}")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMsg</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String message,<span class="hljs-meta">@PathVariable</span> String ttlTime)</span></span>{<br>        System.out.println(<span class="hljs-keyword">new</span> Date()+<span class="hljs-string">"发送一条时长为"</span>+ttlTime+<span class="hljs-string">"毫秒的消息:"</span>+message);<br>        rabbitTemplate.convertAndSend(<span class="hljs-string">"X"</span>,<span class="hljs-string">"XC"</span>,message,msg-&gt;{<br>            <span class="hljs-comment">//设置消息的ttl大小</span><br>            msg.getMessageProperties().setExpiration(ttlTime);<br>            <span class="hljs-keyword">return</span> msg;<br>        });<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>消费者：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DeadLetterQueueConsumer</span> </span>{<br>    <span class="hljs-comment">//从QD死信队列接收消息</span><br>    <span class="hljs-meta">@RabbitListener(queues = "QD")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveD</span><span class="hljs-params">(Message message)</span> <span class="hljs-keyword">throws</span> Exception</span>{<br>        String msg = <span class="hljs-keyword">new</span> String(message.getBody());<br>        System.out.println(<span class="hljs-keyword">new</span> Date()+<span class="hljs-string">"收到死信队列的消息："</span>+msg);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>5、运行结果</strong></p>
<ul>
<li><strong>测试<code>QA</code>和<code>QB</code>这两个设置TTL属性的队列</strong>。<ul>
<li>在浏览器中访问<code>http://localhost:8080/ttl/sendMsg/hello world</code>，消费者在10s和40s后会收到内容为<code>hello world</code>的两条消息。这两条消息的延迟时间是由队列本身决定的。</li>
</ul>
</li>
<li><strong>测试指定消息TTL</strong>。<ul>
<li>在浏览器中访问<code>http://localhost:8080/ttl/sendExpirationMsg/hello world/10000</code>，消费者会在10s后收到消息。这种方式可以任意指定TTL的大小，可以适用于任意的延迟时间。</li>
</ul>
</li>
</ul>
<p><strong>比较队列TTL和消息TTL两种方式</strong></p>
<ul>
<li><p>队列设置TTL属性实现延迟队列，这种方式中，当队列到了过期时间，一定会被放到死信队列。但是这种方式不够灵活，如果想要改变延迟时间，就需要新建队列，面对大量不同时间需求，无法实现。</p>
</li>
<li><p>消息设置TTL属性实现延迟队列，这种方式足够灵活，可以满足任意的延迟时间的需求。但是这种方式的严重缺陷是如果队列中消息积压，会导致过期的消息无法被丢弃（放到死信队列），导致死信队列的消费者无法按时收到消息。</p>
<blockquote>
<p>比如，如果第一个消息的过期时间较长，第二个消息的过期时间较短，则两个消息如果先后发送，会同时被消费者收到。因为RabbitMQ只检查当前第一个消息，直到等到第一个消息到了TTL时间，才会被死信队列收到，然后第二个消息被处理。</p>
<p>正确的结果应该是根据消息的TTL，第二个消息先到达。</p>
</blockquote>
</li>
</ul>
<p>为了解决TTL消息的这种缺陷，我们可以使用插件实现延迟队列，满足不同延迟时间的需求。</p>
<h2 id="7-4-RabbitMQ插件实现延迟队列"><a href="#7-4-RabbitMQ插件实现延迟队列" class="headerlink" title="7.4 RabbitMQ插件实现延迟队列"></a>7.4 RabbitMQ插件实现延迟队列</h2><h3 id="7-4-1-安装插件"><a href="#7-4-1-安装插件" class="headerlink" title="7.4.1 安装插件"></a>7.4.1 安装插件</h3><p><code>rabbitmq_delayed_message_exchange</code>插件正是为了解决TTL消息无法及时死亡的问题。</p>
<p>在<a href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a> 地址下载插件并安装。</p>
<p>下载完以后，将<code>.ez</code>后缀的文件复制到<code>usr/lib/rabbitmq/lib/rabbitmq_server-3.x.x/plugins</code>目录，这个目录用于存放RabbitMQ的插件。</p>
<p>进入到这个目录，然后执行语句：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rabbitmq-plugins <span class="hljs-built_in">enable</span> rabbitmq_delayed_message_exchange<br></code></pre></td></tr></tbody></table></figure>
<p>即可安装插件。</p>
<p>安装成功以后，在web管理界面，添加交换机可以看到新增的<code>x-delayed-message</code>类型。</p>
<h3 id="7-4-2-代码实现"><a href="#7-4-2-代码实现" class="headerlink" title="7.4.2 代码实现"></a>7.4.2 代码实现</h3><p>如图，使用插件实现延迟队列的原理是创建一个<strong>类型为<code>x-delayed-message</code>的交换机（延迟交换机）</strong>，这个类型的交换机支持<strong>延迟投递机制</strong>，即消息传递到以后先暂存到mnesia表中，到达指定的延迟时间以后才将消息投递出去。</p>
<blockquote>
<p>这种方式在发送消息的时候设置每条消息的延迟时间，延迟交换机根据7延迟时间发送消息。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_10.png"><span class="image-caption">结构图</span></p>
</blockquote>
<p>实现代码框架和思路和7.3相同：</p>
<p>1、编写配置类，创建各个组件：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DelayedQueueConfig</span> </span>{<br>    <span class="hljs-comment">//延迟交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DELAYED_EXCHANGE_NAME = <span class="hljs-string">"delayed.exchange"</span>;<br>    <span class="hljs-comment">//队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DELAYED_QUEUE_NAME = <span class="hljs-string">"delayed.queue"</span>;<br>    <span class="hljs-comment">//Routingkey</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String DELAYED_ROUTING_KEY = <span class="hljs-string">"delayed.routingkey"</span>;<br><br>    <span class="hljs-comment">//声明交换机,使用自定义类型的交换机</span><br>    <span class="hljs-comment">//交换机类型为"x-delayed-message"，传播模式为direct</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> CustomExchange <span class="hljs-title">delayedExchange</span><span class="hljs-params">()</span></span>{<br>        Map&lt;String,Object&gt; arguments = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        arguments.put(<span class="hljs-string">"x-delayed-type"</span>,<span class="hljs-string">"direct"</span>);  <span class="hljs-comment">//声明匹配模式</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> CustomExchange(DELAYED_EXCHANGE_NAME,<span class="hljs-string">"x-delayed-message"</span>,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,arguments);<br>    }<br>    <span class="hljs-comment">//声明队列</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">delayedQueue</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(DELAYED_QUEUE_NAME);<br>    }<br><br>    <span class="hljs-comment">//binding</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">delayQueueBindingDelayedExchange</span><span class="hljs-params">(</span></span><br><span class="hljs-function"><span class="hljs-params">        <span class="hljs-meta">@Qualifier("delayedQueue")</span> Queue delayedQueue,</span></span><br><span class="hljs-function"><span class="hljs-params">        <span class="hljs-meta">@Qualifier("delayedExchange")</span> CustomExchange delayedExchange)</span></span>{<br>        <span class="hljs-comment">//自定义类型交换机需要调用noargs()或args()方法指定是否有参数</span><br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(delayedQueue).to(delayedExchange).with(DELAYED_ROUTING_KEY).noargs();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><p>创建延迟交换机，需要创建自定义交换机，即<code>CustomExchange</code>，类型为<code>x-delayed-message</code>，然后设置分配模式。</p>
</li>
<li><p><code>CustomExchange</code>交换机的绑定，需要调用<code>noargs()</code>或<code>args()</code>指定有无参数。</p>
</li>
</ul>
<p>2、生产者代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//发送消息。基于插件，使用延迟交换机。</span><br><span class="hljs-meta">@GetMapping("/sendDelayedMsg/{message}/{delayTime}")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendDelayedMsg</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String message,<span class="hljs-meta">@PathVariable</span> Integer delayTime)</span></span>{<br>    System.out.println(<span class="hljs-keyword">new</span> Date()+<span class="hljs-string">"给延迟交换机发送一条延迟时间为"</span>+delayTime+<span class="hljs-string">"毫秒的消息:"</span>+message);<br>    rabbitTemplate.convertAndSend(DelayedQueueConfig.DELAYED_EXCHANGE_NAME,<br>                                  DelayedQueueConfig.DELAYED_ROUTING_KEY,message,<br>                                  msg-&gt;{<br>                                      <span class="hljs-comment">//设置延迟时间</span><br>                                      msg.getMessageProperties().setDelay(delayTime);<br>                                      <span class="hljs-keyword">return</span> msg;<br>                                  });<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>在发送消息时，调用<code>setDelay()</code>方法设置延迟时间。</p>
<p>3、消费者代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DelayQueueConsumer</span> </span>{<br>    <span class="hljs-meta">@RabbitListener(queues = DelayedQueueConfig.DELAYED_QUEUE_NAME)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveDelayQueue</span><span class="hljs-params">(Message message)</span> </span>{<br>        String msg = <span class="hljs-keyword">new</span> String(message.getBody());<br>        System.out.println(<span class="hljs-keyword">new</span> Date() + <span class="hljs-string">"收到延迟队列的消息："</span> + msg);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，在浏览器中访问<code>http://localhost:8080/ttl/sendDelayedMsg/hello world/10000</code>，消费者会在10s后收到消息。并且，对于先后发送的多条延迟时间不同的消息，消费者也能在正确的延迟时间后收到消息。</p>
<h1 id="八、发布确认SpringBoot版"><a href="#八、发布确认SpringBoot版" class="headerlink" title="八、发布确认SpringBoot版"></a>八、发布确认SpringBoot版</h1><p>发布确认用于确保消息的可靠投递，如果消息投递成功，返回确认信息，如果投递失败，返回失败信息并确保消息不会丢失。</p>
<p>第四章提到过发布确认，这里要讲的是在SpringBoot项目中使用发布确认机制。</p>
<h2 id="8-1-发布确认"><a href="#8-1-发布确认" class="headerlink" title="8.1 发布确认"></a>8.1 发布确认</h2><p>发布确认的回调方法可以判断出交换机是否收到消息，当交换机宕机或其他原因导致交换机没有收到生产者发出的消息时，回调方法能够做出反馈。</p>
<p><strong>实现代码</strong></p>
<p><strong>1、配置文件</strong></p>
<p>需要在配置文件中配置开启发布确认：</p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 配置交换机发布确认，correlated表示发布消息成功到交换机后会触发回调方法</span><br><span class="hljs-meta">spring.rabbitmq.publisher-confirm-type</span>=<span class="hljs-string">correlated</span><br></code></pre></td></tr></tbody></table></figure>
<p>确认类型有三种：</p>
<ul>
<li><code>none</code>表示禁用发布确认模式。</li>
<li><code>correlated</code>表示发布消息成功到交换器后会触发回调方法。</li>
<li><code>simple</code>不仅有和<code>correlated</code>相同的功能，此外，<code>simple</code>模式在发布消息成功后使用<code>rabbitTemplate</code>调用<code>watiForConfirms</code>或<code>waitForConfirmsOrDie</code>方法等待<code>broker</code>节点返回发送结果，根据返回结果来判定下一步的逻辑。</li>
</ul>
<p><strong>2、添加配置类，构建各个组件</strong></p>
<p><code>ConfirmConfig.java</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfirmConfig</span> </span>{<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CONFIRM_EXCHANGE_NAME = <span class="hljs-string">"confirm_exchange"</span>; <span class="hljs-comment">//交换机</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CONFIRM_QUEUE_NAME = <span class="hljs-string">"confirm_queue"</span>; <span class="hljs-comment">//队列</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String CONFIRM_ROUTING_KEY = <span class="hljs-string">"key1"</span>; <span class="hljs-comment">//绑定</span><br><br>    <span class="hljs-comment">//声明确认交换机</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> DirectExchange <span class="hljs-title">confirmExchange</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DirectExchange(CONFIRM_EXCHANGE_NAME);<br>    }<br><br>    <span class="hljs-comment">//声明确认队列</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Queue <span class="hljs-title">confirmQueue</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Queue(CONFIRM_QUEUE_NAME,<span class="hljs-keyword">true</span>);<br>    }<br><br>    <span class="hljs-comment">//确认交换机和确认队列的绑定</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Binding <span class="hljs-title">queueBingdingExchange</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("confirmExchange")</span> DirectExchange directExchange,</span></span><br><span class="hljs-function"><span class="hljs-params">                                         <span class="hljs-meta">@Qualifier("confirmQueue")</span> Queue queue)</span></span>{<br>        <span class="hljs-keyword">return</span> BindingBuilder.bind(queue).to(directExchange).with(CONFIRM_ROUTING_KEY);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、生产者代码</strong></p>
<p>生产者代码可以指定消息id，即回调接口中消息的id。</p>
<p>此外，可以通过修改交换机和队列的名字，模拟交换机/队列宕机的故障情况。</p>
<p><code>ProducerController.java</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RestController</span><br><span class="hljs-meta">@RequestMapping("/confirm")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProducerController</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br><br>    <span class="hljs-meta">@GetMapping("/send/{message}")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sendMessage</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String message)</span></span>{<br>        <span class="hljs-comment">//发送消息</span><br>        CorrelationData correlationData = <span class="hljs-keyword">new</span> CorrelationData(<span class="hljs-string">"1"</span>); <span class="hljs-comment">//设置回调接口中的消息,id为1</span><br>        rabbitTemplate.convertAndSend(ConfirmConfig.CONFIRM_EXCHANGE_NAME,<br>                                      ConfirmConfig.CONFIRM_ROUTING_KEY,message,correlationData);<br><br>        <span class="hljs-comment">//模拟队列宕机的情况</span><br>        CorrelationData correlationData2 = <span class="hljs-keyword">new</span> CorrelationData(<span class="hljs-string">"2"</span>); <span class="hljs-comment">//设置回退接口中的消息,id为2</span><br>        rabbitTemplate.convertAndSend(ConfirmConfig.CONFIRM_EXCHANGE_NAME,<br>                                      ConfirmConfig.CONFIRM_ROUTING_KEY+<span class="hljs-string">"aaaa"</span>,<br>                message,correlationData2);<br>        System.out.println(<span class="hljs-string">"已发送消息"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、回调接口</strong></p>
<p>我们需要实现<code>RabbitTemplate</code>类的一个内部接口，并重写其中的<code>confirm</code>方法，用来判断交换机是否收到消息。</p>
<p><code>MyCallBack.java</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCallBack</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RabbitTemplate</span>.<span class="hljs-title">ConfirmCallback</span></span>{<br>    <span class="hljs-comment">//由于实现的是内部类，RabbitTemplate对象不包括当前对象。</span><br>    <span class="hljs-comment">//需要将MyCallBack对象注入到RabbitTemplate中。</span><br>    <span class="hljs-comment">//第二种方式是不使用这种实现接口的方式，在配置类中实现接口</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>    <br>    <span class="hljs-comment">//将当前实现类注入到RabbitTemplate中,postConstruct会在autowired之后执行</span><br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>{<br>        rabbitTemplate.setConfirmCallback(<span class="hljs-keyword">this</span>);<br>    }<br>  <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">confirm</span><span class="hljs-params">(CorrelationData correlationData, <span class="hljs-keyword">boolean</span> ack, String reason)</span> </span>{<br>        String id = correlationData != <span class="hljs-keyword">null</span> ? correlationData.getId() : <span class="hljs-string">""</span>;<br>        <span class="hljs-keyword">if</span>(ack){<br>            System.out.println(<span class="hljs-string">"交换机收到了id为"</span>+id+<span class="hljs-string">"的消息"</span>);<br>        }<span class="hljs-keyword">else</span>{<br>            System.out.println(<span class="hljs-string">"交换机未收到消息，原因为"</span>+reason);<br>        }<br>    } <br>}<br></code></pre></td></tr></tbody></table></figure>
<p>关于<code>@PostConstruct</code>注解，参考<a href="https://www.cnblogs.com/lay2017/p/11735802.html">https://www.cnblogs.com/lay2017/p/11735802.html</a></p>
<p><code>confirm()</code>方法的参数解析：</p>
<ul>
<li><code>correlationData</code>保存回调消息的ID及相关信息</li>
<li><code>ack</code>表示交换机是否收到了消息。<code>true</code>表示交换机接收到了消息，否则表示接收消息失败。</li>
<li><code>reason</code>表示消息接收失败的原因，如果接收成功则为<code>null</code></li>
</ul>
<p><strong>5、消费者代码</strong></p>
<p>消费者代码就是正常的接收消息。</p>
<p><code>ConfirmConsumer.java</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ConfirmConsumer</span> </span>{<br>    <span class="hljs-meta">@RabbitListener(queues = ConfirmConfig.CONFIRM_QUEUE_NAME)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveConfirmMessage</span><span class="hljs-params">(Message message)</span></span>{<br>        System.out.println(<span class="hljs-string">"消费者接收到消息："</span>+<span class="hljs-keyword">new</span> String(message.getBody()));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>结果分析</strong></p>
<ul>
<li>状态正常时，消费者接收到消息，回调方法<code>ack</code>为<code>true</code>。</li>
<li>交换机宕机，消费者收不到消息，回调方法<code>ack</code>为<code>false</code>。</li>
<li>队列宕机，或者消息无法路由，消费者收不到消息，但是回调方法<code>ack</code>为<code>true</code>，表示交换机收到了消息（虽然没有被路由到队列）。</li>
</ul>
<h2 id="8-2-回退消息"><a href="#8-2-回退消息" class="headerlink" title="8.2 回退消息"></a>8.2 回退消息</h2><p>由上一节的发布确认机制可知，生产者通过回调方法只能得知消息有没有被发送到交换机，<strong>如果消息不可路由</strong>，那么消息会被直接丢弃，生产者并不知道消息被丢弃。为了解决这一问题，需要<strong>回退消息</strong>机制。</p>
<p><strong>回退消息用在消息无法被路由（队列宕机）的情况</strong>。</p>
<p>回退消息的实现和发布确认类似，不同之处为：</p>
<p><strong>1、设置参数：</strong></p>
<figure class="highlight yml"><table><tbody><tr><td class="code"><pre><code class="hljs yml"><span class="hljs-comment"># 开启消息回退机制，如果消息无法被路由，则消息会被回退</span><br><span class="hljs-string">spring.rabbitmq.publisher-returns=true</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、配置类：</strong></p>
<p>配置类中需要实现<code>RabbitTemplate.ReturnsCallback</code>内部接口，并实现其中的方法。</p>
<p><code>MyCallBack.java</code>： </p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyCallBack</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RabbitTemplate</span>.<span class="hljs-title">ReturnsCallback</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RabbitTemplate rabbitTemplate;<br>  <br>    <span class="hljs-meta">@PostConstruct</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//true表示交换机发现消息无法被路由时，会将消息返回给生产者；false表示直接丢弃。</span><br>        rabbitTemplate.setMandatory(<span class="hljs-keyword">true</span>); <br>        rabbitTemplate.setReturnsCallback(<span class="hljs-keyword">this</span>);<br>    }<br>    <span class="hljs-comment">//回退消息，当消息无法被路由，会被回退。</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">returnedMessage</span><span class="hljs-params">(ReturnedMessage returnedMessage)</span> </span>{<br>        String replyText = returnedMessage.getReplyText();<br>        System.out.println(<span class="hljs-string">"消息被回退，回退原因为："</span>+replyText);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>生产者和消费者的实现并无特殊。当发送的消息无法被路由（比如队列宕机、RoutingKey错误等）时，会调用回退方法。</p>
<p>通过发布确认机制，生产者可以得知消息是否被交换机接收；通过回退消息机制，生产者可以得知消息消息是否被分发到队列中。</p>
<h2 id="8-3-备份交换机"><a href="#8-3-备份交换机" class="headerlink" title="8.3 备份交换机"></a>8.3 备份交换机</h2><p>通过回退消息，我们可以感知到无法被路由的消息，但是只能把消息回退，无法继续处理。想要处理无法被路由的消息，需要使用<strong>备份交换机</strong>。</p>
<p><strong>备份交换机</strong>可以理解为RabbitMQ中交换机的备胎，当交换机收到一条不可路由消息时，将会把这条消息转发到备份交换机中。通常备份交换机的类型为<code>Fanout</code>，这样就能将不可路由消息广播到所有和它绑定的队列中。</p>
<p>备份交换机除了添加备份队列以外，还可以添加一个报警队列，这样如果有无法被路由的消息，报警队列的消费者可以发出警报信息进行提示。</p>
<blockquote>
<p>和死信队列不同的是，死信队列是消息已经转发到了队列，而备份交换机处理的是不能被路由转发到队列的消息。</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_11.png"><span class="image-caption">备份交换机</span></p>
<p>如图，正常交换机无法路由的消息会交给备份交换机处理，备份交换机接收到消息后，将消息广播，其中一个队列是报警队列，用于提示消息无法路由。</p>
<p>实现备份交换机，需要在声明普通交换机的时候添加备份交换机：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//声明一个交换机，其备份交换机为"backup_exchange"</span><br>Exchange exchange = ExchangeBuilder.directExchange(<span class="hljs-string">"confirm_exchange"</span>).<br>    durable(<span class="hljs-keyword">true</span>).<br>    withArgument(<span class="hljs-string">"alternate-exchange"</span>,<span class="hljs-string">"backup_exchange"</span>).<br>    build();<br></code></pre></td></tr></tbody></table></figure>
<p>备份交换机需要声明为<code>fanout</code>类型：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">FanoutExchange exchange = <span class="hljs-keyword">new</span> FanoutExchange(<span class="hljs-string">"backup_exchange"</span>);<br></code></pre></td></tr></tbody></table></figure>
<p>然后声明报警队列和消费者队列，并且声明各自和交换机之间的绑定。</p>
<p>其中，报警队列的消费者可以用来发出警告信息，表示生产者发出的消息无法被路由：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WarningConsumer</span> </span>{<br>    <span class="hljs-comment">//报警队列</span><br>    <span class="hljs-meta">@RabbitListener(queues = "warning_queue")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">receiveWarningMessage</span><span class="hljs-params">(Message message)</span></span>{<br>        System.out.println(<span class="hljs-string">"报警！发现不可路由消息："</span>+<span class="hljs-keyword">new</span> String(message.getBody()));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>如果<strong>消息回退</strong>机制和<strong>备份交换机</strong>同时配置，则备份交换机机制优先。因为备份队列收到了消息，理解为消息成功路由。</p>
<h1 id="九、RabbitMQ其他知识点"><a href="#九、RabbitMQ其他知识点" class="headerlink" title="九、RabbitMQ其他知识点"></a>九、RabbitMQ其他知识点</h1><h2 id="9-1-幂等性"><a href="#9-1-幂等性" class="headerlink" title="9.1 幂等性"></a>9.1 幂等性</h2><p><strong>幂等性(idempotence)</strong>指的是用户对同一操作发起的一次请求或多次请求的结果是一致的，不会因为多次点击而产生了副作用。消息重复消费时需要考虑消息的幂等性。</p>
<p><strong>消息重复消费</strong>：如果MQ已经把消息发送给了消费者，消费者在返回ack时网络中断，MQ未收到确认消息，会将消息重新发送给其他的消费者，或者再次发送给该消费者，就会造成消息重复消费。</p>
<p><strong>解决方式</strong>：</p>
<ul>
<li>对于消费端，可以使用全局ID或者唯一标识比如时间戳等唯一的id，每次消费时用该id判断该消息是否已消费过。</li>
<li>对于发送端，有两种方式：①唯一ID+指纹码机制（基于业务规则拼接的唯一字符串），查询数据库判断是否重复；②利用redis的原子性，<code>setnx</code>指令天然具有幂等性。</li>
</ul>
<h2 id="9-2-优先队列"><a href="#9-2-优先队列" class="headerlink" title="9.2 优先队列"></a>9.2 优先队列</h2><p>优先队列可以根据消息的优先级进行消息的分发，优先队列会<strong>将队列中的消息按照优先级进行排序</strong>，按照优先级从高到低的顺序进行消息的发送，而不考虑消息进入队列的顺序。因此，使用优先级队列需要确保所有消息都发送到队列中以后，消费者才开始消费，<strong>确保这些消息能够在队列中排序</strong>。</p>
<p>使用优先队列需要满足两个条件：①队列是优先队列；②消息需要设置优先级。</p>
<p>声明优先队列：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> HashMap();<br>params.put(<span class="hljs-string">"x-max-priority"</span>,<span class="hljs-number">10</span>); <span class="hljs-comment">//设置队列为优先级队列，且消息的最大优先级为10</span><br>channel.queueDeclare(<span class="hljs-string">"Q1"</span>,<span class="hljs-keyword">true</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,params);<br></code></pre></td></tr></tbody></table></figure>
<p>设置消息的优先级：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 在生产者代码中，设置消息的优先级为5</span><br>AMQP.BasicProperties properties = <span class="hljs-keyword">new</span> AMQP.BasicProperties().builder().priority(<span class="hljs-number">5</span>).build();<br>channel.basicPublish(<span class="hljs-string">"exchange"</span>,<span class="hljs-string">"routingKey"</span>,properties,message.getBytes(<span class="hljs-string">"UTF-8"</span>));<br></code></pre></td></tr></tbody></table></figure>
<p>当不同优先级的消息都进入优先队列以后，优先队列将消息进行排序，然后消费者进行消费，接收到的消息是按照优先级从高到低排列。</p>
<h2 id="9-3-惰性队列"><a href="#9-3-惰性队列" class="headerlink" title="9.3 惰性队列"></a>9.3 惰性队列</h2><p>RabbitMQ 3.6.0版本引入了<strong>惰性队列</strong>的概念。惰性队列会尽可能的将消息存入磁盘中，消费者消费到对应的消息时，才会被加载到内存中。</p>
<p>惰性队列的目的是为了能够支持更长的队列，当消费者下线或者宕机等情况导致长时间不能消费消息造成堆积时，惰性队列就发挥作用了。</p>
<p>开启惰性队列：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> HashMap();<br>params.put(<span class="hljs-string">"x-queue-mode"</span>,lazy); <span class="hljs-comment">//设置队列为惰性队列</span><br>channel.queueDeclare(<span class="hljs-string">"Q1"</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,<span class="hljs-keyword">false</span>,params);<br></code></pre></td></tr></tbody></table></figure>
<p><code>x-queue-mode</code>表示队列的模式，默认为<code>default</code>模式，如果想要声明惰性队列，则将其设置为<code>lazy</code>模式即可。</p>
<p>在面对大量消息积压的情况下，<strong>惰性队列能够占用更少的内存，从而存储更多的消息。</strong></p>
<h1 id="十、RabbitMQ集群"><a href="#十、RabbitMQ集群" class="headerlink" title="十、RabbitMQ集群"></a>十、RabbitMQ集群</h1><h2 id="10-1-集群搭建"><a href="#10-1-集群搭建" class="headerlink" title="10.1 集群搭建"></a>10.1 集群搭建</h2><p>RabbitMQ集群是指搭建多台RabbitMQ服务器，这样当其中的某台服务器出现故障时，其他服务器可以保障服务可用。并且集群能够提升服务的性能。</p>
<p><strong>搭建步骤</strong></p>
<p>需要准备三台机器。</p>
<p>建立三个节点，node1-node2-node3</p>
<p><strong>1、修改3台机器的主机名称</strong></p>
<p>将3台机器的主机名分别修改为<code>node1</code>、<code>node2</code>、<code>node3</code>，方便识别。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 在/etc/hostname文件中修改</span><br>vim /etc/hostname<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、配置各个节点的<code>hosts</code>文件</strong></p>
<p>配置<code>hosts</code>文件，确保各个节点能够互相认识对方。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">vim /etc/hosts<br></code></pre></td></tr></tbody></table></figure>
<p>在每台主机的<code>/etc/hosts</code>文件中添加三个节点的ip地址和主机名，比如：</p>
<figure class="highlight accesslog"><table><tbody><tr><td class="code"><pre><code class="hljs accesslog"><span class="hljs-number">123.123.123.1</span> node1<br><span class="hljs-number">123.123.123.2</span> ndoe2<br><span class="hljs-number">123.123.123.3</span> node3<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、确保各个节点的cookie文件相同</strong></p>
<p>在其中一个节点上，比如node1节点上，执行远程复制命令，将本机的<code>cookie</code>文件远程复制到另外两个节点中：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">scp /var/lib/rabbitmq/.erlang.coolie root@node2:/var/lib/rabbitmq/.erlang.cookie<br>scp /var/lib/rabbitmq/.erlang.coolie root@node3:/var/lib/rabbitmq/.erlang.cookie<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、启动RabbitMQ服务</strong></p>
<p>在每台机器上启动RabbitMQ服务：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># detached代表以后台守护进程方式启动</span><br>rabbitmq-server start -detached<br></code></pre></td></tr></tbody></table></figure>
<p><strong>5、将节点加入集群</strong></p>
<p>在node2中执行下列指令，将node2加入到node1的集群：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># stop_app表示之关闭RabbitMQ服务，stop则会将Erlang虚拟机也关闭</span><br>rabbitmqctl stop_app<br>rabbitmqctl reset<br>rabbitmqctl join_cluster rabbit@node1<br>rabbitmqctl start_app<br></code></pre></td></tr></tbody></table></figure>
<p>同理，将node3加入到node2的集群。</p>
<p><strong>6、查看集群状态</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rabbitmqctl cluster_status<br></code></pre></td></tr></tbody></table></figure>
<p><strong>7、需要重新设置用户</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 添加用户，用户名admin，密码123</span><br>rabbitmqctl add_user admin 123<br><span class="hljs-comment"># 设置用户角色</span><br>rabbitmqctl set_user_tags admin administrator<br><span class="hljs-comment"># 设置用户权限</span><br>rabbitmqctl set_permissions -p <span class="hljs-string">"/"</span> admin <span class="hljs-string">".*"</span> <span class="hljs-string">".*"</span> <span class="hljs-string">".*"</span><br></code></pre></td></tr></tbody></table></figure>
<p>至此，包括三个节点的集群搭建完成。</p>
<p>如果想要解除集群节点，需要在节点中执行解除指令，比如 在节点1中解除节点2，需要在节点1中执行下面的指令：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># node1解除node2节点</span><br>rabbitmqctl forget_cluster_node rabbit@node2<br></code></pre></td></tr></tbody></table></figure>
<h2 id="10-2-镜像队列"><a href="#10-2-镜像队列" class="headerlink" title="10.2 镜像队列"></a>10.2 镜像队列</h2><p><a href="https://www.rabbitmq.com/ha.html"><strong>镜像队列</strong></a>是指将队列镜像到集群中的其他Broker节点之上，这样当集群中某一节点失效后，队列能够自动切换到镜像中的另一个节点上保证服务的可用性。</p>
<blockquote>
<p>和集群保证的可用性不同的是，集群中某一节点宕机后，其中的队列都不可用了，队列中的消息也无法被消费。而镜像队列能够保证集群中的节点宕机后，队列中的消息也不会丢失。</p>
</blockquote>
<p><strong>搭建步骤</strong></p>
<p>以3个集群节点为例，通过web管理页面创建镜像队列。</p>
<p><strong>1、启动三个集群节点</strong></p>
<p><strong>2、添加policy</strong></p>
<p>选一个节点，比如node1，然后<code>Add/update a policy</code>，进行如下设置：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_12.png"><span class="image-caption">镜像队列配置</span></p>
<blockquote>
<p>如果在代码中设置镜像队列，参数名称前需要加<code>x-</code></p>
</blockquote>
<p>这样，在node1上创建一个队列，则其他两个节点都有这个队列的镜像队列。当node1宕机以后，可以继续使用node2节点中的队列，保证了高可用性。</p>
<h2 id="10-3-高可用负载均衡"><a href="#10-3-高可用负载均衡" class="headerlink" title="10.3 高可用负载均衡"></a>10.3 高可用负载均衡</h2><p><strong>1、使用Haproxy实现负载均衡。</strong></p>
<p>Nginx、lvs、Haproxy之间的区别：<a href="http://www.ha97.com/5646.html">http://www.ha97.com/5646.html</a></p>
<p>假设当前有一个Haproxy服务器，要负责一个3个节点的RabbitMQ集群的负载均衡，需要在Haproxy服务器配置如下：</p>
<p>安装Haproxy：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">yum -y install haproxy<br></code></pre></td></tr></tbody></table></figure>
<p>修改<code>haproxy.cfg</code>：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">vim /etc/haproxy/haproxy.cfg<br></code></pre></td></tr></tbody></table></figure>
<p>修改以下内容，将IP改为集群中节点的IP地址：</p>
<figure class="highlight routeros"><table><tbody><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 检测心跳频率</span><br>server rabbitmq_node1 123.123.123.1:5672 check inter 5000 rise 2 fall 3 weight1<br>server rabbitmq_node1 123.123.123.2:5672 check inter 5000 rise 2 fall 3 weight1<br>server rabbitmq_node1 123.123.123.3:5672 check inter 5000 rise 2 fall 3 weight1<br></code></pre></td></tr></tbody></table></figure>
<p>启动Haproxy：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">haproxy -f /etc/haproxy/haproxy.cfg<br><span class="hljs-comment"># 查看服务是否启动</span><br>ps -ef | grep haproxy<br></code></pre></td></tr></tbody></table></figure>
<p>访问地址： <code>http://haproxy主机地址:8888/stats</code></p>
<p><strong>2、Keeplived实现双机热备份</strong></p>
<p>上面只使用了一个Haproxy主机进行负载均衡，如果Haproxy主机宕机，虽然RabbitMQ集群没有故障，但是对于外界客户端来说所有的连接都会断开。为了确保负载均衡服务的可靠性，使用Keepalied做高可用，实现故障转移。</p>
<p>Keepalived能够通过自身健康检查，资源接管功能做双机热备份。</p>
<p>Keepalived实现双机热备的步骤可参考：<a href="https://blog.51cto.com/hellocjq/2089450">https://blog.51cto.com/hellocjq/2089450</a></p>
<h2 id="10-4-Federation-Plugin"><a href="#10-4-Federation-Plugin" class="headerlink" title="10.4 Federation Plugin"></a>10.4 Federation Plugin</h2><p><a href="https://www.rabbitmq.com/federation.html">Federation插件</a>的目的是在不同集群的Broker之间同步消息。</p>
<p>Federation plugin可以实现<a href="https://www.rabbitmq.com/federated-exchanges.html">Federation Exchange</a>和<a href="https://www.rabbitmq.com/federated-queues.html">Federation Queue</a>两种功能。</p>
<p><strong>Federation Exchange</strong></p>
<p>比如，位于两个地区（不同集群）的两个交换机，如果需要两个地区的用户访问两个节点速度一致，不会出现A地区用户访问B地区服务器延迟比较高的情况，需要使用Federation exchange。</p>
<p>将其中一个设置为上游交换机，另一个设置为下游交换机，这样发送到上游交换机的信息会通过federation机制同步到下游交换机。这样下游交换机的消费者访问两个交换机的速度是一致的。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_13.png"><span class="image-caption">Federation Plugin</span></p>
<p>搭建步骤参考：<a href="https://www.cnblogs.com/yeyongjian/p/13964161.html">https://www.cnblogs.com/yeyongjian/p/13964161.html</a></p>
<p><strong>Federation Queue</strong></p>
<p>联邦队列可以在多个Broker节点或集群之间，为单个队列提供负载均衡的功能。一个联邦队列可以连接一个或多个上游队列，并从这些上游队列中获取消息以满足本地消费者消费消息的需求。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/rabbitmq_14.png"><span class="image-caption">Federation Queue</span></p>
<h2 id="10-5-Shovel-Plugin"><a href="#10-5-Shovel-Plugin" class="headerlink" title="10.5 Shovel Plugin"></a>10.5 Shovel Plugin</h2><p><a href="https://www.rabbitmq.com/shovel.html">Shovel plugin</a>能够可靠、持续地从一个Broker中的队列（源，source）拉去数据并转发到另一个Broker中的交换器中（目的端，destination）。</p>
<p>源端的队列和目的端的交换机可以同时位于同一个Broker，也可以位于不同的Broker上。</p>
<p>部署方法可以参考官方文档：<a href="https://www.rabbitmq.com/shovel.html">https://www.rabbitmq.com/shovel.html</a></p>
]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>消息队列</tag>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis基础</title>
    <url>/2021/07/30/redis/</url>
    <content><![CDATA[<h1 id="一、Redis入门"><a href="#一、Redis入门" class="headerlink" title="一、Redis入门"></a>一、Redis入门</h1><p>Redis（Remote Dictionary Server）远程字典服务。基于<strong>键值对</strong>的NoSQL数据库</p>
<p>Redis教程参考：<a href="https://www.redis.com.cn/tutorial.html">Redis中文教程</a></p>
<p>Redis命令参考：<a href="http://www.redis.cn/commands.html">Redis命令</a></p>
<h2 id="1-1-Redis安装"><a href="#1-1-Redis安装" class="headerlink" title="1.1 Redis安装"></a>1.1 Redis安装</h2><p>获取安装包：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">wget http://download.redis.io/releases/redis-5.0.8.tar.gz<br></code></pre></td></tr></tbody></table></figure>
<p>一般我们将安装的第三方文件放到<code>usr/local</code>目录下。</p>
<p>因此将其解压到<code>usr/local/redis</code>目录下，作为redis的根目录。</p>
<p>解压到指定目录：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">tar xzvf redis-5.0.8.tar.gz /usr/<span class="hljs-built_in">local</span>/redis<br></code></pre></td></tr></tbody></table></figure>
<p>进入<code>redis</code>目录进行安装：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> redis<br><span class="hljs-comment"># 因为Redis是c语言编写的，需要gcc编译器的支持，因此需要保证系统中已安装了gcc</span><br><span class="hljs-comment"># 编译</span><br>make<br></code></pre></td></tr></tbody></table></figure>
<p>编译后，在<code>redis</code>目录下会生成一个<code>src</code>目录，里面包含了<code>redis-server</code>服务端和<code>redis-cli</code>客户端，已经可以启动redis服务了。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/redis_1.png"><span class="image-caption">编译后的目录</span></p>
<p>通常，我们还会执行<code>make install</code>进行安装，这样可以方便管理：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 进入src目录</span><br><span class="hljs-built_in">cd</span> src<br><span class="hljs-comment"># 安装，并指定安装的位置，在这个位置下会生成一个bin目录</span><br>make install PREFIX=/usr/<span class="hljs-built_in">local</span>/redis<br></code></pre></td></tr></tbody></table></figure>
<p>安装完后，指定的<code>/usr/local/redis</code>目录下会生成一个<code>bin</code>目录，这个目录里面包含了常用的几个可执行文件，我们将<code>redis/redis.conf</code>配置文件复制一份到<code>redis/bin</code>这个目录，作为我们自己的配置文件。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">cp redis.conf ./bin/myredis.conf<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/redis_2.png"><span class="image-caption">bin目录</span></p>
<p>这样，我们以后只需要在<code>redis/bin</code>这个目录下进行操作就可以了。</p>
<p>redis服务默认是前台执行的，将配置文件中的<code>daemonize</code>值修改为<code>yes</code>，就可以将redis启动为后台进程。</p>
<p>在<code>bin</code>目录下启动redis服务端：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 在bin目录下，根据指定的配置文件启动,如果不指定，会根据默认的配置文件启动</span><br>./redis-server myredis.conf<br></code></pre></td></tr></tbody></table></figure>
<p>启动成功。</p>
<h2 id="1-2-Redis启动"><a href="#1-2-Redis启动" class="headerlink" title="1.2 Redis启动"></a>1.2 Redis启动</h2><p>Redis的默认端口号是6379。</p>
<p>启动服务端，在安装目录下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用默认的配置文件启动</span><br>./redis-server <br><span class="hljs-comment"># 也可以使用指定的配置文件启动</span><br>./redis-server redis-config.conf<br></code></pre></td></tr></tbody></table></figure>
<p>启动客户端连接服务端：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">./redis-cli -p 6379<br></code></pre></td></tr></tbody></table></figure>
<p>如果是服务端就是本机，则端口号和服务器主机地址可以不用写</p>
<p>在客户端中，可以使用<code>exit</code>命令退出连接，使用<code>shutdown</code>命令关闭服务端。</p>
<p>Redis命令不区分大小写。</p>
<p>redis默认有16个数据库，<code>select</code>命令选择指定的数据库</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 选择第0号数据库</span><br>select 0<br></code></pre></td></tr></tbody></table></figure>
<p>清空当前数据库：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">flushdb<br></code></pre></td></tr></tbody></table></figure>
<p>清空所有数据库：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">flushall<br></code></pre></td></tr></tbody></table></figure>
<p>删除当前数据库的某个key</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">del mykey<br></code></pre></td></tr></tbody></table></figure>
<p>Redis是单线程的，基于内存的，没有使用多线程，redis6.0之后引入了多线程，主要是为了提高网络IO读写性能。</p>
<p>Redis基于内存，因此其瓶颈主要受限于内存和网络。</p>
<h2 id="1-3-Redis速度快的原因"><a href="#1-3-Redis速度快的原因" class="headerlink" title="1.3 Redis速度快的原因"></a>1.3 Redis速度快的原因</h2><p>1、<strong>基于内存</strong></p>
<p>Redis的绝大部分请求是纯粹的内存操作，非常快速。</p>
<p>2、<strong>数据结构简单</strong></p>
<p>Redis的数据结构简单，并且数据操作也简单，Redis中的数据结构是专门采用C语言进行设计的</p>
<p>3、<strong>采用单线程</strong></p>
<p>Redis使用单线程模型，避免了不必要的上下文切换和竞争条件，也不存在多进程或者多线程导致的切换而消耗 CPU，不需要考虑锁的问题以及加锁释放锁操作，没有因为可能出现死锁而导致的性能消耗。</p>
<p>因为<strong>Redis是基于内存的操作，CPU不是Redis的瓶颈，Redis的瓶颈是内存的大小和网络带宽</strong>，因此可以采用单线程的方式。</p>
<p>Redis在4.0版本加入了多线程支持，主要的目的是针对大键值对删除操作的命令，使用这些命令就会使用主处理之外的其他线程来“异步处理”。</p>
<p>Redis 6.0正式引入了多线程，目的是为了提高网络IO读写性能。Redis6.0虽然引入了多线程，但是只在网络数据的读写这类耗时操作上使用，执行命令仍然是单线程顺序执行。</p>
<p>4、<strong>使用多路I/O复用模型</strong></p>
<p>Redis虽然是单线程，但采用<strong>非阻塞的IO多路复用程序</strong>来监听来自客户端的大量连接。</p>
<blockquote>
<p>非阻塞IO可以在等待期间做其他事情；阻塞IO等待期间什么也不能做。</p>
</blockquote>
<p>5、<strong>使用底层模型不同</strong></p>
<p>Redis自己构建了VM 机制 ，因为一般的系统调用系统函数，会浪费一定的时间去移动和请求；</p>
<h1 id="二、数据类型"><a href="#二、数据类型" class="headerlink" title="二、数据类型"></a>二、数据类型</h1><p>Redis中有五种基本数据类型：String、List、Set、Hash、sorted set（Zset）</p>
<p>另外有三种特殊的数据类型：geospatial、hyperloglog、bitmaps</p>
<h2 id="2-1-五大数据类型"><a href="#2-1-五大数据类型" class="headerlink" title="2.1 五大数据类型"></a>2.1 五大数据类型</h2><h3 id="2-1-1-基础操作"><a href="#2-1-1-基础操作" class="headerlink" title="2.1.1 基础操作"></a>2.1.1 基础操作</h3><p>查看所有的key：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">keys *<br></code></pre></td></tr></tbody></table></figure>
<p>设置一个key:</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> name Rick   <span class="hljs-comment"># 设置key为name，value为Rick</span><br></code></pre></td></tr></tbody></table></figure>
<p>获取key的值：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">get name   <span class="hljs-comment"># 获取名为name的这个key的值</span><br></code></pre></td></tr></tbody></table></figure>
<p>判断key是否存在：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">exists name  <span class="hljs-comment"># 判断name这个key是否存在</span><br></code></pre></td></tr></tbody></table></figure>
<p>查看key的类型：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">type</span> name  <span class="hljs-comment"># 查看name这个key的类型</span><br></code></pre></td></tr></tbody></table></figure>
<p>移动指定key到其他数据库：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">move name 1  <span class="hljs-comment"># 将当前数据库中的name这个键值对移动到1号数据库中</span><br></code></pre></td></tr></tbody></table></figure>
<p>设置key的过期时间：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">expire name 10  <span class="hljs-comment"># 将name这个key设置为10秒后过期，10s后就会被销毁</span><br></code></pre></td></tr></tbody></table></figure>
<p>查看某个key的剩余存活时间</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">ttl name  <span class="hljs-comment"># 查看name的剩余存活时间,-1表示永久有效</span><br></code></pre></td></tr></tbody></table></figure>
<h3 id="2-1-2-String"><a href="#2-1-2-String" class="headerlink" title="2.1.2 String"></a>2.1.2 String</h3><p><code>append</code>追加字符串</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> key1 v1  <span class="hljs-comment"># 设置一个key</span><br>append key1 hello  <span class="hljs-comment"># 向key1的值后面追加一个字符串hello，结果为v1hello</span><br></code></pre></td></tr></tbody></table></figure>
<p>如果当前key不存在，会新建一个，相当于<code>set</code>命令</p>
<p><code>strlen</code> 查看字符串长度</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">strlen key1   <span class="hljs-comment"># key1为v1时，结果为2</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>incr</code>将key的值+1，前提是key的值必须是整数：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> key1 10  <span class="hljs-comment"># 设置一个key</span><br>incr key1  <span class="hljs-comment"># 将key1的值+1，结果是11</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>incrby</code>：将key的值加上指定的值：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> key1 10 <span class="hljs-comment"># 设置key1的值为10</span><br>incrby key1 5 <span class="hljs-comment"># 将key1的值+5，结果是15</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>decr</code>将key的值减一。</p>
<p><code>decrby</code>将key的值减指定的值。</p>
<p><code>getrange</code>获取指定范围的字符：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> key1 hello  <br>getrange key1 0 3  <span class="hljs-comment"># 获取key1的值的0-3范围的字符，结果是hell</span><br>getrange key1 0 -1 <span class="hljs-comment"># hello，-1表示全部字符串</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>setrange</code>替换指定位置开始的字符串：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> key1 hello<br>setrange key1 3 world  <span class="hljs-comment"># helworld，将索引从3开始的字符开始往后替换</span><br>setrange key1 1 hh <span class="hljs-comment"># hhhworld，字符从指定位置向后覆盖</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>setex</code>，set with expire，即设置一个带过期时间的key：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">setex key1 10 hello   <span class="hljs-comment"># 设置key1的值为hello，且10秒后过期</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>setnx</code>，set if not exist，如果当前key不存在，就创建，否则创建失败（而普通的<code>set</code>指令会替换值）：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> key1 hello <span class="hljs-comment"># 当前有一个key1</span><br>setnx key1 world <span class="hljs-comment"># 返回值为0，表示设置失败，因为key1已经存在了</span><br>setnx key2 world <span class="hljs-comment"># 返回值为1，key2不存在的时候，会新建成功</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>mset</code>和<code>mget</code>同时设置和获取多个值</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">mset k1 v1 k2 v2 k3 v3<br>mget k1 k2 k3 <span class="hljs-comment"># 结果为v1 v2 v3</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>msetnx</code>如果指定的key都不存在才创建，只要有一个已经存在，就创建失败，这是一个原子性的指令。</p>
<hr>
<p>使用<code>set</code>/<code>mset</code>命令创建对象，可以有两种方式，一种是保存JSON格式的字符串，另一种则是以键值对的方式：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 方式一：JSON</span><br><span class="hljs-built_in">set</span> user:1 {name:Rick,age:20}<br><br><span class="hljs-comment"># 方式二：完全使用键值对</span><br>mset user:1:name Rick user:1:age:20<br></code></pre></td></tr></tbody></table></figure>
<p>方式一保存了一条数据，key为<code>user:1</code>，value为<code>{name:Rick,age:20}</code>的数据；</p>
<p>方式二保存了两条数据，key为<code>user:1:name</code>，value为<code>Rick</code>；第二条数据的key为<code>user:1:age</code>，value为<code>20</code>。</p>
<p>两种方式都能够用来表示一个user对象，使用key来区分不同的对象。第二种方式的key是一个巧妙的设计。</p>
<hr>
<p><code>getset</code>先获取值，再设置值，如果key不存在，则会新建一个key，并把值赋进去：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">getset key1 value1 <span class="hljs-comment"># 如果key1不存在，则会返回nil</span><br>getset key1 value2 <span class="hljs-comment"># 再次执行，此时可以获取到上一条指令设置的value1</span><br></code></pre></td></tr></tbody></table></figure>
<p>String类型的使用场景，value值除了是字符串以外，还可以是数字型的字符串，可以用来计算。</p>
<p>应用场景：</p>
<ul>
<li>计数器</li>
<li>记录阅读量、浏览量等</li>
</ul>
<h3 id="2-1-3-List"><a href="#2-1-3-List" class="headerlink" title="2.1.3 List"></a>2.1.3 List</h3><p>list，列表，可以当作栈、队列、阻塞队列来使用，本质是一个<strong>双向链表</strong>。具体用法参考：<a href="https://www.redis.com.cn/redis-lists.html">List</a></p>
<p><code>list</code>的指令一般是以<code>l</code>和<code>r</code>开头的。<code>l</code>可以理解为list或left，r理解为right。</p>
<p>list中的值，索引是从最新的值为0开始算的，类似于栈顶元素的索引值为0。</p>
<p><code>lpush</code>向一个list中添加一个值或多个值，从左边添加，即从头部添加：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 向list1这个list中添加3个数据1、2、3、4、5</span><br>lpush list1 1<br>lpush list1 2<br>lpush list1 3<br>lpush list1 4 5<br><span class="hljs-comment"># 此时的list1值为5，4,3,2,1</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>lindex</code>通过索引获取列表中的元素：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">lindex list1 0  <span class="hljs-comment"># 值为5</span><br></code></pre></td></tr></tbody></table></figure>
<p>此时数据1、2、3、4、5在list1中的索引为4、3、2、1、0</p>
<p><code>lrange</code>取出list数据中指定范围的值：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">lrange list1 0 -1  <span class="hljs-comment"># 获取list1的所有值</span><br></code></pre></td></tr></tbody></table></figure>
<p> <code>rpush</code>在列表中添加一个或多个值，从尾部添加：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">rpush list1 0 <span class="hljs-comment"># 此时的list1值为5,4,3,2,1,0</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>lpop</code>从头部移除一个数据</p>
<p><code>rpop</code>从尾部移除一个数据</p>
<p><code>blpop</code>移除并获取列表的第一个元素</p>
<p><code>brpop</code>移除并获取列表的最后一个元素</p>
<p><code>llen</code>获取列表长度</p>
<p><code>lrem</code>移除指定的元素：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 从key中，移除count个值为value的元素</span><br>lrem key count value  <br></code></pre></td></tr></tbody></table></figure>
<ul>
<li>count&gt;0：从头到尾移除count个值为value的元素</li>
<li>count&lt;0：从尾到头移除count个置为value的元素</li>
<li>count=0：移除所有值为value的元素。</li>
</ul>
<p><code>ltrim</code>将一个list截取为指定的元素，list的值会改变。</p>
<p><code>rpoplpush</code>移除列表最后一个元素，并将其添加到指定的列表</p>
<p><code>lset</code>通过索引设置列表指定索引元素的值。前提是list和这个索引位置必须存在。</p>
<p><code>linsert</code>在列表的指定的值前或后插入元素</p>
<p><strong>应用场景</strong></p>
<ul>
<li>发布或订阅</li>
<li>消息队列、慢查询</li>
</ul>
<h3 id="2-1-4-Set"><a href="#2-1-4-Set" class="headerlink" title="2.1.4 Set"></a>2.1.4 Set</h3><p>set，集合，其中的值无序、不能重复。</p>
<p>set的指令以<code>s</code>开头。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>指令</th>
<th>操作</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.redis.com.cn/commands/sadd.html">sadd</a></td>
<td>向集合添加一个或多个成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/scard.html">scard</a></td>
<td>获取集合的成员数</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/sdiff.html">sdiff</a></td>
<td>返回给定所有集合的差集，返回值是第一个集合中独有的元素</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/sdiffstore.html">sdiffstore</a></td>
<td>返回给定所有集合的差集并存储在指定集合中</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/sinter.html">sinter</a></td>
<td>返回给定所有集合的交集</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/sinterstore.html">sinterstore</a></td>
<td>返回给定所有集合的交集并存储在指定集合中</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/sismember.html">sismember</a></td>
<td>判断 member 元素是否是集合 key 的成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/smembers.html">smembers</a></td>
<td>返回集合中的所有成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/smove.html">smove</a></td>
<td>将 member 元素从 source 集合移动到指定的集合</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/spop.html">spop</a></td>
<td>移除并返回集合中的一个<strong>随机</strong>元素</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/srandmember.html">srandmember</a></td>
<td>返回集合中一个或多个随机数</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/srem.html">srem</a></td>
<td>移除集合中一个或多个成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/sunion.html">sunion</a></td>
<td>返回所有给定集合的并集</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/sunionstore.html">sunionstore</a></td>
<td>所有给定集合的并集存储在指定集合中</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/sscan.html">sscan</a></td>
<td>迭代集合中的元素</td>
</tr>
</tbody>
</table>
</div>
<p><strong>应用场景</strong></p>
<ul>
<li>需要存放的数据不能重复，以及需要获取多个数据源交集和并集的情况，比如共同关注，共同粉丝等。</li>
</ul>
<h3 id="2-1-5-Hash"><a href="#2-1-5-Hash" class="headerlink" title="2.1.5 Hash"></a>2.1.5 Hash</h3><p>hash类似于HashMap，即key的值是一个键-值对（域-值对），即<code>field</code>和<code>value</code>的映射。特别<strong>适合存放对象。</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">hset user:1 name Rick age 20 <span class="hljs-comment"># 设置user:1这个hash的name为Rick，age为20</span><br>hget user:1 name  <span class="hljs-comment"># 结果为Rick</span><br></code></pre></td></tr></tbody></table></figure>
<p>hash的指令以<code>h</code>开头，表示其操作是对hash类型的数据操作的。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hdel</code></td>
<td>删除一个或多个哈希表字段</td>
</tr>
<tr>
<td><code>hexists</code></td>
<td>查看哈希表key中，指定的字段是否存在</td>
</tr>
<tr>
<td><code>hget</code></td>
<td>获取存储在哈希表中指定字段的值</td>
</tr>
<tr>
<td><code>hgetall</code></td>
<td>获取在哈希表中指定key的所有字段和值</td>
</tr>
<tr>
<td><code>hset</code></td>
<td>设置哈希表中field的值</td>
</tr>
<tr>
<td><code>hsetnx</code></td>
<td>只有在字段filed不存在时，设置哈希表字段的值</td>
</tr>
<tr>
<td><code>hmget</code></td>
<td>获取所有给定字段的值</td>
</tr>
<tr>
<td><code>hmset</code></td>
<td>同时将多个filed-value对设置到哈希表中</td>
</tr>
<tr>
<td><code>hkeys</code></td>
<td>获取所有哈希表中的字段</td>
</tr>
<tr>
<td><code>hvals</code></td>
<td>获取哈希表中所有值</td>
</tr>
<tr>
<td><code>hincrby</code></td>
<td>为哈希表key中指定字段的整数值加上增量</td>
</tr>
<tr>
<td><code>hincrbyfloat</code></td>
<td>为哈希表key中指定字段的浮点数值加上增量</td>
</tr>
<tr>
<td><code>hlen</code></td>
<td>获取哈希表中字段的数量</td>
</tr>
<tr>
<td><code>hscan</code></td>
<td>迭代哈希表中的键值对</td>
</tr>
<tr>
<td><code>hstrlen</code></td>
<td>返回哈希表中与给定域field相关联的值的字符串长度</td>
</tr>
</tbody>
</table>
</div>
<p><strong>应用场景</strong></p>
<p>常用于存储对象数据</p>
<h3 id="2-1-6-Zset"><a href="#2-1-6-Zset" class="headerlink" title="2.1.6 Zset"></a>2.1.6 Zset</h3><p>Zset，即sorted set，有序集合。与set相比，Zset增加了一个权重参数score，使得集合中的元素能够按照score进行有序排列，还可以通过score的范围来获取元素的列表。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://www.redis.com.cn/commands/zadd.html">zadd</a></td>
<td>向有序集合添加一个或多个成员，或者更新已存在成员的分数</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zcard.html">zcard</a></td>
<td>获取有序集合的成员数</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zcount.html">zcount</a></td>
<td>计算在有序集合中指定区间分数的成员数</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zincrby.html">zincrby</a></td>
<td>有序集合中对指定成员的分数加上增量</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zinterstore.html">zinterstore</a></td>
<td>计算给定的一个或多个有序集的交集并将结果集存储在新的有序集合 key 中</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zlexcount.html">zlexcount</a></td>
<td>在有序集合中计算指定字典区间内成员数量</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zrange.html">zrange</a></td>
<td>通过索引区间返回有序集合成指定区间内的成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zrangebylex.html">zrangebylex</a></td>
<td>通过字典区间返回有序集合的成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zrangebyscore.html">zrangebyscore</a></td>
<td>通过分数返回有序集合指定区间内的成员，默认是闭区间，-inf为负无穷，+inf正无穷</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zrank.html">zrank</a></td>
<td>返回有序集合中指定成员的索引</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zrem.html">zrem</a></td>
<td>移除有序集合中的一个或多个成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zremrangebylex.html">zremrangebylex</a></td>
<td>移除有序集合中给定的字典区间的所有成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zremrangebyrank.html">zremrangebyrank</a></td>
<td>移除有序集合中给定的排名区间的所有成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zremrangebyscore.html">zremrangebyscore</a></td>
<td>移除有序集合中给定的分数区间的所有成员</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zrevrange.html">zrevrange</a></td>
<td>返回有序集中指定区间内的成员，通过索引，分数从高到低</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zrevrangebyscore.html">zrevrangebyscore</a></td>
<td>返回有序集中指定分数区间内的成员，分数从高到低排序</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zrevrank.html">zrevrank</a></td>
<td>返回有序集合中指定成员的排名，有序集成员按分数值递减(从大到小)排序</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zscore.html">zscore</a></td>
<td>返回有序集中，成员的分数值</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zunionstore.html">zunionstore</a></td>
<td>计算一个或多个有序集的并集，并存储在新的 key 中</td>
</tr>
<tr>
<td><a href="https://www.redis.com.cn/commands/zscan.html">zscan</a></td>
<td>迭代有序集合中的元素（包括元素成员和元素分值）</td>
</tr>
</tbody>
</table>
</div>
<p><strong>应用场景</strong></p>
<p>常用于需要对数据根据权重进行排序的场景，比如成绩排名、直播间礼物排行榜、热度排行榜等</p>
<h2 id="2-2-三种特殊数据类型"><a href="#2-2-三种特殊数据类型" class="headerlink" title="2.2 三种特殊数据类型"></a>2.2 三种特殊数据类型</h2><h3 id="2-2-1-geospatial"><a href="#2-2-1-geospatial" class="headerlink" title="2.2.1 geospatial"></a>2.2.1 geospatial</h3><p>Redis GEO 主要用于存储地理位置信息，并对存储的信息进行操作，是 Redis 3.2新增的类型。</p>
<p>Redis GEO 操作方法有：</p>
<ul>
<li><code>geoadd</code>：添加地理位置的坐标。</li>
<li><code>geopos</code>：获取地理位置的坐标。</li>
<li><code>geodist</code>：计算两个位置之间的距离。</li>
<li><code>georadius</code>：根据给定的经纬度坐标为中心，获取指定半径范围内的地理位置集合。</li>
<li><code>georadiusbymember</code>：根据储存在位置集合里面的某个地点，获取指定半径范围内的地理位置集合。</li>
<li><code>geohash</code>：返回一个或多个位置对象的 geohash 值。</li>
</ul>
<p>使用举例：</p>
<p><code>geoadd key 经度 纬度 member(即地点名)</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">geoadd city 116.40 39.90 beijing  <span class="hljs-comment"># key为city，成员为beijing，经纬度数据为116.4 39.90</span><br>geoadd city 121.47 31.23 shanghai<br>geoadd city 120.16 30.24 hangzhou<br>geoadd city 114.05 22.52 shenzhen<br>geoadd city 106.50 29.53 chongqing<br></code></pre></td></tr></tbody></table></figure>
<p><code>geopos</code>获取地理位置的坐标。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">geopos city beijing<br><span class="hljs-comment"># 输出结果为：</span><br>1) 1) <span class="hljs-string">"116.39999896287918091"</span><br>   2) <span class="hljs-string">"39.90000009167092543"</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>geodist key member1 member2 [unit]</code> 可以指定单位，比如m、km</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 计算beijing和shanghai之间的直线距离，默认是m为单位</span><br>geodist city beijing shanghai km  <br><span class="hljs-string">"1067.3788"</span><br></code></pre></td></tr></tbody></table></figure>
<p>geospatial底层使用Zset实现，因此可以使用Zset的部分指令，比如查看所有成员，或者移除成员：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; <span class="hljs-built_in">type</span> city  <span class="hljs-comment"># 查看geospatial的数据类型</span><br>zset  <span class="hljs-comment"># geospatial的类型是zset</span><br>zrange city 0 -1  <span class="hljs-comment"># 查看city里面的所有成员</span><br>zrem city hangzhou  <span class="hljs-comment"># 移除city里面的hangzhou这个成员</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>应用场景</strong></p>
<p>比如查找附近的人、查找指定地点周围的地点等。</p>
<h3 id="2-2-2-hyperloglog"><a href="#2-2-2-hyperloglog" class="headerlink" title="2.2.2 hyperloglog"></a>2.2.2 hyperloglog</h3><p>HyperLogLog是用来做基数统计的算法，它的优势是在输入元素的数量或者体积非常大时，计算基数所需的空间总是固定的、并且是很小的。</p>
<p>HyperLogLog<strong>只会根据输入元素来计算基数，不会存储输入元素本身</strong>，所以它不能像集合那样返回输入的各个元素。</p>
<blockquote>
<p>基数，即集合中不重复的元素，比如{1,2,3,4,4,5,2,3}，其基数为{1,2,3,4,5}</p>
</blockquote>
<p>使用HyperLogLog是由计算基数值是有误差的，但误差率小于1%。</p>
<p>常用命令：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pfadd</code></td>
<td>添加指定元素到HyperLogLog中</td>
</tr>
<tr>
<td><code>pfcount</code></td>
<td>返回给定HyperLogLog的基数估算值，误差小于1%</td>
</tr>
<tr>
<td><code>pfmerge</code></td>
<td>将多个HyperLogLog合并为一个HyperLogLog</td>
</tr>
</tbody>
</table>
</div>
<p><strong>应用场景</strong></p>
<p>比如计算网站的UV（独立访客，访问用户数），前提是允许有误差，否则只能用set。</p>
<h3 id="2-2-3-bitmaps"><a href="#2-2-3-bitmaps" class="headerlink" title="2.2.3 bitmaps"></a>2.2.3 bitmaps</h3><p>Bitmaps使用二进制位来记录数据，只有0和1，比较适合表示某个元素的两种状态。</p>
<p>常用命令：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>命令</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>setbit</code></td>
<td>设置数据，返回值为之前位的值，默认为0。</td>
</tr>
<tr>
<td><code>getbit</code></td>
<td>获取某个位上的值</td>
</tr>
<tr>
<td><code>bitcount</code></td>
<td>计算并返回1的个数</td>
</tr>
<tr>
<td><code>bitop</code></td>
<td>对一个或多个key进行位运算（and、or、not、xor），将结果保存到另一个key中</td>
</tr>
<tr>
<td><code>bitpos</code></td>
<td>查找指定范围内，0或1出现的第一个位置。</td>
</tr>
</tbody>
</table>
</div>
<p>使用案例：</p>
<p><code>setbit key offset value</code>，将key上指定offset上的值设置为value（0或1），offset可以用来表示用户id或日期。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置day的7个值，表示七天的签到状态，1表示签到，0表示未签到</span><br><span class="hljs-comment"># 即1101011</span><br>setbit day 0 1<br>setbit day 1 1<br>setbit day 2 0<br>setbit day 3 1<br>setbit day 4 0<br>setbit day 5 1<br>setbit day 6 1<br><br>getbit day 5  <span class="hljs-comment">#获取offset为5的值，结果为1</span><br>bitcount day  <span class="hljs-comment"># 统计day中1的个数，结果为5，表示有5个1</span><br>bitpos day 1  <span class="hljs-comment"># 查找day中1第一次出现的位置，默认是所有位，可以指定范围</span><br><br><span class="hljs-comment"># day1 1101011</span><br><span class="hljs-comment"># day2 1001100</span><br>bitop and day3 day1 day2 <span class="hljs-comment"># 将day1和day2的与运算结果保存到day3中，结果为1001000</span><br>bitop or day4 day1 day2  <span class="hljs-comment"># 将day1和day2的或运算结果保存到day4中，结果为1101111</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>常用场景</strong></p>
<p>用户是否活跃、用户签到状态等。</p>
<h1 id="三、Redis事务"><a href="#三、Redis事务" class="headerlink" title="三、Redis事务"></a>三、Redis事务</h1><h2 id="3-1-Redis执行事务"><a href="#3-1-Redis执行事务" class="headerlink" title="3.1 Redis执行事务"></a>3.1 Redis执行事务</h2><font color="red">Redis的单条命令是原子性的，但是Redis中的事务不保证原子性。因此没有隔离级别的概念</font>

<p>Redis事务不支持回滚，因而不满足原子性，并且不满足持久性。Redis事务就是将多个命令请求打包，按顺序执行，并且中途不会被打断。</p>
<blockquote>
<p>只有当发生语法错误(语法错误在命令队列时无法检测到)，对keys赋予了一个类型错误的数据时，Redis命令才会执行失败, 这些都是程序性错误，这类错误在开发的过程中就能够发现并解决掉，几乎不会出现在生产环境。因此不需要回滚机制</p>
<p>由于不需要回滚，这使得Redis内部更加简单，而且运行速度更快。</p>
</blockquote>
<p>Redis的事务<strong>本质</strong>：一组命令的集合。一个事务中的所有命令都会被序列化，在事务的执行过程中，会按照顺序执行。</p>
<p>Redis 事务可以一次执行多个命令， 并且带有以下三个重要的保证：</p>
<ul>
<li>批量操作在发送<code>EXEC</code>命令前被放入队列缓存。</li>
<li>收到<code>EXEC</code>命令后进入事务执行，<strong>事务中任意命令执行失败，其余的命令依然被执行</strong>。</li>
<li>在事务执行过程，其他客户端提交的命令请求不会插入到事务执行命令序列中。</li>
</ul>
<p>Redis事务从开始到执行的过程：</p>
<ul>
<li>开始事务：<code>multi</code></li>
<li>命令入队，即批量操作的命令，以队列FIFO的顺序执行</li>
<li>执行事务：<code>exec</code></li>
</ul>
<p>可以使用<code>discard</code>命令取消一个事务。</p>
<p>使用案例：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">&gt; multi 	<span class="hljs-comment"># 开启事务</span><br>OK<br>&gt; <span class="hljs-built_in">set</span> k1 v1  <span class="hljs-comment"># 命令入队</span><br>QUEUED<br>&gt; <span class="hljs-built_in">set</span> k2 v2<br>QUEUED<br>&gt; <span class="hljs-built_in">set</span> k3 v3<br>QUEUED<br>&gt; get k2<br>QUEUED<br>&gt; <span class="hljs-built_in">exec</span>     <span class="hljs-comment"># 执行事务，会按照入队顺序依次执行命令</span><br>1) OK<br>2) OK<br>3) OK<br>4) <span class="hljs-string">"v2"</span><br>===================<br>&gt; multi		<span class="hljs-comment">#开启事务</span><br>OK<br>&gt; <span class="hljs-built_in">set</span> k4 v4  <span class="hljs-comment"># 命令入队</span><br>QUEUED<br>&gt; discard  <span class="hljs-comment"># 取消事务</span><br>OK  <br>&gt; get k4   <span class="hljs-comment"># 事务被取消，命令没有被执行，因此k4为空</span><br>(nil)<br></code></pre></td></tr></tbody></table></figure>
<p>如果事务中的命令本身有语法错误，比如命令拼写错误，则事务不会执行，即事务中所有命令都不会执行；</p>
<p>如果某条命令执行失败，比如对字符串进行<code>incr</code>操作，则其他命令仍然会被执行，执行错误的命令会抛出异常。</p>
<h2 id="3-2-watch"><a href="#3-2-watch" class="headerlink" title="3.2 watch"></a>3.2 watch</h2><p><code>watch</code>用于监听一个或多个<code>key</code>，如果被监听的<code>key</code>在事务执行之前被其他命令（比如其他线程）改动，则事务不会执行，直接返回失败。（即乐观锁的机制）</p>
<p><code>unwatch</code>取消<code>watch</code>命令对所有<code>key</code>的监视。</p>
<p>事务执行完成后，成功或失败，都会自动解锁。</p>
<h1 id="四、Jedis"><a href="#四、Jedis" class="headerlink" title="四、Jedis"></a>四、Jedis</h1><p>Jedis是Redis官方推荐的Java连接开发工具，即使用Java操作Redis的一个中间件。</p>
<p><strong>1、导入jedis依赖</strong></p>
<p>导入jedis依赖</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/redis.clients/jedis --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>redis.clients<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jedis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.3.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、编写代码测试</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestPing</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//1.new Jedis对象;通过主机名和端口号连接</span><br>        Jedis jedis = <span class="hljs-keyword">new</span> Jedis(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6379</span>);<br>        <span class="hljs-comment">//jedis.auth("123456"); //如果是远程连接，需要验证密码</span><br>        <br>        <span class="hljs-comment">//jedis中的所有命令就是redis的基础指令</span><br>        <span class="hljs-comment">//测试连接，如果输出PONG，说明连接成功</span><br>        System.out.println(jedis.ping());<br>        jedis.close(); <span class="hljs-comment">//关闭连接</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>如果是远程的Redis，需要进行以下配置：</p>
<ul>
<li><p>将redis配置文件的<code>bind 127.0.0.1</code>注释掉，确保外部主机可以访问。</p>
</li>
<li><p><code>protected-mode</code>如果为<code>true</code>，则需要设置访问redis的密码<code>requirepass</code>或<code>bind</code>指定ip，外部网络才可以访问；如果关闭保护模式，则外部网络可以直接访问。</p>
<blockquote>
<p>安全起见，建议开启<code>protected-mode</code>，设置访问密码，并修改默认的端口号。</p>
</blockquote>
</li>
<li><p>确保服务器的防火墙关闭，<code>systemctl status firewalld.service</code>查看防火墙状态。</p>
</li>
<li><p>重启redis服务。</p>
</li>
<li><p>如果设置了密码，需要在Java代码中使用<code>auth()</code>方法验证密码，才能使用Redis数据库。</p>
</li>
</ul>
<p><strong>3、连接成功后，可以使用jedis对象进行操作</strong></p>
<p>方法名和操作Redis的指令名是相同的，比如：</p>
<figure class="highlight q"><table><tbody><tr><td class="code"><pre><code class="hljs q">jedis.<span class="hljs-built_in">keys</span>(<span class="hljs-string">"*"</span>);<br>等价于<br>&gt; <span class="hljs-built_in">keys</span> *<br></code></pre></td></tr></tbody></table></figure>
<p><strong>在Java代码中使用Redis事务</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestTransaction</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//1.new Jedis对象</span><br>        Jedis jedis = <span class="hljs-keyword">new</span> Jedis(<span class="hljs-string">"127.0.0.1"</span>, <span class="hljs-number">6379</span>);<br>        jedis.auth(<span class="hljs-string">"123456"</span>); <span class="hljs-comment">//验证密码</span><br>        Transaction multi = jedis.multi();<span class="hljs-comment">//开启事务</span><br>        <span class="hljs-keyword">try</span>{<br>            multi.set(<span class="hljs-string">"user1"</span>,<span class="hljs-string">"v1"</span>);<br>            multi.set(<span class="hljs-string">"user2"</span>,<span class="hljs-string">"v2"</span>);<br>            <span class="hljs-comment">//int i = 1/0;  //模拟一个java中的异常</span><br>            multi.exec();  <span class="hljs-comment">//执行事务</span><br>        }<span class="hljs-keyword">catch</span> (Exception e){<br>            multi.discard();  <span class="hljs-comment">//在exec()方法执行之前出现了Java代码异常，会放弃事务</span><br>            e.printStackTrace(); <br>        }<span class="hljs-keyword">finally</span> {<br>            jedis.close(); <span class="hljs-comment">//关闭连接</span><br>        }<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这里<code>catch</code>中的异常，只能是捕获Java代码的异常，如果是Redis中的异常不会被捕获。比如，如果对字符串进行<code>incr</code>操作，Java代码并不会抛出异常，只是底层这个Redis语句会返回执行异常，事务中的其他命令仍然会执行。</p>
<h1 id="五、SpringBoot整合Redis"><a href="#五、SpringBoot整合Redis" class="headerlink" title="五、SpringBoot整合Redis"></a>五、SpringBoot整合Redis</h1><h2 id="5-1-环境配置"><a href="#5-1-环境配置" class="headerlink" title="5.1 环境配置"></a>5.1 环境配置</h2><p>在SpringBoot中使用Redis，主要是通过<a href="https://spring.io/projects/spring-data-redis">Spring Data Redis</a></p>
<p>在SpringBoot项目中，可以使用模版自动引入启动器，或者手动引入Spring Data Redis启动器：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>在SpringBoot 2.x版本，底层使用的是lettuce，而不再是Jedis：</p>
<ul>
<li>Jedis：直连，多个线程操作时是不安全的；如果要避免不安全的情况，需要使用jedis pool连接池。更像BIO模式</li>
<li>lettuce：使用netty，实例可以在多个线程中共享，不存在线程不安全的情况。可以减少线程数据，更新NIO模式。</li>
</ul>
<p>根据自动配置类，找到Redis自动配置的源码，并且根据配置类<code>RedisProperties</code>，可以找到配置Redis的前缀为<code>spring.redis</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration(proxyBeanMethods = false)</span><br><span class="hljs-meta">@ConditionalOnClass(RedisOperations.class)</span><br><span class="hljs-meta">@EnableConfigurationProperties(RedisProperties.class)</span><br><span class="hljs-meta">@Import({ LettuceConnectionConfiguration.class, JedisConnectionConfiguration.class })</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisAutoConfiguration</span> </span>{<br><br>    <span class="hljs-comment">//可以自定义redisTemplate来替换这个默认的</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean(name = "redisTemplate")</span>  <br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisTemplate&lt;Object, Object&gt; <span class="hljs-title">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> UnknownHostException </span>{<br>        <span class="hljs-comment">//默认的template没有过多的设置；redis对象都是需要序列化的</span><br>        <span class="hljs-comment">//两个类型都是Object类型，需要根据需求强制类型转换，比如&lt;String,Object&gt;</span><br>        RedisTemplate&lt;Object, Object&gt; template = <span class="hljs-keyword">new</span> RedisTemplate&lt;&gt;();<br>        template.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-keyword">return</span> template;<br>    }<br><br>    <span class="hljs-comment">//由于String类型是最常使用的类型，所以单独定义了一个bean</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-meta">@ConditionalOnMissingBean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> StringRedisTemplate <span class="hljs-title">stringRedisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> UnknownHostException </span>{<br>        StringRedisTemplate template = <span class="hljs-keyword">new</span> StringRedisTemplate();<br>        template.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-keyword">return</span> template;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>在导入依赖后，可以进行配置，然后测试</p>
<p><code>application.properties</code></p>
<figure class="highlight properties"><table><tbody><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 配置redis</span><br><span class="hljs-meta">spring.redis.host</span>=<span class="hljs-string">127.0.0.1</span><br><span class="hljs-meta">spring.redis.port</span>=<span class="hljs-string">6379</span><br><span class="hljs-comment"># 如果有密码，要配置密码</span><br><span class="hljs-meta">spring.redis.password</span>=<span class="hljs-string">123456</span><br></code></pre></td></tr></tbody></table></figure>
<p>测试：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Redis02SprintbootApplicationTests</span> </span>{<br><br>    <span class="hljs-comment">//注入redisTemplate</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">contextLoads</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-comment">/*redisTemplate调用不同的方法操作不同的数据类型</span><br><span class="hljs-comment">        opsForValue 操作字符串，类似String</span><br><span class="hljs-comment">        opsForList 操作List 类似List</span><br><span class="hljs-comment">        常用的方法，可以直接调用方法，比如multi()方法</span><br><span class="hljs-comment">         */</span><br><span class="hljs-comment">//        redisTemplate.opsForValue().set("k1","v1");</span><br><span class="hljs-comment">//        redisTemplate.opsForList().leftPush("k2","v2");</span><br><span class="hljs-comment">//        redisTemplate.multi();</span><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">        获取连接对象</span><br><span class="hljs-comment">        */</span><br><span class="hljs-comment">//        RedisConnection connection = redisTemplate.getConnectionFactory().getConnection();</span><br><span class="hljs-comment">//        connection.flushDb();</span><br>        redisTemplate.opsForValue().set(<span class="hljs-string">"mykey"</span>,<span class="hljs-string">"test"</span>);<br>        System.out.println(redisTemplate.opsForValue().get(<span class="hljs-string">"mykey"</span>));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="5-2-自定义RedisTemplate"><a href="#5-2-自定义RedisTemplate" class="headerlink" title="5.2 自定义RedisTemplate"></a>5.2 自定义RedisTemplate</h2><p>根据Redis自动配置类，我们也可以自定义<code>RedisTemplate</code>，实际开发过程中都是使用自定义的<code>RedisTemplate</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">定义一个配置类，编写自定义的redisTemplate</span><br><span class="hljs-comment">*/</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisConfig</span> </span>{ <br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory redisConnectionFactory)</span></span><br><span class="hljs-function">        <span class="hljs-keyword">throws</span> UnknownHostException </span>{<br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> RedisTemplate&lt;&gt;();<br>        <span class="hljs-comment">//底层默认的是JDK序列化，我们可以配置自定义的序列化方式</span><br>        <span class="hljs-comment">//具体序列化方式根据实际情况确定</span><br>        <span class="hljs-comment">//template.setKeySerializer();</span><br><br>        template.setConnectionFactory(redisConnectionFactory);<br>        <span class="hljs-keyword">return</span> template;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>此外，通常会创建工具类，使用工具类调用<code>RedisTemplate</code>的方法，这样更简洁。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//自定义Redis工具类，将原生的方法封装到这个工具类。</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RedisUtil</span> </span>{<br>    <span class="hljs-comment">//使用自定义的配置类</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">//调用原生的方法，创建工具类方法。这样可以更简洁地调用方法</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取指定key的值</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">get</span><span class="hljs-params">(String key)</span></span>{<br>        <span class="hljs-comment">//工具类中功能调用底层方法</span><br>        <span class="hljs-keyword">return</span> key==<span class="hljs-keyword">null</span> ? <span class="hljs-keyword">null</span>:redisTemplate.opsForValue().get(key);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>然后，我们就可以使用我们定义的工具类实现功能：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Redis02SprintbootApplicationTests</span> </span>{<br>    <span class="hljs-comment">//创建好工具类以后，进行装配</span><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisUtil redisUtil;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">test</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-comment">//调用工具类提供的get方法，更简洁</span><br>        System.out.println(redisUtil.get(<span class="hljs-string">"t1"</span>));<br>        <span class="hljs-comment">//功能上相当于直接调用底层方法</span><br>        System.out.println(redisTemplate.opsForValue().get(<span class="hljs-string">"t1"</span>));<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="六、-Redis配置文件"><a href="#六、-Redis配置文件" class="headerlink" title="六、 Redis配置文件"></a>六、 Redis配置文件</h1><p>Redis安装完以后，配置文件为<code>redis.conf</code>，对其中的内容进行解析。</p>
<p>Redis启动，是通过配置文件来启动的。</p>
<p>配置文件主要有以下部分：</p>
<p><strong>1、UNITS</strong></p>
<p>配置文件对单位的大小写不敏感，比如1GB和1gb相同。</p>
<p><strong>2、INCLUDES</strong></p>
<p>可以包含其他配置文件。如：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">include /path/to/local.conf<br>include /path/to/other.conf<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、NETWORK</strong></p>
<p>可以使用bind来绑定ip，比如：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 绑定指定的ip地址</span><br><span class="hljs-built_in">bind</span> 127.0.0.1  <br></code></pre></td></tr></tbody></table></figure>
<p>保护模式：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># yes表示保护模式开启</span><br>protected-mode yes<br></code></pre></td></tr></tbody></table></figure>
<p>端口设置：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">port 6379<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、GENERAL</strong></p>
<p>是否以守护进程方式启动</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 默认是no</span><br><span class="hljs-comment"># yes表示以守护进程方式运行，即后台运行</span><br>daemonize yes<br></code></pre></td></tr></tbody></table></figure>
<p>配置文件的pid文件保存位置，如果redis以后台方式运行，就需要指定pid文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">pidfile /var/run/redis_6379.pid<br></code></pre></td></tr></tbody></table></figure>
<p>日志：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs propertiesbash"># 有四种日志级别，默认是notice，适用于生产环境<br># This can be one of:<br># debug (a lot of information, useful for development/testing)<br># verbose (many rarely useful info, but not a mess like the debug level)<br># notice (moderately verbose, what you want in production probably)<br># warning (only very important / critical messages are logged)<br>loglevel notice<br></code></pre></td></tr></tbody></table></figure>
<p>生成的日志文件名：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 如果为空，则为标准的输出</span><br>logfile <span class="hljs-string">""</span><br></code></pre></td></tr></tbody></table></figure>
<p>默认的数据库个数：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 默认16个数据库，从0-15</span><br>databases 16<br></code></pre></td></tr></tbody></table></figure>
<p>是否显示启动时的logo：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 默认为开启状态</span><br>always-show-logo yes<br></code></pre></td></tr></tbody></table></figure>
<p><strong>5、SNAPSHOTTING</strong></p>
<p>用于设置持久化<code>rdb</code>的配置。</p>
<p>持久化：在规定的时间内，执行了多少次操作，就会持久化到文件<code>.rdb</code></p>
<p>Redis是内存数据库，如果没有持久化操作，就会断电即失。</p>
<p>设置持久化时间：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 如果下面时间n内，至少m个key被修改，就会进行持久化操作</span><br><span class="hljs-comment"># In the example below the behaviour will be to save:</span><br><span class="hljs-comment"># after 900 sec (15 min) if at least 1 key changed</span><br><span class="hljs-comment"># after 300 sec (5 min) if at least 10 keys changed</span><br><span class="hljs-comment"># after 60 sec if at least 10000 keys changed</span><br>save 900 1<br>save 300 10<br>save 60 10000<br><span class="hljs-comment"># 可以根据需求设置</span><br></code></pre></td></tr></tbody></table></figure>
<p>rdb文件名称：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># The filename where to dump the DB</span><br>dbfilename dump.rdb<br></code></pre></td></tr></tbody></table></figure>
<p>如果bgsave操作失败，是否停止写入硬盘（持久化）：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 默认是yes，即bgsave出错时，停止写入</span><br>stop-writes-on-bgsave-error yes<br></code></pre></td></tr></tbody></table></figure>
<p>是否压缩rdb文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 这个操作需要消耗一定的CPU资源</span><br>rdbcompression yes<br></code></pre></td></tr></tbody></table></figure>
<p>是否校验rdb文件：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 保存rdb文件的时候，进行错误校验检查</span><br>rdbchecksum yes<br></code></pre></td></tr></tbody></table></figure>
<p>持久化（rdb文件）保存的目录：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#　默认是当前目录，即rdb文件保存的目录</span><br>dir ./<br></code></pre></td></tr></tbody></table></figure>
<p><strong>6、REPLICATION</strong></p>
<p>replication是主从复制相关的配置</p>
<p><strong>7、SECURITY</strong></p>
<p>安全相关的配置</p>
<p>设置密码：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置数据库密码为123456</span><br>requirepass 123456<br></code></pre></td></tr></tbody></table></figure>
<p>也可以在命令行设置：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; config <span class="hljs-built_in">set</span> requirepass <span class="hljs-string">"123456"</span><br></code></pre></td></tr></tbody></table></figure>
<p>设置完密码后，需要使用<code>auth</code>进行密码验证才能使用数据库：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; auth 123456<br></code></pre></td></tr></tbody></table></figure>
<p><strong>8、CLIENTS</strong></p>
<p>客户端配置。</p>
<p>限制最大客户端连接数：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置最大连接数为10000</span><br>maxclients 10000<br></code></pre></td></tr></tbody></table></figure>
<p><strong>9、MEMORY MANAGEMENT</strong></p>
<p>Redis的内存配置。</p>
<p>设置最大内存：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置redis的最大内存容量</span><br>maxmemory &lt;bytes&gt;<br></code></pre></td></tr></tbody></table></figure>
<p>内存满时的处理策略：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 默认是noeviction</span><br>maxmemory-policy noeviction<br><span class="hljs-comment"># 一共有以下几种策略：</span><br><span class="hljs-comment"># volatile-lru -&gt; Evict using approximated LRU among the keys with an expire set.</span><br><span class="hljs-comment"># allkeys-lru -&gt; Evict any key using approximated LRU.</span><br><span class="hljs-comment"># volatile-lfu -&gt; Evict using approximated LFU among the keys with an expire set.</span><br><span class="hljs-comment"># allkeys-lfu -&gt; Evict any key using approximated LFU.</span><br><span class="hljs-comment"># volatile-random -&gt; Remove a random key among the ones with an expire set.</span><br><span class="hljs-comment"># allkeys-random -&gt; Remove a random key, any key.</span><br><span class="hljs-comment"># volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL)</span><br><span class="hljs-comment"># noeviction -&gt; Don't evict anything, just return an error on write operations.</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>10、APPEND ONLY MODE</strong></p>
<p>持久化<code>aof</code>配置。</p>
<p>默认不开启aof，而是使用rdb方式持久化：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 默认使用rdb方式持久化，大部分情况下，rdb方式就够用了</span><br>appendonly no<br></code></pre></td></tr></tbody></table></figure>
<p>aof持久化文件的名字：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># rdb文件的后缀名就是rdb</span><br>appendfilename <span class="hljs-string">"appendonly.aof"</span><br></code></pre></td></tr></tbody></table></figure>
<p>同步策略：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># appendfsync always  # 每次修改都会同步，消耗性能</span><br>appendfsync everysec  <span class="hljs-comment"># 每秒同步一次，可能会丢失最后一秒的数据</span><br><span class="hljs-comment"># appendfsync no      # 不执行同步，此时操作系统自己同步数据，速度最快</span><br></code></pre></td></tr></tbody></table></figure>
<h1 id="七、数据持久化"><a href="#七、数据持久化" class="headerlink" title="七、数据持久化"></a>七、数据持久化</h1><p>Redis是一个内存数据库，内存的特征是断电即失，因此Redis的持久化操作是将数据写入硬盘进行持久化。</p>
<p>Redis中的持久化操作有两种方式：<strong>RDB（Redis DataBase）</strong>、<strong>AOF（Append Only File）</strong></p>
<h2 id="7-1-RDB持久化"><a href="#7-1-RDB持久化" class="headerlink" title="7.1 RDB持久化"></a>7.1 RDB持久化</h2><p><strong>RDB(Redis DataBase)方式</strong>也叫<strong>快照(snapshotting)</strong>方式，因为这种方式是通过生成快照进行持久化的。Redis默认的持久化方式就是rdb方式。</p>
<p>RDB方式是通过创建快照来获得存储在内存里面的数据在某个时间点上的副本。Redis 创建快照之后，可以对快照进行备份，可以将快照复制到其他服务器从而创建具有相同数据的服务器副本（Redis 主从结构，主要用来提高 Redis 性能），还可以将快照留在原地以便重启服务器的时候使用。</p>
<p>Redis会单独创建 ( fork )一个子进程来进行持久化，会<strong>先将数据写入到一个临时文件中，待持久化过程结束后，再用这个临时文件替换上次持久化好的文件</strong>（原子性系统调用rename重命名）。整个过程中，主进程是不进行任何IO操作的。这就确保了极高的性能。如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。<strong>RDB的缺点是最后一次持久化后的数据可能丢失。</strong></p>
<blockquote>
<p>如果最后一次修改，还未来得及进行rdb持久化就宕机，则最后一次持久化的数据就会丢失。</p>
</blockquote>
<p>redis配置文件中的<code>SNAPSHOTTING</code>部分，就是关于rdb持久化的配置。其中的<code>save</code>设置：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">save 900 1  <span class="hljs-comment"># 表示如果900秒后，至少有一个key发生了改变，就进行持久化。</span><br>save 300 10<br>save 60 10000<br></code></pre></td></tr></tbody></table></figure>
<p>RDB持久化一般通过<code>bgsave</code>操作创建快照，创建的文件名默认为<code>dump.rdb</code></p>
<blockquote>
<p>RDB持久化有三种保存数据的机制：save、bgsave、自动化。</p>
<p>save方式会阻塞Redis服务器，执行save命令期间，不能执行其他命令，直到RDB过程完成位置。</p>
<p>bgsave（background save），常用的方式，会使用fork子进程的方式</p>
<p>自动化：通过配置文件完成。</p>
</blockquote>
<p>生成<code>.rdb</code>文件的情况：</p>
<ul>
<li>满足<code>save</code>指定的规则</li>
<li>执行<code>flushall</code>命令</li>
<li>退出Redis，也会生成<code>.rdb</code>文件</li>
</ul>
<p>开发中要对<code>dump.rdb</code>文件进行备份，防止误删<code>.rdb</code>文件导致数据无法恢复。</p>
<p><strong>恢复rdb文件</strong></p>
<p>只需要将rdb文件放入Redis的启动目录就可以，Redis启动的时候会自动检查<code>dump.rdb</code>，恢复其中的数据。</p>
<p>查看需要存放的位置：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; config get dir<br>1) <span class="hljs-string">"dir"</span><br>2) <span class="hljs-string">"/usr/local/redis/bin"</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>RDB方式的优缺点</strong></p>
<p>优点</p>
<ul>
<li>适合大规模的数据恢复。</li>
</ul>
<p>缺点：</p>
<ul>
<li>需要一定的时间间隔来生成快照，如果没有到时间间隔系统宕机，则最后一段时间内的数据未被持久化导致数据丢失。</li>
<li>fork进程的时候，会占用一定的内存空间。fork操作会对主进程进行阻塞（只是fork时会阻塞，fork完成后的子进程操作不会影响主进程），影响主进程读写。</li>
<li>RDB是对完整的数据进行持久化，如果数据量较大，fork操作会消耗比较大的资源。</li>
</ul>
<h2 id="7-2-AOF持久化"><a href="#7-2-AOF持久化" class="headerlink" title="7.2 AOF持久化"></a>7.2 AOF持久化</h2><p>AOF（Append Only File），只追加文件。</p>
<p>RDB方式是的持久化数据库所有数据，而AOF方式是追加日志。AOF是将所有命令都记录下来，恢复的时候把这个文件记录的命令再执行一遍。</p>
<p>与RDB方式相比，<strong>AOF的实时性更好</strong>，开启 AOF 持久化后<strong>每执行一条会更改 Redis 中的数据的命令，Redis 就会将该命令写入硬盘中的 AOF 文件</strong>。Redis也会fork一个子进程用于追加日志文件，重启后，会读取AOF文件根据指令<strong>重新构建数据。</strong></p>
<blockquote>
<p>只记录写操作，不记录读操作。</p>
<p>只追加文件，不改写文件</p>
</blockquote>
<p>AOF的配置在Redis配置文件的<code>APPEND ONLY MODE</code>部分。AOF 文件的保存位置和 RDB 文件的位置相同，都是通过<code>dir</code>参数设置的，默认的文件名是<code>appendonly.aof</code>。AOF默认是关闭的，需要手动开启。</p>
<p>Redis提供了三种AOF同步策略：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># appendfsync always  # 每次修改都会同步，消耗性能</span><br>appendfsync everysec  <span class="hljs-comment"># 每秒同步一次，但可能会丢失最后一秒的数据</span><br><span class="hljs-comment"># appendfsync no      # 不执行同步，此时操作系统自己同步数据，速度最快</span><br></code></pre></td></tr></tbody></table></figure>
<p>兼顾性能和数据，可以选用<code>everysec</code>方式，每秒同步一次，这样最多只会丢失一秒的数据。</p>
<p><code>appendonly.aof</code>文件的内容是记录的写入指令，可以被人为破坏。如果<code>.aof</code>文件有错误，会导致Redis启动失败。可以使用<code>redis-check-aof</code>对其进行修复：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 执行redis-check-aof修复aof文件</span><br>./redis-check-aof --fix appendonly.aof<br></code></pre></td></tr></tbody></table></figure>
<p><strong>重写规则</strong></p>
<p>由于AOF是增量持久化方式，因此AOF文件会不断增大，这时候需要使用重写对其进行瘦身。</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">no-appendfsync-on-rewrite no<br><span class="hljs-comment"># Automatic rewrite of the append only file.</span><br><span class="hljs-comment"># Redis is able to automatically rewrite the log file implicitly calling</span><br><span class="hljs-comment"># BGREWRITEAOF when the AOF log size grows by the specified percentage.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This is how it works: Redis remembers the size of the AOF file after the</span><br><span class="hljs-comment"># latest rewrite (if no rewrite has happened since the restart, the size of</span><br><span class="hljs-comment"># the AOF at startup is used).</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># This base size is compared to the current size. If the current size is</span><br><span class="hljs-comment"># bigger than the specified percentage, the rewrite is triggered. Also</span><br><span class="hljs-comment"># you need to specify a minimal size for the AOF file to be rewritten, this</span><br><span class="hljs-comment"># is useful to avoid rewriting the AOF file even if the percentage increase</span><br><span class="hljs-comment"># is reached but it is still pretty small.</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Specify a percentage of zero in order to disable the automatic AOF</span><br><span class="hljs-comment"># rewrite feature.</span><br>auto-aof-rewrite-percentage 100<br>auto-aof-rewrite-min-size 64mb<br><span class="hljs-comment"># 当文件大小大于当前文件的100%且文件大小至少是64MB时，才会触发重写机制。</span><br></code></pre></td></tr></tbody></table></figure>
<p>AOF 重写可以产生一个新的 AOF 文件，这个新的 AOF 文件和原有的 AOF 文件所保存的数据库状态一样，但体积更小。AOF是通过读取数据库中的键值对来实现的，程序无须对现有 AOF 文件进行任何读入、分析或者写入操作。</p>
<blockquote>
<p><strong>AOF Rewrite</strong> 虽然是“压缩”AOF文件的过程，但并非采用“基于原AOF文件”来重写或压缩，而是采取了类似RDB快照的方式：基于Copy On Write，全量遍历内存中数据，然后逐个序列到AOF文件中。因此AOF rewrite能够正确反应当前内存数据的状态。</p>
</blockquote>
<p><strong>AOF持久化流程</strong></p>
<p>在执行 BGREWRITEAOF 命令时，Redis 服务器会维护一个 AOF 重写缓冲区，该缓冲区会在子进程创建新 AOF 文件期间，记录服务器执行的所有写命令。当子进程完成创建新 AOF 文件的工作之后，服务器会将重写缓冲区中的所有内容追加到新 AOF 文件的末尾，使得新旧两个 AOF 文件所保存的数据库状态一致。最后，服务器用新的 AOF 文件替换旧的 AOF 文件，以此来完成 AOF 文件重写操作.</p>
<p><strong>AOF的优缺点</strong></p>
<p>优点：</p>
<ul>
<li>可以每次修改都同步、每秒同步一次、从不同步三种同步策略。数据完整性从高变低，而效率从低变高。</li>
</ul>
<p>缺点：</p>
<ul>
<li>相对于RDB方式来说，AOF恢复数据慢，因为其要重新执行一遍指令重构数据。</li>
<li>AOF是文本文件，体积较大，需要不断进行AOF重写，进行瘦身。</li>
</ul>
<p><strong>Redis 4.0 对于持久化机制的优化</strong></p>
<p>Redis 4.0 开始支持 RDB 和 AOF 的混合持久化（默认关闭，可以通过配置项 <code>aof-use-rdb-preamble</code> 开启）。</p>
<p>如果把混合持久化打开，AOF 重写的时候就直接把 RDB 的内容写到 AOF 文件开头。这样做的好处是可以结合 RDB 和 AOF 的优点, 快速加载同时避免丢失过多的数据。缺点是 AOF 里面的 RDB 部分是压缩格式不再是 AOF 格式，可读性较差。</p>
<h1 id="八、数据删除与淘汰"><a href="#八、数据删除与淘汰" class="headerlink" title="八、数据删除与淘汰"></a>八、数据删除与淘汰</h1><h2 id="8-1-数据过期时间"><a href="#8-1-数据过期时间" class="headerlink" title="8.1 数据过期时间"></a>8.1 数据过期时间</h2><p>Redis是内存数据库，而内存是有限的，如果缓存中的所有数据都一直保存的话，很容易导致内存溢出。因此需要对数据设置过期时间。此外，一些场景中的数据本身就只需要存活一段时间，比如验证码，通过设置过期时间，可以省略多余的判断操作。</p>
<p><strong>设置过期时间</strong></p>
<p>string类型有自带的创建带有过期时间的指令：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">setex key 60 value  <span class="hljs-comment"># 设置key为60s后过期</span><br></code></pre></td></tr></tbody></table></figure>
<p>通用的设置过期时间的指令是<code>expire</code>，使用<code>persist</code>指令可以移除一个键的过期时间：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">expire name 10  <span class="hljs-comment"># 将name这个key设置为10秒后过期，10s后就会被销毁</span><br></code></pre></td></tr></tbody></table></figure>
<p>查看某个key的剩余存活时间</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">ttl name  <span class="hljs-comment"># 查看name的剩余存活时间,-1表示永久有效</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>Redis是如何判断数据是否过期的？</strong></p>
<p><a href="https://snailclimb.gitee.io/javaguide/#/docs/database/Redis/redis-all?id=_11-redis-%e6%98%af%e5%a6%82%e4%bd%95%e5%88%a4%e6%96%ad%e6%95%b0%e6%8d%ae%e6%98%af%e5%90%a6%e8%bf%87%e6%9c%9f%e7%9a%84%e5%91%a2%ef%bc%9f">Redis如何判断数据是否过期</a></p>
<p>Redis 通过<strong>过期字典</strong>（可以看作是 hash 表）来保存数据过期的时间。过期字典的键指向Redis中的某个 key，过期字典的值是一个 long long 类型的整数，这个整数保存了 key 所指向的数据库键的过期时间（毫秒精度的 UNIX 时间戳）。</p>
<p>过期字典是存储在<code>redisDb</code>这个结构里的：</p>
<figure class="highlight c"><table><tbody><tr><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">redisDb</span> {</span><br>    ...<br>    dict *dict;     <span class="hljs-comment">// 数据库键字典,保存着数据库中所有键值对</span><br>    dict *expires   <span class="hljs-comment">// 过期字典,保存着键的过期时间</span><br>    ...<br>} redisDb;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="8-2-过期数据删除"><a href="#8-2-过期数据删除" class="headerlink" title="8.2 过期数据删除"></a>8.2 过期数据删除</h2><p>对于过期的数据，Redis有三种删除策略：立即删除、惰性删除、定期删除。</p>
<p><strong>1、立即删除</strong></p>
<p>在设置键的过期时间时，创建一个回调事件，当过期时间达到时，由时间处理器自动执行键的删除操作。</p>
<p>优点：</p>
<ul>
<li>立即删除能保证内存中数据的最大新鲜度，因为它<strong>保证过期键值会在过期后马上被删除，其所占用的内存也会随之释放</strong>。</li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>立即删除对cpu是最不友好的</strong>。因为删除操作会占用cpu的时间，如果刚好碰上了cpu很忙的时候，比如正在做交集或排序等计算的时候，就会给cpu造成额外的压力。</li>
</ul>
<p>redis事件处理器对时间事件的处理方式是无序链表，查找一个key的时间复杂度为O(n)，所以并不适合用来处理大量的时间事件。</p>
<p><strong>2、惰性删除</strong> </p>
<p>只会在取出 key 的时候才对数据进行过期检查。这样对 CPU 最友好，但是可能会造成太多过期 key 没有被删除。</p>
<p>优点：</p>
<ul>
<li>key被使用的时候才会检查是否过期。<strong>对 CPU 最友好。</strong></li>
</ul>
<p>缺点：</p>
<ul>
<li><strong>浪费内存</strong>。比如某些数据在过期后可能很长一段时间内不会被访问（比如日志数据），但是这段时间dict字典和expires字典都要保存这个键值的信息，会浪费很多空间，对于依赖内存大小的Redis来说这个确定是致命的。</li>
</ul>
<p><strong>3、定期删除</strong> ： 每隔一段时间抽取一批 key 执行删除过期 key 操作。并且，Redis 底层会通过限制删除操作执行的时长和频率来减少删除操作对 CPU 时间的影响。</p>
<p>优点：</p>
<ul>
<li>对CPU比较友好，优势介于立即删除和惰性删除之间。</li>
<li>另一方面，减少了因惰性删除带来的内存浪费。</li>
</ul>
<p>Redis 采用的是 <strong>定期删除+惰性/懒汉式删除</strong> 。</p>
<p>但是，仅仅通过给 key 设置过期时间还是有问题的。因为还是可能存在定期删除和惰性删除漏掉了很多过期 key 的情况。这样就导致大量过期 key 堆积在内存里，同样会导致OOM。解决方法就是通过Redis的内存淘汰机制。</p>
<h2 id="8-3-内存淘汰机制"><a href="#8-3-内存淘汰机制" class="headerlink" title="8.3 内存淘汰机制"></a>8.3 内存淘汰机制</h2><p>当内存满的时候，Redis可以通过内存淘汰策略，将选中的数据淘汰。Redis一共有8种淘汰策略：</p>
<ul>
<li><strong>volatile-lru</strong>：从<strong>设置过期时间的数据集中</strong>挑选出最近最少使用（LRU）的数据淘汰。</li>
<li><strong>allkeys-lru</strong> ：从数据集中挑选出最近最少使用（LRU）的数据淘汰。</li>
<li><strong>volatile-lfu</strong> ：从<strong>设置过期时间的数据集中</strong>挑选出最近最不常使用（LFU）的数据淘汰。</li>
<li><strong>allkeys-lfu</strong> ：从的数据集中挑选出最近最不常使用的数据淘汰。</li>
<li><strong>volatile-random</strong> ：从<strong>设置过期时间的数据集中</strong>随机挑选数据淘汰。</li>
<li><strong>allkeys-random</strong>：从数据集中随机挑选数据淘汰。</li>
<li><strong>volatile-ttl</strong>：从<strong>设置过期时间的数据集中</strong>挑选最近要过期的数据淘汰。</li>
<li><strong>noeviction</strong> ：禁止淘汰数据，当内存不足以容纳新写入数据时，新写入操作会报错。</li>
</ul>
<blockquote>
<p>其中LFU是Redis 4.0版本新增的淘汰策略。</p>
</blockquote>
<h1 id="九、Redis发布订阅"><a href="#九、Redis发布订阅" class="headerlink" title="九、Redis发布订阅"></a>九、Redis发布订阅</h1><h2 id="9-1-介绍"><a href="#9-1-介绍" class="headerlink" title="9.1 介绍"></a>9.1 介绍</h2><p>Redis的发布订阅（pub/sub）是一种消息通信模式：<strong>发送者</strong>（pub）发送消息，<strong>订阅者</strong>（sub）接收消息。传递消息的通道称为<strong>频道</strong>（channel）。</p>
<p>订阅者可以订阅任意数量的频道。</p>
<p>当发送者通过PUBLISH命令将新消息发送给频道时，这个消息就会被发送给订阅这个频道的n个订阅者。</p>
<p>发布订阅常用的命令：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">psubscribe</td>
<td style="text-align:left">订阅一个或多个符合给定模式的频道。</td>
</tr>
<tr>
<td style="text-align:left">pubsub</td>
<td style="text-align:left">查看订阅与发布系统状态。</td>
</tr>
<tr>
<td style="text-align:left">publish</td>
<td style="text-align:left">将信息发送到指定的频道。</td>
</tr>
<tr>
<td style="text-align:left">punsubscribe</td>
<td style="text-align:left">退订所有给定模式的频道。</td>
</tr>
<tr>
<td style="text-align:left">subscribe</td>
<td style="text-align:left">订阅给定的一个或多个频道的信息。</td>
</tr>
<tr>
<td style="text-align:left">unsubscribe</td>
<td style="text-align:left">指退订给定的频道。</td>
</tr>
</tbody>
</table>
</div>
<p><strong>使用案例</strong></p>
<p>订阅者订阅频道：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; subscribe pubTest<br>Reading messages... (press Ctrl-C to quit)<br>1) <span class="hljs-string">"subscribe"</span><br>2) <span class="hljs-string">"pubTest"</span><br>3) (<span class="hljs-built_in">integer</span>) 1<br></code></pre></td></tr></tbody></table></figure>
<p>发布者往频道内发布消息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; publish pubTest <span class="hljs-string">"hello,world"</span><br>(<span class="hljs-built_in">integer</span>) 1  <span class="hljs-comment"># 表示有1个客户端收到</span><br></code></pre></td></tr></tbody></table></figure>
<p>此时的订阅者能够收到消息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; subscribe pubTest<br>Reading messages... (press Ctrl-C to quit)<br>1) <span class="hljs-string">"subscribe"</span><br>2) <span class="hljs-string">"pubTest"</span><br>3) (<span class="hljs-built_in">integer</span>) 1<br>1) <span class="hljs-string">"message"</span>  <span class="hljs-comment"># 收到message</span><br>2) <span class="hljs-string">"pubTest"</span>  <span class="hljs-comment"># 来自频道pubTest</span><br>3) <span class="hljs-string">"hello,world"</span>  <span class="hljs-comment"># 消息内容为"hello,world"</span><br></code></pre></td></tr></tbody></table></figure>
<p>Redis中的订阅功能最明显的用途就是用作<strong>实时消息系统</strong>，比如普通的即时聊天，群聊等功能。</p>
<h2 id="9-2-pub-sub原理"><a href="#9-2-pub-sub原理" class="headerlink" title="9.2 pub/sub原理"></a>9.2 pub/sub原理</h2><p><strong>subscribe命令</strong></p>
<p>通过<code>SUBSCRIBE</code>命令订阅某频道后，redis-server里会维护一个字典，字典的键代表channel，字典的是一个链表，链表中保存了所有订阅这个channel的客户端。<code>SUBSCRIBE</code>命令的关键，就是将客户端添加到给定 channel 的订阅链表中。</p>
<p><strong>publish命令</strong></p>
<p>通过<code>PUBLISH</code>命令向订阅者发送消息，redis-server会使用给定的频道作为键，在它所维护的 channel 字典中查找记录了订阅这个频道的所有客户端的链表，遍历这个链表，将消息发布给所有订阅者。</p>
<h1 id="十、Redis主从复制"><a href="#十、Redis主从复制" class="headerlink" title="十、Redis主从复制"></a>十、Redis主从复制</h1><h2 id="10-1-介绍"><a href="#10-1-介绍" class="headerlink" title="10.1 介绍"></a>10.1 介绍</h2><p>主从复制：将一台Redis服务器的数据，复制到其他的Redis服务器，前者称为主节点（master/leader），后者称为从节点（slaver/follower)。</p>
<p>数据的复制是单向的，只能由主节点到从节点。master以写为主，slaver以读为主。默认情况下每个服务器都是主节点，一个主节点可以由多个从节点，而一个从节点只能有一个主节点。</p>
<p><strong>主从复制的作用</strong>：</p>
<ul>
<li>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。</li>
<li>故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。</li>
<li>负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写Redis数据时应用连接主节点，读Redis数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高Redis服务器的并发量。</li>
<li>高可用（集群）基石：主从复制是哨兵和集群能够实施的基础，是Redis高可用的基础。</li>
</ul>
<h2 id="10-2-环境配置"><a href="#10-2-环境配置" class="headerlink" title="10.2 环境配置"></a>10.2 环境配置</h2><p>查看当前库信息：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 使用info命令查看信息</span><br>127.0.0.1:6379&gt; info replication <br><span class="hljs-comment"># Replication</span><br>role:master  <span class="hljs-comment"># 角色：master</span><br>connected_slaves:0  <span class="hljs-comment"># 从机个数：0</span><br>master_replid:0fae2ec2d0ed428e4a08a46f126d426e70f45601<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:0<br>second_repl_offset:-1<br>repl_backlog_active:0<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:0<br>repl_backlog_histlen:0<br></code></pre></td></tr></tbody></table></figure>
<p>在一台服务器上通过创建多个配置文件，模拟多个Redis主机：</p>
<ul>
<li>修改端口号</li>
<li>修改pid文件名</li>
<li>修改日志文件名</li>
<li>修改<code>dump.rdb</code>文件名</li>
</ul>
<p>在单机上，通过不同端口，模拟一主二从的配置。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/redis_3.png"><span class="image-caption">两个配置文件，用来启动不同端口的Redis服务</span></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/redis_4.png"><span class="image-caption">多个Redis服务</span></p>
<p>Redis主从复制遵循<strong>配从不配主</strong>的原则，只对从机进行配置。</p>
<p>在从机客户端使用<code>slaveof</code>命令指定其主机地址：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 设置其从机地址</span><br>127.0.0.1:6380&gt; slaveof 127.0.0.1 6379<br><span class="hljs-comment"># 查看此时的状态，已经变为了从机</span><br>127.0.0.1:6380&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:slave  <span class="hljs-comment"># 当前角色：从机</span><br>master_host:127.0.0.1   <span class="hljs-comment"># 主机地址</span><br>master_port:6379<br>master_link_status:up  <span class="hljs-comment"># 主机连接状态</span><br>master_last_io_seconds_ago:2<br>master_sync_in_progress:0<br>slave_repl_offset:42<br>slave_priority:100<br>slave_read_only:1<br>connected_slaves:0<br>master_replid:e93e4bf39bf9973a62074e0d6a8e40f4babc71ed<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:42<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:29<br>repl_backlog_histlen:14<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>Redis 5.0之前的版本使用<code>slaveof</code>，5.0之后的版本可以使用<code>replicaof</code>命令。</p>
</blockquote>
<p>使用命令行配置从机的方式是一次性的，重启服务就失效了。如果要永久生效，需要在配置文件中配置<code>replicaof</code>选项，这样每次启动时会自动被设置为从机，这种方式是常用的方式：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 配置主机地址和端口号</span><br>replicaof 127.0.0.1 6379<br></code></pre></td></tr></tbody></table></figure>
<p>如果主机设置了密码，会导致<code>master_link_status</code>这一项结果为<code>down</code>，需要在从机的配置文件中设置<code>masterauth</code>添加主机密码：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 指定主机密码</span><br>masterauth 123456<br></code></pre></td></tr></tbody></table></figure>
<p>两个从机都设置好后，我们可以在主机客户端看到已连接的从机：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6379&gt; info replication<br><span class="hljs-comment"># Replication</span><br>role:master<br>connected_slaves:2  <span class="hljs-comment"># 有两个从机，然后是从机的详细信息</span><br>slave0:ip=127.0.0.1,port=6381,state=online,offset=42,lag=0<br>slave1:ip=127.0.0.1,port=6380,state=online,offset=42,lag=1<br>master_replid:e93e4bf39bf9973a62074e0d6a8e40f4babc71ed<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:42<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:42<br></code></pre></td></tr></tbody></table></figure>
<p>简单的主从复制模型就配置好了。</p>
<h2 id="10-3-主从复制测试"><a href="#10-3-主从复制测试" class="headerlink" title="10.3 主从复制测试"></a>10.3 主从复制测试</h2><p>主机中的所有信息和数据，都会自动被从机保存。</p>
<p>默认情况下，从机是只读复制模式，即从机只能读，不能写。</p>
<p>在只读复制模式下，从机写入数据，会失败：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">127.0.0.1:6380&gt; <span class="hljs-built_in">set</span> t1 v1<br>(error) READONLY You can<span class="hljs-string">'t write against a read only replica.</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>测试1、主机写入数据，从机会自动保存数据，可以读取</strong></p>
<p><strong>测试2、如果主机宕机再重连以后，从机同样能够保存新写入的数据</strong></p>
<p><strong>测试3、如果从机宕机，如果重启后仍然是之前主机的从机，那么仍然可以获取到主机的数据</strong></p>
<p>如果从机使用配置文件配置的主机地址，那么从机重启后仍然是从机，仍然可以获取到主机的数据。</p>
<h2 id="10-4-复制原理"><a href="#10-4-复制原理" class="headerlink" title="10.4 复制原理"></a>10.4 复制原理</h2><p>从机和主机的数据会保持一致，无论是哪一方宕机，重启后仍然能够同步数据，其复制原理如下：</p>
<ul>
<li>Slave启动成功连接到Master后会发送一个<code>sync</code>同步命令。</li>
<li>Master接到命令，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，master将传送整个数据文件到slave，并完成一次完全同步。</li>
</ul>
<p>复制方式有两种：</p>
<ul>
<li><strong>全量复制：</strong>而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。</li>
<li><strong>增量复制：</strong>Master继续将新的所有收集到的修改命令依次传给slave，完成同步</li>
</ul>
<p>每次重新连接master，都会自动执行一次完全同步（全量复制）。因此即使从机宕机，重连以后也能同步到主机的数据。</p>
<h2 id="10-5-链路模式"><a href="#10-5-链路模式" class="headerlink" title="10.5 链路模式"></a>10.5 链路模式</h2><p>上述模式是一主机多从机的模式，主机和从机是一对多的关系。</p>
<p>还有一种主从复制是链路模式，主机和从机是一对一的关系，每个从机又有其自己的从机，层层相连。中间的从机既是主机，又是从机。</p>
<p>最顶端的主机写数据，后面的所有从机都能同步到数据。</p>
<h1 id="十一、哨兵模式"><a href="#十一、哨兵模式" class="headerlink" title="十一、哨兵模式"></a>十一、哨兵模式</h1><p>哨兵模式实现了自动主从切换。</p>
<h2 id="11-1-哨兵的作用"><a href="#11-1-哨兵的作用" class="headerlink" title="11.1 哨兵的作用"></a>11.1 哨兵的作用</h2><p>如果主机宕机，需要选用其中一个从机当作主机。使用<code>slaveof no one</code>命令，使当前从机变回主机。然后其他从机就可以连接到这个从机。在没有哨兵模式之前，上述操作是手动完成的。</p>
<p>Redis从2.8版本提供了Sentinel架构（哨兵模式）自动解决上述问题，哨兵模式能够自动剩余的从机中选出一个当作主机。</p>
<p><strong>哨兵模式</strong>是一种特殊的模式，Redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是<strong>哨兵通过发送命令，等待Redis服务器响应，从而监控运行的多个Redis实例。</strong></p>
<p>实际情况中， 我们通常会设置多个哨兵，多个哨兵之间互相监督，防止单一哨兵出现问题时无法及时主从切换。</p>
<p><strong>多哨兵模式，基本原理如下：</strong></p>
<p>正常情况下，哨兵会向master发送心跳ping来确认Master是否存活。</p>
<p>假设主服务器宕机，master会不回应PONG或者回复错误值，哨兵1先检测到这个结果，系统并不会马上进行<code>failover</code>过程，仅仅是哨兵1主观的认为主服务器不可用，即<strong>主观下线</strong>（Subjectively Down，SDOWN）。</p>
<p>当其他哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行<strong>failover（故障转移）</strong>操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，即<strong>客观下线</strong>（Objectively Down，ODOWN）。</p>
<blockquote>
<p>客观下线才是真正的进行主从切换。</p>
</blockquote>
<h2 id="11-2-创建哨兵"><a href="#11-2-创建哨兵" class="headerlink" title="11.2 创建哨兵"></a>11.2 创建哨兵</h2><p>以一个哨兵为例，每一个哨兵都需要一个自己的配置文件：</p>
<p><code>sentinel.conf</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#格式：sentinel monitor &lt;option_name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span><br>sentinel monitor T1 127.0.0.1 6379 1<br></code></pre></td></tr></tbody></table></figure>
<p>上述是最基础的哨兵配置。监控的master的名字叫做T1（自定义），地址为127.0.0.1:6379，行尾最后的数字1表示在sentinel集群中，至少有多少个哨兵认为masters挂掉了，才能真正认为该master不可用了，开始选举从机作为主机。</p>
<p>如果主机设置了密码，客户端和从机在连接时都需要提供密码。master通过<code>requirepass</code>设置自身的密码，slave通过<code>masterauth</code>来设置访问master时的密码。客户端需要<code>auth</code>提供密码。</p>
<p>但是当使用了sentinel时，由于一个master可能会变成一个slave，一个slave也可能会变成master，所以需要同时设置上述两个配置项，即同时配置<code>requirepass</code>和<code>masterauth</code>，并且哨兵需要连接master和slave，也必须设置参数：<code>sentinel auth-pass &lt;master_name&gt; xxxxx</code>。</p>
<p>配置好哨兵的配置文件以后，就可以执行<code>redis-sentinel</code>，并指定配置文件，启动指定的哨兵进程:</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/redis_5.png"><span class="image-caption">启动哨兵</span></p>
<p>手动将主机<code>shutdown</code>掉，哨兵检测到主机宕机，会投票选出新的主机节点：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/redis_6.png"><span class="image-caption">执行了主从转换</span></p>
<p>一个一主二从一哨兵的架构就搭建好了，通常情况下，我们不会使用单个哨兵，而是使用多个哨兵组成哨兵集群。如果是哨兵集群，则需要配置多个哨兵配置文件，并且每个哨兵都需要配置自己的端口。详细的哨兵配置，参考<a href="https://www.cnblogs.com/happydreamzjl/p/11322937.html">Redis哨兵机制</a></p>
<p>如果主机重新连接回来，只能归并到新的主机下，当作新的主机的从机。</p>
<p>关于哨兵的底层原理，可以参考<a href="https://www.cnblogs.com/myd620/p/7811156.html">哨兵选举底层原理</a></p>
<h2 id="11-3-哨兵模式总结"><a href="#11-3-哨兵模式总结" class="headerlink" title="11.3 哨兵模式总结"></a>11.3 哨兵模式总结</h2><p><strong>优缺点</strong></p>
<p>优点：</p>
<ul>
<li>基于主从复制原理，用于主从复制的优点。</li>
<li>主从可以切换，故障可以转移，系统的可用性更好。</li>
<li>哨兵模式就是主从模式的升级，从手动主从切换到自动主从切换。</li>
</ul>
<p>缺点：</p>
<ul>
<li>redis较难支持在线扩容，如果集群容量到达上限，在线扩容很复杂。</li>
<li>实现哨兵集群的配置选择项很多，不容易配置。</li>
</ul>
<h1 id="十二、缓存穿透、缓存击穿、缓存雪崩"><a href="#十二、缓存穿透、缓存击穿、缓存雪崩" class="headerlink" title="十二、缓存穿透、缓存击穿、缓存雪崩"></a>十二、缓存穿透、缓存击穿、缓存雪崩</h1><h2 id="12-1-缓存穿透"><a href="#12-1-缓存穿透" class="headerlink" title="12.1 缓存穿透"></a>12.1 缓存穿透</h2><p><strong>缓存穿透的概念</strong></p>
<p>用户查询一个redis缓存中没有的数据，并且数据库中也没有，因此每次都会到持久层中查询数据库，因为数据库中没有，最终查询失败。当用户很多，这种不存在的数据查询量很大的时候，都去请求持久层，给持久层数据库造成了很大的压力，导致失去了缓存保护后端数据库的意义，相当于穿透了缓存。</p>
<p><strong>解决方法</strong></p>
<p><strong>1、缓存空对象</strong></p>
<p>如果不存在此key，则在缓存中为这个key设置一个空值，这样每次查询就会直接从缓冲中返回空值。</p>
<p>但是这种方法存在两个问题：</p>
<ul>
<li>值为<code>null</code>不代表不占用内存空间，空值做了缓存，意味着缓存层中存了更多的键，需要更多的内存空间，因此会造成一定程度上的空间浪费。比较有效的方法是针对这类数据<strong>设置一个较短的过期时间，让其自动剔除</strong>。</li>
<li><strong>缓存和数据库的数据会有一段时间数据不一致</strong>，这可能会对业务有一定影响。例如过期时间设置为5分钟，如果此时数据库中添加了这个数据，那此段时间就会出现缓存和数据库中数据不一致的情况，此时可以利用消息系统或者其他方式清除掉缓存层中的空对象。</li>
</ul>
<p><strong>2、布隆过滤器</strong></p>
<p>在访问缓存和持久层之前，将存在的key用布隆过滤器提前保存起来，做第一层拦截，当收到一个对key请求时先用布隆过滤器验证是key否存在，如果存在才会进入缓存、持久层。否则就直接返回。</p>
<p>布隆过滤器是一个bit向量或者说bit数组，其基本原理是事先将所有可能查询的key映射到这个数组，是使用多个不同的哈希函数对插入的对象进行hash操作并生成多个哈希值，将每个生成的哈希值指向的bit位置置为1。当用户查询的时候，会查找多个哈希值对于位置的值是否为1，如果这多个位置上的值都是1，说明这个值<strong>可能存在</strong>，<strong>否则一定不存在</strong>。</p>
<blockquote>
<p>布隆过滤器只能判断可能存在，并不能确定一定会存在，但是能够判断一定不存在的情况。</p>
<p>参考：<a href="https://zhuanlan.zhihu.com/p/43263751">详解布隆过滤器原理</a></p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/redis_7.jpg"><span class="image-caption">布隆过滤器</span></p>
<h2 id="12-2-缓存击穿"><a href="#12-2-缓存击穿" class="headerlink" title="12.2 缓存击穿"></a>12.2 缓存击穿</h2><p><strong>缓存击穿的概念</strong></p>
<p>与缓存穿透不同的是，缓存击穿指的是<strong>某一时刻某一个热点数据失效</strong>，对应的大量请求涌入数据库，造成数据库压力过大。</p>
<p>比如微博某一热点数据设置了过期时间，导致过期后到重新创建的这一小段时间内热点数据短暂失效，在这段时间内大量对于这一数据的查询请求会直接访问数据库，导致数据库压力过大，好比缓存被击穿。</p>
<p><strong>解决方案</strong></p>
<p><strong>1、设置热点数据永不过期</strong></p>
<p>从缓存层面来看，没有设置过期时间，所以不会出现热点 key过期后产生的问题。但是会存在数据不一致的情况。</p>
<p><strong>2、分布式互斥锁</strong></p>
<p>使用分布式锁，保证对于每个key同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。</p>
<h2 id="12-3-缓存雪崩"><a href="#12-3-缓存雪崩" class="headerlink" title="12.3 缓存雪崩"></a>12.3 缓存雪崩</h2><p><strong>缓存雪崩概念</strong></p>
<p>缓存雪崩指的是<strong>缓存在同一时间大面积的失效，后面的请求都直接落到了数据库上</strong>，造成数据库短时间内承受大量请求。就像雪崩一样。</p>
<p>造成缓存雪崩有两种情况：一种是因为缓存模块本身的故障，比如宕机，导致原本应该访问缓存的请求都去访问了数据库；另一种造成缓存雪崩的情况是大量热点数据在某一时刻大面积失效，导致对应的请求落到了数据库上。</p>
<p><strong>解决方案</strong></p>
<p>针对Redis服务不可用的情况（情况一）：</p>
<ul>
<li><strong>使用redis集群</strong>。采用Redis集群，避免单机出现问题整个缓存服务都不可用。（比如异地多活)</li>
<li><strong>限流降级</strong>。限流，避免同时处理大量的请求，设置最高的QPS阈值，当请求数超过这个阈值后，就不再调用后续资源。降级，指的是服务器压力剧增的情况下，根据业务情况，对一些服务和页面进行有策略的降级，以此释放服务器资源保证核心任务的正常运行。</li>
</ul>
<p>针对Redis服务可用的情况（情况二）：</p>
<ul>
<li><strong>设置不同的失效时间</strong>，比如随机设置缓存的失效时间。或者设置缓存永不失效。</li>
<li><strong>数据预热</strong>。在正式部署之前，先将可能的数据预先访问一遍，使那些可能大量访问的数据预先加载到缓存中。</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.bilibili.com/video/BV1S54y1R7SB">Redis教程</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>SQL</tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL数据库基础篇</title>
    <url>/2021/04/26/mysql-basis/</url>
    <content><![CDATA[<h1 id="一、数据库概述"><a href="#一、数据库概述" class="headerlink" title="一、数据库概述"></a>一、数据库概述</h1><h2 id="1、使用数据库的优势"><a href="#1、使用数据库的优势" class="headerlink" title="1、使用数据库的优势"></a>1、使用数据库的优势</h2><p>使用数据库有两个优势：</p>
<ul>
<li>持久化数据到本地。</li>
<li>可以实现结构化查询，方便管理。</li>
</ul>
<h2 id="2、数据库相关概念"><a href="#2、数据库相关概念" class="headerlink" title="2、数据库相关概念"></a>2、数据库相关概念</h2><p><strong>DB(Database)</strong>：数据库，保存一组有组织的数据的容器。</p>
<p><strong>DBMS(Database Management System)</strong>：数据库管理系统，又称为数据库软件（产品），用于管理DB中的数据。</p>
<p><strong>SQL(Structured Query Language)</strong>：结构化查询语言，用于和DBMS通信的语言，包括数据插入、查询、更新、删除，数据库模式创建和修改，以及数据访问控制。</p>
<h2 id="3、SQL的语言分类"><a href="#3、SQL的语言分类" class="headerlink" title="3、SQL的语言分类"></a>3、SQL的语言分类</h2><p><strong>DDL(Data Definition Language)</strong>：数据定义语言。允许用户<strong>定义</strong>数据，包括创建（create）、删除（drop）、修改（alter）这些操作。通常，DDL由数据库管理员执行。</p>
<p><strong>DML(Data Manipulation Language</strong>)：数据操作语言。DML为用户提供添加（insert）、删除（delete）、更新数据（update）的能力，这些是应用程序对数据库的日常操作。</p>
<p><strong>DQL(Data Query Language)</strong>：数据查询语言，执行查询（select）操作。<br><strong>TCL(Transaction Control Language)</strong>：事务控制语言，执行commit、rollback等操作。</p>
<h1 id="二、关系数据库"><a href="#二、关系数据库" class="headerlink" title="二、关系数据库"></a>二、关系数据库</h1><h2 id="1、什么是关系型数据库"><a href="#1、什么是关系型数据库" class="headerlink" title="1、什么是关系型数据库"></a>1、什么是关系型数据库</h2><p><strong>RDBMS(Relational Database Management System)</strong>：关系型数据库管理系统，即基于关系模型的数据库。</p>
<p><strong>关系模型</strong>把数据看作是一个二维表格，任何数据都可以通过行号和列号来唯一确定，它的数据模型看起来就是一个Excel表。</p>
<h2 id="2、RDBMS存储数据的特点"><a href="#2、RDBMS存储数据的特点" class="headerlink" title="2、RDBMS存储数据的特点"></a>2、RDBMS存储数据的特点</h2><p>RDBMS存储数据的特点：</p>
<ul>
<li>数据以表格的形式出现，每个表都有唯一的名字，用于标识自己。</li>
<li>若干的表格组成数据库。</li>
<li>表本身具有一些特性，这些特性定义了数据在表中如何存储，类似java中 “类”的设计。</li>
<li>表中的<strong>列</strong>也称为<strong>字段（Column）</strong>。列类似于java 中的”属性”。</li>
<li>表中的<strong>行</strong>称为<strong>记录（Record）</strong>，每一行是一组相关的数据。行类似于java中的“对象”。</li>
</ul>
<h2 id="3、常见的关系型数据库"><a href="#3、常见的关系型数据库" class="headerlink" title="3、常见的关系型数据库"></a>3、常见的关系型数据库</h2><ul>
<li>商用数据库，例如：<a href="https://www.oracle.com/">Oracle</a>，<a href="https://www.microsoft.com/sql-server/">SQL Server</a>，<a href="https://www.ibm.com/db2/">DB2</a>等；</li>
<li>开源数据库，例如：<a href="https://www.mysql.com/">MySQL</a>，<a href="https://www.postgresql.org/">PostgreSQL</a>等；</li>
<li>桌面数据库，以微软<a href="https://products.office.com/access">Access</a>为代表，适合桌面应用程序使用；</li>
<li>嵌入式数据库，以<a href="https://sqlite.org/">Sqlite</a>为代表，适合手机应用和桌面程序。</li>
</ul>
<h2 id="4、NoSQL"><a href="#4、NoSQL" class="headerlink" title="4、NoSQL"></a>4、NoSQL</h2><p>NoSQL数据库，也就是非SQL的数据库，包括MongoDB、Cassandra、Dynamo等等，它们都不是关系数据库。SQL数据库从始至终从未被取代过，NoSQL的发展历程：</p>
<ul>
<li>1970: NoSQL = We have no SQL</li>
<li>1980: NoSQL = Know SQL</li>
<li>2000: NoSQL = No SQL!</li>
<li>2005: NoSQL = Not only SQL</li>
<li>2013: NoSQL = No, SQL!</li>
</ul>
<p>今天，SQL数据库仍然承担了各种应用程序的核心数据存储，而NoSQL数据库作为SQL数据库的补充，两者不再是二选一的问题，而是主从关系。</p>
<h1 id="三、MySQL"><a href="#三、MySQL" class="headerlink" title="三、MySQL"></a>三、MySQL</h1><h2 id="1、MySQL介绍"><a href="#1、MySQL介绍" class="headerlink" title="1、MySQL介绍"></a>1、MySQL介绍</h2><p>MySQL是目前应用最广泛的开源关系数据库。MySQL最早是由瑞典的MySQL AB公司开发，该公司在2008年被SUN公司收购，SUN公司在2009年被Oracle公司收购，所以MySQL最终就变成了Oracle旗下的产品。</p>
<p>MySQL优势：</p>
<ul>
<li>开源、免费、成本低</li>
<li>性能高、移植性好</li>
<li>体积小，便于安装</li>
</ul>
<h2 id="2、MySQL安装"><a href="#2、MySQL安装" class="headerlink" title="2、MySQL安装"></a>2、MySQL安装</h2><p>MySQL属于c/s架构的软件，一般来讲只安装服务端。以下案例以 MySQL5.7 为例</p>
<p>下载<a href="https://dev.mysql.com/downloads/mysql/">链接</a></p>
<h2 id="3、MySQL服务的启动和停止"><a href="#3、MySQL服务的启动和停止" class="headerlink" title="3、MySQL服务的启动和停止"></a>3、MySQL服务的启动和停止</h2><p>Windows下，MySQL启动和停止有两种方式：</p>
<ul>
<li>计算机—右击管理—服务，启动MySQL服务</li>
<li>通过管理员身份运行cmd：<ul>
<li>net start 服务名（启动服务），例<code>net start mysql57</code></li>
<li>net stop 服务名（停止服务），例<code>net stop mysql57</code></li>
</ul>
</li>
</ul>
<h2 id="4、MySQL服务的登录和退出"><a href="#4、MySQL服务的登录和退出" class="headerlink" title="4、MySQL服务的登录和退出"></a>4、MySQL服务的登录和退出</h2><p>​    方式一：通过mysql自带的客户端（MySQL Line Client），只限于root用户</p>
<p>​    方式二：通过windows的命令提示符，以管理员身份打开</p>
<ul>
<li><p>登录：<code>mysql [-h 主机名 -P 端口号] -u 用户名 -p密码</code>，<code>[]</code>里的内容表示可以省略</p>
<blockquote>
<p>其中<code>p</code>参数和密码直接不能有空格，其他参数和值之间空格可有可无，比如<code>-uroot</code>，表示root用户。</p>
<p>密码可以不添加值，直接回车，然后输入密码，不会显示出明文。</p>
<p>如果是本机，并且端口是3306，可以省略<code>-h</code>和<code>-P</code>参数，直接输入用户名和密码即可。</p>
</blockquote>
</li>
<li><p>退出：<code>exit</code></p>
</li>
</ul>
<p>如下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-basis_1.png"></p>
<h2 id="5、MySQL的常见命令"><a href="#5、MySQL的常见命令" class="headerlink" title="5、MySQL的常见命令"></a>5、MySQL的常见命令</h2><p>查看当前所有的数据库:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show databases;<br></code></pre></td></tr></tbody></table></figure>
<p>打开指定的库:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">use 库名;<br></code></pre></td></tr></tbody></table></figure>
<p>查看当前库的所有表:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show tables;<br></code></pre></td></tr></tbody></table></figure>
<p>查看其它库的所有表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show tables from 库名;<br></code></pre></td></tr></tbody></table></figure>
<p>查看表结构：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">desc 表名;<br></code></pre></td></tr></tbody></table></figure>
<p>查看表的列属性：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show columns from 表名;<br></code></pre></td></tr></tbody></table></figure>
<p>查看表的索引：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show index from 表名;<br></code></pre></td></tr></tbody></table></figure>
<p>查看xx状态：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 查看指定表的状态信息<br>show table status from 表名/数据库;<br><br># 查看主从复制中的主机状态<br>show master status;<br><br># 查看主从复制中从机状态<br>show slave status;<br></code></pre></td></tr></tbody></table></figure>
<p>查看服务器的版本：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 方式一，在mysql服务端查看：<br>select version();<br># 方式二，在cmd窗口查看：<br>mysql --version<br>或<br>mysql --V<br></code></pre></td></tr></tbody></table></figure>
<p>用户管理指令：</p>
<p><strong>添加用户的两种方式</strong></p>
<p>1、使用insert指令，在mysql.user表中添加用户：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 比如想添加用户：user，密码：123456，并授予select权限<br># 只需要在user表的指定列添加内容即可。<br>insert into mysql.user(host,user,password，select_priv)<br>	values('localhost','user',password('123456'),'Y');<br>flush privileges;<br>/* <br>其中host列表示限制登陆的主机，localhost表示只能当前主机登陆，<br>可以指定ip，使用%表示任意主机。<br>MySQL5.7以后，password改名为authentication_string。<br>密码需要使用password()函数进行加密，MySQL8.0.11移除了这个函数，可以使用MD5()代替。<br>可以根据需求授予其他权限，只需要相应列赋值为'Y'即可。<br>添加完后，使用flush privileges语句刷新授权表，使之立即生效，<br>否则需要重启MySQL服务才生效。<br>*/<br></code></pre></td></tr></tbody></table></figure>
<p>2、使用grant命令</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 比如给指定数据库比如student库，添加用户user，密码123,授予select权限<br>grant select   # 指定授予的权限<br>on student.*   # 指定数据库和表，*表示所有，这里表示student库所有表<br>to 'user'@'localhost'  # 指定用户名和登陆主机，localhost根据需求填写<br>indentified by '123';   # 指定登录密码。<br></code></pre></td></tr></tbody></table></figure>
<p>grant指令更多内容，参考<a href="https://dev.mysql.com/doc/refman/8.0/en/grant.html#grant-overview">GRANT  Statement</a></p>
<h2 id="6、MySQL的语法规范"><a href="#6、MySQL的语法规范" class="headerlink" title="6、MySQL的语法规范"></a>6、MySQL的语法规范</h2><p>MySQL中的命令有以下规范：</p>
<ul>
<li><strong>不区分大小写</strong>，建议关键字大写，表名和列名小写</li>
<li>每条命令以<code>;</code>或<code>\g</code>结尾</li>
<li>每条命令根据需要，可以进行缩进或换行。关键字不能缩写或分行。</li>
<li>注释<ul>
<li>单行注释：<code>#注释文字</code></li>
<li>单行注释：<code>-- 注释文字</code>,(注意<code>--</code>后面有空格)</li>
<li>多行注释：<code>/* 注释文字  */</code></li>
</ul>
</li>
</ul>
<p>字符（建议加，有时必须加）和日期型要加引号，数值不需要加。<strong>表的别名不需要加引号</strong></p>
<h1 id="四、MySQL数据类型"><a href="#四、MySQL数据类型" class="headerlink" title="四、MySQL数据类型"></a>四、MySQL数据类型</h1><p>MySQL支持所有标准SQL数值数据类型（SQL数据类型参考<a href="https://www.runoob.com/sql/sql-datatypes-general.html">链接</a>）。作为SQL标准的扩展，MySQL也支持整数类型TINYINT、MEDIUMINT和BIGINT。详细参考<a href="https://www.runoob.com/mysql/mysql-data-types.html">MySQL数据类型</a></p>
<p><strong>MySQL中的TRUE和FALSE，也可以分别用1和0表示。</strong></p>
<p>MySQL中的数据类型包括<strong>数值型</strong>、<strong>字符型</strong>、<strong>日期型</strong>等。</p>
<p><strong>数值型</strong></p>
<table>
    <tbody><tr>
        <td><b></b></td>
        <td><b>类型</b></td>
        <td><b>字节</b></td>
        <td><b>说明</b></td>
    </tr>
    <tr>
        <td rowspan="5">整型</td>
        <td>Tinyint</td>
        <td>1</td>
        <td>有符号：-128~127<br>
            无符号：0~255
        </td>
    </tr>
    <tr>
        <td>Smallint</td>
        <td>2</td>
        <td>有符号：-32768~32767<br>
            无符号：0~65535
        </td>
    </tr>
    <tr>
        <td>Mediumint</td>
        <td>3</td>
        <td>有符号：-8,388,608~8,388,607<br>
            无符号：0~16,777,215
        </td>
    </tr>
    <tr>
        <td>Int/Integer</td>
        <td>4</td>
        <td>有符号：-2,147,483,648~2,147,483,647<br>
            无符号：0~4,294,967,296
        </td>
    </tr>
    <tr>
        <td>Bigint</td>
        <td>8</td>
        <td>有符号：-2^63~2^63-1<br>
            无符号：0~2^64
        </td>
    </tr>
    <tr>
        <td rowspan="2">浮点型小数</td>
        <td>float(M,D)</td>
        <td>4</td>
        <td>±1.75494351E-38 ~ ±3.402823466E+38</td>
    </tr>
    <tr>
        <td>double(M,D)</td>
        <td>8</td>
        <td>±2.2250738585072014E-308 ~ ±1.7976931348623157E+308</td>
    </tr>
      <tr>
        <td>定点型小数</td>
        <td>DEC(M,D)<br>
              DECIMAL(M,D)
          </td>
        <td>M+2</td>
        <td>最大取值范围与double相同， 给定decimal的有效取值范围由M和D决定</td>
    </tr>
</tbody></table>


<p>说明：</p>
<ul>
<li>如果不设置无符号还是有符号，默认是有符号，如果想设置无符号，需要在类型后面添加<code>unsigned</code>关键字</li>
<li>如果插入的数值超出了整型的范围,会报out of range异常，并且插入临界值</li>
<li><p>如果不设置长度，会有默认的长度。长度不决定范围，长度代表了显示的最大宽度。可以选择在长度不够时，用0在左边填充，需要在类型后面添加<code>zerofill</code>。zerofill只支持正数（无符号）</p>
</li>
<li><p>定点型的精确度较高，如果要求插入数值的精度较高如货币运算等则考虑使用</p>
</li>
<li>M表示整数部位个数+小数部位个数的总长度。D表示小数部位长度。如果插入的数值超过范围，会报out of range异常，并插入临界值。</li>
<li>M和D都可以省略。如果是decimal，则M默认为10，D默认为0。</li>
<li>float和double，会根据插入的数值的精度来决定精度。</li>
</ul>
<p><strong>字符型</strong></p>
<table>
    <tbody><tr>
        <td><b>类型</b></td>
        <td><b>最多字符数</b></td>
        <td><b>描述</b></td>
    </tr>
    <tr>
        <td>char(M)</td>
        <td>M</td>
        <td>M为0~255之间的整数，固定长度的字符，比较耗费空间，效率高</td>
    </tr>
    <tr>
        <td>varchar(M)</td>
        <td>M</td>
        <td>M为0~65535之间的整数，可变长度的字符，比较节省空间，效率低</td>
    </tr>
</tbody></table>


<p>M表示最大的字符个数，而不是存储空间。</p>
<p>M</p>
<p>其他字符型类型：</p>
<ul>
<li><code>binary</code>和<code>varbinary</code>用于保存较短的二进制</li>
<li><code>enum</code>用于保存枚举类型，要求插入的值必须属于列表中指定的值之一。如果列表成员为<code>1~255</code>，则需要1个字节存储。如果列表成员为<code>255~65535</code>，则需要2个字节存储，最多为65535个成员。</li>
<li><code>set</code>用于保存集合。里面可以保存0~64个成员。一次可以选取多个成员。根据成员个数不同，存储所占的字节从1-8变化。</li>
<li><code>text</code>用于存放较长的文本</li>
<li><code>blob</code>用于存放较大的二进制</li>
</ul>
<p><strong>日期型</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>日期和时间类型</th>
<th>字节</th>
<th>最小值</th>
<th>最大值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>date</code></td>
<td>4</td>
<td>1000-01-01</td>
<td>9999-12-31</td>
</tr>
<tr>
<td><code>datetime</code></td>
<td>8</td>
<td>1000-01-01 00:00:00</td>
<td>9999-12-31 23:59:59</td>
</tr>
<tr>
<td><code>timestamp</code></td>
<td>4</td>
<td>1970-01-01 00:00:00</td>
<td>2038-1-19某一时刻</td>
</tr>
<tr>
<td><code>time</code></td>
<td>3</td>
<td>-838:59:59</td>
<td>838:59:59</td>
</tr>
<tr>
<td><code>year</code></td>
<td>1</td>
<td>1901</td>
<td>2155</td>
</tr>
</tbody>
</table>
</div>
<p>其中字符型和日期型的常量值必须要用<code>''</code>或<code>""</code>包起来。数值型不需要。</p>
<p><strong>datetime和timestamp的对比</strong></p>
<ul>
<li><p>二者都是保存日期和时间。</p>
</li>
<li><p>datetime占用8字节，范围是1000-9999，不受时区的影响。</p>
</li>
<li>timestamp占用4字节，范围为1970-2038，受时区的影响，其值会根据时区的变化而变化。即插入数据以后，如果修改时区，表中的时间戳也会改变为对应时区的值。</li>
</ul>
<h1 id="五、DQL语言"><a href="#五、DQL语言" class="headerlink" title="五、DQL语言"></a>五、DQL语言</h1><p>DQL为数据查询语言，执行查询（select）操作。</p>
<p>DQL的完整查询语句结构：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select 字段,...				# 7<br>from 表1 [别名]				# 1<br>[连接类型 join 表2]...			# 2<br>[on 连接条件]				# 3<br>[where 筛选条件]			# 4<br>[group by 分组字段]			# 5<br>[having 分组后的筛选条件]		# 6<br>[order by 排序的字段或表达式]		# 8<br>[limit 偏移量(起始条目索引),条数]; 	# 9<br></code></pre></td></tr></tbody></table></figure>
<p>以上各部分的执行顺序：<br><code>from</code>→<code>join</code>→<code>on</code>→<code>where</code>→<code>group by</code>(开始使用select中的别名，后面的语句都可以使用)-</p>
<p>→<code>AVG/SUM/MAX/MIN等分组函数</code>→<code>having</code>→<code>select</code>→<code>distinct</code>→<code>order by</code>→<code>limit</code></p>
<p>以下案例使用的数据库：<code>myemployees</code>，其中有<code>departments</code>、<code>employees</code>、<code>job_grades</code>、<code>jobs</code>、<code>locations</code>共五张表。各自的包含的字段如下：</p>
<p><code>departments</code>表：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-basis_3.png"></p>
<p><code>employees</code>表：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-basis_2.png"></p>
<p><code>job_grades</code>表：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-basis_4.png"></p>
<p><code>jobs</code>表：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-basis_5.png"></p>
<p><code>locations</code>表：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-basis_6.png"></p>
<h2 id="1、基础查询"><a href="#1、基础查询" class="headerlink" title="1、基础查询"></a>1、基础查询</h2><p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT 查询内容 <br>[FROM 表名];<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>类似于Java中的System.out.println(要打印的东西);</p>
<p>查询的结果是一个虚拟的表，不会改变原来的表格。</p>
</blockquote>
<p>特点：<br>①通过select查询出的结果 ，是一个虚拟的表格，不是真实存在</p>
<p>②查询内容可以是<strong>常量值</strong>、<strong>表达式</strong>、<strong>字段</strong>、<strong>函数</strong></p>
<p>示例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#1.查询单个字段<br>SELECT last_name FROM employees;<br><br>#2.查询多个字段<br>SELECT last_name,salary,email FROM employees;<br><br>#3.查询所有字段<br>SELECT <br>    `employee_id`,<br>    `first_name`,<br>    `last_name`,<br>    `phone_number`,<br>    `last_name`,<br>    `job_id`,<br>    `phone_number`,<br>    `job_id`,<br>    `salary`,<br>    `commission_pct`,<br>    `manager_id`,<br>    `department_id`,<br>    `hiredate` <br>FROM<br>    employees ;<br>#方式二，*号表示所有字段：  <br>SELECT * FROM employees;<br><br>#4.查询常量<br>SELECT 100;<br><br>#5.查询函数<br>SELECT VERSION();<br><br>#6.查询表达式<br>SELECT 100%98;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>别名</strong>：如果要查询的字段有重名的情况，可以使用别名区分；同样，表也可以起别名。</p>
<p>定义别名有两种方式：</p>
<ul>
<li><p>使用<code>as</code>:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT 100%98 AS 结果;<br>/*运行结果为：<br>+------+<br>| 结果 |<br>+------+<br>|    2 |<br>+------+<br>*/<br>SELECT last_name AS 姓,first_name AS 名 FROM employees;<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>使用空格，将<code>as</code>替换为空格即可：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT last_name 姓,first_name 名 FROM employees;<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p><strong>去重</strong>：使用<code>distinct</code>对结果去重</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#案例：查询员工表中涉及到的所有的部门编号<br>SELECT DISTINCT department_id FROM employees;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>+号在MySQL中的作用</strong>：</p>
<p>MySQL中的<code>+</code>号只有运算符的作用，其运算规则如下：</p>
<ul>
<li>如果两个操作值都是数值型，做加法运算</li>
<li>如果一方为字符型，则尝试进行转换，转换成功就做加法运算，如果转换失败，则将字符值当作0</li>
<li>任何数和<code>null</code>做加法运算，结果都是<code>null</code></li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select 100+90;  # 结果为190<br>select '123'+90; # 结果为213<br>select 'john'+90; # 结果为90<br>select null+10;  # 结果为null<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、条件查询"><a href="#2、条件查询" class="headerlink" title="2、条件查询"></a>2、条件查询</h2><p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select 要查询的字段|表达式|常量值|函数<br>from 表<br>where 筛选条件;  # where后面加筛选条件<br></code></pre></td></tr></tbody></table></figure>
<p>根据筛选条件的不同，可以分为以下几种：</p>
<p>① <strong>条件表达式</strong></p>
<p>使用以下条件运算符：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">操作符</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>=</code></td>
<td style="text-align:left">等于，也可以作为赋值符号，为了便于区分，变量赋值尽量用<code>:=</code>符号。<br>不能用于判断<code>null</code>值</td>
</tr>
<tr>
<td style="text-align:center"><code>&gt;</code></td>
<td style="text-align:left">大于</td>
</tr>
<tr>
<td style="text-align:center"><code>&gt;=</code></td>
<td style="text-align:left">大于等于</td>
</tr>
<tr>
<td style="text-align:center"><code>&lt;</code></td>
<td style="text-align:left">小于</td>
</tr>
<tr>
<td style="text-align:center"><code>&lt;=</code></td>
<td style="text-align:left">小于等于</td>
</tr>
<tr>
<td style="text-align:center"><code>&lt;&gt;</code>或<code>!=</code></td>
<td style="text-align:left">不等于，两种写法均可，不能用于判断<code>null</code>值</td>
</tr>
</tbody>
</table>
</div>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#案例1：查询工资&gt;12000的员工信息<br>SELECT * FROM employees WHERE salary&gt;12000;<br><br>#案例2：查询部门编号不等于90号的员工名和部门编号<br>SELECT <br>	last_name,<br>	department_id<br>FROM employees<br>WHERE department_id&lt;&gt;90;<br></code></pre></td></tr></tbody></table></figure>
<p>②<strong>逻辑表达式</strong></p>
<p>使用以下逻辑运算符：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>操作符</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>and</code>或<code>&amp;&amp;</code></td>
<td>与</td>
</tr>
<tr>
<td><code>or</code>或<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.294ex" height="2.843ex" style="vertical-align: -0.838ex;" viewBox="0 -863.1 557 1223.9" role="img" focusable="false" xmlns="http://www.w3.org/2000/svg" aria-labelledby="MathJax-SVG-1-Title">
<title id="MathJax-SVG-1-Title">||</title>
<defs aria-hidden="true">
<path stroke-width="1" id="E1-MJMAIN-7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"></path>
</defs>
<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)" aria-hidden="true">
 <use xlink:href="#E1-MJMAIN-7C" x="0" y="0"></use>
 <use xlink:href="#E1-MJMAIN-7C" x="278" y="0"></use>
</g>
</svg></td>
<td>或</td>
</tr>
<tr>
<td><code>not</code>或<code>!</code></td>
<td>非</td>
</tr>
</tbody>
</table>
</div>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#案例1：查询工资z在10000到20000之间的员工名、工资以及奖金<br>SELECT<br>	last_name,<br>	salary,<br>	commission_pct<br>FROM employees<br>WHERE salary&gt;=10000 AND salary&lt;=20000;<br><br>#案例2：查询部门编号不是在90到110之间，或者工资高于15000的员工信息<br>SELECT * FROM employees<br>WHERE NOT(department_id&gt;=90 AND department_id&lt;=110) OR salary&gt;15000;<br></code></pre></td></tr></tbody></table></figure>
<p>③<strong>其他</strong></p>
<p>包括以下几种：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>操作符</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>like</code></td>
<td style="text-align:left">模糊查询，<code>%</code>用于匹配<strong>任意个</strong>字符，包括0个，<code>_</code>用于匹配<strong>任意一个</strong>字符</td>
</tr>
<tr>
<td><code>between ... and ...</code></td>
<td style="text-align:left">判断是否在范围之间，相当于<code>&gt;=</code>和<code>&lt;=</code></td>
</tr>
<tr>
<td><code>in</code></td>
<td style="text-align:left">使用<code>=</code>号判断</td>
</tr>
<tr>
<td><code>is null</code>，<code>is not null</code></td>
<td style="text-align:left">用于判断是否为<code>null</code></td>
</tr>
</tbody>
</table>
</div>
<p><code>like</code>  一般用于字符型数据，也可以查询数值型数据。使用通配符查询，默认<code>\</code>为转义字符，也可以使用<code>escape</code>自定义转移字符。</p>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#查询员工名中包含字符a的员工信息<br>SELECT * FROM employees<br>WHERE last_name LIKE '%a%';<br><br>#查询员工名中第二个字符为_的员工名<br>SELECT last_name FROM employees<br>WHERE last_name LIKE '_#_%' ESCAPE '#'; # 自定义#作为转义字符<br></code></pre></td></tr></tbody></table></figure>
<p><code>between and</code>语句包含两个临界值，且要求是合法的范围：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#查询员工编号在100到120之间的员工信息<br>SELECT * FROM employees<br>WHERE employee_id BETWEEN 100 AND 120;<br>#等价于：<br>SELECT * FROM employees<br>WHERE employee_id &gt;= 100 AND employee_id&lt;=120;<br></code></pre></td></tr></tbody></table></figure>
<p><code>in</code>用于判断某字段的值是否属于<strong>in列表</strong>中的某一项，使用<code>=</code>号判断</p>
<ul>
<li>in列表的值类型必须一致或兼容</li>
<li>in列表中不支持通配符</li>
</ul>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#查询工种编号是IT_PROG、AD_VP、AD_PRES中其中一个的所有员工的姓名和工种编号<br>SELECT last_name, job_id FROM employees<br>WHERE job_id IN( 'IT_PROT' ,'AD_VP','AD_PRES');<br>#等价于<br>SELECT last_name, job_id FROM employees<br>WHERE job_id = 'IT_PROT' OR job_id = 'AD_VP' OR JOB_ID ='AD_PRES';<br></code></pre></td></tr></tbody></table></figure>
<p><code>is null</code>和<code>is not null</code>用于判断字段是否为<code>null</code>，且只能用于判断是否为<code>null</code>，不能用于判断是否等于某个数值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#查询没有奖金的员工名和奖金率<br>SELECT last_name,commission_pct <br>FROM employees<br>WHERE commission_pct IS NULL;<br></code></pre></td></tr></tbody></table></figure>
<p><code>&lt;=&gt;</code>既可以判断是否等于某个数值，也能用于判断是否为<code>null</code>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#案例1：查询没有奖金的员工名和奖金率<br>SELECT last_name, commission_pct<br>FROM employees<br>WHERE commission_pct &lt;=&gt;NULL;<br><br>#案例2：查询工资为12000的员工名和工资<br>SELECT last_name, salary<br>FROM employees<br>WHERE salary &lt;=&gt; 12000;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、排序查询"><a href="#3、排序查询" class="headerlink" title="3、排序查询"></a>3、排序查询</h2><p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select 查询列表<br>from 表名<br>[where 筛选条件]<br>order by 排序的字段|表达式|函数|别名 [asc|desc];  # 使用order by排序<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>默认asc，表示升序。也可以使用desc指定为降序</p>
<p>order by的位置一般放在最后面（除limit外)</p>
</blockquote>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#1、按单个字段排序<br>SELECT * FROM employees ORDER BY salary DESC;<br><br>#2、添加筛选条件再排序<br>#查询部门编号&gt;=90的员工信息，并按员工编号降序<br>SELECT * FROM employees WHERE department_id&gt;=90<br>ORDER BY employee_id DESC;<br><br>#3、按表达式排序<br>#查询员工信息 按年薪降序<br>SELECT *,salary*12*(1+IFNULL(commission_pct,0)) FROM employees<br>ORDER BY salary*12*(1+IFNULL(commission_pct,0)) DESC;<br><br>#4、按别名排序<br>#查询员工信息 按年薪升序<br>SELECT *,salary*12*(1+IFNULL(commission_pct,0)) 年薪<br>FROM employees<br>ORDER BY 年薪 ASC;<br><br>#5、按函数排序<br>#查询员工名，并且按名字的长度降序<br>SELECT LENGTH(last_name),last_name <br>FROM employees<br>ORDER BY LENGTH(last_name) DESC;<br><br>#6、按多个字段排序<br>#案例：查询员工信息，要求先按工资降序，再按employee_id升序<br>SELECT * FROM employees<br>ORDER BY salary DESC,employee_id ASC;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、常见函数"><a href="#4、常见函数" class="headerlink" title="4、常见函数"></a>4、常见函数</h2><p>MySQL中的函数类似于java中的方法，将一组逻辑语句封装在方法体中，对外暴露方法名。</p>
<p>优势：提高代码重用性，隐藏了实现细节。</p>
<p>调用函数的语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select 函数名(实参列表) [from 表名...]<br></code></pre></td></tr></tbody></table></figure>
<p>函数根据作用对象的个数不同，可以分为<strong>单行函数</strong>和<strong>分组函数</strong>。</p>
<p><strong>单行函数</strong></p>
<ul>
<li><p>字符函数</p>
<ul>
<li><code>length</code>：求参数的字节个数，比如一个汉字三个字节</li>
<li><code>concat</code>：字符拼接，只要有一个为null，则结果为null</li>
<li><code>substr</code>：截取子串。sql中的索引是从1开始的</li>
<li><code>instr</code>：返回子串第一次出现的索引</li>
<li><code>trim</code>：去除首尾指定的空格和字符</li>
<li><code>upper</code>：转换成大写</li>
<li><code>lower</code>：转换成小写</li>
<li><code>lpad</code>：左填充</li>
<li><code>rpad</code>：右填充</li>
<li><code>replace(str,a,b)</code>：将str中的a替换成b</li>
</ul>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#截取从指定索引处指定字符长度的字符(不是字节长度)<br>SELECT SUBSTR('你好，MySQL',1,2) out_put;   # 你好<br><br>SELECT LENGTH(TRIM('    张 翠 山    ')) AS out_put; # 11<br># trim只能去除首尾的空格，length求得是字节的个数<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>数学函数</p>
<ul>
<li><code>round</code>：四舍五入</li>
<li><code>rand</code>：返回一个[0,1)之间的随机数</li>
<li><code>ceil</code>：向上取整，返回&gt;=该参数的最小整数</li>
<li><code>floor</code>：向下取整，返回&lt;=该参数的最大整数</li>
<li><code>truncate</code>：截断（直接截断，不会四舍五入），保留小数点后的n位</li>
<li><code>mod</code>：取余</li>
</ul>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT ROUND(-1.55); #-2<br>SELECT CEIL(-1.02);  #-1<br>SELECT FLOOR(-9.99);  #-10<br>SELECT TRUNCATE(1.69999,1); # 1.6<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>日期函数</p>
<ul>
<li><code>now</code>：返回当前系统日期+时间</li>
<li><code>curdate</code>：返回当前系统日期，不包含时间</li>
<li><code>curtime</code>：返回当前时间，不包含日期</li>
<li><code>year</code>：获取指定日期的年份</li>
<li><code>month</code>：获取指定日期的月份</li>
<li><code>monthname</code>：获取指定日期月份的英文</li>
<li><code>day</code>：获取指定日期的日</li>
<li><code>hour</code>：获取指定日期的小时</li>
<li><code>minute</code>：获取指定日期的分钟</li>
<li><code>second</code>：获取指定日期的秒</li>
<li><code>str_to_date</code>：将字符通过指定的格式转换成日期</li>
<li><code>date_format</code>：将日期转换成字符</li>
<li><code>datediff</code>：返回两个日期相差的天数</li>
</ul>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT YEAR('1998-1-1') 年;  # 1998<br>SELECT DATE_FORMAT(NOW(),'%y年%m月%d日') AS out_put;  # 21年04月25日<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p><span id="refer2">流程控制函数</span>，包括<code>if</code>和<code>case</code>函数。这里作为函数，可以用在任何地方，包括begin end里面和外面，注意和后面的<code>if</code>结构和<code>case</code>结构区分。    </p>
<ul>
<li><p><code>if</code>函数：<code>if(条件，值1，值2)</code>，如果条件成立，返回值1，否则返回值2</p>
</li>
<li><p><code>case</code>函数：作为函数，其有两种用法，格式如下：</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#用法1：<br>case 要判断的字段或表达式<br>when 常量1 then 值1<br>when 常量2 then 值2<br>...<br>else 值n<br>endl;<br>    <br>#用法2：<br>case <br>when 条件1 then 值1<br>when 条件2 then 值2<br>...<br>else 值n<br>end;<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>if/case结构作为函数时，可以应用在begin end结构中或外面，其返回结果必须是值；语句中不用加分号，最后结束才加分号。</p>
<p>if/case作为流程控制结构时，只能用于begin end结构中，其返回的是执行语句，中间需要加分号，且end后面要加if/case。作为流程控制结构的语法参考最后一章流程控制。</p>
</blockquote>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># if<br># 例一<br>SELECT IF(10&lt;5,'大','小');<br><br># 例2<br>SELECT <br>	last_name,<br>	commission_pct,<br>	IF(commission_pct IS NULL,'没奖金','有奖金') 备注<br>FROM employees;<br><br># case<br># 例1<br>SELECT salary 原始工资,department_id,<br>CASE department_id<br>WHEN 30 THEN salary*1.1<br>WHEN 40 THEN salary*1.2<br>WHEN 50 THEN salary*1.3<br>ELSE salary<br>END AS 新工资<br>FROM employees;<br><br># 例2<br>SELECT salary,<br>CASE <br>WHEN salary&gt;20000 THEN 'A'<br>WHEN salary&gt;15000 THEN 'B'<br>WHEN salary&gt;10000 THEN 'C'<br>ELSE 'D'<br>END AS 工资级别<br>FROM employees;<br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><p>其他</p>
<ul>
<li><code>version</code>：获取MySQL当前版本</li>
<li><code>database</code>：获取当前数据库</li>
<li><code>user</code>：获取当前用户</li>
<li><code>if null(参数,指定值)</code>：如果参数值为<code>null</code>，则返回指定值，否则返回参数的值</li>
<li><code>is null(参数)</code>：判断字段或表达式是否为<code>null</code>，如果是，返回1，否则返回0</li>
<li><code>password("str")</code>：返回str的密码形式</li>
<li><code>md5("str")</code>：返回str的MD5形式</li>
</ul>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT VERSION();<br>SELECT DATABASE();<br>SELECT USER();<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p><strong>分组函数</strong></p>
<ul>
<li><code>sum</code>：求和。一般用于处理数值</li>
<li><code>max</code> ：最大值</li>
<li><code>min</code>： 最小值</li>
<li><code>avg</code>：平均值。一般用于处理数值</li>
<li><code>count</code>：计数。参数可以是<code>字段</code>、<code>*</code>、<code>常量值（一般用1）</code>，<code>*</code>表示所有字段同时考虑，一般用来统计行数。常量值也能用来统计行数。</li>
</ul>
<blockquote>
<p>1.、以上五个分组函数都忽略<code>null</code>值，除了<code>count(*)</code>，因为主键一定不为空<br>2、max、min、count可以处理任何数据类型。<br>3、都可以搭配distinct使用，用于统计去重后的结果</p>
<p>4、MYISAM存储引擎下  ，<code>COUNT(*)</code>的效率高；INNODB存储引擎下，<code>COUNT(*)</code>和<code>COUNT(1)</code>的效率差不多，比COUNT(字段)要高一些。</p>
</blockquote>
<p>和分组函数同时查询的字段，必须是group by后的字段，不然会出现错误结果。</p>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT SUM(salary) FROM employees;<br>SELECT AVG(salary) FROM employees;<br># 与distinct搭配使用<br>SELECT COUNT(DISTINCT salary),COUNT(salary) FROM employees;  # 57,107<br><br># 和分组函数一同查询的字段有限制<br># 下面这种，employee_id是无意义的，只有group by后的字段才能和分组函数一起查询<br>SELECT AVG(salary),employee_id  FROM employees;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="5、分组查询"><a href="#5、分组查询" class="headerlink" title="5、分组查询"></a>5、分组查询</h2><p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select 查询列表<br>from 表<br>[where 筛选条件]<br>group by 分组的字段  # 使用group by进行分组<br>[having 条件语句];<br></code></pre></td></tr></tbody></table></figure>
<p>说明：</p>
<p>1、和分组函数一同查询的字段必须是group by后出现的字段，确保意义正确</p>
<p>2、筛选分为两类：分组前筛选(where)和分组后(having)筛选。having后面一般跟的分组函数，表示对初步筛选后的结果再进行筛选。</p>
<p>3、分组可以按单个字段也可以按多个字段。</p>
<p>4、可以搭配排序使用。</p>
<p>5、having 和group by后，mysql支持别名，Oracle不支持。一般也不使用。</p>
<p>6、having后面的条件一般是分组函数，如果是一般的字段，必须是select中的字段（自己实验得出）。规范来说，having必须是在使用group by语句之后才能使用，如果不是在group by后面，having的作用和where的作用相同，但是不建议这么做，最好按照规范来做。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">/*<br>MySQL 5.7版本，出现以下结果<br>*/<br>SELECT salary FROM employees <br>WHERE salary&gt;15000; # 输出正确结果<br><br>SELECT last_name FROM employees<br>WHERE salary&gt;15000; # 输出正确结果<br>#－－－－－－－－－－－－－－－－－－<br>SELECT salary FROM employees <br>HAVING salary&gt;15000; # 输出正确结果<br><br>#如果having后的字段，没在select中，会报错<br>SELECT last_name FROM employees <br>HAVING salary&gt;15000; # 显示语法错误，原因是‘having clause’中没有salary列<br></code></pre></td></tr></tbody></table></figure>
<p><strong><code>where</code>和<code>having</code>的区别：</strong></p>
<ul>
<li>where是分组前进行筛选，是对原始表筛选；having是在分组后筛选，是对分组后的结果再进行筛选，一般的筛选条件是分组函数。可以根据代码执行顺序进行推断。</li>
<li>在语句格式上，where写在group by 前面，having写在group by后面。</li>
</ul>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#案例1：查询每个工种的员工平均工资<br>SELECT AVG(salary),job_id  #和分组函数同时查询的字段，是用于分组的字段<br>FROM employees<br>GROUP BY job_id;<br><br>#案例2：查询邮箱中包含a字符的每个部门的最高工资<br>SELECT MAX(salary),department_id<br>FROM employees<br>WHERE email LIKE '%a%'<br>GROUP BY department_id;<br><br>#案例3：查询哪个部门的员工个数&gt;5<br>SELECT COUNT(*),department_id<br>FROM employees<br>GROUP BY department_id  # 先查询每个部门员工个数<br>HAVING COUNT(*)&gt;5;  # 然后选出个数&gt;5的<br><br>#案例4：查询每个工种有奖金的员工的最高工资&gt;6000的工种编号和最高工资,按最高工资升序<br>SELECT job_id,MAX(salary) m<br>FROM employees<br>WHERE commission_pct IS NOT NULL<br>GROUP BY job_id<br>HAVING m&gt;6000<br>ORDER BY m;<br><br>#按多个字段分组<br>#案例5：查询每个查询每个工种每个部门的平均工资<br>SELECT department_id, job_id,AVG(salary) FROM employees<br>GROUP BY department_id,job_id; # 顺序可以颠倒<br># 这两种写法等价，每个A，每个B和每个B，每个A结果相同。<br>SELECT department_id, job_id,AVG(salary) FROM employees<br>GROUP BY job_id,department_id;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="6、多表连接查询"><a href="#6、多表连接查询" class="headerlink" title="6、多表连接查询"></a>6、多表连接查询</h2><p>当查询的字段来自多个表时，就需要使用连接查询。</p>
<p>如果不使用连接条件，或者连接条件无效，则多个表会按照笛卡儿乘积的形式连接，即查询的结果为m*n的表。</p>
<p>解决这种现象就需要添加有效的连接条件。</p>
<p>连接方式按照功能分类：</p>
<ul>
<li>内连接<ul>
<li>等值连接</li>
<li>非等值连接</li>
<li>自连接</li>
</ul>
</li>
<li>外连接。<ul>
<li>左外连接，left join左边是主表</li>
<li>右外连接，right join右边是主表</li>
<li>全外连接</li>
</ul>
</li>
<li>交叉连接</li>
</ul>
<p>其中，SQL 92标准仅支持内连接，ORACLE和SQL Server支持一部分外连接（mysql不支持），SQL 99标准支持内连接+外连接+交叉连接(mysql不支持全外连接)。</p>
<p>下面以两个表连接为例，说明连接查询的语法格式。</p>
<p><strong>内连接</strong></p>
<p>等值连接</p>
<p>等值内连接的结果是多表的交集。n表连接，至少需要n-1个连接条件。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># SQL 92语法<br>select 查询列表<br>from 表1 别名，表2 别名<br>where 表1.字段= 表2.字段   # 连接条件 <br>[and 筛选条件]<br>其他结构...<br><br># SQL 99语法<br>select 查询列表<br>from 表1 别名<br>[inner] join 表2 别名<br>on 连接条件<br>其他结构...<br># SQL 99语法将筛选条件和连接条件分离，便于阅读<br></code></pre></td></tr></tbody></table></figure>
<p>非等值连接</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># SQL 92<br>select 查询列表<br>from 表1 别名，表2, 别名...<br>where 非等值连接条件<br>[and 筛选条件]<br>其他结构...<br><br># SQL 99<br>select 查询列表<br>from 表1 别名<br>[inner] join 表2 别名<br>on 非等值连接条件<br>其他结构...<br></code></pre></td></tr></tbody></table></figure>
<p>自连接</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 自连接是指同一张表自己和自己连接。<br>#将同一张表看作两个表，起两个别名。<br># SQL 92<br>select 查询列表<br>from 表 别名1,表 别名2<br>where 连接条件<br>[and 筛选条件]<br>其他结构...<br><br># SQL 99语法<br>select 查询列表<br>from 表 别名1<br>[inner] join 表 别名2<br>on 连接条件<br>其他结构...<br></code></pre></td></tr></tbody></table></figure>
<p>总结：对于内连接，SQL 92和SQL 99标准只有在连接表的方式和连接条件的位置不同，其余用法相同。SQL 99语法将连接条件写在<code>on</code>语句后面，与筛选条件分离，提高了易读性。</p>
<p>内连接案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#案例1：查询有奖金的每个部门的部门名、部门的领导编号，以及该部门的最低工资<br># SQL 92，等值连接<br>SELECT department_name,d.`manager_id`,MIN(salary)<br>FROM departments d,employees e<br>WHERE d.`department_id`=e.`department_id`<br>AND commission_pct IS NOT NULL<br>GROUP BY department_name,d.`manager_id`;<br><br># SQL 99，等值连接<br>SELECT d.department_name,d.manager_id,MIN(salary)<br>FROM employees e <br>JOIN departments d<br>ON e.`department_id` = d.`department_id`<br>WHERE e.`commission_pct` IS NOT NULL<br>GROUP BY e.`department_id`;<br><br>#案例2：查询员工的工资和工资级别<br># SQL 92，非等值连接<br>SELECT salary,grade_level<br>FROM employees e,job_grades g<br>WHERE salary BETWEEN g.`lowest_sal` AND g.`highest_sal`;<br><br># SQL 99，非等值连接<br>SELECT salary,grade_level<br>FROM employees e<br>JOIN job_grades g <br>ON e.`salary` BETWEEN g.`lowest_sal` AND g.`highest_sal`;<br><br>#案例3：查询员工名和上级的名称<br># SQL 92，自连接<br>SELECT e.last_name,m.last_name<br>FROM employees e,employees m<br>WHERE e.`manager_id`=m.`employee_id`;<br><br># SQL 99，自连接<br>SELECT e.last_name,m.last_name<br>FROM employees e<br>JOIN employees m<br>ON e.`manager_id`= m.`employee_id`;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>外连接</strong></p>
<p>外连接的查询结果为主表中的所有记录，如果从表中有和它匹配的，则显示匹配的值，如果从表中没有和它匹配的，则从表的结果显示<code>null</code>。外连接查询结果=内连接结果+主表中有，从表没有的记录。</p>
<p>外连接的特性决定了其应用场景为一般<strong>用于查询两个表交集以外的部分</strong>。即用于查询一个表中有，另一个表没有的记录。</p>
<p>左外连接和右外连接交换两个表的顺序，可以实现同样的效果 。</p>
<p>全外连接=内连接的结果+表1有，表2没有+表2有，表1没有。</p>
<p>交叉连接可以省略连接条件，其结果是笛卡尔积。</p>
<p>MySQL中只有SQL 99支持外连接（但不支持全外连接），只介绍SQL 99，语法如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 语法：<br>select 查询内容<br>from 表1<br>left [outer]|right [outer]|full [outer]|cross join 表2 <br>on 连接条件<br>其他结构...;<br><br>#outer可以省略<br></code></pre></td></tr></tbody></table></figure>
<p>外连接案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#案例1：查询哪个部门没有员工<br>#左外<br>SELECT d.*,e.employee_id<br>FROM departments d<br>LEFT OUTER JOIN employees e<br>ON d.`department_id` = e.`department_id`<br>WHERE e.`employee_id` IS NULL;<br> <br>#右外,调换两个表的顺序后使用右外连接，和上面写法等价 <br>SELECT d.*,e.employee_id<br>FROM employees e<br>RIGHT OUTER JOIN departments d<br>ON d.`department_id` = e.`department_id`<br>WHERE e.`employee_id` IS NULL;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>总结</strong></p>
<p>以集合关系来理解内连接和外连接：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-basis_7.png"></p>
<h2 id="7、子查询"><a href="#7、子查询" class="headerlink" title="7、子查询"></a>7、子查询</h2><p>嵌套在其他语句内部的select语句称为<strong>子查询</strong>或<strong>内查询</strong>。外面的语句可以是insert、update、delete、select等，一般为select语句较多。</p>
<p>如果外面的语句是select语句，则称其为<strong>主查询</strong>或<strong>外查询</strong>。</p>
<p>子查询根据位置的不同和结果集的不同可以有以下分类。</p>
<p><strong>按子查询出现的位置分类</strong>：</p>
<ul>
<li><code>select</code>后面：仅支持标量子查询</li>
<li><code>from</code>后面：表子查询</li>
<li><code>where</code>或<code>having</code>后面(常用)：标量子查询、列子查询、行子查询    </li>
<li><code>exists</code>后面（相关子查询）：均可。<code>exists</code>返回结果0或1，可以用<code>in</code>代替</li>
</ul>
<p><strong>按结果集的行列数不同分类</strong>：</p>
<ul>
<li>标量子查询（结果集只有一行一列）</li>
<li>列子查询（结果集只有一列多行）</li>
<li>行子查询（结果集一行多列）</li>
<li>表子查询（又称嵌套子查询。结果集一般为多行多列,一或多都可）</li>
</ul>
<p><strong>特点</strong>：</p>
<ul>
<li>子查询放在小括号内。</li>
<li>子查询一般放在条件的右侧。</li>
<li>子查询的执行优先于主查询执行，主查询的条件用到了子查询的结果。</li>
<li>标量、单行子查询，一般搭配着<strong>单行操作符</strong>使用：<code>&lt;</code>，<code>&gt;</code>，<code>=</code>，<code>&lt;=</code>，<code>&gt;=</code>，<code>&lt;&gt;</code></li>
<li>多行子查询，一般搭配着<strong>多行操作符</strong>使用：<code>in/not in</code>、<code>any|some</code>、<code>all</code></li>
</ul>
<p><code>in/not in</code>表示等于/不等于列表中的<strong>任意一个</strong>，例：<code>xxx in ();</code></p>
<p><code>any|some</code>表示和子查询返回的<strong>某一个值</strong>进行比较（只要有一个满足即可），例：<code>xxx &gt;any();</code>。大于<code>any|some</code>等价于大于最小值，小于<code>any|some</code>等价于小于最大值。<code>any|some</code>一般很少使用。</p>
<p><code>all</code>表示和子查询返回的<strong>所有值</strong>进行比较。</p>
<p><strong>相关子查询和嵌套子查询对比</strong></p>
<p><strong>嵌套子查询</strong>的执行<strong>不依赖于外部的查询</strong>。其执行过程为：</p>
<ul>
<li>执行子查询，其结果不被显示，而是传递给外部查询，作为外部查询的条件使用。</li>
<li>执行外部查询，并显示整个结果。</li>
</ul>
<p><strong>相关子查询</strong>的执行<strong>依赖于外部查询</strong>。多数情况下是子查询的WHERE子句中引用了外部查询的表。其执行过程为：</p>
<ul>
<li>从外层查询中取出一个元组，将元组相关列的值传给内层查询。</li>
<li>执行内层查询，得到子查询操作的值。</li>
<li>外查询根据子查询返回的结果或结果集得到满足条件的行。</li>
<li>然后外层查询取出下一个元组重复做步骤1-3，直到外层的元组全部处理完毕。 </li>
</ul>
<p>比如下面的例子：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 嵌套子查询<br># 查询工资大于平均工资的员工信息<br>/*<br>平均工资是子查询，其不依赖于外查询<br>*/<br>SELECT * FROM employees<br>WHERE salary&gt;( <br>	SELECT AVG(salary) FROM employees<br>);<br><br># 相关子查询<br># 查询每个部门的员工数量和部门信息<br>/*<br>可以使用子查询的方式，也可以使用外连接+分组查询的方式。<br>查询员工数量时，需要将子查询和父查询根据部门id关联起来，<br>先统计一个部门的数量，然后继续统计下一个部门数量,<br>子查询和父查询二者交替执行<br>*/<br>SELECT d.*,(<br>	SELECT COUNT(*) FROM employees e<br>	WHERE e.`department_id`=d.`department_id`<br>	) AS 'NUMBER'<br>FROM departments d;<br><br># exist也是相关子查询。能用exist的，也能使用in代替<br># 查询有员工的部门名<br>SELECT department_name<br>FROM departments d<br>WHERE EXISTS(<br>	SELECT *   <br>	FROM employees e<br>	WHERE d.`department_id`=e.`department_id`<br>);<br></code></pre></td></tr></tbody></table></figure>
<p>子查询案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># -------------用在where和having后使用子查询------------<br>#案例1：查询最低工资大于50号部门最低工资的 部门id 和 其最低工资<br>/*思路：<br>1.先查出50号部门的最低工资<br>2.然后查出每个部门的最低工资，<br>3.根据前两步的结果筛选出最低工资大于50号部门最低工资的部门信息<br>*/<br>SELECT MIN(salary),department_id<br>FROM employees<br>GROUP BY department_id<br>HAVING MIN(salary)&gt;(<br>	SELECT  MIN(salary)<br>	FROM employees<br>	WHERE department_id = 50<br>);<br><br>#案例2：查询其它工种中，比‘IT_PROG’工种任一工资低的员工的 员工号、工种和薪资<br>/*思路：<br>1.查询‘IT_PROG’部门的任一工资<br>2.查询员工信息，salary&lt;1的结果<br>*/<br>SELECT employee_id,job_id,salary<br>FROM employees<br>WHERE salary&lt;ANY(<br>	SELECT DISTINCT salary<br>	FROM employees<br>	WHERE job_id = 'IT_PROG'<br>) AND job_id&lt;&gt;'IT_PROG';<br><br># 小于any，只要比最大值小就可以，因此可以不用any<br>SELECT employee_id,job_id,salary<br>FROM employees<br>WHERE salary&lt;(<br>	SELECT MAX(salary) <br>	FROM employees<br>	WHERE job_id = 'IT_PROG'<br><br>) AND job_id&lt;&gt;'IT_PROG';<br><br># -------------用在select后使用子查询------------<br>#案例：查询每个部门的员工个数和部门信息<br>SELECT d.*,(<br>	SELECT COUNT(*)<br>	FROM employees e<br>	WHERE e.department_id = d.`department_id`<br> ) 个数<br> FROM departments d;<br> <br># -------------用在from后使用子查询------------<br># from后面的子查询结果作为一张表，必须起别名<br># 案例：查询每个部门的平均工资的工资等级<br>/*思路：<br>1.使用子查询，查询每个部门的平均工资<br>2.根据平均工资查找工资等级<br>*/<br>SELECT  ag_dep.*,g.`grade_level`<br>FROM (<br>	SELECT AVG(salary) ag,department_id<br>	FROM employees<br>	GROUP BY department_id<br>) ag_dep<br>INNER JOIN job_grades g<br>ON ag_dep.ag BETWEEN lowest_sal AND highest_sal;<br><br># -------------用在exists后使用子查询------------<br># 查询有员工的部门名<br># 使用 in<br>SELECT department_name<br>FROM departments d<br>WHERE d.`department_id` IN(<br>	SELECT department_id<br>	FROM employees<br>);<br># 使用外连接<br>SELECT DISTINCT department_name<br>FROM departments d<br>INNER JOIN employees e<br>ON d.`department_id`=e.`department_id`<br>WHERE e.`employee_id` IS NOT NULL;<br><br># 使用exists<br>SELECT department_name<br>FROM departments d<br>WHERE EXISTS(<br>	SELECT *<br>	FROM employees e<br>	WHERE d.`department_id`=e.`department_id`<br>);<br></code></pre></td></tr></tbody></table></figure>
<h2 id="8、分页查询"><a href="#8、分页查询" class="headerlink" title="8、分页查询"></a>8、分页查询</h2><p>如果想要显示查询结果中的一部分，就需要使用分页查询，使用<code>limit</code>限制返回的结果开始位置和条数。</p>
<p>分页查询通常用于实际web项目中，根据用户需求提交对应页数的查询结果。</p>
<p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select 查询内容<br>from 表<br>[where 条件]<br>[group by 分组字段]<br>[having 条件]<br>[order by 排序字段]<br>limit [偏移量,] 条目数;  # 使用limit语句进行分页<br></code></pre></td></tr></tbody></table></figure>
<p>说明：</p>
<ul>
<li>偏移量从0开始，可以省略，默认为0，理解为索引-1。偏移量为0表示从第一条开始</li>
<li><code>limit</code>子句放在查询语句的最后。</li>
</ul>
<p>如果每页显示条目数为<code>sizePage</code>，当前页数为<code>page</code>，则查询语句为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select * from 表<br>limit (page-1)*sizePage,sizePage;<br></code></pre></td></tr></tbody></table></figure>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#案例1：查询第11条到第25条信息<br>SELECT * FROM  employees LIMIT 10,15;<br><br>#案例2：查询有奖金的员工中，工资较高的前10名员工信息<br>SELECT * FROM employees <br>WHERE commission_pct IS NOT NULL <br>ORDER BY salary DESC <br>LIMIT 10;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>子查询经典案例，使用排序和分页组合求最值</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 1.查询工资最低的员工姓名和工资<br>SELECT last_name,salary<br>FROM employees<br>WHERE salary = ( # 先使用子查询查找最低工资<br>	SELECT MIN(salary) FROM employees<br>);<br><br># 2.查询平均工资最低的部门信息<br>/*思路：<br>1.先查询每个部门的平均工资<br>2.筛选出平均工资中最低的部门<br>3.根据上一步的结果，查询出部门信息<br>*/<br># 方式一：<br>SELECT * FROM departments d # d.根据id，查询部门信息<br>WHERE d.`department_id` = <br>(<br>	SELECT department_id # c.找出平均工资为最低平均工资的部门id<br>	FROM employees<br>	GROUP BY department_id<br>	HAVING AVG(salary)=<br>    ( <br>		SELECT MIN(ag.a_s) # b.找出最低的平均工资<br>		FROM( # a.查询出每个部门的平均工资和id<br>			SELECT AVG(salary) a_s,department_id <br>            FROM employees<br>			GROUP BY department_id<br>			) AS ag<br>	)<br>);<br># 方式二，使用limit，求出平均工资以后进行排序，就可以直接选出部门id<br>SELECT * FROM departments d<br>WHERE d.`department_id`= <br>(<br>	SELECT department_id <br>	FROM employees<br>	GROUP BY department_id<br>	ORDER BY AVG(salary)<br>	LIMIT 1   # 递增排序中的第一条就是要查询的部门<br>);<br><br># 3.各个部门中 最高工资最低的部门的最低工资是多少<br>SELECT MIN(salary) FROM employees<br>WHERE department_id = ( # 子查询将排序和分页组合找出最值<br>	SELECT department_id <br>    FROM employees<br>	GROUP BY department_id<br>	ORDER BY MAX(salary) <br>	LIMIT 1<br>);<br><br># 4.查询平均工资最高的部门的manager信息<br>SELECT last_name,department_id,email,salary<br>FROM employees<br>WHERE employee_id=<br>( # b,根据部门id找出管理者id<br>	SELECT manager_id FROM departments<br>	WHERE department_id = <br>    (  # a,找出平均工资最高的部门id<br>		SELECT department_id FROM employees<br>		GROUP BY department_id<br>		ORDER BY AVG(salary) DESC<br>		LIMIT 1<br>	)<br>);<br></code></pre></td></tr></tbody></table></figure>
<h2 id="9、联合查询"><a href="#9、联合查询" class="headerlink" title="9、联合查询"></a>9、联合查询</h2><p>如果要查询的结果<strong>来自于多个表，且多个表没有直接的连接关系，但查询的信息一致时</strong>，可以使用<strong>联合查询</strong>。联合查询使用<code>union</code>将多次的查询结果合并成一个结果。</p>
<p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 使用union将多个查询语句合并<br>select xxx<br>union [all]<br>select xxx<br>union [all]<br>.....<br>select xxx<br></code></pre></td></tr></tbody></table></figure>
<p>说明：</p>
<ul>
<li>要求多条查询语句的查询的<strong>列数必须一致</strong></li>
<li>多条查询语句的查询的列的类型和含义尽量相同</li>
<li><code>union</code>默认去重，<code>union all</code>代表不去重</li>
</ul>
<p><strong><code>join</code>和<code>union</code>的区别</strong></p>
<ul>
<li><code>join</code>用于外连接，是根据一定的<strong>连接条件</strong>将两张表连接，并生成连接后的结果表，连接条件是<code>on</code>后面的条件。连接包括左外连接、右外连接、全连接和交叉连接。</li>
<li><code>union</code>表示联合查询，是将两个查询结果合并在一起，不需要进行表的连接。<code>union</code>连接的查询语句查询的字段个数必须一致。<code>union</code>默认去重，可以使用<code>all</code>保留全部结果。</li>
</ul>
<h1 id="六、DML语言"><a href="#六、DML语言" class="headerlink" title="六、DML语言"></a>六、DML语言</h1><p>DML指数据操作语言。</p>
<p>主要是对表格的添加（insert）、删除（delete）、修改（update）操作。</p>
<h2 id="1、insert"><a href="#1、insert" class="headerlink" title="1、insert"></a>1、insert</h2><p>向表格中插入数据有两种方式：</p>
<p><strong>方式一</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">insert into 表名(字段1,字段2,...) values(值1,值2,...);<br></code></pre></td></tr></tbody></table></figure>
<p>要求：</p>
<ul>
<li>字段类型和值类型必须一致或兼容，字段和值的顺序可以和表中不一致，但是字段和值必须一一对应。</li>
<li>可以为空的字段，如果要插入<code>null</code>值，有两种方式：①字段和值都省略，此时值默认为<code>null</code>；②字段和值都写，值为<code>null</code>。</li>
<li>不可以为空的字段，必须插入值。</li>
<li>字段个数和值的个数必须一致。</li>
<li>字段可以省略，但默认所有字段，并且顺序和表中的存储顺序一致。</li>
</ul>
<p><strong>方式二</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">insert into 表名<br>set 列名1=值,列名2=值,...;<br></code></pre></td></tr></tbody></table></figure>
<p>两种方式的对比：</p>
<ul>
<li><p>方式一支持插入多行，方式二不支持：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">INSERT INTO employees(employee_id,last_name,salary)<br>values(123,'john','15000'),<br>values(124,'jerry','12000'),<br>values(125,'mickey','11000');<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>方式一支持子查询，方式二不支持：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 查询标量<br>INSERT INTO employees(employee_id,last_name,salary)<br>SELECT 123,'john','15000';<br><br># 从表2中查询到的结果插入表1<br>INSERT INTO employees(employee_id,last_name,salary)<br>SELECT id,name,salary<br>FROM employees WHERE id&lt;3; <br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="2、update"><a href="#2、update" class="headerlink" title="2、update"></a>2、update</h2><p><strong>修改单表的记录</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">update 表名 set 字段=新值,字段=新值...<br>[where 条件];<br><br># 案例<br># 将90号部门的员工工资修改为15000<br>update employees<br>set salary=15000<br>where department_id90;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>修改多表记录</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># SQL 92语法<br>update 表1 别名1,表2 别名2<br>set 字段=新值，字段=新值...<br>where 连接条件<br>[and 筛选条件];<br><br># SQL 99语法，唯一不同的就是连接表的方式不同。其余相同<br>update 表1 别名<br>[inner]|left [outer]|right [outer] join 表2 别名<br>on 连接条件<br>set 列=值,...<br>[where 筛选条件];<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、delete"><a href="#3、delete" class="headerlink" title="3、delete"></a>3、delete</h2><p>delete表示删除表中的一条或多条记录（一行或多行），有两种方式</p>
<p><strong>方式1，使用delete</strong></p>
<p>单表的删除：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">delete from 表名 <br>[where 筛选条件]<br>[limit 条目数]<br></code></pre></td></tr></tbody></table></figure>
<p>一般会使用<code>where</code>筛选特定的记录删除，如果没有筛选条件，会删除所有的记录。</p>
<p>可以使用<code>limit</code>限定删除的条数，只能用一个参数，表示删除查询结果的前几条。</p>
<p>多表的删除（级联删除）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 同样地，也分为两种标准的语句，仅仅是连接表的时候不同，其余语句完全相同。<br># 以SQL 92为例<br>delete 别名1，别名2<br>from 表1 别名1，表2 别名2<br>where 连接条件<br>[and 筛选条件];<br></code></pre></td></tr></tbody></table></figure>
<p><strong>方式2，使用truncate</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">truncate table 表名;<br></code></pre></td></tr></tbody></table></figure>
<p><code>delete</code>和<code>truncate</code>两种方式删除记录的区别（详细对比可以参考<a href="#refer1">下文</a>）：</p>
<ul>
<li><code>truncate</code>不能加<code>where</code>条件，而<code>delete</code>可以加<code>where</code>条件，意味着<code>truncate</code>会删除表中的所有记录。</li>
<li><code>truncate</code>的效率稍高。</li>
<li><p><code>truncate</code> 删除带自增长的列的表后，如果再插入数据，数据从1开始，<code>delete</code> 删除带自增长列的表后，如果再插入数据，数据从上一次的断点处开始</p>
</li>
<li><p><code>truncate</code>删除没有返回值，<code>delete</code>删除有返回值</p>
</li>
<li><code>truncate</code>属于DDL语言，删除不能回滚，<code>delete</code>是DML语言，支持事务，可以回滚</li>
</ul>
<h1 id="七、DDL语句"><a href="#七、DDL语句" class="headerlink" title="七、DDL语句"></a>七、DDL语句</h1><p>DDL为数据定义语言。允许用户<strong>定义</strong>数据，包括创建（create）、删除（drop）、修改（alter）表和数据库，操作对象是<strong>表和数据库</strong>。通常，DDL由数据库管理员执行。</p>
<h2 id="1、create"><a href="#1、create" class="headerlink" title="1、create"></a>1、create</h2><p><strong>创建数据库</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">create database [if not exists] 库名;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>创建表</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 语法：<br>create table [if not exists] 表名(<br>	列名 列的类型[(长度) 约束],<br>	列名 列的类型[(长度) 约束],<br>	列名 列的类型[(长度) 约束],<br>	...<br>	列名 列的类型[(长度) 约束]<br>);<br><br># 例：创建名为stuinfo的表，包含的列和类型如下：<br>CREATE TABLE IF NOT EXISTS stuinfo(<br>	stuId INT,<br>	stuName VARCHAR(20),  # varchar类型必须有长度<br>	gender CHAR,<br>	bornDate DATETIME<br>);<br></code></pre></td></tr></tbody></table></figure>
<p>创建库/表的时候，可以使用<code>if not exists</code>进行判断，如果要创建的库/表不存在，则创建，否则不会创建。不能创建名字相同的两个库/表。</p>
<p><strong>表的复制</strong></p>
<p>将<code>create</code>和<code>select</code>语句结合，可以实现表的复制：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 仅复制表的结构<br>create table 新表名 like 旧表<br><br># 复制表的字段和数据<br>create table 新表名<br>select 字段列表 from 旧表 [where 筛选条件];<br><br>#仅仅复制某些字段<br>create table 新表名<br>select 字段列表 from 旧表 where false;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、alter"><a href="#2、alter" class="headerlink" title="2、alter"></a>2、alter</h2><p>修改库/表使用<code>alter</code>语句</p>
<p>修改数据库，一般很少对现有数据库进行修改：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#已废弃.现在需要去文件路径中重命名<br>RENAME DATABASE books TO 新库名; <br># 更数据库字符集<br>ALTER DATABASE books CHARACTER SET gbk;<br></code></pre></td></tr></tbody></table></figure>
<p>修改表：</p>
<p>修改表中的字段：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 添加新的列，必须指定类型<br># 新列默认在表中的位置为最后，可以使用first或after参数指定位置<br>alter table 表名 add column 列名 类型 [约束] [first|after 列名];<br><br># 删除某列（无法使用if exist进行判断）<br>alter table 表名 drop column 列名;<br><br># 修改列名<br>alter table 表名 change column 旧列名 新列名 类型;<br><br># 修改列的类型或约束<br>alter table 表名 modify column 列名 类型 [约束];<br></code></pre></td></tr></tbody></table></figure>
<p>修改表名：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 格式：<br>alter table 表名 rename [to] 新表名;<br># 案例：<br>ALTER TABLE author RENAME TO book_author;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、drop"><a href="#3、drop" class="headerlink" title="3、drop"></a>3、drop</h2><p>删除数据库：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">drop database [if exists] 库名;<br></code></pre></td></tr></tbody></table></figure>
<p>删除表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">drop table [if exists] 表名;<br></code></pre></td></tr></tbody></table></figure>
<p>同样地，删除数据库/表的时候，可以使用<code>if exists</code>判断是否存在，避免报错。</p>
<h1 id="八、约束和标识列"><a href="#八、约束和标识列" class="headerlink" title="八、约束和标识列"></a>八、约束和标识列</h1><h2 id="1、约束"><a href="#1、约束" class="headerlink" title="1、约束"></a>1、约束</h2><p>约束指的是一种限制，用于限制表中的数据，为了保证表中的数据的准确和可靠性。</p>
<p>主要有以下六大约束：</p>
<ul>
<li><code>NOT NULL</code>：非空，用于保证该字段的值不能为空。比如姓名、学号等</li>
<li><code>DEFAULT</code>：默认，用于保证该字段有默认值。比如性别</li>
<li><code>CHECK</code>：检查约束[mysql中不支持]。比如年龄、性别，检查年龄是否在某个区间内、性别是否是男或女。</li>
<li><code>PRIMARY KEY</code>：主键，用于保证该字段的值具有唯一性，并且非空。比如学号、员工编号等</li>
<li><code>UNIQUE</code>：唯一，用于保证该字段的值具有唯一性，可以为空（<code>unique key</code>可以插入多个<code>null</code>值，空值并不受唯一性约束）。比如座位号。</li>
<li><code>FOREIGN KEY</code>：外键，用于限制两个表的关系，用于保证该字段的值必须来自于主表的关联列的值在从表添加外键约束，用于引用主表中某列的值。比如学生表的专业编号（学生表为从表，专业表为主表），员工表的部门编号，员工表的工种编号。</li>
</ul>
<p>其中主键、外键、唯一键都是<code>key</code>，会默认生成索引。</p>
<blockquote>
<p><strong>关于key</strong></p>
<p><a href="https://dev.mysql.com/doc/refman/8.0/en/create-table.html">MySQL文档</a>：key是索引的近义词，可以将key理解为索引。</p>
<p><a href="https://sqlrelease.com/sql-server-tutorial/types-of-keys">参考1</a>：key是表中的字段，它们参与RDBMS系统中的以下活动<br>a.表与表中数据之间的依赖关系由key建立<br>b.标识数据的唯一性。<br>c.使表的约束有效果, 进而能够保证数据都是有效的。<br>d.有可能会提升数据库表的查询效率。</p>
<p>key 包含两层意义和作用：<br>一是约束（偏重于约束和规范数据库的结构完整性）；<br>二是索引（辅助查询用）包括primary key (主键)、unique key(唯一键)、foreign key(外键) 等</p>
</blockquote>
<p>约束可以在<strong>创建表</strong>和<strong>修改表(添加数据前)</strong>时添加。</p>
<p>添加约束有两类：</p>
<ul>
<li>列级约束：六大约束语法上都支持，但外键约束没有效果。不可以起约束名。</li>
<li>表级约束：除了非空、默认，其他的都支持。可以起约束名（约束名对于主键没有效果，一直是primary）</li>
</ul>
<p><strong>主键和唯一键对比</strong>：</p>
<ul>
<li>主键的值是唯一的，非空，一个表中最多只能有一个主键，允许多个字段组合在一起作为主键，但不推荐。</li>
<li>唯一键的值是唯一的，但是允许值为空，一个表中可以有多个唯一键，同样允许多个字段组合在一起作为唯一键，但不推荐。</li>
</ul>
<p><strong>外键</strong>：</p>
<ul>
<li>要求在从表设置外键关系</li>
<li>从表的外键列的类型和主表的关联列的类型要求一致或兼容，名称无要求</li>
<li>主表的关联列必须是一个key（一般是主键或唯一）</li>
<li>插入数据时，先插入主表，再插入从表。删除数据时，先删除从表，再删除主表：</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#方式一：级联删除，删除主表数据时，将从表中相关的记录(整行)也删除<br>#添加外键时，在最后添加 on delete cascade。例如：<br>ALTER TABLE stuinfo <br>ADD CONSTRAINT fk_stuinfo_major <br>FOREIGN KEY(majorid) <br>REFERENCES major(id) ON DELETE CASCADE; <br><br># 方式二：级联置空，删除主表数据时，将从表中相关的记录中对应的字段置为null<br>#添加外键时，在最后添加 on delete set null。例如：<br>ALTER TABLE stuinfo <br>ADD CONSTRAINT fk_stuinfo_major <br>FOREIGN KEY(majorid) <br>REFERENCES major(id) ON DELETE SET NULL; <br></code></pre></td></tr></tbody></table></figure>
<p><strong>添加约束</strong></p>
<p>列级约束，直接在类型后添加约束名</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 例如。<br>create table 表名(<br>    字段名 字段类型 not null,  # 非空<br>    字段名 字段类型 primary key,  # 主键<br>    字段名 字段类型 unique,  # 唯一键<br>    字段名 字段类型 default,  # 默认<br>    ...<br>);<br></code></pre></td></tr></tbody></table></figure>
<p>表级约束，在字段都定义完后，再为指定的列添加约束</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 语法：<br>[constraint 约束别名] 约束(字段名);<br># 例如：<br>CREATE TABLE stuinfo(<br>	id INT,<br>	stuname VARCHAR(20),<br>	gender CHAR(1),<br>	seat INT,<br>	age INT,<br>	majorid INT,<br>    <br>	CONSTRAINT pk PRIMARY KEY(id),#主键<br>	CONSTRAINT uq UNIQUE(seat),#唯一键<br>	CONSTRAINT ck CHECK(gender ='男' OR gender  = '女'),#检查（MySQL不支持）<br>	CONSTRAINT fk_stuinfo_major FOREIGN KEY(majorid) REFERENCES major(id)#外键<br>);<br></code></pre></td></tr></tbody></table></figure>
<p>如果多个字段组合作为主键或唯一键，将这几个字段都写在表级约束的括号中，逗号隔开。</p>
<p>表级约束和列级约束可以一起使用，定义外键时使用表级约束，其他约束使用列级约束即可。</p>
<p>查看表中的所有索引（主键、外键、唯一键）：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SHOW INDEX FROM 表名;<br></code></pre></td></tr></tbody></table></figure>
<p>除了在定义表时添加约束，也可以在修改表的时候添加约束：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#1、添加列级约束<br>alter table 表名 modify column 字段名 字段类型 新约束;<br><br>#2、添加表级约束<br>alter table 表名 add [constraint 约束名] 约束类型(字段名) [外键相关];<br></code></pre></td></tr></tbody></table></figure>
<p><strong>删除约束</strong></p>
<p>在修改表的语句中，也可以删除约束，一般的约束在类型后面不加约束就代表删除，对于<code>key</code>，则需要使用<code>drop</code>显式删除，具体如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#1.删除非空约束<br>ALTER TABLE stuinfo MODIFY COLUMN stuname VARCHAR(20) NULL;<br><br>#2.删除默认约束<br>ALTER TABLE stuinfo MODIFY COLUMN age INT;<br><br>#3.删除主键<br>ALTER TABLE stuinfo DROP PRIMARY KEY;<br><br>#4.删除唯一键，使用删除索引的语法<br>ALTER TABLE stuinfo DROP INDEX seat;<br><br>#5.删除外键，需要先将对应的索引删除<br>ALTER TABLE stuinfo DROP INDEX fk_stuinfo_major;<br>ALTER TABLE stuinfo DROP FOREIGN KEY fk_stuinfo_major;<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>MySQL中直接删除外键以后，外键依然存在，需要先将同名索引删除，然后再删除外键，这样查询时就不会显示外键了。</p>
<p>删除外键的时候，同名索引如果没被删，MYSQL认为外键仍然存在，MYSQL会在show keys命令里继续显示外键，当drop table时，MYSQL会提示Can’t DROP ‘xxx’; check that column/key exists”<br>如果再次想删除外键的时候，会报1091错误，提示外键名错误，因为实际上外键已经不存在了。因此MySQL中需要先将对应的索引删除，再删除外键。</p>
</blockquote>
<h2 id="2、标识列"><a href="#2、标识列" class="headerlink" title="2、标识列"></a>2、标识列</h2><p><strong>标识列</strong>又称为<strong>自增长列</strong>，可以不用手动的插入值，系统提供默认的序列值，默认从1开始。</p>
<p><strong>格式</strong>：在key的约束后面加上<code>auto_increment</code>即可。</p>
<p><strong>用法</strong>：添加数据时，标识列可以填<code>null</code>，或者不赋值，系统都会自动在已有的基础上+1。也可以手动指定值。</p>
<p><strong>特点</strong>：</p>
<ul>
<li>标识列不是必须和主键搭配，但要求是一个key。</li>
<li>一个表最多只能有一个标识列。</li>
<li>标识列的类型只能是数值型，一般是int型。如果是非int型，自动赋值时是整数，可以手动插入小数。</li>
<li>可以通过<code>SHOW VARIABLES LIKE '%auto_increment%';</code> 查看标识列的步长和默认起始值.</li>
<li>标识列可以通过<code>SET auto_increment_increment=n</code>设置步长。mysql不支持设置起始值，但可以通过手动插入值，设置起始值。</li>
</ul>
<p><strong>使用</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 创建表时设置标识列<br>CREATE TABLE tab_identity(<br>	id INT,<br>	NAME FLOAT UNIQUE AUTO_INCREMENT,<br>	seat INT <br>);<br><br># 修改表时设置标识列<br>ALTER TABLE tab_identity MODIFY COLUMN id INT PRIMARY KEY AUTO_INCREMENT;<br><br>#三、修改表时删除标识列<br>ALTER TABLE tab_identity MODIFY COLUMN id INT;<br><br></code></pre></td></tr></tbody></table></figure>
<h1 id="九、数据库事务"><a href="#九、数据库事务" class="headerlink" title="九、数据库事务"></a>九、数据库事务</h1><p><strong>TCL（Transaction Control Language）</strong>： 事务控制语言</p>
<h2 id="1、事务概述"><a href="#1、事务概述" class="headerlink" title="1、事务概述"></a>1、事务概述</h2><p><strong>事务</strong>：一个或一组SQL语句（一般是DML语句）组成的一个<strong>执行单元</strong>，这个执行单元要么全部执行，要么全部不执行。</p>
<p>DDL语句不支持事务，可以认为DDL语句执行完自动提交，因此也无法回滚。</p>
<p><strong>事务的四大特性（ACID）</strong>：</p>
<ul>
<li><strong>原子性</strong>（<strong>A</strong>tomic）：组成事务的SQL语句要么都执行，要么都不执行（回滚）。</li>
<li><strong>一致性</strong>（<strong>C</strong>onsistent）：事务完成前后，所有数据的状态都是一致的。比如A账户只要减去了100，B账户则必定加上了100。</li>
<li><strong>隔离性</strong>（<strong>I</strong>solation）：多个事务同时操作相同数据库的同一个数据时，即多个事务并发执行，每个事务作出的修改必须与其他事务隔离。</li>
<li><strong>持久性</strong>（<strong>D</strong>uration）：事务一旦提交，对数据库数据的修改被持久化到本地存储。</li>
</ul>
<p><strong>事务分类</strong>：</p>
<ul>
<li><strong>隐式事务</strong>：没有明显的开启和结束的标记，本身就是一个事务。对于单条SQL语句，数据库系统自动将其作为一个事务执行，这种事务被称为隐式事务。<strong>隐式事务系统会自动提交</strong>。</li>
<li><strong>显式事务</strong>：具有明显的开启和结束的标记，即手动开启事务。显式事务必须保证系统的自动提交功能被禁用，实际上，MySQL中显示开启事务时，自动提交是无效的，不需要手动设置。</li>
</ul>
<h2 id="2、事务的开启"><a href="#2、事务的开启" class="headerlink" title="2、事务的开启"></a>2、事务的开启</h2><p>一个完整的事务包括以下执行流程：开启事务→执行事务语句→提交或回滚。</p>
<p>事务的执行结果要么是提交，要么是回滚。</p>
<p><strong>步骤一：开启事务</strong></p>
<p>开启事务有两种方式，一种是关闭自动提交模式，隐式开启事务；另一种是显式开启事务，有两种显式开启事务的语法，具体如下：</p>
<p>方式一：<strong>关闭自动提交模式</strong>，之后遇到需要开启事务的sql时，会自动开启事务，相当于隐式开启事务:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">set autocommit=0; # 将自动提交模式关闭<br>执行语句<br></code></pre></td></tr></tbody></table></figure>
<p>方式二：<strong>显式开启事务</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 方式一：<br>start transaction;<br><br>#方式二：<br>begin;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>步骤二：执行语句</strong></p>
<p>在这一步，可以编写执行语句，包括insert、update、delete等语句。</p>
<p>DDL语言（create、drop、truncate等）是非事务的，可以理解为事务中的DDL语言执行完后会自动提交（禁用自动提交也没用），无法回滚，影响事务其他DML操作。</p>
<p>如果事务中掺杂了DDL语句，执行完DDL语句后会自动提交，导致之前的执行语句被提交，无法回滚，因此为了安全起见，尽量将DDL和DML完全分开，便于回滚。</p>
<p><strong>步骤三：结束事务</strong></p>
<p>事务的结束有两种情况：</p>
<ul>
<li><code>commit [work]</code>：提交，表示事务的执行单元都执行了。</li>
<li><code>rollback [work]</code> ：回滚，表示事务的执行单元都没执行。</li>
</ul>
<blockquote>
<p>事务相关的其他关键字：</p>
<p><code>savepoint identifier</code>：设置一个名为identifier的保存点</p>
<p><code>release savepoint identifier</code>：删除一个事务的名为identifier的保存点，当没有指定的保存点时，执行该语句会抛出一个异常；</p>
<p><code>rollback to identifier</code> ：把事务回滚到保存点。不算真正地结束事务，仍可以使用rollback将整个事务的修改撤销，因此执行了此语句后，也需要显式运行commit或rollback命令结束事务。</p>
</blockquote>
<p>事务的使用案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#开启事务，三种均可<br>#SET autocommit=0;<br>#START TRANSACTION;<br>begin;<br><br>#事务执行语句<br>UPDATE employees SET salary = 17200 WHERE username='K_ing';<br>UPDATE employees SET salary = 10000 WHERE username='Marry';<br><br>#结束事务，要么提交，要么回滚<br>ROLLBACK;<br>#commit;<br></code></pre></td></tr></tbody></table></figure>
<p><span id="refer1"><strong>drop、delete、truncate三者的区别</strong></span>：</p>
<ul>
<li>drop用于删除整个表。</li>
<li>delete可以使用筛选条件，删除表中的一行或多行记录。并且同时将该行的删除操作作为事务记录在日志中保存以便进行进行回滚操作。</li>
<li>truncate table则一次性地从表中删除所有的数据，即所有行，不能使用筛选条件。并不把单独的删除操作记录记入日志保存，操作不能恢复。</li>
<li>delete是DML语言，支持事务，delete操作可以会滚；而truncate和drop是ddl语言，不支持事务，因此无法回滚。</li>
<li>truncate和delete只删除数据，drop则删除整个表，包括结构和数据。</li>
<li>delete可以激活触发器。truncate不能激活触发器。</li>
<li>当表被truncate后，这个表和索引所占用的空间会<strong>恢复到初始大小</strong>，并且标识列也从1重新开始计数；delete操作不会减少表或索引所占用的空间，标识列还是从断点处计数。drop语句将表所占用的空间全释放掉。</li>
<li>速度上：drop&gt;truncate&gt;delete</li>
</ul>
<h2 id="3、事务的隔离级别"><a href="#3、事务的隔离级别" class="headerlink" title="3、事务的隔离级别"></a>3、事务的隔离级别</h2><p>当多个事务同时操作同一个数据库的相同数据时，容易导致并发问题，包括以下问题：</p>
<p><strong>脏写（丢失修改）</strong>：一个事务修改了其他事务还没有提交的数据，如果其他事务回滚，导致当前事务的修改丢失。事务B去修改了事务A修改过的值，但是此时事务A还没提交，所以事务A随时会回滚，导致事务B修改的值也没了。<br><strong>脏读</strong>：一个事务读取到了其他事务未提交（一般指<strong>数据修改</strong>）的数据。事务B去查询了事务A修改过的数据，但是此时事务A还没提交，所以事务A随时会回滚，导致事务B再次查询就读不到刚才事务A修改的数据了。</p>
<blockquote>
<p> 脏读和脏写都是因为一个事务去更新或者查询了另外一个还没提交的事务更新过的数据。因为另外一个事务还没提交，所以它随时可能会回滚，那么必然导致你更新的数据就没了，或者你之前查询到的数据就没了，这就是脏写和脏读两种场景。</p>
</blockquote>
<p><strong>不可重复读</strong>：同一个事务中，多次读取到的数据不一致，即中间有其他事务提交了修改（一般指<strong>数据修改</strong>）。事务A读取一个字段后，事务B更新了该字段并提交了，导致A再次读取的时候和之前不一致了，即无法重复读取到相同的某个值。</p>
<p><strong>幻读</strong>：一个事务多次读取数据时，中间有其他事务提交了更新操作（一般指<strong>插入或删除</strong>）的数据。比如同样的查询语句，第一次查询出n条，然后别的事务进行了插入或删除，第二次查询出m条，同样的查询语句得到的结果不一样，就像出现了幻觉。</p>
<p>可以通过设置<strong>隔离级别</strong>避免事务的并发问题，主要有以下四种隔离级别：</p>
<table>
    <tbody><tr>
        <td width="23%">隔离级别</td>
        <td width="10%"><b>脏读</b></td>
        <td width="10%"><b>不可重复读</b></td>
        <td width="10%"><b>幻读</b></td>
        <td width="47%"><b>说明</b></td>
    </tr>
    <tr>
        <td>read uncommitted</td>
        <td>未解决</td>
        <td>未解决</td>
        <td>未解决</td>
        <td>允许事务读取未被其他事务提交的更改</td>
    </tr>
    <tr>
        <td>read committed</td>
        <td>解决</td>
        <td>未解决</td>
        <td>未解决</td>
        <td>只允许事务读取已经被其它事务提交的更改。<b>Oracle的默认隔离级别</b></td>
    </tr>
    <tr>
        <td>repeatable read</td>
        <td>解决</td>
        <td>解决</td>
        <td>未解决</td>
        <td>确保事务可以多次从一个字段中读取相同的值，事务持续期间，禁止其他事务对这个字段更新。<b>MySQL的默认隔离级别</b></td>
    </tr>
    <tr>
        <td>serializable</td>
        <td>解决</td>
        <td>解决</td>
        <td>解决</td>
        <td>确保事务可以多次从一个表中读取相同的行，事务持续期间，禁止其他事务对该表执行插入、更新和删除操作。可以避免所有并发问题，性能最差。</td>
    </tr>
</tbody></table>



<p>上述四种隔离级别，MySQL全部支持，Oracle只支持<code>read committed</code>和<code>serializable</code>。</p>
<h2 id="4、设置隔离级别"><a href="#4、设置隔离级别" class="headerlink" title="4、设置隔离级别"></a>4、设置隔离级别</h2><p>事务的隔离级别包括<strong>全局级别</strong>和<strong>会话级别</strong>：</p>
<ul>
<li>全局级别：对后续新的所有会话连接有效，对已经存在的会话连接无效。</li>
<li>会话级别：对数据库会话连接的<strong>后续新发起或当前未提交</strong>的事务有效。如果没有session关键字的话，只对当前数据库会话连接的<strong>后续新发起</strong>的事务有效，当前未提交的事务，还是继续使用之前的事务隔离级别。</li>
</ul>
<p>设置隔离级别的语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 设置全局隔离级别<br>set global transaction isolation level 隔离级别名;<br><br># 设置当前会话连接的隔离级别<br>set [session] transaction isolation level 隔离级别名;<br></code></pre></td></tr></tbody></table></figure>
<p>查看隔离级别：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#查看当前会话隔离级别<br>select @@tx_isolation;<br>#查看全局隔离级别<br>select @@global.tx_isolation;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="5、MyISAM引擎和InnoDB引擎对比"><a href="#5、MyISAM引擎和InnoDB引擎对比" class="headerlink" title="5、MyISAM引擎和InnoDB引擎对比"></a>5、MyISAM引擎和InnoDB引擎对比</h2><p>InnoDB引擎是MySQL5.5开始引入的。InnoDB和MyISAM引擎的对比：</p>
<ul>
<li><strong>是否支持行级锁</strong>。MyISAM只支持表锁，而InnoDB支持表锁和行锁，且默认为行锁。</li>
<li><strong>是否支持事务</strong>。MyISAM不支持事务，InnoDB支持事务，具有提交和回滚事务的能力。</li>
<li><strong>是否支持外键</strong>。MyISAM不支持外键，InnoDB支持外键。</li>
<li><strong>是否支持数据库异常崩溃后的安全恢复</strong>。MyISAM不支持，InnoDB支持。InnoDB引擎能够保证，在数据库异常崩溃后，数据库重新启动的时候会保证数据库恢复到崩溃前的状态，恢复的过程依赖于<code>redo log</code></li>
</ul>
<font color="red">扩展：InnoDB是如何保证ACID特性的？</font>

<p>1、InnoDB引擎使用<strong>redo log(重做日志)</strong>保证事务的<strong>持久性</strong></p>
<p>2、InnoDB引擎使用<strong>undo log(回滚日志)</strong>保证事务的<strong>原子性</strong></p>
<p>3、InnoDB引擎使用<strong>锁机制</strong>、<strong>MVCC</strong>等手段保证事务的<strong>隔离性</strong></p>
<p>4、保证了上述三个特性后，<strong>一致性</strong>才得以保障。</p>
<h1 id="十、视图"><a href="#十、视图" class="headerlink" title="十、视图"></a>十、视图</h1><h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p>视图是MySQL 5.1的新特性。视图是一张<strong>虚拟的表</strong>，它的数据来自于表，通过执行时动态生成。视图的用法和表相同。视图只保存了SQL逻辑，没有保存查询结果，因此其几乎不占用物理空间，视图一般仅用于查询，仅仅少数情况下才能修改数据。</p>
<p>视图的优势：</p>
<ul>
<li>提高SQL语句的重用性，简化了复杂的SQL操作，提高了效率</li>
<li>和表实现了分离，提高了安全性</li>
</ul>
<h2 id="2、创建视图"><a href="#2、创建视图" class="headerlink" title="2、创建视图"></a>2、创建视图</h2><p>创建视图：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">create [or replace] view 视图名 as 查询语句;<br># 使用or replace还可以用于视图的修改<br></code></pre></td></tr></tbody></table></figure>
<p>使用案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 使用视图，查询各部门的平均工资级别<br><br># 1.创建视图查看每个部门的平均工资<br>CREATE VIEW myview AS<br>SELECT AVG(salary) ag,department_id<br>FROM employees<br>GROUP BY department_id;<br><br># 2.使用创建的视图查询<br>SELECT myview.`ag`,g.grade_level<br>FROM myview<br>JOIN job_grades g<br>ON myview.`ag` BETWEEN g.`lowest_sal` AND g.`highest_sal`;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3、删除视图"><a href="#3、删除视图" class="headerlink" title="3、删除视图"></a>3、删除视图</h2><p>删除视图：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">drop view 视图名,视图名,...;  # 可以一次删除多个视图<br><br>#案例：删除myv1，myv2，myv3三个视图<br>DROP VIEW myv1,myv2,myv3;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4、查看视图"><a href="#4、查看视图" class="headerlink" title="4、查看视图"></a>4、查看视图</h2><p>查看视图有两种方式：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#方式一：<br>DESC 视图名;<br><br>#方式二：<br>SHOW CREATE VIEW 视图名;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="5、更新视图"><a href="#5、更新视图" class="headerlink" title="5、更新视图"></a>5、更新视图</h2><p>和修改表相似，更新视图包括修改视图本身，和修改视图中的内容两部分。</p>
<p><strong>修改视图本身</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#方式一：可用于修改和创建视图<br>create or replace view  视图名<br>as 查询语句;<br><br># 方式二：<br>alter view 视图名<br>as 查询语句;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>修改视图的内容</strong></p>
<p>一般的视图只用来查询，对视图进行插入、删除、修改数据，如果能操作成功，则会对源表中的数据也会进行修改。但是绝大多数情况下无法对视图进行修改，而且也不建议对视图进行修改。</p>
<p>以下情况的视图无法更新：</p>
<ul>
<li>SQL语句包含<code>分组函数</code>、<code>distinct</code>、<code>group  by</code>、<code>having</code>、<code>union</code>或者<code>union all</code>的视图</li>
<li>常量视图</li>
<li><code>select</code>中包含子查询的视图</li>
<li>包含<code>join</code>的视图</li>
<li><code>from</code>一个不能更新的视图</li>
<li><code>where</code>子句的子查询引用了<code>from</code>子句中的表</li>
</ul>
<h1 id="十一、变量"><a href="#十一、变量" class="headerlink" title="十一、变量"></a>十一、变量</h1><p>变量包括：</p>
<ul>
<li><strong>系统变量</strong><ul>
<li>全局变量</li>
<li>会话变量</li>
</ul>
</li>
<li><strong>自定义变量</strong><ul>
<li>用户变量</li>
<li>局部变量</li>
</ul>
</li>
</ul>
<h2 id="1、系统变量"><a href="#1、系统变量" class="headerlink" title="1、系统变量"></a>1、系统变量</h2><p><strong>系统变量</strong>：变量由系统定义，不是用户定义，属于服务器层面。必须拥有super权限才能修改系统变量。</p>
<p>系统变量分为<strong>全局变量</strong>和<strong>会话变量</strong>。全局变量需要添加global关键字，会话变量需要添加session关键字，如果不写，默认为会话级别。</p>
<p><strong>全局变量</strong></p>
<p>作用域：服务器每次启动将为所有的全局变量赋初始值，针对于所有会话（连接）有效，但不能跨重启。</p>
<p>查看全局变量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 查看所有全局变量<br>SHOW GLOBAL VARIABLES;<br><br># 查看满足条件的部分系统变量<br>SHOW GLOBAL VARIABLES LIKE 'xxx';<br><br># 查看指定的系统变量的值，<br>SELECT @@global.变量名<br></code></pre></td></tr></tbody></table></figure>
<p>设置全局变量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 以autocommit为例<br># 方式一：<br>SET @@global.变量名=值;<br># 方式二：<br>SET GLOBAL 变量名=值;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>会话变量</strong></p>
<p>作用域：针对于当前会话（连接）有效</p>
<p>查看会话变量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 查看所有会话变量<br>SHOW [SESSION] VARIABLES;<br><br># 查看满足条件的部分会话变量<br>SHOW [SESSION] VARIABLES LIKE 'xxx';<br><br># 查看指定的会话变量的值<br>#SELECT @@[session.]变量名;<br># 例：<br>SELECT @@autocommit;<br># 或写成<br>SELECT @@session.autocommit;<br></code></pre></td></tr></tbody></table></figure>
<p>设置会话变量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SET @@session.变量名=值;<br>SET [SESSION] 变量名=值;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、自定义变量"><a href="#2、自定义变量" class="headerlink" title="2、自定义变量"></a>2、自定义变量</h2><p><strong>自定义变量</strong>是由用户自定义，而不是系统提供的。其分为<strong>用户变量</strong>和<strong>局部变量</strong>。</p>
<p>自定义变量的使用一般都有<strong>声明、赋值、使用</strong>（查看、比较、运算等）三个步骤。</p>
<p><strong>用户变量</strong></p>
<p>作用域：和会话变量的作用域相同，对于当前会话（连接）有效。在<code>begin end</code>里面和外面都可以使用。</p>
<p>声明用户变量，要求声明时必须初始化值。有两种赋值操作符：<code>=</code>和<code>:=</code></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#方式一<br>SET @变量名=值;<br><br>#方式二<br>SET @变量名:=值;<br><br>#方式三<br>SELECT @变量名:=值;<br></code></pre></td></tr></tbody></table></figure>
<p>为用户变量赋值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 方式一，和初始化时相同：<br>SET @变量名=值;<br>SET @变量名:=值;<br>SELECT @变量名:=值;<br><br># 方式二：<br>SELECT 字段 INTO @变量名 FROM 表;<br></code></pre></td></tr></tbody></table></figure>
<p>查看用户变量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT @变量名;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>局部变量</strong></p>
<p>作用域：仅在定义它的<code>begin end</code>块中有效。</p>
<p>声明局部变量必须在<code>begin end</code>块中的最前面部分。</p>
<p>局部变量一般不用加<code>@</code>符号，但是声明时需要指定类型，用户变量不需要指定类型。</p>
<p>声明局部变量：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">DECLARE 变量名 类型 [DEFAULT 值];<br></code></pre></td></tr></tbody></table></figure>
<p>为局部变量赋值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#方式一，同样是三种：<br>SET 局部变量名=值;<br>SET 局部变量名:=值;<br>SELECT @局部变量名:=值;<br><br>#方式二：<br>SELECT 字段 INTO 局部变量名 FROM 表;<br></code></pre></td></tr></tbody></table></figure>
<p>查看局部变量的值：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT 局部变量名;<br></code></pre></td></tr></tbody></table></figure>
<h1 id="十二、存储过程和函数"><a href="#十二、存储过程和函数" class="headerlink" title="十二、存储过程和函数"></a>十二、存储过程和函数</h1><p>存储过程和函数都是事先经过编译 并存储在数据库中的一段SQL语句的集合。</p>
<p>优势：</p>
<ul>
<li>提高了sql语句的重用性，减少了开发人员的压力</li>
<li>提高了数据处理的效率</li>
<li>减少数据在数据库和应用服务器之间的传输次数</li>
</ul>
<h2 id="1、存储过程"><a href="#1、存储过程" class="headerlink" title="1、存储过程"></a>1、存储过程</h2><p><strong>创建存储过程</strong></p>
<p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">create procedure 存储过程名(参数模式 参数名 参数类型,...)<br>begin<br>	存储过程体(一条或多条合法的SQL语句);<br>end 结束符<br></code></pre></td></tr></tbody></table></figure>
<p>参数可以有0个（比如只有插入语句）或多个。参数模式包括三种：</p>
<ul>
<li><code>IN</code>：表示该参数可以作为输入，即该参数需要调用方传入值</li>
<li><code>OUT</code>：表示该参数可以作为输出，即该参数可以作为返回值</li>
<li><code>INOUT</code>：表示该参数既可以作为输入又可以作为输出，即该参数既需要传入值，又可以返回值</li>
</ul>
<p>存储过程体如果只有一个SQL语句，可以省略<code>begin</code>和<code>end</code>，如果有多个SQL语句，<strong>每条SQL语句必须需要使用<code>;</code>结尾</strong>。</p>
<p>MySQL默认将<code>;</code>作为结束符，所以如果存储过程中有多个语句，但又希望将多个语句都执行，因此创建存储过程之前需要将修改默认的结束符。使用 <code>delimiter</code>重新设置结束符，保证过程体中的<code>;</code>被直接传递到服务器，而不会被客户端解释。例如，将<code>//</code>设置结束符的语句为：<code>delimiter //</code></p>
<p>SQLyog 10.0，定义存储过程前必须要设置结束符，生成的存储过程会自动将结束符设置为$$$$，如果没有手动将结束符改为<code>;</code>，系统会自动添加<code>delimiter ;</code>语句，因此每次创建存储过程都要重新设置结束符。</p>
<p>手写存储过程，建议在开头设置结束符，在末尾将结束符重新设置为<code>;</code></p>
<p><strong>调用存储过程</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">call 存储结构名(实参);<br># 如果是in模式的参数，可以直接传入值<br># 如果是out或inout模式的参数，必须预先定义变量，然后作为参数传入。<br></code></pre></td></tr></tbody></table></figure>
<p><strong>删除存储过程</strong></p>
<p>存储过程不能修改，一般做法是将原来的删除，然后新建。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 每次只能删除一个，不能删除多个<br>DROP PROCEDURE [IF EXISTS] 存储过程名;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>查看存储过程</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SHOW CREATE PROCEDURE 存储过程名;<br></code></pre></td></tr></tbody></table></figure>
<p>例：创建存储过程，输入员工id，输出其管理者的id和名字</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">/* 声明存储结构<br>*/<br>DELIMITER @@  # 设置结束符为@@<br># 确保存储过程能正确创建，如果已经存在，删除原有的<br>DROP PROCEDURE IF EXISTS `myp`@@<br>CREATE PROCEDURE myp(IN id INT,<br>                     OUT managerId INT,<br>                     OUT managerName VARCHAR(20))<br>BEGIN<br>	# 将查询的结果值赋给输出变量，这里参数为局部变量<br>	SELECT m.`employee_id`,m.`last_name` INTO managerId,managerName<br>	FROM employees m <br>	INNER JOIN employees e<br>	ON m.`employee_id`=e.`manager_id`<br>	WHERE e.`employee_id`=id;<br>END @@  # end后面要加设置的结束符<br>DELIMITER ;  # 将结束符改回分号<br><br>/*调用存储结构<br>in模式参数直接传入值，<br>out模式的参数要先声明，或者传入的时候指定名字<br>*/<br>CALL myp (110,@mid,@mname);  # 调用存储结构，传入参数<br>SELECT @mid,@mname;  # 查看结果值<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、函数"><a href="#2、函数" class="headerlink" title="2、函数"></a>2、函数</h2><p>函数和存储过程相似，唯一的区别是，<strong>存储过程可以有0个返回值</strong>，也可以有多个返回，适合做批量插入、批量更新；而<strong>函数有且仅有1个返回值</strong>，适合做处理数据后返回一个结果的情况。</p>
<p><strong>创建函数</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">CREATE FUNCTION 函数名(参数名 参数类型,...) RETURNS 返回类型<br>BEGIN<br>	函数体;<br>	RETURN xx;  #必须有返回值<br>END 结束符<br></code></pre></td></tr></tbody></table></figure>
<p>和存储过程相同，函数的参数也可是是0个或多个；结束符和存储过程的用法也相同；如果函数体只有一句，同样可以省略<code>begin end</code>语句。</p>
<p><strong>调用函数</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT 函数名(参数列表);  # 存储过程用的是CALL<br></code></pre></td></tr></tbody></table></figure>
<p><strong>删除函数</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 同样每次只能删除一个<br>DROP FUNCTION [IF EXISTS] 函数名; <br></code></pre></td></tr></tbody></table></figure>
<p><strong>查看函数</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SHOW CREATE FUNCTION 函数名;<br></code></pre></td></tr></tbody></table></figure>
<p>函数使用案例：根据部门名，返回该部门的平均工资</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">/*创建函数<br>*/<br>DELIMITER @@   # 先将分隔符设置为@@<br>DROP FUNCTION IF EXISTS `myf`@@<br>CREATE FUNCTION myf(deptName VARCHAR(20)) RETURNS DOUBLE<br>BEGIN<br>	#声明一个局部变量，用于接收查询结果，并返回<br>	DECLARE sal DOUBLE ;<br>	SELECT AVG(salary) INTO sal<br>	FROM employees e<br>	JOIN departments d ON e.department_id = d.department_id<br>	WHERE d.department_name=deptName;<br>	RETURN sal;  # 返回结果值<br>END @@<br>DELIMITER ;  # 将分隔符重新设置为分号<br><br>/*调用函数<br>*/<br>SELECT myf('IT');<br></code></pre></td></tr></tbody></table></figure>
<h1 id="十三、流程控制结构"><a href="#十三、流程控制结构" class="headerlink" title="十三、流程控制结构"></a>十三、流程控制结构</h1><p>流程控制结构包括以下三种：</p>
<ul>
<li>顺序结构：程序从上到下依次执行</li>
<li>分支结构：程序从两条或多条路径中选择一条去执行，比如<code>if</code>、<code>case</code>结构</li>
<li>循环结构：程序在满足一定条件的基础上，重复执行一段代码，比如<code>while</code>、<code>loop</code>、<code>repeat</code></li>
</ul>
<h2 id="1、分支结构"><a href="#1、分支结构" class="headerlink" title="1、分支结构"></a>1、分支结构</h2><p>分支结构包括<code>if结构</code>和<code>case结构</code>，只能用于<code>begin end</code>中，要和<code>if函数</code>、<code>case函数</code>区分开，<a href="#refer2">流程控制函数</a>既可以用在<code>begin end</code>里面，也可以用在外面。<code>if函数</code>适用于简单双分支，而<code>if结构</code>适用于区间判断的多分支，<code>case</code>适用于等值判断。</p>
<p><strong>if结构</strong></p>
<p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">if 条件1 then 语句1;<br>elseif 条件1 then 语句2;<br>...<br>else 语句n;<br>end if;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>case结构</strong></p>
<p>语法：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 方式一：类似于switch<br>case 表达式<br>when 值1 then 语句1;<br>when 值2 then 语句2;<br>...<br>else 语句n;<br>end case;<br><br># 方式二：类似于多重if<br>case <br>when 条件1 then 语句1;<br>when 条件2 then 语句2;<br>...<br>else 语句n;<br>end case;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>分支结构使用案例</strong></p>
<p>创建函数，实现传入成绩返回等级的功能。如果成绩&gt;90，返回A，如果成绩&gt;80，返回B，如果成绩&gt;60，返回C，否则返回D。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 方式一：使用if结构<br>DELIMITER @@   # 先将分隔符设置为@@<br>DROP FUNCTION IF EXISTS `myf_if`@@<br>CREATE FUNCTION myf_if(score FLOAT) RETURNS CHAR<br>BEGIN<br>	# 设置局部变量保存结果<br>	DECLARE ch CHAR DEFAULT 'A';<br>	IF score&gt;90 THEN SET ch='A';<br>	ELSEIF score&gt;80 THEN SET ch='B';<br>	ELSEIF score&gt;60 THEN SET ch='C';<br>	ELSE ch='D';<br>	END IF;<br>	RETURN ch;<br>END @@<br>DELIMITER ;<br>#调用函数<br>SELECT myf_if(87);<br><br># 方式二：使用case结构<br>DELIMITER @@   # 先将分隔符设置为@@<br>DROP FUNCTION IF EXISTS `myf_case`@@<br>CREATE FUNCTION myf_case(score FLOAT) RETURNS CHAR<br>BEGIN <br>	#设置局部变量保存结果<br>	DECLARE ch CHAR DEFAULT 'A';<br>	CASE <br>	WHEN score&gt;90 THEN SET ch='A';<br>	WHEN score&gt;80 THEN SET ch='B';<br>	WHEN score&gt;60 THEN SET ch='C';<br>	ELSE SET ch='D';<br>	END CASE;<br>	RETURN ch;<br>END @@<br>DELIMITER ;<br>#调用函数<br>SELECT myf_case(56);<br></code></pre></td></tr></tbody></table></figure>
<h2 id="2、循环结构"><a href="#2、循环结构" class="headerlink" title="2、循环结构"></a>2、循环结构</h2><p>循环结构包括<code>while</code>，<code>loop</code>，<code>repeat</code>三种。</p>
<p>同样，循环结构只能在<code>begin end</code>中使用。</p>
<p>循环结构中，包括两个循环控制语句：</p>
<ul>
<li><code>iterate</code>：类似于java中的continue，结束本次循环，进入下一次循环。</li>
<li><code>leave</code>：类似于java中的breek，跳出当前循环体。</li>
</ul>
<p><strong>循环控制语句后面必须有循环结构的标签名</strong>，也就是说，如果循环结构中使用了循环控制语句，此循环结构必须添加标签。</p>
<p><strong>while结构</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">[标签:] WHILE 循环条件 DO<br>	循环体<br>END WHILE [标签];<br></code></pre></td></tr></tbody></table></figure>
<p><strong>loop结构</strong></p>
<p><code>loop</code>结构没有循环条件，想要结束循环必须使用<code>leave</code>语句，<code>loop</code>结构可以用于模拟简单的死循环。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">[标签:] loop<br>	循环体;<br>end loop [标签];<br></code></pre></td></tr></tbody></table></figure>
<p><strong>repeat结构</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">[标签:] repeat<br>	循环体;<br>until 结束循环条件<br>end repeat [标签];<br></code></pre></td></tr></tbody></table></figure>
<p>使用循环结构的案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 使用存储结构和循环结构，实现批量插入，要求只插入偶数次的记录<br>DELIMITER @@   # 先将分隔符设置为@@<br>DROP PROCEDURE IF EXISTS test_while@@<br>CREATE PROCEDURE test_while(IN insertCount INT)<br>BEGIN<br>	DECLARE i INT DEFAULT 0;<br>	a: WHILE i&lt;=insertCount DO<br>		SET i=i+1;<br>		IF MOD(i,2)!=0 THEN ITERATE a;<br>		END IF;<br>		INSERT INTO admin(username,`password`) <br>		VALUES(CONCAT('xiaohua',i),'0000');<br>	END WHILE a;<br>END @@<br>DELIMITER ;<br><br># 传入100，只会插入偶数时的记录<br>CALL test_while1(100);<br></code></pre></td></tr></tbody></table></figure>]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>MySQL</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL数据库高级篇-索引和性能优化</title>
    <url>/2021/06/07/mysql-advance/</url>
    <content><![CDATA[<hr>
<p>首先需要了解MySQL的逻辑架构：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_1.png"><span class="image-caption">MySQL逻辑架构</span></p>
<p>还可以参考这篇：<a href="https://snailclimb.gitee.io/javaguide/#/docs/database/一条sql语句在mysql中如何执行的">一条 SQL 语句在 MySQL 中如何执行的</a></p>
<p>什么原因会导致SQL执行速度变慢呢？</p>
<p>1、查询语句写的有问题。</p>
<p>2、索引失效。</p>
<p>3、由于设计缺陷或者不得已的需求，导致关联查询有太多join连接。</p>
<p>4、服务器各个参数设置问题。</p>
<p>如果想要提高SQL语句执行效率，就要从以上几个方面入手，其中索引是主要的关注点。</p>
<hr>
<h1 id="一、索引介绍"><a href="#一、索引介绍" class="headerlink" title="一、索引介绍"></a>一、索引介绍</h1><h2 id="1-1-索引简介"><a href="#1-1-索引简介" class="headerlink" title="1.1 索引简介"></a>1.1 索引简介</h2><p><strong>索引（Index）</strong>是帮助MySQL高效获取数据的<strong>数据结构</strong>。除数据本身之外，数据库还维护着一个满足特定查找算法的数据结构，这些数据结构以某种方式指向数据，这样就可以在这些数据结构的基础上实现高级查找算法，这种数据结构就是<strong>索引</strong>。</p>
<p>索引的本质是数据结构。可以简单理解为<strong>“排好序的快速查找数据结构”</strong>。也就是说<strong>索引不仅可以用于查找，也可以用于排序</strong>。</p>
<p>常见的索引结构有：<strong>B树（B+树是一种扩展的B树）</strong>、<strong>Hash</strong>、<strong>R-Tree</strong>等</p>
<blockquote>
<p>B-Tree，即B树，B+Tree是一种扩展的B-Tree，读作B+树，B-Tree不是B-树。:-)</p>
</blockquote>
<h2 id="1-2-索引底层结构"><a href="#1-2-索引底层结构" class="headerlink" title="1.2 索引底层结构"></a>1.2 索引底层结构</h2><p>索引的底层数据结构有<strong>B树</strong>、<strong>哈希</strong>、<strong>R-Tree(空间数据索引)</strong>等。</p>
<p>MySQL使用的<strong>B树</strong>结构作为索引的数据结构，具体来说是使用<strong>B+树</strong>的结构实现的。这里主要讨论MySQL数据库的InnoDB引擎的B+树结构。</p>
<p>使用<code>show index from 表名;</code>可以查看指定表的索引情况，其中<code>index_type</code>为<code>BTREE</code>说明MySQL确实使用的是B树实现的索引结构，更具体点来说是用的扩展的B树，即B+树。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_2.png"><span class="image-caption">索引信息</span></p>
<h4 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h4><p><strong>哈希索引 （Hash index）</strong>基于哈希表实现，只有精确匹配索引所有列的查询才有效#4。对于每一行数据，存储引擎都会对所有的索引列计算一个哈希码(hash code)，哈希码是一个较小的值，并且不同键值的行计算出来的哈希码也不一样。哈希索引将所有的哈希码存储在索引中，同时在哈希表中保存指向每个数据行的指针。</p>
<p>在MySQL中，只有Memory引擎显式支持哈希索引。这也是 Memory引擎表的默认索引类型，Memory引擎同时也支持B-Tree索引。值得一提的是，Memory引擎是支持非唯一哈希索引的，这在数据库世界里面是比较与众不同的。如果多个列的哈希值相同，索引会以链表的方式存放多个记录指针到同一个哈希条目中。</p>
<p>Hash索引最大的优点就是<strong>能够在很短的时间内，根据 Hash 函数定位到数据所在的位置</strong>，也就是说 Hash索引检索指定数据的时间复杂度可以接近 O(1)。</p>
<font color="red">MySQL 并没有使用 Hash 索引而是使用 B+树作为索引的数据结构的原因：</font>

<ul>
<li><strong>Hash 冲突问题</strong>。</li>
<li><strong>Hash 索引不支持顺序和范围查询。</strong>这是Hash索引最大的缺点*，假如我们要对表中的数据进行排序或者进行范围查询，那 Hash 索引就无效了，会导致全表扫描。</li>
</ul>
<p>试想一种情况:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT * FROM tb1 WHERE id &lt; 500;<br></code></pre></td></tr></tbody></table></figure>
<p>Hash 索引是根据 hash 算法来定位的，在这种范围查询中，Hash索引无法处理的，而<strong>B树</strong>结构优势很大，直接遍历比500小的叶子节点即可。</p>
<h4 id="B-Tree"><a href="#B-Tree" class="headerlink" title="B-Tree"></a>B-Tree</h4><p><strong>B-Tree</strong>，即B树，<strong>多路平衡查找树</strong>，B+树是B树的一种变体。MySQL使用B树作为索引结构，但是没有直接使用B树的结构，而是使用B树的变体B+树，不同的存储引擎对于B+树的具体实现是不同的。</p>
<p><strong>B树和B+树结构对比</strong>，参考自[<a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html">MySQL索引背后的数据结构及算法原理</a>]：</p>
<ul>
<li><p>B树每个非叶子节点由n-1个key和n个指针组成，这n-1个key划分出了n个范围。这些key限定了其子节点中的最值。所有叶子节点具有相同的深度，等于树高h。</p>
</li>
<li><p>B+树的每个非叶子节点的key和指针个数相等，即n个key，n个指针，key表示子节点元素中的最大（或最小）元素。</p>
</li>
<li><p>B 树的所有节点既存放键(key)也存放数据(data)，而 B+树只有叶子节点存放 key 和 data，其他内节点只存放 key。</p>
</li>
<li><p>B 树的叶子节点都是独立的，在MySQL中为了提高区间访问的性能，在经典B+树的叶子节点中额外添加了一条引用链，指向与它<strong>相邻</strong>的叶子节点。（是双向指针，可以用来正序排序和逆序排序）</p>
<blockquote>
<p>一般所说的B+树都是MySQL这种叶子节点带顺序访问指针的B+树。</p>
</blockquote>
</li>
</ul>
<p>B树和B+树的结构图如下，来自<a href="https://zhuanlan.zhihu.com/p/149287061">知乎</a>：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_3.jpg"><span class="image-caption">B-Tree结构图</span></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_4.jpg"><span class="image-caption">B+树</span></p>
<p>上图的B+树的结点值，表示子节点元素的最大值，也可以是表示子节点元素的最小值，两种方式均可。</p>
<p>对于B+树在MySQL中的实现索引的结构，可以参考下图：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_5.png"><span class="image-caption">建立在B-Tree结构（从技术上来说是B+Tree）上的索引</span></p>
<p>B-Tree对索引是<strong>顺序组织存储</strong>的，因此很适合查找范围数据，比如一个包含last_name、first_name和dob列的索引，其B树结构（使用B+树实现）如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_6.png"><span class="image-caption">B-Tree(技术上来说是B+Tree)索引树中BUFF条目示例</span></p>
<font color="red">MySQL使用的是B+树作为索引结构的实现，而没有直接使用B树，这是为什么呢？</font>

<p>索引往往以索引文件的形式存储在磁盘上，这样索引的查找过程要产生磁盘I/O消耗，而I/O操作很耗时，I/O次数越多，查询的效率也就越低。因此索引的结构要尽量减少磁盘I/O操作次数。</p>
<ul>
<li>对于查询单个值：B 树的检索的过程相当于对范围内的每个节点的关键字做二分查找，可能还没有到达叶子节点，检索就结束了，查询性能不稳定。而 <strong>B+树的任何查找都是从根节点到叶子节点的过程，查询次数就是树的高度，检索效率稳定</strong>。</li>
<li>对于查询连续数据：由于B树在非叶子节点中存储了数据，<strong>导致查询连续数据时可能会带来更多额外I/O操作</strong>，因为叶子节点的不连续，可能会多次I/O查找目标节点，因此查询时间很长。而<strong>B+树只在叶子节点存储键和数据</strong>，其他非叶子节点只存储了键（以及指向子树的指针），并且所有叶子节点可以通过指针相互连接，<strong>减少了顺序遍历时产生的额外I/O操作</strong>，从而大大提升了效率。因此<strong>对于区间查询，B+树更简便实用</strong>。</li>
</ul>
<p>对于连续数据（范围）查找的举例，对于上图的B树和B+树，比如要查询[45,70]区间的所有节点：</p>
<p><strong>B树中的查找过程</strong>： </p>
<p>①加载根节点所在的页，发现59大于45；</p>
<p>②根据根节点指针加载左节点所在的页，发现44小于45；</p>
<p>③继续加载右节点所在的页，找到节点51；</p>
<p>④然后从51开始，进行中序遍历，重新加载44所在的节点，发现没有70，再向上加载根节点59，然后加载节点72，最后找到63。如果每次加载算一次随机I/O操作的话，一共需要7次I/O操作。如果重复加载不算次数，至少也需要5次I/O</p>
<p><strong>B+树中的过程</strong>：加载[59,97]节点-&gt;加载[15,44,59]节点-&gt;加载[51,59]节点所在的页，利用叶子节点指针顺序遍历，加载[63,72]节点所在的页。最多需要4次I/O操作。减少了额外的I/O操作</p>
<h4 id="R-Tree（空间数据索引）"><a href="#R-Tree（空间数据索引）" class="headerlink" title="R-Tree（空间数据索引）"></a>R-Tree（空间数据索引）</h4><p>以下内容来自《高性能MySQL 第3版》：</p>
<p>MyISAM表支持空间索引，可以用作地理数据存储。和B-Tree索引不同，这类索引无须前缀查询。空间索引会从所有维度来索引数据。查询时，可以有效地使用任意维度来组合查询。必须使用MySQL 的GIS相关函数如<code>MBRCONTAINS()</code>等来维护数据。MySQL的GIS支持并不完善，所以大部分人都不会使用这个特性。开源关系数据库系统中对GIS的解决方案做得比较好的是 PostgresQL的PostGIS。</p>
<h2 id="1-3-MyISAM和InnoDB索引对比"><a href="#1-3-MyISAM和InnoDB索引对比" class="headerlink" title="1.3 MyISAM和InnoDB索引对比"></a>1.3 MyISAM和InnoDB索引对比</h2><p>不同的存储引擎对于B+树的实现方式不同，以MyISAM和InnoDB引擎为例。</p>
<p><strong>MyISAM存储引擎</strong></p>
<ul>
<li>使用前缀压缩技术使得索引更小。</li>
<li>MyISAM的索引文件和数据文件是分离的，属于<strong>“非聚簇索引（或非聚集索引）”</strong>。B+树叶子节点的 <strong>data 域存放数据记录的地址</strong>。在索引检索的时候，首先按照 B+树搜索算法搜索索引，如果指定的 Key 存在，则取出其 data 域的值，然后以 data 域的值为地址读取相应的数据记录。</li>
</ul>
<p><strong>InnoDB存储引擎</strong></p>
<ul>
<li>InnoDB按照原数据格式进行存储索引。</li>
<li>而InnoDB则根据主键引用被索引的行。</li>
<li>InnoDB 引擎中，表数据文件本身就是按B+树组织的一个索引文件，树的叶节点 data 域保存了完整的数据记录。这个索引的 key 是数据表的主键id，因此<strong>InnoDB表数据文件本身就是主键索引。这被称为“聚簇索引（或聚集索引）”</strong>，而其余的索引都作为<strong>辅助索引</strong>，<strong>辅助索引的 data 域存储相应记录主键的值而不是地址</strong>，这也是和 MyISAM 不同的地方。在根据主索引搜索时，直接找到 key 所在的节点即可取出数据。而根据辅助索引查找时，则需要先取出主键的值，再走一遍主索引。 因此，在设计表的时候，不建议使用过长的字段作为主键，也不建议使用非单调的字段作为主键，这样会造成主索引频繁分裂。</li>
</ul>
<h2 id="1-4-索引种类"><a href="#1-4-索引种类" class="headerlink" title="1.4 索引种类"></a>1.4 索引种类</h2><p>从逻辑上，根据索引列是否是主键，索引可以分为<strong>主键索引（primary key）</strong>和<strong>二级索引（辅助索引）</strong>。</p>
<h3 id="1-4-1主键索引"><a href="#1-4-1主键索引" class="headerlink" title="1.4.1主键索引"></a>1.4.1主键索引</h3><p><strong>数据表的主键列使用的就是主键索引。</strong></p>
<p>InnoDB的主键索引叶子节点存放的是数据本身，即<id,row>的形式，id是主键，可以通过id找到该行的全部列数据。</id,row></p>
<p>一张数据表只能有一个主键，并且主键不能为null，不能重复。</p>
<p>在 MySQL 的InnoDB引擎的表中，当没有显式地指定表的主键时，InnoDB会自动先检查表中是否有唯一索引的字段，如果有，则选择该字段为默认的主键，否则 InnoDB将会自动创建一个 6Byte 的自增主键。</p>
<font color="red">对于InnoDB来说，其主键索引是聚簇索引，data域存储数据本身。而MyISAM的索引属于非聚簇索引，因此其主键索引的叶子节点存放的是数据地址。</font>



<h3 id="1-4-2-二级索引"><a href="#1-4-2-二级索引" class="headerlink" title="1.4.2 二级索引"></a>1.4.2 二级索引</h3><p><strong>二级索引又叫辅助索引，二级索引的叶子节点存储的数据是主键。即<index,id>的形式</index,id></strong>。</p>
<p><strong>二级索引属于非聚集索引</strong>。</p>
<p>通过二级索引，可以定位主键的位置，有需要的话再根据主键找当前行的数据。</p>
<p>唯一索引、普通索引、前缀索引等都属于二级索引：</p>
<ul>
<li><strong>唯一索引（Unique key）</strong>：唯一索引也是一种约束（唯一键）。<strong>唯一索引的属性列不能有重复的数据，允许数据为null</strong>，一张表允许创建多个唯一索引。一般来说，唯一索引的目的是为了保证数据的唯一性，而不是为了查询效率。</li>
<li><strong>普通索引（index）</strong>：<strong>普通索引的唯一作用就是为了快速查询数据，一张表允许创建多个普通索引，并允许数据重复和 NULL。</strong></li>
<li><strong>前缀索引（Prefix）</strong>：前缀索引只适用于字符串类型的数据。前缀索引是对文本的前几个字符创建索引，相比普通索引建立的数据更小， 因为只取前几个字符。</li>
<li><strong>全文索引（Full Text)</strong>：全文索引是一种特殊类型的索引，主要是为了检索大文本数据中的关键字的信息，是目前搜索引擎数据库使用的一种技术。Mysql5.6 之前只有 MYISAM 引擎支持全文索引，5.6 之后 InnoDB 也支持了全文索引。</li>
</ul>
<p>其中，如果一个索引只包含单个列，这样的索引为<strong>单值索引</strong>，一张表可以有多个单列索引。</p>
<p>类似的，<strong>复合索引</strong>指的是一个索引包含多个列。</p>
<h2 id="1-5-聚集索引和非聚集索引"><a href="#1-5-聚集索引和非聚集索引" class="headerlink" title="1.5 聚集索引和非聚集索引"></a>1.5 聚集索引和非聚集索引</h2><p>从存储结构上，索引分为<strong>聚集索引</strong>和<strong>非聚集索引</strong>。</p>
<p><strong>聚集索引和非聚集索引决定了数据库的物理存储结构，即索引结构和数据是否一起存放，主键只是逻辑上的组织方式</strong>，不同引擎的主键索引存储结构也不同。</p>
<h3 id="1-5-1-聚集索引"><a href="#1-5-1-聚集索引" class="headerlink" title="1.5.1 聚集索引"></a>1.5.1 聚集索引</h3><p><strong>聚集索引是指索引结构和数据一起存放的索引</strong>。InnoDB的主键索引属于聚集索引。</p>
<p>MySQL中InnoDB 引擎表的 <code>.ibd</code>文件就包含了该表的索引和数据，对于 InnoDB 引擎表来说，该表的索引(B+树)的每个非叶子节点存储索引，叶子节点存储索引和索引对应的<strong>数据</strong>。</p>
<h4 id="聚集索引的优点"><a href="#聚集索引的优点" class="headerlink" title="聚集索引的优点"></a>聚集索引的优点</h4><p>聚集索引的查询速度非常的快，因为整个 B+树本身就是一棵多叉平衡排序树，叶子节点也都是有序的，定位到索引的节点，就相当于定位到了数据。</p>
<h4 id="聚集索引的缺点"><a href="#聚集索引的缺点" class="headerlink" title="聚集索引的缺点"></a>聚集索引的缺点</h4><ul>
<li><p><strong>依赖于有序的数据</strong> ：因为 B+树是多路平衡树，如果索引的数据不是有序的，那么就需要在插入时排序。数据是整型的还好，如果是类似于字符串或 UUID 这种又长又难比较的数据，插入或查找的速度肯定比较慢。</p>
</li>
<li><p><strong>更新代价大</strong> ： 如果对索引列的数据修改时，那么对应的索引也将会被修改， 聚集索引的叶子节点存放着数据本身，修改代价较大， 所以对于主键索引来说，主键一般都是不可被修改的。</p>
</li>
</ul>
<h3 id="1-5-2-非聚集索引"><a href="#1-5-2-非聚集索引" class="headerlink" title="1.5.2 非聚集索引"></a>1.5.2 非聚集索引</h3><p><strong>非聚集索引即索引结构和数据分开存放的索引。</strong></p>
<p><strong>二级索引属于非聚集索引。</strong></p>
<p>MySQL中MyISAM引擎的表的<code>.MYI</code>文件包含了表的索引， 该表的索引(B+树)的每个叶子非叶子节点存储索引， 叶子节点存储索引和索引对应<strong>数据的指针</strong>，指向<code>.MYD</code>文件的数据。</p>
<p><strong>非聚集索引的data域除了存储数据地址（指针）以外，还可以存放主键</strong>，比如二级索引属于非聚簇索引，其叶子节点的data域存放的是主键，根据主键回表查询数据。</p>
<h4 id="非聚集索引的优点"><a href="#非聚集索引的优点" class="headerlink" title="非聚集索引的优点"></a>非聚集索引的优点</h4><p>由于非聚集索引的叶子节点不存放数据本身（叶子节点的data域是数据地址或主键），因此<strong>非聚集索引的更新代价比聚集索引小</strong>。</p>
<h4 id="非聚集索引的缺点"><a href="#非聚集索引的缺点" class="headerlink" title="非聚集索引的缺点"></a>非聚集索引的缺点</h4><ul>
<li>非聚集索引也依赖于有序的数据</li>
<li><strong>可能会二次查询(回表查询)</strong> ：这是非聚集索引最大的缺点。当查到索引对应的指针或主键后，可能还需要根据指针或主键再到数据文件或表中查询，也就是回表操作。</li>
</ul>
<p>非聚集索引不一定会导致回表查询，比如<strong>覆盖索引</strong>情况下就不会回表查询：</p>
<p>如果要查询的字段正好建立了索引（无论是单值索引还是复合索引，只要索引字段包括要查询的字段就可以），就属于覆盖索引，不会回表查询：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT name FROM table WHERE name='john';<br></code></pre></td></tr></tbody></table></figure>
<p>索引字段包括了<code>name</code>列，查询的时候，索引的key本身就是name，查到对应的name直接返回就行，无需回表查询数据。</p>
<p>对于MyISAM引擎中的主键索引，虽然其主键索引的叶子节点存放的是指针。但是如果 SQL 查的就是主键，也算是覆盖索引，不会导致回表查询：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT id FROM table WHERE id=1;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="1-6-覆盖索引"><a href="#1-6-覆盖索引" class="headerlink" title="1.6 覆盖索引"></a>1.6 覆盖索引</h2><p>如果一个索引<strong>包含（或者说覆盖）所有需要查询的字段的值</strong>，称为<strong>“覆盖索引（Covering Index）”</strong>。</p>
<blockquote>
<p>就是说<strong>select的数据列只从索引中就能够取得，不必读取数据行</strong>，MySQL可以利用索引返回select列表中的字段，而不必根据索引再次读取数据文件，换句话说，查询列要被所建的索引覆盖。</p>
</blockquote>
<p>比如在 InnoDB存储引擎中，如果不是主键索引，叶子节点存储的是key+主键。最终还是要“回表”，也就是要通过主键再查找一次，这样就会比较慢。覆盖索引就是要查询的列和索引是对应的，不做回表操作！</p>
<p><strong>覆盖索引即需要查询的字段正好是索引的字段，直接根据该索引就可以查到数据， 无需回表查询。</strong></p>
<p>例如：</p>
<ul>
<li>如果需要查询name，name字段有索引，那么直接根据索引就可以查找到name的值，无需回表查询。</li>
</ul>
<h2 id="1-7-索引优缺点"><a href="#1-7-索引优缺点" class="headerlink" title="1.7 索引优缺点"></a>1.7 索引优缺点</h2><h3 id="1-7-1-索引的优点"><a href="#1-7-1-索引的优点" class="headerlink" title="1.7.1 索引的优点"></a>1.7.1 索引的优点</h3><ul>
<li>索引可以加快数据的检索速度，提高检索效率，降低数据库的IO成本。</li>
<li>通过索引对数据进行排序，降低排序成本。</li>
<li>唯一性索引可以保证数据库表中每一行数据的唯一性。</li>
</ul>
<h3 id="1-7-2-索引的缺点"><a href="#1-7-2-索引的缺点" class="headerlink" title="1.7.2 索引的缺点"></a>1.7.2 索引的缺点</h3><ul>
<li>索引也是一张表，需要耗费物理空间。</li>
<li>创建索引和维护索引耗费时间长，对表中数据更改时，如果数据有索引，也要修改索引，会降低SQL执行效率。</li>
</ul>
<p>使用索引不一定会提高性能。多数情况下，索引查询比全表扫描要快，如果数据量不大，索引带来的提升也不大。</p>
<h2 id="1-8-索引的使用"><a href="#1-8-索引的使用" class="headerlink" title="1.8 索引的使用"></a>1.8 索引的使用</h2><h3 id="1-8-1-适合使用索引的情况"><a href="#1-8-1-适合使用索引的情况" class="headerlink" title="1.8.1 适合使用索引的情况"></a>1.8.1 适合使用索引的情况</h3><p>创建的索引应该尽量符合以下条件，即适合建立索引的情况：</p>
<ul>
<li><strong>不为null的字段</strong>：索引字段的数据应该尽量不为 NULL，因为对于数据为 NULL 的字段，数据库较难优化。如果字段频繁被查询，但又避免不了为 NULL，建议使用 0,1,true,false 这样语义较为清晰的短值或短字符作为替代。</li>
<li><strong>频繁查询的字段</strong>。</li>
<li><strong>频繁作为查询条件的字段</strong>：即经常出现在where条件里的字段。</li>
<li><strong>频繁需要排序的字段</strong>：因为索引是排好序的，这样查询的时候可以利用索引的排序，加快排序查询时间。</li>
<li><strong>频繁用于和其他表关联的字段</strong>：频繁用于和其他表连接的字段可能是外键列（不同于外键），对于频繁被连接查询的字段，建立索引可以提高多表连接查询的效率。</li>
<li><strong>一般情况下考虑创建组合索引而不是单列索引</strong>。索引是B+树结构，多个单列索引占用空间比一个组合索引的占用空间要大，且维护成本更高。</li>
<li><strong>查询中统计或分组的字段适合建索引</strong>。</li>
<li><strong>考虑在字符串类型的字段上使用前缀索引代替普通索引</strong>。前缀索引仅限于字符串类型，比普通索引占用更小的空间。</li>
</ul>
<h3 id="1-8-2-不适合使用索引的情况"><a href="#1-8-2-不适合使用索引的情况" class="headerlink" title="1.8.2 不适合使用索引的情况"></a>1.8.2 不适合使用索引的情况</h3><p>以下情况不适合使用索引：</p>
<ul>
<li><p>表记录太少。</p>
</li>
<li><p>频繁更新的字段，或者频繁增删改的表，不适合建立索引。因为数据更新也必须更新索引，维护索引的成本也不小，会导致更新表速度下降。</p>
</li>
<li><p>包含大量重复内容的字段不适合建立索引。索引的选择性越高，索引的效率越高。</p>
<blockquote>
<p>索引的选择性指索引列中不同值/记录总数的比值，比如100条数据，只有两种值，其选择性是0.5，如果有99种不同的值，选择性是0.99，选择性越接近于1，索引效率越高。</p>
</blockquote>
</li>
<li><p>where条件里面用不到的字段不创建索引。</p>
</li>
</ul>
<h2 id="1-9-索引创建和删除"><a href="#1-9-索引创建和删除" class="headerlink" title="1.9 索引创建和删除"></a>1.9 索引创建和删除</h2><h4 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h4><figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SHOW INDEX FROM 表名;<br></code></pre></td></tr></tbody></table></figure>
<h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><p>为了可读性，索引名一般命名为<code>idx_表名_列名</code>的格式，比如student表中的学号age的索引名：<code>idx_student_age</code></p>
<p><strong>1、添加主键索引（primary key）</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">ALTER TABLE 表名 ADD PRIMARY KEY (列名);   # 指定列作为主键，会自动创建主键索引。<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、添加唯一索引（UNIQUE）</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">ALTER TABLE 表名 ADD UNIQUE (列名);<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、添加普通索引（INDEX）</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 写法1<br>ALTER TABLE 表名 ADD INDEX 索引名 (列名);<br><br># 写法2<br>CREATE INDEX 索引名 ON 表名 (列名);<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、添加全文索引（FULLTEXT）</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">ALTER TABLE 表名 ADD FULLTEXT (列名);<br></code></pre></td></tr></tbody></table></figure>
<p><strong>5、添加复合索引</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 写法1<br>ALTER TABLE 表名 ADD INDEX 索引名 (列名1,列名2,...);<br><br># 写法2<br>CREATE INDEX 索引名 ON 表名 (列名1,列名2,...);<br></code></pre></td></tr></tbody></table></figure>
<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><p><strong>1、删除主键索引</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">ALTER TABLE stuinfo DROP PRIMARY KEY;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、删除一般索引</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 写法1<br>ALTER TABLE 表名 DROP INDEX 索引名;<br><br># 写法2<br>DROP INDEX 索引名 ON 表名;<br></code></pre></td></tr></tbody></table></figure>
<h1 id="二、索引优化分析"><a href="#二、索引优化分析" class="headerlink" title="二、索引优化分析"></a>二、索引优化分析</h1><h2 id="2-1-性能分析"><a href="#2-1-性能分析" class="headerlink" title="2.1 性能分析"></a>2.1 性能分析</h2><h3 id="2-1-1-MySQL-Query-Optimizer"><a href="#2-1-1-MySQL-Query-Optimizer" class="headerlink" title="2.1.1 MySQL Query Optimizer"></a>2.1.1 MySQL Query Optimizer</h3><p>MySQL Query Optimizer是MySQL中专门负责优化SELECT语句的优化器，其主要功能是通过计算分析系统中收集到的统计信息，为客户端请求的Query提供它认为最优的执行计划（优化器认为最优的数据检索方式，不一定是开发人员认为是最优的，这部分最耗费时间)。</p>
<p>当客户端向MySQL请求一条Query，命令解析器模块完成请求分类，区别出是SELECT并转发给查询优化器，MySQL Query Optimizer首先会对整条Query进行优化，处理掉一些常量表达式的预算，直接换算成常量值。并对Query中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整等。然后分析Query 中的 Hint 信息(如果有)，看显示Hint信息是否可以完全确定该Query 的执行计划。如果没有Hint 或Hint信息还不足以完全确定执行计划，则会读取所涉及对象的统计信息，根据 Query进行写相应的计算分析,然后再得出最后的执行计划。</p>
<h3 id="2-1-2-MySQL常见瓶颈"><a href="#2-1-2-MySQL常见瓶颈" class="headerlink" title="2.1.2 MySQL常见瓶颈"></a>2.1.2 MySQL常见瓶颈</h3><ul>
<li>CPU：数据装入内存或从磁盘上读取数据的时候，可能会导致CPU饱和。</li>
<li>IO：磁盘I/O瓶颈发生在装入数据远大于内存容量的时候。</li>
<li>服务器硬件的性能瓶颈：可以通过<code>top</code>，<code>free</code>，<code>iostat</code>，<code>vmstat</code>指令查看系统的性能状态。</li>
</ul>
<h3 id="2-1-3-Explain"><a href="#2-1-3-Explain" class="headerlink" title="2.1.3 Explain"></a>2.1.3 Explain</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>使用EXPLAIN关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理SQL查询语句的。</p>
<p>Explain关键字用于分析查询语句或是表结构的性能瓶颈。官网介绍：<a href="https://dev.mysql.com/doc/refman/8.0/en/execution-plan-information.html">链接</a></p>
<p>使用方法为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">EXPLAIN 查询语句;<br><br># 举例：<br>EXPLAIN SELECT * FROM staffs WHERE name='july' AND age=20 AND pos='dev';<br></code></pre></td></tr></tbody></table></figure>
<h4 id="Explain的作用"><a href="#Explain的作用" class="headerlink" title="Explain的作用"></a>Explain的作用</h4><ul>
<li>可以得知表的读取顺序。</li>
<li>可以得知数据读取操作的操作类型</li>
<li><strong>可以得知哪些索引可以使用、实际使用了哪些索引。</strong></li>
<li>可以得知表之间的引用。</li>
<li>可以得知每张表有多少行被优化器查询。</li>
<li><strong>可以得知是否使用filesort或者temporary（临时表）等操作。</strong></li>
</ul>
<h4 id="Explain结果分析"><a href="#Explain结果分析" class="headerlink" title="Explain结果分析"></a>Explain结果分析</h4><p>执行Explain+SQL语句以后，输出的结果有以下几种类型：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_7.png"><span class="image-caption">Explain结果类型</span></p>
<p>每一行表示一张表的查询，包括实际存在的表和临时表（子查询重命名的表）。</p>
<p>其中各字段的含义如下。</p>
<font color="red">id</font>

<p>表示select查询的序列号，表示查询中执行select子句或操作表的顺序。</p>
<ul>
<li>如果id相同，则执行顺序从上往下依次执行，</li>
<li>如果id不同，id越大执行优先级越高，一般是最里层的子查询id最大，最先执行。</li>
<li>如果id既有相同的也有不同的，则可以认为相同id的为一组，按照前两条规则执行</li>
</ul>
<p>例如：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_8.png"><span class="image-caption">既有相同id，也有不同id的情况</span></p>
<p>上图的例子中，可以看到，先执行id为2的语句，再依次往下执行id为1的语句。</p>
<font color="red">select_type</font>

<p>表示查询的类型，主要是用于区别普通查询、联合查询、子查询等复杂查询。包括以下集中状态：</p>
<ul>
<li><strong>SIMPLE</strong>：表示简单的select查询，查询中不包含子查询或UNION。</li>
<li><strong>PRIMARY</strong>：查询中若包含任何复杂的子部分，最外层的查询就会被标记为PRIMATY。</li>
<li><strong>SUBQUERY</strong>：子查询，出现在select或where列表中的子查询会被标记为SUBQUERY。</li>
<li><strong>DERIVED</strong>：在FROM列表中包含的子查询被标记为DERIVED（衍生），MySQL会递归执行这些子查询，把结果放在临时表里。</li>
<li><strong>UNION</strong>：出现在UNION之后的select语句就会被标记为UNION。</li>
<li><strong>UNION RESULT</strong>：从UNION表中获取结果的SELECT。</li>
</ul>
<p>如图中的例子</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_9.png"><span class="image-caption">select_type举例</span></p>
<font color="red">table</font>

<p>表示这一行是关于哪张表的。</p>
<font color="red">type</font>

<p>展示了查询使用了何种类型。</p>
<p>type的结果值从好到坏依次是：<strong>system</strong> &gt; <strong>const </strong>&gt; <strong>eq_ref </strong>&gt; <strong>ref </strong>&gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; <strong>range </strong>&gt; <strong>index</strong> &gt; <strong>ALL</strong>。</p>
<p>其中常见的几种类型，从好到坏依次是：</p>
<ul>
<li><p><strong>system</strong>：表只有一行记录（等于系统表），这是const类型的特例，平时不会出现，可以忽略不计。</p>
</li>
<li><p><strong>const</strong>：表示通过索引一次就找到了，const用于比较PRIMARY KEY和UNIQUE索引，因为只匹配一行数据，所以很快。比如where条件中是主键，MySQL能将该查询转换为一个常量。</p>
<blockquote>
<p>举例：<code>explain select * from t1 where id = 1;</code></p>
</blockquote>
</li>
<li><p><strong>eq_ref</strong>：唯一性索引扫描，对于每个索引键，表中只有一条记录与之匹配，常见于主键或唯一索引扫描。</p>
<blockquote>
<p>举例：<code>explain select * from t1,t2 where t1.id = t2.id;</code>，t2中只有一条数据与之对应，因此类型是eq_ref.</p>
</blockquote>
</li>
<li><p><strong>ref</strong>：非唯一性索引扫描，返回匹配某个单独值的所有行。本质上也是一种索引访问，它返回所有匹配某个单独值的行，然而，它可能会找到多个符合条件的行，所以它应该属于查找和扫描的混合体。</p>
<blockquote>
<p>举例：<code>explain select * from t1 where col1='ac';</code>，其中t1中的索引为<code>idx_t1_clo1_col2</code>。t1中符合条件的数据有多条，因此类型为ref。</p>
</blockquote>
</li>
<li><p><strong>range</strong>：只检索给定范围的行，使用一个索引来选择行。一般在where语句中出现了<code>between</code>、<code>&lt;</code>、<code>&gt;</code>、<code>in</code>等关键字的查询语句中会出现range类型。这种范围扫描索引扫描比全表扫描要好，因为它只需要开始于索引的某一点，而结束于另一点，不用扫描全部索引。</p>
<blockquote>
<p>举例：<code>explain select * from t1 where id between 30 and 60;</code></p>
</blockquote>
</li>
<li><p><strong>index</strong>：Full Index Scan，index和ALL的区别是index类型只遍历索引树。这通常比ALL快，因为索引文件通常比数据文件小。就是说虽然index和ALL都是读全表，但是index是从索引中读取的，而ALL是从硬盘中读取的。</p>
<blockquote>
<p>举例：<code>explain select id from t1;</code>，id为主键。</p>
</blockquote>
</li>
<li><p><strong>ALL</strong>：Full Table Scan，遍历全表找到匹配的行。</p>
<blockquote>
<p>举例：<code>explain select * from t1 where column_without_index = ' ';</code>，对于没有索引的查询条件，需要扫描全表，效率最差。</p>
</blockquote>
</li>
</ul>
<p><strong>一般来说，得保证查询至少达到range级别，最好能达到ref级别。</strong></p>
<font color="red">possible_keys</font>

<p>显示<strong>可能</strong>应用在这张表中的索引，一个或多个。</p>
<p>如果查询涉及的字段上存在索引，则该索引将被列出，但不一定被查询实际使用。</p>
<font color="red">key</font>

<p>实际使用的索引。如果为NULL，表明没有用到索引。</p>
<p>如果查询中使用了覆盖索引，则该索引仅出现在key列表中，不会在possible_keys中出现。</p>
<p>比如下面的例子，对col1和col2建立了复合索引，查询内容为col1和col2，是覆盖索引。因此，possible_keys的值为NULL，索引<code>idx_col1_col2</code>只出现在key列表中。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_10.png"><span class="image-caption">覆盖索引的例子</span></p>
<font color="red">key_len</font>

<p>表示索引中使用的字节数，可通过该列计算出查询中使用的索引长度（即使用了几列的索引）。</p>
<p>在不损失精确性的情况下，长度越短越好。key_len显示的值为索引字段的最大可能长度，<strong>并非实际使用长度</strong>，即key_len是根据表定义计算而得，不是通过表内检索出的。</p>
<p>如下图的例子，使用到一个列索引时key_len值为13字节，使用到两个索引列时，key_len的值为26字节。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_11.png"><span class="image-caption">key_len例子</span></p>
<font color="red">ref</font>

<p>表示哪些列或常量被用于查找索引列上的值。</p>
<p>如图中的例子，第二行ref的shared.t2.col1表示使用t1中的索引查询时，使用到了t2的col1这一列，const表示使用到了常量，即常量’ac’。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_12.png"><span class="image-caption">ref例子</span></p>
<font color="red">rows</font>

<p>根据表统计信息和索引选用情况，大致估算出找到所需记录需要读取的行数。</p>
<p>如下面的例子：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_13.png"><span class="image-caption">rows优化案例</span></p>
<p>第一条查询语句是没有索引时查询的情况，可以看到表t2需要读取的行数为640；第二条查询语句在t2上建立了索引，这时表t2使用到了索引，所需读取的行数从640优化到了142。</p>
<font color="red">Extra</font>

<p>包含不适合在其它列中显示但十分重要的额外信息。</p>
<p>Extra包括以下几个值：</p>
<ul>
<li><font color="red">Using filesort</font>：说明MySQL会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。MySQL无法利用索引完成的排序操作称作”文件排序“。出现这种情况会严重拖慢效率。比如对col1和col2两列建立复合索引，但是select中的ORDER BY子句不是按照col1和col2的顺序排序，就会导致索引失效，并出现using filesort。</li>
<li><font color="red">Using temporary</font>：说明使用了临时表保存中间结果，MySQL对查询结果排序时使用临时表。常见于排序ORDER BY和分组GROUP BY。这种情况比Using filesort还要糟糕。</li>
<li><font color="green">Using index</font>：表示相应的select操作中使用了索引覆盖，避免了访问表的数据行，是我们希望看到的。其中，如果同时出现了using where，表示索引被用来根据索引键值查找数据（即根据索引值判断数据是否是符合条件的值）。如果没有同时出现using where，表示索引用来读取数据（仅读取索引值），而非执行查找动作。</li>
<li>Using where：表明使用了where过滤。</li>
<li>using join buffer：使用了连接缓存。</li>
<li>impossible where：表明where子句的值总是false，不会有符合条件的数据。</li>
<li>select tables optimized away：没有GROUP BY子句的情况下，基于索引优化MIN、MAX操作或者对于MyISAM存储引擎优化COUNT(*)操作，不必等到执行阶段再进行计算，查询执行计划生成的阶段即完成优化。</li>
<li>distinct：优化distinct操作，在找到第一匹配的元组后即停止找同样值的动作。</li>
</ul>
<p><strong>Explain例题</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_14.png"><span class="image-caption">Explain例题</span></p>
<p>对以上信息，分析如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_15.png"><span class="image-caption">分析内容</span></p>
<h2 id="2-2-索引优化"><a href="#2-2-索引优化" class="headerlink" title="2.2 索引优化"></a>2.2 索引优化</h2><h3 id="2-2-1-索引分析"><a href="#2-2-1-索引分析" class="headerlink" title="2.2.1 索引分析"></a>2.2.1 索引分析</h3><h4 id="单表案例"><a href="#单表案例" class="headerlink" title="单表案例"></a>单表案例</h4><p>建表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">CREATE TABLE IF NOT EXISTS article(<br>id INT(10) UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,<br>author_id INT(10) UNSIGNED NOT NULL,<br>category_id INT(10) UNSIGNED NOT NULL,<br>views INT(10) UNSIGNED NOT NULL,<br>comments INT(10) UNSIGNED NOT NULL,<br>title VARBINARY(255) NOT NULL,<br>content TEXT NOT NULL<br>);<br><br>INSERT INTO article(author_id,category_id,views,comments,title,content)<br>VALUES(1,1,1,1,'1','1'),<br>(2,2,2,2,'2','2'),<br>(1,1,3,3,'3','3');<br></code></pre></td></tr></tbody></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_16.png"><span class="image-caption">article表</span></p>
<p>逐步优化过程：</p>
<p><strong>1、初始时，表格没有普通索引，执行下列语句</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">EXPLAIN SELECT id,author_id FROM article <br>WHERE category_id=1 AND comments&gt;1 <br>ORDER BY views DESC\G<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>末尾的\G表示以键值对的形式显示内容，不需要加分号。</p>
</blockquote>
<p>结果为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">*************************** 1. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: article<br>         type: ALL<br>possible_keys: NULL<br>          key: NULL<br>      key_len: NULL<br>          ref: NULL<br>         rows: 3<br>        Extra: Using where; Using filesort<br>1 row in set (0.00 sec)<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到type为<code>ALL</code>，表示全表扫描，并且出现了<code>Using filesort</code>。</p>
<p>接下来尝试对其优化。</p>
<p><strong>2、第一次优化：尝试对where条件和order by中设计的三个列都建立索引：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 对三个列建立索引<br>CREATE INDEX idx_article_ccv ON article(category_id,comments,views);<br># 再次执行SQL语句<br>EXPLAIN SELECT id,author_id FROM article <br>WHERE category_id=1 AND comments&gt;1 <br>ORDER BY views DESC\G<br></code></pre></td></tr></tbody></table></figure>
<p>初步优化后，Explain语句运行结果为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">*************************** 1. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: article<br>         type: range<br>possible_keys: idx_article_ccv<br>          key: idx_article_ccv<br>      key_len: 8<br>          ref: NULL<br>         rows: 1<br>        Extra: Using index condition; Using filesort<br>1 row in set (0.00 sec)<br></code></pre></td></tr></tbody></table></figure>
<p>可见，第二次运行用到了我们建立的索引，并且type变为了<code>range</code>，表示范围内查找，比<code>ALL</code>效率提升了，但是<code>Using filesort</code>还在。</p>
<p>为什么建立了索引，还出现了<code>Using filesort</code>呢？</p>
<ul>
<li><p>根据B+树索引的结构分析可知，对category_id、comments、views三列建立复合索引，在B+树中是先根据category_id排序，category_id相同时，根据comments排序，views同理，这样就建立起一个排好序的索引B+树结构。</p>
</li>
<li><p>查询条件中，由于第二个条件是comments&gt;1，是个范围，因此会导致其后面的列，即views列的索引失效。因为第二列是个范围，查询时需要遍历所有范围内的索引，因此第三列的索引用不到了，根据views排列时用不到索引就需要使用文件排序。</p>
</li>
</ul>
<p>经过以上分析，可知，假如第二个条件也是常量，索引就不会失效，从而也不会导致<code>Using filesort</code>:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">EXPLAIN SELECT id,author_id FROM article <br>WHERE category_id=1 AND comments=1 <br>ORDER BY views DESC\G<br></code></pre></td></tr></tbody></table></figure>
<p>上述语句的结果为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">*************************** 1. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: article<br>         type: ref<br>possible_keys: idx_article_ccv<br>          key: idx_article_ccv<br>      key_len: 8<br>          ref: const,const<br>         rows: 1<br>        Extra: Using where<br>1 row in set (0.00 sec)<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，type变为了<code>ref</code>，根据ref可知用到了两个常量，即前两个索引值都是固定的常量，因此根据索引的第三个列进行排列（正序倒序都可以）时，可以用到索引，因此没有了<code>Using filesort</code>。</p>
<p>如果针对第一次的SQL语句优化，可以考虑不对第二列建立索引。</p>
<p><strong>3、第二次优化，删除第一次建的索引，重新只对category_id和views两列建立索引</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 删除第一次建立的索引<br>DROP INDEX idx_article_ccv ON article;<br># 只对category_id和views建立索引<br>CREATE INDEX idx_article_cv ON article(category_id,views);<br># 再次执行SQL语句<br>EXPLAIN SELECT id,author_id FROM article <br>WHERE category_id=1 AND comments&gt;1 <br>ORDER BY views DESC\G<br></code></pre></td></tr></tbody></table></figure>
<p>这次的结果：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">*************************** 1. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: article<br>         type: ref<br>possible_keys: idx_article_cv<br>          key: idx_article_cv<br>      key_len: 4<br>          ref: const<br>         rows: 2<br>        Extra: Using where<br>1 row in set (0.00 sec)<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，这次用到索引的同时，没有了<code>Using filesort</code>，因为两列的索引都用到了。</p>
<p><strong>总结</strong>：经过第一个案例可知，<strong>如果索引遇到范围，则其后面列的索引全部失效。</strong></p>
<h4 id="两表案例"><a href="#两表案例" class="headerlink" title="两表案例"></a>两表案例</h4><p>class表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">mysql&gt; select * from class;<br>+----+------+<br>| id | card |<br>+----+------+<br>|  1 |   18 |<br>|  2 |   18 |<br>|  3 |   16 |<br>|  4 |    7 |<br>|  5 |    5 |<br>|  6 |    3 |<br>|  7 |   19 |<br>|  8 |    5 |<br>|  9 |    7 |<br>| 10 |   20 |<br>| 11 |   20 |<br>| 12 |   19 |<br>| 13 |   16 |<br>| 14 |    3 |<br>| 15 |    6 |<br>| 16 |   19 |<br>| 17 |   16 |<br>| 18 |    3 |<br>| 19 |    5 |<br>| 20 |   17 |<br>+----+------+<br>20 rows in set (0.00 sec)<br></code></pre></td></tr></tbody></table></figure>
<p>book表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">mysql&gt; select * from book;<br>+--------+------+<br>| bookid | card |<br>+--------+------+<br>|     11 |    1 |<br>|     14 |    3 |<br>|      8 |    4 |<br>|     15 |    4 |<br>|      6 |    5 |<br>|     18 |    7 |<br>|     19 |    7 |<br>|      7 |    8 |<br>|     17 |    9 |<br>|      1 |   10 |<br>|      4 |   10 |<br>|     16 |   13 |<br>|     20 |   13 |<br>|     10 |   15 |<br>|      3 |   16 |<br>|      2 |   17 |<br>|     13 |   17 |<br>|      9 |   18 |<br>|      5 |   19 |<br>|     12 |   20 |<br>+--------+------+<br>20 rows in set (0.00 sec)<br></code></pre></td></tr></tbody></table></figure>
<p><strong>1、第一次查询，没有任何索引</strong>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card=book.card;<br></code></pre></td></tr></tbody></table></figure>
<p>执行结果为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">*************************** 1. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: class<br>         type: ALL<br>possible_keys: NULL<br>          key: NULL<br>      key_len: NULL<br>          ref: NULL<br>         rows: 20<br>        Extra: NULL<br>*************************** 2. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: book<br>         type: ALL<br>possible_keys: NULL<br>          key: NULL<br>      key_len: NULL<br>          ref: NULL<br>         rows: 20<br>        Extra: Using where; Using join buffer (Block Nested Loop)<br>2 rows in set (0.00 sec)<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，在两个表上的查询，type都是<code>ALL</code>，rows都是20。</p>
<p><strong>2、如果仅在左连接的右边的表中对应列建立索引：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 在book表的card列上建立索引 Y，此时表中仅有一个普通索引Y<br>ALTER TABLE book ADD INDEX Y (card);<br># 此时左连接的右表，type变为ref，且rows是1<br>EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card=book.card;<br></code></pre></td></tr></tbody></table></figure>
<p>执行结果为：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">*************************** 1. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: class<br>         type: ALL<br>possible_keys: NULL<br>          key: NULL<br>      key_len: NULL<br>          ref: NULL<br>         rows: 20<br>        Extra: NULL<br>*************************** 2. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: book<br>         type: ref<br>possible_keys: Y<br>          key: Y<br>      key_len: 4<br>          ref: db01.class.card<br>         rows: 1<br>        Extra: Using index<br>2 rows in set (0.01 sec)<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，在class表中的rows仍然是20，但是book表中的rows从20变为了1，且type也从ALL变为了ref，因为用到了建立的索引Y，说明索引Y起到了优化作用。因为有了索引，每次内循环从book表中查询时，只需要根据索引遍历一行数据即可，所以rows是1。</p>
<p><strong>3、如果仅在左连接的左边的表中对应列建立索引</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">#将上一步的索引删掉，然后对表class的card建立索引X<br>DROP INDEX Y ON book;<br>ALTER TABLE class ADD INDEX X (card);<br># 此时book表中无索引，class表的card列有一个索引x<br>EXPLAIN SELECT * FROM class LEFT JOIN book ON class.card=book.card;<br></code></pre></td></tr></tbody></table></figure>
<p>执行结果为:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">*************************** 1. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: class<br>         type: index<br>possible_keys: NULL<br>          key: X<br>      key_len: 4<br>          ref: NULL<br>         rows: 20<br>        Extra: Using index<br>*************************** 2. row ***************************<br>           id: 1<br>  select_type: SIMPLE<br>        table: book<br>         type: ALL<br>possible_keys: NULL<br>          key: NULL<br>      key_len: NULL<br>          ref: NULL<br>         rows: 20<br>        Extra: Using where; Using join buffer (Block Nested Loop)<br>2 rows in set (0.00 sec)<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，class表中虽然用到了索引，type是index，但是rows仍然是20，book表中没有索引因此也是20。</p>
<p>通过以上实验可知，对于左连接，如果对右表的对应列建立索引，优化效果更好。</p>
<p>同理，对于右连接，对左表的对应列建立索引，优化效果更好。</p>
<p>因此，<strong>左连接的右表和右连接的左表是优化的重点。</strong></p>
<h4 id="三表案例"><a href="#三表案例" class="headerlink" title="三表案例"></a>三表案例</h4><p>这次我们使用三表连接：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 对三个表的card列都建立索引<br>ALTER TABLE class ADD INDEX X(card);<br>ALTER TABLE book ADD INDEX Y(card);<br>ALTER TABLE phone ADD INDEX Z(card);<br># 执行三表连接查询语句<br>EXPLAIN SELECT * FROM class <br>LEFT JOIN book ON class.`card`=book.`card` <br>LEFT JOIN phone ON book.`card`=phone.`card`;<br></code></pre></td></tr></tbody></table></figure>
<p>执行结果：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_17.png"><span class="image-caption">三表连接查询</span></p>
<p>与两表案例类似，无论是否用到索引，最外层的表，即这里的class表，rows一直是20，而book和phone可以通过索引将row降到1。</p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>1、通过单表案例可以总结出：<strong>如果索引遇到范围，则其后面列的索引全部失效。</strong></p>
<p>2、根据两表和三表案例，可以总结出优化建议：</p>
<ul>
<li>对于多表连接查询，优化的重点是内层的表，即优化被驱动表带来的效率提升较大。应<strong>尽可能减少Join语句中嵌套循环的总次数</strong>。（通过被驱动表建立索引，可以降低循环次数）。</li>
<li><strong>永远要用小结果集驱动大结果集，即小表驱动大表</strong>，就是说，要将小表作为驱动表，大表作为被驱动表。</li>
<li><strong>在被驱动表上的Join的字段建立索引</strong>，可以降低总循环次数，从而提升效率。</li>
<li>无法保证被驱动表的Join条件字段被索引且内存资源充足的前提下，不要太吝啬JoinBuffer的设置。</li>
</ul>
<p>左连接中，左表是<strong>驱动表</strong>，右表是<strong>被驱动表</strong>。</p>
<p>右连接中，右表是<strong>驱动表</strong>，左表是<strong>被驱动表</strong>。</p>
<p>内连接时，MySQL自动选择数据量小的表作为驱动表，即小表驱动大表。</p>
<font color="red">为什么要用小表驱动大表？或者说为什么小表驱动大表效率较高？</font>

<p>解答这个问题前，需要了解嵌套循环的效率对比。</p>
<p>嵌套循环的<strong>连接次数</strong>是取决于外层循环的，循环体的循环次数不变，如果连接次数越少，则效率越高。</p>
<p>比如：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//循环1</span><br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">10</span>;i++){<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">1000</span>;j++){<br>        <span class="hljs-comment">//循环体</span><br>    }<br>}<br><span class="hljs-comment">//循环2</span><br><span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">1000</span>;i++){<br>    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">10</span>;j++){<br>        <span class="hljs-comment">//循环体</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>两个循环的循环体执行次数相同的，但是循环1的执行速度要比循环2快，因为循环1中，i和j初始化的初始化次数分别为1、10次，而循环2中i和j的初始化次数分别是1,、1000次，且循环1的连接次数是10，循环2的连接次数是1000，因此循环1速度快于循环2。<a href="https://blog.csdn.net/taohuaxinmu123/article/details/31419701">参考</a></p>
<p><strong>MySQL中的连接查询，正是类似于嵌套循环</strong>。</p>
<p>以左查询为例，比如SQL语句：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SELECT * FROM A LEFT JOIN B ON A.c=B.c;<br></code></pre></td></tr></tbody></table></figure>
<p>以上连接查询语句可以理解为一个双重for循环，即：</p>
<figure class="highlight n1ql"><table><tbody><tr><td class="code"><pre><code class="hljs n1ql">for(循环次数为A的行数){<br>	<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> A <span class="hljs-keyword">where</span> 第i行;<br>	for(循环次数不确定，直到找到B中符合条件的行位置){<br>		<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> B <span class="hljs-keyword">where</span> B.c=A.c<br>	}<br>} <br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，<strong>驱动表相当于多重for循环的外层循环，被驱动表相当于内层循环。因此驱动表（外层循环）小于被驱动表（内层循环）时，效率较高</strong>。</p>
<font color="red">为什么要在被驱动表建立索引？</font>

<p>驱动表无论是否有索引，都要遍历所有行，而被驱动表则不是这样。从上述for循环的例子可知，对于驱动表A中的当前行，从<strong>被驱动表B中查询的次数和是否用到了索引有关</strong>。如果没有索引，则会遍历被驱动表B的所有行，找到所有符合当前A.c值的行；如果表B的c行建立了索引，则会根据索引，直接找到所有符合当前A.c值的行，不必遍历所有行。</p>
<p>上述案例中，建立索引之后的rows从20（没有索引，需要遍历所有行）降为了1（有了索引，只需根据索引进行查找）。</p>
<h3 id="2-2-2-避免索引失效"><a href="#2-2-2-避免索引失效" class="headerlink" title="2.2.2 避免索引失效"></a>2.2.2 避免索引失效</h3><p>从上一节的例子中可以看到，有时候虽然建立了索引，但是遇到了范围，导致了索引失效。有哪些情况会导致索引失效呢？</p>
<p>下面以staff表说明各种索引失效的情况：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_18.png"><span class="image-caption">staff表格内容</span></p>
<p>对staff表的<code>name</code>,<code>age</code>,<code>pos</code>三列建立复合索引<code>idx_staffs_nameAgePos</code>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">ALTER TABLE staffs ADD INDEX idx_staffs_nameAgePos(name,age,pos);<br></code></pre></td></tr></tbody></table></figure>
<h4 id="索引失效的情况"><a href="#索引失效的情况" class="headerlink" title="索引失效的情况"></a>索引失效的情况</h4><p>以下几种情况，会导致索引失效。</p>
<p><strong>1、违反最佳左前缀法则（或全值匹配，最左匹配），导致索引失效（或部分失效）</strong></p>
<p>如果where条件缺少了（即不在where条件中）索引中的某个列，则这个列后面的列都无法使用索引。如果是索引的第一列不在查询条件中，则会导致索引完全失效，如果是中间的某一列不在查询条件中，导致索引部分失效。</p>
<p>MySQL优化器会自动调整where条件的顺序，多个条件的书写顺序对于结果无影响。但还是推荐按照顺序写。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 以下四种情况，都正常使用到了索引。<br>EXPLAIN SELECT * FROM staffs WHERE name ='july';<br>EXPLAIN SELECT * FROM staffs WHERE name ='july' AND age=25;<br>EXPLAIN SELECT * FROM staffs WHERE name ='july' AND age=25 AND pos='dev';<br># 正常使用索引。匹配顺序和书写顺序无关，只要调整顺序以后覆盖即可。<br>EXPLAIN SELECT * FROM staffs WHERE age=25 AND name ='july' AND pos='dev';<br><br># 由于缺少了索引的第一列，因此索引完全失效<br>EXPLAIN SELECT * FROM staffs WHERE age=25 AND pos='dev';<br><br>/* 由于缺少了中间的age列，age列后面的pos列的索引失效,但name列的索引正常使用。<br>这种情况属于索引部分失效。<br>*/<br>EXPLAIN SELECT * FROM staffs WHERE name ='july' AND pos='dev';<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、在索引上做操作（计算、函数、自动或手动类型转换），导致操作列和之后列索引失效</strong></p>
<p>如果在索引上做任何操作，都会导致操作列及其后面列的索引失效。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 以下操作，在name上取子串，导致索引全部失效，因为name是索引的第一列<br>EXPLAIN SELECT * FROM staffs WHERE SUBSTRING(name,1,4) ='july';<br><br># age列的索引失效，只使用了name列的索引。<br>EXPLAIN SELECT * FROM staffs WHERE name='july' AND age+5=28;<br><br># 在中间列age上操作，导致age和之后的pos列索引都失效，只使用了name列索引<br>EXPLAIN SELECT * FROM staffs <br>WHERE name ='july' AND age+5=28 AND pos='dev';<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、范围条件右边的列索引会失效</strong></p>
<p>如果某一索引列的查询条件是一个范围，会导致其后面的所有列的索引都失效。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 索引的中间列age，因为是范围查找，导致后面的pos列的索引失效。<br># age列本身的索引不会失效，索引用于排序。<br>EXPLAIN SELECT * FROM staffs <br>WHERE name='july' AND age&gt;20 AND pos='dev';  # 用2个索引<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、使用不等于号(<code>!=</code>或<code>&lt;&gt;</code>)时，导致索引全部失效。</strong></p>
<p>如果索引列的任一列使用了<code>!=</code>或<code>&lt;&gt;</code>，就会导致索引全部失效，造成全表扫描。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 索引全部失效<br>EXPLAIN SELECT * FROM staffs WHERE name &lt;&gt;'july';<br># 索引全部失效<br>EXPLAIN SELECT * FROM staffs WHERE name ='july' AND age!=21;<br># 索引全部失效<br>EXPLAIN SELECT * FROM staffs WHERE name ='z3' AND age=22 AND pos&lt;&gt;'dev';<br></code></pre></td></tr></tbody></table></figure>
<p><strong>5、使用<code>is null</code>、<code>is not null</code>，导致当前列和之后列的索引失效</strong></p>
<p>如果索引列的某一列使用了<code>is null</code>或<code>is not null</code>，会导致当前列和其后面所有列的索引都失效。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 索引完全失效。<br>EXPLAIN SELECT * FROM staffs WHERE name IS NULL;<br><br># 索引部分失效，只使用了name列的索引<br>EXPLAIN SELECT * FROM staffs WHERE name = 'july' AND age IS NOT NULL;<br><br># 索引部分失效，只使用了name列的索引<br>EXPLAIN SELECT * FROM staffs <br>WHERE name = 'july' AND age IS NOT NULL AND pos='dev';<br></code></pre></td></tr></tbody></table></figure>
<p><strong>6、LIKE条件中，%放在开头，导致当前列和之后列的索引失效</strong></p>
<p>在使用了<code>LIKE</code>的条件语句中，如果将<code>%</code>号放在了开头位置，会导致当前列和之后所有列的索引失效。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 索引全部失效<br>EXPLAIN SELECT * FROM staffs WHERE name LIKE '%july'; <br><br># 索引全部失效<br>EXPLAIN SELECT * FROM staffs <br>WHERE name  LIKE '%july' AND age = 25; # 索引失效<br><br># 索引部分失效，只使用了name和age列的索引，pos列的索引失效。<br>EXPLAIN SELECT * FROM staffs <br>WHERE name = 'july' AND age = 23 AND pos LIKE '%dev'; <br></code></pre></td></tr></tbody></table></figure>
<p>如果SQL语句中必须要将<code>%</code>写在开头，则可以使用覆盖索引避免索引失效：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 索引未失效<br>EXPLAIN SELECT name FROM staffs WHERE name LIKE '%july';<br><br># 索引未失效<br>EXPLAIN SELECT name,pos,age FROM staffs WHERE name LIKE '%july%';<br><br># 索引未失效<br>EXPLAIN SELECT name,pos,age FROM staffs <br>WHERE name = 'july' AND age = 23 AND pos LIKE '%dev';<br><br># 索引未失效,id是主键，主键索引为primary，自动创建。也是覆盖索引。<br>EXPLAIN SELECT id,name,pos,age FROM staffs <br>WHERE name LIKE '%july%'; <br><br># 索引失效，不是索引覆盖，且%开头。<br>EXPLAIN SELECT name,add_time FROM staffs <br>WHERE name LIKE '%july';<br></code></pre></td></tr></tbody></table></figure>
<p><strong>7、字符类型的字段，查询时常量值不加单引号而触发类型转换，导致当前列和之后列的索引失效</strong></p>
<p>如果某一字段类型是字符类型，比如varchar类型，如果查询语句写的是整型数字（如果是字符串不写引号是语法错误），会触发自动类型转换（同第2条），导致当前列和之后所有列的索引失效。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 索引失效。name列是varchar型，2000会自动转换为varchar型，导致索引失效。<br>EXPLAIN SELECT * FROM staffs WHERE name=2000;<br><br># 索引全部失效<br>EXPLAIN SELECT * FROM staffs WHERE name=2000 AND age=23; # 失效<br></code></pre></td></tr></tbody></table></figure>
<p><strong>8、使用or时，如果其中一个列没有索引，导致索引全部失效</strong></p>
<p>使用or时，只要其中一个列没有索引，就会导致索引全部失效，其他字段有索引也不会使用。</p>
<p>因为如果其中的列没有索引，必然会导致一次全表扫描，如果带索引的列使用索引，那么总操作就是全表扫描+索引查找+合并，共三部分。于是干脆就不使用索引，直接全表扫描。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 使用全部索引<br>EXPLAIN SELECT name FROM staffs WHERE name = 'july' OR pos ='dev';<br><br># 索引全部失效。因为add_time没有索引。<br>EXPLAIN SELECT name FROM staffs <br>WHERE name = 'july' OR add_time = NOW();<br><br># 正常使用索引，该使用几个使用几个。<br># 因为有带索引的列，and条件，一定不会导致全部扫描，先根据索引查找，再判断即可。<br>EXPLAIN SELECT name FROM staffs <br>WHERE name = 'july' AND add_time = NOW();<br></code></pre></td></tr></tbody></table></figure>
<h4 id="索引优化总结"><a href="#索引优化总结" class="headerlink" title="索引优化总结"></a>索引优化总结</h4><p>根据以上索引分析和索引失效的情况，可以总结出避免索引失效的优化建议：</p>
<ul>
<li><p>遵守全值匹配（最左匹配）和最左前缀的规则。</p>
</li>
<li><p>尽量避免缺失索引首列或中间列，以防发生索引全部失效或部分失效的情况</p>
</li>
<li><p>尽量避免在索引列上计算，以防索引失效。</p>
</li>
<li><p>尽量使用覆盖索引，少用<code>*</code>查询，以避免因二次查询非索引列数据导致效率下降。</p>
</li>
<li><p>LIKE条件中，尽量避免将<code>%</code>号写在开头。如果<code>%</code>必须写在开头，可以使用覆盖索引的方式避免索引失效。</p>
<blockquote>
<p>一般来说，%越往后，查询效率越高。</p>
</blockquote>
</li>
<li><p>尽量避免使用<code>is null</code>、<code>is not null</code>、<code>!=</code>、<code>&lt;&gt;</code>和<code>or</code>，以免导致索引失效。</p>
</li>
<li><p>字符类型的单引号一定要写。</p>
</li>
</ul>
<p>口诀：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">全值匹配我最爱，最左前缀要遵守;<br>带头大哥不能死，中间兄弟不能断;<br>索引列上少计算，范围之后全失效;<br>LIKE百分写最右，覆盖索引不写星;<br>不等空值还有or，索引失效要少用；<br>VAR引号不可丢，SQL高级也不难！<br></code></pre></td></tr></tbody></table></figure>
<h3 id="2-2-3-一般性建议"><a href="#2-2-3-一般性建议" class="headerlink" title="2.2.3 一般性建议"></a>2.2.3 一般性建议</h3><p>对于单键索引，尽量选择针对当前query过滤性更好的索引。</p>
<p>在选择组合索引的时候，当前Query中过滤性最好的字段在索引字段顺序中，位置越靠前越好。</p>
<p>在选择组合索引的时候，尽量选择可以能够包含当前query中的where字句中更多字段的索引。</p>
<p>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的。</p>
<h1 id="三、查询截取分析"><a href="#三、查询截取分析" class="headerlink" title="三、查询截取分析"></a>三、查询截取分析</h1><p>SQL优化分析的大致流程：</p>
<p>1、慢查询日志的开启并捕获。</p>
<p>2、explain+慢SQL分析。</p>
<p>3、使用Show Profile查询SQL在MySQL服务器里面的执行细节和生命周期情况。</p>
<p>4、SQL数据库服务器的参数调优（一般是DBA来操作）。</p>
<h2 id="3-1-查询优化"><a href="#3-1-查询优化" class="headerlink" title="3.1 查询优化"></a>3.1 查询优化</h2><h3 id="3-1-1-永远小表驱动大表"><a href="#3-1-1-永远小表驱动大表" class="headerlink" title="3.1.1 永远小表驱动大表"></a>3.1.1 永远小表驱动大表</h3><p>小表驱动大表是一个重要的优化原则，即小的数据集驱动大的数据集。</p>
<p>上文已经讨论过小表驱动大表在<code>join</code>时的效率情况，这里讨论的是关于<code>in</code>和<code>exist</code>两种子查询中，使用小表驱动大表的优化情况。</p>
<p><code>in</code>和<code>exists</code>使用及对比：<a href="https://kangshitao.github.io/2021/04/26/mysql-basis/#7%E3%80%81%E5%AD%90%E6%9F%A5%E8%AF%A2">子查询</a></p>
<p>使用<code>in</code>关键字的子查询案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select * from A where id in (select id from B);<br>/*等价于：<br>for (select id from B){<br>	for (select * from A where A.id = B.id)<br>}<br>*/<br></code></pre></td></tr></tbody></table></figure>
<p>使用<code>exists</code>关键字的子查询案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select * from A where exists (select 1 from B where B.id=A.id);<br>/*等价于<br>for(select * from A){<br>	for(select * from B where B.id=A.id)<br>}<br>*/<br></code></pre></td></tr></tbody></table></figure>
<p>通过以上案例可知，当子查询的数据集（表B）小于主查询（表A）的数据集时，根据小表驱动大表原则，使用<code>in</code>关键字要优于<code>exists</code>，反之，主查询数据集小于子查询数据集时，用<code>exists</code>优于<code>in</code>。</p>
<p>这是由<code>exists</code>和<code>in</code>子查询的执行顺序决定的：</p>
<ul>
<li>使用<code>in</code>的SQL语句，会先执行子查询语句，然后执行主查询，再判断。</li>
<li>使用<code>exists</code>的SQL语句，会先执行主查询，然后将主查询得到的数据，放到子查询中做条件验证，根据验证结果（<code>TRUE</code>或<code>FALSE</code>)来决定主查询的数据结果是否得以保留。</li>
</ul>
<blockquote>
<p>1、<code>exists</code>子句只返回<code>TRUE</code>或<code>FALSE</code>。子查询中可以是<code>SELECT *</code>，也可以是<code>SELECT 1</code>或其他，实际执行时会忽略 SELECT清单，因此SELECT后写什么都没有区别。</p>
<p>2、<code>exists</code>子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担忧效率问题，可进行实际检验以确定是否有效率问题。</p>
<p>3、<code>exists</code>子查询往往也可以用条件表达式、其他子查询或者<code>JOIN</code>来替代，何种最优需要具体问题具体分析。</p>
</blockquote>
<h3 id="3-1-2-ORDER-BY关键字优化"><a href="#3-1-2-ORDER-BY关键字优化" class="headerlink" title="3.1.2 ORDER BY关键字优化"></a>3.1.2 ORDER BY关键字优化</h3><font color="red">优化建议一：ORDER BY子句，尽量使用Index方式排序，避免使用FileSort方式排序。</font>

<p>如果使用order by进行排序，则尽量保证在Explain结果的Extra列，出现<code>Using index</code>而不出现<code>Using filesort</code>。</p>
<p>案例：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 建表<br>CREATE TABLE tblA(<br>id INT PRIMARY KEY NOT NULL AUTO_INCREMENT,<br> age INT,<br> birth TIMESTAMP NOT NULL<br>);<br>INSERT INTO tblA(age,birth) VALUES(22,NOW());<br>INSERT INTO tblA(age,birth) VALUES(23,NOW());<br>INSERT INTO tblA(age,birth) VALUES(24,NOW());<br><br># 在age和birth两列上建立复合索引。<br>CREATE INDEX idx_A_ageBirth ON tblA(age,birth);<br><br>/*表的内容如下:<br>+----+------+---------------------+<br>| id | age  | birth               |<br>+----+------+---------------------+<br>|  1 |   22 | 2021-06-02 22:22:43 |<br>|  2 |   23 | 2021-06-02 22:22:43 |<br>|  3 |   24 | 2021-06-02 22:22:43 |<br>+----+------+---------------------+<br>*/<br></code></pre></td></tr></tbody></table></figure>
<p>在表<code>tblA</code>中，分析以下几个案例，只关注<code>Extra</code>列：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 1.Extra: Using where; Using index<br>EXPLAIN SELECT * FROM tblA WHERE age&gt;20 ORDER BY age;<br><br># 2.Extra: Using where; Using index<br>EXPLAIN SELECT * FROM tblA WHERE age&gt;20 ORDER BY age,birth;<br><br># 3.Extra: Using where; Using index; Using filesort<br># 由于排序条件缺少复合索引的第一列，并且where中的age是个范围，<br># 导致birth列的索引失效，MySQL不得不采用filesort方式排序<br>EXPLAIN SELECT * FROM tblA WHERE age&gt;20 ORDER BY birth;<br><br># 4.Extra: Using where; Using index<br># 虽然排序条件缺少了age列，但是where中age是确定的，<br># 这样就保证了根据birth排序时，将第一列当成常数，birth列可以正常使用索引<br>EXPLAIN SELECT * FROM tblA WHERE age=20 ORDER BY birth;<br><br># 5.Extra: Using where; Using index; Using filesort<br># 虽然根据索引的两个列排序，但是不是按照索引建立的顺序，<br># 因此也会导致排序时索引失效，出现filesort<br>EXPLAIN SELECT * FROM tblA WHERE age&gt;20 ORDER BY birth,age;<br><br># 6.Extra: Using index; Using filesort<br># 出现了firesort，因为不符合最左覆盖原则，age列是缺失的，导致索引失效<br>EXPLAIN SELECT * FROM tblA ORDER BY birth;<br><br># 7.Extra: Using where; Using index; Using filesort<br># 同样索引失效，因为没有age列<br>EXPLAIN SELECT * FROM tblA <br>WHERE birth &gt; '2021-05-29 16:24:38' ORDER BY birth;<br><br># 8.Extra: Using where; Using index<br># 索引可以使用，因此使用了索引排序<br>EXPLAIN SELECT * FROM tblA <br>WHERE birth &gt; '2021-05-29 16:24:38' ORDER BY age;<br><br># 9.Extra: Using index; Using filesort<br># 因为索引建立时，是根据从小到大排序的，复合索引也是如此，类似于基数排序。<br># 复合索引的两个列排列规则不一致，会导致排序时索引失效，从而触发filesort<br>EXPLAIN SELECT * FROM tblA ORDER BY age ASC,birth DESC;<br><br># 10.Extra: Using index<br># 这两条都没有触发filesort，因为B+树叶子节点有指向左右叶子节点的指针<br># 所以无论是从小到大还是从大到小，都可以借助索引排序，前提是多个列的排序规则要一致。<br>EXPLAIN SELECT * FROM tblA ORDER BY age DESC;<br>EXPLAIN SELECT * FROM tblA ORDER BY age DESC,birth DESC;<br></code></pre></td></tr></tbody></table></figure>
<p>MySQL支持两种排序方式：Index和FileSort，对应于Using index和Using filesort。</p>
<p>Using index扫描索引本身就能完成排序，因此使用索引的效率比使用文件排序的效率要高。</p>
<p>当ORDER BY子句满足以下两种情况时，会使用Index方式排序：</p>
<ul>
<li>ORDER BY语句使用索引最左前列。</li>
<li>使用Where子句与ORDER BY子句条件列组合，满足了索引最左前列的要求，比如上述第4个例子。</li>
</ul>
<font color="red">优化建议二：尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀条件</font>



<p>ORDER BY之后的列如果没有建立索引，就会导致<code>Using filesort</code>。</p>
<p>ORDER BY之后的列虽然建立索引，但是没有符合最左前缀原则，同样会导致索引失效，触发<code>Using filesort</code>。</p>
<p>如果两个排序列排序规则不一致(比如一个降序一个升序)，也会导致索引失效，出现<code>Using filesort</code></p>
<font color="red">优化建议三：MySQL的filesort算法的介绍和优化</font>

<p>如果要排序的字段不在索引列上，那么MySQL使用filesort算法排序，filesort算法有两种，包括双路排序和单路排序：</p>
<ul>
<li>双路排序：MySQL 4.1之前使用的是双路排序，即两次扫描磁盘，最终得到数据。具体来说，读取行指针和orderby 列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据输出。简言之，就是从磁盘取排序字段，在buffer中排序，然后根据排序好的字段再从磁盘中读取其他字段的数据。</li>
<li>单路排序：MySQL 4.1之后对双路排序改进。从磁盘读取查询需要的所有列，按照order by列在buffer对它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据。并且把随机IO变成了顺序IO,但是它会使用更多的空间。因为它把每一行都保存在内存中了。</li>
</ul>
<blockquote>
<p>虽然单路排序总体而言好于多路排序，但是其也有缺点：</p>
<p>单路排序比多路排序多占用很多排序缓存(sort_buffer)空间。因为单路排序排序时，把所有字段都取出，所以有可能取出数据的总大小超出了排序缓存的容量，导致每次只能取sort_buffer容量大小的数据进行排序（创建tmp文件，多路合并)，排完再取sort_buffer容量大小，重复这两步，从而导致多次IO，得不偿失。</p>
</blockquote>
<p><strong>对filesort单路排序的优化策略：</strong></p>
<ul>
<li><p>使用Order by时，只查询需要的字段，避免使用<code>select *'</code>。</p>
<blockquote>
<p>这点非常重要。因为：<br>1、当Query的字段大小总和小于max_length_for_sort_data而且排序字段不是TEXTIBLOG类型时，会使用单路排序，否则会用多路排序算法。<br>2、两种算法算法的数据都有可能超出sort_buffer的容量（超出之后，会创建tmp文件进行合并排序，导致多次IO），但是用单路排序算法的风险会更大一些，所以要提高sort_buffer_size。</p>
</blockquote>
</li>
<li><p>尝试提高<code>sort_buffer_size</code>。</p>
<blockquote>
<p>无论那种算法，提高这个参数都会提高效率，要根据系统能力去提高，这个参数是针对每个进程的。</p>
</blockquote>
</li>
<li><p>尝试提高<code>max_length_for_sort_data</code>。</p>
<blockquote>
<p>提高这个参数，会提高用单路排序的概率。但如果设置的太高，数据容量超出sort_buffer_size的概率就会增大，明显症状是提高磁盘I/O活动和处理器使用率变低。</p>
</blockquote>
</li>
</ul>
<h3 id="3-1-3-GROUP-BY关键字优化"><a href="#3-1-3-GROUP-BY关键字优化" class="headerlink" title="3.1.3 GROUP BY关键字优化"></a>3.1.3 GROUP BY关键字优化</h3><p>GROUP BY的实质是先排序后分组，同样遵照索引建的最佳左前缀。</p>
<p>因此GRUOP BY的优化策略和ORDER BY一致，唯一不同的是，<code>where</code>高于<code>having</code>，<strong>能写在where中的就不要写在having中。</strong></p>
<h2 id="3-2-慢查询日志"><a href="#3-2-慢查询日志" class="headerlink" title="3.2 慢查询日志"></a>3.2 慢查询日志</h2><h3 id="3-2-1-慢查询日志介绍"><a href="#3-2-1-慢查询日志介绍" class="headerlink" title="3.2.1 慢查询日志介绍"></a>3.2.1 慢查询日志介绍</h3><p>MySQL的慢查询日志是MySQL提供的一种日志记录，用来记录在MySQL中响应时间超过阈值的语句，具体指运行时间大于<code>long_query_time</code>（默认是10秒）值的SQL语句，会被记录到慢查询日志中。</p>
<p>比如<code>long_query_time</code>的值为5时，执行时间大于5秒的SQL就会被记录到慢查询日志中。</p>
<h3 id="3-2-2-慢查询日志的使用"><a href="#3-2-2-慢查询日志的使用" class="headerlink" title="3.2.2 慢查询日志的使用"></a>3.2.2 慢查询日志的使用</h3><p>默认情况下，MySQL数据库没有开启慢查询日志，需要手动开启。</p>
<p>如果不是调优需要，不建议开启慢查询日志，因为开启慢查询日志或带来一定的性能影响。</p>
<p><strong>查看慢查询日志是否开启：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SHOW VARIABLES LIKE '%slow_query_log%';<br></code></pre></td></tr></tbody></table></figure>
<p><strong>开启慢查询日志：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SET GLOBAL slow_query_log=1;  # 1或TRUE都表示TRUE<br># 只对当前数据库生效；MySQL重启后失效。<br></code></pre></td></tr></tbody></table></figure>
<p>如果想要使开启状态永久生效，需要修改配置文件<code>my.cnf</code>(其他系统变量也是如此)：</p>
<p>修改<code>my.cnf</code>文件，在<code>mysqld</code>下增加或修改参数：</p>
<figure class="highlight shell"><table><tbody><tr><td class="code"><pre><code class="hljs shell"><span class="hljs-meta">#</span><span class="bash"> 设置开启状态</span><br>slow_query_log=1;<br><span class="hljs-meta">#</span><span class="bash"> 设置慢查询日志文件路径。</span><br><span class="hljs-meta">#</span><span class="bash"> 如果没有指定，系统会默认给一个名为host_name-slow.log文件</span><br>slow_query_log_file=/var/lib/mysql/localhost-slow.log  <br></code></pre></td></tr></tbody></table></figure>
<p>设置完以后，需要重启MySQL服务器。</p>
<p><strong>查看记录到慢查询日志中的阈值时间：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 默认是10秒<br>SHOW VARIABLES LIKE '%long_query_time%';<br></code></pre></td></tr></tbody></table></figure>
<p>同样地，可以使用<code>SET</code>命令修改，或者在<code>my.cnf</code>配置文件里修改。</p>
<p>注意：大于<code>long_query_time</code>才会记录到慢查询日志中，等于这个时间的SQL语句不会被记录。</p>
<p><strong>查询当前系统中有多少条慢查询记录：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SHOW GLOBAL STATUS LIKE '%Slow_queries%';<br></code></pre></td></tr></tbody></table></figure>
<p>慢查询日志文件的内容举例：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_19.png"><span class="image-caption">慢查询日志文件内容</span></p>
<h3 id="3-2-3-日志分析工具mysqldumpslow"><a href="#3-2-3-日志分析工具mysqldumpslow" class="headerlink" title="3.2.3 日志分析工具mysqldumpslow"></a>3.2.3 日志分析工具mysqldumpslow</h3><p>实际生产环境中，可以使用日志分析工具mysqldumpslow，用来分析日志，查找、分析SQL。</p>
<p>在Linux服务器中使用<code>mysqldumpslow</code>命令可以使用mysqldumpslow工具的各种功能。</p>
<p><strong>查看帮助信息：</strong></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">mysqldumpslow --<span class="hljs-built_in">help</span><br></code></pre></td></tr></tbody></table></figure>
<p>help信息的部分内容，详细参考<a href="https://www.linuxcool.com/mysqldumpslow">mysqldumpslow命令</a>：</p>
<ul>
<li>-s：表示按照何种方式排序，其后可跟以下几个参数，表示不同的排序方式<ul>
<li>aI：平均锁定时间</li>
<li>ar：平均返回记录数</li>
<li>at：平均查询时间</li>
<li>c：次数</li>
<li>l：锁定时间</li>
<li>r：查询行数</li>
<li>t：查询时间</li>
</ul>
</li>
<li>-r：反转排序顺序</li>
<li>-t NUM：展示前NUM条查询</li>
<li>-l：从总时间中不减去锁定时间</li>
<li>-g：后面跟正则表达式，大小写不敏感</li>
</ul>
<p><strong>实例参考</strong></p>
<p>得到返回记录集最多的10个SQL：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">mysqldumpslow -s r -t 10 /usr/<span class="hljs-built_in">local</span>/mysql/data/localhost-slow.log<br></code></pre></td></tr></tbody></table></figure>
<p>得到访问次数最多的10个SQL：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">mysqldumpslow -s c -t 10 /usr/<span class="hljs-built_in">local</span>/mysql/data/localhost-slow.log<br></code></pre></td></tr></tbody></table></figure>
<p>得到按照时间排序的前10条里面含有左连接的查询语句：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">mysqldumpslow -s t -t 10 /usr/<span class="hljs-built_in">local</span>/mysql/data/localhost-slow.log<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3-3-批量数据脚本"><a href="#3-3-批量数据脚本" class="headerlink" title="3.3 批量数据脚本"></a>3.3 批量数据脚本</h2><p>案例：往表里插入1000万条数据。</p>
<p><strong>1、建表</strong></p>
<p>创建dept表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">CREATE TABLE dept(<br>	id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,<br>	deptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,<br>	dname VARCHAR(20) NOT NULL DEFAULT "",<br>	loc VARCHAR(13) NOT NULL DEFAULT ""<br>) ENGINE = INNODB DEFAULT CHARSET=GBK;<br></code></pre></td></tr></tbody></table></figure>
<p>创建emp表：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">CREATE TABLE emp(<br>	id INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,<br>	empno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,<br>	ename VARCHAR(20) NOT NULL DEFAULT "",<br>	job VARCHAR(9) NOT NULL DEFAULT "",<br>	mgr MEDIUMINT UNSIGNED NOT NULL DEFAULT 0,<br>	hiredate DATE NOT NULL,<br>	sal DECIMAL(7,2) NOT NULL,<br>	comm DECIMAL(7,2) NOT NULL,<br>	deptno MEDIUMINT UNSIGNED NOT NULL DEFAULT 0<br>) ENGINE = INNODB DEFAULT CHARSET=GBK;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、设置参数</strong></p>
<p>由于开启过慢查询日志，开启了bin-log，必须为我们的function指定一个参数，即使<code>log_bin_trust_function_creators</code>出于开启状态。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">SET GLOBAL log_bin_trust_function_creators =1;<br></code></pre></td></tr></tbody></table></figure>
<p>同样地，如果想永久有效，必须将其写入<code>my.cnf</code>配置文件。</p>
<p><strong>3、创建函数，用于随机生成内容，保证每条数据都不同</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 功能为返回一个长度为n的随机字符串<br>DELIMITER $$<br>CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)<br>BEGIN<br>	DECLARE chars_str VARCHAR(100) DEFAULT 	'abcdefghijk1mnopgrstuvwxyzABCDEFJHIJKIMNOPQRSTUVWXYZ';<br> 	DECLARE return_str VARCHAR(255) DEFAULT '';<br> 	DECLARE i INT DEFAULT 0;<br> 	WHILE i &lt; n DO<br> 	# 随机选取一个字符<br> 	SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1)); <br> 	SET i = i +1;<br> END WHILE;<br> RETURN return_str; #最终长度为n<br>END $$<br>DELIMITER ;<br><br>#用于随机产生部门编号<br>DELIMITER $$<br>CREATE FUNCTION rand_num() RETURNS INT(5)<br>BEGIN<br>	DECLARE i INT DEFAULT 0;<br>	SET i = FLOOR(100+RAND()*10);<br>	RETURN i;<br>END $$<br>DELIMITER ;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、创建存储过程，插入数据</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 创建向emp表中插入数据的存储过程<br>DELIMITER $$<br>CREATE PROCEDURE insert_emp(IN START INT(10),IN max_num INT(10))<br>BEGIN<br>	DECLARE i INT DEFAULT 0;<br>	SET autocommit = 0; #关闭自动提交autocommit<br> REPEAT<br>	SET i=i+ 1;<br>	INSERT INTO emp(empno, ename ,job ,mgr ,hiredate ,sal ,comm ,deptno)<br>	VALUES((START+i),rand_string(6),'SALESMAN',0001,CURDATE(),2000,400,rand_num());<br> UNTIL i = max_num<br>END REPEAT;<br>COMMIT;<br>END $$<br>DELIMITER ;<br><br># 创建向dept表中插入数据的存储过程<br>DELIMITER $$<br>CREATE PROCEDURE insert_dept(IN START INT(10),IN max_num INT(10))<br>BEGIN<br>	DECLARE i INT DEFAULT 0;<br>	SET autocommit = 0; #关闭自动提交autocommit<br> REPEAT<br>	SET i=i+ 1;<br>	INSERT INTO dept(deptno, dname,loc)<br>	VALUES((START+i),rand_string(10),rand_string(8));<br> UNTIL i = max_num<br>END REPEAT;<br>COMMIT;<br>END $$<br>DELIMITER ;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>5、调用存储过程</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 向dept表批量插入10条部门数据<br>CALL insert_dept(100,10);  <br><br># 向emp表批量插入50万条数据<br>CALL insert_emp(100001,500000);<br></code></pre></td></tr></tbody></table></figure>
<h2 id="3-4-Show-Profile"><a href="#3-4-Show-Profile" class="headerlink" title="3.4 Show Profile"></a>3.4 Show Profile</h2><h3 id="3-4-1-Show-Profile介绍"><a href="#3-4-1-Show-Profile介绍" class="headerlink" title="3.4.1 Show Profile介绍"></a>3.4.1 Show Profile介绍</h3><p>Show Profile是MySQL提供的可以用来分析当前会话中语句执行的资源消耗情况的工具，可以用于SQL的调优的测量。</p>
<p>官网介绍：<a href="https://dev.mysql.com/doc/refman/8.0/en/show-profile.html">https://dev.mysql.com/doc/refman/8.0/en/show-profile.html</a></p>
<h3 id="3-4-2-Show-Profile使用"><a href="#3-4-2-Show-Profile使用" class="headerlink" title="3.4.2 Show Profile使用"></a>3.4.2 Show Profile使用</h3><p>使用步骤：</p>
<p>1、查看是否支持</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show variables like 'profiling';<br></code></pre></td></tr></tbody></table></figure>
<p>2、开启Show Profile</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">set profiling = 1;<br></code></pre></td></tr></tbody></table></figure>
<p>3、运行SQL</p>
<p>4、查看结果</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show profiles;<br></code></pre></td></tr></tbody></table></figure>
<p>结果中可以查看profile中保存的查询记录的运行时间和SQL语句。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_20.png"><span class="image-caption">profile中保存的结果</span></p>
<p>5、诊断SQL：<code>show profile [option,...] for query SQL语句id号;</code></p>
<p>其中可选的参数有：</p>
<ul>
<li>ALL：显示所有的开销信息。</li>
<li>BLOCK IO：显示块IO相关开销。</li>
<li>CONTEXT SWITCHES：上下文切换相关开销。</li>
<li>CPU：显示CPU相关开销信息。</li>
<li>IPC：显示发送和接收相关开销信息</li>
<li>MEMORY：显示内存相关开销信息</li>
<li>PAGE FAULTS：显示页面错误相关开销信息</li>
<li>SOURCE：显示和Source_function，Source_file，Source_line相关的开销信息</li>
<li>SWAPS：显示交换次数相关开销的信息</li>
</ul>
<p>使用诊断指令，展示具体SQL的执行过程以及每个步骤消耗的资源信息。比如查询id为15的那条SQL的cpu和block io的使用情况：<code>show profile cpu,block io for query 15;</code>，结果如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_21.png"><span class="image-caption">查询第15个语句的资源消耗情况</span></p>
<blockquote>
<p> 日常开发需要注意的结论：</p>
<p> 1、converting HEAP to MyISAM：查询结果太大，内存不够用了</p>
<p> 2、Creating tmp table：创建临时表，复制数据到临时表，用完再删除。</p>
<p> 3、Copying to tmp table on disk：把内存中临时表复制到磁盘。<strong>危险信号</strong>。</p>
</blockquote>
<h2 id="3-5-全局查询日志"><a href="#3-5-全局查询日志" class="headerlink" title="3.5 全局查询日志"></a>3.5 全局查询日志</h2><p> <strong>永远不要在生产环境开启此功能。</strong></p>
<p>同样的，有两种开启方式，如果想要永久生效，必须写在配置文件中。</p>
<h3 id="3-5-1-编码启用"><a href="#3-5-1-编码启用" class="headerlink" title="3.5.1 编码启用"></a>3.5.1 编码启用</h3><p>开启全局查询日志：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">set global general_log=1;<br></code></pre></td></tr></tbody></table></figure>
<p>设置文件输出格式：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 比如，将输出格式设置为TABLE类型<br>set global log_output='TABLE';<br></code></pre></td></tr></tbody></table></figure>
<p>开启并设置输出为TABLE类型以后，所有的SQL语句，都会记录到MySQL库里的general_log表，可以使用以下命令查看：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">select * from mysql.`general_log`;<br></code></pre></td></tr></tbody></table></figure>
<h3 id="3-5-2-配置启用"><a href="#3-5-2-配置启用" class="headerlink" title="3.5.2 配置启用"></a>3.5.2 配置启用</h3><p>在MySQL的配置文件<code>my.cnf</code>中，设置如下：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 开启</span><br>general_log=1<br><span class="hljs-comment"># 记录日志文件的路径</span><br>general_log_file=/path/logfile<br><span class="hljs-comment"># 输出格式</span><br>log_output=FILE<br></code></pre></td></tr></tbody></table></figure>
<p>如果将输出格式设置为FILE，则记录会保存到指定的文件目录，默认路径和慢查询日志相同，默认文件名为<code>localhost.log</code>，比如MySQL 5.6中，<code>/usr/local/mysql/data/localhost.log</code>。</p>
<h1 id="四、MySQL锁机制"><a href="#四、MySQL锁机制" class="headerlink" title="四、MySQL锁机制"></a>四、MySQL锁机制</h1><h2 id="4-1-锁的定义和分类"><a href="#4-1-锁的定义和分类" class="headerlink" title="4.1 锁的定义和分类"></a>4.1 锁的定义和分类</h2><h3 id="4-1-1-定义"><a href="#4-1-1-定义" class="headerlink" title="4.1.1 定义"></a>4.1.1 定义</h3><p>锁是计算机协调多个进程或线程并发访问某一资源的机制。</p>
<h3 id="4-1-2-锁分类"><a href="#4-1-2-锁分类" class="headerlink" title="4.1.2 锁分类"></a>4.1.2 锁分类</h3><p>1、MySQL中的锁，根据对数据的操作粒度，分为<strong>表锁（表级锁，table-level locking）</strong>和<strong>行锁（行级锁，row-level locking）</strong>：</p>
<ul>
<li><strong>表锁</strong>：对当前操作的整张表加锁</li>
<li><strong>行锁</strong>：只针对当前操作的行进行加锁。</li>
</ul>
<hr>
<p>扩展：</p>
<p>MyISAM引擎仅支持表锁。InnoDB引擎支持表锁和行锁，默认采用行锁。</p>
<p>InnoDB引擎的行锁实现算法有三种：</p>
<ul>
<li><strong>Record lock：记录锁</strong>，单个行记录上的锁。列必须是<strong>唯一索引或者主键列</strong>，否则加的锁会变成临键锁。查询语句必须为<code>=</code>，不能是<code>&gt;</code>或<code>&lt;</code>，否则也会变为临键锁。</li>
<li><strong>Gap lock：间隙锁</strong>，锁定一个范围，但不包括记录（表中有的边界）本身。基于非唯一索引。比如查询区间为[1,5]，则间隙锁会锁定(1,5)。防止间隙中被其他事务插入数据。</li>
<li><strong>Next-key lock：临键锁</strong>，record+gap锁的组合，锁定一个范围和记录本身。临键锁只在<strong>非唯一索引列</strong>。临键锁是加锁的基本单位。锁定的是<strong>左开右闭</strong>区间，即(a,b]。如果最后一个值不满足条件（即表中没有），则临键锁退化为间隙锁(a,b)。临键锁解决幻读问题。</li>
</ul>
<p>MySQL只有在可重复读的隔离级别下才有间隙锁和临键锁</p>
<hr>
<p>2、根据对数据操作的类型(读/写)，分为<strong>读锁</strong>和<strong>写锁</strong>：</p>
<ul>
<li><strong>读锁（共享锁）</strong>：针对同一份数据，多个读操作可以同时进行而不会互相影响。</li>
<li><strong>写锁（排它锁）</strong>：当前写操作没有完成前，会阻断其他写锁和读锁。</li>
</ul>
<h2 id="4-2-表锁"><a href="#4-2-表锁" class="headerlink" title="4.2 表锁"></a>4.2 表锁</h2><h3 id="4-2-1-特点"><a href="#4-2-1-特点" class="headerlink" title="4.2.1 特点"></a>4.2.1 特点</h3><p>MySQL中锁定<strong>粒度最大</strong>的一种锁，对当前操作的整张表加锁，实现简单，资源消耗也比较少，<strong>加锁快，不会出现死锁</strong>。由于锁定粒度大，导致触发锁冲突的概率最高，并发度最低。</p>
<h3 id="4-2-2-案例分析"><a href="#4-2-2-案例分析" class="headerlink" title="4.2.2 案例分析"></a>4.2.2 案例分析</h3><h4 id="例一：添加表级读锁"><a href="#例一：添加表级读锁" class="headerlink" title="例一：添加表级读锁"></a>例一：添加表级读锁</h4><p>假设目前有一个表<code>mylock</code>，两个会话（或者是事务）：<code>session 1</code>和<code>sessoin 2</code>，会话1表示加锁的会话，会话2代表其他会话。</p>
<p>在session 1种对mylock表添加表级锁，读锁：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">lock table mylock read;<br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>一个会话同时只能对一个表加锁</p>
</blockquote>
<p>加锁后，<strong>对于读操作</strong>：</p>
<p>session 1只可以查询该表记录，但不能查询其他没有被session 1锁定的表。session 2既可以查询表<code>mylock</code>，也可以查询其他表。</p>
<p><strong>对于写操作</strong>：</p>
<p>session 1无法对当前表写入或更新数据，也无法对其他表进行写入或更新操作，会提示错误。session 2如果对当前表插入或更新，会一直处于阻塞状态，直到session 1释放锁，session 2的操作才会执行；对于其他表，session 2正常对他们进行操作。</p>
<p>释放锁的指令：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 释放当前会话持有的锁<br>unlock tables;<br></code></pre></td></tr></tbody></table></figure>
<p>总结：当前会话对某个表添加表级读锁后，只能对其添加表级读锁的表进行读操作，不能写，也不能对没被它锁定的表进行任何操作。其他会话只有对这个表写操作时会阻塞，但可以读，同时对其他表的操作不会受影响。</p>
<h4 id="例二：添加表级写锁"><a href="#例二：添加表级写锁" class="headerlink" title="例二：添加表级写锁"></a>例二：添加表级写锁</h4><p>session 1对<code>mylock</code>表添加写锁：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">lock tables mylock write;<br></code></pre></td></tr></tbody></table></figure>
<p>此时session 1只能对当前表（加写锁的表）进行读和写操作，不能对其他表进行任何操作。</p>
<p>session 2对<code>mylock</code>表进行读写操作都会进入阻塞状态，直到锁释放才会执行。对其他表的操作不受影响。</p>
<p>释放锁：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">unlock tables;<br></code></pre></td></tr></tbody></table></figure>
<h4 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h4><p>MyISAM引擎在执行查询语句前，会自动给涉及的所有表加读锁，在执行增删改操作前，会自动给涉及的表加写锁。MySQL的表级锁有两种模式：</p>
<ul>
<li>表共享读锁（Table Read Lock）</li>
<li>表独占写锁（Table Write Lock）</li>
</ul>
<p>根据上述案例，可以总结出两个结论：</p>
<ul>
<li>对MyISAM表的读操作(加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求（包括自己也不能写）。只有当读锁释放后，才会执行其它进程的写操作。</li>
<li>对MyISAM表的写操作(加写锁)，会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其它进程的读写操作。</li>
</ul>
<h3 id="4-2-3-表锁分析"><a href="#4-2-3-表锁分析" class="headerlink" title="4.2.3 表锁分析"></a>4.2.3 表锁分析</h3><p>查看哪些表被加锁：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show open tables;<br></code></pre></td></tr></tbody></table></figure>
<p>查看表相关状态：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show status like'table%';<br></code></pre></td></tr></tbody></table></figure>
<p>其结果中，变量<code>Table_locks_immediate</code>表示产生表级锁定的次数（即可以立即获取锁的查询次数，每立即获取锁，值加1）。</p>
<p><code>Table_lock_waited</code>表示出现表级锁争用而发生等待的次数（即不能立即获取锁的次数，每等待一次，锁值+1)，此值高则说明存在着较严重的表级锁争用情况。</p>
<p>此外，MyISAM引擎的读写锁调度是写优先，这也是MyISAM不适合做写为主表的引擎的原因，因为添加写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞。因此，<strong>要保证MyISAM引擎的表偏读</strong>，避免堵塞。</p>
<h2 id="4-3-行锁"><a href="#4-3-行锁" class="headerlink" title="4.3 行锁"></a>4.3 行锁</h2><h3 id="4-3-1-特点"><a href="#4-3-1-特点" class="headerlink" title="4.3.1 特点"></a>4.3.1 特点</h3><p>MySQL中锁定<strong>粒度最小</strong> 的一种锁，只针对当前操作的行进行加锁。<strong>行级锁能大大减少数据库操作的冲突</strong>。由于锁定粒度小，因此并发度高。但加锁的开销也最大，加锁慢，容易出现死锁。</p>
<h3 id="4-3-2-案例分析"><a href="#4-3-2-案例分析" class="headerlink" title="4.3.2 案例分析"></a>4.3.2 案例分析</h3><p>以下案例的前提当前表使用的是InnoDB引擎，且使用行锁。</p>
<h4 id="1、行锁基本案例"><a href="#1、行锁基本案例" class="headerlink" title="1、行锁基本案例"></a>1、行锁基本案例</h4><p>情景一：会话1对某一行进行修改操作，但还未提交，此时会话2如果要对同一行进行操作，会被阻塞，直到会话1提交以后，会话2才会被执行。</p>
<p>情景二：会话1对某一行进行修改操作，同时会话2对另一行进行操作，二者互不影响。</p>
<h4 id="2、无索引行锁升级为表锁"><a href="#2、无索引行锁升级为表锁" class="headerlink" title="2、无索引行锁升级为表锁"></a>2、无索引行锁升级为表锁</h4><p>如果会话1的操作导致索引失效，或者没有使用索引，会导致行锁变为表锁，导致会话1操作时，会话2不能进行写操作（比如update和insert），处于阻塞状态。</p>
<blockquote>
<p>和MyISAM的表锁不同的是，这里的其他会话虽然不能进行写操作，但是可以进行读操作。MyISAM中的表锁，其他会话对于此表既不能读也不能写。</p>
</blockquote>
<p>例如，表<code>test_innodb_lock</code>中的a和b两列都有单独的索引，且a的类型是<code>INT</code>，b的类型是<code>VARCHAR</code>，此时会话1对其中的一行进行更新，由于自动类型转换，导致了索引失效，从而行锁变为表锁。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 会话1进行更新操作，未提交：<br>update test_innodb_lock set a=44 where b=4000;<br><br># 会话2进行写操作,即使不是同一行，也会阻塞，因为行锁升级为了表锁<br>update test_innodb_lock set a=5 where b='5000';<br></code></pre></td></tr></tbody></table></figure>
<h4 id="3、间隙锁的危害"><a href="#3、间隙锁的危害" class="headerlink" title="3、间隙锁的危害"></a>3、间隙锁的危害</h4><p>关于InnoDB引擎的行锁，有三种实现算法，分别为记录锁、间隙锁、临键锁。根据4.1.2节的介绍，间隙锁锁定的是一个范围，不包括边界值。</p>
<p>间隙锁锁住的是索引记录中的间隔。间隙锁的主要目的，是为了防止其他事务在间隔中插入数据。</p>
<p>如果一个事务使用范围查找，会锁定一个范围，具体范围是什么，需要根据表内容和索引确定。</p>
<p>间隙锁的致命弱点就是，锁定一个范围后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据，在某些场景下，可能会对性能造成很大的危害。</p>
<p>关于间隙锁的详细讲解，可以参考<a href="https://mp.weixin.qq.com/s/y_f2qrZvZe_F4_HPnwVjOw">链接1</a>、<a href="https://blog.guitar-coder.cn/MySql%E9%94%81-%E9%97%B4%E9%9A%99%E9%94%81%E5%92%8C%E4%B8%B4%E9%94%AE%E9%94%81.html">链接2</a></p>
<h4 id="4、如何锁定某一行"><a href="#4、如何锁定某一行" class="headerlink" title="4、如何锁定某一行"></a>4、如何锁定某一行</h4><p>如果想要单独锁定某一行，可以在事务中，在语句后面添加<code>for update</code>:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">begin;  # 开启事务，也可以使用set autocommit=0;<br># 假如想要单独锁定a=8的这一行,在执行语句后面加for update<br>select * from test_innodb_lock where a=8 for update;<br>commit;<br></code></pre></td></tr></tbody></table></figure>
<h4 id="5、案例结论"><a href="#5、案例结论" class="headerlink" title="5、案例结论"></a>5、案例结论</h4><p>InnoDB存储引擎实现了行锁，虽然在实现行锁所带来的性能损耗可能比表锁更高，但是在整体并发处理能力方面要远远优于MyISAM的表锁的。当系统并发量较高的时候，Innodb的整体性能和MyISAM相比就会有比较明显的优势。<br>但是，Innodb的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让Innodb的整体性能表现不仅不能比MyISAM高，甚至可能会更差。</p>
<h3 id="4-3-3-行锁分析"><a href="#4-3-3-行锁分析" class="headerlink" title="4.3.3 行锁分析"></a>4.3.3 行锁分析</h3><p>使用以下指令查看行锁争夺相关的状态信息：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show status like 'innodb_row_lock%';<br></code></pre></td></tr></tbody></table></figure>
<p>其结果中，各个状态说明如下：</p>
<ul>
<li><code>Innodb_row_lock_current_waits</code>：表示<strong>当前</strong>正在等待锁定的数量。</li>
<li><code>Innodb_row_lock_time</code>：表示从系统启动到现在，<strong>等待的总时间</strong>。</li>
<li><code>Innodb_row_lock_time_avg</code>：表示每次<strong>等待所花的平均时间</strong>。</li>
<li><code>Innodb_row_lock_time_max</code>：表示从系统启动到现在，等待最长的一次时间。</li>
<li><code>Innodb_row_lock_waits</code>：表示系统启动到现在，<strong>总共等待的次数</strong>。</li>
</ul>
<p>如果等待次数很高，且每次平均等待时长也很高的时候，就说明系统可能存在问题，需要对系统进行分析，然后优化。</p>
<h3 id="4-3-4-优化建议"><a href="#4-3-4-优化建议" class="headerlink" title="4.3.4 优化建议"></a>4.3.4 优化建议</h3><p>1、尽可能让所有数据检索都通过索引完成，避免无索引行为导致行锁升级为表锁。</p>
<p>2、合理设计索引，尽量缩小锁的范围。</p>
<p>3、尽可能减少检索条件，避免间隙锁。</p>
<p>4、尽量控制事务大小，减少锁定的资源量和时间。</p>
<p>5、尽可能低级别事务隔离。</p>
<h2 id="4-4-页锁"><a href="#4-4-页锁" class="headerlink" title="4.4 页锁"></a>4.4 页锁</h2><p>开销和加锁时间介于表锁和行锁之间；会出现死锁；锁定粒度介于表锁和行锁之间，并发度一般。</p>
<h1 id="五、MVCC"><a href="#五、MVCC" class="headerlink" title="五、MVCC"></a>五、MVCC</h1><p>以下内容参考<a href="https://juejin.cn/post/6871046354018238472#heading-0">链接1</a>、<a href="https://zhuanlan.zhihu.com/p/133480167">链接2</a></p>
<h2 id="5-1-MVCC介绍"><a href="#5-1-MVCC介绍" class="headerlink" title="5.1 MVCC介绍"></a>5.1 MVCC介绍</h2><p><strong>MVCC(Mutil-Version Concurrency Control)，多版本并发控制</strong>。它使得大部分支持行锁的事务引擎，不再单纯的使用行锁来进行数据库的并发控制，取而代之的是<strong>把数据库的行锁与行的多个版本结合起来</strong>，只需要很小的开销，就可以实现非锁定读，从而大大提高数据库系统的并发性能。可以将MVCC看成是乐观锁的一种实现。</p>
<p>MVCC主要是对于InnoDB引擎来说的。</p>
<h2 id="5-2-相关概念"><a href="#5-2-相关概念" class="headerlink" title="5.2 相关概念"></a>5.2 相关概念</h2><p><strong>乐观锁（Optimistic Lock）</strong>：总是假设最好的情况，假设一般情况下不会造成冲突，所以取数据时不会上锁。在提交更新时，才会判断是否有冲突。<strong>乐观锁适用于多读的情况，可以提高吞吐量。</strong></p>
<p>乐观锁的实现方式主要有两种：CAS（比较并替换）算法、版本号控制。</p>
<p>比如，Java中的<code>util.concurrent.atomic</code>包下面的原子变量类就是使用了CAS实现的。</p>
<p><strong>悲观锁（Pessimistic Lock）</strong>：总是假设最坏的情况。对数据操作之前，总是认为会发生冲突，因此会上锁，其他线程如果想操作数据就会进入阻塞状态。悲观锁具有强烈的独占和排他性，共享锁（读锁）和排它锁（写锁）是悲观锁的两种情况。</p>
<p>悲观锁的实现：数据库中的锁机制，比如表锁、行锁等，都是在操作之前先上锁；Java中的<code>synchronized</code>的实现、<code>ReentrantLock</code>的实现。</p>
<p>参考<a href="https://zhuanlan.zhihu.com/p/40211594">乐观锁和悲观锁</a>、<a href="https://www.jianshu.com/p/d2ac26ca6525">什么是乐观锁、悲观锁</a></p>
<p><strong>快照读</strong>：快照读的实现是基于<strong>多版本</strong>并发控制，即MVCC的，快照读读取到的数据不一定是最新的数据，好比对某一个版本生成了一个快照，这个快照一旦生成了其中的数据就不会发生改变。<strong>MVCC是“维持一个数据的多个版本，使读写操作没有冲突”的一个抽象概念，这个概念的具体实现就是快照读。</strong></p>
<p>比如不加锁的select操作。</p>
<p><strong>当前读</strong>：总是读取当前最新版本的数据，会对当前读的数据进行加锁。是悲观锁的一种操作。</p>
<p>比如共享锁、排它锁。</p>
<h2 id="5-3-解决的问题"><a href="#5-3-解决的问题" class="headerlink" title="5.3 解决的问题"></a>5.3 解决的问题</h2><p><strong>数据库并发场景</strong></p>
<ul>
<li><code>读-读</code>：不存在任何问题，也不需要并发控制。</li>
<li><code>读-写</code>：有线程安全问题，可能会造成事务隔离性问题，可能遇到脏读，幻读，不可重复读。</li>
<li><code>写-写</code>：有线程安全问题，可能会存在更新丢失问题，比如第一类更新丢失，第二类更新丢失。</li>
</ul>
<p><strong>MVCC解决并发哪些问题？</strong></p>
<p>MVCC是用来解决读写冲突的无锁并发控制，就是为事务分配<code>单向增长</code>的<code>时间戳</code>。为每个数据修改保存一个<code>版本</code>，版本与事务时间戳<code>相关联</code>。</p>
<p>读操作<code>只读取</code>该事务<code>开始前</code>的<code>数据库快照</code>。</p>
<p><strong>解决问题如下：</strong></p>
<ul>
<li><code>并发读-写时</code>：可以做到读操作不阻塞写操作，同时写操作也不会阻塞读操作。</li>
<li>解决<code>脏读</code>、<code>幻读</code>、<code>不可重复读</code>等事务隔离问题，但不能解决上面的<code>写-写 更新丢失</code>问题。</li>
</ul>
<p><strong>因此有了下面提高并发性能的<code>组合拳</code>：</strong></p>
<ul>
<li><code>MVCC + 悲观锁</code>：MVCC解决读写冲突，悲观锁解决写写冲突</li>
<li><code>MVCC + 乐观锁</code>：MVCC解决读写冲突，乐观锁解决写写冲突</li>
</ul>
<h2 id="5-4-MVCC的实现原理"><a href="#5-4-MVCC的实现原理" class="headerlink" title="5.4 MVCC的实现原理"></a>5.4 MVCC的实现原理</h2><p>MVCC的实现原理主要是<strong>版本链</strong>、<strong>undo日志</strong>、<strong>ReadView</strong>来实现的。</p>
<h3 id="5-4-1-版本链"><a href="#5-4-1-版本链" class="headerlink" title="5.4.1 版本链"></a>5.4.1 版本链</h3><p>数据库每行数据中，除了可见数据，还包括了几个隐藏字段，分别是：</p>
<ul>
<li><p><code>db_trx_id</code>：6B，最近修改事务id，记录创建或最后一次修改这条记录的事务id</p>
</li>
<li><p><code>db_roll_pointer</code>：7B，回滚指针，指向这条记录的上一个版本</p>
</li>
<li><p><code>db_row_id</code>：6B，隐含的自增id，如果数据表没有主键，InnoDB会自动以db_row_id生成一个聚簇索引。</p>
<blockquote>
<p>还有一个删除flag字段，删除或更新字段时，只是删除flag改变了。</p>
</blockquote>
</li>
</ul>
<p>每次对数据库记录进行改动，都会记录一条<code>undo日志</code>，每条undo日志都有一个<code>roll_pointer</code>属性，可以将这些undo日志连起来串成一个链表，对该记录每次更新后，都会将旧值放到一条undo日志中，算是该记录的一个旧版本，随着更新次数的增多，所有的版本都会被<code>roll_pointer</code>属性连接成一个链表，这个链表称之为<code>版本链</code>，<strong>版本链的头节点就是当前记录最新的值</strong>。</p>
<p><strong>每个版本中还包含生成该版本时对应的事务id，用于Read View中判断版本可见性</strong>。</p>
<h3 id="5-4-2-undo日志"><a href="#5-4-2-undo日志" class="headerlink" title="5.4.2 undo日志"></a>5.4.2 undo日志</h3><p><strong>undo log</strong>主要用于记录数据被修改之前的日志，在表信息被修改之前会先把数据拷贝到<code>undo log</code>中。</p>
<p>事务进行回滚时，可以通过<code>undo log</code>里的日志进行数据还原。</p>
<p><strong>undo日志的作用：</strong></p>
<ul>
<li>保证事务进行回滚时的<code>原子性和一致性</code>，当事务进行回滚的时候可以用<code>undo log</code>的数据进行恢复。</li>
<li>用于MVCC<code>快照读</code>的数据，在MVCC多版本控制中，通过读取<code>undo log</code>的<code>历史版本数据</code>可以实现<code>不同事务版本号</code>都拥有自己<code>独立的快照数据版本</code>。</li>
</ul>
<blockquote>
<p>InnoDB中，用undo日志保证原子性和一致性，redo日志保证持久性，锁机制保证隔离性。</p>
</blockquote>
<p><strong>undo日志的分类</strong></p>
<p>undo日志主要有两种：</p>
<ul>
<li><p>insert undo log：代表事务在insert新记录时产生的undo log , 只在事务回滚时需要，并且在事务提交后可以被立即丢弃。</p>
</li>
<li><p>update undo log（主要）：事务在进行update或delete时产生的undo log ; <strong>不仅在事务回滚时需要，在快照读时也需要</strong>；不能随便删除，只有在快速读或事务回滚不涉及该日志时，对应的日志才会被purge线程统一清除。</p>
</li>
</ul>
<h3 id="5-4-3-Read-View（读视图）"><a href="#5-4-3-Read-View（读视图）" class="headerlink" title="5.4.3 Read View（读视图）"></a>5.4.3 Read View（读视图）</h3><p>事务进行<code>快照读</code>操作的时候生成<code>读视图</code>(Read View)，在该事务执行的快照读的那一刻，会生成数据库系统当前的一个<code>快照</code>。</p>
<p>每个事务开启时，都会被分配一个ID，这个ID是递增的，越新的事务ID值越大。其中没有commit的事务称为<strong>活跃事务</strong>。</p>
<p>Read View记录并维护着系统<strong>当前活跃事务的id</strong>，是系统中当前不应该被<strong>本事务</strong>看到的<strong>其他事务id列表</strong>。</p>
<p><font color="red">Read View主要是用来做可见性判断</font>，当某个事务执行快照读的时候，对该记录创建一个Read View读视图，根据这个读视图，<strong>用来判断当前事务能够看到哪个版本的数据</strong>，可能是当前最新版本的数据，也可能是该行记录的undo log里的某个版本的数据。</p>
<p><strong>Read View的几个属性</strong></p>
<ul>
<li><code>trx_ids</code>：当前系统活跃（未提交）事务版本号（id）集合</li>
<li><code>low_limit_id</code>：创建当前读视图时的当前<strong>系统最大事务版本号+1</strong></li>
<li><code>up_limit_id</code>：创建当前读视图时，系统<strong>活跃事务的最小版本号</strong>。</li>
<li><code>creator_trx_id</code>：创建当前读视图的事务版本号。</li>
</ul>
<p><strong>Read View可见性判断</strong></p>
<p>对于某条记录，其对于当前事务的可见性根据以下条件逐步进行判断。</p>
<p><strong>1、<code>db_trx_id</code>&lt;<code>up_limit_id</code> || <code>db_trx_id</code>==<code>creator_trx_id</code></strong></p>
<p>显示内容。包括两种情况。</p>
<p>第一种，如果当前数据的最近修改事务id，小于读视图中最小活跃事务id，说明<strong>该数据肯定是当前事务开启之前就存在</strong>了，可以显示给当前事务。</p>
<p>第二种，如果当前数据的最近修改事务id，就是创建当前读视图的事务，说明这个数据就是当前事务自己创建的，自己创建的数据当然可以显示。</p>
<p><strong>2、<code>db_trx_id</code> &gt;= <code>low_limit_id</code></strong></p>
<p>不显示。</p>
<p>如果当前数据的最近修改事务id，比生成读视图时候的最大事务id还大，说明这个数据是创建当前读视图之后才生成的，所以此数据不显示。</p>
<p>如果不满足此条件，则进行下一步判断。</p>
<p><strong>3、<code>db_trx_id</code>是否在<code>trx_ids</code>（活跃事务）中</strong></p>
<ul>
<li>不在其中：显示。如果当前数据的最近修改事务id，不在创建读视图时的活跃事务中，说明创建读视图的时候，这个事务已经提交了（因此不是活跃事务），则此数据可以显示。</li>
<li>存在其中：不显示。说明创建读视图的时候，这个事务还在活跃，处于未提交状态，因此不予显示。</li>
</ul>
<h2 id="5-5-MVCC和事务隔离级别"><a href="#5-5-MVCC和事务隔离级别" class="headerlink" title="5.5 MVCC和事务隔离级别"></a>5.5 MVCC和事务隔离级别</h2><p>根据MVCC的实现原理，可以知道，Read View用于<strong>RC（Read Commited，读提交）</strong>和<strong>RR（Repeatable Read，可重复读）</strong>这两种隔离级别的实现，解决了<strong>脏读</strong>和<strong>不可重复读</strong>的问题。</p>
<p><strong>解决脏读和不可重复读</strong></p>
<p>在不同的隔离级别下，MVCC中Read View的创建是不同的。</p>
<p>对于<code>RC</code>隔离级别：<strong>每个快照读都会生成并获取最新的Read View</strong>，因此只能解决脏读问题，不能解决不可重复读的问题。</p>
<p>对于<code>RR</code>隔离级别：<strong>对于同一个事务来说，只有第一个快照读才会创建Read View</strong>，之后的快照读获取的都是同一个Read View，<strong>不会重复生成</strong>，因此其他事务的修改对于当前事务来说是不可见的，所以每次查询的结果都是一样的，解决了不可重复读的问题。</p>
<p><strong>解决幻读问题</strong></p>
<ul>
<li>快照读：对于快照读来说，直接用MVCC控制就可以，不需要加锁。根据MVCC中的规则进行增删查改操作，就可以避免幻读。</li>
<li>当前读：对于当前读来说，使用next-key(临键锁)来控制，避免幻读。</li>
</ul>
<h1 id="六、主从复制"><a href="#六、主从复制" class="headerlink" title="六、主从复制"></a>六、主从复制</h1><p>参考<a href="https://blog.csdn.net/why15732625998/article/details/80463041"></a><a href="七">MySQL高级</a> MySQL主从复制及读写分离实战</p>
<h2 id="6-1-复制的基本原理"><a href="#6-1-复制的基本原理" class="headerlink" title="6.1 复制的基本原理"></a>6.1 复制的基本原理</h2><p>主从复制的基本原理：slave机器会从master机器读取<code>binlog</code>文件来进行数据同步，主要有三步：</p>
<ul>
<li>master将改变记录到二进制文件（<code>binlog</code>）中，这些记录过程叫做二进制日志事件（binary log events）；</li>
<li>slave将master的二进制文件中的内容（二进制日志事件）拷贝到自己的中继日志（<code>relay log</code>）；</li>
<li>salve重做中继日志中的事件，将改变应用到自己的数据库中，MySQL复制是异步的且串行化的。</li>
</ul>
<blockquote>
<p>MySQL 的二进制文件，即常说的<code>binlog</code>文件，是MySQL执行改动产生的二进制日志文件，其主要作用有两个：</p>
<p>1、Replication（<em>主从数据库）</em>：在master端开启<code>binlog</code>文件后，log会记录所有数据库的改动，然后slave端获取这个日志文件内容就可以在slave端进行同样的操作。</p>
<p>2、备份（<em>数据恢复</em> ）：在某个时间点a做了一次备份，然后利用二进制日志文件记录从这个时间点a后的所有数据库的改动，然后下一次还原的时候，利用时间点a的备份文件和这个二进制日志文件，就可以将数据还原。</p>
</blockquote>
<h2 id="6-2-复制的基本原则"><a href="#6-2-复制的基本原则" class="headerlink" title="6.2 复制的基本原则"></a>6.2 复制的基本原则</h2><p>主从复制的基本原则：</p>
<ul>
<li><p>每个slave只有一个master</p>
</li>
<li><p>每个slave只有一个唯一的服务器ID</p>
</li>
<li><p>每个master可以有多个slave</p>
</li>
</ul>
<h2 id="6-3-复制的最大问题"><a href="#6-3-复制的最大问题" class="headerlink" title="6.3 复制的最大问题"></a>6.3 复制的最大问题</h2><p>延时问题是主从复制最大的问题。</p>
<h2 id="6-4-一主一从常见配置"><a href="#6-4-一主一从常见配置" class="headerlink" title="6.4 一主一从常见配置"></a>6.4 一主一从常见配置</h2><p>以一个Windows主机，一个Linux从机为例。</p>
<p><strong>要求：</strong></p>
<p>①MySQL版本尽量一致，且后台以服务运行。版本不同容易导致兼容问题。</p>
<p>②主从都配置在<code>mysqld</code>节点下</p>
<p><strong>步骤：</strong></p>
<p><strong>一、主机修改<code>my.ini</code>配置文件（Windows中是ini后缀，linux中是cnf后缀）</strong></p>
<p>假设本地安装路径为<code>D:/MySQLServer5.7</code></p>
<ul>
<li><p>设置主服务器唯一ID（必须）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">server-id=1<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>启用二进制日志（必须）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">log-bin=本地路径/data/mysqlbin<br><span class="hljs-comment"># 即</span><br>log-bin=D:/MySQLServer5.7/data/mysqlbin<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>启用错误日志（可选）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">log-err=本地路径/data/mysqlerr<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>根目录（可选）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">basedir=<span class="hljs-string">"D:/MySQLServer5.7"</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>临时目录（可选）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">tmpdir=<span class="hljs-string">"D:/MySQLServer5.7"</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>数据目录（可选）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">datadir=<span class="hljs-string">"D:/MySQLServer5.7/Data/"</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>设置<code>read-only=0</code>，意为主机可以读写。</p>
</li>
<li><p>设置不要复制的数据库（可选）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 比如设置mysql这个数据库不复制</span><br>binlog-ignore-db=mysql<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>设置需要复制的数据库（可选）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 比如需要复制student数据库</span><br>binlog-do-db=student<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p><strong>二、从机修改<code>my.cnf</code>配置文件</strong></p>
<ul>
<li><p>设置从服务器唯一ID（必须）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 需要和主机id号不同</span><br>service-id=2<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>启用二进制文件（可选）</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">log-bin=mysql-bin<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>修改完配置文件后，主机和从机必须重启MySQL服务。</p>
<p><strong>三、主机和从机都关闭防火墙</strong></p>
<ul>
<li><p>CentOS 7关闭防火墙</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">systemctl stop firewalld.service<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>Windows关闭防火墙</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># cmd窗口</span><br><span class="hljs-comment"># 查看防火墙状态</span><br>netsh advfirewall show allprofiles<br><br><span class="hljs-comment"># 关闭防火墙</span><br>netsh advfirewall <span class="hljs-built_in">set</span> allprofiles state off<br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p><strong>四、主机上建立账户并授权slave</strong></p>
<ul>
<li><p>授权给指定ip的从机账户名和密码：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 比如从机ip为192.168.168.168，给从机建立的账户名为kang，密码为123456<br># 192.168.168.168从机就可以根据此用户名和密码进行复制。<br># replication slave表示给从机赋予复制的权限，*.*表示所有数据库。<br># ip如果为%则表示任意ip都可以使用此账号密码登陆<br>grant replication slave on *.* to 'kang'@'192.168.168.168' identified by '123456';<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>刷新一下权限，使权限立即生效：<code>flush privileges;</code></p>
</li>
<li><p>查询master状态</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show master status;<br># 记录下File和Position的值，slave需要从File文件的Position位置开始复制。<br></code></pre></td></tr></tbody></table></figure>
<p>执行完此步骤后，不要操作主机MySQL，防止主服务器发生变化。</p>
<blockquote>
<p>重置master二进制文件：<code>reset master;</code>，会删除所有binlog文件，慎用。</p>
</blockquote>
</li>
</ul>
<p><strong>五、从机配置需要复制的主机信息</strong></p>
<ul>
<li><p>配置账户名和File和Position：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 需要指定主机ip，账户名和密码就是主机授权的账户名和密码<br># File和Position是从File文件的Positon位置开始复制<br>change master to master_host='主机ip',<br>master_user='kang',<br>master_password='123456',<br>master_log_file='File名字',<br>master_log_pos=Position数字;<br><br># 如果之前做过同步，需要停止同步：stop slave;<br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>启动从机的复制功能：<code>start slave;</code></p>
</li>
<li><p>显示状态：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">show slave status;<br># 可以在指令后面使用\G代替分号，表示按照键值对的方式显示内容<br></code></pre></td></tr></tbody></table></figure>
<p>如果<code>Slave_IO_Running: Yes</code>，<code>Slave_SQL_Running: Yes</code>说明配置成功。</p>
</li>
</ul>
<p>配置成功后，主机的新建库、新建表、插入数据等相关操作就会被从机复制下来，从而实现数据同步。</p>
<p>如果需要同步的时主机中已有，但从机中没有的数据库，需要先手动将此数据库备份到从机，才能完成此数据库的同步。</p>
<p>使用<code>mysqldump</code>指令可以导出数据。</p>
<p><strong>六、停止从主机复制数据的功能</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">stop slave;<br></code></pre></td></tr></tbody></table></figure>
<h2 id="6-5-故障排除"><a href="#6-5-故障排除" class="headerlink" title="6.5 故障排除"></a>6.5 故障排除</h2><p>常见故障排除方法：</p>
<p><strong>1、网络问题。</strong></p>
<p>确保主机和从机可以互相ping通，才能够保证主从复制正常使用。</p>
<p><strong>2、检查账号密码</strong></p>
<p>仔细检查账号密码是否有误。</p>
<p><strong>3、防火墙</strong></p>
<p>主机和从机的防火墙都要关闭。</p>
<p><strong>4、MySQL文件配置问题</strong></p>
<p>检查文件配置，确保主机开启二进制日志文件，确保主机和从机的<code>server-id</code>不同</p>
<p><strong>5、检查语法问题</strong></p>
<p><strong>6、检查账号权限</strong></p>
<p>在主机服务器中，检查授权账号的权限和登陆主机限制。</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># host限制了此账号在哪个主机上可以登录。如果是%表示任何主机。<br>select user,host from mysql.user;<br></code></pre></td></tr></tbody></table></figure>
<p><strong>遇到的问题</strong></p>
<p><strong>问题1、问题描述</strong></p>
<p>配置完后，发现<code>Slave_IO_Running</code>状态一直处于<code>Connecting</code>状态。说明一直在连接主机数据库。</p>
<p>尝试手动使用授权的账号密码登陆主机数据库，正常情况下应该能够登录成功，结果登陆不成功，因此导致了从机的<code>Slave_IO_Running</code>状态一直处于<code>Connecting</code>状态。如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_22.png"><span class="image-caption">从机无法使用授权账号登陆到主机</span></p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_23.png"><span class="image-caption">Slave_IO_Running</span></p>
<p><strong>解决方法：</strong></p>
<p>ERROR 1130错误，说明在当前ip下，此账号没有权限登录到主机的MySQL数据库。在主机中可以查看用户以及允许登陆的主机：</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql"># 查看用户和host信息<br>select user,host from mysql.user;<br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，slave账号允许登陆的主机ip，我使用的是Vmware虚拟机CentOS7作为从机，Windows作为主机，网络模式是NAT模式，虽然从机ip确实是<code>192.168.198.198</code>，主机和从机也能互相ping通，但是就不允许登陆。可能是和NAT模式有关？（没搞清楚为什么会这样，按理说应该可以登陆。。。）如果换成桥接模式是不是就可以了？（以后有空再试吧）</p>
<p>使用<code>update</code>语句将<code>slave</code>账号的host改为<code>%</code>后，就可以登录了，<code>Slave_IO_Running</code>变为正常。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/mysql-advance_24.png"><span class="image-caption">主机服务器查看用户信息</span></p>
<p><strong>问题2、问题描述</strong></p>
<p>上个问题解决了以后，看起来没问题了，但是数据只能同步执行一次。主机创建一个数据库以后，从机可以同步创建，但是主机再进行操作，从机就不继续同步了，用<code>show slave status</code>查看状态，<code>Read_Master_Log_Pos</code>一直和主机状态中的保持同步，但是就不同步执行主机相应命令:-(</p>
<p>可能是因为MySQL数据库版本不同？主机用的MySQL 5.7，从机用的MySQL 5.6，不知道是不是因为版本的问题。等有空再将版本统一一下，重新配置一遍试试。</p>
<h1 id="七、其他内容补充"><a href="#七、其他内容补充" class="headerlink" title="七、其他内容补充"></a>七、其他内容补充</h1><h2 id="7-1-数据库范式"><a href="#7-1-数据库范式" class="headerlink" title="7.1 数据库范式"></a>7.1 数据库范式</h2><p>第一范式（1NF）：属性不可分割，即表中的字段不能再划分为多个字段</p>
<p>第二范式（2NF）：满足1NF的同时，必须有主键，且其他字段都依赖于主键（或者是候选码），保证唯一性。即每个非主属性完全依赖于候选码。</p>
<p>第三范式（3NF）：每个非主属性既不传递依赖于主码，也不部分依赖于主码。即属性不依赖于其他非主属性，直接依赖于主键。主要是用于避免冗余，同一个属性不能存在于多个表中，即一个表中的属性不能依赖于其他表的主键，否则这个属性在多个表中都有，就出现了冗余。</p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ol>
<li><a href="https://www.bilibili.com/video/BV1KW411u7vy">MySQL数据库优化</a></li>
<li><a href="https://snailclimb.gitee.io/javaguide/#/docs/database/MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B4%A2%E5%BC%95">JavaGuide-MySQL数据库索引总结</a></li>
<li><a href="https://snailclimb.gitee.io/javaguide/#/docs/database/一条sql语句在mysql中如何执行的">一条 SQL 语句在 MySQL 中如何执行的</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/110375475">为什么 MySQL 使用 B+树</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/149287061">B+树看这一篇就够了</a></li>
<li><a href="http://blog.codinglabs.org/articles/theory-of-mysql-index.html">MySQL索引背后的数据结构及算法原理</a></li>
<li>《高性能 MySQL第3版》</li>
</ol>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>MySQL</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring5配置与使用</title>
    <url>/2021/06/27/spring-basis/</url>
    <content><![CDATA[<h1 id="一、Spring简介"><a href="#一、Spring简介" class="headerlink" title="一、Spring简介"></a>一、Spring简介</h1><h2 id="1-1-什么是Spring？"><a href="#1-1-什么是Spring？" class="headerlink" title="1.1 什么是Spring？"></a>1.1 什么是Spring？</h2><p>Spring 是一种轻量级开发框架（或者说是一种容器），旨在提高开发人员的开发效率以及系统的可维护性。Spring 官网：<a href="https://spring.io/">https://spring.io/</a></p>
<p>我们一般说 Spring 框架指的都是 Spring Framework，它是很多模块的集合，使用这些模块可以很方便地协助我们进行开发。这些模块是：核心容器、数据访问/集成,、Web、AOP（面向切面编程）、工具、消息和测试模块。比如：Core Container 中的 Core 组件是Spring 所有组件的核心，Beans 组件和 Context 组件是实现IOC和依赖注入的基础，AOP组件用来实现面向切面编程。</p>
<p>Spring 官网列出的 Spring 的 6 个特征:</p>
<ul>
<li><strong>核心技术</strong> ：依赖注入(DI)，AOP，事件(events)，资源，i18n，验证，数据绑定，类型转换，SpEL。</li>
<li><strong>测试</strong> ：模拟对象，TestContext框架，Spring MVC 测试，WebTestClient。</li>
<li><strong>数据访问</strong> ：事务，DAO支持，JDBC，ORM，编组XML。</li>
<li><strong>Web支持</strong> : Spring MVC和Spring WebFlux Web框架。</li>
<li><strong>集成</strong> ：远程处理，JMS，JCA，JMX，电子邮件，任务，调度，缓存。</li>
<li><strong>语言</strong> ：Kotlin，Groovy，动态语言。</li>
</ul>
<p><strong>Spring是一个轻量级的IOC和AOP的框架。</strong></p>
<h2 id="1-2-Spring的组成"><a href="#1-2-Spring的组成" class="headerlink" title="1.2 Spring的组成"></a>1.2 Spring的组成</h2><p>下图对应的是 Spring4.x 版本。目前最新的5.x版本中 Web 模块的 Portlet 组件已经被废弃掉，同时增加了用于异步响应式处理的 WebFlux 组件。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/spring-basis_1.png"><span class="image-caption">Spring主要模块</span></p>
<ul>
<li><strong>Spring Core：</strong> 基础，可以说 Spring 其他所有的功能都需要依赖于该类库。主要提供 IoC 依赖注入功能。</li>
<li><strong>Spring Aspects</strong> ： 该模块为与AspectJ的集成提供支持。</li>
<li><strong>Spring AOP</strong> ：提供了面向切面的编程实现。</li>
<li><strong>Spring JDBC</strong> : Java数据库连接。</li>
<li><strong>Spring JMS</strong> ：Java消息服务。</li>
<li><strong>Spring ORM</strong> : 用于支持Hibernate等ORM工具。</li>
<li><strong>Spring Web</strong> : 为创建Web应用程序提供支持。</li>
<li><strong>Spring Test</strong> : 提供了对 JUnit 和 TestNG 测试的支持。</li>
<li></li>
</ul>
<h2 id="1-3-Spring的优点"><a href="#1-3-Spring的优点" class="headerlink" title="1.3 Spring的优点"></a>1.3 Spring的优点</h2><ul>
<li>Spring是一个开源免费的框架(容器)</li>
<li>Spring是一个轻量级的、<strong>非入侵式</strong>的框架（AOP是非入侵式的，不需要对原有的代码进行修改）</li>
<li><strong>控制反转(Inversion of Control ,IoC)</strong>，<strong>面向切面编程(Aspect-Oriented Programming，AOP)</strong></li>
<li>支持声明式事务。</li>
</ul>
<h2 id="1-4-Spring弊端"><a href="#1-4-Spring弊端" class="headerlink" title="1.4 Spring弊端"></a>1.4 Spring弊端</h2><p>Spring经过长时间的发展，配置十分繁琐，人称”配置地狱”。</p>
<p>直到SpringBoot的出现，解决了这一问题。SpringBoot是一个快速开发的脚手架。</p>
<h1 id="二、IOC"><a href="#二、IOC" class="headerlink" title="二、IOC"></a>二、IOC</h1><p><strong>控制反转loC(Inversion of Control)</strong>，是一种设计思想，<strong>DI(依赖注入)</strong>是实现loC的一种方法，也有人认为DI只是loC的另一种说法。没有loC的程序中，我们使用面向对象编程，对象的创建与对象间的依赖关系完全硬编码在程序中，对象的创建由程序自己控制，控制反转后将对象的创建转移给第三方，个人认为控制反转就是：获得依赖对象的方式反转了。简而言之就是，<strong>对象由Spring创建、管理和装配。</strong></p>
<p>IOC是Spring的核心内容，IOC可以有多种方式实现，比如XML配置，注解，甚至可以零配置实现IOC。</p>
<p>采用XML方式配置Bean的时候，Bean的定义信息是和实现分离的，而采用注解的方式可以把两者合为一体，Bean的定义信息直接以注解的形式定义在实现类中，从而达到了零配置的目的。</p>
<p><strong>控制反转是一种通过描述(XML或注解）并通过第三方去生产或获取特定对象的方式。在Spring中实现控制反转的是loC容器，其实现方法是依赖注入(Dependency Injection,Dl) ，控制反转是一种思想，依赖注入是一种具体实现方式。</strong></p>
<h2 id="2-1-IOC基础"><a href="#2-1-IOC基础" class="headerlink" title="2.1 IOC基础"></a>2.1 IOC基础</h2><p>以传统的项目为例，假设现在有以下程序：</p>
<ul>
<li><p>DAO层：<code>UserDao</code>接口；接口的实现类<code>UserDaoImpl</code></p>
</li>
<li><p>Service层：<code>UserService</code>接口；接口的实现类<code>UserServiceImpl</code></p>
</li>
</ul>
<p>在<code>UserServiceImpl</code>中，有这样的代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span></span>{<br>    <span class="hljs-keyword">private</span> UserDao userDao = <span class="hljs-keyword">new</span> UserDaoImpl();<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getUser</span><span class="hljs-params">()</span> </span>{<br>        userDao.getUser();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>UserServiceImpl</code>中通过创建<code>UserDaoImpl</code>对象，完成相应的功能。</p>
<p>Controller层的程序，通过创建<code>UserServiceImpl</code>对象并调用方法完成功能。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();<br><span class="hljs-comment">//然后通过UserService调用方法完成功能</span><br></code></pre></td></tr></tbody></table></figure>
<p>如果现在有第二个<code>UserDao</code>接口的实现类<code>UserDaoImpl2</code>，此时如果想要使用<code>UserDaoImpl2</code>中的方法，必须修改<code>UserServiceImpl</code>中的代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> UserDao userDao = <span class="hljs-keyword">new</span> UserDaoImpl2();<br></code></pre></td></tr></tbody></table></figure>
<p>如果实现类有很多，就需要大量修改底层代码。</p>
<p>如何修改代码使得程序能够自动适应不同的需求呢？可以在<code>UserServiceImpl</code>中添加一个<code>set</code>方法，代替手动<code>new</code>的方式：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserService</span></span>{<br>    <span class="hljs-keyword">private</span> UserDao userDao;<br>    <span class="hljs-comment">//private UserDao userDao = new UserDaoImpl();</span><br><br>    <span class="hljs-comment">//利用set方法,动态实现值的注入</span><br>    <span class="hljs-comment">//程序由主动创建对象，变为了被动接收对象。这就是控制反转的思想（IOC）</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setUserDao</span><span class="hljs-params">(UserDao userDao)</span> </span>{<br>        <span class="hljs-keyword">this</span>.userDao = userDao;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getUser</span><span class="hljs-params">()</span> </span>{<br>        userDao.getUser();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这样，只要传入不同的UserDao的实现类，就能完成不同的功能。程序由主动创建对象，变为了被动接收对象。这就是IOC思想的原型。</p>
<p>主动权由原来的业务层(service)，变为了用户层。</p>
<h2 id="2-2-使用IOC创建对象"><a href="#2-2-使用IOC创建对象" class="headerlink" title="2.2 使用IOC创建对象"></a>2.2 使用IOC创建对象</h2><p>使用Spring的IOC容器，创建并获取对象的基本流程如下，以创建一个HelloSpring程序为例。</p>
<p><strong>1、首先创建POJO类，<code>Hello.java</code>：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hello</span> </span>{<br>    <span class="hljs-keyword">private</span> String str;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getStr</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> str;<br>    }<br>    ...<span class="hljs-comment">//</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、然后创建<code>applicationContext.xml</code>配置文件：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- </span><br><span class="hljs-comment">    id相当于变量名，根据此id获取对象</span><br><span class="hljs-comment">    class是全限类名，表示获取的是哪个类的对象</span><br><span class="hljs-comment">    property用于设置（注入）对象中属性的值,这里的name必须和属性名相同</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"hello"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Hello"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"str"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Spring"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- more bean definitions go here --&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>顾名思义，<code>&lt;bean&gt;</code>标签的<code>class</code>必须是非抽象类，即能够实例化的类，不能是接口和抽象类。因为Spring要实例化这些类。</p>
<p><strong>3、最后实例化容器，并获取对象：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>    <span class="hljs-comment">//实例化容器，获取Spring的上下文对象</span><br>    ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext.xml"</span>);<br>    <span class="hljs-comment">//对象现在都在Spring容器中管理了，使用getBean方法从容器里取对象</span><br>    Hello hello = context.getBean(<span class="hljs-string">"hello"</span>,Hello.class);<br>    System.out.println(hello.toString());<br>}<br><span class="hljs-comment">//以上代码打印结果为：Hello{str='Spring'}</span><br></code></pre></td></tr></tbody></table></figure>
<p>在配置文件中注册的bean，当实例化容器的时候，都会生成一个对象保存到容器中，然后使用<code>getBean()</code>方法获取指定的对象实例。</p>
<p>多次获取同一个id的对象，默认是单例模式，得到的都是同一个对象。</p>
<p><code>ApplicationContext</code>是Spring的一个核心接口（或容器），允许容器通过应用程序上下文环境创建、获取、管理bean，是为应用程序提供配置的中央接口。其有多个实现类，根据不同的使用方式需要实例化不同类型的容器。</p>
<p>上述例子是使用Spring的一个简单案例，从中我们可以得出：</p>
<ul>
<li>hello对象是由Spring创建的，而不是我们手动创建的（使用<code>&lt;bean&gt;</code>)</li>
<li>hello对象的属性是由Spring容器设置的（使用<code>&lt;property&gt;</code>）</li>
</ul>
<p>这个过程就是控制反转。</p>
<h2 id="2-3-IOC创建对象的方式"><a href="#2-3-IOC创建对象的方式" class="headerlink" title="2.3 IOC创建对象的方式"></a>2.3 IOC创建对象的方式</h2><p><strong>1、如果不显式指定使用有参构造器，IOC默认使用无参构造器创建对象。</strong></p>
<p>使用无参构造器的前提是bean类中必须有无参构造器。</p>
<p><strong>2、如果想要使用有参构造器创建对象，有以下几种方式传参：</strong></p>
<ul>
<li><p>a. 通过<strong>索引</strong>为参数赋值，创建对象</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 索引从0开始 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"usernamevalue"</span>/&gt;</span>      <br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这里的索引从”0”开始。</p>
</li>
</ul>
<ul>
<li><p>b. 通过<strong>类型</strong>为参数赋值，创建对象</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"java.lang.String"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"usernamevalue"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>要想使用这种方法，必须保证各个参数可以通过类型区分开。基本类型可以直接用，引用类型必须使用全限类名。</p>
</li>
</ul>
<ul>
<li><p>c. 通过<strong>参数名称</strong>赋值，创建对象</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"usernamevalue"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
</li>
<li><p>d. 通过<strong>引用</strong>赋值，创建对象。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> x.y;<br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ThingOne</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThingOne</span><span class="hljs-params">(ThingTwo thingTwo, ThingThree thingThree)</span> </span>{<br>        <span class="hljs-comment">// ...</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>对应的配置文件：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"thingOne"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingOne"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"thingTwo"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"thingThree"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"thingTwo"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingTwo"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"thingThree"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingThree"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h1 id="三、Spring配置文件详解"><a href="#三、Spring配置文件详解" class="headerlink" title="三、Spring配置文件详解"></a>三、Spring配置文件详解</h1><p>下面介绍Spring核心配置文件中的常用标签，后面的使用到再介绍。</p>
<h2 id="3-1-alias"><a href="#3-1-alias" class="headerlink" title="3.1 alias"></a>3.1 alias</h2><p><code>&lt;alias</code>起别名，比如：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"kangkang"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-comment">&lt;!--给user起别名，和直接通过id获取效果是一样的--&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">alias</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">"userAlias"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中在<code>&lt;bean&gt;</code>标签中的<code>name</code>属性也能够为对象起别名：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 通过name属性起别名，可以同时起多个别名，用逗号隔开 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"user2,user3"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"kangkang"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="3-2-Bean"><a href="#3-2-Bean" class="headerlink" title="3.2 Bean"></a>3.2 Bean</h2><p>Spring中将需要实例化的类使用<code>&lt;bean&gt;</code>注册为容器中的bean：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"user2,user3"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"kangkang"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中常用的变量有：</p>
<ul>
<li><code>id</code>: bean的唯一标识，相当于对象名。</li>
<li><code>class</code>：bean对象所对应的全限类名，包名+类名。<strong>必须是普通的类，不能是抽象类或者接口，因为容器要创建对象，抽象类和接口无法创建对象</strong>。</li>
<li><code>name</code>：可以省略。也是别名，并且可以同时取多个别名，可以空格或<code>,</code>分隔。通过这些别名获取对象时，得到的都是同一个对象。</li>
<li><code>scope</code>：指定该bean的作用域，官方给定了六种作用域，比如<code>prototype</code>/<code>sigleton</code>等，具体参考下文内容。</li>
<li><code>autowire</code>：用于指定自动装配的方式，具体参考下文内容。</li>
</ul>
<p>如果使用<code>property</code>对属性进行配置，其中有两个用于赋值的参数需要注意：</p>
<ul>
<li><code>value</code>：表示一个字符串，当参数类型为<code>String</code>时需要使用<code>value</code>进行赋值。</li>
<li><code>ref</code>：传递一个引用类型的变量，当参数的类型为引用类型时，必须使用<code>ref</code>进行传值。</li>
</ul>
<h2 id="3-3-import"><a href="#3-3-import" class="headerlink" title="3.3 import"></a>3.3 import</h2><p><code>import</code>一般用于团队开发，用于将多个配置文件导入合并在一起。</p>
<p>假设有一个总配置文件<code>applicationContext.xml</code>，每个开发人员都有自己的一个配置文件，则可以在总配置文件中将各个配置文件导入，合并为一个配置文件。这样在实例化容器时，只需要传入总配置文件，就可以创建导入的所有配置文件中的<code>bean</code>对象。</p>
<p>总配置文件<code>applicationContext.xml</code>引入多个配置文件：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"beans1.xml"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"beans2.xml"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"beans3.xml"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>实例化容器：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java">ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext.xml"</span>);<br></code></pre></td></tr></tbody></table></figure>
<p>如果不同配置文件中，存在相同<code>id</code>的<code>bean</code>对象，则会根据导入的顺序依次进行覆盖，以最后一个为准。</p>
<h1 id="四、依赖注入"><a href="#四、依赖注入" class="headerlink" title="四、依赖注入"></a>四、依赖注入</h1><p><strong>依赖注入(Dependency Injection，DI)</strong>是一个过程，通过该过程，对象只能通过构造函数参数，工厂方法的参数或在构造或创建对象实例后在对象实例上设置的属性来定义其依赖关系（即其需要的其他对象），从工厂方法返回。然后，容器在创建 bean 时注入那些依赖项。从根本上讲，此过程是通过使用<strong>类的构造器</strong>或<strong>服务定位器模式</strong>来自己控制其依赖关系的实例化或位置的 Bean 本身的逆过程（因此称为<strong>控制反转</strong>）。</p>
<p>依赖注入使得代码更简洁，当为对象提供依赖项时，去耦会更有效。该对象不查找其依赖项，也不知道依赖项的位置或类。</p>
<p>DI主要有两种方式：<strong>基于构造器的依赖注入</strong>和<strong>基于Setter的依赖注入</strong>。</p>
<h2 id="4-1-构造器注入"><a href="#4-1-构造器注入" class="headerlink" title="4.1 构造器注入"></a>4.1 构造器注入</h2><p>使用构造器实现依赖注入，可以参考前面2.1中IOC创建对象的例子。</p>
<p><strong>1、基于无参构造器的依赖注入</strong>，是在调用无参数构造函数或无参数<code>static</code>工厂方法以实例化 bean 之后，然后在bean上调用 <code>set</code> 方法来给属性赋值。</p>
<p>比如：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 通过反射调用无参构造器创建对象，然后调用set方法为name属性赋值 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"student"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Student"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Jack"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这种方式要求类中必须有对应的<code>setXxx()</code>方法</p>
<p><strong>2、基于有参构造器的依赖注入，通过有参构造器给属性赋值。</strong></p>
<p>主要是在<code>&lt;bean&gt;</code>中使用<code>&lt;constructor-arg&gt;</code>标签表示使用有参构造器。</p>
<ul>
<li><p>a. 通过<strong>索引</strong>为参数赋值，创建对象。</p>
<blockquote>
<p>这里的索引从”0”开始。</p>
</blockquote>
</li>
<li><p>b. 通过<strong>类型</strong>为参数赋值，创建对象。</p>
<blockquote>
<p>要想使用这种方法，必须保证各个参数可以通过类型区分开。基本类型可以直接用，引用类型必须使用全限类名。</p>
</blockquote>
</li>
<li><p>通过<strong>参数名称</strong>赋值，创建对象。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"usernamevalue"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>通过<strong>引用</strong>赋值，创建对象。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"thingOne"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingOne"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"thingTwo"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"thingThree"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"thingTwo"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingTwo"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"thingThree"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingThree"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="4-2-通过Setter方式注入"><a href="#4-2-通过Setter方式注入" class="headerlink" title="4.2 通过Setter方式注入"></a>4.2 通过Setter方式注入</h2><p>通过setter方式注入，也就是通过无参构造器创建对象后，调用<code>set</code>方法注入，因此使用setter方式注入，要求bean中必须要有<code>set</code>方法和一个<strong>无参构造器</strong>。</p>
<p>使用Setter方式注入：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"id"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"1"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Java"</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"18"</span> /&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>复杂类型的依赖注入</strong></p>
<p>举例：</p>
<p>1、定义类<code>Address</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Address</span> </span>{<br>    <span class="hljs-keyword">private</span> String address;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAddress</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> address;}<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setAddress</span><span class="hljs-params">(String address)</span> </span>{<span class="hljs-keyword">this</span>.address = address;}<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">toString</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">"Address{"</span> +<br>            <span class="hljs-string">"address='"</span> + address + <span class="hljs-string">'\''</span> +<br>            <span class="hljs-string">'}'</span>;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>2、实体类<code>Student</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Student</span> </span>{<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> Address address;<br>    <span class="hljs-keyword">private</span> String[] books;<br>    <span class="hljs-keyword">private</span> List&lt;String&gt; hobbies;<br>    <span class="hljs-keyword">private</span> Map&lt;String,String&gt; card;<br>    <span class="hljs-keyword">private</span> Set&lt;String&gt; games;<br>    <span class="hljs-keyword">private</span> Properties info;<br>    <span class="hljs-keyword">private</span> String wife;<br>    ...<span class="hljs-comment">//</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<p>3、<code>applicationContext.xml</code>配置文件:</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"address"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Address"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"address"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"xx省xx市xx区"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"student"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Student"</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 1、普通值注入 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"kangst"</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--另一种写法--&gt;</span><br>        <span class="hljs-comment">&lt;!--        &lt;property name="name"&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--            &lt;value&gt;kangst&lt;/value&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--        &lt;/property&gt;--&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 2、Bean注入 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"address"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"address"</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--另一种写法--&gt;</span><br>        <span class="hljs-comment">&lt;!--        &lt;property name="address"&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--            &lt;ref bean="address"/&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--        &lt;/property&gt;--&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 3、数组注入 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"books"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>红楼梦<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>西游记<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>三国演义<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>水浒传<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 4、list注入 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"hobbies"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hobby1<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hobby2<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>hobby3<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 5、map注入 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"card"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"身份证"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"12345678"</span>/&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"银行卡"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"6345112384034"</span>/&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 6、set注入 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"games"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>Game1<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>Game2<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 7、Properties注入 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"info"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">props</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"username"</span>&gt;</span>root<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"password"</span>&gt;</span>123456<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">props</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br><br>        <span class="hljs-comment">&lt;!-- 8、null值注入 (和空串不同,空串直接赋值为""即可)--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"wife"</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">null</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>4、测试</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>    ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext.xml"</span>);<br>    Student student = (Student) context.getBean(<span class="hljs-string">"student"</span>);<br>    System.out.println(student.toString());<br>    <span class="hljs-comment">/*输出结果</span><br><span class="hljs-comment">        Student{name='kangst',</span><br><span class="hljs-comment">        address=Address{address='xx省xx市xx区'},</span><br><span class="hljs-comment">        books=[红楼梦, 西游记, 三国演义, 水浒传],</span><br><span class="hljs-comment">        hobbies=[hobby1, hobby2, hobby3],</span><br><span class="hljs-comment">        card={身份证=12345678, 银行卡=6345112384034},</span><br><span class="hljs-comment">        games=[Game1, Game2],</span><br><span class="hljs-comment">        info={password=123456, username=root},</span><br><span class="hljs-comment">        wife='null'}</span><br><span class="hljs-comment">     */</span><br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="4-3-其他方式注入"><a href="#4-3-其他方式注入" class="headerlink" title="4.3 其他方式注入"></a>4.3 其他方式注入</h2><h4 id="p-命名空间"><a href="#p-命名空间" class="headerlink" title="p-命名空间"></a>p-命名空间</h4><p>p表示properties，允许使用<code>bean</code>元素的属性(而不是嵌套的<code>&lt;property&gt;</code>元素)来声明 <code>Bean</code>的属性值，或同时使用这两者。</p>
<p><strong>要求类中必须有<code>setXxx()</code>方法。</strong></p>
<p>如下，可以同时使用p-命名空间和<code>&lt;property&gt;</code>两种方式。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">"http://www.springframework.org/schema/p"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--p-命名方式和传统方式结合使用--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span> <span class="hljs-attr">p:name</span>=<span class="hljs-string">"用户名"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"20"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>注意，使用p-命名空间时，需要导入<code>xmlns:p="http://www.springframework.org/schema/p"</code>约束</p>
<h4 id="c-命名空间"><a href="#c-命名空间" class="headerlink" title="c-命名空间"></a>c-命名空间</h4><p>c表示constructor，构造器。表示使用<strong>有参构造器</strong>注入属性值。<strong>要求类中必须有有参构造器</strong>。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xmlns:c</span>=<span class="hljs-string">"http://www.springframework.org/schema/c"</span></span><br><span class="hljs-tag">    <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">        https://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"beanTwo"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingTwo"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"beanThree"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingThree"</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 传统使用构造器的声明方式 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"beanOne"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingOne"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"thingTwo"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"beanTwo"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"thingThree"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"beanThree"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"email"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"something@somewhere.com"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- c-命名空间声明方式 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"beanOne"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"x.y.ThingOne"</span> <span class="hljs-attr">c:thingTwo-ref</span>=<span class="hljs-string">"beanTwo"</span></span><br><span class="hljs-tag">        <span class="hljs-attr">c:thingThree-ref</span>=<span class="hljs-string">"beanThree"</span> <span class="hljs-attr">c:email</span>=<span class="hljs-string">"something@somewhere.com"</span>/&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>同样，需要导入<code>xmlns:c="http://www.springframework.org/schema/c"</code>约束</p>
<h2 id="4-4-理解IOC和DI"><a href="#4-4-理解IOC和DI" class="headerlink" title="4.4 理解IOC和DI"></a>4.4 理解IOC和DI</h2><p><strong><code>IOC</code>：当某个角色(比如一个Java实例，调用者)需要另一个角色(另一个Java实例，被调用者)的协助时，在 传统的程序设计过程中，通常由调用者来创建被调用者的实例。但在Spring里，创建被调用者的工作不再由调用者来完成，因此称为控制反转</strong></p>
<p><strong><code>DI</code>：创建被调用者实例的工作通常由Spring容器来完成，然后注入调用者，这个操作称为依赖注入</strong>。</p>
<p>控制反转是一种思想，依赖注入是实现IOC的一种行为。</p>
<p><strong>控制反转（IOC）</strong></p>
<p>传统程序中，我们在类内部通过new的方式，主动创建其依赖对象，导致类和类之间高耦合。在Spring中，将创建和查找依赖对象的控制权交给了IOC容器，由容器负责控制对象的创建和注入组合对象，程序想要什么资源必须从容器中获取，即对资源的控制权转变了，这就是控制反转。IOC有效降低了耦合性。</p>
<p>谁控制谁？</p>
<ul>
<li>IOC容器控制对象；</li>
</ul>
<p>控制什么？</p>
<ul>
<li>控制了外部资源的获取（比如依赖对象，文件资源等）</li>
</ul>
<p>为何是反转？</p>
<ul>
<li>传统应用程序是由我们自己在对象中主动控制去直接获取依赖对象，也就是正转；而反转则是由容器来帮忙创建及注入依赖对象；因为由容器帮我们查找及注入依赖对象，对象只是被动的接受依赖对象，所以是反转；</li>
</ul>
<p>哪些方面反转了？</p>
<ul>
<li>依赖对象的获取被反转了。</li>
</ul>
<p>举个例子？</p>
<ul>
<li>比如用户类需要依赖用户信息类，传统做法是程序（比如客户端类）创建用户类和用户信息类，然后将用户信息类主动注入得到用户类。而在Spring中，使用IOC容器，IOC容器创建用户类，发现用户类需要有依赖对象注入，然后创建用户信息类，并将其注入到用户类。此时的客户端类直接从容器中获取用户类即可。</li>
</ul>
<p><strong>依赖注入</strong></p>
<p>组件之间的依赖关系由容器在<strong>运行期</strong>决定，即由容器<strong>动态</strong>的将某个依赖关系注入到组件中。即动态的向某个对象提供它所需要的其他对象。</p>
<p>谁注入谁？</p>
<ul>
<li>IOC容器注入将对象所依赖的对象或资源注入到这个对象中。</li>
</ul>
<p>注入什么？</p>
<ul>
<li>注入某个对象所需要的外部资源，或者说是属性，比如对象、资源、常量数据等。</li>
</ul>
<h1 id="五、Bean作用域与生命周期"><a href="#五、Bean作用域与生命周期" class="headerlink" title="五、Bean作用域与生命周期"></a>五、Bean作用域与生命周期</h1><h2 id="5-1-Bean-作用域"><a href="#5-1-Bean-作用域" class="headerlink" title="5.1 Bean 作用域"></a>5.1 Bean 作用域</h2><p>Bean Scope（Bean作用域），即Bean对象的作用范围。Spring官方规定了Bean的六种作用域。</p>
<p><strong>1、singleton，单例模式（默认）：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">"singleton"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>​    IOC容器<strong>仅创建一个</strong>Bean实例，并且IOC容器<strong>每次返回的都是同一个Bean实例</strong>，singleton是默认的作用域。</p>
<p><strong>2、prototype，原型模式：</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">"prototype"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>​    IOC容器<strong>可以创建多个</strong>Bean实例，<strong>每次返回的都是一个新的实例</strong>。</p>
<p><strong>3、request</strong></p>
<p>​    仅对HTTP请求产生作用，每次HTTP请求都会创建一个自己的Bean。</p>
<p><strong>4、session</strong></p>
<p>​    每个Session中只有一个共享的Bean实例。不同Session使用不同的实例。</p>
<p><strong>5、application</strong></p>
<p>​    作用域为整个web应用，即<code>ServletContext</code></p>
<p><strong>6、websocket</strong></p>
<p>​    作用域为<code>WebSocket</code></p>
<p>其中后四种仅在web应用中有效。</p>
<p>Spring还支持自定义范围。</p>
<h2 id="5-2-Spring-中的单例-bean-的线程安全问题"><a href="#5-2-Spring-中的单例-bean-的线程安全问题" class="headerlink" title="5.2 Spring 中的单例 bean 的线程安全问题"></a>5.2 Spring 中的单例 bean 的线程安全问题</h2><p>当多个线程操作同一个对象的时候，对这个对象的成员变量的写操作会存在线程安全问题。</p>
<p>但是，一般情况下，我们常用的 <code>Controller</code>、<code>Service</code>、<code>Dao</code> 这些 Bean 是无状态的。无状态的 Bean 不能保存数据，因此是线程安全的。</p>
<blockquote>
<p>无状态的bean只有普通的对数据的操作方法，没有数据存储的功能，比如UserDao</p>
<p>有状态的bean具有数据存储功能，比如User</p>
</blockquote>
<p>常见的有两种解决办法：</p>
<ul>
<li>在类中定义一个 <code>ThreadLocal</code> 成员变量，将需要的可变成员变量保存在 <code>ThreadLocal</code> 中（推荐的一种方式）。</li>
<li>改变Bean的作用域为 <code>prototype</code>，保证每次请求都会创建一个新的 bean 实例，避免线程安全问题。</li>
</ul>
<h2 id="5-3-Bean的生命周期"><a href="#5-3-Bean的生命周期" class="headerlink" title="5.3 Bean的生命周期"></a>5.3 Bean的生命周期</h2><p>简单来说，Bean的生命周期有四个阶段：</p>
<ul>
<li><p><strong>实例化</strong>：容器通过获取<code>BeanDefinition</code>对象中的信息进行实例化，仅仅是简单的实例化，并未进行依赖注入。</p>
<ul>
<li>对于BeanFactory容器，当客户向容器请求一个尚未初始化的bean时，或初始化bean的时候需要注入另一个尚未初始化的依赖时，容器就会调用createBean进行实例化。 </li>
<li>对于ApplicationContext容器，当容器启动结束后，便实例化所有的bean。</li>
</ul>
<blockquote>
<p>实例化对象被包装在<code>BeanWrapper</code>对象中（可以认为是Bean的原生态）</p>
</blockquote>
</li>
<li><p><strong>属性赋值</strong>：也就是依赖注入的过程。Spring根据<code>BeanDefinition</code>中的信息，通过<code>populateBean()</code>方法为属性赋值。</p>
</li>
<li><p><strong>初始化</strong>：比如</p>
<ul>
<li>如果实现了<code>BeanNameAware</code>接口，就调用它的<code>setBeanName()</code>方法，传入Bean的名字。</li>
<li>如果实现了其他的<code>*Aware</code>接口，同样调用其方法。</li>
<li>如果有和加载这个 Bean 的 Spring 容器相关的 <code>BeanPostProcessor</code> 对象，执行<code>postProcessBeforeInitialization()</code> 方法</li>
<li>如果Bean实现了<code>InitializingBean</code>接口，执行<code>afterPropertiesSet()</code>方法。</li>
<li>如果 Bean 在配置文件中的定义包含<code>init-method</code> 属性，执行指定的方法。</li>
<li>如果有和加载这个 Bean的 Spring 容器相关的 <code>BeanPostProcessor</code> 对象，执行<code>postProcessAfterInitialization()</code> 方法</li>
</ul>
</li>
<li><p><strong>销毁</strong>：容器关闭时销毁bean。销毁时，如果实现了<code>DisposableBean</code>接口，就执行<code>destroy()</code>方法，如果配置文件中包含<code>destroy-method</code>属性，就调用指定方法。</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/spring-basis_7.jpg"><span class="image-caption">Bean声明周期</span></p>
<p>这里涉及到了两个主要的接口：</p>
<ul>
<li><code>BeanPostProcessor</code>接口，自定义处理，该接口提供了两个方法，即前置处理和后置处理方法。这个接口可以影响多个Bean。</li>
<li><code>*Aware</code>相关接口，只会调用一次。主要是用于从Spring容器中拿到一些资源，增强Bean的能力。</li>
</ul>
<p>详细内容参考<a href="https://snailclimb.gitee.io/javaguide/#/docs/system-design/framework/spring/Spring%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93?id=_55-spring-%e4%b8%ad%e7%9a%84-bean-%e7%94%9f%e5%91%bd%e5%91%a8%e6%9c%9f">Bean的生命周期</a>、<a href="https://www.zhihu.com/question/38597960/answer/1063970966">Spring中的bean生命周期是怎样的</a></p>
<h1 id="六、Bean的自动装配"><a href="#六、Bean的自动装配" class="headerlink" title="六、Bean的自动装配"></a>六、Bean的自动装配</h1><h2 id="6-1-介绍"><a href="#6-1-介绍" class="headerlink" title="6.1 介绍"></a>6.1 介绍</h2><p>自动装配是Spring满足bean依赖的一种方式，自动装配就是<strong>实现对Java类属性的自动注入</strong>，也就是说为当前类中的类型为<code>bean</code>的属性自动注入值。</p>
<p>Spring会在上下文中自动寻找，并自动给bean装配属性。</p>
<p>Spring中bean的三种装配方式：</p>
<ul>
<li>xml中手动配置。（第四节依赖注入，使用<code>ref</code>）</li>
<li>java中使用注解显式配置。</li>
<li>隐式自动装配。</li>
</ul>
<p>本章使用到的测试类：Person类、Dog类、Cat类。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Person类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{<br>    <span class="hljs-keyword">private</span> Cat cat;<br>    <span class="hljs-keyword">private</span> Dog dog;<br>    <span class="hljs-keyword">private</span> String name;<br>    ...<span class="hljs-comment">//</span><br>}<br><br><span class="hljs-comment">//Dog类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Dog</span> </span>{}<br><br><span class="hljs-comment">//Cat类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cat</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<p>首先看一下xml手动装配时的配置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cat"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Cat"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dog"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Dog"</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"person"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Person"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"kang"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dog"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dog"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"cat"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"cat"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>以上通过<code>ref</code>为<code>Dog</code>类型和<code>Cat</code>类型属性注入值的方式称为手动装配。</p>
<p>对<code>bean</code>类型的属性注入需要使用<code>ref</code>手动注入，他们的代码是相似的，有没有可能将这些相似的代码精简掉呢？这就需要使用<code>bean</code>的自动装配功能了。</p>
<p><strong>bean的自动装配有两种方式</strong>，一种是在<strong>xml中配置（组件扫描）</strong>，另一种是在<strong>Java代码中使用注解（比如@Autowired）</strong>。</p>
<p>这两种方式具体使用哪一种需要视情况而定(“it depends”)，二者各有优缺点。使用注解更简洁，但会造成配置分散难以控制；使用XML配置的方式不需要在源代码上改动，但配置代码繁琐。</p>
<p>两种方式可以同时使用，要注意的是，<strong>注解注入会在XML注入之前执行</strong>，XML注入会覆盖<code>@Autowired</code>注解已经注入的内容。</p>
<h2 id="6-2-使用xml自动装配"><a href="#6-2-使用xml自动装配" class="headerlink" title="6.2 使用xml自动装配"></a>6.2 使用xml自动装配</h2><p><code>xml</code>中的自动装配使用的参数为<code>autowire</code>，有以下5种类型，其中常用的是<code>byName</code>和<code>byType</code>：</p>
<ul>
<li><p><code>byName</code>·：在应用上下文中自动查找和自己对象的<code>set</code>方法后的值对应的<code>bean id</code>。比如<code>setDog()</code>，会自动将<code>Dog</code>的首字母变为小写，查找<code>id</code>为<code>dog</code>的<code>bean</code>。</p>
<blockquote>
<p>只有命名符合驼峰命名规范的才会将首字母小写然后匹配，如果不符合规范，则会直接匹配，比如<code>setDOG()</code>，会去查找<code>id</code>为<code>DOG</code>的<code>bean</code></p>
</blockquote>
</li>
</ul>
  <figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- byName，通过set方法的方法名查找bean的id，为属性注入值 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cat"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Cat"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dog"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Dog"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"person"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Person"</span> <span class="hljs-attr">autowire</span>=<span class="hljs-string">"byName"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"kang"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>  这种方法要求bean的<code>id</code>唯一，并且bean应该和自动注入的属性的<code>set</code>方法的值（set方法名）一致。</p>
<ul>
<li><p><code>byType</code>：在容器上下文中自动查找和自己对象属性类型相同的bean。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 使用byType的方式，会自动查找和属性类型对应的bean并注入。 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cat"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Cat"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dog"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Dog"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"person"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Person"</span> <span class="hljs-attr">autowire</span>=<span class="hljs-string">"byTpye"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"kang"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>这种方式要求所有bean类型必须唯一，并且该bean应该和自动注入的属性的类型一致。</p>
</li>
</ul>
<ul>
<li><p><code>constructor</code>：根据构造方法的参数的数据类型，进行byType模式的自动装配。</p>
</li>
<li><p><code>default</code>：由上级标签<code>&lt;beans&gt;</code>的<code>default-autowire</code>属性确定。</p>
</li>
<li><p><code>no</code>：默认情况。即不使用自动装配。</p>
</li>
</ul>
<h2 id="6-3-通过注解自动装配"><a href="#6-3-通过注解自动装配" class="headerlink" title="6.3 通过注解自动装配"></a>6.3 通过注解自动装配</h2><p>JDK 5.0开始支持注解，Spring 2.5开始支持注解。使用注解注入不需要<code>set</code>方法</p>
<p>使用注解前，需要在配置文件中导入约束并配置注解支持：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/context</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>和自动装配相关的注解有三个，分别是<code>@Autowired</code>、<code>@Qualifier</code>、<code>@Resource</code> 。其中<code>@Autowired</code>和<code>@Qualifier</code>是Spring中的注解，<code>@Resource</code> 是Java中的注解。</p>
<p><strong>1、<code>@Autowired</code></strong></p>
<ul>
<li><p>默认按类型匹配（<code>byType</code>），如果找不到则报错，如果有多个，则通过<strong>属性名</strong>找，如果通过名字也无法找到则报错。</p>
<blockquote>
<p>例如，一个接口如果有多个实现类，按仅按照类型查找会找到多个结果，Spring不知道使用哪一个，这时必须使用<code>byName</code>的方式，可以结合使用<code>@Autowired</code>和<code>@Qualifier</code>两种注解完成注入。也可以单独使用<code>@Resource</code>注解。</p>
</blockquote>
</li>
<li><p>默认情况下要求依赖对象必须存在，如果要允许<code>null</code>值，可以设置这个注解的<code>required</code>属性为<code>false</code>，即<code>@Autowired(required = false)</code></p>
<blockquote>
<p>使用@Nullable注解，也能表示属性值可以为null。</p>
</blockquote>
</li>
<li><p>可以用于构造方法、set方法、普通方法、字段上。</p>
</li>
<li><p><code>@Autowired</code>注解进行注入的方式，是不通过<code>set</code>方法进行注入的，因此<code>set</code>方法可以省略。</p>
</li>
</ul>
<p><code>@Autowired</code>是三种注解中比较常用的。</p>
<p><strong>2、<code>@Qualifier</code></strong></p>
<p> 按名称注入（<code>byName</code>），即在容器中查找和指定<code>value</code>值相同<code>id</code>的<code>bean</code>。</p>
<p><strong>3、<code>@Resource</code> </strong></p>
<p>是Java的注解。可以通过 <code>byName</code> 和 <code>byType</code>的方式注入， 默认先按 <code>byName</code>的方式进行匹配，如果匹配不到，再按 <code>byType</code>的方式进行匹配。</p>
<p>通过几个例子理解一下，这三个注解的用法。</p>
<p><strong>情况1、通过类型可以唯一确定bean，可以忽略名字，装配(注入)成功：</strong></p>
<p><code>Person</code>类中的注解情况：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cat cat;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Dog dog;<br>    <span class="hljs-keyword">private</span> String name;<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>xml</code>中的<code>&lt;bean&gt;</code>:</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cat2"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Cat"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dog2"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Dog"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"person"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Person"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>上述情况下，可以通过类型唯一确定<code>bean</code>，因此可以注入成功。此时将<code>id</code>为<code>cat2</code>和<code>id</code>为<code>dog2</code>的bean分别注入到<code>Person</code>类的<code>cat</code>和<code>dog</code>属性中。</p>
<p><strong>情况2、查找出多个类型，但可以通过名称找到唯一的值，也能注入成功。</strong></p>
<p><code>Person</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cat cat;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Dog dog;<br>    <span class="hljs-keyword">private</span> String name;<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>xml</code>中的<code>&lt;bean&gt;</code>:</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 将id为cat的bean注入到Person中，因为按名字查找，和属性名cat匹配 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cat"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Cat"</span>/&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cat2"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Cat"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dog"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Dog"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"person"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Person"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>观察上述情况，对于<code>Cat</code>类型，通过<code>byType</code>的方式可以找到两个<code>bean</code>，然后再通过<code>byName</code>的方式，查找和属性名(<code>Person</code>中的属性名为<code>cat</code>)相同的id，可以找到id为<code>cat</code>的<code>&lt;bean&gt;</code>，因此也可以注入成功。</p>
<p><strong>情况3、查找出多个类型，通过<code>byName</code>的方式也没找到，则注入失败。</strong></p>
<p><code>Person</code>：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Cat cat;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Dog dog;<br>    <span class="hljs-keyword">private</span> String name;<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>xml</code>中的<code>&lt;bean&gt;</code>:</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 有两个Cat类型的bean，根据变量名cat找不到对应id的bean --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cat1"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Cat"</span>/&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"cat2"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Cat"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dog"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Dog"</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"person"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.Person"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>此时根据<code>byType</code>找到两个<code>Cat</code>类型的<code>bean</code>，然后根据变量名<code>cat</code>以<code>byName</code>的方式查找，仍然找不到，因此注入失败。</p>
<p>这种情况下，就需要使用<code>@Qualifier</code> 注解：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//使用@Qualifier注解，指明查找的id名，即根据这个value在容器中查找bean</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Person</span> </span>{<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-meta">@Qualifier(value = "cat2")</span><br>    <span class="hljs-keyword">private</span> Cat cat;<br>    <br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> Dog dog;<br>    <span class="hljs-keyword">private</span> String name;<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>同时使用 <code>@Autowired</code>和<code>@Qualifier(value = "cat2")</code>两个注解，并指定按名称查找时的<code>id</code>，可以在容器中找到<code>id</code>为<code>cat2</code>的<code>bean</code>，因此可以注入成功，可以通过代码验证这一点：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>    ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext2.xml"</span>);<br>    Person person = context.getBean(<span class="hljs-string">"person"</span>, Person.class);<br>    System.out.println(person.toString());<br>    System.out.println(context.getBean(<span class="hljs-string">"cat1"</span>)+<span class="hljs-string">"  "</span>+context.getBean(<span class="hljs-string">"cat2"</span>));<br>}<br><span class="hljs-comment">/*运行结果</span><br><span class="hljs-comment">Person{cat=com.kang.pojo.Cat@2177849e, dog=com.kang.pojo.Dog@40cb8df7, name='kang'}</span><br><span class="hljs-comment">com.kang.pojo.Cat@13b13b5d  com.kang.pojo.Cat@2177849e</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，<code>person</code>实例中的<code>cat</code>属性被注入了值，并且这个对象确实是<code>@Qualifier</code>指定的<code>id</code>为<code>cat2</code>的<code>bean</code>。</p>
<p><code>@Resource</code>注解可以使用<code>byName</code>和 <code>byType</code>的方式注入，优先使用<code>byName</code>的方式，具体使用案例不再赘述。</p>
<h1 id="七、使用注解开发"><a href="#七、使用注解开发" class="headerlink" title="七、使用注解开发"></a>七、使用注解开发</h1><p>使用注解开发，就是在Java代码中使用注解的方式，取代<code>xml</code>文件中配置的方式。<strong>使用注解</strong>和<strong>XML配置</strong>是Spring开发的两种主要的方式。</p>
<p>在Spring4之后，要使用注解开发，必须要保证已经导入了aop的包。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/spring-basis_2.png"><span class="image-caption">确保导入aop包</span></p>
<p>使用注解，需要在<code>applicationContext.xml</code>配置文件的头部添加注解对应的支持，使用<code>&lt;contex&gt;</code>指定需要使用的注解相关的配置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">"http://www.springframework.org/schema/context"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/context</span></span><br><span class="hljs-tag"><span class="hljs-string">                           https://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--指定要扫描的包，这个包下的注解就会生效</span><br><span class="hljs-comment">        这个标签也包括了annotation-config的功能</span><br><span class="hljs-comment">        所以如果使用了这个标签，就可以不使用annotation-config了</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">"com.kang"</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!--</span><br><span class="hljs-comment">    使用context:annotation-config 可以隐式地自动向Spring容器注册4个BeanPostProcessor：</span><br><span class="hljs-comment">    AutowiredAnnotationBeanPostProcessor</span><br><span class="hljs-comment">    CommonAnnotationBeanPostProcessor</span><br><span class="hljs-comment">    PersistenceAnnotationBeanPostProcessor</span><br><span class="hljs-comment">    RequiredAnnotationBeanPostProcessor</span><br><span class="hljs-comment">    这样就可以使用@Resource 、@PostConstruct、@PreDestroy、</span><br><span class="hljs-comment">    @PersistenceContext、@Autowired、@Required等注解了，就可以实现自动注入。</span><br><span class="hljs-comment">    注册这4个 BeanPostProcessor的作用，就是为了系统能够识别相应的注解。</span><br><span class="hljs-comment">    --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:annotation-config</span>/&gt;</span><br><br>    <span class="hljs-comment">&lt;!--    &lt;bean id="user" class="com.kang.pojo.User"&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--        &lt;property name="name" value="kangst"/&gt;--&gt;</span><br>    <span class="hljs-comment">&lt;!--    &lt;/bean&gt;--&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="7-1-注册bean"><a href="#7-1-注册bean" class="headerlink" title="7.1 注册bean"></a>7.1 注册bean</h2><p><code>@Componet</code>：组件，用于<strong>类</strong>上，说明这个类被Spring管理了，就是<code>bean</code>，等价于在<code>xml</code>配置文件中使用<code>&lt;bean&gt;</code>标签注册。默认的<code>id</code>为类名的小写。也可以显式指定<code>id</code>名。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//@Component等价于&lt;bean id="user" class="com.kang.pojo.User"/&gt;</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>    <span class="hljs-keyword">public</span> String name;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>@Component</code>注解等价于<code>xml</code>配置文件中的：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"user"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.pojo.User"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="7-2-属性注入"><a href="#7-2-属性注入" class="headerlink" title="7.2 属性注入"></a>7.2 属性注入</h2><p>使用<code>@Value</code>注解可以为属性注入值：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>    <span class="hljs-comment">//@Value用于给属性赋值。相当于&lt;property name="name" value="Jarry"/&gt;</span><br>    <span class="hljs-meta">@Value("kangst")</span><br>    <span class="hljs-keyword">public</span> String name;<br><br>    <span class="hljs-comment">//@Value也可以用在set方法上</span><br>    <span class="hljs-meta">@Value("Jarry")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>{<br>        <span class="hljs-keyword">this</span>.name = name;<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>@Value</code>注解等价于<code>xml</code>配置文件中的：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"name"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"Jarry"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="7-3-Component的衍生注解"><a href="#7-3-Component的衍生注解" class="headerlink" title="7.3 @Component的衍生注解"></a>7.3 @Component的衍生注解</h2><p><code>@Component</code>的几个衍生注解，比如在dao层、service层、controller层有各自的注解，在功能上和<code>@Component</code>是一样的。</p>
<p>这几个衍生注解可以解释为<code>@Component</code>的具体形式，<strong>他们在Spring中的功能是相同的</strong>，都是用于将其注解的类注册到Spring容器中，让容器托管。在不同的层使用不同的注解可以增加程序的可读性。</p>
<ul>
<li><code>@Repository</code>：用于dao层，标注dao组件</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Repository</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserDao</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><code>@Service</code>：用于service层</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserService</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<ul>
<li><code>@Controller</code>：用于controller层</li>
</ul>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserController</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="7-4-自动装配"><a href="#7-4-自动装配" class="headerlink" title="7.4 自动装配"></a>7.4 自动装配</h2><p>自动装配相关的注解，第六节已经详细介绍过了：</p>
<ul>
<li><code>@Autowired</code></li>
<li><code>@Qualifier</code></li>
<li><code>@Resource</code> </li>
</ul>
<p>还有其他的注解，比如<code>@Nullable</code>注解标记的属性或字段允许为<code>null</code>。</p>
<h2 id="7-5-作用域"><a href="#7-5-作用域" class="headerlink" title="7.5 作用域"></a>7.5 作用域</h2><p>使用<code>@Scope</code>注解可以指定当前bean的作用域，效果等价于配置文件中的<code>scope</code>属性。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Scope(value = "prototype")</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="7-6-小结"><a href="#7-6-小结" class="headerlink" title="7.6 小结"></a>7.6 小结</h2><p><strong>XML文件配置和注解两种方式对比</strong></p>
<ul>
<li>XML适用性更好，适用于各种情况；便于维护。</li>
<li>注解只能在当前类使用；维护起来更复杂。</li>
</ul>
<p>最佳实践：XML文件用来管理<code>bean</code>，注解只负责完成属性的注入。</p>
<p>使用注解时，需要注意要在配置文件中让注解生效，开启注解的支持。</p>
<h1 id="八、基于Java的容器配置"><a href="#八、基于Java的容器配置" class="headerlink" title="八、基于Java的容器配置"></a>八、基于Java的容器配置</h1><h2 id="8-1-使用Java配置类"><a href="#8-1-使用Java配置类" class="headerlink" title="8.1 使用Java配置类"></a>8.1 使用Java配置类</h2><p>上述使用注解的方式，仍然需要使用XML配置文件写一部分内容。这一节讲述如何<strong>使用Java代码完全代替XML配置文件</strong>，对Spring容器进行配置。</p>
<p>完全使用Java程序进行容器配置主要依赖于<code>JavaConfig</code>，其是Spring的一个子项目，在Spring之后它成为了核心功能。</p>
<p>使用Java类作为配置文件，实现XML配置文件的功能，完全取代了XML配置文件。</p>
<p>比如，创建一个配置类<code>MyConfig</code>:</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.config;<br><span class="hljs-keyword">import</span> com.kang.pojo.User;<br><br><span class="hljs-comment">//@Configuration代表这是一个配置类，就和applicationContext.xml配置文件一样</span><br><span class="hljs-comment">//将当前类交给Spring容器托管，注册到容器中，因为它底层本质也是一个Component</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-comment">//相当于配置文件中的&lt;context:component-scan base-package="com.kang.pojo"/&gt;</span><br><span class="hljs-comment">//@ComponentScan("com.kang.pojo")  </span><br><span class="hljs-comment">//引入另一个配置类</span><br><span class="hljs-comment">//@Import(MyConfig2.class)  </span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyConfig</span> </span>{<br>    <span class="hljs-comment">//@Bean就相当于配置文件中的&lt;bean&gt;标签，注册一个bean；</span><br>    <span class="hljs-comment">//这个方法的名字就相当于bean标签中的id</span><br>    <span class="hljs-comment">//方法的返回值就是bean标签中的class，表示要注册的类</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getUser</span><span class="hljs-params">()</span></span>{<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> User(); <span class="hljs-comment">//返回要注入到容器中的对象</span><br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>配置类中使用注解替代XML文件的功能，比如：</p>
<ul>
<li><p><code>@Configuration</code>：代表这是一个配置类，就和<code>applicationContext.xml</code>配置文件一样。同时这个注解表示将当前类交给Spring容器托管，注册到容器中，因为其底层也是<code>@Component</code>。</p>
</li>
<li><p><code>@Bean</code>：类似于<code>&lt;bean&gt;</code>标签，功能是在容器中注册一个bean，其id默认是方法名（可以指定别名），返回类型就是要注册的bean。</p>
</li>
</ul>
<p>还有其他的一些注解：</p>
<ul>
<li><p><code>@ComponentScan</code>：相当于配置文件中的<code>&lt;context:component-scan base-package="xxx.xxx"/&gt;</code>扫描包，使这个包下文件的注解生效。</p>
</li>
<li><p><code>@Import</code>：可以用于引入另一个配置类，也可以用来注册其他类的bean，相当于XML文件中的<code>&lt;import&gt;</code>标签。</p>
</li>
</ul>
<p>有了配置类和bean以后，我们就可以实例化容器，获取注册好的bean对象：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>    <span class="hljs-comment">//如果完全使用配置类，只能通过AnnotationConfigApplicationContext来获取容器</span><br>    <span class="hljs-comment">//通过配置类的class对象加载。</span><br>    ApplicationContext context = <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(MyConfig.class);<br>    <span class="hljs-comment">//默认id为方法名</span><br>    User getUser = context.getBean(<span class="hljs-string">"getUser"</span>, User.class);<br>    System.out.println(getUser.toString());<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>要注意的是，如果我们完全使用Java配置类，实例化容器用的是<code>AnnotationConfigApplicationContext</code>类。</p>
<p><code>ApplicationContex</code>接口有很多实现类，<code>AnnotationConfigApplicationContext</code>也只是其中一种。</p>
<h2 id="8-2-Component和-Bean对比"><a href="#8-2-Component和-Bean对比" class="headerlink" title="8.2 @Component和@Bean对比"></a>8.2 @Component和@Bean对比</h2><p><strong>相同点</strong></p>
<p>二者都是注册bean。</p>
<p><strong>不同点</strong></p>
<ul>
<li>作用对象不同：<strong><code>@Component</code> 注解作用于类，而<code>@Bean</code>注解作用于方法</strong>。</li>
<li><code>@Component</code>通常是通过类路径扫描来自动侦测以及自动装配到Spring容器中（我们可以使用 <code>@ComponentScan</code> 注解定义要扫描的路径从中找出标识了需要装配的类自动装配到 Spring 的 bean 容器中）。<code>@Bean</code> 注解通常是在标有该注解的方法中定义产生这个 bean，<code>@Bean</code>告诉了Spring这是某个类的示例，当我们需要用它的时候容器会将其传递给我们。</li>
<li><code>@Bean</code> 注解比 <code>Component</code> 注解的自定义性更强，而且<strong>很多地方我们只能通过 <code>@Bean</code> 注解来注册bean</strong>。比如<strong>当我们引用第三方库中的类需要装配到 <code>Spring</code>容器时，则只能通过 <code>@Bean</code>来实现</strong>。</li>
</ul>
<p>只能使用 <code>@Bean</code>而不能使用 <code>Component</code> 的案例：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> OneService <span class="hljs-title">getService</span><span class="hljs-params">(<span class="hljs-keyword">int</span> status)</span> </span>{<br>    <span class="hljs-keyword">switch</span> (status)  {<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> serviceImpl1();<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> serviceImpl2();<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> serviceImpl3();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h1 id="九、代理模式"><a href="#九、代理模式" class="headerlink" title="九、代理模式"></a>九、代理模式</h1><p>Spring的AOP底层实现原理就是使用的<strong>代理模式</strong>。</p>
<p>使用代理模式能够在不改变原有代码的情况下，添加一些其他功能，符合<strong>“开闭原则”，即“对扩展开放，对修改封闭”</strong>。举个例子，比如说希望在当前程序的某个方法执行前后添加一个功能，直接修改源代码的做法是不提倡的，正确做法是使用一个代理类，将其功能代理过来然后添加新的功能。</p>
<p>这种<strong>不改变原有代码，使用横向切入的开发方式，就是AOP（面向切面编程）的思想</strong>。</p>
<p>代理模式的优势：</p>
<ul>
<li>使被代理类的操作更加纯粹，不用关注一些额外功能。</li>
<li>额外功能交给代理类来实现，实现了业务的分工。</li>
<li>额外功能发生扩展时，方便集中管理。</li>
</ul>
<h2 id="9-1-静态代理"><a href="#9-1-静态代理" class="headerlink" title="9.1 静态代理"></a>9.1 静态代理</h2><p>代理模式一般有以下三种角色：</p>
<p><strong>接口</strong>：代理类和被代理类共同实现的接口。这样用户只需要对接口操作，不需要关心实现类是真实对象还是代理类对象。</p>
<blockquote>
<p>虽然代理类不实现这个接口，使用组合的方式也能完成同样的功能，但是那样扩展性差。</p>
<p>JDK接口实现的动态代理模式中，要求必须实现共同的接口，因为它就是代理的接口。</p>
<p>Cglib实现的动态代理不需要实现接口，它是通过自动创建子类来实现代理的。</p>
</blockquote>
<p><strong>被代理类</strong>：实现接口，被代理类不直接和用户交互。</p>
<p><strong>代理类</strong>：用于代理被代理类，供客户调用，完成被代理类的功能的同时，有一些扩展的功能。直接和用户交互。</p>
<p>静态代理的缺点：一个代理类只能代理一个接口，当被代理的接口增加的时候，会导致代理类翻倍。另外，如果接口中的功能修改了，会导致代理类也会修改。</p>
<h2 id="9-2-动态代理"><a href="#9-2-动态代理" class="headerlink" title="9.2 动态代理"></a>9.2 动态代理</h2><p><strong>什么是动态代理</strong></p>
<p>动态代理能够动态生成代理类，而不需要我们手动去写代理类。动态代理和静态代理的代理角色是一样的。</p>
<p><strong>动态代理的实现方式</strong></p>
<p>动态代理主要有<strong>基于接口的动态代理</strong>和<strong>基于类的动态代理</strong>两种方式：</p>
<ul>
<li><p>基于接口：JDK的动态代理，代理类和被代理类实现共同的接口，动态代理返回的代理类类型就是这个接口类型。</p>
</li>
<li><p>基于类：Cglib。如果没有实现接口，则需要使用Cglib，生成被代理对象的子类来作为代理。</p>
<blockquote>
<p>实现接口的情况下也能用Cglib，只不过是代理的不是接口，而是使用子类来实现。</p>
</blockquote>
</li>
</ul>
<p>还有一种Java字节码实现：Javassist，是一个创建Java字节码的类库，可以直接编辑和生成Java生成的字节码。</p>
<p><strong>动态代理的优势</strong></p>
<p>动态代理除了具有传统代理模式的优势以外，还有其特有的优势：</p>
<ul>
<li>动态代理类代理的同样是接口，但可以同时代理一个或多个接口，一般对应的是<strong>一类</strong>业务。</li>
<li>一个动态代理类可以代理多个类，前提是<strong>这些类都是同一个接口的实现类</strong>。也就是说，对于这些被代理类，代理类做的额外工作是相同的，这样这些被代理类都可以使用这一个代理类完成代理。</li>
</ul>
<p><strong>基于接口的动态代理具体实现</strong></p>
<p>基于接口的动态代理是指<strong>JDK动态代理，代理的是接口</strong>。因此这种方式<strong>要求代理类和被代理类必须实现同一个接口</strong>。</p>
<p>JDK动态代理主要使用<code>Proxy</code>类和<code>InvocationHandler</code>两个接口。主要步骤是：</p>
<ul>
<li>实现<code>InvocationHandler</code>接口和其中的<code>invoke()</code>方法，主要是用于动态地调用被代理类中的同名方法。这一步中需要被代理类的实例。</li>
<li>调用<code>Proxy</code>类的<code>newProxyInstance</code>方法，生成代理类对象，其中需要<code>InvocationHandler</code>实现类对象作为参数。这一步主要是用于动态生成代理类对象。</li>
</ul>
<p>详情可以参考<a href="https://kangshitao.github.io/2021/04/18/java-note-1501/#%E4%B8%83%E3%80%81%E5%8F%8D%E5%B0%84%E7%9A%84%E5%BA%94%E7%94%A8%EF%BC%9A%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86">反射的应用-动态代理</a>。</p>
<p>下面是一种动态代理的实现：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DynamicProxyTest</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{<br>        <span class="hljs-comment">//创建一个UserService实现类的对象，即被代理类对象</span><br>        UserService userService = <span class="hljs-keyword">new</span> UserServiceImpl();<br>        <span class="hljs-comment">//根据这个被代理类对象，生成一个代理类对象的实例</span><br>        <span class="hljs-comment">//根据这里可以看出，被代理类必须也要实现接口，不然无法实现代理功能</span><br>        UserService proxyInstance = (UserService) ProxyFactory.getProxyInstance(userService);<br>        <span class="hljs-comment">//调用代理类实例的方法，可以完成被代理类的功能和一些额外的方法。</span><br>        proxyInstance.addUser();<br>    }<br>}<br><br><span class="hljs-comment">//步骤1，需要实现InvocationHandler接口</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvocationHandlerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InvocationHandler</span> </span>{<br>    <span class="hljs-keyword">private</span> Object obj; <span class="hljs-comment">//被代理类的对象</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setObj</span><span class="hljs-params">(Object obj)</span> </span>{<br>        <span class="hljs-keyword">this</span>.obj = obj;<br>    }<br><br>    <span class="hljs-comment">//当通过代理类的对象调用某个方法时，就会自动调用这个invoke()方法。</span><br>    <span class="hljs-comment">//我们将代理类要执行的额外的方法写在里面，就可以完成代理的功能。</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">invoke</span><span class="hljs-params">(Object proxy, Method method, </span></span><br><span class="hljs-function"><span class="hljs-params">                         Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable </span>{<br>        <span class="hljs-comment">//proxy参数好像没用？</span><br>        System.out.println(<span class="hljs-string">"调用方法之前，代理类执行一些额外方法"</span>);<br>        <span class="hljs-comment">//调用被代理类对象的同名方法，args表示传入的参数，此返回值就是原方法的返回值</span><br>        Object result = method.invoke(obj, args);<br>        System.out.println(<span class="hljs-string">"调用方法之后，代理类执行一些额外方法"</span>);<br>        <span class="hljs-keyword">return</span> result;<br>    }<br>}<br><br><span class="hljs-comment">//步骤2，创建一个类，用来获取被代理类的实例</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProxyFactory</span> </span>{<br>    <span class="hljs-comment">//obj表示被代理类的对象</span><br>    <span class="hljs-comment">//这里可以使用泛型，避免使用时类型强转。</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">getProxyInstance</span><span class="hljs-params">(Object obj)</span> </span>{<br>        InvocationHandlerImpl handler = <span class="hljs-keyword">new</span> InvocationHandlerImpl();<br>        handler.setObj(obj);<br>        <span class="hljs-comment">//调用Proxy类的newProxyInstance方法获取被代理类的实例</span><br>        <span class="hljs-comment">//需要将InvocationHandler实现类的对象作为参数</span><br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(<br>            obj.getClass().getClassLoader(),                  <br>            obj.getClass().getInterfaces(), <br>            handler);<br>    }<br>}<br><span class="hljs-comment">/*运行结果</span><br><span class="hljs-comment">调用方法之前，代理类执行一些额外方法</span><br><span class="hljs-comment">执行UserServiceImpl类的addUser()方法</span><br><span class="hljs-comment">调用方法之后，代理类执行一些额外方法</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，当一个接口有多个实现类的时候，使用以上动态代理的方法，只要将被代理的对象传入，就可以自动生成一个代理类的对象，通过这个代理类对象完成代理功能。</p>
<blockquote>
<p>如果使用了代理模式，因为要返回一个代理类对象，所以容器的<code>getBean()</code>方法的传入参数必须是共同实现的接口class对象。</p>
<p>如果没有使用代理模式，就是一般的IOC，则容器中返回的依旧是原生对象。</p>
</blockquote>
<p><strong>动态代理代理的是接口，返回的代理类对象必须使用接口类型接收</strong>，否则无法判断具体的类型，就不能调用相关方法。这也是代理类必须要和被代理类实现同一个接口的原因。</p>
<h1 id="十、AOP"><a href="#十、AOP" class="headerlink" title="十、AOP"></a>十、AOP</h1><h2 id="10-1-AOP介绍"><a href="#10-1-AOP介绍" class="headerlink" title="10.1 AOP介绍"></a>10.1 AOP介绍</h2><h3 id="10-1-1-简介"><a href="#10-1-1-简介" class="headerlink" title="10.1.1 简介"></a>10.1.1 简介</h3><p>官方文档中关于AOP的介绍：<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop">Aspect Oriented Programming with Spring</a></p>
<p>AOP(Aspect Oriented Programming)，面向切片编程，通过<strong>预编译</strong>方式（比如AspectJ）和<strong>运行期动态代理</strong>（比如Spring AOP）实现程序功能的统一维护的一种技术。利用AOP可以对业务逻辑各个部分进行隔离，使业务逻辑各部分之间的<strong>耦合度降低</strong>，提高程序的可重用性，同时提高开发效率。</p>
<p>AOP<strong>能够将那些与业务无关却为业务模块所共同调用的逻辑或责任（例如事务处理、日志管理、权限控制等）封装起来</strong>，便于<strong>减少系统的重复代码、降低模块间的耦合度</strong>，并<strong>有利于未来的可扩展性和可维护性</strong>。</p>
<p>通俗点说，AOP提供声明式事务，允许用户自定义切面，<strong>在不改变原来代码的情况下，增加新的功能</strong>。</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/spring-basis_3.png"><span class="image-caption">AOP示意图</span></p>
<h3 id="10-1-2-相关概念"><a href="#10-1-2-相关概念" class="headerlink" title="10.1.2 相关概念"></a>10.1.2 相关概念</h3><p><strong>AOP的相关概念，参考官方文档：<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop-introduction-defn">AOP Concepts</a></strong>：</p>
<ul>
<li><p><strong>横切关注点</strong>：跨越应用程序多个模块的方法或功能，和业务逻辑无关但需要关注的地方，比如安全（验证）、事务、日志、缓存等。</p>
</li>
<li><p><strong>Aspect：切面</strong>，是Advice和PointCut的集合，通知和切入点共同定义了切面的全部功能，即它是什么，在何时何处完成其功能。切面是横切关注点被模块化的<strong>类</strong>。</p>
</li>
<li><p><strong>Advice：通知，增强</strong>。即切面中要完成的工作，一般为切面类中的<strong>方法</strong>。共有五种类型。<strong>定义了“切入什么”和“何时切入“</strong>。</p>
</li>
<li><p><strong>Target：目标</strong>，相当于被代理类，即被通知的对象。</p>
</li>
<li><p><strong>Proxy：代理</strong>，相当于代理类，向target对象应用通知后创建的对象。</p>
</li>
<li><p><strong>JointPoint：连接点</strong>。指应用执行过程中能够插入切面的点，或者说能够应用通知的所有点，Spring AOP中的连接点指的是方法。</p>
</li>
<li><p><strong>PointCut：切入点</strong>。实际要切入的位置，<strong>定义了在”何处“切入</strong>。是一个具体确定的连接点。</p>
</li>
<li><p><strong>Introduction：引入</strong>。向现有的类中添加方法或属性。</p>
</li>
<li><p><strong>Weaving：织入</strong>。就是把切面连接到应用程序类型或者对象上，并创建代理对象的过程。</p>
<blockquote>
<p>在目标对象的生命周期里有多个点可以进行织入：</p>
<p>1、编译期织入：切面在目标类编译时期被织入。AspectJ采用的织入方式。</p>
<p>2、类加载期织入：目标类被引入之前增强该目标类的字节码。AspectJ5采用的方式</p>
<p>3、运行期织入：切面在应用运行期间的某个时刻被织入。Spring AOP采用这种方式，在织入切面的时候，AOP容器会为目标对象动态的创建代理对象。</p>
</blockquote>
</li>
</ul>
<p><strong>Advice的五种类型：</strong></p>
<ul>
<li><code>Before advice</code>：前置通知。在连接点前面执行，前置通知不会影响连接点的执行，除非此处抛出异常。</li>
<li><code>After returning  advice</code>：正常返回通知。在连接点正常执行完成后执行，如果连接点抛出异常，则不会执行。</li>
<li><code>After throwing advice</code>： 异常返回通知。在连接点抛出异常后执行。</li>
<li><code>After (finally) advice</code>：返回通知。在连接点执行完成后执行，不论连接点有没有抛出异常，都会执行。</li>
<li><code>Around advice</code>：环绕通知。围绕在连接点前后，比如一个方法调用的前后。这是最强大的通知类型，能在方法调用前后自定义一些操作。环绕通知还需要负责决定是继续处理连接点（调用<code>ProceedingJoinPoint</code>的<code>proceed</code>方法）还是中断执行。 <strong>环绕通知能够在前置通知之前，和返回通知之前执行一些操作</strong>，并且能够控制连接点是否继续执行。</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/spring-basis_5.png"><span class="image-caption">AOP执行示意图</span></p>
<h2 id="10-2-AOP实现原理"><a href="#10-2-AOP实现原理" class="headerlink" title="10.2  AOP实现原理"></a>10.2  AOP实现原理</h2><p>String AOP的实现是<strong>基于动态代理</strong>的，如前面所述，如果被代理对象实现了某个接口，则会使用JDK的Proxy接口创建代理对象，实现动态代理；否则，如果被代理对象没有实现接口，此时必须使用Cglib来生成被代理对象的子类作为代理。</p>
<p>关于开启CGLIB代理的配置，可以参考官方文档：<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop-mixing-styles">Mixing Aspect Types</a></p>
<p>下图展示了两种代理模式的实现原理（<a href="https://snailclimb.gitee.io/javaguide/#/docs/system-design/framework/spring/Spring%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93?id=aop">参考JavaGuide</a>）：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/spring-basis_4.jpg"><span class="image-caption">JDK Proxy和CGLib代理</span></p>
<h2 id="10-3-Spring-AOP和AspectJ-AOP"><a href="#10-3-Spring-AOP和AspectJ-AOP" class="headerlink" title="10.3 Spring AOP和AspectJ AOP"></a>10.3 Spring AOP和AspectJ AOP</h2><p>AOP有多种实现框架，在Spring中主要是<strong>Spring AOP实现</strong>和<strong>AspectJ AOP</strong>两种实现方式。</p>
<p>AspectJ AOP也是一种AOP编程扩展框架，其内部使用BCEL框架完成其功能。</p>
<p><strong>Spring AOP基于代理模式，属于运行时增强；而AspectJ基于字节码操作(Bytecode Manipulation)，是编译时增强。</strong></p>
<p>Spring中集成了AspectJ，AspectJ 的AOP功能相比于Spring AOP功能更加强大，但Spring AOP使用起来更简单。</p>
<p><strong>关于Spring AOP和AspectJ的选择问题</strong></p>
<p>官方说明：<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop-choosing">Choosing which AOP Declaration Style to Use</a></p>
<ul>
<li>如果切面较少，两者性能差异不大。如果切面太多时，AspectJ比Spring AOP快很多。</li>
<li>如果只需要在Spring bean上执行通知，建议使用Spring AOP即可</li>
<li>如果需要通知不受Spring 容器管理的对象，比如域对象，则需要使用AspectJ</li>
<li>如果希望通知连接点，而不是仅通知简单的方法（比如set、get方法等），则需要使用AspectJ</li>
</ul>
<h2 id="10-4-AOP在Spring-中的实现"><a href="#10-4-AOP在Spring-中的实现" class="headerlink" title="10.4 AOP在Spring 中的实现"></a>10.4 AOP在Spring 中的实现</h2><p>参考官方文档<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop">Aspect Oriented Programming with Spring</a></p>
<p>Spring中实现AOP需要导入AOP织入包：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.aspectj/aspectjweaver --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjweaver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>Spring中实现AOP可以通过三种方式，其中前两种都是Spring AOP，第三种是AspectJ AOP：</p>
<ul>
<li>实现Spring提供的接口，比如<code>MethodBeforeAdvice</code>、<code>AfterReturningAdvice</code>等接口。</li>
<li>自定义切面类，然后在XML配置文件中使用<code>&lt;aop:config&gt;</code>标签。</li>
<li>使用注解，借助内部集成的AspectJ实现AOP。在切面类中使用<code>@Aspect</code>、<code>@Before</code>、<code>@After</code>、<code>@Around</code>等注解。</li>
</ul>
<h3 id="10-4-1-方式一：实现Spring接口"><a href="#10-4-1-方式一：实现Spring接口" class="headerlink" title="10.4.1 方式一：实现Spring接口"></a>10.4.1 方式一：实现Spring接口</h3><p>Spring中给定了一些相关的接口，用于定义通知，比如<code>MethodBeforeAdvice</code>、<code>AfterReturningAdvice</code>等接口。我们需要实现这些接口，完成通知的具体功能。</p>
<p>通过实现Spring接口实现AOP的方法，主要是使用<code>&lt;aop:advisor&gt;</code>标签，具体实现如下：</p>
<p><strong>1、定义接口的实现类，实现对象通知方法</strong></p>
<p>可以用一个实现类同时实现多个通知接口，也可以创建多个类各自实现一个接口。</p>
<p>这里创建一个<code>Log</code>类，在目标方法执行前后输出一些信息：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Log</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">MethodBeforeAdvice</span>,<span class="hljs-title">AfterReturningAdvice</span></span>{<br>    <span class="hljs-comment">/**实现before方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> method 反射方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> args 方法的参数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> target 方法调用的目标对象，可以为空</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">before</span><span class="hljs-params">(Method method, Object[] args, Object target)</span> </span>{<br>        System.out.println(<span class="hljs-string">"Before:"</span>+target.getClass().getName()+<br>                           <span class="hljs-string">"类的"</span>+method.getName()+<span class="hljs-string">"方法被执行"</span>);<br>    }<br><br>    <span class="hljs-comment">//实现afterReturning方法</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterReturning</span><span class="hljs-params">(Object returnValue, Method method, </span></span><br><span class="hljs-function"><span class="hljs-params">                               Object[] args, Object target)</span> </span>{<br>        System.out.println(<span class="hljs-string">"After:"</span>+<span class="hljs-string">"执行了"</span>+method.getName()+<br>                           <span class="hljs-string">",返回结果为："</span>+returnValue);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、在配置文件中注册bean，然后配置AOP</strong>：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 将Log类注册为bean --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"log"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.log.Log"</span>/&gt;</span><br><span class="hljs-comment">&lt;!-- 配置AOP --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">aop:config</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--配置切入点--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"pointcut"</span> <span class="hljs-attr">expression</span>=</span><br><span class="hljs-tag">                  "<span class="hljs-attr">execution</span>(* <span class="hljs-attr">com.kang.service.UserServiceImpl.</span>*(<span class="hljs-attr">..</span>))"/&gt;</span><br>    <span class="hljs-comment">&lt;!-- advisor，定义通知器，类似于切面，包括了通知和切点 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- 如果有多个实现类，就写多个标签 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:advisor</span> <span class="hljs-attr">advice-ref</span>=<span class="hljs-string">"log"</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">"pointcut"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">aop:config</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>advisor</code>表示定义一个通知器，通知器的概念类似于切面，包括了通知和切入点。</p>
<p>为了可读性，建议一个实现类对应一个通知接口，这样一个类就可以表示一个通知，结构清晰。</p>
<p><strong>3、配置完后，可以测试是否生效：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>{<br>    ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext.xml"</span>);<br>    <span class="hljs-comment">// 动态代理是代理的接口，因此这里必须传入的是接口的class对象</span><br>    UserService userService = context.getBean(<span class="hljs-string">"userService"</span>,UserService.class);<br>    userService.queryUser();<br>}<br><span class="hljs-comment">/*执行结果</span><br><span class="hljs-comment">Before:com.kang.service.UserServiceImpl类的queryUser方法被执行</span><br><span class="hljs-comment">执行queryUser()方法</span><br><span class="hljs-comment">After:执行了queryUser,返回结果为：null</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>补充：关于切点表达式</strong></p>
<p>切点表达式主要用于定位连接点。详细用法可以参考<a href="https://www.jianshu.com/p/d99e3d0edc32">切点表达式</a>、<a href="https://www.kancloud.cn/apachecn/howtodoinjava-zh/1952644">Spring AOP AspectJ 切入点表达式示例</a></p>
<p>表达式中有三种通配符：</p>
<ul>
<li><code>*</code>：匹配任何数量字符</li>
<li><code>..</code>：用在路径中表示任何数量子包，用在参数中则表示任何数量参数。</li>
<li><code>+</code>：匹配指定类型的子类型，仅能作为后缀放在类型模式后边。</li>
</ul>
<p>格式如下：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">//[]内的内容可以省略<br>execution([方法修饰符] 返回值类型 [包路径]方法名(参数类型列表)[throws 异常类型])<br></code></pre></td></tr></tbody></table></figure>
<p>execution表达式主要由三部分组成</p>
<ul>
<li>方法修饰符，比如<code>public</code>、<code>private</code>等；可以省略</li>
<li>返回值类型，可以用<code>*</code>表示所有类型。</li>
<li>[包路径]方法名及其参数类型的列表。其中<code>*</code>表示所有方法或所有类，参数类型列表中填的是参数的类型。其中包路径可以省略，表示表示所有包下和这个方法同名的方法。</li>
</ul>
<p>此外，在AspectJ中，切入点表达式可以通过<code>&amp;&amp;</code>、<code>||</code>、<code>!</code>来组合切入点表达式，由于在XML中使用<code>&amp;&amp;</code>需要使用转义字符来代替，因此Spring AOP 使用<code>and</code>、<code>or</code>、<code>not</code>来代替。</p>
<p>表达式举例：</p>
<p>1、全通配</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">execution(* *..*.*(..))<br></code></pre></td></tr></tbody></table></figure>
<p>2、匹配所有目标类以xxx开头的方法，第一个*代表返回任意类型，参数类型为任意数量的任意类型。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">execution(* xxx* (..))<br></code></pre></td></tr></tbody></table></figure>
<p>3、匹配Service接口及其实现子类中的所有方法</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">execution(* com.xxx.Service.*(..))<br></code></pre></td></tr></tbody></table></figure>
<p>4、匹配service包下的所有类的所有方法，<strong>但不包括子包</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">execution(* com.xxx.service.*(..))<br></code></pre></td></tr></tbody></table></figure>
<p>5、匹配aop_part包下的所有类的所有方法，包括子包。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"># 注意 （当".."出现在类名中时，后面必须跟" * ",表示包、子孙包下的所有类**）<br>execution(* com.xxx.service..*(..))<br></code></pre></td></tr></tbody></table></figure>
<p>6、匹配所有方法名为add，且有两个参数，其中，第一个的类型为int 第二个参数是String</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">execution(* add(int, String))<br></code></pre></td></tr></tbody></table></figure>
<p>7、匹配所有方法名为add，且至少含有一个参数，并且第一个参数为int的方法</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml">execution(* add(int, ..))<br></code></pre></td></tr></tbody></table></figure>
<h3 id="10-4-2-方式二：自定义切面类"><a href="#10-4-2-方式二：自定义切面类" class="headerlink" title="10.4.2 方式二：自定义切面类"></a>10.4.2 方式二：自定义切面类</h3><p>自定义切面主要借助于<code>&lt;aop:aspect&gt;</code>来实现。我们只需要在切面类中定义通知方法，不需要实现接口。</p>
<p><strong>1、定义切面类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//定义两个通知方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyAspect</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">before</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-string">"before：方法执行前"</span>);<br>    }<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">after</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-string">"after：方法执行后"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、在配置文件中注册bean，然后配置AOP</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--方式二：自定义切面--&gt;</span><br><span class="hljs-comment">&lt;!-- 将切面类注册为bean --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"myAspect"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.diy.MyAspect"</span>/&gt;</span><br><span class="hljs-comment">&lt;!-- 配置AOP --&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">aop:config</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:aspect</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"myAspect"</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--定义切入点--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"pointcut"</span> <span class="hljs-attr">expression</span>=</span><br><span class="hljs-tag">                      "<span class="hljs-attr">execution</span>(* <span class="hljs-attr">com.kang.service.UserServiceImpl.</span>*(<span class="hljs-attr">..</span>))"/&gt;</span><br>        <span class="hljs-comment">&lt;!--定义通知，这里定义了before和after两种类型--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">aop:before</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"before"</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">"pointcut"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">aop:after</span> <span class="hljs-attr">method</span>=<span class="hljs-string">"after"</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">"pointcut"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">aop:aspect</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">aop:config</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>我们在配置文件中，使用<code>&lt;aop:aspect&gt;</code>定义切面类，然后定义切入点和通知的类型。</p>
<p><strong>3、测试是否生效：</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test2</span><span class="hljs-params">()</span></span>{<br>    ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext.xml"</span>);<br>    UserService userService = context.getBean(<span class="hljs-string">"userService"</span>, UserService.class);<br>    userService.deleteUser();<br>}<br><span class="hljs-comment">/*运行结果</span><br><span class="hljs-comment">before：方法执行前</span><br><span class="hljs-comment">执行deleteUser()方法</span><br><span class="hljs-comment">after：方法执行后</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>可以看到，这种方法和第一种方法比较相似，对比<code>&lt;aop:aspect&gt;</code>和<code>&lt;aop:advisor&gt;</code>：</p>
<ul>
<li><code>aspect</code>和<code>advisor</code>都是定义切面，二者最终的原理基本上是一样的。 </li>
<li><code>aspect</code>定义切面时，只需要定义一般的bean，而<code>advisor</code>中引用的通知，必须实现相应的通知接口。</li>
<li><code>advisor</code>大多用于事务管理。</li>
</ul>
<h3 id="10-4-3-方式三：使用AspectJ的注解"><a href="#10-4-3-方式三：使用AspectJ的注解" class="headerlink" title="10.4.3 方式三：使用AspectJ的注解"></a>10.4.3 方式三：使用AspectJ的注解</h3><p>前两种方法都是基于XML配置使用Spring AOP的实现，这种注解方式是使用AspectJ的注解实现AOP。</p>
<p><strong>1、创建类，并使用注解标记为切面类</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Aspect</span>  <span class="hljs-comment">//标注这个类是一个切面类</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnnotationAspect</span> </span>{<br>    <span class="hljs-comment">//将当前方法标记为前置通知，并指明切入点</span><br>    <span class="hljs-meta">@Before(value="execution(* com.kang.service.UserServiceImpl.*(..))")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">before</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-string">"注解Before：方法执行前"</span>);<br>    }<br><br>    <span class="hljs-meta">@After(value = "execution(* com.kang.service.UserServiceImpl.*(..))")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">after</span><span class="hljs-params">()</span></span>{<br>        System.out.println(<span class="hljs-string">"注解After：方法执行后"</span>);<br>    }<br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    环绕通知会在前置通知和返回通知之前执行一些东西，并且控制连接点是否继续执行</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@Around(value = "execution(* com.kang.service.UserServiceImpl.*(..))")</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">around</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span></span>{<br>        System.out.println(<span class="hljs-string">"注解Around：方法执行前"</span>);<br>        <span class="hljs-keyword">try</span> {<br>            <span class="hljs-comment">// 执行目标方法，如果不调用此方法，则会中断执行目标方法。</span><br>            pjp.proceed();<br>            <span class="hljs-comment">// pjp还可以获取目标方法的签名</span><br>            System.out.println(pjp.getSignature());<br>        } <span class="hljs-keyword">catch</span> (Throwable throwable) {<br>            throwable.printStackTrace();<br>        }<br>        System.out.println(<span class="hljs-string">"注解Around：方法执行后"</span>);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、注册bean并开启AspectJ注解</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"annotationAspect"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.anno.AnnotationAspect"</span>/&gt;</span><br><span class="hljs-comment">&lt;!-- 使AspectJ注解生效，默认使用JDK接口动态代理 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">aop:aspectj-autoproxy</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中Spring的动态代理默认使用的是JDK动态代理。也可以通过参数设置为使用cglib：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- proxy-target-class默认为false，表示使用JDK动态代理接口 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">aop:aspect-autoproxy</span> <span class="hljs-attr">proxy-target-class</span>=<span class="hljs-string">"true"</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>如果使用的是Java配置类，开启AspectJ需要使用<code>@EnableAspectJAutoProxy</code>注解：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@EnableAspectJAutoProxy</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppConfig</span> </span>{<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、测试是否织入成功</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test3</span><span class="hljs-params">()</span></span>{<br>    ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext.xml"</span>);<br>    UserService userService = context.getBean(<span class="hljs-string">"userService"</span>, UserService.class);<br>    userService.queryUser();<br>}<br><span class="hljs-comment">/*执行结果</span><br><span class="hljs-comment">注解Around：方法执行前</span><br><span class="hljs-comment">注解Before：方法执行前</span><br><span class="hljs-comment">query a user</span><br><span class="hljs-comment">void com.kang.service.UserService.queryUser()</span><br><span class="hljs-comment">注解Around：方法执行后</span><br><span class="hljs-comment">注解After：方法执行后</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></tbody></table></figure>
<p>使用注解的方式，如果每个通知的切入点相同，可以定义一个方法写切入点。</p>
<h3 id="10-4-4-总结"><a href="#10-4-4-总结" class="headerlink" title="10.4.4 总结"></a>10.4.4 总结</h3><p>选用XML配置还是AspectJ注解，需要视情况而定，官方说明：<a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#aop-ataspectj-or-xml">@AspectJ or XML for Spring AOP?</a>，官方文档提供了一个例子，只能使用AspectJ注解而无法使用XML的例子：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Pointcut("execution(* get*())")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">propertyAccess</span><span class="hljs-params">()</span> </span>{}<br><br><span class="hljs-meta">@Pointcut("execution(org.xyz.Account+ *(..))")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">operationReturningAnAccount</span><span class="hljs-params">()</span> </span>{}<br><br><span class="hljs-meta">@Pointcut("propertyAccess() &amp;&amp; operationReturningAnAccount()")</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">accountPropertyAccess</span><span class="hljs-params">()</span> </span>{}<br></code></pre></td></tr></tbody></table></figure>
<p>上述这种情况，只有前两种能用XML配置：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"propertyAccess"</span></span><br><span class="hljs-tag">              <span class="hljs-attr">expression</span>=<span class="hljs-string">"execution(* get*())"</span>/&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"operationReturningAnAccount"</span></span><br><span class="hljs-tag">              <span class="hljs-attr">expression</span>=<span class="hljs-string">"execution(org.xyz.Account+ *(..))"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>对于第三种这样结合使用过的方式，是XML无法完成的，这也是XML配置方式的一个缺陷。</p>
<h1 id="十一、整合MyBatis"><a href="#十一、整合MyBatis" class="headerlink" title="　十一、整合MyBatis"></a>　十一、整合MyBatis</h1><p>整合主要是将MyBatis中需要手动创建对象的地方，交给Spring容器去做。我们最后只需要通过容器获取实现类的对象，然后调用相关的方法即可。</p>
<p>我们主要使用<a href="http://mybatis.org/spring/zh/index.html"><code>MyBatis-Spring</code></a>来整合。</p>
<p>一般来说Spring和MyBatis有三种整合方式：</p>
<ul>
<li><p>使用<code>MapperScannerConfigurer</code>，它会查找类路径下的映射器并自动将它们创建为<code>MapperFactoryBean</code>。</p>
</li>
<li><p>使用<code>org.mybatis.spring.SqlSessionTemplate</code>类获取<code>SqlSession</code>实现类类对象，它是<code>SqlSession</code>接口的一个实现类</p>
</li>
<li><p>使用<code>org.mybatis.spring.support.SqlSessionDaoSupport</code>获取<code>SqlSession</code>实现类对象。相比于第二种方法，这中方法省略了在Spring容器中注册<code>SqlSessionTemplate</code>的步骤。</p>
<blockquote>
<p><code>org.apache.ibatis.session.SqlSession</code>类是MyBatis中和一个核心接口，它的实现类用于获取Mapper接口的实现类对象。</p>
</blockquote>
</li>
</ul>
<p>首先我们需要在Maven配置中导入MyBatis-Spring依赖和spring-jdbc依赖：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><br><span class="hljs-comment">&lt;!-- spring整合mybatis需要用的依赖 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.0.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- Spring操作数据库，还需要一个spring-jdbc --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.2.0.RELEASE<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>我们需要准备一个POJO类，和一个对应的Mapper接口，以及对应的Mapper配置类。</p>
<p><code>User</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String pwd;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">()</span> </span>{}<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>userMapper</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title">selectUser</span><span class="hljs-params">()</span></span>;<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>UserMapper.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">mapper</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">"com.kang.mapper.UserMapper"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"selectUser"</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">"User"</span>&gt;</span><br>        select * from user<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>目录结构如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/kangshitao/BlogPicture@main/img/spring-basis_6.png"><span class="image-caption">Spring-MyBatis整合目录</span></p>
<h2 id="11-1-方式一：使用SqlSessionTemplate"><a href="#11-1-方式一：使用SqlSessionTemplate" class="headerlink" title="11.1 方式一：使用SqlSessionTemplate"></a>11.1 方式一：使用SqlSessionTemplate</h2><p>主要思路是将MyBatis中需要手动创建对象的地方交给Spring容器处理。</p>
<p>参考<a href="http://mybatis.org/spring/zh/getting-started.html">mybatis-spring官方文档</a>，详细步骤如下：</p>
<p><strong>1、配置数据源</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- DataSource </span><br><span class="hljs-comment"> 使用Spring的数据源替换Mybatis的dataSource配置</span><br><span class="hljs-comment">    这个数据源可以使用任意的数据源，这里使用的是Spring提供的JDBC.</span><br><span class="hljs-comment">    需要导入spring-jdbc依赖。</span><br><span class="hljs-comment">    --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"driverClassName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.mysql.jdbc.Driver"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"url"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"jdbc:mysql://localhost:3306/mybatis?useSSL=false<span class="hljs-symbol">&amp;amp;</span>characterEncoding=UTF-8<span class="hljs-symbol">&amp;amp;</span>serverTimezone=UTC"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"username"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"root"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"123456"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>2、获取SqlSessionFactory对象</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 注册SqlSessionFactory --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sqlSessionFactory"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dataSource"</span> <span class="hljs-attr">ref</span> = <span class="hljs-string">"dataSource"</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!-- 还可以绑定Mybatis配置文件和注册Mapper --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"configLocation"</span> <span class="hljs-attr">value</span>=</span><br><span class="hljs-tag">              "<span class="hljs-attr">classpath:mybatis-config.xml</span>"/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mapperLocations"</span> <span class="hljs-attr">value</span>=</span><br><span class="hljs-tag">              "<span class="hljs-attr">classpath:com</span>/<span class="hljs-attr">kang</span>/<span class="hljs-attr">mapper</span>/<span class="hljs-attr">UserMapper.xml</span>"/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中<code>dataSource</code>属性是必须的。</p>
<p>关于<code>SqlSessionFactoryBean</code>的详细介绍可以参考<a href="http://mybatis.org/spring/zh/factorybean.html">SqlSessoinFactoryBean</a></p>
<p>值得注意的是，<code>mapperLocations</code>也可以接受多个资源位置，即注册多个映射器，比如下面的配置表示会从类路径下加载所有在<code>sample.config.mappers</code>包和它的子包中的映射器<code>xml</code>文件。</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"mapperLocations"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"classpath*:sample/config/mappers/**/*.xml"</span> /&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>3、获取SqlSessionTemplate对象</strong></p>
<p><code>SqlSessionTemplate</code>是<code>SqlSession</code>的一个实现类，可以无缝代替<code>SqlSession</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- SqlSessionTemplate 就和SqlSession类似 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"sqlSession"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.SqlSessionTemplate"</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 只能使用构造器注入sqlSessionFactory，因为SqlSessionTemplate没有set方法 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">index</span>=<span class="hljs-string">"0"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sqlSessionFactory"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>4、给接口编写实现类</strong></p>
<p>为了将MyBatis中手动获取Mapper对象的过程由Spring IOC容器接管，我们需要定义一个Mapper实现类，然后将其注入到Spring容器：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.mapper;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserMapperImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserMapper</span></span>{<br>    <span class="hljs-comment">//我们的所有操作，原来都是用sqlSession来执行，</span><br>    <span class="hljs-comment">//现在mybatis-spring整合，使用SqlSessionTemplate代替SqlSession</span><br>    <span class="hljs-keyword">private</span> SqlSessionTemplate sqlSession;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSqlSession</span><span class="hljs-params">(SqlSessionTemplate sqlSession)</span> </span>{<br>        <span class="hljs-keyword">this</span>.sqlSession = sqlSession;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title">selectUser</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-comment">//获取UserMapper的一个实现类对象</span><br>        UserMapper mapper = sqlSession.getMapper(UserMapper.class);<br>        <span class="hljs-keyword">return</span> mapper.selectUser();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>这个实现类相当于连接了MyBatis和Spring，将MyBatis获取Mapper实现类对象的步骤封装到一个类中，这个实现类虽然继承了接口，但它是借用MyBatis完成的功能，因此我们将这个实现类注册到Spring容器中。</p>
<p>之后从容器中获取这个实现类的对象就可以完成功能。</p>
<p><strong>5、将实现类注入到Spring中</strong></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userMapper"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.mapper.UserMapperImpl"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sqlSession"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sqlSession"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>6、通过Spring容器获取实现类对象，调用方法，完成功能</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">selectUser</span><span class="hljs-params">()</span> </span>{<br>    ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext.xml"</span>);<br>    <span class="hljs-comment">//直接从容器中获取实现类对象，调用方法就可以完成功能。</span><br>    UserMapper userMapper = context.getBean(<span class="hljs-string">"userMapper"</span>, UserMapper.class);<br>    List&lt;User&gt; users = userMapper.selectUser();<br>    <span class="hljs-keyword">for</span>(User user:users){<br>        System.out.println(user);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<hr>
<p><strong>汇总</strong></p>
<p>我们在Spring的配置文件中，可以实现对数据源的配置，也可以注册Mapper映射器，因此可以完全取代MyBatis配置文件，这里象征性地保留MyBatis配置文件<code>mybatis-config.xml</code>，里面保留了起别名的配置语句。</p>
<p><code>mybatis-config.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">"-//mybatis.org//DTD Config 3.0//EN"</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"com.kang.pojo"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>我们可以将上述的获取数据源、获取<code>SqlSessionFactory</code>对象、获取<code>SqlSessionTemplate</code>对象这三个和数据库相关的配置语句单独放到一个配置文件<code>spring-dao.xml</code>中，在<code>applicationContext.xml</code>核心配置文件中用来注册bean，并负责将引入<code>spring-dao.xml</code>。</p>
<p><code>spring-dao.xml</code>，用于获取SqlSessionTemplate对象：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 1、DataSource --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 2、获取SqlSessionFactory对象 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 3、获取SqlSessionTemplate对象 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><code>applicationContext.xml</code>，引入<code>spring-dao.xml</code>，注册bean：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 引入spring-dao --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">"spring-dao.xml"</span>/&gt;</span><br>    <br>    <span class="hljs-comment">&lt;!-- 注册bean，即userMapper实现类对象 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userMapper"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.mapper.UserMapperImpl"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sqlSession"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sqlSession"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p><strong>测试</strong></p>
<p>通过上述配置以后，我们可以测试是否配置成功。</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Test</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">selectUser</span><span class="hljs-params">()</span> </span>{<br>    ApplicationContext context = <span class="hljs-keyword">new</span> ClassPathXmlApplicationContext(<span class="hljs-string">"applicationContext.xml"</span>);<br>    <span class="hljs-comment">//现在我们只需要从Spring容器中获取UserMapper实现类对象即可</span><br>    UserMapper userMapper = context.getBean(<span class="hljs-string">"userMapper"</span>, UserMapper.class);<br>    List&lt;User&gt; users = userMapper.selectUser();<br>    <span class="hljs-keyword">for</span>(User user:users){<br>        System.out.println(user);<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<h2 id="11-2-方式二：SqlSessionDaoSupport"><a href="#11-2-方式二：SqlSessionDaoSupport" class="headerlink" title="11.2 方式二：SqlSessionDaoSupport"></a>11.2 方式二：SqlSessionDaoSupport</h2><p>第一种方式中，我们需要将<code>SqlSessionFactory</code>注入到<code>SqlSessionTemplate</code>类来获取<code>SqlSessionTemplate</code>对象。</p>
<p>现在我们将<code>UserMapperImpl</code>类继承<code>SqlSessionDaoSupport</code>类，就可以直接获得<code>SqlSessionTemplate</code>对象。</p>
<p><code>UserMapperImpl</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.kang.mapper;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserMapperImpl</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">SqlSessionDaoSupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserMapper</span></span>{<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title">selectUser</span><span class="hljs-params">()</span> </span>{<br>        <span class="hljs-comment">//getSqlSession()方法会创建并返回一个SqlSessionTemplate对象</span><br>        SqlSession sqlSession = getSqlSession();<br>        <span class="hljs-keyword">return</span> sqlSession.getMapper(UserMapper.class).selectUser();<br>    }<br>}<br></code></pre></td></tr></tbody></table></figure>
<p>我们可以使用<code>getSqlSession()</code>方法，其内部为我们创建了一个<code>SqlSessionTemplate</code>对象并返回，因此我们不需要在Spring容器中注册<code>SqlSessionTemplate</code>类。</p>
<p>此时的<code>spring-dao.xml</code>省略了一个bean内容：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 1、DataSource --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 2、获取SqlSessionFactory对象 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>同时，我们在<code>applicationContext.xml</code>配置文件中注册<code>UserMapperImpl</code>的时候，需要将<code>SqlSessionFactory</code>依赖注入:</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userMapperImpl"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.kang.mapper.UserMapperImpl"</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sqlSessionFactory"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"sqlSessionFactory"</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<h2 id="11-3-方式三：使用MapperScannerConfigurer"><a href="#11-3-方式三：使用MapperScannerConfigurer" class="headerlink" title="11.3 方式三：使用MapperScannerConfigurer"></a>11.3 方式三：使用MapperScannerConfigurer</h2><p><a href="http://mybatis.org/spring/zh/mappers.html#MapperScannerConfigurer"><code>MapperScannerConfigurer</code></a>基于反射原理，会自动查找类路径下的映射器（DAO接口）并自动将它们创建为<code>MapperFactoryBean</code>。也就是说它会扫描指定包下的所有接口，然后创建各自接口的动态代理类。</p>
<p><code>MapperFactoryBean</code>的出现<strong>为了代替手工使用SqlSessionDaoSupport或SqlSessionTemplate编写数据访问对象(DAO)的代码,使用动态代理实现。</strong>所以使用<code>MapperScannerConfigurer</code>的方式省略了前两种方法中手动创建<code>UserMapper</code>的步骤。</p>
<p>此时的<code>spring-dao.xml</code>文件内容如下：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans </span></span><br><span class="hljs-tag"><span class="hljs-string">                           http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 1、DataSource --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 2、获取SqlSessionFactory对象 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 3、配置MapperScannerConfigurer --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- a.设置要扫描的包 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"basePackage"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"com.kang.dao"</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!-- b.注入sqlSessionFactory --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"sqlSessionFactoryBeanName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"sqlSessionFactory"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>在上述配置中，我们设置自动扫描<code>com.kang.dao</code>这个包，假如这个包内有一个<code>UserMapper</code>接口，则<code>MapperScannerConfigurer</code>会使用动态代理自动为我们创建一个<code>id</code>为<code>userMapper</code>的代理bean对象，在同一个ApplicationContext中（或者是通过<code>import</code>引入）我们就可以直接使用这个bean。</p>
<h1 id="十二、声明式事务"><a href="#十二、声明式事务" class="headerlink" title="十二、声明式事务"></a>十二、声明式事务</h1><p>参考<a href="https://snailclimb.gitee.io/javaguide/#/docs/system-design/framework/spring/Spring%E4%BA%8B%E5%8A%A1%E6%80%BB%E7%BB%93">Spring事务总结</a></p>
<p>Spring中的事务有两种：</p>
<ul>
<li>编程式事务：在代码中管理事务，即使用 <code>TransactionTemplate</code>类或者<code>TransactionManager</code>接口手动编码管理事务。（不推荐使用）</li>
<li>声明式事务：使用AOP，在配置文件中配置。</li>
</ul>
<p>Spring中实现声明式事务同样也包括<strong>XML配置</strong>和<strong>注解</strong>两种方式，其中XML配置主要使用的时<code>&lt;tx&gt;</code>标签，注解主要使用的是<code>@Transactional</code>注解。</p>
<p><strong>一般我们需要处理事务是在service层。</strong></p>
<p>首先我们需要准备POJO类，对应的接口以及接口实现类。</p>
<p><code>User</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> </span>{<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> id;<br>    <span class="hljs-keyword">private</span> String name;<br>    <span class="hljs-keyword">private</span> String pwd;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">User</span><span class="hljs-params">()</span> </span>{<br>    }<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>UserMapper</code></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserMapper</span> </span>{<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">addUser</span><span class="hljs-params">(User user)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">deleteUser</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">updateUser</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title">querytUser</span><span class="hljs-params">()</span></span>;<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>UserMapperImpl</code>内容和十一节用到的相似。</p>
<h2 id="12-1-使用声明式事务"><a href="#12-1-使用声明式事务" class="headerlink" title="12.1 使用声明式事务"></a>12.1 使用声明式事务</h2><h3 id="12-1-1-使用tx和aop命名空间实现声明式事务"><a href="#12-1-1-使用tx和aop命名空间实现声明式事务" class="headerlink" title="12.1.1 使用tx和aop命名空间实现声明式事务"></a>12.1.1 使用tx和aop命名空间实现声明式事务</h3><p>前面说过，<code>advisor</code>多用于事务管理。我们可以结合使用<code>&lt;tx&gt;</code>和<code>&lt;aop&gt;</code>配置声明式事务。我们将事务配置语句写在<code>spring-dao.xml</code>文件中，内容如下。</p>
<p><code>spring-dao.xml</code></p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 配置声明式事务的步骤 --&gt;</span><br><span class="hljs-comment">&lt;!-- 1.开启事务处理功能，配置事务管理器 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 注入数据源 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 2.使用AOP织入 --&gt;</span><br><span class="hljs-comment">&lt;!-- 默认使用transactionManager --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">tx:advice</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"txAdvice"</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">"transactionManager"</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 给切入点中指定的方法配置事务 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tx:attributes</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"addUser"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"deleteUser"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"updateUser"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">tx:method</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"queryUser"</span> <span class="hljs-attr">propagation</span>=<span class="hljs-string">"REQUIRED"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">tx:attributes</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">tx:advice</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 配置事务切入点和通知器 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">aop:config</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 一般处理事务在service层，这里只是做个示例 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:pointcut</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"txPointcut"</span> <span class="hljs-attr">expression</span>=<span class="hljs-string">"execution(* com.kang.mapper.*.*(..))"</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">aop:advisor</span> <span class="hljs-attr">advice-ref</span>=<span class="hljs-string">"txAdvice"</span> <span class="hljs-attr">pointcut-ref</span>=<span class="hljs-string">"txPointcut"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">aop:config</span>&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>其中，<code>propagation</code>表示事务的传播行为，默认是<code>REQUIRED</code>，下文详细讲解，还可以根据需求配置其他属性。</p>
<p><code>&lt;tx:method&gt;</code>中的<code>name</code>要注入事务的方法名，可以用<code>*</code>表示所有方法。</p>
<p><strong>注意：</strong>为事务管理器指定的 <code>DataSource</code> <strong>必须</strong>和用来创建 <code>SqlSessionFactoryBean</code> 的是同一个数据源，否则事务管理器无法工作。</p>
<p>除了使用AOP的方式，还可以直接使用<code>JtaTransactionManager</code>，不用上面手动配置事务管理器和AOP织入等，直接配置事务管理器，<a href="http://mybatis.org/spring/zh/transactions.html#">参考mybatis-spring官方-交由容器管理事务</a>：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">tx:jta-transaction-manager</span> /&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<blockquote>
<p>JTA: Java Transaction API</p>
</blockquote>
<h3 id="12-1-2-使用-Transactional配置声明式事务"><a href="#12-1-2-使用-Transactional配置声明式事务" class="headerlink" title="12.1.2 使用@Transactional配置声明式事务"></a>12.1.2 使用@Transactional配置声明式事务</h3><p>使用注解的方式配置声明式事务，主要步骤：</p>
<p><strong>1.开启事务处理功能，配置事务管理器</strong></p>
<p><strong>2. 开启Spring对注解事务的支持，使类中事务注解生效</strong></p>
<p><strong>3.在需要事务的方法上使用<code>@Transactional</code>注解即可</strong></p>
<p>示例，<code>spring-dao.xml</code>：</p>
<figure class="highlight xml"><table><tbody><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 1、开启事务处理功能，配置事务管理器 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"transactionManager"</span> <span class="hljs-attr">class</span>=</span><br><span class="hljs-tag">      "<span class="hljs-attr">org.springframework.jdbc.datasource.DataSourceTransactionManager</span>"&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dataSource"</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-comment">&lt;!-- 2、开启Spring对注解事务的支持，指定事务管理器id --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">"transactionManager"</span>/&gt;</span><br></code></pre></td></tr></tbody></table></figure>
<p>在实现类中的方法上使用<code>@Transactional</code>注解：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserMapperImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserMapper</span></span>{<br>    <span class="hljs-keyword">private</span> SqlSessionTemplate sqlSession;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSqlSession</span><span class="hljs-params">(SqlSessionTemplate sqlSession)</span> </span>{<br>        <span class="hljs-keyword">this</span>.sqlSession = sqlSession;<br>    }<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span><br>    <span class="hljs-comment">//使用注解配置事务，还可以指定参数</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title">queryUser</span><span class="hljs-params">()</span> </span>{<br>        UserMapper mapper = sqlSession.getMapper(UserMapper.class);<br>        <span class="hljs-keyword">return</span> mapper.queryUser();<br>    }<br>    ...<br>}<br></code></pre></td></tr></tbody></table></figure>
<p><code>@Transactional</code>的<strong>工作原理</strong>是基于AOP实现的，AOP 是使用动态代理实现的。如果目标对象实现了接口，默认情况下会采用 JDK 的动态代理，如果目标对象没有实现了接口，会使用 CGLIB 动态代理。</p>
<p><strong><code>@Transactional</code></strong>的作用范围</p>
<ul>
<li><strong>方法</strong> ：推荐将注解使用于方法上，不过<strong>该注解只能应用到 public 方法上，否则不生效。</strong></li>
<li><strong>类</strong> ：如果这个注解使用在类上的话，表明该注解对该类中所有的 public 方法都生效。</li>
<li><strong>接口</strong> ：不推荐在接口上使用。因为<strong>在接口上使用时只有基于接口的代理（比如JDK接口代理）才会生效</strong>。因为注解是不能继承 的，这就意味着如果正在使用基于类（比如CGlib）的代理时，那么事务的设置将不能被基于类的代理所识别，而且对象也将不会被事务代理所包装。</li>
</ul>
<blockquote>
<p>@Inherited使注解能够继承，只能控制对类名上注解是否可以被继承。不能控制方法上的注解是否可以被继承。</p>
</blockquote>
<p><strong><code>@Transactional</code></strong>的常用参数</p>
<ul>
<li><code>propagation</code>：事务的传播行为，默认值为REQUIRED</li>
<li><code>isolation</code>：事务的隔离级别，默认值采用DEFAULT</li>
<li><code>timeout</code>：事务的超时时间，默认值为-1，表示不会超时。如果超过改时间限制但事务还没有完成，则自动回滚事务。</li>
<li><code>readOnly</code>：指定事务是否是只读事务，默认值为false</li>
<li><code>rollbackFor</code>：用于指定能够触发事务回滚的异常类型，并且可以指定多个异常类型。默认为<code>RuntimeException.class</code>，表示在遇到<code>RuntimeException</code>异常时才回滚。</li>
</ul>
<p><strong><code>@Transactional</code></strong>的使用注意事项</p>
<ul>
<li><p><code>@Transactional</code> 注解只有作用到 public 方法上事务才生效，不推荐在接口上使用；</p>
</li>
<li><p>避免同一个类中调用 <code>@Transactional</code> 注解的方法，这样会导致事务失效；</p>
<blockquote>
<p>也就是说，同一个类中，方法A调用使用了@Transactional注解的方法B，会导致方法B事务失效。这是由于Spring采用动态代理(AOP)实现对bean的管理和切片，它为我们的每个class生成一个代理对象。只有在代理对象之间进行调用时，可以触发切面逻辑。而在同一个class中，方法A调用方法B，调用的是原对象的方法，而不通过代理对象。所以Spring无法切到这次调用，也就无法通过注解保证事务性了。</p>
</blockquote>
</li>
<li><p>正确的设置 <code>@Transactional</code> 的<code>rollbackFor</code>和<code>propagation</code>属性，否则事务可能会回滚失败.</p>
</li>
</ul>
<h2 id="12-2-事务属性"><a href="#12-2-事务属性" class="headerlink" title="12.2 事务属性"></a>12.2 事务属性</h2><p>Spring中事务的常用属性包括以下几种。</p>
<h3 id="12-2-1-事务传播行为"><a href="#12-2-1-事务传播行为" class="headerlink" title="12.2.1 事务传播行为"></a>12.2.1 事务传播行为</h3><p>事务传播行为是为了解决业务层方法之间互相调用的事务问题。</p>
<p>当事务方法被另一个事务方法调用时，必须指定事务应该如何传播。例如：方法可能继续在现有事务中运行，也可能开启一个新事务，并在自己的事务中运行。不同的事务导致回滚时的行为也会不同。事务的传播行为就是解决这种问题的。</p>
<p>事务的传播行为共有以下7种：</p>
<p>支持当前事务的情况</p>
<ul>
<li><strong><code>TransactionDefinition.PROPAGATION_REQUIRED</code></strong>(0)：默认。如果当前存在事务，则加入该事务；如果当前没有事务，则创建一个新的事务。</li>
<li><strong><code>TransactionDefinition.PROPAGATION_SUPPORTS</code></strong>(1)：如果当前存在事务，则加入该事务；如果当前没有事务，则以非事务的方式继续运行。</li>
<li><strong><code>TransactionDefinition.PROPAGATION_MANDATORY</code></strong>(2)：如果当前存在事务，则加入该事务；如果当前没有事务，则抛出异常。</li>
</ul>
<p>不支持当前事务的情况</p>
<ul>
<li><strong><code>TransactionDefinition.PROPAGATION_REQUIRES_NEW</code></strong>(3)：创建一个新的事务，如果当前存在事务，则把当前事务挂起。</li>
<li><strong><code>TransactionDefinition.PROPAGATION_NOT_SUPPORTED</code></strong>(4)：以非事务方式运行，如果当前存在事务，则把当前事务挂起。</li>
<li><strong><code>TransactionDefinition.PROPAGATION_NEVER</code></strong>(5)：以非事务方式运行，如果当前存在事务，则抛出异常。</li>
</ul>
<p>其他情况</p>
<ul>
<li><strong><code>TransactionDefinition.PROPAGATION_NESTED</code></strong>(6)：如果当前存在事务，则创建一个事务作为当前事务的嵌套事务来运行（外部主事务回滚的话，子事务也会回滚，而内部子事务可以单独回滚而不影响外部主事务和其他子事务）；如果当前没有事务，则该取值等价于<code>REQUIRED</code>。</li>
</ul>
<h3 id="12-2-2-事务隔离级别"><a href="#12-2-2-事务隔离级别" class="headerlink" title="12.2.2 事务隔离级别"></a>12.2.2 事务隔离级别</h3><p><strong>TransactionDefinition 接口中定义了五个表示隔离级别的常量，</strong>除了默认级别以外，其余四种和SQL中的四种隔离级别一一对应：</p>
<ul>
<li><p><strong><code>TransactionDefinition.ISOLATION_DEFAULT</code>:</strong> 使用后端数据库默认的隔离级别，Mysql 默认采用的 <code>REPEATABLE_READ</code>隔离级别，Oracle 默认采用的 <code>READ_COMMITTED</code>隔离级别.</p>
</li>
<li><p><strong><code>TransactionDefinition.ISOLATION_READ_UNCOMMITTED</code>:</strong> 最低的隔离级别，允许读取尚未提交的数据变更，<strong>可能会导致脏读、幻读或不可重复读</strong></p>
</li>
<li><p><strong><code>TransactionDefinition.ISOLATION_READ_COMMITTED</code>:</strong> 允许读取并发事务已经提交的数据，<strong>可以阻止脏读，但是幻读或不可重复读仍有可能发生</strong></p>
</li>
<li><p><strong><code>TransactionDefinition.ISOLATION_REPEATABLE_READ</code>:</strong> 对同一字段的多次读取结果都是一致的，除非数据是被本身事务自己所修改，<strong>可以阻止脏读和不可重复读，但幻读仍有可能发生。</strong></p>
</li>
<li><p><strong><code>TransactionDefinition.ISOLATION_SERIALIZABLE</code>:</strong> 最高的隔离级别，完全服从ACID的隔离级别。所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰，也就是说，<strong>该级别可以防止脏读、不可重复读以及幻读</strong>。但是这将严重影响程序的性能。通常情况下也不会用到该级别。</p>
</li>
</ul>
<h3 id="12-2-3-事务超时属性"><a href="#12-2-3-事务超时属性" class="headerlink" title="12.2.3 事务超时属性"></a>12.2.3 事务超时属性</h3><p>事务超时，指一个事务所允许执行的最长时间。如果超过该时间限制但事务还没有完成，则自动回滚事务。</p>
<p>在 <code>TransactionDefinition</code> 中以 int 的值来表示超时时间，其单位是秒，默认值为-1，表示无限制。</p>
<h3 id="12-2-4-事务只读属性"><a href="#12-2-4-事务只读属性" class="headerlink" title="12.2.4 事务只读属性"></a>12.2.4 事务只读属性</h3><p><code>readOnly</code>为只读属性，对于只有读取数据查询的事务，可以指定事务类型为 readonly，即只读事务。只读事务不涉及数据的修改，数据库会提供一些优化手段，适合用在有多条数据库查询操作的方法中。</p>
<p>MySQL 默认对每一个新建立的连接都启用了<code>autocommit</code>模式。在该模式下，每一个发送到 MySQL 服务器的<code>sql</code>语句都会在一个单独的事务中进行处理，执行结束后会自动提交事务，并开启一个新的事务。</p>
<p>如果给方法加上了<code>Transactional</code>注解的话，这个方法执行的<strong>所有<code>sql</code></strong>会被放在一个事务中。如果声明了只读事务的话，<strong>数据库就会去优化它的执行</strong>，并不会带来其他的什么收益。</p>
<p>如果不加<code>Transactional</code>，每条<code>sql</code>会开启一个单独的事务，中间被其它事务改了数据，都会实时读取到最新值。会导致一个方法中的多次查询可能出现数据不一致的结果。</p>
<p>比如在一次执行多条查询语句，例如统计查询，报表查询的场景下，多条查询 SQL 必须保证整体的读一致性，否则，如前条 SQL 查询之后，后面的 SQL 查询之前，数据被改变了，则该次整体的统计查询将会出现读数据不一致的状态。</p>
<h3 id="12-2-5-事务回滚规则"><a href="#12-2-5-事务回滚规则" class="headerlink" title="12.2.5 事务回滚规则"></a>12.2.5 事务回滚规则</h3><p><strong>事务的回滚规则定义了哪些异常会导致事务回滚而哪些不会。</strong></p>
<p><strong>默认情况下</strong>，事务只有遇到运行期异常（<code>RuntimeException</code> 的子类）时才会回滚，<code>Error</code>也会导致事务回滚，在遇到检查型（<code>Checked</code>）异常时不会回滚。</p>
<p>可以自定义特定的异常类型，只需要为<code>rollbackFor</code>赋不同的值。</p>
<h1 id="十三、其他问题"><a href="#十三、其他问题" class="headerlink" title="十三、其他问题"></a>十三、其他问题</h1><h2 id="13-1-Spring的启动过程"><a href="#13-1-Spring的启动过程" class="headerlink" title="13.1 Spring的启动过程"></a>13.1 Spring的启动过程</h2><ul>
<li>创建<code>beanFactory</code>，加载xml配置文件。</li>
<li>解析配置文件转化<code>beanDefination</code>，获取到bean的所有属性、依赖及初始化用到的各类处理器等。</li>
<li>刷新<code>beanFactory</code>容器，初始化所有单例bean。</li>
<li>注册所有的单例bean并返回可用的容器，一般为扩展的<code>applicationContext</code>。  </li>
</ul>
<h2 id="13-2-Spring的BeanFactory和ApplicationContex容器"><a href="#13-2-Spring的BeanFactory和ApplicationContex容器" class="headerlink" title="13.2 Spring的BeanFactory和ApplicationContex容器"></a>13.2 Spring的BeanFactory和ApplicationContex容器</h2><p>Bean 工厂(<code>com.springframework.beans.factory.BeanFactory</code>)是 Spring框架最核心的接口，它提供了高级IoC的配置机制。BeanFactory使管理不同类型的Java对象成为可能，<code>com.springframework.context.ApplicationContext</code>建立在 BeanFactory基础之上，提供了更多面向应用的功能，它提供了国际化支持和框架事件体系，更易于创建实际应用。我们一般称BeanFactory为IoC容器，而称<code>ApplicationContext</code>为应用上下文。但有时为了行文方便，我们也将<code>ApplicationContext</code>称为Spring容器。</p>
<p>二者的主要区别是，<code>BeanFactory</code>是延迟加载，比如说，如果Bean没有完全注入，BeanFacotry加载后，会在第一次调用getBean方法才会抛出异常；而ApplicationContext会在初始化的时候就加载并且检查，这样的好处是可以及时检查依赖是否完全注入。通常来说我们会选择使用ApplicationContext。</p>
<p>对于二者的用途，我们可以进行简单的划分：</p>
<ul>
<li><code>BcanFactory</code>是 Spring框架的基础设施，面向Spring本身；</li>
<li><code>ApplicationContext</code>面向使用 Spring框架的开发者，几乎所有的应用场合都可以直接使用<code>ApplicationContext</code>而非底层的 <code>BeanFactory</code>。</li>
</ul>
<h2 id="13-3-Spring是如何解决循环依赖的"><a href="#13-3-Spring是如何解决循环依赖的" class="headerlink" title="13.3 Spring是如何解决循环依赖的"></a>13.3 Spring是如何解决循环依赖的</h2><p>参考<a href="https://blog.csdn.net/weixin_49592546/article/details/108050566">Spring如何解决循环依赖，源码解析</a>、<a href="https://www.zhihu.com/question/438247718">Spring如何解决循环依赖</a></p>
<p><strong>循环依赖</strong>：bean对象直接互相依赖，比如A中依赖B，同时B中也依赖A，就构成了循环依赖，在注册Bean时就要考虑先后的问题。</p>
<p>Spring中的循环依赖有三种情况：</p>
<ul>
<li><p><strong>构造器注入形成的循环依赖。</strong>也就是beanB需要在beanA的构造函数中完成初始化，beanA也需要在beanB的构造函数中完成初始化，这种情况的结果就是两个bean都不能完成初始化，循环依赖难以解决。</p>
</li>
<li><p><strong>setter注入构成的循环依赖。</strong>beanA需要在beanB的setter方法中完成初始化，beanB也需要在beanA的setter方法中完成初始化，<strong>Spring设计的机制主要就是解决这种循环依赖</strong></p>
</li>
<li><p><strong>prototype作用域bean的循环依赖。</strong>这种循环依赖同样无法解决，因为spring不会缓存<code>prototype</code>作用域的bean，而Spring中循环依赖的解决正是通过缓存来实现的。</p>
</li>
</ul>
<p><strong>Spring只能解决setter注入构成的依赖，使用三级缓存结构，提前曝光的思想：</strong></p>
<ul>
<li><p><code>singletonObjects</code>：一级缓存，用于保存实例化、注入、初始化完成的bean实例，即<strong>完全初始化好的bean</strong>，即成品bean对象。从该缓存中取出的bean可以直接使用。</p>
</li>
<li><p><code>earlySingletonObjects</code>：二级缓存，用于保存实例化完成的bean实例，<strong>尚未填充属性</strong>，即半成品的bean对象。用于解决循环依赖。</p>
</li>
<li><p><code>singletonFactories</code>：三级缓存，用于<strong>保存bean工厂对象</strong>，实例化半成品bean并放到二级缓存，用于解决循环依赖。</p>
<blockquote>
<p>没有循环依赖的情况下，创建好完成品bean之后，才创建对应的代理。但是Spring并不知道有没有循环依赖，因此其选择了不提前创建代理对象，在出现循环依赖被其他对象注入时，才实时生成代理对象。</p>
<p>在对象外面包一层<code>ObjectFactory</code>，做到了提前曝光又不生成代理。在被注入时才使用<code>ObjectFactory.getObject</code>方法生成代理对象，并将生成好的代理对象放到二级缓存中。</p>
</blockquote>
</li>
</ul>
<p>具体步骤：</p>
<ul>
<li><p>首先 A 完成初始化第一步并将自己提前曝光出来（通过<code>ObjectFactory</code> 将自己<strong>提前曝光</strong>，将其包装为<code>ObjectFactory</code>对象然后存放到三级缓存），在初始化的时候，发现自己依赖对象 B，此时就会去尝试 get(B)，这个时候发现 B 还没有被创建出来 。</p>
</li>
<li><p>然后创建 B，在 B 初始化的时候，同样发现自己依赖A，于是尝试 get(A)，这个时候由于 A 已经被包装为工厂类对象并被添加至缓存（三级缓存 ）中，所以可以通过 <code>ObjectFactory.getObject()</code> 方法来拿到 A 对象（A的半成品，同时也是代理对象，然后半成品A会被放到二级缓存），B拿到 A 对象后顺利完成初始化，然后将自己添加到一级缓存中。</p>
</li>
<li><p>回到 A，A 也可以拿到 B 对象，完成初始化，到这里整个链路就已经完成了初始化过程了。</p>
</li>
</ul>
<blockquote>
<p>Spring是通过递归的方式获取目标bean及其所依赖的bean的</p>
<p>Spring实例化一个bean的时候，是分两步进行的，首先实例化目标bean，然后为其注入属性。</p>
</blockquote>
<p>另外，为什么需要三级缓存，而不是二级缓存，也就是bean构造完成后就生成代理对象？</p>
<p>因为没有出现循环依赖的情况下，Spring的初衷就是在Bean生命周期的最后一步完成代理，而不是实例化之后马上生成代理对象。</p>
<p>二级缓存便于存放半成品bean对象，二级缓存和三级缓存就是为了解决循环依赖问题才设置的，<strong>三级缓存的实现提供了提前生成代理的口子，而不是直接生成代理，只有发生循环依赖执行getObject才会执行代理</strong>，从而达到了<strong>只有循环依赖发生时，才提前代理，而没有循环依赖，则代理方式不变，依然是初始化以后代理</strong>的目的。<a href="https://blog.csdn.net/u012098021/article/details/107352463/">Spring循环依赖及三级缓存</a></p>
<h2 id="13-4-Spring框架中用到了哪些设计模式"><a href="#13-4-Spring框架中用到了哪些设计模式" class="headerlink" title="13.4 Spring框架中用到了哪些设计模式"></a>13.4 Spring框架中用到了哪些设计模式</h2><p>参考<a href="https://mp.weixin.qq.com/s?__biz=Mzg2OTA0Njk0OA==&amp;mid=2247485303&amp;idx=1&amp;sn=9e4626a1e3f001f9b0d84a6fa0cff04a&amp;chksm=cea248bcf9d5c1aaf48b67cc52bac74eb29d6037848d6cf213b0e5466f2d1fda970db700ba41&amp;token=255050878&amp;lang=zh_CN#rd">Spring中都用到了那些设计模式?</a></p>
<ul>
<li><strong>工厂模式</strong>：比如Spring使用BeanFactory、ApplicationContext创建bean对象。</li>
<li><strong>代理模式</strong>：AOP的核心就是代理模式</li>
<li><strong>单例模式</strong>：Spring中的Bean默认就是单例模式</li>
<li><strong>模板方法模式</strong> : Spring 中 <code>jdbcTemplate</code>、<code>hibernateTemplate</code> 等以 Template 结尾的对数据库操作的类，它们就使用到了模板模式。</li>
<li><strong>包装器设计模式</strong> : 我们的项目需要连接多个数据库，而且不同的客户在每次访问中根据需要会去访问不同的数据库。这种模式让我们可以根据客户的需求能够动态切换不同的数据源。</li>
<li><strong>观察者模式:</strong> Spring 事件驱动模型就是观察者模式很经典的一个应用。</li>
<li><strong>适配器模式</strong> ：Adapter Pattern，将一个接口转换成客户希望的另一个接口，适配器模式使接口不兼容的那些类可以一起工作，其别名为包装器(Wrapper)。Spring AOP 的增强或通知(Advice)使用到了适配器模式，Spring MVC 中也是用到了适配器模式适配<code>Controller</code>。</li>
</ul>
<hr>
<p>参考：<a href="https://snailclimb.gitee.io/javaguide/#/docs/system-design/framework/spring/Spring%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E6%80%BB%E7%BB%93">JavaGuide-Spring常见问题总结</a></p>
]]></content>
      <categories>
        <category>SSM框架</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>SSM</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu20安装MySQL8.md</title>
    <url>/2022/05/22/Ubuntu20-install-mysql8-md/</url>
    <content><![CDATA[<h2 id="一、版本信息"><a href="#一、版本信息" class="headerlink" title="一、版本信息"></a>一、版本信息</h2><p>系统：<code>Ubuntu 20.04.4</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">root@LAPTOP-4LK64UFH:/etc<span class="hljs-comment"># lsb_release -a</span><br>No LSB modules are available.<br>Distributor ID: Ubuntu<br>Description:    Ubuntu 20.04.4 LTS<br>Release:        20.04<br>Codename:       focal<br></code></pre></td></tr></tbody></table></figure>
<p>MySQL：<code>8.0.29</code></p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">root@LAPTOP-4LK64UFH:/<span class="hljs-comment"># mysql --version</span><br>mysql  Ver 8.0.29-0ubuntu0.20.04.3 <span class="hljs-keyword">for</span> Linux on x86_64 ((Ubuntu))<br></code></pre></td></tr></tbody></table></figure>
<h2 id="二、安装步骤"><a href="#二、安装步骤" class="headerlink" title="二、安装步骤"></a>二、安装步骤</h2><h3 id="1、卸载旧版本"><a href="#1、卸载旧版本" class="headerlink" title="1、卸载旧版本"></a>1、卸载旧版本</h3><p>安装之前确保旧版本已经卸载干净：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 卸载mysql-common</span><br>sudo apt-get remove mysql-common<br><span class="hljs-comment"># 卸载mysql-server</span><br>sudo apt-get autoremove --purge mysql-server-5.0<br><span class="hljs-comment"># 查看MySQL剩余的包，然后卸载</span><br>dpkg --list|grep mysql<br><span class="hljs-comment"># 清除残留数据</span><br>dpkg -l |grep ^rc|awk <span class="hljs-string">'{print $2}'</span> |sudo xargs dpkg -P <br><span class="hljs-comment"># 删除MySQL数据文件</span><br>sudo rm /var/lib/mysql/ -R<br><span class="hljs-comment"># 删除MySQL配置文件</span><br>sudo rm /etc/mysql/ -R<br></code></pre></td></tr></tbody></table></figure>
<h3 id="2、安装"><a href="#2、安装" class="headerlink" title="2、安装"></a>2、安装</h3><p>更新软件库：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">sudo apt update<br></code></pre></td></tr></tbody></table></figure>
<p>安装MySQL服务：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">sudo apt install mysql-server<br><span class="hljs-comment"># 这里会自动安装mysql-client</span><br></code></pre></td></tr></tbody></table></figure>
<p>安装依赖：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">sudo apt install libmysqlclient-dev<br></code></pre></td></tr></tbody></table></figure>
<p>安装完后，检查状态：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash">sudo netstat -tap | grep mysql<br></code></pre></td></tr></tbody></table></figure>
<p>常用命令：</p>
<figure class="highlight bash"><table><tbody><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 启动MySQL服务</span><br>sudo service mysql start<br><span class="hljs-comment"># 停止MySQL服务</span><br>sudo service mysql stop<br><span class="hljs-comment"># 重启MySQL服务</span><br>sudo service mysql restart<br></code></pre></td></tr></tbody></table></figure>
<h1 id="三、使用MySQL"><a href="#三、使用MySQL" class="headerlink" title="三、使用MySQL"></a>三、使用MySQL</h1><p>MySQL8版本中，用户密码字段为<code>authentication_string</code>，并且新增了<code>caching_sha2_password</code>加密插件。</p>
<h3 id="1、设置用户密码"><a href="#1、设置用户密码" class="headerlink" title="1、设置用户密码"></a>1、设置用户密码</h3><p>用户表保存在<code>mysql</code>库的<code>user</code>表中:</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><code class="hljs mysql">ALTER mysql.user 'userName'@'hostName' IDENTIFIED WITH caching_sha2_password BY 'userName';<br># 这里用caching_sha2_password，则plugin字段也应该是caching_sha2_password<br><br># 修改完后刷新<br>flush privileges;<br></code></pre></td></tr></tbody></table></figure>
<p>使用这个指令前，要确保<code>authentication_string</code>字段为空，否则会执行失败。</p>
<h3 id="2、远程连接MySQL服务"><a href="#2、远程连接MySQL服务" class="headerlink" title="2、远程连接MySQL服务"></a>2、远程连接MySQL服务</h3><p>服务器上安装好MySQL后，客户端连接服务器的数据库，需要检查下面几项内容：</p>
<ul>
<li>服务器防火墙关闭。</li>
<li>服务器ssh服务开启。</li>
<li>服务端端口打开：使用<code>netstat -an | grep 3306</code>指令查看3306端口情况，如果端口前面的地址是<code>127.0.0.1</code>，需要将<code>etc/mysql/mysql.conf.d/mysqld.cnf</code>中的<code>bind-address = 127.0.0.1</code>注释掉，确保其他地址客户端可以连接。</li>
</ul>
<h1 id="四、问题排查"><a href="#四、问题排查" class="headerlink" title="四、问题排查"></a>四、问题排查</h1><p><strong>问题一</strong>：修改完密码登录，提示拒绝登录</p>
<p><strong>错误信息</strong>：ERROR 1045 (28000): Access denied for user ‘root’@’localhost’ (using password: YES)</p>
<p><strong>原因</strong>：可能是缓存密码的加密方式和当前用的加密插件不一致，<strong>确保设置密码时的加密插件和用户的<code>plugin</code>字段是相同的加密插件</strong>。</p>
<blockquote>
<p>如果第三方客户端不支持caching_sha2_password，可以改成旧的mysql_native_password 加密方式。</p>
</blockquote>
<p><strong>问题二</strong>：无法连接MySQL服务器</p>
<p><strong>错误信息</strong>：ERROR 2002 (HY000): Can’t connect to local MySQL server through socket ‘/var/run/mysqld/mysqld.sock’ (13)</p>
<p><strong>原因</strong>：1、检查目录是否有指定文件。2、可能是当前用户没有此文件的权限，添加权限即可。</p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>Ubuntu</tag>
      </tags>
  </entry>
</search>
